# 需求文档：军事系统精细化修复

## 引言

本次修复针对战线-战斗系统融合后暴露的 5 个核心问题，涉及军团/将领数据可见性隔离、将领系统与官员系统的打通、战线持续战况反馈、以及战线资源点/设施与游戏主系统的对齐。

**现有机制摘要：**
- `militaryCorps` 数组同时包含玩家军团和 AI 敌方军团（`isAI: true`），`generals` 数组同时包含玩家将领和 AI 将领（`ai_gen_` 前缀）
- 将领系统（`corpsSystem.js`）完全独立于官员系统（`config/officials.js` + `logic/officials/manager.js`），有独立的名字库/traits/等级体系
- 官员系统已有 `sourceStratum: 'soldier'` 出身的官员、`militaryBonus`（+10%~+35%）和 `militaryUpkeep`（-10%~-35%）效果
- 战线仅在有 `activeBattle` 时显示战斗面板，无战斗时只有静态信息和"发起进攻"按钮
- 战线资源节点（`RESOURCE_NODE_TEMPLATES`）和设施（`INFRASTRUCTURE_TEMPLATES`）是硬编码模板，不基于游戏主建筑系统（`BUILDINGS`）和资源系统（`RESOURCES`）

---

## 需求

### 需求 1：军团面板隐藏 AI 敌方军团

**用户故事：** 作为玩家，我只想在军团管理面板中看到自己的军团，以便不被敌方军团信息干扰决策。

#### 验收标准

1.1 WHEN 军团面板（`CorpsManagementPanel`）渲染军团列表 THEN 系统 SHALL 过滤掉 `isAI === true` 的军团，仅显示玩家自己的军团

1.2 WHEN 计算"未编入军团"的兵力池 THEN 系统 SHALL 仅扣除玩家军团中的单位数量（排除 AI 军团）

1.3 WHEN 显示军团计数（如"3/8 军团"） THEN 系统 SHALL 仅统计玩家军团，不包含 AI 军团

---

### 需求 2：将领列表隐藏 AI 将领

**用户故事：** 作为玩家，我只想看到自己的将领列表，以便清晰管理将领分配。

#### 验收标准

2.1 WHEN 将领区域渲染将领列表 THEN 系统 SHALL 过滤掉 AI 将领（`id` 以 `ai_gen_` 开头或带有 `isAI` 标记的将领）

2.2 WHEN 展开军团详情中的"将领管理"下拉列表 THEN 系统 SHALL 仅列出可分配的玩家将领（排除 AI 将领和已分配给其他军团的将领）

2.3 WHEN 战局视图（`WarfrontCard`）显示敌方军团将领信息 THEN 系统 SHALL 可以显示 AI 将领名称和等级作为情报展示（这是合理的战线情报），但应与玩家将领使用不同的视觉标记（如灰色/暗红色）

---

### 需求 3：将领从官员系统选拔

**用户故事：** 作为玩家，我希望从已有的官员中选择一位担任将领，而不是凭空招募，以便复用官员系统已有的军事属性和政治互动。

#### 验收标准

3.1 WHEN 玩家点击"招募将领"按钮 THEN 系统 SHALL 显示当前在任官员列表（而非生成随机将领），只列出可选为将领的官员（非正在担任将领的官员）

3.2 IF 一名官员被选为将领 THEN 系统 SHALL 基于该官员的属性生成对应的将领数据：
   - 将领 `name` = 官员 `name`
   - 将领 `level` = 基于官员的 `militaryBonus` 效果强度和威望（prestige）推算（如 militaryBonus ≥ 0.2 → Lv.3，≥ 0.3 → Lv.4）
   - 将领 `traits` = 根据官员出身阶层和效果类型映射（如 `soldier` 出身 → 可能获得 `aggressive`/`veteran`；有 `militaryUpkeep` 效果 → `logistics` trait）
   - 保留官员 ID 引用（`officialId` 字段），方便双向查询

3.3 IF 一名官员正在担任将领角色 THEN 系统 SHALL 在官员面板中显示"领军中"标签，并且该官员不能被解雇（需先卸任将领）

3.4 WHEN 一名将领被卸任 THEN 系统 SHALL 将对应官员恢复为普通官员状态（移除"领军中"标记）

3.5 IF 当前没有在任官员，或没有具备军事效果的官员 THEN 系统 SHALL 在招募界面显示提示："无合适官员可担任将领。建议在行政面板录用具有军事才能的官员。"

3.6 WHEN 一名担任将领的官员在官员面板中被查看 THEN 系统 SHALL 额外显示其将领相关信息（已分配军团、将领等级、特质等）

---

### 需求 4：战线持续战况反馈和多层次战斗

**用户故事：** 作为玩家，我希望即使没有大型会战在进行，也能看到战线上的持续活动反馈（小规模冲突、骚扰、巡逻），以便获得沉浸感和战略参考。

#### 验收标准

4.1 WHEN 战线上双方都部署了军团且没有正式战斗进行时 THEN 系统 SHALL 自动产生"前线摩擦"事件（低强度持续冲突），在 WarfrontCard 中通过动态文字日志和简单动画展示，如：
   - "边境巡逻队遭遇敌方斥候…"
   - "小股敌军试图渗透…被我方哨兵击退"
   - "我方骑兵对敌方补给线发起骚扰…"

4.2 WHEN "前线摩擦"事件触发 THEN 系统 SHALL 产生少量伤亡（双方各损失 0.1%~0.5% 兵力）和少量 warScore 变化（±1~3），使战线持续产生微量变化

4.3 WHEN 玩家选择战术姿态（如"积极防御"/"主动骚扰"/"消极防守"） THEN 系统 SHALL 即使在非正式战斗期间也调整前线摩擦的频率和强度：
   - 主动骚扰：摩擦频率+50%，我方损失略高但敌方损失更高
   - 积极防御：标准摩擦频率
   - 消极防守：摩擦频率-50%，双方损失都更低

4.4 WHEN 玩家发起正式进攻（"发起进攻"按钮） THEN 系统 SHALL 视为大规模会战（现有的 `createBattle` 机制），与前线摩擦共存——大型会战进行的同时，其他部署军团仍会产生前线摩擦

4.5 IF 战线上只有一方部署了军团（另一方为空） THEN 系统 SHALL 显示"无对抗"状态文字，不产生前线摩擦

4.6 WHEN 前线摩擦事件发生 THEN 系统 SHALL 在 WarfrontCard 中显示一个滚动的事件日志区域（最近 3-5 条事件），带有时间戳和简短描述，使用淡入淡出动画

---

### 需求 5：战线资源点和设施与游戏主系统对齐

**用户故事：** 作为玩家，我希望战线上的资源点和设施反映我实际拥有的经济状况（建筑和资源），而不是看到一些与游戏系统无关的随机生成内容。

#### 验收标准

5.1 WHEN 生成战线时 THEN 系统 SHALL 基于玩家和敌方实际拥有的建筑（`BUILDINGS` 配置）生成资源节点：
   - 玩家方的资源节点 = 从玩家当前拥有的建筑中随机抽取 2-4 个作为"前线经济目标"
   - 每个节点的 `resource` 必须来自该建筑的 `output` 字段中的主产出资源
   - 每个节点的 `amount` 基于该建筑的实际产出量 × 一个系数（如 50-100 天的产出量）
   - 节点的 `desc` 使用建筑名称（如"农田"、"铁匠铺"）

5.2 WHEN 生成战线设施时 THEN 系统 SHALL 基于建筑类别映射，而非使用硬编码模板：
   - `military` 类建筑 → 军事设施（城墙、兵营，提供防御加成）
   - `civic` 类建筑 → 民用设施（贸易站、图书馆，提供收入/研究加成）
   - `gather/industry` 类建筑 → 经济设施（农田、工坊，提供资源产出）
   - 设施的耐久度基于建筑等级和数量

5.3 IF 玩家在战争期间建造了新建筑 THEN 系统 SHALL 不动态更新已生成的战线资源点（战线在生成时快照，战争期间保持不变）

5.4 WHEN 资源节点被掠夺 THEN 系统 SHALL 仅使用 `RESOURCES` 中已定义的资源类型（如 `food`、`iron`、`wood`、`stone`、`silver`、`tools`、`cloth` 等），不使用 `swords`、`gunpowder` 等未在 `RESOURCES` 中定义的资源

5.5 WHEN 显示战线详情中的资源点和设施 THEN 系统 SHALL 使用与游戏主界面一致的资源图标和颜色（复用 `RESOURCES[key].icon` 和 `RESOURCES[key].color`）

5.6 IF 敌方（AI 国家）没有具体的建筑数据 THEN 系统 SHALL 基于敌国的 `epoch`、`wealth`、`population` 等宏观数据合理推算其经济结构，生成与其发展水平匹配的资源节点（当前的随机生成逻辑可作为兜底，但需确保资源类型在 `RESOURCES` 范围内）

---

## 边界情况和注意事项

- **数据迁移**：修改后需确保已有存档中的旧格式将领/军团数据兼容（如旧将领没有 `officialId` 字段，应 graceful fallback）
- **AI 军团清理**：和平协议签订后，AI 军团和 AI 将领应从 `militaryCorps` 和 `generals` 中完全移除（已在任务9中实现部分逻辑，需复查）
- **官员系统关联的可逆性**：官员被选为将领后，其官员效果（如 `militaryBonus`）是否仍然生效？建议保留：领军中的官员仍提供其政治/经济效果，但加一个"分心惩罚"（-30% 非军事效果）
- **前线摩擦性能**：每日 tick 中增加前线摩擦计算，需确保对大量战线时的性能影响可控（建议每 3-5 天才触发一次摩擦事件，而非每天）
- **资源类型校验**：`RESOURCE_NODE_TEMPLATES` 中的 `swords`、`gunpowder`、`ammunition` 等需要校验是否在 `RESOURCES` 中定义；如未定义，使用最接近的已有资源替代
