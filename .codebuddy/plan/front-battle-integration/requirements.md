# 需求文档：战线-战斗系统融合

## 引言

当前军事系统的战线（Front）和战斗（Battle）是两个完全割裂的子系统：战线面板只能查看信息，"增派军团"按钮无响应（回调未绑定）；战斗面板始终为空（`activeBattles` 为空，`createBattle` 从未被调用）；旧的"军事行动"卡片仍使用瞬时 `simulateBattle` 而非新的回合制 `battleSystem`。

本次改造的核心目标是：**将战线作为战斗的容器**，建立完整的交互闭环：

```
宣战 → 战线生成 → 军团部署到战线 → 在战线上发起/自动触发战斗 
→ 战斗回合在 game loop 中推进 → 战斗结果反馈到战线（掠夺/破坏）
→ 战线状态影响和平谈判
```

### 现有系统状态

| 模块 | 当前状态 | 问题 |
|------|---------|------|
| `frontSystem.js` | 数据模型完整，`generateFront` 已集成 | `assignCorpsToFront` 未绑定到 App；`processFrontTick` 未接入 loop |
| `battleSystem.js` | 回合制引擎完整（战术/士气/增援/撤退） | `createBattle`/`processCombatRound` 从未被调用 |
| `corpsSystem.js` | 军团创建/编入/将领完整 | 军团部署到战线的回调未实现 |
| `FrontViewPanel` | 可显示战线信息 | "增派军团"无响应；无发起战斗入口；无战斗进度展示 |
| `ActiveBattlePanel` | 可显示战斗信息和战术选择 | `activeBattles` 始终为空；只在独立 tab 显示 |
| `MilitaryTab` | 4 个独立 tab | 无交互闻环；旧军事行动卡片仍是主入口 |
| `useGameLoop.js` | 每日 tick 推进 | 未调用 `processCombatRound` 或 `processFrontTick` |
| `App.jsx` | 传递 props | 缺少 `onAssignCorpsToFront`/`onRemoveCorpsFromFront`/`onSetBattleTactic` 实现 |

### 设计理念

- **战线是战场**：所有战斗都发生在战线上，战线承载军团、资源点、设施
- **军团是作战单元**：玩家通过军团与战线交互，不再直接用全局 army 发起战斗
- **战斗是实时过程**：每日 tick 推进一个战斗回合，玩家可在战斗中改变战术
- **融合而非分割**：合并战线和战斗为统一视图（"战局"），而非分成两个独立 tab
- **可视化优先**：用进度条、动态指示器、色彩编码让战争态势一目了然

---

## 需求

### 需求 1：打通数据流 — 回调绑定与状态管理

**用户故事：** 作为一名玩家，我希望点击"增派军团"等按钮时能正常工作，以便我能实际操作军事系统。

#### 验收标准

1. WHEN 玩家在战线面板点击"增派军团" THEN 系统 SHALL 将选中军团分配到该战线，更新 `activeFronts` 中对应战线的 `assignedCorps`，并将军团状态设为 `deployed`
2. WHEN 玩家在战线面板点击"撤回"军团 THEN 系统 SHALL 将该军团从战线移除，恢复其状态为 `idle`
3. WHEN 玩家在战斗面板选择战术 THEN 系统 SHALL 更新对应 battle 中玩家方的 `tactic` 字段
4. IF App.jsx 渲染 MilitaryTab THEN 系统 SHALL 传递完整的 `onAssignCorpsToFront`、`onRemoveCorpsFromFront`、`onSetBattleTactic` 回调实现

---

### 需求 2：战斗引擎接入 Game Loop

**用户故事：** 作为一名玩家，我希望战斗每天自动推进一个回合，而不是瞬间结算，以便我能在战斗中实时调整战术。

#### 验收标准

1. WHEN game loop 每日 tick 执行 THEN 系统 SHALL 对每场 `status === 'active'` 的战斗调用 `processCombatRound`，推进一个回合
2. WHEN game loop 每日 tick 执行 THEN 系统 SHALL 对每条活跃战线调用 `processFrontTick`，处理资源再生等效果
3. WHEN 战斗回合产生伤亡 THEN 系统 SHALL 同步更新对应军团的 `units` 对象（减少阵亡单位），并同步到 `militaryCorps` 和全局 `army`
4. WHEN 战斗结束（status !== 'active'）THEN 系统 SHALL 根据战果更新军团状态（胜方恢复 idle，败方减员），更新对应 nation 的 `warScore`，并触发战利品结算
5. IF 战斗消耗补给（food/silver/弹药）THEN 系统 SHALL 从玩家资源中扣除；若补给不足，应用 `getSupplyPenalty` 的战力惩罚

---

### 需求 3：战线上发起战斗的入口

**用户故事：** 作为一名玩家，我希望能从战线上直接发起战斗（进攻/防御），而不是使用旧的"军事行动"卡片，以便战斗与战线有机结合。

#### 验收标准

1. WHEN 玩家的军团已部署到某战线且该战线有敌方军团 THEN 系统 SHALL 在战线面板显示"发起进攻"按钮
2. WHEN 玩家点击"发起进攻" THEN 系统 SHALL 使用战线上玩家方第一个可用军团作为攻方、敌方第一个军团作为守方，调用 `createBattle` 创建一场新的回合制战斗
3. WHEN 战线上玩家没有部署军团但敌方有军团 THEN 系统 SHALL 敌方每隔一定天数自动发起进攻（AI 主动攻击无防守战线）
4. IF 敌方在该战线没有军团（敌方未部署兵力）THEN 系统 SHALL 允许玩家发起"扫荡"行动，直接掠夺战线资源和破坏设施，无需战斗
5. WHEN 战斗在战线上发起时 THEN 系统 SHALL 自动根据双方兵力规模确定战斗类型（skirmish/pitched_battle/siege）
6. IF 同一战线上已有一场进行中的战斗 THEN 系统 SHALL 不允许发起新战斗（一条战线同时只进行一场战斗）

---

### 需求 4：AI 敌方军团自动生成与行为

**用户故事：** 作为一名玩家，我希望敌国在战线上也有军团和行为，而不只是空的占位符，以便战争有真正的对手。

#### 验收标准

1. WHEN 战线生成时 THEN 系统 SHALL 为敌方自动生成 1-3 个 AI 军团（根据敌国军事实力），包含与该国时代匹配的兵种
2. WHEN AI 军团部署到战线 THEN 系统 SHALL 自动为其生成一位 AI 将领（使用现有 `generateGeneral`）
3. WHEN 战线上双方都有军团但无进行中的战斗 THEN 系统 SHALL 每隔 5-15 天由 AI 发起一次进攻（如果 AI 兵力足够）
4. WHEN AI 的战斗结束后 THEN 系统 SHALL 让 AI 军团休整一段时间再发起下一次进攻
5. IF AI 军团在战斗中被消灭 THEN 系统 SHALL 根据敌国剩余军事实力，可能在一段时间后补充新的 AI 军团到战线

---

### 需求 5：UI 融合 — 统一战局视图

**用户故事：** 作为一名玩家，我希望战线和战斗不再是两个独立的 tab，而是融合为一个直观的"战局"视图，我能在同一个界面看到战线状态、部署军团、查看战斗进度、下达战术命令，以便获得沉浸式的战争指挥体验。

#### 验收标准

1. WHEN 玩家切换到军事 tab 的"战局"（合并原"战线"和"战斗"tab）THEN 系统 SHALL 显示所有活跃战线的卡片列表
2. WHEN 每条战线卡片展示时 THEN 系统 SHALL 包含以下可视化信息：
   - **战线头部**：敌国名称、战争持续天数、整体局势指示（优势/劣势/胶着的色彩条）
   - **兵力对比条**：左右两侧分别显示玩家/敌方总兵力，用宽度比例可视化表达力量对比
   - **已部署军团列表**：每个军团显示名称、兵力数、将领、士气条、当前状态（待命/战斗中）
   - **进行中的战斗内嵌面板**：如果该战线有活跃战斗，直接在战线卡片内展示（不需要切换到另一个 tab），包括回合进度条、态势条（momentum）、双方兵力伤亡、战术选择按钮
   - **战线资源点和设施**：折叠式显示，点击展开查看详细掠夺/破坏状态
3. WHEN 战线上有进行中的战斗 THEN 系统 SHALL 战斗信息直接内嵌在战线卡片中，用醒目的橙色/红色边框和脉冲动画表示
4. WHEN 战线上没有战斗但可以发起进攻 THEN 系统 SHALL 在军团部署区域下方显示"发起进攻"按钮
5. WHEN 玩家点击发起进攻 THEN 系统 SHALL 弹出简洁的确认界面（显示双方预估兵力、战斗类型预测），确认后创建战斗
6. IF 战线上无军团部署 THEN 系统 SHALL 显示醒目的"⚠️ 无防御"警告，并提示可用军团列表和快速部署按钮

---

### 需求 6：战斗结果与战线互动

**用户故事：** 作为一名玩家，我希望战斗胜利后能获得实际的战线掠夺和破坏成果，战败也有实际惩罚，以便战斗有意义和后果。

#### 验收标准

1. WHEN 玩家方在战线战斗中获胜 THEN 系统 SHALL 自动掠夺 1-2 个敌方资源点（调用 `plunderResourceNode`），并对 1 个敌方设施造成伤害（调用 `damageInfrastructure`）
2. WHEN 玩家方在战线战斗中失败 THEN 系统 SHALL 敌方自动掠夺 1-2 个玩家方资源点，并对 1 个玩家方设施造成伤害
3. WHEN 资源被掠夺 THEN 系统 SHALL 将掠夺的资源实际添加到玩家 `resources` 中（玩家胜利时），并在日志中记录
4. WHEN 设施被破坏达到 0 耐久 THEN 系统 SHALL 在战线面板中用视觉效果明确标识（删除线 + 灰色 + 破坏图标）
5. WHEN 战斗结束 THEN 系统 SHALL 更新对应 nation 的 `warScore`，胜方获得 +20~50 warScore，败方获得 -20~50 warScore
6. IF 战线上所有敌方资源点均被掠夺且所有设施被摧毁 THEN 系统 SHALL 显示"战线压制"状态，增加 AI 求和倾向

---

### 需求 7：旧军事行动系统的过渡

**用户故事：** 作为一名玩家，我希望新的战线战斗系统能平滑替代旧的"军事行动"卡片（遭遇战/大规模攻势/围城/焦土战术），以便不会丢失已有的游戏功能。

#### 验收标准

1. WHEN 玩家处于战争状态且有活跃战线 THEN 系统 SHALL 在战斗 tab 中显示新的战局视图（来自需求 5），而非旧的军事行动卡片
2. WHEN 玩家通过战局视图在战线上发起进攻 THEN 系统 SHALL 使用新的 `createBattle` + 回合制 `processCombatRound` 替代旧的 `simulateBattle` 瞬时结算
3. IF 旧的军事行动卡片中的功能（冷却/战利品/敌方构成预估）THEN 系统 SHALL 在新的战斗创建/结算流程中保留等价功能
4. WHEN 没有活跃战争时 THEN 系统 SHALL 战斗 tab 显示"暂无交战国"的提示（保持现有行为）

---

### 需求 8：边界情况与健壮性

**用户故事：** 作为一名玩家，我希望系统在各种边界情况下都能正常工作，不会出现卡死或数据不一致。

#### 验收标准

1. IF 战争突然结束（和平协议/投降）而战线上有进行中的战斗 THEN 系统 SHALL 立即结束所有相关战斗，恢复军团状态，清理战线
2. IF 参战军团在战斗进行中被解散（通过军团管理面板）THEN 系统 SHALL 终止相关战斗，将剩余兵力退回全局 army
3. IF 玩家同时有多条战线多场战斗 THEN 系统 SHALL 每条战线独立推进，不互相干扰
4. IF 敌方军团全部被消灭且敌国无力补充 THEN 系统 SHALL 战线进入"无抵抗"状态，允许玩家自由掠夺
5. WHEN 存档/读档时 THEN 系统 SHALL 正确保存和恢复所有战线、战斗、军团部署状态
