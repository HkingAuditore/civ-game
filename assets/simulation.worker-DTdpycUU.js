(function(){"use strict";const Lt={price:{livingCostWeight:.15,taxCostWeight:.1},wage:{livingCostWeight:.1,taxCostWeight:.1},market:{virtualDemandPerPop:.01,supplyDemandWeight:1,inventoryTargetDays:365,inventoryPriceImpact:.25,demandElasticity:.5,outputVariation:.2}},De={food:{name:"粮食",icon:"Wheat",color:"text-yellow-400",basePrice:1,minPrice:.1,maxPrice:10,defaultOwner:"peasant",unlockEpoch:0,tags:["essential","raw_material"],marketConfig:{supplyDemandWeight:.4,inventoryTargetDays:730,inventoryPriceImpact:.15,demandElasticity:.2,outputVariation:.2}},wood:{name:"木材",icon:"Trees",color:"text-emerald-400",basePrice:2,minPrice:.02,maxPrice:20,defaultOwner:"lumberjack",unlockEpoch:0,tags:["raw_material"],marketConfig:{supplyDemandWeight:.7,inventoryTargetDays:550,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},stone:{name:"石料",icon:"Pickaxe",color:"text-stone-400",basePrice:3,minPrice:.03,maxPrice:30,defaultOwner:"miner",unlockEpoch:0,tags:["raw_material"],marketConfig:{supplyDemandWeight:.7,inventoryTargetDays:550,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},cloth:{name:"布料",icon:"Shirt",color:"text-indigo-300",basePrice:1.5,minPrice:.015,maxPrice:15,defaultOwner:"worker",unlockEpoch:0,tags:["essential","raw_material","manufactured"],marketConfig:{supplyDemandWeight:.8,inventoryTargetDays:600,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},brick:{name:"砖块",icon:"Home",color:"text-red-400",basePrice:6,minPrice:.06,maxPrice:60,defaultOwner:"artisan",unlockEpoch:0,unlockTech:"pottery",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:270,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},tools:{name:"工具",icon:"Anvil",color:"text-blue-300",basePrice:16,minPrice:.16,maxPrice:160,defaultOwner:"artisan",unlockEpoch:0,unlockTech:"tool_making",tags:["industrial"],marketConfig:{supplyDemandWeight:1.2,inventoryTargetDays:300,inventoryPriceImpact:.35,demandElasticity:.6,outputVariation:.2}},plank:{name:"木板",icon:"TreeDeciduous",color:"text-amber-600",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"worker",unlockEpoch:1,unlockTech:"tools",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:240,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},copper:{name:"铜矿",icon:"Pickaxe",color:"text-orange-400",basePrice:5.5,minPrice:.055,maxPrice:55,defaultOwner:"miner",unlockEpoch:1,unlockTech:"copper_mining",tags:["raw_material"],marketConfig:{supplyDemandWeight:.9,inventoryTargetDays:300,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},dye:{name:"染料",icon:"Droplets",color:"text-pink-500",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"artisan",unlockEpoch:1,tags:["industrial","raw_material"],marketConfig:{supplyDemandWeight:1.1,inventoryTargetDays:200,inventoryPriceImpact:.35,demandElasticity:.6,outputVariation:.2}},papyrus:{name:"纸张",icon:"ScrollText",color:"text-lime-300",basePrice:6.5,minPrice:.065,maxPrice:65,defaultOwner:"scribe",unlockEpoch:2,unlockTech:"papyrus_cultivation",tags:["raw_material","manufactured"],marketConfig:{supplyDemandWeight:1.1,inventoryTargetDays:240,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},delicacies:{name:"珍馐",icon:"UtensilsCrossed",color:"text-rose-400",basePrice:24,minPrice:.24,maxPrice:240,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"culinary_arts",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.5,inventoryTargetDays:90,inventoryPriceImpact:.45,demandElasticity:1.3,outputVariation:.2}},furniture:{name:"家具",icon:"Armchair",color:"text-amber-500",basePrice:28,minPrice:.28,maxPrice:280,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"carpentry",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.5,inventoryTargetDays:120,inventoryPriceImpact:.4,demandElasticity:1.2,outputVariation:.2}},ale:{name:"美酒",icon:"Wine",color:"text-purple-400",basePrice:18,minPrice:.18,maxPrice:180,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"brewing",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.6,inventoryTargetDays:150,inventoryPriceImpact:.5,demandElasticity:1.5,outputVariation:.2}},fine_clothes:{name:"华服",icon:"Shirt",color:"text-purple-400",basePrice:32,minPrice:.32,maxPrice:320,defaultOwner:"artisan",unlockEpoch:2,tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.6,inventoryTargetDays:100,inventoryPriceImpact:.5,demandElasticity:1.5,outputVariation:.2}},iron:{name:"铁矿",icon:"Pickaxe",color:"text-zinc-400",basePrice:8,minPrice:.08,maxPrice:80,defaultOwner:"miner",unlockEpoch:2,unlockTech:"ironworking",tags:["raw_material"],marketConfig:{supplyDemandWeight:.8,inventoryTargetDays:500,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},spice:{name:"香料",icon:"Leaf",color:"text-amber-400",basePrice:26,minPrice:.26,maxPrice:260,defaultOwner:"merchant",unlockEpoch:4,unlockTech:"cartography",tags:["essential","manufactured"],marketConfig:{supplyDemandWeight:1.4,inventoryTargetDays:180,inventoryPriceImpact:.4,demandElasticity:.9,outputVariation:.2}},coffee:{name:"咖啡",icon:"Coffee",color:"text-amber-700",basePrice:24,minPrice:.24,maxPrice:240,defaultOwner:"merchant",unlockEpoch:5,unlockTech:"coffee_agronomy",tags:["essential","manufactured"],marketConfig:{supplyDemandWeight:1.2,inventoryTargetDays:240,inventoryPriceImpact:.35,demandElasticity:.8,outputVariation:.2}},coal:{name:"煤炭",icon:"Flame",color:"text-slate-300",basePrice:7.5,minPrice:.075,maxPrice:75,defaultOwner:"miner",unlockEpoch:6,unlockTech:"coal_gasification",tags:["raw_material"],marketConfig:{supplyDemandWeight:.9,inventoryTargetDays:365,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},steel:{name:"钢材",icon:"Cog",color:"text-gray-300",basePrice:40,minPrice:.4,maxPrice:400,defaultOwner:"engineer",unlockEpoch:6,unlockTech:"steel_alloys",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:300,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},silver:{name:"银币",icon:"Coins",color:"text-slate-200",type:"currency",basePrice:1,minPrice:1,maxPrice:1,unlockEpoch:0,tags:["currency"]},science:{name:"科研",icon:"Cpu",color:"text-cyan-400",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"official",unlockEpoch:0,tags:["special","manufactured"],marketConfig:{supplyDemandWeight:.5,inventoryTargetDays:730,inventoryPriceImpact:.15,demandElasticity:.2,outputVariation:.1}},culture:{name:"文化",icon:"ScrollText",color:"text-pink-400",basePrice:2,minPrice:.025,maxPrice:10,defaultOwner:"cleric",unlockEpoch:1,unlockTech:"amphitheater_design",tags:["special","manufactured"],marketConfig:{supplyDemandWeight:.6,inventoryTargetDays:600,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.15}},maxPop:{name:"人口上限",icon:"Users",color:"text-blue-400",type:"virtual",tags:["special"]},militaryCapacity:{name:"军事容量",icon:"Shield",color:"text-red-400",type:"virtual",tags:["special"]}},ba={MAX_HEAD_TAX:1e4},pi=[{id:0,name:"石器时代",color:"text-stone-400",bg:"bg-stone-900",tileColor:"bg-stone-700",req:{science:0},cost:{},bonuses:{desc:"文明的起源，一切从这里开始。",gatherBonus:.2}},{id:1,name:"青铜时代",color:"text-orange-400",bg:"bg-orange-950",tileColor:"bg-orange-800",req:{science:600,population:25},cost:{food:6e3,wood:3500,stone:1200,silver:600,science:600},bonuses:{desc:"掌握青铜冶炼与畜力生产，资源获取加速。",gatherBonus:.4,militaryBonus:.2,industryBonus:.2}},{id:2,name:"古典时代",color:"text-amber-300",bg:"bg-amber-900",tileColor:"bg-amber-700",req:{science:1800,population:90,culture:250},cost:{food:2e4,wood:1e4,brick:3600,silver:5e3,tools:1200,science:1800},bonuses:{desc:"哲学与艺术的萌芽，文明全方位提升。",gatherBonus:.6,militaryBonus:.3,cultureBonus:.2,scienceBonus:.2,industryBonus:.3,maxPop:.1}},{id:3,name:"封建时代",color:"text-blue-400",bg:"bg-blue-950",tileColor:"bg-blue-800",req:{science:4500,population:170,culture:600},cost:{food:1e5,wood:5e4,brick:25e3,iron:12500,papyrus:5e3,silver:15e3,science:4500},bonuses:{desc:"封建制度确立，人口与经济快速增长。",gatherBonus:.8,militaryBonus:.4,cultureBonus:.3,scienceBonus:.3,industryBonus:.4,taxIncome:.2}},{id:4,name:"探索时代",color:"text-cyan-300",bg:"bg-cyan-900",tileColor:"bg-cyan-700",req:{science:8e3,population:320,culture:1400},cost:{food:26e4,plank:7e4,brick:6e4,iron:35e3,silver:4e4,science:8e3},bonuses:{desc:"大航海开启，贸易与工业蓬勃发展。",gatherBonus:1.2,militaryBonus:.45,cultureBonus:.4,scienceBonus:.5,industryBonus:.6,incomePercent:.5}},{id:5,name:"启蒙时代",color:"text-purple-400",bg:"bg-purple-950",tileColor:"bg-purple-800",req:{science:12e3,population:450,culture:2500},cost:{food:35e4,plank:8e4,papyrus:3e4,spice:2e4,silver:5e4,science:12e3},bonuses:{desc:"理性的光辉照耀，科学与文化大幅提升。",gatherBonus:1.5,militaryBonus:.5,cultureBonus:.6,scienceBonus:.8,industryBonus:1,stability:10}},{id:6,name:"工业时代",color:"text-gray-200",bg:"bg-gray-800",tileColor:"bg-gray-600",req:{science:2e4,population:650,culture:4e3},cost:{food:75e4,brick:18e4,iron:12e4,tools:75e3,spice:3e4,silver:12e4,science:2e4},bonuses:{desc:"机械化大生产，工业产能爆炸式增长。",gatherBonus:2,militaryBonus:.6,cultureBonus:.8,scienceBonus:1.2,industryBonus:2,maxPop:.2}},{id:7,name:"信息时代",color:"text-green-400",bg:"bg-green-950",tileColor:"bg-green-800",req:{science:35e3,population:1e3,culture:8e3},cost:{food:2e6,tools:3e5,silver:25e4,spice:8e4,papyrus:1e5,science:35e3},bonuses:{desc:"数字革命改变世界，知识和信息成为核心生产力。",gatherBonus:3,militaryBonus:.8,cultureBonus:1.5,scienceBonus:3,industryBonus:3,incomePercent:1}}],ae={peasant:{name:"自耕农",icon:"Wheat",weight:1,tax:1,headTaxBase:.01,desc:"社会的基础，提供稳定的粮食和兵源。",wealthWeight:1,influenceBase:.5,startingWealth:80,defaultResource:"food",wealthElasticity:.5,maxConsumptionMultiplier:3,needs:{food:.42,cloth:.06},luxuryNeeds:{1:{ale:.05},1.5:{wood:.03,culture:.02},2:{plank:.045,stone:.015},2.5:{furniture:.03,tools:.03},3:{spice:.06,brick:.03,culture:.04},4.5:{copper:.006,plank:.02},5.5:{delicacies:.04,fine_clothes:.02,culture:.05},7:{coffee:.04,spice:.03},8:{delicacies:.05,culture:.06,furniture:.02}},buffs:{satisfied:{desc:"民心稳定",taxIncome:.1,production:.05},dissatisfied:{desc:"民怨沸腾",taxIncome:-.2,production:-.1}}},lumberjack:{name:"樵夫",icon:"Trees",weight:.8,tax:1.2,headTaxBase:.02,desc:"专职砍伐木材，维系城市建设。",wealthWeight:1,influenceBase:.4,startingWealth:90,defaultResource:"wood",wealthElasticity:.6,maxConsumptionMultiplier:3,needs:{food:.46,cloth:.07},luxuryNeeds:{1:{ale:.05},1.5:{stone:.015,culture:.02},2:{plank:.06,wood:.06},2.5:{tools:.03,furniture:.03},3:{spice:.045,brick:.035,culture:.045},4.5:{copper:.01,tools:.04,plank:.02},5.5:{delicacies:.04,fine_clothes:.02,culture:.05},7:{coffee:.05,spice:.03},8:{delicacies:.05,culture:.06,furniture:.02}},buffs:{satisfied:{desc:"林场顺畅",production:.06},dissatisfied:{desc:"供应迟滞",production:-.1}}},serf:{name:"佃农",icon:"Users",weight:.5,tax:2,headTaxBase:.015,desc:"依附于地主的农民，产出归地主所有。",wealthWeight:.5,influenceBase:.3,startingWealth:50,defaultResource:"food",wealthElasticity:.4,maxConsumptionMultiplier:3,needs:{food:.36,cloth:.05},luxuryNeeds:{1:{ale:.035},2:{culture:.015},2.5:{food:.08},3:{furniture:.015,plank:.03,tools:.01},4:{spice:.03,stone:.01,culture:.025},5:{ale:.03,cloth:.015},6:{delicacies:.02,brick:.02,culture:.03},7.5:{fine_clothes:.015,copper:.006},9:{coffee:.02,furniture:.01},10:{delicacies:.02,culture:.035}},buffs:{satisfied:{desc:"佃农勤恳",production:.08},dissatisfied:{desc:"佃农怠工",production:-.15}}},worker:{name:"工人",icon:"Hammer",weight:2,tax:3,headTaxBase:.03,desc:"工业时代的基石，推动生产力发展。",wealthWeight:2,influenceBase:1,startingWealth:80,defaultResource:"plank",wealthElasticity:.7,maxConsumptionMultiplier:3,needs:{food:.52,cloth:.09},luxuryNeeds:{1:{tools:.06,ale:.09},1.5:{plank:.03,culture:.03},2.5:{furniture:.045,spice:.03},3:{coffee:.04,brick:.04,culture:.04},4:{fine_clothes:.05,delicacies:.07,stone:.02},5:{steel:.02,copper:.015,culture:.08},6.5:{delicacies:.06,fine_clothes:.04,brick:.03,culture:.07},8:{papyrus:.035,furniture:.02},10:{coffee:.04,spice:.04,furniture:.04,culture:.07},12:{delicacies:.08,fine_clothes:.05,culture:.1}},buffs:{satisfied:{desc:"工人积极",industryBonus:.15},dissatisfied:{desc:"工人罢工",industryBonus:-.25}}},artisan:{name:"工匠",icon:"Anvil",weight:1.5,tax:3.5,headTaxBase:.035,desc:"技艺精湛的手工业者，负责加工铜器与印刷制品。",wealthWeight:2.5,influenceBase:1.2,startingWealth:200,defaultResource:"tools",wealthElasticity:.8,maxConsumptionMultiplier:6,needs:{food:.62,cloth:.11},luxuryNeeds:{1:{tools:.07,ale:.1,furniture:.05,culture:.04},1.8:{copper:.02,spice:.05},2.5:{coffee:.04,fine_clothes:.035,brick:.04,culture:.09},3.5:{delicacies:.09,stone:.035,dye:.025},4.5:{steel:.015,iron:.02,culture:.12},6:{tools:.06,copper:.03,furniture:.04,culture:.1},8:{papyrus:.05,furniture:.03},10:{coffee:.05,fine_clothes:.05,dye:.03,culture:.13},12:{delicacies:.1,culture:.18,spice:.04}},buffs:{satisfied:{desc:"坊市繁盛",production:.1},dissatisfied:{desc:"工坊停工",production:-.15}}},miner:{name:"矿工",icon:"Pickaxe",weight:1.2,tax:2.5,headTaxBase:.025,desc:"深入地下采集矿石，承担艰苦劳动。",wealthWeight:1.5,influenceBase:.8,startingWealth:120,defaultResource:"stone",wealthElasticity:.6,maxConsumptionMultiplier:4,needs:{food:.56,cloth:.1},luxuryNeeds:{1:{ale:.06},1.8:{wood:.04,tools:.015},2:{culture:.02},2.5:{furniture:.03,spice:.02,food:.2},3:{plank:.04,brick:.03,coffee:.025},4:{delicacies:.05,culture:.04},5.5:{copper:.015,steel:.01},7:{fine_clothes:.035,culture:.07},9:{ale:.06,delicacies:.05,culture:.06},11:{coffee:.04,fine_clothes:.035,culture:.08}},buffs:{satisfied:{desc:"矿脉稳定",gatherBonus:.1},dissatisfied:{desc:"矿难隐患",stability:-.1}}},merchant:{name:"商人",icon:"Coins",weight:6,tax:5,headTaxBase:.09,desc:"控制贸易网络的阶层，主宽港口与市场。",wealthWeight:8,influenceBase:3.5,startingWealth:500,defaultResource:"spice",wealthElasticity:1.5,maxConsumptionMultiplier:10,needs:{food:.7,cloth:.14},luxuryNeeds:{1:{delicacies:.6,spice:.2,furniture:.12,plank:.08,ale:.15,fine_clothes:.1,culture:.12,dye:.02},1.5:{coffee:.14},2:{delicacies:.35,plank:.12,brick:.05,culture:.2},3:{steel:.05,coal:.03},5:{papyrus:.08,copper:.06,stone:.05,culture:.3},8:{coffee:.1,spice:.18,fine_clothes:.1,culture:.2},12:{delicacies:.35,furniture:.1,culture:.35,dye:.03},18:{delicacies:.45,fine_clothes:.14,culture:.45,papyrus:.08}},buffs:{satisfied:{desc:"商贸兴隆",taxIncome:.15,gatherBonus:.05},dissatisfied:{desc:"贸易停滞",taxIncome:-.2,stability:-.1}},tradeConfig:{minProfitMargin:.1,maxPurchaseAmount:10,exportProbability:.5,maxInventoryRatio:.1,minWealthForTrade:10,tradeDuration:3,tradeCooldown:0,enableDebugLog:!0}},navigator:{name:"水手",icon:"Compass",weight:4,tax:3,headTaxBase:.06,desc:"探索时代的海员与测绘师，推动航海扩张。",wealthWeight:3,influenceBase:2.5,startingWealth:300,defaultResource:"spice",wealthElasticity:.7,maxConsumptionMultiplier:6,needs:{food:.6,cloth:.1},luxuryNeeds:{1:{spice:.12,ale:.12,culture:.05},1.8:{tools:.05},2.5:{coffee:.07,furniture:.07,culture:.09},3.5:{fine_clothes:.08,delicacies:.12,plank:.07},5:{copper:.05,steel:.03,culture:.15},7:{papyrus:.05},10:{brick:.08},14:{spice:.1,coffee:.06,fine_clothes:.06,culture:.2}},buffs:{satisfied:{desc:"海权扩张",gatherBonus:.1},dissatisfied:{desc:"航员哗变",gatherBonus:-.1,stability:-.1}}},scribe:{name:"学者",icon:"Feather",weight:2.5,tax:2,headTaxBase:.04,desc:"记录知识的学者，为图书馆与学院服务。",wealthWeight:2.5,influenceBase:1.5,startingWealth:250,defaultResource:"papyrus",wealthElasticity:1,maxConsumptionMultiplier:6,needs:{food:.62,cloth:.11},luxuryNeeds:{1:{papyrus:.1,furniture:.05,culture:.08},1.5:{coffee:.07},2:{fine_clothes:.05,plank:.025,culture:.15,science:.01},3:{delicacies:.09,spice:.05},5:{copper:.035,brick:.025,culture:.2,science:.03},7:{papyrus:.08,coffee:.05,culture:.12},10:{stone:.04},14:{cloth:.07},18:{steel:.015}},buffs:{satisfied:{desc:"文献井然",scienceBonus:.15},dissatisfied:{desc:"文献损失",scienceBonus:-.2}}},soldier:{name:"军人",icon:"Swords",weight:3,tax:1,headTaxBase:.04,desc:"维护国家安全，但也可能造成动荡。",wealthWeight:2,influenceBase:2,startingWealth:180,defaultResource:"tools",wealthElasticity:.6,maxConsumptionMultiplier:6,needs:{food:.6,cloth:.1},luxuryNeeds:{1:{ale:.08},1.5:{culture:.04},2:{tools:.07,copper:.025,iron:.02},2.5:{furniture:.05,spice:.05},3:{culture:.07},3.5:{fine_clothes:.07,delicacies:.07,steel:.025},5:{brick:.05,culture:.12},7:{coffee:.09,stone:.05},10:{steel:.03,tools:.04,culture:.1,delicacies:.06},14:{copper:.04,brick:.04,culture:.14}},buffs:{satisfied:{desc:"军心稳固",militaryPower:.2},dissatisfied:{desc:"军队哗变风险",militaryPower:-.3,stability:-.2}}},cleric:{name:"神职人员",icon:"Cross",weight:4,tax:.5,headTaxBase:.05,desc:"提供信仰和文化，安抚民心。",wealthWeight:3,influenceBase:3,startingWealth:220,defaultResource:"culture",wealthElasticity:.9,maxConsumptionMultiplier:6,needs:{food:.65,cloth:.11},luxuryNeeds:{1:{papyrus:.08,ale:.06,culture:.1},1.5:{plank:.02},2:{fine_clothes:.06,furniture:.06,stone:.04,culture:.18},3:{delicacies:.08,spice:.04},4.5:{copper:.04,brick:.04,culture:.25},6:{coffee:.05,steel:.01},8:{papyrus:.09},10:{culture:.15,fine_clothes:.05,delicacies:.06}},buffs:{satisfied:{desc:"宗教和谐",cultureBonus:.2,stability:.1},dissatisfied:{desc:"信仰危机",cultureBonus:-.15,stability:-.1}}},official:{name:"官员",icon:"ScrollText",weight:5,tax:2,headTaxBase:.08,desc:"政府管理者。",wealthWeight:5,influenceBase:4,startingWealth:400,defaultResource:"science",wealthElasticity:2.5,maxConsumptionMultiplier:50,greedy:!0,needs:{food:.85,cloth:.14},luxuryNeeds:{1:{delicacies:.5,papyrus:.12,coffee:.08,furniture:.1,stone:.04,fine_clothes:.1,culture:.15},1.3:{coffee:.06,culture:.08},1.8:{delicacies:.3,spice:.12,plank:.08,brick:.06},2:{culture:.25},2.5:{steel:.04,iron:.03,coal:.03},4:{papyrus:.08,copper:.04,stone:.04,culture:.35,science:.02},6:{fine_clothes:.15},9:{delicacies:.35,coffee:.1,culture:.4,science:.04},14:{delicacies:.45,fine_clothes:.12,papyrus:.08,culture:.55},20:{delicacies:.6,spice:.18,furniture:.1,culture:.7}},buffs:{satisfied:{desc:"吏治清明",taxIncome:.1},dissatisfied:{desc:"官员腐败",taxIncome:-.2}}},landowner:{name:"地主",icon:"Castle",weight:10,tax:5,headTaxBase:.07,desc:"传统精英，掌控土地和农业。",wealthWeight:10,influenceBase:5,startingWealth:800,defaultResource:"food",wealthElasticity:1.4,maxConsumptionMultiplier:10,needs:{food:.95,cloth:.15},luxuryNeeds:{1:{delicacies:.8,spice:.2,furniture:.18,brick:.1,plank:.1,fine_clothes:.15,culture:.2},1.3:{delicacies:.4,fine_clothes:.12},1.5:{culture:.28},1.8:{spice:.2,coffee:.1,stone:.08},2.5:{plank:.12,steel:.04,brick:.08,culture:.35},4:{copper:.06,papyrus:.04},6:{delicacies:.5,fine_clothes:.12,culture:.35},9:{delicacies:.65,coffee:.14,furniture:.12,culture:.45},14:{delicacies:.85,spice:.22,fine_clothes:.18,culture:.6},20:{delicacies:1.1,fine_clothes:.22,furniture:.16,culture:.8}},buffs:{satisfied:{desc:"贵族支持",taxIncome:.15,stability:.15},dissatisfied:{desc:"贵族叛乱",taxIncome:-.3,stability:-.25}}},capitalist:{name:"资本家",icon:"Briefcase",weight:15,tax:8,headTaxBase:.08,desc:"工业精英，提供投资和工业加成。",wealthWeight:20,influenceBase:6,startingWealth:1200,defaultResource:"steel",wealthElasticity:1.8,maxConsumptionMultiplier:10,needs:{food:1,cloth:.16},luxuryNeeds:{1:{delicacies:.7,coffee:.15,furniture:.15,steel:.05,culture:.25},1.3:{fine_clothes:.12},1.5:{culture:.3},1.8:{delicacies:.3,spice:.15,brick:.08},2.5:{stone:.06,plank:.1,coal:.04,iron:.03,culture:.45},4:{copper:.08,papyrus:.06,science:.03},6:{steel:.1,coal:.06,tools:.06,culture:.4},10:{delicacies:.55,coffee:.18,fine_clothes:.16,culture:.6,science:.06},15:{steel:.14,coal:.1,copper:.1,culture:.75},22:{delicacies:.85,spice:.25,furniture:.18,culture:1}},buffs:{satisfied:{desc:"资本繁荣",industryBonus:.25,scienceBonus:.15},dissatisfied:{desc:"资本外逃",industryBonus:-.3,taxIncome:-.25}}},knight:{name:"骑士",icon:"Shield",weight:8,tax:2,headTaxBase:.09,desc:"军事贵族，强大的战斗力。",wealthWeight:8,influenceBase:4,startingWealth:600,defaultResource:"tools",wealthElasticity:1,maxConsumptionMultiplier:10,needs:{food:.9,cloth:.14},luxuryNeeds:{1:{delicacies:.9,coffee:.1,furniture:.15,ale:.15,culture:.15},1.3:{delicacies:.4,fine_clothes:.1},1.5:{culture:.2},1.8:{spice:.12,steel:.04},2.5:{coffee:.08,brick:.06,stone:.04,culture:.3},4:{tools:.06,copper:.04,plank:.06},6:{steel:.06,tools:.04,culture:.25,delicacies:.25},10:{delicacies:.55,fine_clothes:.14,culture:.45},15:{steel:.1,copper:.06,culture:.6},22:{delicacies:.85,spice:.22,fine_clothes:.18,culture:.8}},buffs:{satisfied:{desc:"骑士忠诚",militaryPower:.25,stability:.1},dissatisfied:{desc:"骑士不满",militaryPower:-.2,stability:-.15}}},engineer:{name:"工程师",icon:"Cog",weight:7,tax:6,headTaxBase:.1,desc:"掌控蒸汽与机器的技术阶层。",wealthWeight:6,influenceBase:3.5,startingWealth:700,defaultResource:"steel",wealthElasticity:1.1,maxConsumptionMultiplier:10,needs:{food:.75,cloth:.12},luxuryNeeds:{1:{coffee:.12,ale:.08,furniture:.1,culture:.12},1.3:{fine_clothes:.08},1.8:{delicacies:.15,spice:.08,tools:.06},2:{culture:.2,science:.02},2.5:{plank:.08,copper:.04,stone:.04},4:{papyrus:.06,brick:.06,steel:.04,coal:.05,iron:.03,culture:.25},6:{steel:.08,tools:.08,coal:.08,culture:.25,science:.05},10:{coffee:.12,fine_clothes:.1,culture:.45,delicacies:.25},15:{steel:.12,copper:.08,coal:.12,culture:.6},22:{delicacies:.6,spice:.2,furniture:.14,culture:.75}},buffs:{satisfied:{desc:"工艺革新",industryBonus:.2,scienceBonus:.1},dissatisfied:{desc:"技术流失",industryBonus:-.25}}},unemployed:{name:"失业者",icon:"AlertTriangle",weight:.2,tax:1,headTaxBase:.01,desc:"暂时没有工作的平民，如果得不到安排会渐渐不满。",wealthWeight:.2,influenceBase:.3,startingWealth:30,wealthElasticity:.3,maxConsumptionMultiplier:3,needs:{food:.3,cloth:.04},luxuryNeeds:{2.5:{ale:.04,food:.1},3.5:{furniture:.01},4.5:{plank:.01,culture:.002},5.5:{tools:.004},7:{spice:.008},9:{brick:.006}},buffs:{satisfied:{desc:"等待机会",stability:.02},dissatisfied:{desc:"失业动荡",stability:-.1}}}},Vt=[{id:"farm",name:"农田",desc:"提供自耕农岗位。",baseCost:{wood:12},output:{food:4.8},jobs:{peasant:3},owner:"peasant",epoch:0,cat:"gather",visual:{icon:"Wheat",color:"bg-yellow-700",text:"text-yellow-200"},marketConfig:{price:{livingCostWeight:.08,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.05}}},{id:"trading_post",name:"贸易站",desc:"原始的物资交换场所，提供商人岗位。",baseCost:{wood:50,stone:10},output:{food:4,silver:1.6},jobs:{merchant:2},owner:"merchant",epoch:0,cat:"civic",requiresTech:"barter",visual:{icon:"Handshake",color:"bg-amber-800",text:"text-amber-200"}},{id:"large_estate",name:"庄园",desc:"地主控制的土地，雇佣佃农。",baseCost:{wood:100,plank:25},output:{food:24},jobs:{serf:8,landowner:1},owner:"landowner",epoch:3,cat:"gather",requiresTech:"feudalism",visual:{icon:"Castle",color:"bg-amber-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05,wageMode:"subsistence",subsistenceMultiplier:1.5}}},{id:"lumber_camp",name:"伐木场",desc:"砍伐木材，基础采集建筑。",baseCost:{food:18},input:{},output:{wood:3.84},jobs:{lumberjack:3},owner:"lumberjack",epoch:0,cat:"gather",visual:{icon:"Trees",color:"bg-emerald-800",text:"text-emerald-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"quarry",name:"采石场",desc:"开采石料，基础采集建筑。",baseCost:{wood:55},input:{},output:{stone:3},jobs:{miner:3},owner:"miner",epoch:0,cat:"gather",visual:{icon:"Pickaxe",color:"bg-stone-600",text:"text-stone-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"copper_mine",name:"铜矿井",desc:"开采铜矿石，需要少量工具维护。",baseCost:{food:120,wood:120},input:{tools:.0267},output:{copper:.6667},jobs:{miner:4},owner:"miner",epoch:1,cat:"gather",requiresTech:"copper_mining",visual:{icon:"Gem",color:"bg-orange-700",text:"text-orange-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"reed_works",name:"造纸工坊",desc:"生产纸张的手工作坊。",baseCost:{food:140,wood:80},input:{wood:.75},output:{papyrus:.9},jobs:{worker:3},owner:"worker",epoch:2,cat:"industry",requiresTech:"papyrus_cultivation",visual:{icon:"ScrollText",color:"bg-lime-800",text:"text-lime-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"culinary_kitchen",name:"烹饪坊",desc:"将粮食烹饪为珍馐，供上层阶级享用。",baseCost:{wood:100,stone:60,brick:30},input:{tools:.1333,food:2},output:{delicacies:2},jobs:{artisan:3,peasant:1},owner:"artisan",epoch:2,cat:"industry",requiresTech:"culinary_arts",visual:{icon:"UtensilsCrossed",color:"bg-rose-800",text:"text-rose-200"}},{id:"brewery",name:"酿造坊",desc:"将粮食发酵酿造成美酒，供贸易与享用。",baseCost:{wood:90,stone:50,brick:25},input:{food:1.8,wood:.3},output:{ale:1.8},jobs:{worker:3},owner:"worker",epoch:2,cat:"industry",requiresTech:"brewing",visual:{icon:"Wine",color:"bg-purple-800",text:"text-purple-200"},marketConfig:{price:{livingCostWeight:.4,taxCostWeight:.5},wage:{livingCostWeight:.25,taxCostWeight:.25}}},{id:"furniture_workshop",name:"家具工坊",desc:"将木板与布料雕刻成精美家具，提升上层阶级的生活品质。",baseCost:{plank:120,stone:80},input:{tools:.1333,plank:1.3333,cloth:.4},output:{furniture:1.6},jobs:{artisan:4},owner:"artisan",epoch:2,cat:"industry",requiresTech:"carpentry",visual:{icon:"Armchair",color:"bg-amber-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.4},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"loom_house",name:"织布坊",desc:"家庭式纺纱织布，保障民众衣物供应。",baseCost:{wood:35,food:20},output:{cloth:2.88},jobs:{worker:3},owner:"worker",epoch:0,cat:"industry",visual:{icon:"Shirt",color:"bg-indigo-800",text:"text-indigo-200"},marketConfig:{price:{livingCostWeight:.12,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"dye_works",name:"染坊",desc:"从植物中提取染料，用于制作高级织物。",baseCost:{wood:60,stone:20},input:{food:.75},output:{dye:.9},jobs:{worker:3},owner:"worker",epoch:1,cat:"industry",visual:{icon:"Paintbrush",color:"bg-pink-800",text:"text-pink-200"}},{id:"tailor_workshop",name:"成衣作坊",desc:"使用布料和染料制作精美的华服，供上层阶级享用。",baseCost:{wood:100,stone:40},input:{tools:.06,cloth:1.5,dye:.3},output:{fine_clothes:1.2,culture:.5},jobs:{artisan:3},owner:"artisan",epoch:1,cat:"industry",requiresTech:"tools",visual:{icon:"Package",color:"bg-indigo-900",text:"text-indigo-100"}},{id:"mine",name:"铁矿井",desc:"深入岩层采集铁矿，需要工具维护。",baseCost:{plank:120,food:220},input:{tools:.072},output:{iron:.9},jobs:{miner:9,landowner:1},owner:"landowner",epoch:2,cat:"gather",requiresTech:"ironworking",visual:{icon:"Mountain",color:"bg-zinc-700",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"coffee_plantation",name:"咖啡种植园",desc:"开垦远方殖民地的咖啡种植地。",baseCost:{wood:200,spice:30},output:{coffee:.6},jobs:{serf:6,merchant:1},owner:"merchant",epoch:5,cat:"gather",requiresTech:"coffee_agronomy",visual:{icon:"Coffee",color:"bg-amber-900",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.05,taxCostWeight:.05,wageMode:"subsistence",subsistenceMultiplier:1.3}}},{id:"coal_mine",name:"煤矿",desc:"开采地下煤炭，工业能源基石。",baseCost:{plank:200,tools:60},input:{tools:.2},output:{coal:3},jobs:{miner:12,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"coal_gasification",visual:{icon:"Flame",color:"bg-slate-700",text:"text-slate-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"hut",name:"简陋小屋",desc:"增加人口上限。",baseCost:{wood:20,food:20},output:{maxPop:3},epoch:0,cat:"civic",visual:{icon:"Tent",color:"bg-orange-800",text:"text-orange-200"}},{id:"house",name:"木屋",desc:"以木板与砖块搭建的整洁居所。",baseCost:{plank:60,brick:40},output:{maxPop:8},epoch:2,cat:"civic",requiresTech:"urban_planning",visual:{icon:"Home",color:"bg-amber-700",text:"text-amber-100"}},{id:"manor_house",name:"石砌宅邸",desc:"贵族风格的石砌住宅，坚固耐久，彰显领主权威。",baseCost:{brick:120,plank:80,iron:15},output:{maxPop:9},epoch:3,cat:"civic",requiresTech:"manor_architecture",visual:{icon:"Castle",color:"bg-blue-800",text:"text-blue-200"}},{id:"townhouse",name:"联排住宅",desc:"港口城市流行的多层联排建筑，高效利用城市空间。",baseCost:{brick:180,plank:120,tools:25},output:{maxPop:10},epoch:4,cat:"civic",requiresTech:"colonial_architecture",visual:{icon:"Building",color:"bg-cyan-800",text:"text-cyan-200"}},{id:"civic_apartment",name:"阁楼公馆",desc:"启蒙时代流行的多层砖石建筑，优雅的阁楼设计为新兴中产阶级提供舒适居所。",baseCost:{brick:250,plank:150,iron:40,furniture:20},output:{maxPop:11},epoch:5,cat:"civic",requiresTech:"enlightened_urbanism",visual:{icon:"Building2",color:"bg-purple-800",text:"text-purple-200"}},{id:"granary",name:"粮仓",desc:"加固的干燥粮仓，提升人口承载。",baseCost:{wood:120,brick:40,stone:30},output:{maxPop:6},epoch:1,cat:"civic",requiresTech:"granary_architecture",visual:{icon:"Boxes",color:"bg-yellow-900",text:"text-yellow-200"}},{id:"town_hall",name:"市政厅",desc:"官员办公地，提供官员岗位，需要少量维护。",baseCost:{brick:200,plank:200,cloth:20},input:{brick:.2,papyrus:.02,delicacies:.1,fine_clothes:.05,culture:.03,science:.05},output:{},jobs:{official:7},epoch:3,cat:"civic",requiresTech:"bureaucracy",visual:{icon:"Scale",color:"bg-slate-800",text:"text-slate-200"}},{id:"church",name:"教堂",desc:"安抚民心，产出文化。",baseCost:{stone:150,plank:50,brick:60},input:{furniture:.1333,fine_clothes:.1333,brick:.0533},output:{culture:3.2,silver:.6667},jobs:{cleric:4},owner:"cleric",epoch:3,cat:"civic",requiresTech:"theology",visual:{icon:"Cross",color:"bg-purple-900",text:"text-purple-200"}},{id:"monastery_cellar",name:"修道院酒窖",desc:"修道士传承的酿酒技艺，出产上等美酒，彰显宗教文化。",baseCost:{stone:120,brick:60,tools:15},input:{food:2.7,wood:.45},output:{ale:3,culture:1.2},jobs:{cleric:1,worker:3},owner:"cleric",epoch:3,cat:"industry",requiresTech:"monastic_brewing",visual:{icon:"Wine",color:"bg-purple-800",text:"text-purple-200"}},{id:"wool_workshop",name:"纺织工场",desc:"规模化的羊毛加工作坊，封建领地的重要经济支柱。",baseCost:{plank:100,brick:50,tools:15},input:{food:.9,tools:.045},output:{cloth:4.8,fine_clothes:.3},jobs:{serf:4,worker:3},owner:"worker",epoch:3,cat:"industry",requiresTech:"wool_trade",visual:{icon:"Shirt",color:"bg-indigo-700",text:"text-indigo-200"},marketConfig:{price:{livingCostWeight:.12,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.08,wageMode:"subsistence",subsistenceMultiplier:1.8}}},{id:"stone_workshop",name:"采石工场",desc:"使用铁器工具的专业采石场，为城堡和教堂建设提供大量优质石料。",baseCost:{plank:80,iron:30,tools:20},input:{tools:.075},output:{stone:4.375},jobs:{miner:4,worker:1},owner:"miner",epoch:3,cat:"gather",requiresTech:"masonry_guild",visual:{icon:"Pickaxe",color:"bg-stone-700",text:"text-stone-200"}},{id:"hardwood_camp",name:"硬木林场",desc:"有计划的森林采伐，提供大量木材与优质硬木。",baseCost:{plank:100,iron:25,tools:25},input:{tools:.096},output:{wood:5.76},jobs:{lumberjack:5,worker:1},owner:"lumberjack",epoch:3,cat:"gather",requiresTech:"forestry_management",visual:{icon:"Trees",color:"bg-emerald-900",text:"text-emerald-200"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"amphitheater",name:"剧场",desc:"古典时代的文化舞台，激发灵感。",baseCost:{stone:200,brick:80,dye:10},input:{fine_clothes:.225,brick:.045},output:{culture:5.4},jobs:{cleric:3},owner:"cleric",epoch:1,cat:"civic",requiresTech:"amphitheater_design",visual:{icon:"Music2",color:"bg-rose-900",text:"text-rose-200"}},{id:"navigator_school",name:"航海学院",desc:"培养探索时代的开路者，产出科研文化。",baseCost:{wood:160,papyrus:80,brick:70},output:{science:.75,culture:1},jobs:{navigator:3,scribe:1,official:1},owner:"official",epoch:4,cat:"civic",requiresTech:"navigator_schooling",visual:{icon:"Navigation",color:"bg-cyan-900",text:"text-cyan-200"}},{id:"shaft_mine",name:"竖井矿场",desc:"利用绞盘与更好的通风设施深入地下，同时开采铜铁矿脉。",baseCost:{brick:150,plank:100,tools:50},input:{tools:.144,wood:.3,science:.05},output:{iron:1.44,copper:.96},jobs:{miner:6,engineer:1},owner:"miner",epoch:4,cat:"gather",requiresTech:"advanced_metallurgy",visual:{icon:"Mountain",color:"bg-zinc-600",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"dye_workshop",name:"印染工坊",desc:"使用新世界染料的专业印染作坊，如珍贵的胭脂虫红。",baseCost:{brick:100,plank:80,tools:20},input:{food:1.2,cloth:.6,spice:.075,science:.02},output:{dye:1.8,fine_clothes:.45},jobs:{artisan:3,worker:2},owner:"artisan",epoch:4,cat:"industry",requiresTech:"new_world_dyes",visual:{icon:"Paintbrush",color:"bg-rose-800",text:"text-rose-200"}},{id:"coffee_house",name:"咖啡馆",desc:"啜饮咖啡、交流思想的启蒙沙龙。",baseCost:{plank:140,coffee:40,cloth:20,delicacies:15,science:100},input:{coffee:.5333,delicacies:.2667},output:{culture:4,science:1.3333},jobs:{merchant:1,scribe:3},owner:"merchant",epoch:5,cat:"civic",requiresTech:"coffeehouse_philosophy",visual:{icon:"Coffee",color:"bg-brown-900",text:"text-amber-200"}},{id:"rail_depot",name:"铁路枢纽",desc:"蒸汽时代的交通心脏，连接全国贸易，提供岗位和人口上限。",baseCost:{steel:180,coal:120,science:300},input:{coal:.72,ale:.36,delicacies:.18,science:.15},output:{silver:2.7,maxPop:14},jobs:{engineer:4,merchant:3,capitalist:1},owner:"capitalist",epoch:6,cat:"civic",requiresTech:"rail_network",visual:{icon:"Train",color:"bg-gray-900",text:"text-gray-100"}},{id:"sawmill",name:"锯木厂",desc:"在铜制工具辅助下高效加工木板。",baseCost:{wood:75,stone:35},input:{wood:1.6},output:{plank:3.47},jobs:{worker:4},owner:"worker",epoch:1,requiresTech:"tools",cat:"industry",visual:{icon:"Hammer",color:"bg-amber-900",text:"text-amber-300"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"brickworks",name:"砖窯",desc:"烧制砖块，供城墙与民宅所用。",baseCost:{wood:140,stone:90},input:{stone:1.5,wood:.45},output:{brick:3.6},jobs:{worker:3},owner:"worker",epoch:0,cat:"industry",requiresTech:"pottery",visual:{icon:"Factory",color:"bg-red-900",text:"text-red-300"}},{id:"stone_tool_workshop",name:"石器作坊",desc:"用燧石和木料打制粗糙的工具。",baseCost:{wood:40,stone:25},input:{wood:1.5,stone:1.2},output:{tools:.75},jobs:{artisan:3},owner:"artisan",epoch:0,cat:"industry",requiresTech:"tool_making",visual:{icon:"Hammer",color:"bg-stone-700",text:"text-stone-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"bronze_foundry",name:"青铜铸坊",desc:"熔炼铜与木炭，制造精良工具。",baseCost:{wood:140,stone:75,copper:35},input:{copper:.8,wood:.5333},output:{tools:1.3333},jobs:{worker:3,artisan:1},owner:"artisan",epoch:1,cat:"industry",requiresTech:"bronze_working",visual:{icon:"Anvil",color:"bg-orange-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"iron_tool_workshop",name:"铁器铺",desc:"以铁为原料，锻造坚固耐用的工具。",baseCost:{plank:150,brick:80},input:{wood:.6667,iron:1.0667},output:{tools:2},jobs:{worker:3,artisan:1},owner:"artisan",epoch:2,cat:"industry",requiresTech:"ironworking",visual:{icon:"Cog",color:"bg-zinc-800",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"factory",name:"工厂",desc:"蒸汽驱动的流水线生产工具与机械。",baseCost:{brick:400,steel:200,science:350},input:{steel:2,coal:2,science:.5},output:{tools:15},jobs:{worker:20,engineer:4,capitalist:1},owner:"capitalist",epoch:6,requiresTech:"industrialization",cat:"industry",visual:{icon:"Factory",color:"bg-blue-900",text:"text-blue-200"}},{id:"printing_house",name:"印刷所",desc:"启蒙时代的出版重镇，大量复制知识。",baseCost:{brick:200,papyrus:80,wood:60,science:150},input:{papyrus:.8,coffee:.2,brick:.08,science:.3},output:{science:2.4,culture:2},jobs:{artisan:5,scribe:3,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"printing_press",visual:{icon:"BookOpen",color:"bg-indigo-900",text:"text-indigo-200"}},{id:"steel_foundry",name:"炼钢厂",desc:"以煤炭为燃料的炼钢炉，供应工业时代钢材。",baseCost:{brick:300,iron:200,science:280},input:{iron:.7,coal:.7,science:.2},output:{steel:.7},jobs:{engineer:5,worker:7,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"steel_alloys",visual:{icon:"Cog",color:"bg-gray-900",text:"text-gray-200"}},{id:"library",name:"图书馆",desc:"编目典籍，持续产出科研。",baseCost:{wood:200,stone:100},output:{science:1.0667},jobs:{scribe:4},owner:"scribe",epoch:0,cat:"civic",visual:{icon:"Landmark",color:"bg-cyan-800",text:"text-cyan-200"}},{id:"market",name:"市场",desc:"自动平衡市场供需：将盈余的滞销资源出口，换取急需的短缺资源。产出少量商业税收。",baseCost:{plank:100},input:{brick:.075},output:{food:3},jobs:{merchant:3},owner:"merchant",epoch:1,requiresTech:"caravan_trade",cat:"civic",visual:{icon:"Handshake",color:"bg-yellow-800",text:"text-yellow-200"}},{id:"magistrate_office",name:"官署",desc:"早期行政机构，管理青铜时代的税收与民政。提供少量官员岗位。",baseCost:{plank:80,stone:60,brick:40},input:{papyrus:.015,brick:.03},output:{},jobs:{official:3,scribe:1},epoch:1,cat:"civic",requiresTech:"early_administration",visual:{icon:"Scroll",color:"bg-slate-700",text:"text-slate-200"}},{id:"dockyard",name:"船坞",desc:"建造远洋船队，换取异域香料。",baseCost:{plank:200,tools:40},input:{wood:.6},output:{spice:.84},jobs:{navigator:3,worker:2,merchant:1},owner:"merchant",epoch:4,cat:"industry",requiresTech:"cartography",visual:{icon:"Anchor",color:"bg-sky-900",text:"text-sky-200"}},{id:"trade_port",name:"贸易港",desc:"汇聚香料、银币与海外特许的繁忙港口。",baseCost:{plank:220,spice:60},input:{spice:.4},output:{food:2.6667},jobs:{merchant:4},owner:"merchant",epoch:4,cat:"civic",requiresTech:"charter_companies",visual:{icon:"Ship",color:"bg-indigo-900",text:"text-indigo-200"}},{id:"barracks",name:"兵营",desc:"训练和驻扎军队的基地，提供军事容量。",baseCost:{wood:80,stone:40},output:{militaryCapacity:10},epoch:0,cat:"military",visual:{icon:"Shield",color:"bg-red-900",text:"text-red-200"}},{id:"training_ground",name:"训练场",desc:"专业的军事训练设施，大幅提升军事容量。",baseCost:{plank:150,brick:80,iron:30},output:{militaryCapacity:20},epoch:2,cat:"military",requiresTech:"military_training",visual:{icon:"Swords",color:"bg-red-800",text:"text-red-100"}},{id:"fortress",name:"要塞",desc:"坚固的军事堡垒，可容纳大量军队。",baseCost:{brick:300,iron:150,steel:50},output:{militaryCapacity:40},epoch:4,cat:"military",requiresTech:"fortification",visual:{icon:"Castle",color:"bg-red-950",text:"text-red-100"}},{id:"textile_mill",name:"纺织厂",desc:"水力驱动的纺织机，大幅提升布料和成衣产量。",baseCost:{brick:180,plank:120,tools:60,science:150},input:{food:2,dye:.75},output:{cloth:12.5,fine_clothes:1.5},jobs:{worker:15,artisan:4,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"mechanized_weaving",visual:{icon:"Shirt",color:"bg-indigo-700",text:"text-indigo-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"garment_factory",name:"服装工厂",desc:"蒸汽动力缝纫机的大规模成衣生产线。",baseCost:{brick:350,steel:150,tools:100,science:300},input:{cloth:3.75,dye:.75,coal:.45},output:{fine_clothes:4.2,culture:.45},jobs:{worker:18,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"assembly_line",visual:{icon:"Factory",color:"bg-indigo-900",text:"text-indigo-100"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"lumber_mill",name:"木材加工厂",desc:"水力锯木机与烘干设备，高效生产优质木板。",baseCost:{brick:160,plank:100,tools:50},input:{wood:6.4286},output:{plank:17.1429},jobs:{worker:10,artisan:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"hydraulic_sawing",visual:{icon:"Axe",color:"bg-amber-700",text:"text-amber-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.12,taxCostWeight:.12}}},{id:"furniture_factory",name:"家具工厂",desc:"流水线生产标准化家具，满足城市中产阶级需求。",baseCost:{brick:280,steel:120,tools:80,science:280},input:{plank:5.625,cloth:1.8,coal:.5625},output:{furniture:7.875,culture:.45},jobs:{worker:17,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"mass_production",visual:{icon:"Armchair",color:"bg-amber-900",text:"text-amber-100"},marketConfig:{price:{livingCostWeight:.28,taxCostWeight:.32},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"metallurgy_workshop",name:"冶金工坊",desc:"改良的熔炉与锻造技术，高效生产精良工具。",baseCost:{brick:200,iron:100,tools:60},input:{iron:1.7143,copper:.3429,wood:.9143},output:{tools:3.4286},jobs:{worker:5,artisan:2,engineer:1},owner:"artisan",epoch:4,cat:"industry",requiresTech:"advanced_metallurgy",visual:{icon:"Anvil",color:"bg-zinc-700",text:"text-zinc-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"steel_works",name:"钢铁联合体",desc:"垂直整合的大型钢铁企业，从矿石到成品一条龙生产。",baseCost:{brick:500,steel:250,tools:150,science:400},input:{iron:1.44,coal:1.2,science:.4},output:{steel:1.44,tools:.96},jobs:{worker:18,engineer:5,capitalist:2},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"bessemer_process",visual:{icon:"Factory",color:"bg-gray-800",text:"text-gray-100"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"building_materials_plant",name:"建材厂",desc:"规模化生产砖块和预制建材，加速城市建设。",baseCost:{brick:200,plank:100,tools:50},input:{stone:4.5,wood:1.35,coal:.45},output:{brick:12.375},jobs:{worker:14,engineer:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"industrial_ceramics",visual:{icon:"Building2",color:"bg-red-800",text:"text-red-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.12,taxCostWeight:.12}}},{id:"prefab_factory",name:"预制构件厂",desc:"生产标准化建筑构件，革命性地改变建筑行业。",baseCost:{brick:400,steel:200,tools:100,science:350},input:{brick:3,steel:.4,stone:2,coal:.8},output:{brick:22},jobs:{worker:20,engineer:4,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"standardized_construction",visual:{icon:"Building",color:"bg-slate-700",text:"text-slate-100"},marketConfig:{price:{livingCostWeight:.28,taxCostWeight:.32},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"cannery",name:"罐头厂",desc:"革命性的食品保存技术，将珍馐装罐长期保存。",baseCost:{brick:250,steel:100,tools:60,science:280},input:{food:5.625,iron:.675,coal:.5625},output:{delicacies:7.875},jobs:{worker:17,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"food_preservation",visual:{icon:"Package",color:"bg-orange-800",text:"text-orange-100"},marketConfig:{price:{livingCostWeight:.22,taxCostWeight:.28},wage:{livingCostWeight:.14,taxCostWeight:.14}}},{id:"distillery",name:"蒸馏酒厂",desc:"工业化的酿酒设施，生产高度烈酒供出口贸易。",baseCost:{brick:220,copper:80,tools:50,science:140},input:{food:4.5,coal:.45},output:{ale:7.875,silver:1.8},jobs:{worker:12,artisan:2,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"distillation",visual:{icon:"Wine",color:"bg-purple-700",text:"text-purple-100"},marketConfig:{price:{livingCostWeight:.35,taxCostWeight:.4},wage:{livingCostWeight:.22,taxCostWeight:.22}}},{id:"paper_mill",name:"造纸厂",desc:"工业化造纸设备，用木浆大规模生产纸张。",baseCost:{brick:180,plank:100,tools:50,science:130},input:{wood:3,coal:.3},output:{papyrus:5},jobs:{worker:10,engineer:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"wood_pulp_process",visual:{icon:"ScrollText",color:"bg-lime-700",text:"text-lime-100"},marketConfig:{price:{livingCostWeight:.18,taxCostWeight:.22},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"publishing_house",name:"出版社",desc:"现代印刷与发行一体化，传播知识启迪民智。",baseCost:{brick:300,steel:80,papyrus:100,science:320},input:{papyrus:2,coffee:.4,coal:.3},output:{science:5,culture:2},jobs:{scribe:8,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"mass_media",visual:{icon:"Newspaper",color:"bg-cyan-800",text:"text-cyan-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"industrial_mine",name:"工业矿场",desc:"蒸汽动力的深井采矿设备，大幅提升矿石产量。",baseCost:{brick:350,steel:200,tools:100},input:{tools:.2615,coal:.5231},output:{iron:2.9616,copper:.9577},jobs:{miner:17,engineer:2,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"deep_shaft_mining",visual:{icon:"Mountain",color:"bg-zinc-800",text:"text-zinc-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"mechanized_farm",name:"机械化农场",desc:"蒸汽拖拉机与收割机，农业产量飞跃式提升。",baseCost:{brick:200,steel:150,tools:80},input:{tools:.175,coal:.35},output:{food:38.5},jobs:{peasant:8,worker:8,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"agricultural_machinery",visual:{icon:"Tractor",color:"bg-green-800",text:"text-green-100"},marketConfig:{price:{livingCostWeight:.18,taxCostWeight:.22},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"logging_company",name:"伐木公司",desc:"配备蒸汽锯和运输铁路的大型伐木企业。",baseCost:{brick:180,steel:100,tools:60},input:{tools:.1333,coal:.25},output:{wood:20},jobs:{lumberjack:11,worker:7,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"steam_logging",visual:{icon:"TreeDeciduous",color:"bg-emerald-700",text:"text-emerald-100"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"apartment_block",name:"公寓楼",desc:"多层住宅建筑，容纳大量城市人口。",baseCost:{brick:400,steel:100,plank:150},output:{maxPop:11},epoch:6,cat:"civic",requiresTech:"urban_architecture",visual:{icon:"Building2",color:"bg-slate-600",text:"text-slate-100"}},{id:"university",name:"大学",desc:"高等学府，培养工程师和学者，产出大量科研。",baseCost:{brick:400,plank:200,papyrus:100,science:200},input:{papyrus:.36,coffee:.24,delicacies:.18,brick:.072,science:.5},output:{science:3.6,culture:.96},jobs:{scribe:5,engineer:2,official:2},owner:"official",epoch:5,cat:"civic",requiresTech:"higher_education",visual:{icon:"GraduationCap",color:"bg-blue-900",text:"text-blue-100"}},{id:"opera_house",name:"歌剧院",desc:"华丽的艺术殿堂，展示文明的文化成就。",baseCost:{brick:350,plank:150,furniture:80,culture:40,dye:20,science:160},input:{fine_clothes:.2857,delicacies:.2286,brick:.0571},output:{culture:4,silver:1.1429},jobs:{cleric:5,artisan:2,merchant:1},owner:"cleric",epoch:5,cat:"civic",requiresTech:"grand_arts",visual:{icon:"Music",color:"bg-rose-800",text:"text-rose-100"}},{id:"stock_exchange",name:"证券交易所",desc:"金融资本的神经中枢，调配全国资金流向。",baseCost:{brick:500,steel:150,papyrus:100,science:400},input:{papyrus:.32,coffee:.24},output:{silver:8,culture:.8},jobs:{merchant:10,scribe:3,capitalist:2},owner:"capitalist",epoch:6,cat:"civic",requiresTech:"financial_capitalism",visual:{icon:"TrendingUp",color:"bg-emerald-900",text:"text-emerald-100"}}],tr=[{id:"barter",name:"物物交换",desc:"允许建造贸易站，让商人阶层登上历史舞台。财政收入 +2%。",cost:{science:150},epoch:0,effects:{incomePercent:.02}},{id:"stone_axes",name:"磨制石斧",desc:"伐木场产出提升 25%。",cost:{science:150},epoch:0,effects:{buildings:{lumber_camp:.12}}},{id:"flint_knapping",name:"打制燧石",desc:"采石场效率增加 25%。",cost:{science:210},epoch:0,effects:{buildings:{quarry:.12}}},{id:"animal_husbandry",name:"畜牧业",desc:"驯养牲畜，每人每日额外获得 0.1 粮食。",cost:{science:240},epoch:0,effects:{perPopPassive:{food:.1}}},{id:"pottery",name:"陶器",desc:"农田储粮效率 +10%。",cost:{science:300},epoch:0,effects:{buildings:{farm:.05}}},{id:"tool_making",name:"工具制作",desc:"解锁石器作坊，提供早期稳定的工具来源。采集建筑效率 +10%。",cost:{science:270},epoch:0,effects:{categories:{gather:.05}}},{id:"basic_irrigation",name:"基础灌溉",desc:"开凿浅渠把河水引入农田，产量提升 15%。",cost:{science:360},epoch:0,effects:{buildings:{farm:.08}}},{id:"oral_tradition",name:"口述传统",desc:"长者口述史诗，图书馆的整理效率提升 15%。",cost:{science:330},epoch:0,effects:{buildings:{library:.08}}},{id:"communal_granary",name:"公共粮仓",desc:"人口上限 +10%。",cost:{science:390},epoch:0,effects:{maxPop:.1}},{id:"river_fishing",name:"河湾捕鱼",desc:"每人每日额外获得 0.05 粮食，财政收入 +1%。",cost:{science:450},epoch:0,effects:{perPopPassive:{food:.05},incomePercent:.01}},{id:"wheel",name:"车轮",desc:"采集建筑整体效率 +20%。",cost:{science:480},epoch:0,effects:{categories:{gather:.1}}},{id:"sailing",name:"航海术",desc:"解锁船坞建设，开启海上贸易与军事行动。财政收入 +3%，每人每日获得 0.02 粮食。",cost:{science:1050},epoch:1,effects:{incomePercent:.03,perPopPassive:{food:.02}}},{id:"tools",name:"铜制工具",desc:"允许建造锯木厂，工业效率 +5%。",cost:{science:750},epoch:1,effects:{categories:{industry:.03}}},{id:"copper_mining",name:"铜脉勘探",desc:"解锁铜矿开采。",cost:{science:840},epoch:1,effects:{}},{id:"bronze_working",name:"青铜冶炼",desc:"青铜铸坊产出 +30%，铁矿井同步获得 +15%。",cost:{science:960},epoch:1,effects:{buildings:{bronze_foundry:.15,mine:.08}}},{id:"horse_collar",name:"牛项圈",desc:"农田与庄园增产 10%。",cost:{science:780},epoch:1,effects:{buildings:{farm:.05,large_estate:.05}}},{id:"caravan_trade",name:"驼队贸易",desc:"市场银币收入 +35%。",cost:{science:900},epoch:1,effects:{buildings:{market:.18}}},{id:"granary_architecture",name:"粮仓结构",desc:"粮仓产出 +25%，并额外提供 +5% 人口上限。",cost:{science:960},epoch:1,effects:{buildings:{granary:.12},maxPop:.05}},{id:"primitive_weaving",name:"原始纺织",desc:"使用简易织机将羊毛加工为布料。织布坊效率 +10%。",cost:{science:820},epoch:1,effects:{buildings:{loom_house:.05}}},{id:"early_administration",name:"早期行政",desc:"解锁官署，建立初步的税收与民政管理体系。启用官员系统，官员容量 +2。",cost:{science:880},epoch:1,effects:{categories:{civic:.05}}},{id:"papyrus_cultivation",name:"改进造纸术",desc:"造纸工坊效率 +20%。",cost:{science:1575},epoch:2,effects:{buildings:{reed_works:.12}}},{id:"culinary_arts",name:"烹饪艺术",desc:"解锁烹饪坊，将粮食加工为珍馐，满足上层阶级的饮食需求。",cost:{science:1680},epoch:2,effects:{}},{id:"brewing",name:"酿造工艺",desc:"解锁酿造坊，将粮食发酵为美酒，供贸易与享用。",cost:{science:1610},epoch:2,effects:{}},{id:"carpentry",name:"精细木工",desc:"解锁家具工坊，将木材与石料加工为精美家具，提升上层阶级的生活品质。",cost:{science:1750},epoch:2,effects:{}},{id:"library_catalogs",name:"图书编目",desc:"图书馆科研 +25%。",cost:{science:1645},epoch:2,effects:{buildings:{library:.15}}},{id:"amphitheater_design",name:"剧场设计",desc:"解锁剧场建筑。",cost:{science:1470},epoch:1,effects:{}},{id:"urban_planning",name:"城市规划",desc:"木屋效率 +20%，人口上限 +5%。",cost:{science:1820},epoch:2,effects:{buildings:{house:.12},maxPop:.05}},{id:"republican_code",name:"共和法典",desc:"完善的法律体系提升社会运转效率。民生建筑效率 +15%，人口上限 +5%。",cost:{science:1960},epoch:2,effects:{categories:{civic:.09},maxPop:.05}},{id:"road_system",name:"道路网络",desc:"采集作业效率 +10%。",cost:{science:2100},epoch:2,effects:{categories:{gather:.06}}},{id:"advanced_weaving",name:"高级纺织",desc:"改进织布工具和织机设计，提升纺织效率。织布坊效率 +20%。",cost:{science:1950},epoch:2,effects:{buildings:{loom_house:.12}}},{id:"feudalism",name:"封建制度",desc:"庄园耕作效率 +15%。",cost:{science:3500},epoch:3,effects:{buildings:{large_estate:.09}}},{id:"basic_weaving",name:"织布机",desc:"新型的纺织工具。织布坊效率 +25%。",cost:{science:3150},epoch:3,effects:{buildings:{loom_house:.15}}},{id:"theology",name:"神学",desc:"教堂文化产出 +30%。",cost:{science:3850},epoch:3,effects:{buildings:{church:.18}}},{id:"bureaucracy",name:"官僚制度",desc:"解锁市政厅，建立高效的行政管理体系。采集、工业、市政建筑效率 +5%，每人每日获得 0.002 文化。官员容量 +3。",cost:{science:4200},epoch:3,effects:{categories:{gather:.03,industry:.03,civic:.03},perPopPassive:{culture:.002}}},{id:"civil_service",name:"文官制度",desc:"建立系统化的文官选拔与考核体系，提升行政效率。税收收入 +5%，官员容量 +3。",cost:{science:8750},epoch:4,effects:{incomePercent:.05}},{id:"administrative_reform",name:"行政改革",desc:"改革行政体系，提升官僚机构运转效率。民生建筑效率 +10%，官员容量 +4。",cost:{science:18900},epoch:5,effects:{categories:{civic:.07}}},{id:"centralization",name:"中央集权",desc:"加强中央政府权威，统一政令。税收收入 +8%，稳定度 +5%，官员容量 +2。",cost:{science:27900},epoch:6,effects:{incomePercent:.08}},{id:"three_field_system",name:"三圃制",desc:"农田与庄园额外 +15% 产量。",cost:{science:3850},epoch:3,effects:{buildings:{farm:.09,large_estate:.09}}},{id:"stone_keep_engineering",name:"石垒堡舍",desc:"居住建筑人口上限加成 10%。",cost:{science:4025},epoch:3,effects:{buildings:{hut:.06,house:.06}}},{id:"manor_architecture",name:"庄园建筑学",desc:"解锁石砌宅邸，贵族风格的坚固住宅，提供更多人口容量。宅邸效率 +15%，人口上限 +5%。",cost:{science:4550},epoch:3,effects:{buildings:{manor_house:.15},maxPop:.05}},{id:"monastic_brewing",name:"修道院酿造",desc:"解锁修道院酒窖，修士传承的高级酿酒工艺。酒窖效率 +15%，教堂文化 +10%。",cost:{science:4200},epoch:3,effects:{buildings:{monastery_cellar:.15,church:.1}}},{id:"wool_trade",name:"羊毛贸易",desc:"解锁纺织工场，封建时代最重要的纺织产业。纺织工场效率 +15%，织布坊效率 +10%。",cost:{science:3850},epoch:3,effects:{buildings:{wool_workshop:.15,loom_house:.1}}},{id:"masonry_guild",name:"石匠行会",desc:"解锁采石工场，行会组织的专业采石作业。采石工场效率 +15%，采石场效率 +10%。",cost:{science:4025},epoch:3,effects:{buildings:{stone_workshop:.15,quarry:.1}}},{id:"forestry_management",name:"林业管理",desc:"解锁硬木林场，有计划的森林采伐与维护。硬木林场效率 +15%，伐木场效率 +10%。",cost:{science:3675},epoch:3,effects:{buildings:{hardwood_camp:.15,lumber_camp:.1}}},{id:"ritual_priesthood",name:"仪式司祭",desc:"礼拜设施文化产出提升 15%。",cost:{science:1190},epoch:3,effects:{buildings:{church:.09}}},{id:"ironworking",name:"锻铁术",desc:"解锁铁器铺，并且铁矿井效率 +30%。",cost:{science:1500},epoch:2,effects:{buildings:{mine:.18}}},{id:"cartography",name:"海图绘制",desc:"船坞香料获取 +25%。",cost:{science:6300},epoch:4,effects:{buildings:{dockyard:.18}}},{id:"charter_companies",name:"特许公司",desc:"贸易港银币产出 +30%，财政收入 +5%。",cost:{science:6650},epoch:4,effects:{buildings:{trade_port:.21},incomePercent:.05}},{id:"navigator_schooling",name:"领航学",desc:"航海学院科研提升 30%。",cost:{science:7e3},epoch:4,effects:{buildings:{navigator_school:.21}}},{id:"naval_artillery",name:"舰炮试验",desc:"船坞额外获得 15% 产量。",cost:{science:7350},epoch:4,effects:{buildings:{dockyard:.1}}},{id:"colonial_ledgers",name:"殖民档案",desc:"系统化的殖民地档案管理，提升海外贸易效率。船坞和贸易港效率 +20%，财政收入 +5%。",cost:{science:7700},epoch:4,effects:{buildings:{dockyard:.14,trade_port:.14},incomePercent:.05}},{id:"spice_monopolies",name:"香料垄断",desc:"贸易港再获 15% 产量。",cost:{science:8050},epoch:4,effects:{buildings:{trade_port:.1}}},{id:"colonial_architecture",name:"殖民建筑",desc:"解锁联排住宅，港口城市流行的高效多层建筑。联排住宅效率 +15%，人口上限 +5%。",cost:{science:8400},epoch:4,effects:{buildings:{townhouse:.15},maxPop:.05}},{id:"new_world_dyes",name:"新世界染料",desc:"解锁印染工坊，使用胭脂虫红等新世界珍贵染料。印染工坊效率 +15%，染坊效率 +10%。",cost:{science:7875},epoch:4,effects:{buildings:{dye_workshop:.15,dye_works:.1}}},{id:"coffee_agronomy",name:"咖啡栽培学",desc:"解锁咖啡种植园。",cost:{science:14400},epoch:5,effects:{}},{id:"coffeehouse_philosophy",name:"咖啡馆哲学",desc:"解锁咖啡馆，每人每日获得 0.002 文化。",cost:{science:15300},epoch:5,effects:{perPopPassive:{culture:.002}}},{id:"printing_press",name:"印刷机",desc:"解锁印刷所。",cost:{science:16200},epoch:5,effects:{}},{id:"public_schooling",name:"公共教育",desc:"图书馆 +25% 科研，每人每日获得 0.001 文化。",cost:{science:17100},epoch:5,effects:{buildings:{library:.18},perPopPassive:{culture:.001}}},{id:"social_contract",name:"社会契约",desc:"启蒙思想推动社会进步。民生建筑效率 +20%，人口上限 +5%，每人每日获得 0.003 文化。",cost:{science:18e3},epoch:5,effects:{categories:{civic:.14},maxPop:.05,perPopPassive:{culture:.003}}},{id:"salon_debates",name:"沙龙辩论",desc:"剧场文化再增 15%。",cost:{science:18900},epoch:5,effects:{buildings:{amphitheater:.1}}},{id:"enlightened_urbanism",name:"启蒙城市主义",desc:"解锁阁楼公馆，兼具优雅与实用的新式住宅区。阁楼公馆效率 +15%，人口上限 +6%。",cost:{science:19800},epoch:5,effects:{buildings:{civic_apartment:.15},maxPop:.06}},{id:"coal_gasification",name:"煤气化",desc:"解锁煤矿开采。",cost:{science:23400},epoch:6,effects:{}},{id:"steel_alloys",name:"钢合金",desc:"解锁炼钢厂。",cost:{science:24300},epoch:6,effects:{}},{id:"industrialization",name:"工业化",desc:"解锁工厂，工业建筑效率 +10%。",cost:{science:27e3},epoch:6,effects:{categories:{industry:.07}}},{id:"steam_power",name:"蒸汽动力",desc:"工业建筑再获 +20% 产量。",cost:{science:28800},epoch:6,effects:{categories:{industry:.14}}},{id:"chemical_fertilizer",name:"化学施肥",desc:"农田与庄园 +20% 产出。",cost:{science:27e3},epoch:6,effects:{buildings:{farm:.14,large_estate:.14}}},{id:"rail_network",name:"铁路网",desc:"铁路枢纽效率 +30%，采集 +10%。",cost:{science:27900},epoch:6,effects:{buildings:{rail_depot:.21},categories:{gather:.07}}},{id:"precision_tools",name:"精密机具",desc:"工厂产出 +25%。",cost:{science:28800},epoch:6,effects:{buildings:{factory:.18}}},{id:"military_training",name:"军事训练",desc:"解锁训练场，提供更多军事容量。军事建筑效率 +15%。",cost:{science:2800},epoch:2,effects:{categories:{military:.1}}},{id:"fortification",name:"要塞工程",desc:"解锁要塞，大幅提升军事容量。军事建筑效率 +25%，人口上限 +5%。",cost:{science:8400},epoch:4,effects:{categories:{military:.18},maxPop:.05}},{id:"mechanized_weaving",name:"机械织布",desc:"解锁织布坊和成衣作坊，水力驱动的飞梭织机大幅提升布料产量。织布坊效率 +20%，成衣作坊效率 +15%。",cost:{science:13500},epoch:5,effects:{buildings:{loom_house:.14,tailor_workshop:.1}}},{id:"assembly_line",name:"流水线生产",desc:"解锁纺织厂和服装工厂，标准化分工使产量大幅提升。纺织厂效率 +25%，服装工厂效率 +20%。",cost:{science:26100},epoch:6,effects:{buildings:{textile_mill:.18,garment_factory:.14}}},{id:"hydraulic_sawing",name:"水力锯切",desc:"解锁锯木厂和伐木场升级，水轮驱动的圆锯效率远超手工。锯木厂效率 +25%，伐木场效率 +15%。",cost:{science:12600},epoch:5,effects:{buildings:{sawmill:.18,lumber_camp:.1}}},{id:"mass_production",name:"大规模生产",desc:"解锁木材加工厂和家具工坊，标准化零件实现批量生产。木材加工厂效率 +20%，家具工坊效率 +25%。",cost:{science:25200},epoch:6,effects:{buildings:{lumber_mill:.14,furniture_workshop:.18}}},{id:"advanced_metallurgy",name:"先进冶金",desc:"解锁竖井矿场，改良熔炉与合金配方提升工具质量。铁器铺效率 +20%，青铜铸坊效率 +15%。",cost:{science:7700},epoch:4,effects:{buildings:{iron_tool_workshop:.14,bronze_foundry:.1}}},{id:"bessemer_process",name:"贝塞麦炼钢法",desc:"解锁炼钢厂和冶金工坊，吹入空气快速去碳，钢铁产量剧增。炼钢厂效率 +30%，冶金工坊效率 +25%。",cost:{science:27900},epoch:6,effects:{buildings:{steel_foundry:.21,metallurgy_workshop:.18}}},{id:"industrial_ceramics",name:"工业陶瓷",desc:"解锁砖窯升级，环形窑与传送带实现连续烧制。砖窯效率 +25%。",cost:{science:11700},epoch:5,effects:{buildings:{brickworks:.18}}},{id:"standardized_construction",name:"标准化建筑",desc:"解锁建材厂，预制构件加速建设、降低成本。建材厂效率 +25%，人口上限 +5%。",cost:{science:24300},epoch:6,effects:{buildings:{building_materials_plant:.18},maxPop:.05}},{id:"food_preservation",name:"食品保鲜",desc:"解锁罐头厂，密封罐装技术延长食品保质期。",cost:{science:22500},epoch:6,effects:{buildings:{culinary_kitchen:.18}}},{id:"distillation",name:"蒸馏技术",desc:"解锁蒸馏酒厂，分离提纯出高度烈酒。",cost:{science:14400},epoch:5,effects:{buildings:{brewery:.21}}},{id:"wood_pulp_process",name:"木浆造纸",desc:"解锁造纸厂，木材纤维取代手工纸浆，产量倍增。",cost:{science:13050},epoch:5,effects:{buildings:{reed_works:.21}}},{id:"mass_media",name:"大众传媒",desc:"解锁印刷所和出版社，报纸杂志覆盖全民，舆论力量崛起。印刷所效率 +30%，出版社效率 +20%。",cost:{science:24750},epoch:6,effects:{buildings:{printing_house:.21,publishing_house:.14}}},{id:"deep_shaft_mining",name:"深井采矿",desc:"解锁工业矿场，蒸汽泵排水、铁轨运矿，开采深层矿脉。",cost:{science:23400},epoch:6,effects:{buildings:{mine:.18,coal_mine:.14}}},{id:"agricultural_machinery",name:"农业机械",desc:"解锁机械化农场，蒸汽拖拉机与收割机解放大量人力。",cost:{science:25200},epoch:6,effects:{buildings:{farm:.18,large_estate:.21}}},{id:"steam_logging",name:"蒸汽伐木",desc:"解锁伐木公司，蒸汽锯与窄轨铁路运输原木。",cost:{science:22500},epoch:6,effects:{buildings:{lumber_camp:.21}}},{id:"higher_education",name:"高等教育",desc:"解锁大学，系统化培养专业人才。",cost:{science:15750},epoch:5,effects:{buildings:{library:.14,navigator_school:.14}}},{id:"grand_arts",name:"高雅艺术",desc:"解锁歌剧院，戏剧与音乐的殿堂。",cost:{science:17100},epoch:5,effects:{buildings:{amphitheater:.18,church:.1}}},{id:"urban_architecture",name:"城市建筑学",desc:"解锁公寓楼，多层建筑容纳更多城市人口。人口上限 +6%。",cost:{science:26100},epoch:6,effects:{buildings:{house:.14},maxPop:.06}},{id:"financial_capitalism",name:"金融资本主义",desc:"解锁证券交易所，股票与债券调配社会资本。贸易港效率 +20%，铁路枢纽效率 +15%，财政收入 +8%。",cost:{science:29250},epoch:6,effects:{buildings:{trade_port:.14,rail_depot:.1},incomePercent:.08}}],or=(e,t)=>{const o={0:{light:["militia","slinger"],medium:["militia","slinger"],heavy:["militia","slinger"]},1:{light:["militia","slinger","spearman"],medium:["spearman","archer","chariot"],heavy:["spearman","archer","chariot"]},2:{light:["spearman","archer","light_cavalry"],medium:["hoplite","composite_archer","light_cavalry"],heavy:["hoplite","composite_archer","light_cavalry","battering_ram"]},3:{light:["heavy_infantry","crossbowman","knight"],medium:["heavy_infantry","crossbowman","knight","trebuchet"],heavy:["heavy_infantry","crossbowman","knight","trebuchet"]},4:{light:["pikeman","arquebus","cuirassier"],medium:["pikeman","arquebus","cuirassier","bombard"],heavy:["pikeman","arquebus","cuirassier","bombard"]},5:{light:["musketeer","dragoon"],medium:["musketeer","rifleman","dragoon","cannon"],heavy:["musketeer","rifleman","dragoon","cannon"]},6:{light:["line_infantry","lancer"],medium:["line_infantry","gatling","lancer","artillery"],heavy:["line_infantry","gatling","lancer","artillery"]}},i=o[Math.min(e,6)]||o[0];return i[t]||i.medium},ir={treaties:{peace_treaty:{minEra:1,name:"和平条约"},non_aggression:{minEra:2,name:"互不侵犯条约"},trade_agreement:{minEra:2,name:"贸易协定"},free_trade:{minEra:4,name:"自由贸易协定"},investment_pact:{minEra:4,name:"投资协议"},open_market:{minEra:2,name:"开放市场"},academic_exchange:{minEra:3,name:"学术交流"},defensive_pact:{minEra:3,name:"共同防御"}},sovereignty:{vassal:{minEra:2,name:"附庸国"}},organizations:{military_alliance:{minEra:3,name:"军事联盟"},economic_bloc:{minEra:5,name:"经济共同体"}},economy:{merchant_stationing:{minEra:3,name:"商人驻留"},overseas_building:{minEra:4,name:"海外建筑"},price_convergence:{minEra:6,name:"市场价格联动"},multi_round_negotiation:{minEra:2,name:"多轮谈判"}},migration:{economic_migration:{minEra:3,name:"经济移民"},war_refugees:{minEra:2,name:"战争难民"},political_exile:{minEra:4,name:"政治流亡"}}},ic={peace_treaty:"和平条约",non_aggression:"互不侵犯",trade_agreement:"贸易协定",free_trade:"自由贸易",investment_pact:"投资协议",open_market:"开放市场",academic_exchange:"学术交流",defensive_pact:"共同防御",military_alliance:"军事同盟",economic_bloc:"经济共同体"},nc=["peace_treaty","non_aggression"],Ma={military_alliance:{mutualDefense:!0,relationBonus:5,militaryBonus:.1},economic_bloc:{tariffDiscount:.3,relationBonus:5,tradeEfficiency:.2,priceConvergence:.03}},ac={standard:{id:"standard",name:"正常雇佣",description:"按当地生活成本支付正常工资",wageMultiplier:1,unrestPerDay:0,relationPerDay:0,independenceGrowthMod:1},exploitation:{id:"exploitation",name:"压榨剥削",description:"低于市场价的工资，劳动条件恶劣",wageMultiplier:.6,unrestPerDay:.05,relationPerDay:-.5,independenceGrowthMod:1.2},slavery:{id:"slavery",name:"强制劳动",description:"几乎无偿的强制劳动，极高独立风险",wageMultiplier:.3,unrestPerDay:.15,relationPerDay:-2,independenceGrowthMod:1.8,minEra:2}},nr={free:{id:"free",name:"自由贸易",description:"附庸可与任何国家贸易",playerPriceMod:0,tariffDiscount:0,tributeMod:.8,independenceGrowthMod:.8},preferential:{id:"preferential",name:"优惠准入",description:"玩家商人享有优先贸易权",playerPriceMod:-.1,tariffDiscount:.5,tributeMod:1,independenceGrowthMod:1},exclusive:{id:"exclusive",name:"排他贸易",description:"附庸只能与玩家贸易",playerPriceMod:-.25,tariffDiscount:1,tributeMod:1.2,independenceGrowthMod:1.3},dumping:{id:"dumping",name:"倾销市场",description:"强制附庸购买玩家过剩商品",playerPriceMod:.2,tariffDiscount:1,tributeMod:1,independenceGrowthMod:1.4,forcedExports:!0},looting:{id:"looting",name:"资源掠夺",description:"以极低价格获取附庸资源",playerPriceMod:-.4,tariffDiscount:1,tributeMod:1.5,independenceGrowthMod:1.6,forcedImports:!0,minEra:3}},rc=e=>{var t,o;return(o=(t=ac[e])==null?void 0:t.wageMultiplier)!=null?o:1},sc=e=>e>=6?{relationPenalty:50,cooldownDays:365}:e>=4?{relationPenalty:35,cooldownDays:180}:{relationPenalty:20,cooldownDays:90},hi=(e,t,o)=>{var r;const i=(r=ir[e])==null?void 0:r[t];return i?o>=i.minEra:!1},Rn={vassal:{name:"附庸国",minEra:2,minRelation:50,autonomy:80,tributeRate:.1,exploitationFactor:1,tariffDiscount:.5,description:"接受宗主国保护与指导的国家。具体权利义务由政策决定。",canFormAlliance:!0,canSignTreaties:!0,canTrade:!0,militaryObligation:"pay_to_call",economicPrivileges:{investmentCostDiscount:.1,profitTaxExemption:.1,tradePolicyLocked:!1}},protectorate:{name:"附庸国",minEra:2,autonomy:80,minRelation:50},tributary:{name:"附庸国",minEra:2,autonomy:60,minRelation:50},puppet:{name:"附庸国",minEra:2,autonomy:40,minRelation:50},colony:{name:"附庸国",minEra:2,autonomy:20,minRelation:50}},Sn={farm:[{name:"灌溉田",cost:{wood:50,stone:20,tools:5,silver:300},input:{tools:.04,wood:.06},output:{food:6.24},jobs:{peasant:3}},{name:"精耕田",cost:{plank:80,brick:40,tools:15,silver:800},input:{tools:.08,wood:.1},output:{food:10.8},jobs:{peasant:4}}],lumber_camp:[{name:"大伐木场",cost:{wood:80,stone:30,tools:10,silver:250},input:{tools:.05,food:.15},output:{wood:4.992},jobs:{lumberjack:3}},{name:"林场",cost:{plank:60,brick:30,tools:20,silver:600},input:{tools:.1},output:{wood:8.64,food:.15},jobs:{lumberjack:4}}],quarry:[{name:"深坑采石场",cost:{wood:80,stone:50,tools:15,silver:300},input:{tools:.06,wood:.15,food:.15},output:{stone:3.9},jobs:{miner:3}},{name:"大采石场",cost:{plank:80,stone:100,tools:30,silver:700},input:{tools:.12,wood:.25,food:.25},output:{stone:6.75,copper:.02},jobs:{miner:4}}],loom_house:[{name:"织布坊",cost:{wood:80,stone:40,tools:10,silver:250},input:{tools:.02},output:{cloth:2.5},jobs:{worker:3}},{name:"大织布坊",cost:{plank:60,brick:40,tools:20,silver:600},input:{tools:.04,dye:.03},output:{cloth:4.32,culture:.05},jobs:{worker:4}}],brickworks:[{name:"改良砖窑",cost:{stone:80,wood:40,tools:15,silver:300},input:{stone:1,wood:.35,tools:.02},output:{brick:3.12},jobs:{worker:3}},{name:"大砖窑",cost:{stone:120,brick:80,tools:30,silver:700},input:{stone:1.5,wood:.5,tools:.04},output:{brick:5.4,tools:.02},jobs:{worker:4}}],stone_tool_workshop:[{name:"工匠铺",cost:{stone:50,wood:50,silver:200},input:{wood:1.65,stone:1.35},output:{tools:.975},jobs:{artisan:3}},{name:"大工匠铺",cost:{brick:40,plank:40,silver:500},input:{wood:2.25,stone:1.8},output:{tools:1.35},jobs:{artisan:3}}],trading_post:[{name:"商铺",cost:{wood:100,stone:40,silver:400},input:{tools:.01},output:{food:5.2,silver:2.08},jobs:{merchant:2}},{name:"商会",cost:{plank:80,brick:60,silver:900},input:{tools:.02,papyrus:.01},output:{food:9,silver:3.6,spice:.02},jobs:{merchant:3}}],library:[{name:"学堂",cost:{stone:150,plank:40,papyrus:30,brick:40,silver:600,science:80},input:{papyrus:.08},output:{science:1.3867},jobs:{scribe:4}},{name:"书院",cost:{brick:120,plank:60,papyrus:80,silver:1400,science:200},input:{papyrus:.15,science:.15},output:{science:2.4,culture:.12},jobs:{scribe:5}}],copper_mine:[{name:"深铜矿",cost:{wood:120,tools:20,silver:350},input:{tools:.05,wood:.2,food:.2},output:{copper:.8667},jobs:{miner:4}},{name:"大铜矿",cost:{plank:80,tools:40,silver:800},input:{tools:.1,wood:.35,food:.35},output:{copper:1.5,stone:.15},jobs:{miner:5}}],dye_works:[{name:"大染坊",cost:{wood:60,stone:25,tools:10,silver:250},input:{food:.6,tools:.02},output:{dye:1.17},jobs:{worker:3}},{name:"染色工坊",cost:{plank:50,brick:30,tools:20,silver:600},input:{food:.9,tools:.04,cloth:.05},output:{dye:2.025,culture:.05},jobs:{worker:4}}],sawmill:[{name:"水力锯木坊",cost:{wood:120,stone:40,tools:15,silver:350},input:{wood:1.4,tools:.03},output:{plank:4.511},jobs:{worker:4}},{name:"大锯木坊",cost:{plank:80,brick:50,tools:30,silver:800},input:{wood:2,tools:.06,cloth:.05},output:{plank:7.8075,furniture:.05},jobs:{worker:5}}],bronze_foundry:[{name:"改良铸坊",cost:{stone:60,copper:25,silver:300},input:{copper:.75,wood:.45,tools:.015},output:{tools:1.95},jobs:{worker:3,artisan:1}},{name:"大铸坊",cost:{brick:50,copper:40,silver:700},input:{copper:1.05,wood:.675,tools:.03},output:{tools:2.7},jobs:{worker:3,artisan:1}}],amphitheater:[{name:"大剧场",cost:{stone:120,brick:40,silver:400},input:{fine_clothes:.06},output:{culture:6.5,silver:.8},jobs:{cleric:2}},{name:"宏伟剧场",cost:{brick:80,furniture:20,silver:900},input:{fine_clothes:.08,ale:.03},output:{culture:9,silver:1.5},jobs:{cleric:2}}],reed_works:[{name:"改良造纸坊",cost:{wood:60,tools:10,silver:220},input:{tools:.01},output:{papyrus:1.17},jobs:{worker:3}},{name:"大造纸坊",cost:{plank:50,tools:20,silver:500},input:{tools:.02},output:{papyrus:2.025,science:.05},jobs:{worker:4}}],culinary_kitchen:[{name:"精致厨房",cost:{brick:40,tools:15,cloth:8,silver:350},input:{tools:.08,food:1.2},output:{delicacies:2.6},jobs:{artisan:3,peasant:1}},{name:"御膳房",cost:{brick:60,furniture:15,delicacies:20,silver:800},input:{tools:.12,food:1.8,spice:.06},output:{delicacies:4.5,culture:.08},jobs:{artisan:3,peasant:2}}],brewery:[{name:"大酒坊",cost:{brick:30,tools:12,cloth:6,silver:280},input:{food:1,wood:.15,tools:.01},output:{ale:2.34},jobs:{worker:3}},{name:"酿酒工坊",cost:{brick:50,tools:25,dye:10,ale:15,silver:650},input:{food:1.5,wood:.25,tools:.02,spice:.03},output:{ale:4.05,culture:.05},jobs:{worker:4}}],furniture_workshop:[{name:"精工家具坊",cost:{plank:80,tools:20,silver:400},input:{tools:.08,plank:1,cloth:.25},output:{furniture:2.08},jobs:{artisan:4}},{name:"大家具坊",cost:{plank:120,furniture:15,silver:900},input:{tools:.12,plank:1.5,cloth:.35},output:{furniture:3.6},jobs:{artisan:5}}],tailor_workshop:[{name:"高级成衣坊",cost:{plank:50,tools:15,silver:350},input:{tools:.035,cloth:.85,dye:.17},output:{fine_clothes:1.04,culture:.6},jobs:{artisan:3}},{name:"御用成衣坊",cost:{brick:40,fine_clothes:10,silver:800},input:{tools:.05,cloth:1.3,dye:.25},output:{fine_clothes:1.8,culture:.8},jobs:{artisan:4}}],mine:[{name:"深井铁矿",cost:{plank:80,tools:25,silver:400},input:{tools:.08,wood:.2,food:.3},output:{iron:1.65},jobs:{miner:7,landowner:1}},{name:"大铁矿",cost:{brick:60,tools:40,silver:900},input:{tools:.15,wood:.35,food:.45},output:{iron:2.86,coal:.05},jobs:{miner:9,landowner:1}}],iron_tool_workshop:[{name:"精铁工坊",cost:{brick:60,iron:30,silver:400},input:{wood:.6,iron:.975,tools:.015},output:{tools:2.925},jobs:{worker:3,artisan:1}},{name:"大铁匠铺",cost:{brick:100,iron:50,silver:900},input:{wood:.9,iron:1.5,tools:.03},output:{tools:4.05},jobs:{worker:3,artisan:1}}],large_estate:[{name:"繁荣庄园",cost:{plank:60,tools:20,silver:400},input:{tools:.1,wood:.15},output:{food:23.4},jobs:{serf:8,landowner:1}},{name:"领主庄园",cost:{brick:50,furniture:15,silver:900},input:{tools:.18,wood:.25,cloth:.05},output:{food:40.5,cloth:.1,ale:.03},jobs:{serf:9,landowner:1}}],church:[{name:"大教堂",cost:{brick:80,furniture:25,silver:500},input:{furniture:.05,fine_clothes:.04},output:{culture:3.8,silver:1.2},jobs:{cleric:3}},{name:"主教座堂",cost:{brick:150,furniture:40,silver:1200},input:{furniture:.06,fine_clothes:.05,papyrus:.02},output:{culture:5.5,silver:2,science:.15},jobs:{cleric:4}}],monastery_cellar:[{name:"修道院大酒窖",cost:{stone:80,tools:20,silver:400},input:{food:2,wood:.35},output:{ale:2.6,culture:1.4},jobs:{cleric:1,worker:3}},{name:"酿酒修道院",cost:{brick:100,furniture:20,silver:900},input:{food:2.7,wood:.5},output:{ale:4.5,culture:2,science:.08},jobs:{cleric:2,worker:2}}],wool_workshop:[{name:"大纺织工场",cost:{plank:80,tools:20,silver:380},input:{food:.7,tools:.04},output:{cloth:4.16,fine_clothes:.26},jobs:{serf:4,worker:3}},{name:"领主纺织工场",cost:{brick:60,tools:35,silver:850},input:{food:1,tools:.06,dye:.05},output:{cloth:7.2,fine_clothes:.45,culture:.05},jobs:{serf:5,worker:3}}],stone_workshop:[{name:"大采石工场",cost:{plank:60,iron:25,silver:350},input:{tools:.08,food:.15},output:{stone:4.55},jobs:{miner:4,worker:1}},{name:"皇家采石场",cost:{brick:80,iron:40,silver:800},input:{tools:.12,food:.25},output:{stone:7.875,brick:.15},jobs:{miner:5,worker:1}}],hardwood_camp:[{name:"特用林场",cost:{plank:80,tools:30,silver:450},input:{tools:.1,food:.2},output:{wood:6.24},jobs:{lumberjack:5,worker:1}},{name:"皇家御林",cost:{brick:80,tools:50,silver:900},input:{tools:.15,food:.35},output:{wood:10.8,food:.2},jobs:{lumberjack:6,worker:1}}],dockyard:[{name:"大船坞",cost:{plank:120,tools:30,silver:500},input:{wood:.4,tools:.02},output:{spice:.9},jobs:{navigator:2,worker:2,merchant:1}},{name:"皇家船厂",cost:{plank:200,iron:40,silver:1100},input:{wood:.6,tools:.03,cloth:.06},output:{spice:1.55,silver:.25,science:.05},jobs:{navigator:3,worker:2,merchant:1}}],navigator_school:[{name:"航海学府",cost:{plank:80,papyrus:40,silver:400},input:{papyrus:.05},output:{science:.78,culture:1.2},jobs:{navigator:3,scribe:1,official:1}},{name:"皇家航海学院",cost:{brick:60,papyrus:80,silver:900},input:{papyrus:.08,coffee:.03},output:{science:1.35,culture:1.8},jobs:{navigator:4,scribe:1,official:1}}],trade_port:[{name:"繁荣港口",cost:{plank:150,spice:30,silver:600},input:{spice:.25},output:{food:2.6,silver:.15},jobs:{merchant:4}},{name:"贸易枢纽",cost:{brick:120,spice:60,silver:1300},input:{spice:.35,cloth:.06},output:{food:4.5,silver:.4},jobs:{merchant:5}}],shaft_mine:[{name:"通风矿井",cost:{brick:120,tools:45,silver:650},input:{tools:.14,wood:.3,science:.065},output:{iron:1.872,copper:1.248},jobs:{miner:6,engineer:1}},{name:"蒸汽矿井",cost:{brick:200,steel:50,tools:80,silver:1200},input:{tools:.2,coal:.15,wood:.4,science:.11},output:{iron:3.24,copper:2.16,coal:.1},jobs:{miner:7,engineer:1}}],dye_workshop:[{name:"大印染工坊",cost:{brick:80,tools:25,silver:480},input:{food:.9,cloth:.5,spice:.06,science:.026},output:{dye:2.34,fine_clothes:.585},jobs:{artisan:3,worker:2}},{name:"皇家印染工坊",cost:{brick:140,tools:45,silver:1050},input:{food:1.2,cloth:.7,spice:.08,iron:.02,science:.045},output:{dye:4.05,fine_clothes:1.0125,culture:.08},jobs:{artisan:4,worker:2}}],coffee_plantation:[{name:"大种植园",cost:{wood:300,spice:40,silver:800},input:{tools:.03},output:{coffee:.52},jobs:{serf:6,merchant:1}},{name:"种植园庄园",cost:{plank:200,tools:60,silver:1800},input:{tools:.06},output:{coffee:.9,spice:.02,food:.5},jobs:{serf:8,merchant:1}}],coffee_house:[{name:"文人咖啡馆",cost:{plank:80,coffee:25,silver:400},input:{coffee:.2,delicacies:.08},output:{culture:4.8,science:1.733,silver:.6},jobs:{merchant:1,scribe:2}},{name:"沙龙",cost:{brick:60,furniture:25,silver:900},input:{coffee:.3,delicacies:.1},output:{culture:7,science:3,silver:1.2},jobs:{merchant:1,scribe:3}}],printing_house:[{name:"大印刷所",cost:{brick:120,papyrus:40,silver:500,science:100},input:{papyrus:.48,coffee:.09,science:.2},output:{science:3.12,culture:2.4},jobs:{artisan:5,scribe:3,capitalist:1}},{name:"出版社",cost:{brick:200,papyrus:80,silver:1100,science:250},input:{papyrus:.75,coffee:.15,science:.35},output:{science:5.4,culture:3.6},jobs:{artisan:5,scribe:3,capitalist:1}}],textile_mill:[{name:"大纺织厂",cost:{brick:120,tools:40,silver:600},input:{food:2.6,dye:.975,tools:.04},output:{cloth:16.25,fine_clothes:1.95},jobs:{worker:15,artisan:4,capitalist:1}},{name:"纺织工场",cost:{brick:200,tools:60,silver:1300},input:{food:4.5,dye:1.6875,tools:.0692,coffee:.0533},output:{cloth:28.125,fine_clothes:3.375},jobs:{worker:16,artisan:4,capitalist:1}}],lumber_mill:[{name:"大木材厂",cost:{brick:100,tools:35,silver:500},input:{wood:8.3572,tools:.024},output:{plank:22.2858},jobs:{worker:10,artisan:1,capitalist:1}},{name:"木业公司",cost:{brick:180,tools:50,silver:1100},input:{wood:14.4644,tools:.048},output:{plank:38.5715,furniture:.144},jobs:{worker:11,artisan:1,capitalist:1}}],building_materials_plant:[{name:"大建材厂",cost:{brick:120,tools:35,silver:550},input:{stone:5.85,wood:1.755,coal:.585},output:{brick:16.0875},jobs:{worker:14,engineer:1,capitalist:1}},{name:"建材公司",cost:{brick:200,tools:50,silver:1200},input:{stone:10.125,wood:3.0375,coal:1.0125},output:{brick:27.84375},jobs:{worker:15,engineer:1,capitalist:1}}],distillery:[{name:"大蒸馏厂",cost:{brick:150,copper:50,silver:600},input:{food:5.85,coal:.585},output:{ale:10.2375,silver:2.34},jobs:{worker:12,artisan:2,capitalist:1}},{name:"酒业公司",cost:{brick:250,copper:80,silver:1300},input:{food:10.125,coal:1.0125},output:{ale:17.71875,silver:4.05,culture:.12},jobs:{worker:13,artisan:2,capitalist:1}}],paper_mill:[{name:"大造纸厂",cost:{brick:120,tools:35,silver:500},input:{wood:3.9,coal:.39},output:{papyrus:6.5},jobs:{worker:10,engineer:1,capitalist:1}},{name:"造纸公司",cost:{brick:200,tools:50,silver:1100},input:{wood:6.75,coal:.675},output:{papyrus:11.25,tools:.06},jobs:{worker:11,engineer:1,capitalist:1}}],university:[{name:"著名学府",cost:{brick:250,papyrus:60,silver:750,science:150},input:{papyrus:.3125,coffee:.1875,delicacies:.125,science:.4},output:{science:4.875,culture:1.3},jobs:{scribe:5,engineer:2,official:2}},{name:"皇家学院",cost:{brick:400,papyrus:120,silver:1700,science:400},input:{papyrus:.4375,coffee:.25,delicacies:.15,science:.7},output:{science:8.4375,culture:2.25},jobs:{scribe:6,engineer:2,official:2}}],opera_house:[{name:"大歌剧院",cost:{brick:250,furniture:50,silver:700},input:{fine_clothes:.25,delicacies:.15},output:{culture:5.6875,silver:1.625},jobs:{cleric:5,artisan:2,merchant:1}},{name:"皇家歌剧院",cost:{brick:400,furniture:80,silver:1500},input:{fine_clothes:.375,delicacies:.225,coffee:.1},output:{culture:9.8438,silver:2.8125,science:.1875},jobs:{cleric:6,artisan:2,merchant:1}}],coal_mine:[{name:"深煤矿",cost:{plank:150,tools:40,silver:500},input:{tools:.35,wood:.5,food:.8},output:{coal:5},jobs:{miner:13,capitalist:1}},{name:"大煤矿",cost:{brick:100,tools:60,silver:1100},input:{tools:.55,wood:.8,food:1.2},output:{coal:8,iron:.2},jobs:{miner:9,capitalist:1}}],steel_foundry:[{name:"大炼钢厂",cost:{brick:200,iron:120,silver:750,science:150},input:{iron:1.2,coal:1.2,science:.3},output:{steel:1.2},jobs:{engineer:5,worker:7,capitalist:1}},{name:"钢铁联合厂",cost:{steel:100,iron:200,silver:1700,science:350},input:{iron:2.4,coal:2.4,science:.6},output:{steel:2.4,tools:.2},jobs:{engineer:5,worker:8,capitalist:1}}],factory:[{name:"大工厂",cost:{brick:300,steel:120,silver:850,science:200},input:{steel:3,coal:3,science:.75},output:{tools:22},jobs:{worker:20,engineer:4,capitalist:1}},{name:"制造中心",cost:{steel:200,tools:80,silver:1900,science:450},input:{steel:4.2,coal:4.2,science:1},output:{tools:32,steel:.1,science:.2},jobs:{worker:21,engineer:4,capitalist:1}}],industrial_mine:[{name:"大工业矿场",cost:{steel:150,tools:60,silver:850},input:{tools:.33995,coal:.68,wood:.4,food:.8},output:{iron:3.85,copper:1.245},jobs:{miner:17,engineer:2,capitalist:1}},{name:"矿业公司",cost:{steel:250,tools:100,silver:1900},input:{tools:.588375,coal:1.125,wood:.6,food:1},output:{iron:6.663075,copper:2.153925},jobs:{miner:18,engineer:2,capitalist:1}}],mechanized_farm:[{name:"大机械农场",cost:{steel:100,tools:50,silver:750},input:{tools:.2275,coal:.455,iron:.06},output:{food:50.05},jobs:{peasant:8,worker:8,engineer:1,capitalist:1}},{name:"工业农场",cost:{steel:170,tools:80,silver:1700},input:{tools:.39375,coal:.7875,iron:.1,dye:.03},output:{food:86.625,cloth:.2},jobs:{peasant:9,worker:8,engineer:1,capitalist:1}}],logging_company:[{name:"大伐木公司",cost:{steel:60,tools:40,silver:650},input:{tools:.1563,coal:.325,food:.4},output:{wood:26},jobs:{lumberjack:11,worker:7,engineer:1,capitalist:1}},{name:"林业公司",cost:{steel:120,tools:60,silver:1500},input:{tools:.270825,coal:.5625,food:.55},output:{wood:45},jobs:{lumberjack:12,worker:7,engineer:1,capitalist:1}}],prefab_factory:[{name:"大预制厂",cost:{steel:150,tools:60,silver:850},input:{brick:3.9,steel:.52,stone:2.6,coal:1.04},output:{brick:28.6},jobs:{worker:20,engineer:4,capitalist:1}},{name:"建筑材料公司",cost:{steel:250,tools:100,silver:1900},input:{brick:6.75,steel:.9,stone:4.5,coal:1.8},output:{brick:49.5},jobs:{worker:21,engineer:4,capitalist:1}}],cannery:[{name:"大罐头厂",cost:{steel:60,tools:40,silver:650},input:{food:7.3125,iron:.8775,coal:.73125},output:{delicacies:10.2375},jobs:{worker:17,artisan:4,engineer:1,capitalist:1}},{name:"食品公司",cost:{steel:120,tools:60,silver:1500},input:{food:12.65625,iron:1.51875,coal:1.265625},output:{delicacies:17.71875,ale:.3},jobs:{worker:18,artisan:5,engineer:1,capitalist:1}}],garment_factory:[{name:"大服装厂",cost:{steel:100,tools:60,silver:850},input:{cloth:4.875,dye:.975,coal:.585},output:{fine_clothes:5.46,culture:.585},jobs:{worker:18,artisan:4,engineer:1,capitalist:1}},{name:"服装公司",cost:{steel:170,tools:100,silver:1900},input:{cloth:8.4375,dye:1.6875,coal:1.0125},output:{fine_clothes:9.45,culture:1.0125,cloth:.5},jobs:{worker:20,artisan:4,engineer:1,capitalist:1}}],furniture_factory:[{name:"大家具厂",cost:{steel:80,tools:50,silver:750},input:{plank:7.3125,cloth:2.34,coal:.73125},output:{furniture:10.2375,culture:.585},jobs:{worker:17,artisan:4,engineer:1,capitalist:1}},{name:"家具公司",cost:{steel:150,tools:80,silver:1700},input:{plank:12.65625,cloth:4.05,coal:1.265625},output:{furniture:17.71875,culture:1.0125,plank:.4},jobs:{worker:18,artisan:4,engineer:1,capitalist:1}}],market:[{name:"大市场",cost:{brick:300,papyrus:60,cloth:15,silver:1e3},input:{papyrus:.12,coffee:.075},output:{food:3.9,silver:.45},jobs:{merchant:4,scribe:1}},{name:"交易所",cost:{steel:200,papyrus:120,delicacies:30,silver:2200},input:{papyrus:.18,coffee:.12},output:{food:6.75,silver:.75,culture:.225},jobs:{merchant:5,scribe:1}}],rail_depot:[{name:"大铁路站",cost:{steel:120,coal:80,silver:850},input:{coal:.375,ale:.1,delicacies:.05,science:.195},output:{silver:3.51,maxPop:15},jobs:{engineer:4,merchant:3,capitalist:1}},{name:"铁路枢纽",cost:{steel:220,coal:150,silver:1900},input:{coal:.5625,ale:.15,delicacies:.075,science:.3375},output:{silver:6.075,maxPop:16,food:.625,culture:.125},jobs:{engineer:5,merchant:4,capitalist:1}}],metallurgy_workshop:[{name:"精密冶金坊",cost:{brick:120,iron:60,silver:600},input:{iron:1.2,copper:.25,wood:.6},output:{tools:3.9},jobs:{worker:4,artisan:2,engineer:1}},{name:"大冶金坊",cost:{brick:200,iron:100,silver:1300},input:{iron:1.8,copper:.4,wood:.9,coal:.08},output:{tools:6.75},jobs:{worker:5,artisan:2,engineer:1}}]},Ot=(e,t=0)=>{if(!t||t===0)return{name:e.name,input:e.input||{},output:e.output||{},jobs:e.jobs||{},owner:e.owner||null};const o=Sn[e.id];if(!o||!o[t-1])return{name:e.name,input:e.input||{},output:e.output||{},jobs:e.jobs||{},owner:e.owner||null};const i=o[t-1];return{name:i.name||e.name,input:i.input||e.input||{},output:i.output||e.output||{},jobs:i.jobs||e.jobs||{},owner:i.owner||e.owner||null}},In=e=>{const t=Sn[e];return t?t.length:0},kn=(e,t,o=0,i=1.15)=>{const r=Sn[e];if(!r||!r[t-1])return null;const a=r[t-1].cost||{};if(o<=0)return a;const l=1+Math.max(0,i-1)*Math.pow(o,.9),f={};for(const[p,d]of Object.entries(a))f[p]=Math.ceil(d*l);return f},ar={demanding:{high:120,standard:80,low:50},offering:{high:60,standard:40,low:25}},va=2e6;function rr(e,t=null){const o=t?Math.min(e||0,t||0):e||0,i=Math.floor(o*.02);return Math.max(30,Math.min(1e4,i))}function sr(e,t,o,i,r="demanding",a=0){const s=Math.abs(e||0),u=t||0,l=o||0,f=i||0,p=a||0,d=ar[r]||ar.demanding,v=s*d.high,h=u*80,b=l*25,M=p*.3,g=Math.ceil(v+h+b+M),C=Math.ceil(s*d.standard+u*50+l*18+p*.2),x=Math.ceil(s*d.low+u*35+l*12+p*.1),m=Math.floor(f*.18),_=Math.floor(f*.12),A=Math.floor(f*.06),k=f*1,D=Math.max(5e4,k);let P=va;if(p>0&&r==="demanding"){const R=1+s/100;P=p*R,P=Math.max(p*.5,P)}const T=Math.min(va,D,P);return{high:Math.max(600,m,Math.min(T,g)),standard:Math.max(400,_,Math.min(T,C)),low:Math.max(200,A,Math.min(T,x)),breakdown:{scoreComponent:v,lossComponent:h,durationComponent:b,expenseComponent:M,rawHigh:g,rawStandard:C,rawLow:x},caps:{hardCap:va,wealthCap:D,armyExpenseCap:P,effectiveCap:T}}}function cc(e,t,o,i){return sr(e,t,o,i,"offering").standard}function lc(e,t,o=1e4){return sr(e,0,t,o,"offering").standard}const To={militia:{id:"militia",name:"民兵",desc:"由农民临时组成的武装力量，战斗力较弱但成本低廉。",epoch:0,icon:"Users",category:"infantry",attack:6,defense:4,speed:3,range:1,recruitCost:{food:125,wood:60},maintenanceCost:{food:1.75,silver:.6},trainingTime:2,populationCost:1,abilities:["快速征召"],counters:{cavalry:1.2,siege:1.3},weakAgainst:["archer"],obsoleteAfterEpochs:2},slinger:{id:"slinger",name:"投石兵",desc:"使用投石索的远程单位，对轻甲单位有效。",epoch:0,icon:"Circle",category:"archer",attack:6,defense:2,speed:3,range:3,recruitCost:{food:150,wood:75,stone:25},maintenanceCost:{food:2,silver:.75,stone:.5},trainingTime:3,populationCost:1,abilities:["远程攻击"],counters:{infantry:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},spearman:{id:"spearman",name:"长矛兵",desc:"装备青铜长矛的步兵，对骑兵有显著克制效果。",epoch:1,icon:"Sword",category:"infantry",attack:12,defense:9,speed:3,range:1,recruitCost:{food:275,wood:175,copper:60},maintenanceCost:{food:2.75,silver:1.75,copper:.25},trainingTime:4,populationCost:1,abilities:["反骑兵"],counters:{cavalry:1.8,siege:1.2},weakAgainst:["archer"],obsoleteAfterEpochs:2},archer:{id:"archer",name:"弓箭手",desc:"装备复合弓的远程单位，克制步兵。",epoch:1,icon:"Target",category:"archer",attack:14,defense:6,speed:4,range:4,recruitCost:{food:325,wood:225,silver:125},maintenanceCost:{food:3.25,silver:2.25,wood:1},trainingTime:5,populationCost:1,abilities:["远程攻击","高机动"],counters:{infantry:1.5,siege:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},chariot:{id:"chariot",name:"战车",desc:"青铜时代的机动战力，由马匹牵引的战车。",epoch:1,icon:"Truck",category:"cavalry",attack:15,defense:8,speed:6,range:1,recruitCost:{food:500,wood:300,copper:150,silver:200},maintenanceCost:{food:6,silver:3.5,wood:1.5},trainingTime:6,populationCost:1,abilities:["冲锋","机动"],counters:{archer:1.6},weakAgainst:["infantry"],obsoleteAfterEpochs:2},hoplite:{id:"hoplite",name:"重装步兵",desc:"装备圆盾和长矛的古典精锐步兵，方阵作战威力强大。",epoch:2,icon:"Shield",category:"infantry",attack:16,defense:14,speed:2,range:1,recruitCost:{food:500,copper:200,iron:100,silver:250},maintenanceCost:{food:3.75,silver:2.75,iron:.4},trainingTime:6,populationCost:1,abilities:["方阵","坚守"],counters:{cavalry:1.7,siege:1.3},weakAgainst:["archer"],obsoleteAfterEpochs:2},composite_archer:{id:"composite_archer",name:"复合弓手",desc:"使用复合弓的精锐射手，穿透力更强。",epoch:2,icon:"Target",category:"archer",attack:18,defense:7,speed:4,range:5,recruitCost:{food:425,wood:250,copper:125,silver:225},maintenanceCost:{food:3.5,silver:2.5,wood:1.25,copper:.25},trainingTime:6,populationCost:1,abilities:["远程攻击","穿甲"],counters:{infantry:1.6,siege:1.3},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},light_cavalry:{id:"light_cavalry",name:"轻骑兵",desc:"快速机动的骑兵单位，克制弓箭手。",epoch:2,icon:"Navigation",category:"cavalry",attack:18,defense:8,speed:8,range:1,recruitCost:{food:600,silver:300,iron:125},maintenanceCost:{food:6,silver:4,iron:.3},trainingTime:7,populationCost:1,abilities:["快速移动","冲锋"],counters:{archer:1.8},weakAgainst:["infantry"],obsoleteAfterEpochs:2},battering_ram:{id:"battering_ram",name:"攻城槌",desc:"古典时代的攻城器械，对建筑极为有效。",epoch:2,icon:"Hammer",category:"siege",attack:30,defense:15,speed:1,range:1,recruitCost:{food:750,wood:1e3,iron:250,silver:400},maintenanceCost:{food:6,silver:4,wood:2.5,iron:.5},trainingTime:10,populationCost:2,abilities:["攻城"],counters:{},weakAgainst:["cavalry","archer","infantry"],obsoleteAfterEpochs:2},heavy_infantry:{id:"heavy_infantry",name:"重甲步兵",desc:"装备锁子甲的精锐步兵，防御力强。",epoch:3,icon:"ShieldAlert",category:"infantry",attack:20,defense:18,speed:2,range:1,recruitCost:{food:700,iron:300,silver:400},maintenanceCost:{food:4.5,silver:3.5,iron:.6,cloth:.2},trainingTime:8,populationCost:1,abilities:["重甲","坚守"],counters:{cavalry:1.6,siege:1.4},weakAgainst:["archer"],obsoleteAfterEpochs:2},crossbowman:{id:"crossbowman",name:"弩兵",desc:"装备十字弩的远程单位，穿透力强。",epoch:3,icon:"Crosshair",category:"archer",attack:22,defense:9,speed:3,range:5,recruitCost:{food:550,wood:350,iron:225,silver:275},maintenanceCost:{food:4,silver:3,wood:.75,iron:.5},trainingTime:7,populationCost:1,abilities:["远程攻击","穿甲"],counters:{infantry:1.7,siege:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},knight:{id:"knight",name:"骑士",desc:"装备板甲的精锐骑兵，封建时代的主力。",epoch:3,icon:"Crown",category:"cavalry",attack:28,defense:22,speed:6,range:1,recruitCost:{food:1250,iron:500,copper:150,silver:800},maintenanceCost:{food:9,silver:6.5,iron:.8,copper:.3},trainingTime:10,populationCost:1,abilities:["重甲","冲锋","贵族"],counters:{archer:1.9},weakAgainst:["infantry"],obsoleteAfterEpochs:2},trebuchet:{id:"trebuchet",name:"投石机",desc:"中世纪的重型攻城器械，可投掷巨石。",epoch:3,icon:"Mountain",category:"siege",attack:45,defense:8,speed:1,range:6,recruitCost:{food:1e3,wood:1e3,plank:400,iron:400,silver:750},maintenanceCost:{food:7.5,silver:6,plank:1.5,iron:.6,stone:1.2},trainingTime:12,populationCost:3,abilities:["攻城","范围伤害"],counters:{infantry:1.3},weakAgainst:["cavalry","archer"],obsoleteAfterEpochs:2},pikeman:{id:"pikeman",name:"长枪兵",desc:"装备长枪的步兵，方阵抵御骑兵冲锋。",epoch:4,icon:"Swords",category:"infantry",attack:22,defense:20,speed:2,range:2,recruitCost:{food:800,wood:300,iron:350,silver:450},maintenanceCost:{food:5,silver:4,iron:.5},trainingTime:8,populationCost:1,abilities:["反骑兵","方阵"],counters:{cavalry:2,siege:1.3},weakAgainst:["archer","gunpowder"],obsoleteAfterEpochs:2},arquebus:{id:"arquebus",name:"火绳枪手",desc:"早期火器部队，虽然装填慢但威力巨大，克制传统步兵和骑兵。",epoch:4,icon:"Flame",category:"gunpowder",attack:28,defense:8,speed:2,range:4,recruitCost:{food:700,iron:300,tools:200,copper:80,silver:500},maintenanceCost:{food:4.5,silver:4,iron:.35,tools:.9,copper:.15},trainingTime:9,populationCost:1,abilities:["火器","穿甲","装填缓慢"],counters:{infantry:1.5,cavalry:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},cuirassier:{id:"cuirassier",name:"胸甲骑兵",desc:"装备胸甲的重装骑兵，可抵抗早期火器。",epoch:4,icon:"Shield",category:"cavalry",attack:32,defense:24,speed:6,range:1,recruitCost:{food:1500,iron:600,silver:1e3},maintenanceCost:{food:10,silver:7.5,iron:1.25},trainingTime:11,populationCost:1,abilities:["重甲","冲锋","抗火器"],counters:{archer:1.9,gunpowder:1.5},weakAgainst:["infantry"],obsoleteAfterEpochs:2},bombard:{id:"bombard",name:"射石炮",desc:"早期火炮，可攻破城墙。",epoch:4,icon:"Bomb",category:"siege",attack:55,defense:10,speed:1,range:6,recruitCost:{food:1250,iron:600,copper:250,tools:350,silver:1e3},maintenanceCost:{food:9,silver:7.5,iron:1.2,copper:.4,tools:1.5},trainingTime:14,populationCost:3,abilities:["攻城","范围伤害","火器"],counters:{infantry:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},musketeer:{id:"musketeer",name:"刺刀火枪兵",desc:"装备滑膛枪和刺刀的步兵，可远程射击也可近战。",epoch:5,icon:"Zap",category:"infantry",attack:30,defense:14,speed:3,range:3,recruitCost:{food:900,iron:350,tools:250,silver:550},maintenanceCost:{food:5.5,silver:5,iron:.45,tools:1,cloth:.15},trainingTime:9,populationCost:1,abilities:["火器","刺刀冲锋","齐射"],counters:{cavalry:1.6,siege:1.4},weakAgainst:["gunpowder"],obsoleteAfterEpochs:2},rifleman:{id:"rifleman",name:"线膛枪手",desc:"装备线膛枪的精确射手，射程远、精度高。",epoch:5,icon:"Target",category:"gunpowder",attack:35,defense:10,speed:3,range:5,recruitCost:{food:1e3,iron:400,tools:300,silver:650},maintenanceCost:{food:6,silver:5.5,iron:.5,tools:1.3},trainingTime:10,populationCost:1,abilities:["火器","精确射击","穿甲"],counters:{infantry:1.7,cavalry:1.5,siege:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},dragoon:{id:"dragoon",name:"龙骑兵",desc:"骑马机动的火枪兵，可下马作战，机动性和火力兼备。",epoch:5,icon:"Navigation",category:"cavalry",attack:35,defense:18,speed:7,range:2,recruitCost:{food:1400,iron:450,tools:225,silver:900},maintenanceCost:{food:10,silver:7.5,iron:.75,tools:1},trainingTime:12,populationCost:1,abilities:["火器","快速移动","下马作战"],counters:{archer:1.8,gunpowder:1.6},weakAgainst:["infantry"],obsoleteAfterEpochs:2},cannon:{id:"cannon",name:"野战炮",desc:"启蒙时代的标准火炮，可用于攻城和野战。",epoch:5,icon:"Bomb",category:"siege",attack:60,defense:12,speed:2,range:7,recruitCost:{food:1500,iron:700,copper:300,tools:450,silver:1250},maintenanceCost:{food:10,silver:9,iron:1.4,copper:.5,tools:2},trainingTime:15,populationCost:3,abilities:["攻城","范围伤害","火器"],counters:{infantry:1.7,gunpowder:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},line_infantry:{id:"line_infantry",name:"线列步兵",desc:"工业化训练的步兵，装备后装步枪和刺刀。",epoch:6,icon:"Users",category:"infantry",attack:40,defense:20,speed:3,range:4,recruitCost:{food:1250,steel:150,tools:200,silver:800},maintenanceCost:{food:7,silver:6.5,steel:.3,coal:.15},trainingTime:10,populationCost:1,abilities:["火器","齐射","刺刀冲锋"],counters:{cavalry:1.7,siege:1.5},weakAgainst:["gunpowder"],obsoleteAfterEpochs:3},gatling:{id:"gatling",name:"加特林机枪组",desc:"早期机枪，火力密集，克制密集阵型的步兵和骑兵。",epoch:6,icon:"Zap",category:"gunpowder",attack:50,defense:12,speed:2,range:5,recruitCost:{food:1500,steel:300,tools:350,coal:200,silver:1250},maintenanceCost:{food:8,silver:9,steel:.6,coal:.8},trainingTime:12,populationCost:2,abilities:["火器","压制火力","范围伤害"],counters:{infantry:2,cavalry:1.8},weakAgainst:["siege"],obsoleteAfterEpochs:3},lancer:{id:"lancer",name:"枪骑兵",desc:"工业时代的精锐骑兵，适合侦察、追击和近身突袭火器阵地。",epoch:6,icon:"Compass",category:"cavalry",attack:38,defense:20,speed:8,range:1,recruitCost:{food:1600,steel:120,tools:180,silver:1e3},maintenanceCost:{food:11,silver:8,steel:.25,iron:.4},trainingTime:11,populationCost:1,abilities:["冲锋","快速移动","侦察"],counters:{archer:1.9,gunpowder:1.7},weakAgainst:["infantry"],obsoleteAfterEpochs:3},artillery:{id:"artillery",name:"重型火炮",desc:"工业化生产的重型火炮，威力巨大。",epoch:6,icon:"Bomb",category:"siege",attack:80,defense:15,speed:1,range:8,recruitCost:{food:2e3,steel:500,coal:400,tools:300,silver:1750},maintenanceCost:{food:10,silver:11,steel:1.2,coal:1.5},trainingTime:18,populationCost:4,abilities:["攻城","范围伤害","精确打击"],counters:{infantry:2,gunpowder:1.8,siege:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:3}},uc=(e={})=>{let t=0;return Object.entries(e).forEach(([o,i])=>{var s;if(i<=0)return;const r=To[o];if(!r)return;const a=((s=r.maintenanceCost)==null?void 0:s.food)||0;t+=a*i}),t},cr=(e,t)=>{let o=1,i=0;return Object.entries(e).forEach(([r,a])=>{if(a<=0)return;const s=To[r];s&&Object.entries(t).forEach(([u,l])=>{if(l<=0)return;const f=To[u];if(f&&s.counters[f.category]){const p=s.counters[f.category],d=a*l/100;o+=(p-1)*d,i++}})}),{multiplier:o,counterCount:i}},fc={范围伤害:.12,压制火力:.1,火器:.06,齐射:.05,远程攻击:.05,穿甲:.06,冲锋:.06,机动:.04,快速移动:.04,侦察:.03,攻城:.08,精确打击:.08},dc={坚守:.08,方阵:.08,盾墙:.08},lr=(e,t)=>Array.isArray(e)?e.reduce((o,i)=>o+(t[i]||0),0):0,pc=(e={})=>{const t=Object.values(e).reduce((o,i)=>o+(i||0),0);return t<=0?{infantry:0,cavalry:0,archer:0,gunpowder:0,siege:0}:{infantry:(e.infantry||0)/t,cavalry:(e.cavalry||0)/t,archer:(e.archer||0)/t,gunpowder:(e.gunpowder||0)/t,siege:(e.siege||0)/t}},ur=(e={})=>{const t={};return Object.entries(e).forEach(([o,i])=>{if(i<=0)return;const r=To[o];r&&(t[r.category]=(t[r.category]||0)+i)}),t},hc=(e,t,o)=>{if(!e||o<=0)return 1;let i=1;return Object.entries(e.counters||{}).forEach(([r,a])=>{const s=(t[r]||0)/o;s>0&&(i+=(a-1)*s)}),i},fr=(e={})=>{const t={infantry:1,cavalry:1,archer:1,gunpowder:1,siege:1},o=Object.values(e).reduce((i,r)=>i+(r||0),0);return o<=0||Object.entries(e).forEach(([i,r])=>{if(r<=0)return;const a=To[i];if(!a||!a.counters)return;const s=r/o;Object.entries(a.counters).forEach(([u,l])=>{t[u]+=(l-1)*s})}),t},dr=({army:e,enemyCategoryCounts:t,enemyCounterPressure:o,militaryBuffs:i=0,defenseMultiplier:r=1})=>{let a=0,s=0,u=0;const l={},f=Object.values(t||{}).reduce((d,v)=>d+(v||0),0),p=pc(t);return Object.entries(e||{}).forEach(([d,v])=>{if(v<=0)return;const h=To[d];if(!h)return;const b=hc(h,t||{},f),M=lr(h.abilities,fc),g=lr(h.abilities,dc),C=Math.min(.3,(h.range||1)*.03),x=Math.min(.2,(h.speed||1)*.02);let m=0,_=0,A=0;const k=Array.isArray(h.abilities)?h.abilities:[];k.includes("范围伤害")&&(m+=.18*(p.infantry+p.archer)),k.includes("压制火力")&&(m+=.12*(p.infantry+p.archer)),k.includes("火器")&&(m+=.1*(p.infantry+p.cavalry),_-=.08*p.cavalry),k.includes("穿甲")&&(m+=.08*(p.infantry+p.gunpowder+p.siege)),k.includes("冲锋")&&(h.speed||0)>=6&&(m+=.1*(p.gunpowder+p.archer)),k.includes("刺刀冲锋")&&(m+=.06*p.cavalry),k.includes("装填缓慢")&&(m-=.12*p.cavalry),k.includes("重甲")&&(_+=.12,m-=.05),k.includes("抗火器")&&(A-=.15*p.gunpowder,_+=.05*p.gunpowder),(k.includes("精确射击")||k.includes("精确打击"))&&(m+=.08*(p.siege+p.infantry)),k.includes("下马作战")&&(_+=.08*p.cavalry);const D=h.attack*(1+C+x+M+m)*(1+i)*b,P=h.defense*(1+x*.5+g+_)*r*(1+i),T=Math.max(.6,((o==null?void 0:o[h.category])||1)*(1+A)),R=P/T;a+=D*v,s+=P*v,u+=v,l[d]={count:v,attackPerUnit:D,defensePerUnit:P,adjustedDefensePerUnit:R,category:h.category}}),{totalAttack:a,totalDefense:s,totalUnits:u,unitProfiles:l}},mc=(e={})=>{const t={};Object.values(e).forEach(r=>{r&&(t[r.category]=(t[r.category]||0)+r.count)});let o=null,i=0;return Object.entries(t).forEach(([r,a])=>{a>i&&(i=a,o=r)}),o},pr=e=>{const t=Math.floor(e),o=e-t;return t+(Math.random()<o?1:0)},gc=(e,t)=>{if(t<=0)return{};const o={...e};let i=Object.values(o).reduce((u,l)=>u+(l||0),0);if(i<=t)return o;const r=t/i;if(Object.keys(o).forEach(u=>{o[u]=pr(o[u]*r)}),i=Object.values(o).reduce((u,l)=>u+(l||0),0),i<=t)return o;const a=Object.keys(o).sort((u,l)=>(o[l]||0)-(o[u]||0));let s=0;for(;i>t&&a.length>0;){const u=a[s%a.length];(o[u]||0)>0&&(o[u]-=1,i-=1),s+=1}return o},hr=({sideProfile:e,enemyProfile:t,enemyCounterPressure:o,isWinner:i,powerRatio:r,decisive:a,dominanceRatio:s,ownPowerScore:u,enemyPowerScore:l})=>{if(!e||e.totalUnits<=0||t.totalAttack<=0)return{};const f=l/(l+u);let p=.12*Math.pow(f,.9);if(i&&(p*=.75),a&&(p*=i?.6:1.1),p*=.9+Math.random()*.2,!i){const b=Math.max(1,s||1);p*=1+Math.min(.8,(b-1)*.18)}const d=t.totalAttack*p;if(d<=0)return{};let v=0;if(Object.values(e.unitProfiles).forEach(b=>{v+=b.count/b.adjustedDefensePerUnit}),v<=0)return{};const h={};if(Object.entries(e.unitProfiles).forEach(([b,M])=>{const g=M.count/M.adjustedDefensePerUnit,x=d*(g/v)/M.adjustedDefensePerUnit;h[b]=Math.min(M.count,pr(x))}),!i){const b=Math.max(1,s||1);if(b>=3&&(a||b>=6)){const M=Math.min(.75,.2+(b-3)*.12+(a?.15:0));if(Math.random()<M){const g={};return Object.entries(e.unitProfiles).forEach(([C,x])=>{g[C]=x.count}),g}}}if(i&&r>=3&&t.totalUnits>0){let b;r>=10?b=Math.floor(Math.sqrt(t.totalUnits)*.2):r>=6?b=Math.floor(Math.sqrt(t.totalUnits)*.3):b=Math.floor(Math.sqrt(t.totalUnits)*.4);const M=mc(e.unitProfiles);return((o==null?void 0:o[M])||1)>=1.4&&b===0&&t.totalUnits>=5&&(b=1),gc(h,b)}return h},mr=(e,t)=>{const{army:o,militaryBuffs:i=0}=e,{army:r,militaryBuffs:a=0,wealth:s=1e3}=t,u=ur(o),l=ur(r),f=fr(o),p=fr(r),d=dr({army:o,enemyCategoryCounts:l,enemyCounterPressure:p,militaryBuffs:i,defenseMultiplier:1}),v=dr({army:r,enemyCategoryCounts:u,enemyCounterPressure:f,militaryBuffs:a,defenseMultiplier:1.2});let h=d.totalAttack*.65+d.totalDefense*.35,b=v.totalAttack*.65+v.totalDefense*.35;h*=.9+Math.random()*.2,b*=.9+Math.random()*.2;const M=h+b,g=M>0?h/M:0,C=M>0?b/M:0,x=g>.5,m=Math.abs(g-.5)>.28,_=b>0?h/b:100,A=hr({sideProfile:d,enemyProfile:v,enemyCounterPressure:p,isWinner:x,powerRatio:_,decisive:m,dominanceRatio:x?_:1/_,ownPowerScore:h,enemyPowerScore:b}),k=hr({sideProfile:v,enemyProfile:d,enemyCounterPressure:f,isWinner:!x,powerRatio:_>0?1/_:100,decisive:m,dominanceRatio:x?_:1/_,ownPowerScore:b,enemyPowerScore:h}),D=cr(o,r),P=cr(r,o);let T={};if(x){const V=s*(m?.08:.04),N={food:500,wood:300,stone:200,silver:1500,iron:150,copper:100,cloth:100,tools:80};T={food:Math.min(N.food,Math.floor(V*.25)),wood:Math.min(N.wood,Math.floor(V*.12)),stone:Math.min(N.stone,Math.floor(V*.08)),silver:Math.min(N.silver,Math.floor(V*.3)),iron:Math.min(N.iron,Math.floor(V*.1)),copper:Math.min(N.copper,Math.floor(V*.05)),cloth:Math.min(N.cloth,Math.floor(V*.05)),tools:Math.min(N.tools,Math.floor(V*.05))},Object.keys(T).forEach(F=>{T[F]<=0&&delete T[F]})}return{victory:x,decisive:m,attackerPower:Math.floor(h),defenderPower:Math.floor(b),attackerAdvantage:(g*100).toFixed(1),defenderAdvantage:(C*100).toFixed(1),attackerLosses:A,defenderLosses:k,attackerCounter:D.counterCount,defenderCounter:P.counterCount,loot:T,battleReport:yc({victory:x,decisive:m,attackerPower:h,defenderPower:b,attackerCounter:D.counterCount,defenderCounter:P.counterCount,attackerLosses:A,defenderLosses:k,loot:T})}},yc=e=>{const{victory:t,decisive:o,attackerPower:i,defenderPower:r,attackerCounter:a,defenderCounter:s,attackerLosses:u,defenderLosses:l,loot:f}=e;let p=[];t?o?p.push("🎉 压倒性胜利！敌军溃不成军！"):p.push("✓ 艰难的胜利，我军成功击退敌人。"):o?p.push("💀 惨败！我军遭受重创！"):p.push("✗ 战败，我军被迫撤退。"),p.push(`战斗力对比：我方 ${Math.floor(i)} vs 敌方 ${Math.floor(r)}`),a>0&&p.push(`✓ 我方兵种克制生效 ${a} 次`),s>0&&p.push(`✗ 敌方兵种克制生效 ${s} 次`);const d=Object.values(u).reduce((h,b)=>h+b,0),v=Object.values(l).reduce((h,b)=>h+b,0);if(p.push(`我方损失：${d} 人`),p.push(`敌方损失：${v} 人`),t&&f){const h=Object.entries(f).filter(([,b])=>b>0).map(([b,M])=>`${b} ${M}`).join(", ");h&&p.push(`掠夺资源：${h}`)}return p},bc=e=>{const t={};return Object.entries(e).forEach(([o,i])=>{if(i<=0)return;const r=To[o];r&&Object.entries(r.maintenanceCost).forEach(([a,s])=>{t[a]=(t[a]||0)+s*i})}),t},gr=e=>{let t=0;return Object.entries(e).forEach(([o,i])=>{if(i<=0)return;const r=To[o];r&&(t+=r.populationCost*i)}),t},Mc=(e,t)=>{if(t<=0||e<=0)return 1;const o=e/t;return o<=.1?1:o<=.2?1+(o-.1)*2.5:o<=.3?1.25+(o-.2)*2.5:o<=.4?1.5+(o-.3)*2.5:1.75+(o-.4)*2.5},po=["peasant","worker","artisan","merchant","landowner","cleric","scribe","soldier","official","capitalist","miner","engineer","serf"],vc={stratum_approval_above:{generate:()=>{const e=po[Math.floor(Math.random()*po.length)],t=40+Math.floor(Math.random()*40);return{stratum:e,threshold:t}},check:(e,t)=>{var o;return(((o=t.classApproval)==null?void 0:o[e.stratum])||50)>=e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}满意度 ≥ ${e.threshold}`}},stratum_approval_below:{generate:()=>{const e=po[Math.floor(Math.random()*po.length)],t=20+Math.floor(Math.random()*30);return{stratum:e,threshold:t}},check:(e,t)=>{var o;return(((o=t.classApproval)==null?void 0:o[e.stratum])||50)<e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}满意度 < ${e.threshold}`}},stratum_influence_above:{generate:()=>{const e=po[Math.floor(Math.random()*po.length)],t=10+Math.floor(Math.random()*25);return{stratum:e,threshold:t}},check:(e,t)=>{var r;const o=t.totalInfluence||1;return(((r=t.classInfluence)==null?void 0:r[e.stratum])||0)/o*100>=e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}影响力 ≥ ${e.threshold}%`}},stratum_influence_below:{generate:()=>{const e=po[Math.floor(Math.random()*po.length)],t=5+Math.floor(Math.random()*15);return{stratum:e,threshold:t}},check:(e,t)=>{var r;const o=t.totalInfluence||1;return(((r=t.classInfluence)==null?void 0:r[e.stratum])||0)/o*100<e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}影响力 < ${e.threshold}%`}},stratum_living_standard:{generate:()=>{const e=po[Math.floor(Math.random()*po.length)],t=["赤贫","贫困","温饱","小康","富裕","奢华"],o=Math.floor(Math.random()*4);return{stratum:e,minLevel:o,levelName:t[o]}},check:(e,t)=>{var a,s;const o=["赤贫","贫困","温饱","小康","富裕","奢华"],i=((s=(a=t.classLivingStandard)==null?void 0:a[e.stratum])==null?void 0:s.level)||"温饱",r=o.indexOf(i);return r===-1?!1:r>=e.minLevel},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}生活水平 ≥ ${e.levelName}`}},stratum_income_above:{generate:()=>{const e=po[Math.floor(Math.random()*po.length)],t=50+Math.floor(Math.random()*200);return{stratum:e,threshold:t}},check:(e,t)=>{var o;return(((o=t.classIncome)==null?void 0:o[e.stratum])||0)>=e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}日均收入 ≥ ${e.threshold}`}},stability_above:{generate:()=>({threshold:50+Math.floor(Math.random()*40)}),check:(e,t)=>(t.stability||.5)*100>=e.threshold,text:e=>`稳定度 ≥ ${e.threshold}%`},stability_below:{generate:()=>({threshold:20+Math.floor(Math.random()*40)}),check:(e,t)=>(t.stability||.5)*100<e.threshold,text:e=>`稳定度 < ${e.threshold}%`},avg_tax_above:{generate:()=>({threshold:8+Math.floor(Math.random()*15)}),check:(e,t)=>{var r;const o=Object.values(((r=t.taxPolicies)==null?void 0:r.headTaxRates)||{});return(o.length>0?o.reduce((a,s)=>a+s,0)/o.length:.1)*100>=e.threshold},text:e=>`平均税率 ≥ ${e.threshold}%`},avg_tax_below:{generate:()=>({threshold:5+Math.floor(Math.random()*10)}),check:(e,t)=>{var r;const o=Object.values(((r=t.taxPolicies)==null?void 0:r.headTaxRates)||{});return(o.length>0?o.reduce((a,s)=>a+s,0)/o.length:.1)*100<e.threshold},text:e=>`平均税率 < ${e.threshold}%`},coalition_size_above:{generate:()=>({threshold:2+Math.floor(Math.random()*3)}),check:(e,t)=>{var o;return(((o=t.rulingCoalition)==null?void 0:o.length)||0)>=e.threshold},text:e=>`执政联盟 ≥ ${e.threshold}个阶层`},coalition_size_below:{generate:()=>({threshold:2+Math.floor(Math.random()*2)}),check:(e,t)=>{var o;return(((o=t.rulingCoalition)==null?void 0:o.length)||0)<=e.threshold},text:e=>`执政联盟 ≤ ${e.threshold}个阶层`},coalition_includes:{generate:()=>({stratum:po[Math.floor(Math.random()*po.length)]}),check:(e,t)=>{var o;return(o=t.rulingCoalition)==null?void 0:o.includes(e.stratum)},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}参与执政`}},legitimacy_above:{generate:()=>({threshold:40+Math.floor(Math.random()*40)}),check:(e,t)=>(t.legitimacy||50)>=e.threshold,text:e=>`合法性 ≥ ${e.threshold}`},at_war:{generate:()=>({}),check:(e,t)=>{var o;return t.atWar===!0||((o=t.nations)==null?void 0:o.some(i=>i.isAtWar))},text:()=>"处于战争状态"},at_peace:{generate:()=>({}),check:(e,t)=>{var o;return t.atWar!==!0&&!((o=t.nations)!=null&&o.some(i=>i.isAtWar))},text:()=>"处于和平状态"},population_above:{generate:()=>({threshold:500+Math.floor(Math.random()*2e3)}),check:(e,t)=>(t.population||0)>=e.threshold,text:e=>`人口 ≥ ${e.threshold}`},population_below:{generate:()=>({threshold:200+Math.floor(Math.random()*500)}),check:(e,t)=>(t.population||0)<e.threshold,text:e=>`人口 < ${e.threshold}`},epoch_at_least:{generate:()=>({epoch:Math.floor(Math.random()*5)}),check:(e,t)=>(t.epoch||0)>=e.epoch,text:e=>`达到${["石器时代","青铜时代","古典时代","封建时代","探索时代","启蒙时代","工业时代","信息时代"][e.epoch]||`时代${e.epoch}`}`},resource_price_above:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","ale","coal","delicacies","furniture","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",ale:"美酒",coal:"煤炭",delicacies:"珍馐",furniture:"家具",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=1.1+Math.random()*.4,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)>=e.threshold},text:e=>`${e.resourceName}物价 ≥ ${e.threshold}`},resource_price_below:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","ale","coal","delicacies","furniture","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",ale:"美酒",coal:"煤炭",delicacies:"珍馐",furniture:"家具",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=.7+Math.random()*.25,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)<e.threshold},text:e=>`${e.resourceName}物价 < ${e.threshold}`},price_stability:{generate:()=>{const e=.3+Math.random()*.4;return{threshold:Math.round(e*100)/100}},check:(e,t)=>{if(!t.prices||Object.keys(t.prices).length===0)return!0;const o=Object.values(t.prices),i=o.reduce((a,s)=>a+s,0)/o.length,r=o.reduce((a,s)=>a+Math.pow(s-i,2),0)/o.length;return Math.sqrt(r)<=e.threshold},text:e=>`物价波动 ≤ ${(e.threshold*100).toFixed(0)}%`},food_affordable:{generate:e=>{var r;const t=((r=e==null?void 0:e.prices)==null?void 0:r.food)||1,o=.75+Math.random()*.2;return{threshold:Math.round(t*o*10)/10}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i.food)||1)<=e.threshold},text:e=>`粮价 ≤ ${e.threshold}`},food_scarce:{generate:e=>{var r;const t=((r=e==null?void 0:e.prices)==null?void 0:r.food)||1,o=1.1+Math.random()*.3;return{threshold:Math.round(t*o*10)/10}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i.food)||1)>=e.threshold},text:e=>`粮价 ≥ ${e.threshold}`},inflation_above:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","coal","delicacies","furniture","ale","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",coal:"煤炭",delicacies:"珍馐",furniture:"家具",ale:"美酒",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=1.15+Math.random()*.35,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)>=e.threshold},text:e=>`${e.resourceName}物价 ≥ ${e.threshold}`},deflation_below:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","coal","delicacies","furniture","ale","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",coal:"煤炭",delicacies:"珍馐",furniture:"家具",ale:"美酒",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=.65+Math.random()*.25,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)<e.threshold},text:e=>`${e.resourceName}物价 < ${e.threshold}`}},wc={primitive_communism:{name:"原始公社",spectrum:"left",icon:"Users",color:"text-red-400",unlockEpoch:0,maxEpoch:3,historicalRef:"氏族共有制",description:"一切资源归部落共有",issues:["equality","collectivism"],conditionTypes:["stratum_approval_above","stability_above","coalition_size_above"],preferredStrata:["peasant","worker","artisan","serf"],stratumWeights:{peasant:2,worker:2,serf:1.5,landowner:.2,merchant:.3,capitalist:.1},activeEffects:{stability:.05,approval:{peasant:4,worker:4}},unsatisfiedPenalty:{approval:{peasant:-2,worker:-2}}},tribal_elder:{name:"部落长老制",spectrum:"right",icon:"Crown",color:"text-amber-400",unlockEpoch:0,maxEpoch:2,historicalRef:"早期酋长",description:"尊崇长老权威",issues:["tradition","hierarchy"],conditionTypes:["legitimacy_above","stratum_influence_above","population_below"],preferredStrata:["landowner","cleric","official"],stratumWeights:{landowner:2,cleric:1.5,peasant:1},activeEffects:{stability:.04,legitimacyBonus:.04},unsatisfiedPenalty:{stability:-.02}},animism:{name:"万物有灵论",spectrum:"center",icon:"Leaf",color:"text-green-400",unlockEpoch:0,maxEpoch:3,historicalRef:"原始宗教",description:"敬畏自然神灵",issues:["spiritual","nature"],conditionTypes:["stratum_approval_above","stability_above"],preferredStrata:["cleric","peasant"],stratumWeights:{cleric:3,peasant:1.5},activeEffects:{approval:{cleric:6},needsReduction:.02},unsatisfiedPenalty:{}},warrior_cult:{name:"尚武精神",spectrum:"right",icon:"Sword",color:"text-red-500",unlockEpoch:0,maxEpoch:5,historicalRef:"原始部落战争",description:"崇尚武力与征服",issues:["military","expansion"],conditionTypes:["at_war","stratum_approval_above"],preferredStrata:["soldier","landowner"],stratumWeights:{soldier:3},activeEffects:{militaryBonus:.15},unsatisfiedPenalty:{approval:{soldier:-4}}},aristocratic_oligarchy:{name:"贵族寡头制",spectrum:"right",icon:"Castle",color:"text-purple-400",unlockEpoch:1,historicalRef:"斯巴达双王制",description:"政权归于少数贵族",issues:["hierarchy","tradition"],conditionTypes:["stratum_influence_above","coalition_includes","legitimacy_above"],preferredStrata:["landowner","official","merchant"],stratumWeights:{landowner:3,official:1.5},activeEffects:{militaryBonus:.12,taxEfficiency:.08},unsatisfiedPenalty:{approval:{landowner:-6}}},theocracy:{name:"神权政治",spectrum:"right",icon:"Church",color:"text-yellow-300",unlockEpoch:1,historicalRef:"古埃及法老",description:"神的代言人统治",issues:["spiritual","hierarchy"],conditionTypes:["coalition_includes","stratum_approval_above"],preferredStrata:["cleric"],stratumWeights:{cleric:4},activeEffects:{legitimacyBonus:.15,approval:{cleric:15}},unsatisfiedPenalty:{approval:{cleric:-8}}},republicanism:{name:"共和主义",spectrum:"center",icon:"Scale",color:"text-blue-400",unlockEpoch:2,historicalRef:"罗马共和国",description:"公民参与公共事务",issues:["liberty","law"],conditionTypes:["coalition_size_above","legitimacy_above","stability_above"],preferredStrata:["scribe","merchant","artisan","official"],stratumWeights:{scribe:2,merchant:1.5,artisan:1.5},activeEffects:{legitimacyBonus:.12,stability:.08},unsatisfiedPenalty:{stability:-.02}},populares:{name:"平民派",spectrum:"left",icon:"Users",color:"text-orange-400",unlockEpoch:2,historicalRef:"格拉古兄弟",description:"为平民争取权益",issues:["equality","reform"],conditionTypes:["stratum_approval_above","stratum_living_standard","food_affordable"],preferredStrata:["peasant","worker","artisan","serf"],stratumWeights:{peasant:2.5,worker:2.5,artisan:1.5},activeEffects:{populationGrowth:.08,approval:{peasant:8,worker:8}},unsatisfiedPenalty:{approval:{peasant:-4,worker:-4}}},legalism:{name:"法家",spectrum:"right",icon:"Gavel",color:"text-gray-300",unlockEpoch:2,historicalRef:"商鞅变法",description:"严刑峻法治国",issues:["law","efficiency"],conditionTypes:["avg_tax_above","stability_above"],preferredStrata:["official","soldier","scribe"],stratumWeights:{official:2.5,soldier:1.5},activeEffects:{taxEfficiency:.15,stability:-.06},unsatisfiedPenalty:{}},confucianism:{name:"儒家",spectrum:"center",icon:"Book",color:"text-amber-300",unlockEpoch:2,historicalRef:"孔孟之道",description:"礼教治国",issues:["tradition","education"],conditionTypes:["stratum_approval_above","stability_above","legitimacy_above"],preferredStrata:["scribe","cleric","official"],stratumWeights:{scribe:3,cleric:1.5,official:2},activeEffects:{stability:.15,researchSpeed:.08},unsatisfiedPenalty:{stability:-.02}},mohism:{name:"墨家",spectrum:"left",icon:"Wrench",color:"text-gray-400",unlockEpoch:2,historicalRef:"墨子兼爱非攻",description:"兼爱非攻，尚同尚贤",issues:["equality","efficiency"],conditionTypes:["at_peace","stratum_approval_above"],preferredStrata:["artisan","worker","engineer"],stratumWeights:{artisan:2.5,worker:2,engineer:1.5},activeEffects:{industryBonus:.12,buildingCostMod:-.08,productionInputCost:{sawmill:-.15,brickworks:-.15,metallurgy_workshop:-.18}},unsatisfiedPenalty:{approval:{artisan:-2}}},taoism:{name:"道家",spectrum:"center",icon:"Circle",color:"text-slate-300",unlockEpoch:2,historicalRef:"老庄无为",description:"无为而治",issues:["liberty","nature"],conditionTypes:["avg_tax_below","stability_above"],preferredStrata:["cleric","peasant","scribe"],stratumWeights:{cleric:2,peasant:1.5,scribe:1.5},activeEffects:{needsReduction:.12,stability:.08},unsatisfiedPenalty:{}},feudalism:{name:"封建主义",spectrum:"right",icon:"Castle",color:"text-blue-500",unlockEpoch:3,historicalRef:"中世纪欧洲分封",description:"领主-附庸关系",issues:["hierarchy","land"],conditionTypes:["stratum_influence_above","legitimacy_above"],preferredStrata:["landowner","official"],stratumWeights:{landowner:3,peasant:.5},activeEffects:{gatherBonus:.08,approval:{landowner:12}},unsatisfiedPenalty:{approval:{landowner:-6}}},peasant_revolt:{name:"农民起义派",spectrum:"left",icon:"Flame",color:"text-red-600",unlockEpoch:3,historicalRef:"黄巾起义、扎克雷起义",description:"推翻压迫者",issues:["equality","revolution"],conditionTypes:["stratum_approval_below","avg_tax_above","food_scarce","inflation_above"],preferredStrata:["peasant","serf","worker"],stratumWeights:{peasant:3,serf:3,worker:2},activeEffects:{organizationDecay:-.22},unsatisfiedPenalty:{}},guild_corporatism:{name:"行会主义",spectrum:"center",icon:"Hammer",color:"text-orange-300",unlockEpoch:3,historicalRef:"中世纪行会",description:"同业互助，质量至上",issues:["trade","tradition"],conditionTypes:["stratum_approval_above","stratum_income_above","resource_price_below","price_stability"],preferredStrata:["artisan","merchant"],stratumWeights:{artisan:3,merchant:2},activeEffects:{tradeBonus:.12,approval:{artisan:8,merchant:8},productionInputCost:{furniture_workshop:-.18,tailor_workshop:-.18,loom_house:-.15}},unsatisfiedPenalty:{approval:{artisan:-4},productionInputCost:{furniture_workshop:.05,tailor_workshop:.05}}},mercantilism:{name:"重商主义",spectrum:"center",icon:"Ship",color:"text-cyan-400",unlockEpoch:4,historicalRef:"东印度公司",description:"贸易国富之本",issues:["trade","wealth"],conditionTypes:["stratum_income_above","stratum_influence_above","resource_price_above","inflation_above"],preferredStrata:["merchant","capitalist"],stratumWeights:{merchant:3,capitalist:2},activeEffects:{tradeBonus:.18,incomePercentBonus:.08},unsatisfiedPenalty:{approval:{merchant:-4}}},absolutism:{name:"绝对君主制",spectrum:"right",icon:"Crown",color:"text-purple-500",unlockEpoch:4,historicalRef:"路易十四、彼得大帝",description:"朕即国家",issues:["hierarchy","centralization"],conditionTypes:["coalition_size_below","legitimacy_above"],preferredStrata:["official","landowner"],stratumWeights:{official:2},activeEffects:{taxEfficiency:.15,buildingCostMod:-.12},unsatisfiedPenalty:{}},humanism:{name:"人文主义",spectrum:"center",icon:"Book",color:"text-rose-300",unlockEpoch:4,historicalRef:"文艺复兴",description:"以人为本",issues:["education","progress"],conditionTypes:["stratum_approval_above","epoch_at_least"],preferredStrata:["scribe","artisan","engineer"],stratumWeights:{scribe:3,artisan:2},activeEffects:{researchSpeed:.15,cultureBonus:.12},unsatisfiedPenalty:{}},colonialism:{name:"殖民主义",spectrum:"right",icon:"Globe",color:"text-emerald-500",unlockEpoch:4,historicalRef:"大航海时代",description:"开拓新世界",issues:["expansion","trade"],conditionTypes:["stratum_income_above","at_war"],preferredStrata:["merchant","soldier","navigator"],stratumWeights:{merchant:2,soldier:1.5},activeEffects:{tradeBonus:.15,diplomaticBonus:.8},unsatisfiedPenalty:{}},classical_liberalism:{name:"古典自由主义",spectrum:"center",icon:"Lightbulb",color:"text-yellow-400",unlockEpoch:5,historicalRef:"洛克、亚当斯密",description:"自由放任经济",issues:["liberty","free_market"],conditionTypes:["avg_tax_below","stratum_approval_above","price_stability","deflation_below"],preferredStrata:["merchant","capitalist","artisan"],stratumWeights:{merchant:2,capitalist:2.5,artisan:1.5},activeEffects:{incomePercentBonus:.12,populationGrowth:.08},unsatisfiedPenalty:{approval:{merchant:-4,capitalist:-4}}},enlightened_despotism:{name:"开明专制",spectrum:"center",icon:"GraduationCap",color:"text-indigo-400",unlockEpoch:5,historicalRef:"腎特烈大帝、叶卡捷琳娜",description:"国王为国家第一仆人",issues:["reform","centralization"],conditionTypes:["coalition_size_below","legitimacy_above","stability_above"],preferredStrata:["official","scribe","engineer"],stratumWeights:{official:2,scribe:2,engineer:1.5},activeEffects:{researchSpeed:.18,buildingCostMod:-.08},unsatisfiedPenalty:{}},conservatism:{name:"保守主义",spectrum:"right",icon:"Shield",color:"text-gray-400",unlockEpoch:5,historicalRef:"伯克、梅特涅",description:"维护传统秩序",issues:["tradition","stability"],conditionTypes:["stability_above","legitimacy_above"],preferredStrata:["landowner","cleric","official"],stratumWeights:{landowner:2,cleric:2},activeEffects:{stability:.12,legitimacyBonus:.08},unsatisfiedPenalty:{stability:-.04}},utopian_socialism:{name:"空想社会主义",spectrum:"left",icon:"Sparkles",color:"text-pink-400",unlockEpoch:5,historicalRef:"莫尔乌托邦、欧文",description:"构建理想社会",issues:["equality","progress"],conditionTypes:["stratum_approval_above","stratum_living_standard"],preferredStrata:["worker","artisan","peasant","scribe"],stratumWeights:{scribe:2,worker:1.5,artisan:1.5},activeEffects:{researchSpeed:.12,approval:{worker:8}},unsatisfiedPenalty:{}},physiocracy:{name:"重农主义",spectrum:"center",icon:"Wheat",color:"text-lime-400",unlockEpoch:5,historicalRef:"魁奈学派",description:"土地是财富之源",issues:["land","free_market"],conditionTypes:["stratum_influence_above","stratum_approval_above","food_affordable","resource_price_below"],preferredStrata:["landowner","peasant"],stratumWeights:{landowner:2.5,peasant:2},activeEffects:{gatherBonus:.15,approval:{peasant:8,landowner:8}},unsatisfiedPenalty:{approval:{landowner:-4}}},marxism:{name:"马克思主义",spectrum:"left",icon:"Factory",color:"text-red-500",unlockEpoch:6,historicalRef:"共产党宣言",description:"工人阶级专政",issues:["equality","revolution","collectivism"],conditionTypes:["coalition_includes","stratum_influence_above"],preferredStrata:["worker","miner","artisan"],stratumWeights:{worker:4,miner:2},activeEffects:{industryBonus:.18,approval:{worker:15,miner:12},productionInputCost:{steel_foundry:-.22,textile_mill:-.18,building_materials_plant:-.18}},unsatisfiedPenalty:{approval:{worker:-6},organizationDecay:-.08,productionInputCost:{steel_foundry:.08,textile_mill:.06}}},social_democracy:{name:"社会民主主义",spectrum:"left",icon:"HeartHandshake",color:"text-rose-400",unlockEpoch:6,historicalRef:"伯恩斯坦修正主义",description:"渐进改良",issues:["equality","welfare"],conditionTypes:["stratum_approval_above","stratum_living_standard","stability_above","food_affordable","price_stability"],preferredStrata:["worker","scribe","artisan","peasant"],stratumWeights:{worker:2,scribe:1.5,artisan:1.5},activeEffects:{approval:{worker:12,peasant:8},stability:.08},unsatisfiedPenalty:{approval:{worker:-4}}},anarchism:{name:"无政府主义",spectrum:"left",icon:"CircleSlash",color:"text-gray-500",unlockEpoch:6,historicalRef:"巴枯宁、克鲁泡特金",description:"废除一切权威",issues:["liberty","revolution"],conditionTypes:["stability_below","stratum_approval_below"],preferredStrata:["worker","artisan","peasant"],stratumWeights:{worker:2,artisan:2},activeEffects:{needsReduction:.15},unsatisfiedPenalty:{stability:-.06}},nationalism:{name:"民族主义",spectrum:"right",icon:"Flag",color:"text-orange-500",unlockEpoch:6,historicalRef:"俨斯麦统一德国",description:"民族国家至上",issues:["nation","military"],conditionTypes:["at_war","stratum_approval_above"],preferredStrata:["soldier","official","landowner"],stratumWeights:{soldier:2.5,official:1.5},activeEffects:{militaryBonus:.22,approval:{soldier:12}},unsatisfiedPenalty:{}},neoliberalism:{name:"新自由主义",spectrum:"right",icon:"TrendingUp",color:"text-emerald-400",unlockEpoch:6,historicalRef:"哈耶克、弗里德曼",description:"市场万能",issues:["free_market","privatization"],conditionTypes:["stratum_income_above","avg_tax_below","resource_price_above","inflation_above"],preferredStrata:["capitalist","merchant"],stratumWeights:{capitalist:4,merchant:2},activeEffects:{incomePercentBonus:.18,tradeBonus:.12},unsatisfiedPenalty:{approval:{capitalist:-6}}},technocracy:{name:"技术官僚主义",spectrum:"center",icon:"Cpu",color:"text-sky-400",unlockEpoch:6,historicalRef:"圣西门、专家治国",description:"让专家决策",issues:["efficiency","progress"],conditionTypes:["epoch_at_least","stratum_influence_above"],preferredStrata:["engineer","scribe","official"],stratumWeights:{engineer:3,scribe:2},activeEffects:{researchSpeed:.22,industryBonus:.12,productionInputCost:{printing_house:-.28,factory:-.22,steel_foundry:-.15}},unsatisfiedPenalty:{}},digital_democracy:{name:"数字民主",spectrum:"center",icon:"Monitor",color:"text-cyan-300",unlockEpoch:7,historicalRef:"电子政务、区块链投票",description:"网络参与决策",issues:["liberty","progress"],conditionTypes:["coalition_size_above","stability_above","legitimacy_above"],preferredStrata:["engineer","scribe","worker"],stratumWeights:{engineer:2,scribe:2,worker:1.5},activeEffects:{legitimacyBonus:.18,stability:.12},unsatisfiedPenalty:{}},eco_socialism:{name:"生态社会主义",spectrum:"left",icon:"Leaf",color:"text-green-500",unlockEpoch:7,historicalRef:"绿色新政",description:"环境公正",issues:["equality","nature"],conditionTypes:["stratum_approval_above","stability_above"],preferredStrata:["worker","peasant","engineer"],stratumWeights:{worker:2,peasant:2,engineer:1.5},activeEffects:{needsReduction:.15,stability:.08},unsatisfiedPenalty:{}},transhumanism:{name:"超人类主义",spectrum:"right",icon:"Zap",color:"text-violet-400",unlockEpoch:7,historicalRef:"技术奇点",description:"超越人类极限",issues:["progress","efficiency"],conditionTypes:["epoch_at_least","stratum_income_above"],preferredStrata:["engineer","capitalist"],stratumWeights:{engineer:4,capitalist:2},activeEffects:{researchSpeed:.28,populationGrowth:.08},unsatisfiedPenalty:{}}},yr={};Object.entries(wc).forEach(([e,t])=>{yr[e]={id:e,...t,triggerCondition:()=>!1,conditionText:"条件待生成"}});function br(e,t,o){return!o||o.length===0?!1:o.every(i=>{const r=vc[i.typeId];return r?r.check(i.params,t):!1})}const Dn={INITIAL_MIN:50,MAX:100,MIN:0,COUP_THRESHOLD:25,DAILY_CHANGES:{stanceSatisfied:.4,stanceUnsatisfied:-.3,financialSatisfied:.3,financialUncomfortable:-.1,financialStruggling:-.2,financialDesperate:-.25,stabilityHigh:.2,stabilityLow:-.1,salaryPaid:.15,salaryUnpaid:-.3}},Ii=(e,t,o=[])=>{const i=De[e];return!(!i||i.unlockTech&&!o.includes(i.unlockTech)||typeof i.unlockEpoch=="number"&&i.unlockEpoch>t)},Mr=e=>{var t;return((t=De[e])==null?void 0:t.basePrice)||1},vr=(e,t,o=0)=>{var D,P,T,R;if(!t)return Mr(e);const i=Mr(e),r=(T=(P=(D=t==null?void 0:t.economyTraits)==null?void 0:D.resourceBias)==null?void 0:P[e])!=null?T:1,a=((R=t.inventory)==null?void 0:R[e])||0,s=Math.round(500*Math.pow(r,1.2)),u=Math.max(.8,Math.min(1.5,(t.wealth||1e3)/1e3)),l=t.epoch||0,f=1+l*.5+Math.pow(l,1.3)*.1,p=s*u*f,d=p>0?a/p:1,v=Math.max(0,1-d),h=Math.max(0,d-1),b=1+Math.min(2.5,v*.9),M=1-Math.min(.95,h*.6),g=b*M,x=1+(Math.max(.6,Math.min(1.6,r))-1)*.25,m=t.foreignWars?Object.values(t.foreignWars).filter(V=>V==null?void 0:V.isAtWar).length:0,_=(t.isAtWar?1:0)+m,A=_>0?1+Math.min(.75,_*.15):1;let k=i*x*g*A;return k=Math.max(i*.25,Math.min(i*4,k)),Math.max(.5,parseFloat(k.toFixed(2)))},xc=(e="")=>e?e.split("").reduce((t,o)=>t+o.charCodeAt(0),0):0,ki=(e,t={},o=0)=>{var _,A,k,D;const i=(k=(A=(_=t==null?void 0:t.economyTraits)==null?void 0:_.resourceBias)==null?void 0:A[e])!=null?k:1,r=Math.round(500*Math.pow(i,1.2)),a=Math.max(.8,Math.min(1.5,(t.wealth||1e3)/1e3)),s=t.epoch||0,u=1+s*.5+Math.pow(s,1.3)*.1,l=r*a*u,f=typeof t.marketVolatility=="number"?t.marketVolatility:.3,p=((D=t==null?void 0:t.inventory)==null?void 0:D[e])||0,d=xc(e),v=Math.sin(o*.015+d),h=l*(1+v*f),b=i>1?.3:i<1?1.5:.8,M=i>1?.4:i<1?2:1.2,g=h*b,C=h*M,x=Math.max(0,g-p),m=Math.max(0,p-C);return{isShortage:x>0,isSurplus:m>0,shortageAmount:x,surplusAmount:m,target:h}},Di={DESTITUTE:{level:"赤贫",icon:"Skull",color:"text-gray-400",bgColor:"bg-gray-900/30",borderColor:"border-gray-500/30",approvalCap:30},POOR:{level:"贫困",icon:"AlertTriangle",color:"text-red-400",bgColor:"bg-red-900/20",borderColor:"border-red-500/30",approvalCap:50},SUBSISTENCE:{level:"温饱",icon:"UtensilsCrossed",color:"text-yellow-400",bgColor:"bg-yellow-900/20",borderColor:"border-yellow-500/30",approvalCap:70},COMFORTABLE:{level:"小康",icon:"Home",color:"text-green-400",bgColor:"bg-green-900/20",borderColor:"border-green-500/30",approvalCap:85},PROSPEROUS:{level:"富裕",icon:"Gem",color:"text-blue-400",bgColor:"bg-blue-900/20",borderColor:"border-blue-500/30",approvalCap:95},LUXURIOUS:{level:"奢华",icon:"Crown",color:"text-purple-400",bgColor:"bg-purple-900/20",borderColor:"border-purple-500/30",approvalCap:100}};function Ec(e,t,o=0,i=100){if(t<=0){const a=i>0?o/i:0;return a<.5?a*20:a<1?10+(a-.5)*30:a<2?25+(a-1)*10:Math.min(50,35+(a-2)*5)}const r=(e-t)/t;return r>=1?50:r>=0?25+r*25:r>=-1?Math.max(0,25+r*25):0}function Cc(e,t,o=30,i=100){if(t<=0){const a=i>0?e/i:0;return a<.5?a*10:a<1?5+(a-.5)*10:Math.min(20,10+(a-1)*5)}const r=e/t;return Math.min(20,r/o*20)}function _c(e){return e<20?Di.DESTITUTE:e<40?Di.POOR:e<55?Di.SUBSISTENCE:e<70?Di.COMFORTABLE:e<85?Di.PROSPEROUS:Di.LUXURIOUS}function zi(e,t=1,o=1,i=6,r=!1){const a=Math.max(e,t*.3);let s;a<=0?s=.3:a<1?s=.3+a*.7:r?s=1+(a-1)*.8:s=1+Math.log(a)*.5;let u;s<=1?u=s*(.7+.3*Math.min(1.2,o)):u=1+(s-1)*o;let l;t<.3?l=.5:t<1?l=.5+(t-.3)*(.5/.7):t<2?l=1:r?l=1+(t-2)*.05*o:l=1+Math.min(.15,(t-2)*.025*o);let f=u*l;return t<.5?f=Math.min(f,.8):t<1?f=Math.min(f,1):t<2&&(f=Math.min(f,1.2)),Math.max(.3,Math.min(i,f))}function Tc({consumptionMultiplier:e=1,incomeRatio:t=null,wealthRatio:o=null,livingStandardLevel:i=null}={}){var v;const r=(h,b,M)=>Math.min(M,Math.max(b,h)),a=Number.isFinite(e)?Math.max(.3,e):1,s=Number.isFinite(t)?r(.4+.6*Math.min(1.5,t),.3,1.2):1,u=Number.isFinite(o)?r(.4+.6*Math.min(2,o)/2,.3,1.2):1,l=.6+.4*((s+u)/2),p=i&&(v={赤贫:.05,贫困:.15,温饱:.4,小康:.9,富裕:1.1,奢华:1.25}[i])!=null?v:1,d=a*p*l;return r(d,.05,1.6)}function Pc(e,t=1,o=1,i=null){if(e<1&&t<2)return 0;const r=Math.max(e,t*.5);let a;r<=0?a=.3:r<1?a=.3+r*.7:a=1+Math.log(r)*.7;const s=(o+1)/2;let u;a<=1?u=a*(.8+.2*Math.min(1.2,s)):u=1+(a-1)*s;let l;t<.3?l=.5:t<1?l=.5+(t-.3)*(.5/.7):t<2?l=1:l=1+Math.min(.25,(t-2)*.03);const f=u*l;let p=Math.max(.3,Math.min(10,f));if(!i)return p;const v={赤贫:0,贫困:0,温饱:1.49,小康:3,富裕:6,奢华:10}[i];return t<1&&(p=Math.min(p,.99)),v===void 0?p:Math.min(v,p)}function Ac(e,t,o,i=1,r=100){const a=t*30;let s=e+a+o,u=0;r>0&&(u=Math.min(60,.7*Math.sqrt(r)));let l=0;i>0&&(l=Math.min(40,40*(1-Math.exp(-i*.5))));const f=u+l;return s*.5+f*.5}function Rc({count:e,income:t=0,expense:o=0,wealthValue:i=0,startingWealth:r=100,essentialCost:a=0,shortagesCount:s=0,effectiveNeedsCount:u=0,unlockedLuxuryTiers:l=0,totalLuxuryTiers:f=0,previousScore:p=null,isNewStratum:d=!1,maxConsumptionMultiplier:v=6,wealthElasticity:h=1,greedy:b=!1}){if(e<=0)return null;const M=t/e,g=o/e,C=i/e,x=a/e,m=Ec(M,x,C,r);let _;if(u>0)_=Math.max(0,(u-s)/u);else{const O=r>0?C/r:0;_=Math.min(1,O)}const A=Cc(C,g,30,r),k=r>0?C/r:0,D=Ac(m,_,A,k,C),P=d?1:.15,T=p!==null?p*(1-P)+D*P:D,R=_c(T),V=x>0?M/x:M>0?10:0,N=zi(V,k,h,v,b),F=f>0?l/f:0;return{score:T,targetScore:D,incomeAdequacyScore:m,satisfactionRate:_,financialSecurityScore:A,incomePerCapita:M,expensePerCapita:g,wealthPerCapita:C,wealthMultiplier:N,wealthRatio:k,luxuryUnlockRatio:F,unlockedLuxuryTiers:l,totalLuxuryTiers:f,level:R.level,icon:R.icon,color:R.color,bgColor:R.bgColor,borderColor:R.borderColor,approvalCap:R.approvalCap}}function Sc(e){return e<.5?{icon:"Skull",color:"text-gray-400",level:"赤贫",approvalCap:30}:e<1?{icon:"AlertTriangle",color:"text-red-400",level:"贫困",approvalCap:50}:e<1.5?{icon:"UtensilsCrossed",color:"text-yellow-400",level:"温饱",approvalCap:70}:e<2.5?{icon:"Home",color:"text-green-400",level:"小康",approvalCap:85}:e<4?{icon:"Gem",color:"text-blue-400",level:"富裕",approvalCap:95}:{icon:"Crown",color:"text-purple-400",level:"奢华",approvalCap:100}}tr.reduce((e,t)=>(e[t.id]=t,e),{});const Ht=["official","cleric","capitalist","landowner","knight","engineer","navigator","merchant","soldier","scribe","worker","artisan","miner","lumberjack","serf","peasant"],Ic=.0025,kc=.2,Dc=.25,Wc=1e-4,Bc=1.5,Oc=2,jc=1.5,Nc=.8,wr=5,Lc=.5,xr=["food","cloth"],Wi=1e-4,Wn=1,Fc=new Set(["science","culture"]),Uc=45,$c=30,Gc=.003,Vc=.001,Bn=20,qc=.4,Er=200,Hc=.05,wa=3,Yc=30,Po={unemployed:0,serf:0,peasant:1,lumberjack:1,miner:1,worker:1,artisan:2,soldier:2,navigator:2,scribe:2,merchant:2,cleric:2,official:3,landowner:3,capitalist:3,knight:3,engineer:3},Xc={0:0,1:0,2:.5,3:.4},zc={landowner:.35,capitalist:.35,soldier:0},Jc=2,Zc=.2,Ft=(e,t,o)=>!Number.isFinite(e)||e<t?t:e>o?o:e,Qc=1e12,Ji=(e,t=0)=>Number.isFinite(e)?Math.max(0,Math.min(e,Qc)):t,Jt=e=>{if(e==="silver")return!1;const t=De[e];return t?Fc.has(e)?!0:!t.type||t.type!=="virtual":!1},Ao=e=>{if(e==="silver")return 1;const t=De[e];return(t==null?void 0:t.basePrice)||1},xa=(e={},t=1)=>{if(!e||typeof e!="object")return{};const o={};return Object.entries(e).forEach(([i,r])=>{typeof r=="number"?o[i]=r*t:r&&typeof r=="object"&&!Array.isArray(r)?o[i]=xa(r,t):o[i]=r}),o},Kc=(e,t)=>{if(!e||!t)return{adjustments:{},approvalPenalties:{},adminCost:0};const o=Object.values(e).reduce((s,u)=>s+u,0),i={},r={};let a=0;return Object.entries(t).forEach(([s,u])=>{const l=e[s]||0,f=o>0?l/o*100:0,p=u-f;Math.abs(p)>1&&(i[s]=p*.1,p<-5&&(r[s]=Math.floor(p/2)),a+=Math.abs(p)*.5)}),{adjustments:i,approvalPenalties:r,adminCost:Math.round(a)}},e0=1,Zi=(e,t={},o={})=>{var b,M,g,C;if(!e)return{profit:0,outputValue:0,inputValue:0,wageCost:0,businessTax:0};const i=(t==null?void 0:t.prices)||{},r=(t==null?void 0:t.wages)||{},a=x=>{var m;return!x||x==="silver"?1:(m=i[x])!=null?m:1},s=Object.entries(e.output||{}).reduce((x,[m,_])=>x+a(m)*_,0),u=Object.entries(e.input||{}).reduce((x,[m,_])=>x+a(m)*_,0),l=(M=(b=o==null?void 0:o.businessTaxRates)==null?void 0:b[e.id])!=null?M:1,p=((g=e.businessTaxBase)!=null?g:.1)*l,d=e.owner;let v=0;for(const[x,m]of Object.entries(e.jobs||{})){if(x===d)continue;const _=(C=r[x])!=null?C:.1;v+=_*m}return{profit:s-u-p-v,outputValue:s,inputValue:u,wageCost:v,businessTax:p}},t0=(e,t,o,i,r,a={},s={},u={})=>{var C;if(!e||!t)return{canExpand:!1,reason:"无效建筑",cost:0,profit:0,roi:0};const l=i==null?void 0:i[e.id];if(!(l!=null&&l.allowed))return{canExpand:!1,reason:"未允许扩张",cost:0,profit:0,roi:0};const f=(a==null?void 0:a.prices)||{},p=e.baseCost||{};let d=0;for(const[x,m]of Object.entries(p)){const _=(C=f[x])!=null?C:1;d+=m*_}d=d>0?Math.round(d):100;const h=Zi(e,a,s).profit,b=d>0?h/d:0,M=u==null?void 0:u[e.id];return(Number.isFinite(M)?M:1)<e0?{canExpand:!1,reason:"岗位未满",cost:d,profit:h,roi:b}:h<=0?{canExpand:!1,reason:"建筑不盈利",cost:d,profit:h,roi:b}:o<d?{canExpand:!1,reason:"业主财富不足",cost:d,profit:h,roi:b}:{canExpand:!0,reason:null,cost:d,profit:h,roi:b}},o0=(e,t,o,i,r={},a={},s={})=>{const u=[],l={};if(!e||!t||!o)return console.log("[FREE MARKET] processOwnerExpansions early return:",{hasBuildings:!!e,hasClassWealth:!!t,hasExpansionSettings:!!o}),{expansions:u,wealthDeductions:l};const f=[],p={},d=[];for(const v of e){if(!v.owner)continue;const h=v.owner,b=t[h]||0,M=i[v.id]||0,{canExpand:g,reason:C,cost:x,profit:m,roi:_}=t0(v,h,b,o,M,r,a,s);if(g){const A=x>0?Math.max(.01,m*m/x):.01,k={buildingId:v.id,owner:h,cost:x,profit:m,roi:_,weight:A};f.push(k),p[h]||(p[h]=[]),p[h].push(k)}else d.push({buildingId:v.id,owner:h,ownerWealth:b,reason:C,cost:x,profit:m,roi:_,staffingRatio:s==null?void 0:s[v.id],settingsForBuilding:o[v.id]})}if(console.log("[FREE MARKET] processOwnerExpansions:",{totalBuildingsChecked:e.filter(v=>v.owner).length,candidatesFound:f.length,candidates:f.map(v=>({id:v.buildingId,profit:v.profit.toFixed(2),roi:(v.roi*100).toFixed(1)+"%",weight:v.weight.toFixed(2)})),firstFewRejections:d.slice(0,5)}),f.length>0){const v=[];Object.entries(p).forEach(([h,b])=>{if(!b.length)return;const M=e.filter(T=>T.owner===h).reduce((T,R)=>T+(i[R.id]||0),0),g=M%2===0?"roi":"profit",C=[...b].sort((T,R)=>R[g]-T[g]),x=Math.ceil(C.length/3),m=[C.slice(0,x),C.slice(x,x*2),C.slice(x*2)],_=M%3;let A=null;for(let T=0;T<m.length;T+=1){const R=(_+T)%m.length;if(m[R].length>0){A=m[R];break}}if(!A||A.length===0)return;const k=A.reduce((T,R)=>T+R.weight,0);let D=Math.random()*k,P=A[0];for(const T of A)if(D-=T.weight,D<=0){P=T;break}v.push({...P,_debug:{ownerBuildingTotal:M,metric:g,tierIndex:m.indexOf(A),probability:k>0?P.weight/k*100:0}})}),v.length>0&&(console.log("[FREE MARKET] Selected for expansion:",v.map(h=>({buildingId:h.buildingId,owner:h.owner,profit:h.profit.toFixed(2),roi:(h.roi*100).toFixed(1)+"%",weight:h.weight.toFixed(2),metric:h._debug.metric,tierIndex:h._debug.tierIndex,probability:h._debug.probability.toFixed(1)+"%"}))),v.forEach(h=>{u.push(h),l[h.owner]=(l[h.owner]||0)+h.cost}))}return{expansions:u,wealthDeductions:l}},i0=(e,t,o,i)=>{var u;if(!(i!=null&&i.enabled))return{adjustment:0,isIncome:!1,effectivePrice:o};const r=(u=i.governmentSellPrices)==null?void 0:u[e];if(r==null)return{adjustment:0,isIncome:!1,effectivePrice:o};const a=r,s=(r-o)*t;return s>0?{adjustment:s,isIncome:!0,effectivePrice:a}:s<0?{adjustment:Math.abs(s),isIncome:!1,effectivePrice:a}:{adjustment:0,isIncome:!1,effectivePrice:o}},n0=(e,t,o,i)=>{var u;if(!(i!=null&&i.enabled))return{adjustment:0,isIncome:!1,effectivePrice:o};const r=(u=i.governmentBuyPrices)==null?void 0:u[e];if(r==null)return{adjustment:0,isIncome:!1,effectivePrice:o};const a=r;return{adjustment:r*t,isIncome:!1,effectivePrice:a}},Cr=({resourceKey:e,amount:t,marketPrice:o,priceControls:i,taxBreakdown:r,resources:a,onTreasuryChange:s,applyTreasuryChange:u})=>{const l=i0(e,t,o,i);if(l.adjustment>0)if(l.isIncome)r.priceControlIncome=(r.priceControlIncome||0)+l.adjustment;else{const f=a.silver||0;if(f>=l.adjustment)typeof u=="function"?u(-l.adjustment,"price_control_buy"):(a.silver=f-l.adjustment,typeof s=="function"&&s(-l.adjustment,"price_control_buy")),r.priceControlExpense=(r.priceControlExpense||0)+l.adjustment;else return{effectivePrice:o,success:!1}}return{effectivePrice:l.effectivePrice,success:!0}},a0=({resourceKey:e,amount:t,marketPrice:o,priceControls:i,taxBreakdown:r,resources:a,onTreasuryChange:s,applyTreasuryChange:u})=>{const l=n0(e,t,o,i);if(l.adjustment>0)if(l.isIncome)r.priceControlIncome=(r.priceControlIncome||0)+l.adjustment;else{const f=a.silver||0;if(f>=l.adjustment)typeof u=="function"?u(-l.adjustment,"price_control_sell"):(a.silver=f-l.adjustment,typeof s=="function"&&s(-l.adjustment,"price_control_sell")),r.priceControlExpense=(r.priceControlExpense||0)+l.adjustment;else return{effectivePrice:o,success:!1}}return{effectivePrice:l.effectivePrice,success:!0}},Mo={VERY_EASY:"very_easy",EASY:"easy",NORMAL:"normal",HARD:"hard",VERY_HARD:"very_hard",EXTREME:"extreme"},Ea=Mo.EASY,_r={[Mo.VERY_EASY]:{id:Mo.VERY_EASY,name:"和平",description:"极其轻松，专注于建设，几乎没有战争威胁",icon:"🕊️",organizationGrowthMultiplier:.2,organizationDecayMultiplier:2,satisfactionThreshold:25,buildingCostGrowthFactor:1.05,aiWarDeclarationChance:.1,aiMilitaryActionChance:.2,aiMilitaryCooldownBonus:30,aiMinWarEpoch:4,raidDamageMultiplier:.3,raidPopulationLossMultiplier:.2,stabilityDampeningBonus:.25,newGameGracePeriod:150,inventoryTargetDaysMultiplier:.5,taxToleranceMultiplier:2,resourceConsumptionMultiplier:.9,buildingCostBaseMultiplier:1,techCostMultiplier:1,populationGrowthMultiplier:1.5,buildingUpgradeCostMultiplier:1,armyMaintenanceMultiplier:.5,maxConsumptionMultiplierBonus:-1,goodRelationChangeMultiplier:1.25,badRelationChangeMultiplier:.75,relationDailyDriftRate:.015,relationMonthlyDriftRateAlly:.04,relationMonthlyDriftRateNonAlly:.12,allyColdEventCooldown:120,allyColdEventChance:.002,initialBuildings:{farm:3,lumber_camp:3,quarry:2,loom_house:2,market:1}},[Mo.EASY]:{id:Mo.EASY,name:"简单",description:"适合新手，叛乱增长减半，敌人攻击概率降低",icon:"🌱",organizationGrowthMultiplier:.5,organizationDecayMultiplier:1.5,satisfactionThreshold:35,buildingCostGrowthFactor:1.1,aiWarDeclarationChance:.5,aiMilitaryActionChance:.5,aiMilitaryCooldownBonus:15,aiMinWarEpoch:3,raidDamageMultiplier:.6,raidPopulationLossMultiplier:.5,stabilityDampeningBonus:.15,newGameGracePeriod:100,inventoryTargetDaysMultiplier:.7,taxToleranceMultiplier:1.5,resourceConsumptionMultiplier:1,buildingCostBaseMultiplier:1.2,techCostMultiplier:1.2,populationGrowthMultiplier:1.2,buildingUpgradeCostMultiplier:1.2,armyMaintenanceMultiplier:.75,maxConsumptionMultiplierBonus:0,goodRelationChangeMultiplier:1.1,badRelationChangeMultiplier:.9,relationDailyDriftRate:.018,relationMonthlyDriftRateAlly:.045,relationMonthlyDriftRateNonAlly:.16,allyColdEventCooldown:90,allyColdEventChance:.003,initialBuildings:{farm:2,lumber_camp:2,quarry:1,loom_house:1}},[Mo.NORMAL]:{id:Mo.NORMAL,name:"普通",description:"标准游戏体验",icon:"⚖️",organizationGrowthMultiplier:1,organizationDecayMultiplier:1,satisfactionThreshold:45,buildingCostGrowthFactor:1.15,aiWarDeclarationChance:1,aiMilitaryActionChance:1,aiMilitaryCooldownBonus:0,aiMinWarEpoch:2,raidDamageMultiplier:1,raidPopulationLossMultiplier:1,stabilityDampeningBonus:0,newGameGracePeriod:0,inventoryTargetDaysMultiplier:1,taxToleranceMultiplier:1,resourceConsumptionMultiplier:1,buildingCostBaseMultiplier:1.5,techCostMultiplier:1.5,populationGrowthMultiplier:1,buildingUpgradeCostMultiplier:1.5,armyMaintenanceMultiplier:1,maxConsumptionMultiplierBonus:0,goodRelationChangeMultiplier:1,badRelationChangeMultiplier:1,relationDailyDriftRate:.02,relationMonthlyDriftRateAlly:.05,relationMonthlyDriftRateNonAlly:.2,allyColdEventCooldown:60,allyColdEventChance:.004,initialBuildings:{farm:1,lumber_camp:1,loom_house:1}},[Mo.HARD]:{id:Mo.HARD,name:"困难",description:"高难度挑战，叛乱更频繁，敌人更具侵略性",icon:"🔥",organizationGrowthMultiplier:1.5,organizationDecayMultiplier:.5,satisfactionThreshold:60,buildingCostGrowthFactor:1.25,aiWarDeclarationChance:2,aiMilitaryActionChance:1.5,aiMilitaryCooldownBonus:-5,aiMinWarEpoch:1,raidDamageMultiplier:1.5,raidPopulationLossMultiplier:1.5,stabilityDampeningBonus:-.1,newGameGracePeriod:0,inventoryTargetDaysMultiplier:3,taxToleranceMultiplier:.7,resourceConsumptionMultiplier:3,buildingCostBaseMultiplier:3,techCostMultiplier:3,startingSilverMultiplier:4,populationGrowthMultiplier:.8,buildingUpgradeCostMultiplier:3,armyMaintenanceMultiplier:1.5,maxConsumptionMultiplierBonus:2,goodRelationChangeMultiplier:.75,badRelationChangeMultiplier:1.25,relationDailyDriftRate:.03,relationMonthlyDriftRateAlly:.08,relationMonthlyDriftRateNonAlly:.35,allyColdEventCooldown:45,allyColdEventChance:.005,initialBuildings:{farm:1,lumber_camp:1}},[Mo.VERY_HARD]:{id:Mo.VERY_HARD,name:"灾厄",description:"极高难度，内忧外患接踵而至，生存即是胜利",icon:"☠️",organizationGrowthMultiplier:2,organizationDecayMultiplier:.2,satisfactionThreshold:75,buildingCostGrowthFactor:1.3,aiWarDeclarationChance:3.5,aiMilitaryActionChance:2.5,aiMilitaryCooldownBonus:-10,aiMinWarEpoch:0,raidDamageMultiplier:2.5,raidPopulationLossMultiplier:2.5,stabilityDampeningBonus:-.2,newGameGracePeriod:0,inventoryTargetDaysMultiplier:8,taxToleranceMultiplier:.4,resourceConsumptionMultiplier:5,buildingCostBaseMultiplier:5,techCostMultiplier:6,startingSilverMultiplier:6,populationGrowthMultiplier:.5,buildingUpgradeCostMultiplier:5,armyMaintenanceMultiplier:2,maxConsumptionMultiplierBonus:4,goodRelationChangeMultiplier:.6,badRelationChangeMultiplier:1.6,relationDailyDriftRate:.04,relationMonthlyDriftRateAlly:.1,relationMonthlyDriftRateNonAlly:.5,allyColdEventCooldown:60,allyColdEventChance:.004,initialBuildings:{farm:1}},[Mo.EXTREME]:{id:Mo.EXTREME,name:"地狱",description:"绝望的深渊，只有最完美的策略才能存活",icon:"👿",organizationGrowthMultiplier:3,organizationDecayMultiplier:.05,satisfactionThreshold:80,buildingCostGrowthFactor:1.4,aiWarDeclarationChance:5,aiMilitaryActionChance:5,aiMilitaryCooldownBonus:-20,aiMinWarEpoch:0,raidDamageMultiplier:5,raidPopulationLossMultiplier:5,stabilityDampeningBonus:-.5,newGameGracePeriod:0,inventoryTargetDaysMultiplier:20,taxToleranceMultiplier:.2,resourceConsumptionMultiplier:8,buildingCostBaseMultiplier:10,techCostMultiplier:10,startingSilverMultiplier:10,populationGrowthMultiplier:.2,buildingUpgradeCostMultiplier:10,armyMaintenanceMultiplier:3,maxConsumptionMultiplierBonus:8,goodRelationChangeMultiplier:.45,badRelationChangeMultiplier:2,relationDailyDriftRate:.05,relationMonthlyDriftRateAlly:.12,relationMonthlyDriftRateNonAlly:.7,allyColdEventCooldown:90,allyColdEventChance:.003,initialBuildings:{loom_house:1}}};function to(e){return _r[e]||_r[Ea]}function Tr(e,t){const o=to(t);return e*o.aiWarDeclarationChance}function r0(e,t){const o=to(t);return e*o.aiMilitaryActionChance}function s0(e){return to(e).aiMinWarEpoch}function c0(e){return to(e).aiMilitaryCooldownBonus}function Bi(e,t){const o=to(t);return Math.floor(e*o.raidDamageMultiplier)}function Pr(e,t){const o=to(t);return Math.floor(e*o.raidPopulationLossMultiplier)}function Ar(e,t){const o=to(t);return e<o.newGameGracePeriod}function Rr(e){return to(e).buildingCostGrowthFactor||1.15}function l0(e){return to(e).inventoryTargetDaysMultiplier||1}function Sr(e){var o,i;const t=to(e);return{good:(o=t.goodRelationChangeMultiplier)!=null?o:1,bad:(i=t.badRelationChangeMultiplier)!=null?i:1}}function u0(e){var o;return(o=to(e).relationDailyDriftRate)!=null?o:.02}function f0(e){var o;return(o=to(e).allyColdEventCooldown)!=null?o:60}function d0(e){var o;return(o=to(e).allyColdEventChance)!=null?o:.004}function p0(e){return to(e).populationGrowthMultiplier||1}function h0(e){return to(e).armyMaintenanceMultiplier||1}function Ir(e){return to(e).maxConsumptionMultiplierBonus||0}const m0=({popStructure:e,wealth:t,classIncome:o,classExpense:i,classShortages:r,epoch:a,techsUnlocked:s,priceMap:u={},livingStandardStreaks:l={}})=>{const f={},p={};return Object.keys(ae).forEach(d=>{var ye,z,Oe,Ze;const v=e[d]||0;if(v===0){f[d]=null,p[d]={streak:0,level:null,score:null};return}const h=ae[d],b=t[d]||0,M=(o==null?void 0:o[d])||0,g=(i==null?void 0:i[d])||0,C=h.startingWealth||100,x=(r[d]||[]).length,m=h.needs||{};let _=0;const A=["food","cloth"],k=je=>typeof u=="function"?u(je)||Ao(je):u[je]||Ao(je);A.forEach(je=>{if(m[je]&&Ii(je,a,s)){const Ct=m[je]*v,K=k(je),pe=Ao(je),he=Math.max(K,pe);_+=Ct*he}});const D=h.luxuryNeeds||{},P=Object.keys(D).map(Number).sort((je,Ct)=>je-Ct),T=h.wealthElasticity||1,R=v>0?M/v:0,V=v>0?_/v:0,N=V>0?R/V:R>0?10:0,F=v>0?b/v:0,B=C>0?F/C:0,O=h.maxConsumptionMultiplier||6;zi(N,B,T,O);const H=zi(N,B,T,10),le=h.needs?Object.keys(h.needs).filter(je=>Ii(je,a,s)).length:0;let se=0,$=le;for(const je of P)if(H>=je){se++;const Ct=D[je],pe=Object.keys(Ct).filter(he=>Ii(he,a,s)).filter(he=>{var It;return!((It=h.needs)!=null&&It[he])});$+=pe.length}const Y=(l==null?void 0:l[d])||{},ce=(ye=Y.score)!=null?ye:null,oe=ce===null;f[d]=Rc({count:v,income:M,expense:g,wealthValue:b,startingWealth:C,essentialCost:_,shortagesCount:x,effectiveNeedsCount:$,unlockedLuxuryTiers:se,totalLuxuryTiers:P.length,previousScore:ce,isNewStratum:oe,maxConsumptionMultiplier:O,wealthElasticity:T,greedy:h.greedy});const fe=Y.streak||0,Te=((z=f[d])==null?void 0:z.level)||null,xe=(Ze=(Oe=f[d])==null?void 0:Oe.score)!=null?Ze:null;let Ve=fe;Te==="赤贫"||Te==="贫困"?Ve=fe+1:Ve=Math.max(0,fe-1),p[d]={streak:Ve,level:Te,score:xe}}),{classLivingStandard:f,livingStandardStreaks:p}},g0={event:!1,gameLoop:!1,mainThread:!1,simulation:!1,trade:!1,demands:!1},kr=(e=[])=>{const t={};return e.forEach(o=>{const i=String(o||"").trim();i&&(t[i]=!0)}),t},Ca=e=>{if(e==null)return null;if(e===!0)return!0;if(e===!1)return null;if(typeof e=="string"){const t=e.trim();if(!t)return null;if(t==="true"||t==="all")return!0;try{const o=JSON.parse(t);return Ca(o)}catch(o){const i=t.split(",").map(r=>r.trim()).filter(Boolean);return i.length>0?kr(i):null}}return Array.isArray(e)?kr(e):typeof e=="object"?e:null};let Qi=null,Dr;const y0=()=>{const t=(typeof globalThis!="undefined"?globalThis:{}).__CIV_DEBUG__;if(t!==Dr&&(Dr=t,Qi=null),Qi)return Qi;let o=Ca(t);if(!o&&typeof localStorage!="undefined")try{o=Ca(localStorage.getItem("civ_debug_flags"))}catch(i){o=null}return Qi=o||g0,Qi},b0=e=>{const t=y0();return t===!0?!0:!!(t!=null&&t[e])},Ki=(e,...t)=>{b0(e)&&console.log(...t)},M0={trade_agreement:{name:"贸易协定",tariffMultiplier:.85,extraMerchantSlotsPercent:.2,tradeEfficiencyBonus:.08,relationDecayReduction:.1},open_market:{name:"开放市场",tariffMultiplier:.9,extraMerchantSlots:1/0,tradeEfficiencyBonus:0,allowForceTrade:!0,bypassRelationCap:!0},free_trade:{name:"自由贸易协定",tariffMultiplier:0,extraMerchantSlotsPercent:.5,relationDecayReduction:.3},investment_pact:{name:"投资协议",tariffMultiplier:.9,extraMerchantSlots:1,overseasBuildingAccess:!0,profitRepatriationRate:1},non_aggression:{name:"互不侵犯条约",tariffMultiplier:1,extraMerchantSlots:0,relationDecayReduction:.5},peace_treaty:{name:"和平条约",tariffMultiplier:1,extraMerchantSlots:0},academic_exchange:{name:"学术交流",tariffMultiplier:1,extraMerchantSlots:0,techBonus:.05},defensive_pact:{name:"共同防御",tariffMultiplier:.9,extraMerchantSlots:1,mutualDefense:!0},military_alliance:{name:"军事同盟",tariffMultiplier:.85,extraMerchantSlots:2,mutualDefense:!0,relationDecayReduction:.8},economic_bloc:{name:"经济共同体",tariffMultiplier:.6,extraMerchantSlots:5,tradeEfficiencyBonus:.4,priceConvergence:!0,overseasBuildingAccess:!0}},v0=(e,t)=>!(e!=null&&e.treaties)||!Array.isArray(e.treaties)?[]:e.treaties.filter(o=>o&&(!Number.isFinite(o.endDay)||t<o.endDay)),_a=(e,t)=>{const o=v0(e,t),i={tariffMultiplier:1,extraMerchantSlots:0,extraMerchantSlotsPercent:0,tradeEfficiencyBonus:0,hasOverseasAccess:!1,hasMutualDefense:!1,relationDecayReduction:0,techBonus:0,hasPriceConvergence:!1,allowForceTrade:!1,bypassRelationCap:!1,activeTreatyTypes:[]};if(o.length===0)return i;i.activeTreatyTypes=o.map(r=>r.type);for(const r of o){const a=M0[r.type];a&&(a.tariffMultiplier!==void 0&&(i.tariffMultiplier=Math.min(i.tariffMultiplier,a.tariffMultiplier)),a.extraMerchantSlots!==void 0&&(a.extraMerchantSlots===1/0?i.extraMerchantSlots=1/0:i.extraMerchantSlots!==1/0&&(i.extraMerchantSlots+=a.extraMerchantSlots)),a.extraMerchantSlotsPercent!==void 0&&(i.extraMerchantSlotsPercent+=a.extraMerchantSlotsPercent),a.tradeEfficiencyBonus!==void 0&&(i.tradeEfficiencyBonus=Math.max(i.tradeEfficiencyBonus,a.tradeEfficiencyBonus)),a.overseasBuildingAccess&&(i.hasOverseasAccess=!0),a.mutualDefense&&(i.hasMutualDefense=!0),a.priceConvergence&&(i.hasPriceConvergence=!0),a.allowForceTrade&&(i.allowForceTrade=!0),a.bypassRelationCap&&(i.bypassRelationCap=!0),a.relationDecayReduction!==void 0&&(i.relationDecayReduction=Math.max(i.relationDecayReduction,a.relationDecayReduction)),a.techBonus!==void 0&&(i.techBonus+=a.techBonus))}return i},Wr={DAILY_CONVERGENCE_RATE:.05,MIN_PRICE_DIFF_RATIO:.1};function w0(e,t,o=Wr.DAILY_CONVERGENCE_RATE){if(!e||!t)return{playerPrice:e,nationPrice:t,changed:!1};const i=(e+t)/2,r=i*Wr.MIN_PRICE_DIFF_RATIO;if(Math.abs(e-t)<=r)return{playerPrice:e,nationPrice:t,changed:!1};const s=e+(i-e)*o,u=t+(i-t)*o;return{playerPrice:Math.round(s*100)/100,nationPrice:Math.round(u*100)/100,changed:!0,convergenceAmount:Math.abs(s-e)}}function x0(e,t,o){const i={...e},r=[],a=[],s=t.filter(l=>!l||l.isPlayer?!1:_a(l,o).hasPriceConvergence);if(s.length===0)return{marketPrices:i,nationPriceUpdates:r,logs:a};const u=Object.keys(e);for(const l of s){const f=l.nationPrices||{},p={...f};let d=!1;for(const v of u){const h=i[v],b=f[v];if(!h||!b)continue;const M=w0(h,b);M.changed&&(i[v]=M.playerPrice,p[v]=M.nationPrice,d=!0)}d&&r.push({nationId:l.id,nationPrices:p})}if(r.length>0&&o%10===0){const l=s.slice(0,3).map(p=>p.name).join("、"),f=s.length>3?`等${s.length}国`:"";a.push(`📊 自由贸易效应：与${l}${f}的市场价格正在趋同。`)}return{marketPrices:i,nationPriceUpdates:r,logs:a}}const Ta=[{name:"封建地主专制",priority:1e3,description:"由大地主阶级独揽政权",icon:"Castle",color:"text-amber-500",conditions:{exactCoalition:["landowner"]},effects:{categories:{gather:.15},buildingProductionMod:{farm:.2,large_estate:.2},resourceDemandMod:{food:-.1}}},{name:"垄断资本独裁",priority:1e3,description:"资本家独占国家权力",icon:"Briefcase",color:"text-blue-400",conditions:{exactCoalition:["capitalist"]},effects:{industry:.2,buildingProductionMod:{factory:.25,steel_works:.2},taxIncome:.15}},{name:"军事贵族专政",priority:1e3,description:"骑士阶层掌控一切",icon:"Shield",color:"text-red-500",conditions:{exactCoalition:["knight"]},effects:{militaryBonus:.25,buildingProductionMod:{barracks:.2,training_ground:.2},stability:.05}},{name:"官僚集权",priority:1e3,description:"官僚阶层垄断政权",icon:"ScrollText",color:"text-purple-400",conditions:{exactCoalition:["official"]},effects:{production:.1,taxIncome:.12,cultureBonus:.08,officialCapacity:5}},{name:"商业寡头政治",priority:1e3,description:"商人阶层掌控国家",icon:"Coins",color:"text-yellow-400",conditions:{exactCoalition:["merchant"]},effects:{buildingProductionMod:{market:.25,trade_port:.2,trading_post:.15},taxIncome:.15}},{name:"神权政治",priority:1e3,description:"神职人员统治国家",icon:"Cross",color:"text-indigo-400",conditions:{exactCoalition:["cleric"]},effects:{cultureBonus:.25,stability:.1,scienceBonus:-.15}},{name:"军人专政",priority:1e3,description:"军队独揽大权",icon:"Swords",color:"text-red-400",conditions:{exactCoalition:["soldier"]},effects:{militaryBonus:.3,buildingProductionMod:{barracks:.25,fortress:.2},stability:-.05}},{name:"工人无产阶级专政",priority:1e3,description:"工人阶级独揽政权",icon:"Hammer",color:"text-red-600",conditions:{exactCoalition:["worker"]},effects:{industry:.18,stratumDemandMod:{worker:-.12},taxIncome:-.1}},{name:"农民专政",priority:1e3,description:"农民阶级掌控政权",icon:"Wheat",color:"text-green-500",conditions:{exactCoalition:["peasant"]},effects:{categories:{gather:.2},buildingProductionMod:{farm:.18},resourceDemandMod:{food:-.1}}},{name:"技术官僚政治",priority:1e3,description:"工程师主导国家",icon:"Cog",color:"text-cyan-400",conditions:{exactCoalition:["engineer"]},effects:{scienceBonus:.25,industry:.12,buildingProductionMod:{library:.2,university:.25},officialCapacity:4}},{name:"学者治国",priority:1e3,description:"知识分子掌权",icon:"Feather",color:"text-blue-300",conditions:{exactCoalition:["scribe"]},effects:{scienceBonus:.2,cultureBonus:.15,militaryBonus:-.1}},{name:"行会共和",priority:1e3,description:"工匠行会主政",icon:"Anvil",color:"text-orange-400",conditions:{exactCoalition:["artisan"]},effects:{buildingProductionMod:{loom_house:.25,furniture_workshop:.2,tailor_workshop:.15},industry:.15}},{name:"海上共和国",priority:1e3,description:"航海家主导政权",icon:"Compass",color:"text-teal-400",conditions:{exactCoalition:["navigator"]},effects:{buildingProductionMod:{dockyard:.3,trade_port:.25},taxIncome:.1}},{name:"矿业工人政权",priority:1e3,description:"矿工阶级执政",icon:"Pickaxe",color:"text-gray-400",conditions:{exactCoalition:["miner"]},effects:{buildingProductionMod:{mine:.3,quarry:.25},categories:{gather:.15}}},{name:"农奴起义政权",priority:1e3,description:"佃农阶级执政",icon:"Users",color:"text-brown-400",conditions:{exactCoalition:["serf"]},effects:{categories:{gather:.12},stratumDemandMod:{serf:-.1},stability:-.1}},{name:"林业工人政权",priority:1e3,description:"樵夫阶级执政",icon:"Trees",color:"text-green-600",conditions:{exactCoalition:["lumberjack"]},effects:{buildingProductionMod:{lumber_camp:.3},categories:{gather:.12}}},{name:"独裁政体",priority:999,description:"单一阶层执政",icon:"Crown",color:"text-amber-400",conditions:{maxSize:1},effects:{stability:-.05,taxIncome:.05,officialCapacity:2}},{name:"工农联合政府",priority:910,description:"工人和农民阶级联合执政",icon:"Handshake",color:"text-red-500",conditions:{includes:["worker","peasant"],minCategoryShare:{proletariat:.7},maxSize:2},effects:{categories:{gather:.12},industry:.1,stratumDemandMod:{peasant:-.08,worker:-.08}}},{name:"人民民主专政",priority:900,description:"以工农联盟为基础的人民政权",icon:"Users",color:"text-red-600",conditions:{includes:["worker","peasant"],minCategoryShare:{proletariat:.7}},effects:{categories:{gather:.1},industry:.12,stratumDemandMod:{peasant:-.15,worker:-.15},taxIncome:-.15}},{name:"资产阶级共和国",priority:900,description:"资产阶级主导的民主政体",icon:"Building2",color:"text-blue-400",conditions:{minCategoryShare:{bourgeoisie:.6},excludes:["landowner","knight"],includesAny:["worker","artisan"]},effects:{industry:.15,taxIncome:.12,buildingProductionMod:{market:.1},officialCapacity:3}},{name:"资本主义寡头政治",priority:890,description:"资产阶级独占政权",icon:"Briefcase",color:"text-blue-500",conditions:{minCategoryShare:{bourgeoisie:.6},excludes:["landowner","knight"]},effects:{industry:.18,taxIncome:.18,buildingProductionMod:{factory:.2}}},{name:"封建神权联盟",priority:900,description:"传统贵族与教会联合执政",icon:"Crown",color:"text-purple-500",conditions:{minCategoryShare:{aristocracy:.6},includes:["cleric"]},effects:{categories:{gather:.12},cultureBonus:.15,stability:.08,scienceBonus:-.1}},{name:"贵族寡头政治",priority:890,description:"传统贵族阶层联合执政",icon:"Castle",color:"text-amber-500",conditions:{minCategoryShare:{aristocracy:.6}},effects:{categories:{gather:.1},taxIncome:.12,stratumDemandMod:{landowner:.1}}},{name:"军事-精英联盟",priority:900,description:"军队与精英阶层联合执政",icon:"Shield",color:"text-red-500",conditions:{minCategoryShare:{military:.5},includesAny:["capitalist","landowner"]},effects:{militaryBonus:.2,buildingProductionMod:{barracks:.15},taxIncome:.08}},{name:"军人政府",priority:890,description:"军事力量主导的政权",icon:"Swords",color:"text-red-600",conditions:{minCategoryShare:{military:.5}},effects:{militaryBonus:.22,buildingProductionMod:{barracks:.2},stability:-.03}},{name:"全民联合政府",priority:850,description:"跨越阶级的广泛联盟",icon:"Globe",color:"text-green-400",conditions:{minSize:8,includesGroup:["upper","middle","lower"]},effects:{production:.08,stratumDemandMod:{peasant:-.05,worker:-.05},stability:.12,officialCapacity:4}},{name:"民族团结政府",priority:840,description:"各阶层联合执政",icon:"Users",color:"text-teal-400",conditions:{minSize:5,includesGroup:["upper","middle","lower"]},effects:{production:.05,stability:.1,maxPop:15}},{name:"人民阵线",priority:830,description:"以劳动阶层为主体的广泛联盟",icon:"Flag",color:"text-red-500",conditions:{minSize:5,minCategoryShare:{proletariat:.5}},effects:{categories:{gather:.1},industry:.1,stratumDemandMod:{peasant:-.1,worker:-.1}}},{name:"大联盟政府",priority:800,description:"多阶层联合执政",icon:"Users",color:"text-blue-400",conditions:{minSize:5},effects:{production:.05,stability:.05}},{name:"工业资本主义政府",priority:700,description:"工业资产阶级主导",icon:"Factory",color:"text-blue-500",conditions:{minCategoryShare:{industrial:.6},includes:["capitalist"]},effects:{industry:.2,buildingProductionMod:{factory:.18},taxIncome:.12,resourceDemandMod:{food:.1}}},{name:"劳工联合政府",priority:700,description:"工业劳动者联合执政",icon:"Hammer",color:"text-orange-500",conditions:{minCategoryShare:{industrial:.6},includes:["worker","artisan"]},effects:{industry:.15,buildingProductionMod:{loom_house:.12},stratumDemandMod:{worker:-.08,artisan:-.08}}},{name:"地主-农民联盟",priority:700,description:"农村阶层联合执政",icon:"Wheat",color:"text-green-500",conditions:{minCategoryShare:{agrarian:.6},includes:["landowner"],minCategoryShare2:{proletariat:.001}},conditions:{minCategoryShare:{agrarian:.6,proletariat:1e-4},includes:["landowner"]},effects:{categories:{gather:.18},buildingProductionMod:{farm:.15},resourceDemandMod:{food:-.08}}},{name:"农民政府",priority:690,description:"农民阶级主导政权",icon:"Wheat",color:"text-green-600",conditions:{minCategoryShare:{agrarian:.6,proletariat:.5}},effects:{categories:{gather:.18},buildingProductionMod:{farm:.18},resourceDemandMod:{food:-.1}}},{name:"商业共和国",priority:700,description:"商业阶层主导政权",icon:"Ship",color:"text-teal-400",conditions:{minCategoryShare:{commercial:.5}},effects:{buildingProductionMod:{market:.2,trade_port:.18},taxIncome:.12}},{name:"技术精英政府",priority:700,description:"知识分子联合执政",icon:"GraduationCap",color:"text-cyan-400",conditions:{includes:["scribe","engineer"]},effects:{scienceBonus:.18,industry:.1,buildingProductionMod:{library:.15,university:.15},officialCapacity:3}},{name:"无产阶级政府",priority:600,description:"劳动人民掌握政权",icon:"Hammer",color:"text-red-500",conditions:{minCategoryShare:{proletariat:.7}},effects:{categories:{gather:.12},industry:.12,stratumDemandMod:{peasant:-.1,worker:-.1},taxIncome:-.1}},{name:"精英联盟政府",priority:600,description:"上层阶级联合执政",icon:"Crown",color:"text-amber-400",conditions:{minTotalShare:[{categories:["bourgeoisie","aristocracy"],threshold:.7}]},effects:{taxIncome:.15,stratumDemandMod:{landowner:.08,capitalist:.08}}},{name:"双头政治",priority:100,description:"两个阶层联合执政",icon:"Scale",color:"text-gray-400",conditions:{exactSize:2},effects:{stability:.03}},{name:"三方联盟",priority:100,description:"三个阶层共同执政",icon:"Triangle",color:"text-gray-400",conditions:{exactSize:3},effects:{stability:.05}},{name:"联合政府",priority:0,description:"多阶层联合执政",icon:"Users",color:"text-gray-400",conditions:{},effects:{stability:.03}},{name:"无执政联盟",priority:-1,description:"尚未建立执政联盟，政府缺乏社会基础",icon:"HelpCircle",color:"text-gray-400",conditions:{maxSize:0},effects:{production:-.1,taxIncome:-.2,stability:-.15}}],E0=e=>Ta.find(t=>t.name===e),C0=e=>{const t=E0(e);return t?t.effects:null},en={HIGH:"high",MEDIUM:"medium",LOW:"low",ILLEGITIMATE:"illegitimate"},_0={赤贫:10,贫困:10,温饱:15,小康:15,富裕:10,奢华:0};function T0(e,t,o){if(!Array.isArray(e)||e.length===0||o<=0)return 0;let i=0;return e.forEach(r=>{i+=t[r]||0}),i/o}function P0(e,t={}){const{classApproval:o={},coalitionMembers:i=[],classInfluence:r={}}=t;let a=e*100;if(i.length>0&&Object.keys(o).length>0){let s=0,u=0;i.forEach(f=>{var v;const p=(v=o[f])!=null?v:50,d=r[f]||1;u+=p*d,s+=d});const l=s>0?u/s:50;if(l<50){const f=.5+l/100;a*=f}}return Math.min(100,Math.max(0,a))}function A0(e){return e>=80?en.HIGH:e>=60?en.MEDIUM:e>=40?en.LOW:en.ILLEGITIMATE}function Br(e){return .3+Math.min(100,Math.max(0,e))/100*.7}function R0(e){return A0(e)===en.ILLEGITIMATE?-15:0}function S0(e,t){return Array.isArray(t)&&t.includes(e)}function I0(e,t){return _0[e]||0}const k0={aristocracy:["landowner","knight","official"],bourgeoisie:["capitalist","merchant","engineer"],proletariat:["worker","miner","peasant","serf","lumberjack"],military:["soldier","knight"],clerical:["cleric"],intellectual:["scribe","engineer"],commercial:["merchant","navigator"],agrarian:["peasant","serf","landowner","lumberjack"],industrial:["worker","artisan","capitalist","engineer","miner"]},D0={upper:{name:"上流阶级",keys:["merchant","official","landowner","capitalist","knight","engineer"]},middle:{name:"中产阶级",keys:["artisan","soldier","cleric","scribe","navigator"]},lower:{name:"下层阶级",keys:["peasant","serf","lumberjack","worker","miner"]}};function W0(e,t,o){if(!Array.isArray(e)||e.length===0)return B0("无执政联盟")||{name:"无执政联盟",description:"尚未建立执政联盟，政府缺乏社会基础",icon:"HelpCircle",color:"text-gray-400"};let i=0;e.forEach(l=>{i+=t[l]||0});const r={},a=l=>{let f=0;return(k0[l]||[]).forEach(d=>{e.includes(d)&&(f+=t[d]||0)}),f},s=l=>{if(r[l]!==void 0)return r[l];if(i<=0)return 0;const f=a(l)/i;return r[l]=f,f},u=Ta.filter(l=>{const f=l.conditions;if(!f)return!0;const p=e.length;if(f.minSize!==void 0&&p<f.minSize||f.maxSize!==void 0&&p>f.maxSize||f.exactSize!==void 0&&p!==f.exactSize||f.exactCoalition&&(p!==f.exactCoalition.length||!f.exactCoalition.every(d=>e.includes(d)))||f.includes&&!f.includes.every(d=>e.includes(d))||f.excludes&&f.excludes.some(d=>e.includes(d))||f.includesAny&&!f.includesAny.some(d=>e.includes(d)))return!1;if(f.includesGroup)for(const d of f.includesGroup){const v=D0[d];if(v&&!v.keys.some(h=>e.includes(h)))return!1}if(f.minCategoryShare){for(const[d,v]of Object.entries(f.minCategoryShare))if(s(d)<v)return!1}if(f.minTotalShare)for(const d of f.minTotalShare){let v=0;if(d.categories.forEach(h=>v+=s(h)),v<d.threshold)return!1}return!0});return u.sort((l,f)=>(f.priority||0)-(l.priority||0)),u.length>0?u[0]:{name:"联合政府",description:"多阶层联合执政",icon:"Users",color:"text-gray-400"}}function B0(e){return Ta.find(t=>t.name===e)}const Or={priceUpdateFrequency:3,aiDecisionFrequency:5,tradeUpdateFrequency:3,diplomacyUpdateFrequency:5,buildingCacheValidation:10};function On(e,t,o=!1){if(o)return!0;const i=Or[`${t}Frequency`]||Or[t]||1;return e%i===0}class O0{constructor(){this.cache=new Map,this.lastTick=-1}getOrCompute(t,o,i){if(t!==this.lastTick&&(this.cache.clear(),this.lastTick=t),this.cache.has(o))return this.cache.get(o);const r=i();return this.cache.set(o,r),r}get(t,o){if(t!==this.lastTick){this.cache.clear(),this.lastTick=t;return}return this.cache.get(o)}set(t,o,i){t!==this.lastTick&&(this.cache.clear(),this.lastTick=t),this.cache.set(o,i)}clear(){this.cache.clear(),this.lastTick=-1}}const j0=new O0,N0=()=>({headTax:0,industryTax:0,businessTax:0,tariff:0,tariffSubsidy:0,subsidy:0,policyIncome:0,policyExpense:0,priceControlIncome:0,priceControlExpense:0}),jr=(e,t={})=>{let o=t[e];typeof o!="number"&&(o=1);const i=ba==null?void 0:ba.MAX_HEAD_TAX;return Math.max(-i,Math.min(i,o))},L0=(e={},t={},o={})=>{const a={};return Object.entries(ae).forEach(([s,u])=>{var b;let l=0,f=0;const p=u.needs||{};Object.entries(p).forEach(([M,g])=>{var m,_,A;if(!g||g<=0)return;const C=(A=(_=e==null?void 0:e[M])!=null?_:(m=De[M])==null?void 0:m.basePrice)!=null?A:Ao(M);if(!Number.isFinite(C)||C<=0)return;const x=Math.max(0,(o==null?void 0:o[M])||0);l+=g*C,f+=g*C*x});const d=Math.max(0,(b=u.headTaxBase)!=null?b:0),v=Math.max(0,jr(s,t)),h=4*(v/(v+4));f+=d*h,a[s]={needsCost:Number.isFinite(l)?l:0,taxCost:Number.isFinite(f)?f:0}}),a},jn=(e={},t={})=>{const o=Number.isFinite(t.livingCostWeight)?t.livingCostWeight:1,i=Number.isFinite(t.taxCostWeight)?t.taxCostWeight:1,r={};return Object.entries(e).forEach(([a,s])=>{const u=(s==null?void 0:s.needsCost)||0,l=(s==null?void 0:s.taxCost)||0;r[a]=Math.max(0,u*o+l*i)}),r},F0=(e={},t={})=>{let o=0,i=0;return Object.keys(e).forEach(r=>{const a=e[r]||0,s=t[r]||0;a>0&&s>0&&(o+=s*a,i+=a)}),i>0?o/i:Wn},Z={INCOME:{WAGE:"wage",OWNER_REVENUE:"ownerRevenue",SUBSIDY:"subsidy",CORRUPTION:"corruption",TRADE_IMPORT_REVENUE:"tradeImportRevenue"},EXPENSE:{HEAD_TAX:"headTax",BUSINESS_TAX:"businessTax",RESOURCE_TAX:"transactionTax",TARIFF:"tariffs",PRODUCTION_COST:"productionCosts",WAGES_PAID:"wages",ESSENTIAL_CONSUMPTION:"essentialNeeds",LUXURY_CONSUMPTION:"luxuryNeeds",DECAY:"decay",TRADE_EXPORT:"tradeExport",TRADE_EXPORT_PURCHASE:"tradeExportPurchase",CAPITAL_FLIGHT:"capitalFlight",BUILDING_COST:"buildingCost",LAYOFF_TRANSFER:"layoffTransfer"}};class U0{constructor(t,o){this.resources=t.resources,this.wealth=t.wealth,this.officials=t.officials,this.classFinancialData=t.classFinancialData,this.taxBreakdown=t.taxBreakdown,this.silverChangeLog=t.silverChangeLog,this.buildingFinancialData=t.buildingFinancialData,this.classWealthChangeLog=t.classWealthChangeLog||{},this.safeWealth=o.safeWealth}transfer(t,o,i,r,a,s={}){i<=0||(t!=="void"&&(this._deduct(t,i,a,s),this._recordExpense(t,i,a,s)),o!=="void"&&(this._add(o,i,a,s),this._recordIncome(o,i,a,s)),this._updateSystemStats(t,o,i,a,s))}_trackClassWealthChange(t,o,i){t==="state"||t==="void"||(this.classWealthChangeLog[t]||(this.classWealthChangeLog[t]=[]),this.classWealthChangeLog[t].push({amount:o,reason:i,balance:this.wealth[t]||0}))}_deduct(t,o,i,r={}){t==="state"?this.resources.silver=Math.max(0,(this.resources.silver||0)-o):t==="official_pool"||(this.wealth[t]=Math.max(0,(this.wealth[t]||0)-o),this._trackClassWealthChange(t,-o,i))}_add(t,o,i,r={}){t==="state"?this.resources.silver=(this.resources.silver||0)+o:(this.wealth[t]=this.safeWealth((this.wealth[t]||0)+o),this._trackClassWealthChange(t,o,i))}_recordExpense(t,o,i,r){if(t==="state"){this.silverChangeLog.push({amount:-o,reason:i,balance:this.resources.silver});return}if(this.classFinancialData[t]){const a=this.classFinancialData[t].expense;if(i===Z.EXPENSE.ESSENTIAL_CONSUMPTION||i===Z.EXPENSE.LUXURY_CONSUMPTION){a[i]||(a[i]={}),typeof a[i]!="object"&&(a[i]={});const s=r.resource||"unknown";a[i][s]||(a[i][s]={cost:0,quantity:0,price:0}),a[i][s].cost+=o,a[i][s].quantity+=r.quantity||0,a[i][s].price=r.price||0}else a[i]!==void 0&&(a[i]+=o)}}_recordIncome(t,o,i,r){if(t==="state"){this.silverChangeLog.push({amount:o,reason:i,balance:this.resources.silver});return}if(this.classFinancialData[t]){const a=this.classFinancialData[t].income;a[i]!==void 0&&(a[i]+=o)}}_updateSystemStats(t,o,i,r,a={}){if(o==="state"&&(r===Z.EXPENSE.HEAD_TAX&&(this.taxBreakdown.headTax+=i),r===Z.EXPENSE.BUSINESS_TAX&&(this.taxBreakdown.businessTax+=i),r===Z.EXPENSE.RESOURCE_TAX&&(this.taxBreakdown.industryTax+=i),r===Z.EXPENSE.TARIFF&&(this.taxBreakdown.tariff=(this.taxBreakdown.tariff||0)+i)),t==="state"&&r===Z.INCOME.SUBSIDY&&(this.taxBreakdown.subsidy+=i),a.buildingId&&this.buildingFinancialData&&this.buildingFinancialData[a.buildingId]){const s=this.buildingFinancialData[a.buildingId];r===Z.EXPENSE.BUSINESS_TAX&&(s.businessTaxPaid+=i),r===Z.INCOME.OWNER_REVENUE&&(s.ownerRevenue+=i)}}}const Nr={minProfitMargin:.1,maxPurchaseAmount:20,exportProbability:.5,maxInventoryRatio:.3,minWealthForTrade:10,tradeDuration:3,tradeCooldown:0,enableDebugLog:!1,enableMerchantAssignments:!0,idleTradeEfficiency:.15,maxPartnersPerTick:4,maxResourcesScoredPerPartner:10,shortageWeight:2.2,surplusWeight:1.3},Lr=e=>Math.max(0,Math.min(1,e)),ii=(e,t=0)=>Number.isFinite(e)?e:t,tn=(e=[],t=10)=>!Array.isArray(e)||e.length===0?[]:[...e].sort((i,r)=>((r==null?void 0:r.score)||0)-((i==null?void 0:i.score)||0)).slice(0,Math.max(0,t)),$0=e=>ii(e==null?void 0:e.relation,50),G0=({partner:e})=>(e==null?void 0:e.isAtWar)===!0,V0=({merchantAssignments:e,nations:t})=>{if(!e||typeof e!="object")return null;const o={};return Object.entries(e).forEach(([i,r])=>{const a=Math.max(0,Math.floor(Number(r)||0));a<=0||!(!Array.isArray(t)||t.some(u=>(u==null?void 0:u.id)===i))||(o[i]=a)}),Object.keys(o).length>0?o:null},q0=({nations:e,maxPartners:t})=>{const i=(Array.isArray(e)?e.filter(a=>a&&!a.isRebelNation):[]).map(a=>({nationId:a.id,relation:$0(a)})).sort((a,s)=>s.relation-a.relation).slice(0,Math.max(1,t)),r={};return i.forEach(a=>{r[a.nationId]=1}),r},Fr=({resourceKey:e,res:t,demand:o={},marketPrice:i=1})=>{const r=ii(t==null?void 0:t[e],0),a=Math.max(0,ii(o==null?void 0:o[e],0));if(a<=0)return 0;const l=(r<=0?0:r/a)/8,f=Lr(1-l),p=Math.min(1.5,Math.max(.7,ii(i,1)/3));return f*p},Ur=({resourceKey:e,res:t,supply:o={},marketPrice:i=1})=>{const r=ii(t==null?void 0:t[e],0),a=Math.max(0,ii(o==null?void 0:o[e],0));if(a<=0)return 0;const l=(r<=0?0:r/a)/12,f=Lr((l-1)/2),p=Math.min(1.6,Math.max(.6,2.2/Math.max(.5,ii(i,1))));return f*p},Nn=({resourceKey:e,partner:t,tick:o})=>{const i=vr(e,t,o);return Number.isFinite(i)&&i>0?i:null},$r=e=>{const t=Number(e);return Number.isFinite(t)?Math.max(.1,Math.min(5,t)):1},Gr=({resourceKey:e,partner:t,tick:o,getLocalPrice:i,res:r,demand:a,tradeConfig:s,merchantTradePreferences:u,getImportTaxRate:l})=>{var _,A;const f=i(e),p=Nn({resourceKey:e,partner:t,tick:o});if(f==null||p==null)return null;const d=l?l(e):0,v=p*(1+d),h=(f-v)/Math.max(.1,v);if(h<=-.1)return null;const b=Fr({resourceKey:e,res:r,demand:a,marketPrice:f}),M=ki(e,t,o),g=M!=null&&M.surplusAmount?Math.min(1,M.surplusAmount/Math.max(50,M.target||1)):0,C=s.shortageWeight*b+2*Math.max(0,h)+.6*g,x=$r((A=(_=u==null?void 0:u.import)==null?void 0:_[e])!=null?A:1),m=C*x;return{type:"import",resourceKey:e,localPrice:f,foreignPrice:p,score:m,partnerSurplus:g,shortage:b,prefMultiplier:x}},Vr=({resourceKey:e,partner:t,tick:o,getLocalPrice:i,res:r,supply:a,tradeConfig:s,merchantTradePreferences:u})=>{var x,m;const l=i(e),f=Nn({resourceKey:e,partner:t,tick:o});if(l==null||f==null)return null;const p=(f-l)/Math.max(1e-4,l);if(p<=0||ii(r==null?void 0:r[e],0)<=0)return null;const v=Ur({resourceKey:e,res:r,supply:a,marketPrice:l}),h=ki(e,t,o),b=h!=null&&h.shortageAmount?Math.min(1,h.shortageAmount/Math.max(50,h.target||1)):0,M=s.surplusWeight*v+1*p+.6*b,g=$r((m=(x=u==null?void 0:u.export)==null?void 0:x[e])!=null?m:1),C=M*g;return{type:"export",resourceKey:e,localPrice:l,foreignPrice:f,score:C,partnerShortage:b,surplus:v,prefMultiplier:g}},H0=({nations:e,res:t,supply:o,demand:i,market:r,tick:a,taxPolicies:s,tradeConfig:u=Nr,merchantTradePreferences:l=null})=>{const f={exports:[],imports:[]},p=C=>{var x;return(x=r==null?void 0:r.prices)==null?void 0:x[C]},d=(s==null?void 0:s.resourceTaxRates)||{},v=(s==null?void 0:s.importTariffMultipliers)||(s==null?void 0:s.resourceTariffMultipliers)||{},h=C=>{var _;const x=d[C]||0,m=(_=v[C])!=null?_:0;return x+m},b=Object.keys(De).filter(C=>Jt(C)),M=[],g=[];return(e||[]).forEach(C=>{!C||C.isAtWar||b.forEach(x=>{const m=Vr({resourceKey:x,partner:C,tick:a,getLocalPrice:p,res:t,supply:o,tradeConfig:u,merchantTradePreferences:l});m&&m.score>0&&M.push(m);const _=Gr({resourceKey:x,partner:C,tick:a,getLocalPrice:p,res:t,demand:i,tradeConfig:u,merchantTradePreferences:l,getImportTaxRate:h});_&&_.score>0&&g.push(_)})}),f.exports=tn(M,10),f.imports=tn(g,10),f},Y0=({ledger:e,res:t,wealth:o,popStructure:i,supply:r,demand:a,nations:s,tick:u,taxPolicies:l,taxBreakdown:f,getLocalPrice:p,roleExpense:d,roleWagePayout:v,pendingTrades:h=[],lastTradeTime:b=0,gameSpeed:M=1,classFinancialData:g,logs:C,potentialResources:x,merchantAssignments:m=null,merchantTradePreferences:_=null,shouldLogMerchantTrades:A=!0,onTreasuryChange:k=null})=>{var Ze,je,Ct;const D=(i==null?void 0:i.merchant)||0;if(D<=0)return{pendingTrades:h,lastTradeTime:b,lockedCapital:0,capitalInvestedThisTick:0,completedTrades:[]};let P=0;const T=[],R=(l==null?void 0:l.resourceTaxRates)||{},V=(l==null?void 0:l.importTariffMultipliers)||(l==null?void 0:l.resourceTariffMultipliers)||{},N=(l==null?void 0:l.exportTariffMultipliers)||(l==null?void 0:l.resourceTariffMultipliers)||{},F=K=>{var It;const pe=R[K]||0,he=(It=V[K])!=null?It:0;return pe+he},B=K=>{var It;const pe=R[K]||0,he=(It=N[K])!=null?It:0;return pe+he},O={...Nr,...((Ze=ae.merchant)==null?void 0:Ze.tradeConfig)||{}},H=[];if(h.forEach(K=>{if(K.daysRemaining-=1,K.daysRemaining<=0){if(e&&e.transfer("void","merchant",K.revenue,Z.INCOME.OWNER_REVENUE,Z.INCOME.OWNER_REVENUE),v.merchant=(v.merchant||0)+K.revenue,K.type==="import"){if(t[K.resource]=(t[K.resource]||0)+K.amount,r[K.resource]=(r[K.resource]||0)+K.amount,K.partnerId&&Array.isArray(s)){const pe=s.find(he=>(he==null?void 0:he.id)===K.partnerId);if(pe){pe.inventory||(pe.inventory={});const he=pe.inventory[K.resource]||0;pe.inventory[K.resource]=Math.max(0,he-K.amount)}}}else if(K.type==="export"&&K.partnerId&&Array.isArray(s)){const pe=s.find(he=>(he==null?void 0:he.id)===K.partnerId);if(pe){pe.inventory||(pe.inventory={});const he=pe.inventory[K.resource]||0;pe.inventory[K.resource]=Math.max(0,he+K.amount)}}T.push({type:K.type,resource:K.resource,amount:K.amount,revenue:K.revenue,profit:K.profit,partnerId:K.partnerId}),O.enableDebugLog&&Ki("trade","[Merchant Debug] ✅ Trade complete:",{type:K.type==="export"?"Export":"Import",partnerId:K.partnerId,resource:K.resource,amount:K.amount,revenue:K.revenue,profit:K.profit})}else H.push(K)}),!(u-b>=O.tradeCooldown))return{pendingTrades:H,lastTradeTime:b,lockedCapital:0,capitalInvestedThisTick:0,completedTrades:T};const $=Object.keys(De).filter(K=>Jt(K)).filter(K=>!x||x.has(K)),Y=V0({merchantAssignments:m,nations:s}),ce=O.enableMerchantAssignments&&!!Y,oe=ce?Y:q0({nations:s,maxPartners:O.maxPartnersPerTick}),fe=Object.entries(oe).map(([K,pe])=>({nationId:K,count:pe})).filter(K=>K.count>0).slice(0,Math.max(1,O.maxPartnersPerTick)),Te=ce?1:O.idleTradeEfficiency,xe=D>100?100:D,Ve=D>100?D/100:1,ye=fe.reduce((K,pe)=>K+pe.count,0)||1,z=fe.map(K=>{const pe=K.count/ye,he=Math.max(1,Math.round(xe*pe));return{...K,batches:he}});for(let K=0;K<z.length;K++){const pe=z[K],he=Array.isArray(s)?s.find(Ee=>(Ee==null?void 0:Ee.id)===pe.nationId):null;if(!he||G0({partner:he}))continue;const ie=_a(he,u).tariffMultiplier,ot=Ee=>{var kt;F(Ee);const pt=((kt=V[Ee])!=null?kt:0)*ie;return(R[Ee]||0)+pt},zt=Ee=>{var kt;B(Ee);const pt=((kt=N[Ee])!=null?kt:0)*ie;return(R[Ee]||0)+pt},$e=[],mt=[],_t=[];$.forEach(Ee=>{const Le=p(Ee);if(Le==null)return;const pt=Fr({resourceKey:Ee,res:t,demand:a,marketPrice:Le}),kt=Ur({resourceKey:Ee,res:t,supply:r,marketPrice:Le}),it=Nn({resourceKey:Ee,partner:he,tick:u});let oo=0,co=0;if(it!=null){const Vo=ot(Ee),So=it*(1+Vo);Le>So&&(oo=(Le-So)/Math.max(.1,So));const jo=zt(Ee),ht=Le*(1+jo);it>ht&&(co=(it-ht)/Math.max(.1,ht))}(pt>.01||oo>.05)&&mt.push({resourceKey:Ee,score:Math.max(pt,oo)}),(kt>.01||co>.05)&&_t.push({resourceKey:Ee,score:Math.max(kt,co)})});let Ut=tn(mt,O.maxResourcesScoredPerPartner),Oo=tn(_t,O.maxResourcesScoredPerPartner);if(Ut.length===0&&Oo.length===0){const Ee=Math.max(6,O.maxResourcesScoredPerPartner),Le=[];$.forEach(kt=>{const it=p(kt);if(it==null)return;const oo=Nn({resourceKey:kt,partner:he,tick:u});if(oo==null)return;const co=(it-oo)/Math.max(1e-4,it),Vo=(oo-it)/Math.max(1e-4,it),So=Math.max(co,Vo);So<=0||Le.push({resourceKey:kt,score:So})});const pt=tn(Le,Ee);Ut=pt,Oo=pt,O.enableDebugLog&&Ki("trade","[Merchant Debug] ⚠️ Trade 2.0 fallback prefilter active (no shortage/surplus signals).",{partnerId:he==null?void 0:he.id,fallbackCandidates:pt.length})}if(Ut.forEach(({resourceKey:Ee})=>{const Le=Gr({resourceKey:Ee,partner:he,tick:u,getLocalPrice:p,res:t,demand:a,tradeConfig:O,merchantTradePreferences:_,getImportTaxRate:F});Le&&$e.push(Le)}),Oo.forEach(({resourceKey:Ee})=>{const Le=Vr({resourceKey:Ee,partner:he,tick:u,getLocalPrice:p,res:t,supply:r,tradeConfig:O,merchantTradePreferences:_});Le&&$e.push(Le)}),$e.length===0)continue;$e.sort((Ee,Le)=>Le.score-Ee.score);const mi=Math.min(12,pe.batches);for(let Ee=0;Ee<mi;Ee++){const Le=o.merchant||0;if(Le<=O.minWealthForTrade)break;const pt=$e[Ee%$e.length];if(!pt)break;const kt=Le/(xe+1)*Te;if(pt.type==="export"){const it=X0({ledger:e,partner:he,partnerId:he.id,resourceKey:pt.resourceKey,wealthForThisBatch:kt,batchMultiplier:Ve,wealth:o,res:t,supply:r,taxBreakdown:f,tradeConfig:O,getLocalPrice:p,foreignUnitPrice:pt.foreignPrice,getResourceTaxRate:B,roleExpense:d,classFinancialData:g,taxPolicies:l,logs:C});if(it.success){P+=it.outlay,H.push(it.trade),b=u;const oo=((je=De[pt.resourceKey])==null?void 0:je.name)||pt.resourceKey,co=(he==null?void 0:he.name)||(he==null?void 0:he.id)||"未知国家";C&&A&&it.trade.amount>=.5&&C.push(`📦 商人发起贸易: 向${co}出口 ${oo} x${it.trade.amount.toFixed(1)}`)}}else{const it=z0({ledger:e,partner:he,partnerId:he.id,resourceKey:pt.resourceKey,wealthForThisBatch:kt,batchMultiplier:Ve,wealth:o,res:t,taxBreakdown:f,tradeConfig:O,getLocalPrice:p,foreignUnitPrice:pt.foreignPrice,getResourceTaxRate:F,roleExpense:d,classFinancialData:g,taxPolicies:l,logs:C});if(it.success){P+=it.cost,H.push(it.trade),b=u;const oo=((Ct=De[pt.resourceKey])==null?void 0:Ct.name)||pt.resourceKey,co=(he==null?void 0:he.name)||(he==null?void 0:he.id)||"未知国家";C&&A&&it.trade.amount>=.5&&C.push(`📦 商人发起贸易: 从${co}进口 ${oo} x${it.trade.amount.toFixed(1)}`)}}}}const Oe=H.reduce((K,pe)=>K+Math.max(0,(pe==null?void 0:pe.capitalLocked)||0),0);return{pendingTrades:H,lastTradeTime:b,lockedCapital:Oe,capitalInvestedThisTick:P,completedTrades:T}},X0=({ledger:e,partner:t,partnerId:o,resourceKey:i,wealthForThisBatch:r,batchMultiplier:a,wealth:s,res:u,supply:l,taxBreakdown:f,tradeConfig:p,getLocalPrice:d,foreignUnitPrice:v,getResourceTaxRate:h,classFinancialData:b,taxPolicies:M,roleExpense:g,logs:C})=>{var ye,z,Oe,Ze,je,Ct,K;const x=d(i),m=v;if(m===null||x===null||m<=x)return{success:!1};const _=h(i),A=x*(1+_),k=A>0?r/A:0,P=(u[i]||0)/a*p.maxInventoryRatio,T=ki(i,t,0),R=Math.max(20,((T==null?void 0:T.shortageAmount)||0)+((T==null?void 0:T.target)||0)*.08),V=Math.min(p.maxPurchaseAmount,k,P,R);if(V<=.1)return{success:!1};const N=x*V,F=N*_,B=m*V;let O=N;if(F<0){const pe=Math.abs(F);(u.silver||0)>=pe*a?O-=pe:C.push(`Treasury empty, cannot pay export subsidy for ${((ye=De[i])==null?void 0:ye.name)||i}!`)}else O+=F;const H=((z=M==null?void 0:M.resourceTaxRates)==null?void 0:z[i])||0,le=(Ct=(je=(Oe=M==null?void 0:M.exportTariffMultipliers)==null?void 0:Oe[i])!=null?je:(Ze=M==null?void 0:M.resourceTariffMultipliers)==null?void 0:Ze[i])!=null?Ct:0,se=N*le;let $=0;if(se>0)O+=se,$=se;else if(se<0){const pe=Math.abs(se)*a;(u.silver||0)>=pe?(O-=Math.abs(se),$=se):C.push(`Treasury empty, cannot pay export tariff subsidy for ${((K=De[i])==null?void 0:K.name)||i}!`)}const Y=B-O;if((O>0?Y/O:Y>0?1/0:-1/0)<p.minProfitMargin)return{success:!1};const oe=V*a,fe=O*a;if((s.merchant||0)<fe)return{success:!1};if((u[i]||0)<oe)return{success:!1};const Te=N*a;e&&e.transfer("merchant","void",Te,Z.EXPENSE.TRADE_EXPORT,Z.EXPENSE.TRADE_EXPORT),g.merchant=(g.merchant||0)+Te;const xe=N*H*a;if(xe>0)e&&e.transfer("merchant","state",xe,Z.EXPENSE.RESOURCE_TAX,Z.EXPENSE.RESOURCE_TAX),g.merchant=(g.merchant||0)+xe;else if(xe<0){const pe=Math.abs(xe);(u.silver||0)>=pe&&e&&e.transfer("state","merchant",pe,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY)}const Ve=$*a;if(Ve>0)e&&e.transfer("merchant","state",Ve,Z.EXPENSE.TARIFF,Z.EXPENSE.TARIFF),g.merchant=(g.merchant||0)+Ve;else if(Ve<0){const pe=Math.abs(Ve);(u.silver||0)>=pe&&(e&&e.transfer("state","merchant",pe,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),f.tariffSubsidy=(f.tariffSubsidy||0)+pe)}return u[i]=Math.max(0,(u[i]||0)-oe),l[i]=Math.max(0,(l[i]||0)-oe),{success:!0,outlay:fe,trade:{type:"export",partnerId:o,resource:i,amount:oe,revenue:B*a,profit:Y*a,daysRemaining:p.tradeDuration,capitalLocked:fe}}},z0=({ledger:e,partner:t,partnerId:o,resourceKey:i,wealthForThisBatch:r,batchMultiplier:a,wealth:s,res:u,taxBreakdown:l,tradeConfig:f,getLocalPrice:p,foreignUnitPrice:d,getResourceTaxRate:v,roleExpense:h,classFinancialData:b,taxPolicies:M,logs:g})=>{var ce,oe,fe,Te,xe,Ve;const C=p(i),x=d;if(x===null||C===null||x>=C)return{success:!1};const m=ki(i,t,0),_=Math.max(10,((m==null?void 0:m.surplusAmount)||0)+((m==null?void 0:m.target)||0)*.05);(ce=M==null?void 0:M.resourceTaxRates)!=null&&ce[i];const A=(xe=(Te=(oe=M==null?void 0:M.importTariffMultipliers)==null?void 0:oe[i])!=null?Te:(fe=M==null?void 0:M.resourceTariffMultipliers)==null?void 0:fe[i])!=null?xe:0,k=x,D=k>0?r/(k*(1+Math.max(0,A))):0,P=Math.min(f.maxPurchaseAmount,D,_);if(P<=.1)return{success:!1};const T=x*P,R=T*A,V=T+R,N=C*P,F=N-V;if((V>0?F/V:F>0?1/0:-1/0)<f.minProfitMargin)return{success:!1};const O=P*a,H=T*a,le=R*a,se=V*a;if((s.merchant||0)<se)return{success:!1};const $=H;e&&e.transfer("merchant","void",$,Z.EXPENSE.TRADE_IMPORT,Z.EXPENSE.TRADE_IMPORT),h.merchant=(h.merchant||0)+$;const Y=le;if(Y>0)e&&e.transfer("merchant","state",Y,Z.EXPENSE.TARIFF,Z.EXPENSE.TARIFF),h.merchant=(h.merchant||0)+Y;else if(Y<0){const ye=Math.abs(Y);(u.silver||0)>=ye?(e&&e.transfer("state","merchant",ye,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),l.tariffSubsidy=(l.tariffSubsidy||0)+ye,h.merchant=(h.merchant||0)-ye):g.push(`Treasury empty, cannot pay import subsidy for ${((Ve=De[i])==null?void 0:Ve.name)||i}!`)}return{success:!0,cost:se,trade:{type:"import",partnerId:o,resource:i,amount:O,revenue:N*a,profit:F*a,daysRemaining:f.tradeDuration,capitalLocked:se}}},Pa=(e,t,o,i,r)=>{i<=0||e&&(e[t]||(e[t]=[]),e[o]||(e[o]=[]),e[t].push({amount:-i,reason:`${r}_out`}),e[o].push({amount:i,reason:`${r}_in`}))},J0=(e,t,o,i,r)=>{i!==0&&(e[o]=Math.max(0,(e[o]||0)+i),t&&(t[o]||(t[o]=[]),t[o].push({amount:i,reason:r})))},Z0=({popStructure:e,jobsAvailable:t,wealth:o,getExpectedWage:i,getHeadTaxRate:r,effectiveTaxModifier:a,wealthChangeLog:s=null})=>{const u=d=>{var M,g;const v=i(d),b=((g=(M=ae[d])==null?void 0:M.headTaxBase)!=null?g:.01)*r(d)*a;return v-Math.max(0,b)},l=d=>{var g,C,x,m;const v=(g=Po[d])!=null?g:0,h=zc[d],b=Number.isFinite(h)?h:(C=Xc[v])!=null?C:0;return((m=(x=ae[d])==null?void 0:x.startingWealth)!=null?m:100)*b},f=(d,v)=>{var M,g;const h=(M=Po[d])!=null?M:0,b=(g=Po[v])!=null?g:0;return b<=2||h<=b};return Ht.map((d,v)=>{var g;const h=Math.max(0,t[d]||0),b=e[d]||0,M=Math.max(0,h-b);return M<=0||d==="official"?null:{role:d,vacancy:M,netIncome:u(d),priorityIndex:v,tier:(g=Po[d])!=null?g:0,wealthRequired:l(d)}}).filter(Boolean).sort((d,v)=>v.netIncome!==d.netIncome?v.netIncome-d.netIncome:d.priorityIndex-v.priorityIndex).forEach(d=>{var b;const v=Math.max(1,Math.floor(d.vacancy*Dc));let h=Math.min(d.vacancy,v);if(d.tier<=1){const M=e.unemployed||0;if(M<=0||h<=0)return;const g=Math.min(h,M);if(g<=0)return;const C=o.unemployed||0,x=M>0?C/M:0;if(e[d.role]=(e[d.role]||0)+g,e.unemployed=Math.max(0,M-g),x>0){const m=x*g;o.unemployed=Math.max(0,C-m),o[d.role]=Ji((o[d.role]||0)+m),Pa(s,"unemployed",d.role,m,"job_hire_tier01")}}else{const M=Object.keys(Po).filter(g=>{var _;if(!f(g,d.role)||g===d.role||g==="soldier"||g==="official")return!1;const C=e[g]||0;if(C<=0)return!1;const x=(_=Po[g])!=null?_:0,m=d.tier;if(x===m&&g!=="unemployed"){const A=t[g]||0;if(C<=A)return!1}return!0}).sort((g,C)=>{var _,A;const x=(_=Po[g])!=null?_:0,m=(A=Po[C])!=null?A:0;return g==="unemployed"?-1:C==="unemployed"?1:m-x});for(const g of M){if(h<=0)break;const C=e[g]||0;if(C<=0)continue;const x=o[g]||0,m=C>0?x/C:0,_=(b=Po[g])!=null?b:0;let A=!1,k=0,D=0;if(_<d.tier&&m<d.wealthRequired){const T=C*Wc,R=Math.floor(T)+(Math.random()<T%1?1:0);if(R>0)D=R,A=!0,k=d.wealthRequired-m;else continue}else _===d.tier||d.wealthRequired<=0?D=C:D=m>=d.wealthRequired?C:0;const P=Math.min(h,D);if(!(P<=0)){if(e[d.role]=(e[d.role]||0)+P,e[g]=Math.max(0,C-P),m>0||A){const T=m*P;o[g]=Math.max(0,x-T);const R=A?k*P:0;o[d.role]=Ji((o[d.role]||0)+T+R);const V=A?"job_hire_lucky_promotion":"job_hire_tier23";Pa(s,g,d.role,T,V),R>0&&J0(o,s,d.role,R,"job_hire_lucky_bonus")}h-=P}}}}),{popStructure:e,wealth:o}},Q0=({popStructure:e,wealth:t,roleMetrics:o,hasBuildingVacancyForRole:i,reserveBuildingVacancyForRole:r,logs:a,migrationCooldowns:s={},supplyDemandRatio:u={},roleProducesResource:l={},wealthChangeLog:f=null})=>{var H,le,se;const p={};Object.entries(s).forEach(([$,Y])=>{Y>1&&(p[$]=Y-1)});const d=o.filter($=>$.role!=="soldier"&&$.role!=="official");if(d.length===0)return{popStructure:e,wealth:t,migrationCooldowns:p};const v=d.reduce(($,Y)=>$+Y.potentialIncome*Y.pop,0),h=d.reduce(($,Y)=>$+Y.pop,0),b=h>0?v/h:0,M=xr.filter($=>{const Y=u[$];return Y!==void 0&&Y<Lc}),g=new Set;M.length>0&&Object.entries(l).forEach(([$,Y])=>{Y&&Array.isArray(Y)&&Y.some(oe=>M.includes(oe))&&g.add($)}),M.length>0&&g.size>0;const C=.8,x=xr.filter($=>{const Y=u[$];return Y!==void 0&&Y<C}),m=new Set;x.length>0&&Object.entries(l).forEach(([$,Y])=>{Y&&Array.isArray(Y)&&Y.some(oe=>x.includes(oe))&&m.add($)});const _=d.filter($=>i($.role)).reduce(($,Y)=>Math.max($,Y.potentialIncome),0),A=d.filter($=>{if($.pop<=0||$.role==="soldier"||p[$.role]&&p[$.role]>0)return!1;const Y=$.perCap*.05,ce=-Math.max(.5,Math.min(50,Y));return $.potentialIncome<b*.7||$.perCapDelta<ce||_>0&&$.potentialIncome<_*.6}).reduce(($,Y)=>!$||Y.potentialIncome<$.potentialIncome||Y.potentialIncome===$.potentialIncome&&Y.perCapDelta<$.perCapDelta?Y:$,null);if(!A)return{popStructure:e,wealth:t,migrationCooldowns:p};const k=(H=Po[A.role])!=null?H:0,D=(se=(le=ae[A.role])==null?void 0:le.startingWealth)!=null?se:100,P=t[A.role]||0,T=A.pop>0?P/A.pop:0,R=T>=D*Jc,V=$=>{var oe;const ce=((oe=Po[$])!=null?oe:0)-k;if(ce>0)return Nc;if(ce===0)return Bc;{const fe=Math.abs(ce);return Oc*Math.pow(jc,fe-1)}},N=($,Y)=>{var Te;const oe=((Te=Po[$])!=null?Te:0)-k;let fe=Y;if(R&&oe>0){const xe=fe*Zc*oe;fe+=xe}return fe},F=d.filter($=>{if($.role===A.role||$.vacancy<=0)return!1;const ce=1.3*V($.role);if($.role==="soldier")return $.potentialIncome>A.potentialIncome*ce;const oe=N($.role,$.potentialIncome);return i($.role)&&oe>A.potentialIncome*ce}).reduce(($,Y)=>{if(!$)return Y;const ce=N(Y.role,Y.potentialIncome),oe=N($.role,$.potentialIncome);return ce>oe?Y:$},null);if(!F)return{popStructure:e,wealth:t,migrationCooldowns:p};const B=A.pop<Bn?kc:Ic;let O=Math.floor(A.pop*B);if(O<=0&&A.pop>0&&(O=1),O=Math.min(O,F.vacancy),O>0){if(F.role!=="soldier"){const $=r(F.role,O);!$||$.count<=0?O=0:O=$.count}if(O>0){const $=T*O;$>0&&(t[A.role]=Math.max(0,P-$),t[F.role]=Ji((t[F.role]||0)+$),Pa(f,A.role,F.role,$,"job_migration")),e[A.role]=Math.max(0,A.pop-O),e[F.role]=(e[F.role]||0)+O,p[A.role]=wr,p[F.role]=wr}}return{popStructure:e,wealth:t,migrationCooldowns:p}},K0=(e={})=>{const t={...e};return Object.keys(ae).forEach(o=>{var i;t[o]===void 0&&(t[o]=((i=ae[o])==null?void 0:i.startingWealth)||0)}),t},el=(e=[])=>{const t={};return Array.isArray(e)&&e.forEach(o=>{var i;o.active&&((i=o.modifiers)!=null&&i.approval)&&Object.entries(o.modifiers.approval).forEach(([r,a])=>{t[r]=(t[r]||0)+a})}),t},tl=({popStructure:e,classApproval:t,classInfluence:o,totalInfluence:i,newActiveBuffs:r,newActiveDebuffs:a,eventStabilityModifier:s=0,extraStabilityPenalty:u=0,currentStability:l=50,stabilityBonus:f=0})=>{let p=0,d=0;Object.keys(ae).forEach(x=>{if((e[x]||0)===0)return;const _=t[x]||50,A=o[x]||0,k=i>0?A/i:0;p+=_*k,d+=k});let v=d>0?p:50;s&&(v+=s);let h=0;r.forEach(x=>{x.stability&&(h+=x.stability)}),a.forEach(x=>{x.stability&&(h+=x.stability)}),f&&(h+=v*f),h-=u;const b=Math.max(0,Math.min(100,v+h)),M=Math.max(0,Math.min(100,l+(b-l)*Hc)),g=Math.min(1.5,Math.max(.5,1+(M-50)/100));return{stabilityValue:M,targetStability:b,efficiency:g,stabilityFactor:g}},ol=({popStructure:e,classWealthResult:t})=>{const o={},i=Object.values(t).reduce((a,s)=>a+s,0);Object.keys(ae).forEach(a=>{const s=e[a]||0;if(s===0)return;const u=ae[a],l=t[a]||0,f=i>0?l/i:0;o[a]=u.influenceBase*s+f*10});const r=Object.values(o).reduce((a,s)=>a+s,0);return{classInfluence:o,totalInfluence:r,totalWealth:i}},il=tr.reduce((e,t)=>(e[t.id]=t,e),{}),nl=()=>({buildingBonuses:{},categoryBonuses:{gather:0,industry:0,civic:0,military:0},passiveGains:{},passivePercentGains:{},perPopPassiveGains:{},incomePercentBonus:0,decreeResourceDemandMod:{},decreeStratumDemandMod:{},decreeResourceSupplyMod:{},decreeSilverIncome:0,decreeSilverExpense:0,extraMaxPop:0,maxPopPercent:0,productionBonus:0,industryBonus:0,taxBonus:0,needsReduction:0,stabilityBonus:0,scienceBonus:0,cultureBonus:0,militaryBonus:0}),Ho=(e,t)=>{if(!e)return;const{buildingBonuses:o,categoryBonuses:i,passiveGains:r,decreeResourceDemandMod:a,decreeStratumDemandMod:s,decreeResourceSupplyMod:u}=t;if(e.buildings&&Object.entries(e.buildings).forEach(([l,f])=>{!l||typeof f!="number"||Number.isFinite(f)&&(o[l]=(o[l]||0)+f)}),e.buildingProductionMod&&Object.entries(e.buildingProductionMod).forEach(([l,f])=>{if(!l||typeof f!="number"||!Number.isFinite(f))return;["gather","industry","civic","military","all"].includes(l)?i[l]=(i[l]||0)+f:o[l]=(o[l]||0)+f}),e.categories&&Object.entries(e.categories).forEach(([l,f])=>{!l||typeof f!="number"||Number.isFinite(f)&&(i[l]=(i[l]||0)+f)}),e.passive&&Object.entries(e.passive).forEach(([l,f])=>{!l||typeof f!="number"||(r[l]=(r[l]||0)+f)}),e.passivePercent&&Object.entries(e.passivePercent).forEach(([l,f])=>{!l||typeof f!="number"||(t.passivePercentGains[l]=(t.passivePercentGains[l]||0)+f)}),e.maxPop){const l=e.maxPop;l>-1&&l<1&&l!==0?t.maxPopPercent+=l:t.extraMaxPop+=l}e.production&&(t.productionBonus+=e.production),e.industry&&(t.industryBonus+=e.industry),e.taxIncome&&(t.taxBonus+=e.taxIncome),e.needsReduction&&(t.needsReduction+=e.needsReduction),e.stability&&(t.stabilityBonus+=e.stability),e.scienceBonus&&(t.scienceBonus+=e.scienceBonus),e.cultureBonus&&(t.cultureBonus+=e.cultureBonus),e.militaryBonus&&(t.militaryBonus+=e.militaryBonus),e.gatherBonus&&(i.gather=(i.gather||0)+e.gatherBonus),e.industryBonus&&(t.industryBonus+=e.industryBonus),e.knowledgeBonus&&(t.scienceBonus+=e.knowledgeBonus),e.resourceDemandMod&&Object.entries(e.resourceDemandMod).forEach(([l,f])=>{typeof f=="number"&&(a[l]=(a[l]||0)+f)}),e.stratumDemandMod&&Object.entries(e.stratumDemandMod).forEach(([l,f])=>{typeof f=="number"&&(s[l]=(s[l]||0)+f)}),e.resourceSupplyMod&&Object.entries(e.resourceSupplyMod).forEach(([l,f])=>{typeof f=="number"&&(u[l]=(u[l]||0)+f)}),e.perPopPassive&&Object.entries(e.perPopPassive).forEach(([l,f])=>{!l||typeof f!="number"||(t.perPopPassiveGains[l]=(t.perPopPassiveGains[l]||0)+f)}),typeof e.incomePercent=="number"&&(t.incomePercentBonus+=e.incomePercent)},al=(e,t)=>{Array.isArray(e)&&e.forEach(o=>{const i=il[o];!i||!i.effects||Ho(i.effects,t)})},rl=(e,t)=>{Array.isArray(e)&&e.forEach(o=>{var r,a;if(!o||!o.active||!o.modifiers)return;const i=((a=(r=o.modifiers)==null?void 0:r.passive)==null?void 0:a.silver)||0;i>0?t.decreeSilverIncome+=i:i<0&&(t.decreeSilverExpense+=Math.abs(i)),Ho(o.modifiers,t)})},sl=(e,t)=>{Array.isArray(e)&&e.forEach(o=>{!o||!o.effects||Ho(o.effects,t)})},cl=(e,t)=>{e&&Ho(e,t)},ll=(e,t,o=1.15,i=1)=>{const r={},u=1+Math.max(0,o-1)*Math.pow(t,.9);for(const[l,f]of Object.entries(e||{}))r[l]=Math.ceil(f*i*u);return r},ul=(e,t,o={})=>{let i=0;for(const[r,a]of Object.entries(o)){const s=parseInt(r);Number.isFinite(s)&&s>=e&&a>0&&(i+=a)}return i},qr=90,Hr=60,fl=500,dl=.4,Aa={satisfied:{effectMult:1,corruption:0,description:null},uncomfortable:{effectMult:.9,corruption:.01,description:"生活拮据"},struggling:{effectMult:.7,corruption:.03,description:"入不敷出"},desperate:{effectMult:.3,corruption:.1,description:"濒临破产"}},pl={landowner:{cats:["gather"],risk:.4},merchant:{cats:["civic","industry"],risk:.7},capitalist:{cats:["industry","gather"],risk:.8},scribe:{cats:["civic"],risk:.3},cleric:{cats:["civic"],risk:.3},peasant:{cats:["gather"],risk:.4},worker:{cats:["industry"],risk:.5},artisan:{cats:["industry"],risk:.5},engineer:{cats:["industry"],risk:.6},navigator:{cats:["civic","gather"],risk:.6}},hl=(e,t)=>{var o,i;return!t||t==="silver"?1:(i=(o=e==null?void 0:e.prices)==null?void 0:o[t])!=null?i:1},ml=(e,t,o)=>{var s;const i=pl[e]||{cats:["gather"],risk:.5},r=(s=yr[t])==null?void 0:s.spectrum;let a=[...i.cats];return r==="left"?(a=a.filter(u=>u!=="industry"),a.includes("gather")||a.push("gather")):r==="right"&&(a.includes("industry")||a.push("industry")),{preferredCategories:a,riskTolerance:i.risk*(.8+Math.random()*.4),investmentThreshold:.2+Math.random()*.3,lastInvestmentDay:o-Math.floor(qr/2),lastUpgradeDay:o-Math.floor(Hr/2)}},gl=(e,t,o=null)=>{const i=Math.max(1,t||0),r=e.wealth||0,a={desperate:i*10,struggling:i*30,uncomfortable:i*60,wealthy:i*120},u=(Number.isFinite(o)?o:e.salary||0)/i;return r<a.desperate?"desperate":r>=a.wealthy?"satisfied":u<.8&&r<a.struggling?"struggling":r<a.uncomfortable?"uncomfortable":"satisfied"},Yr=(e,t)=>Object.entries(e||{}).reduce((o,[i,r])=>i==="silver"?o+r:o+hl(t,i)*r,0),yl=(e,t={},o={})=>{const i=Vt.find(l=>l.id===e);if(!(i!=null&&i.jobs))return 1;let r=0,a=0;const s=(o==null?void 0:o[e])||0,u=Math.max(1,s);return Object.entries(i.jobs).forEach(([l,f])=>{const p=u*f,d=t[l]||0;r+=p,a+=p*Math.min(1,d)}),r>0?a/r:1},bl=(e,t,o,i,r,a)=>{const s=Vt.find(h=>h.id===e.buildingId);if(!s)return 0;const u=e.level||0,l=Ot(s,u),f={...s,...l,id:s.id,owner:l.owner||s.owner},p=Zi(f,t,o).profit,d=i==null?void 0:i[e.buildingId],v=Number.isFinite(d)?d:yl(e.buildingId,a,r);return p*v},Ml=(e,t,o,i,r)=>{const a=Ot(e,t),s=Ot(e,o),u=Zi({...e,...a},i,r).profit;return Zi({...e,...s},i,r).profit-u},Xr={marxism:0,primitive_communism:.05,peasant_revolt:.1,utopian_socialism:.2,social_democracy:.4,legalism:.6,conservatism:.7,absolutism:.7,aristocratic_oligarchy:.8,feudalism:.8,mercantilism:.9,classical_liberalism:1},vl=(e,t,o,i,r,a,s,u=0,l=[])=>{var A;if(!(e!=null&&e.investmentProfile))return null;const f=e.politicalStance,p=Xr[f]!==void 0?Xr[f]:.5;if(p<=0||Math.random()>p)return null;const d=e.investmentProfile;if(t-d.lastInvestmentDay<qr||e.wealth<fl)return null;const v=((A=r==null?void 0:r.dominance)==null?void 0:A.faction)==="left"?.5:1,h=Math.max(1,(e.wealth||0)/400),b=Math.min(2.2,1+Math.log10(h)*.6),M=d.riskTolerance*v*b;if(Math.random()>M)return null;const g=e.wealth*dl*d.riskTolerance*b;if(g<=0)return null;const C=Rr(s),x=Vt.filter(k=>{var R;return!(!k.owner||!k.baseCost||!(((R=k.epoch)!=null?R:0)<=u)||!(!k.requiresTech||l.includes(k.requiresTech))||((a==null?void 0:a[k.id])||0)<=0)}).map(k=>{const D=(a==null?void 0:a[k.id])||0,P=ll(k.baseCost,D,C),T=Yr(P,o),R=Zi(k,o,i).profit,V=d.preferredCategories.includes(k.cat)?2:1;return{building:k,cost:T,profit:R,weight:Math.max(.01,R*V)}}).filter(k=>k.cost<=g&&k.profit>0).sort((k,D)=>D.weight-k.weight);if(x.length===0)return null;const m=x.reduce((k,D)=>k+D.weight,0);let _=Math.random()*m;for(const k of x)if(_-=k.weight,_<=0)return{buildingId:k.building.id,cost:k.cost,profit:k.profit};return null},wl=(e,t,o,i,r,a,s,u)=>{var v,h,b,M;if(!((v=e.ownedProperties)!=null&&v.length))return null;const l=((h=e.investmentProfile)==null?void 0:h.lastUpgradeDay)||0;if(t-l<Hr||e.wealth<200)return null;const f=((b=r==null?void 0:r.dominance)==null?void 0:b.faction)==="left"?.7:1;if(Math.random()>(((M=e.investmentProfile)==null?void 0:M.riskTolerance)||.5)*f)return null;const p=Rr(u),d=[];return e.ownedProperties.forEach((g,C)=>{const x=Vt.find(N=>N.id===g.buildingId);if(!x)return;const m=In(x.id),_=g.level||0,A=_+1;if(A>m)return;const k=(a==null?void 0:a[x.id])||0,D=(s==null?void 0:s[x.id])||{},P=ul(A,k,D),T=kn(x.id,A,P,p);if(!T)return;const R=Yr(T,o);if(R>e.wealth*.5)return;const V=Ml(x,_,A,o,i);V<=0||d.push({propertyIndex:C,buildingId:x.id,fromLevel:_,toLevel:A,cost:R,profitGain:V,roi:V/R})}),d.length?(d.sort((g,C)=>C.roi-g.roi),d[0]):null},xl={0:0,1:3,2:6,3:9,4:12,5:15,6:18,7:21},zr={early_administration:2,bureaucracy:3,civil_service:3,administrative_reform:4,centralization:2},El=(e=0,t={},o=[])=>{const r=xl[e]||0,a=t.officialCapacity||0;let s=0;return o.forEach(u=>{zr[u]&&(s+=zr[u])}),Math.max(1,2+r+a+s)},Cl=(e,t)=>{const o={buildings:{},buildingProductionMod:{},wartimeProduction:0,tradeBonus:0,taxEfficiency:0,buildingCostMod:0,incomePercentBonus:0,passiveGains:{},passivePercentGains:{},corruption:0,decreeStratumDemandMod:{},decreeResourceDemandMod:{},resourceSupplyMod:{},resourceWaste:{},needsReduction:0,productionInputCost:{},extraMaxPop:0,populationGrowth:0,researchSpeed:0,approval:{},coalitionApproval:0,legitimacyBonus:0,organizationDecay:0,factionConflict:0,stability:0,militaryBonus:0,militaryUpkeep:0,diplomaticBonus:0,diplomaticCooldown:0,diplomaticIncident:0};if(!e||!Array.isArray(e))return o;const i=t?1:.5,r=(a,s=i)=>{if(!a||!a.type||typeof a.value!="number")return;const u=a.value*s;switch(a.type){case"buildings":a.target&&(o.buildings[a.target]=(o.buildings[a.target]||0)+u);break;case"buildingProductionMod":case"categories":a.target&&(o.buildingProductionMod[a.target]=(o.buildingProductionMod[a.target]||0)+u);break;case"wartimeProduction":o.wartimeProduction+=u;break;case"tradeBonus":o.tradeBonus+=u;break;case"taxEfficiency":o.taxEfficiency+=u;break;case"buildingCostMod":o.buildingCostMod+=u;break;case"incomePercent":o.incomePercentBonus+=u;break;case"passive":a.target&&(o.passiveGains[a.target]=(o.passiveGains[a.target]||0)+u);break;case"passivePercent":a.target&&(o.passivePercentGains[a.target]=(o.passivePercentGains[a.target]||0)+u);break;case"corruption":o.corruption+=u;break;case"stratumDemandMod":a.target&&(o.decreeStratumDemandMod[a.target]=(o.decreeStratumDemandMod[a.target]||0)+u);break;case"resourceDemandMod":a.target&&(o.decreeResourceDemandMod[a.target]=(o.decreeResourceDemandMod[a.target]||0)+u);break;case"resourceSupplyMod":a.target&&(o.resourceSupplyMod[a.target]=(o.resourceSupplyMod[a.target]||0)+u);break;case"resourceWaste":a.target&&(o.resourceWaste[a.target]=(o.resourceWaste[a.target]||0)+u);break;case"needsReduction":o.needsReduction+=u;break;case"maxPop":o.extraMaxPop+=u;break;case"populationGrowth":o.populationGrowth+=u;break;case"researchSpeed":o.researchSpeed+=u;break;case"approval":a.target&&(o.approval[a.target]=(o.approval[a.target]||0)+u);break;case"coalitionApproval":o.coalitionApproval+=u;break;case"legitimacyBonus":o.legitimacyBonus+=u;break;case"organizationDecay":o.organizationDecay+=u;break;case"factionConflict":o.factionConflict+=u;break;case"stability":o.stability+=u;break;case"militaryBonus":o.militaryBonus+=u;break;case"militaryUpkeep":o.militaryUpkeep+=u;break;case"diplomaticBonus":o.diplomaticBonus+=u;break;case"diplomaticCooldown":o.diplomaticCooldown+=u;break;case"diplomaticIncident":o.diplomaticIncident+=u;break;case"productionInputCost":a.target&&(o.productionInputCost[a.target]=(o.productionInputCost[a.target]||0)+u);break}};return e.forEach(a=>{if(!a||typeof a!="object")return;const s=Aa[a.financialSatisfaction]||Aa.satisfied,u=i*(s.effectMult||1);s.corruption&&(o.corruption+=s.corruption*i),a.effects&&typeof a.effects=="object"&&Object.entries(a.effects).forEach(([l,f])=>{typeof f=="object"&&f!==null?Object.entries(f).forEach(([p,d])=>{r({type:l,target:p,value:d},u)}):r({type:l,value:f},u)}),a.drawbacks&&typeof a.drawbacks=="object"&&Object.entries(a.drawbacks).forEach(([l,f])=>{typeof f=="object"&&f!==null?Object.entries(f).forEach(([p,d])=>{r({type:l,target:p,value:d},u)}):r({type:l,value:f},u)})}),o},_l=(e,t={})=>{var N,F;if(!e)return 0;const o=(N=t.currentDay)!=null?N:0,i=t.polityEffects||{},r=e.sourceStratum,a=Math.max(0,e.wealth||0),s=Array.isArray(e.ownedProperties)?e.ownedProperties:[],u=s.length,l=s.reduce((B,O)=>B+Math.max(0,(O==null?void 0:O.level)||0),0),f=s.reduce((B,O)=>B+Math.max(0,(O==null?void 0:O.purchaseCost)||0),0),d=(e.hireDate!=null?Math.max(0,o-e.hireDate):0)/365,v=1+Math.min(2.5,Math.log2(d+1)*.9),b=(F={capitalist:260,landowner:240,knight:220,official:200,engineer:180,merchant:170,scribe:140,cleric:140,artisan:120,navigator:120,soldier:110,worker:90,miner:85,lumberjack:80,peasant:75,serf:65,unemployed:60}[r])!=null?F:100,M=t.classInfluence||{},g=Math.max(0,M[r]||0),C=Math.log10(g+1)*70,x=b+C,m=Math.log10(a+1)*60,_=Math.sqrt(u)*55,A=Math.sqrt(l)*45,k=Math.log10(f+1)*40,D=Math.max(0,i.officialCapacity||0),P=1+Math.min(1.2,D*.05),R=Math.max(0,e.stratumInfluenceBonus||0)*120,V=(x+m+_+A+k+R)*v*P;return Math.max(0,V)},Tl=(e,t=!0,o={})=>{const i={},r=o.classInfluence||{},a=o.totalInfluence||0;if(!e||!Array.isArray(e))return i;const s=t?1:.5,u=2e4;return e.forEach(l=>{if(!l||!l.sourceStratum)return;const f=l.sourceStratum,p=_l(l,o),d=Math.max(0,r[f]||0),v=a>0?d/a:0,h=1+Math.min(.35,v*.7);let M=p*10*h;M=Math.min(u,M)*s,!(M<=0)&&(i[f]=(i[f]||0)+M,f!=="official"&&(i.official=(i.official||0)+M*.25))}),i},Pl=(e,t)=>{const o={stability:0,legitimacyBonus:0,gatherBonus:0,industryBonus:0,tradeBonus:0,researchSpeed:0,cultureBonus:0,taxEfficiency:0,incomePercentBonus:0,buildingCostMod:0,needsReduction:0,productionInputCost:{},populationGrowth:0,militaryBonus:0,organizationDecay:0,approval:{},diplomaticBonus:0};let i=0,r=0;if(!e||!Array.isArray(e))return{aggregatedEffects:o,satisfiedCount:i,unsatisfiedCount:r};const a=s=>{!s||typeof s!="object"||Object.entries(s).forEach(([u,l])=>{typeof l=="object"&&l!==null?u==="approval"?Object.entries(l).forEach(([f,p])=>{typeof p=="number"&&(o.approval[f]=(o.approval[f]||0)+p)}):u==="productionInputCost"&&Object.entries(l).forEach(([f,p])=>{typeof p=="number"&&(o.productionInputCost[f]=(o.productionInputCost[f]||0)+p)}):typeof l=="number"&&o.hasOwnProperty(u)&&(o[u]+=l)})};return e.forEach(s=>{if(!s)return;const u=s.stanceConditionParams;br(s.politicalStance,t,u)?(i++,a(s.stanceActiveEffects)):(r++,a(s.stanceUnsatisfiedPenalty))}),{aggregatedEffects:o,satisfiedCount:i,unsatisfiedCount:r}},Al=(e,t=0)=>{var p,d;if(!e||typeof e!="object")return e;const o=!!e.investmentProfile,i=Array.isArray(e.ownedProperties),r=e.loyalty===void 0||e.loyalty===null||e.loyalty===0&&((p=e.lowLoyaltyDays)!=null?p:0)>100,a=Number.isFinite(e.salary);if(o&&i&&!r&&a)return e;const s=e.sourceStratum||e.stratum||"peasant",u=e.politicalStance,l=Dn==null?void 0:Dn.INITIAL_MIN,f=r?l:e.loyalty;return{...e,financialSatisfaction:e.financialSatisfaction||"satisfied",salary:Number.isFinite(e.salary)?e.salary:Number.isFinite(e.baseSalary)?e.baseSalary:0,baseSalary:Number.isFinite(e.baseSalary)?e.baseSalary:e.salary||0,investmentProfile:o?e.investmentProfile:ml(s,u,t),ownedProperties:i?e.ownedProperties:[],lastDayPropertyIncome:typeof e.lastDayPropertyIncome=="number"?e.lastDayPropertyIncome:0,loyalty:f,lowLoyaltyDays:r?0:(d=e.lowLoyaltyDays)!=null?d:0}},Oi=(e,t)=>{var r,a;if(e.vassalOf!=="player")return{allowed:!0,reason:null};const o=((r=e.vassalPolicy)==null?void 0:r.diplomaticControl)||"guided",i=((a=e.vassalPolicy)==null?void 0:a.tradePolicy)||"preferential";switch(t){case"alliance":if(o!=="autonomous")return{allowed:!1,reason:"当前外交政策禁止独立结盟"};break;case"treaty":if(o==="puppet")return{allowed:!1,reason:"傀儡外交政策禁止独立签署条约"};break;case"trade":if(["monopoly","exclusive","looting"].includes(i))return{allowed:!1,reason:"当前贸易政策禁止独立贸易"};break}return{allowed:!0,reason:null}},Ra=(e,t,o,i)=>{if(!e||!Number.isFinite(t)||t===0)return 0;const r=Number(e.silver||0),a=Math.max(0,r+t),s=a-r;return e.silver=a,typeof i=="function"&&s!==0&&i(s,o),s},on=(e,t,o,i,r)=>{if(!e||!Number.isFinite(o)||o===0)return 0;const a=Number(e[t]||0),s=Math.max(0,a+o),u=s-a;return e[t]=s,typeof r=="function"&&u!==0&&r(u,i,t),u},nn=(e,t,o)=>o?o.some(i=>i.type==="military_alliance"&&i.members.includes(e)&&i.members.includes(t)):!1,Rl=({nation:e,tick:t,epoch:o,resources:i,population:r,army:a,logs:s,onTreasuryChange:u,onResourceChange:l})=>{var M,g;let f=0;const p=i,d=e;if(!d.isAtWar)return{raidPopulationLoss:f};d.warDuration=(d.warDuration||0)+1;const v=(M=d.aggression)!=null?M:.7,h=Math.min(.35,.25+v*.1);if(Math.random()<h){const C=(g=d.militaryStrength)!=null?g:1,x=.08+v*.05,m={},_=or(o,"light"),A=3+Math.random()*5,k=Math.floor(A*C);_.forEach(B=>{if(To[B]){const O=Math.floor(k/_.length*(.5+Math.random()*.8));O>0&&(m[B]=O)}});const D={...a},P=Object.values(D).reduce((B,O)=>B+O,0);let T=0,R=0,V=0,N={victory:!0,attackerLosses:{},defenderLosses:{}};if(P===0)T=Math.floor((p.food||0)*x),R=Math.floor((p.silver||0)*(x/2)),V=Math.min(5,Math.max(1,Math.floor(x*25)));else{N=mr({army:m,militaryBuffs:.1},{army:D,militaryBuffs:0}),N.victory&&(T=Math.floor((p.food||0)*x),R=Math.floor((p.silver||0)*(x/2)),V=Math.min(5,Math.max(1,Math.floor(x*25))));const B=N.defenderLosses||{},O={};Object.entries(B).forEach(([H,le])=>{if(a[H]){const se=Math.min(a[H],le);a[H]=Math.max(0,a[H]-se),se>0&&(O[H]=se)}}),Object.keys(O).length>0&&s.push(`AUTO_REPLENISH_LOSSES:${JSON.stringify(O)}`)}T>0&&on(p,"food",-T,"rebel_raid_loss",l),R>0&&Ra(p,-R,"rebel_raid_loss",u),V>0&&(f+=V),d.warScore=(d.warScore||0)+(N.victory?-8:6);const F={nationName:d.name,victory:!N.victory,attackerArmy:m,defenderArmy:D,attackerLosses:N.attackerLosses||{},defenderLosses:N.defenderLosses||{},foodLoss:T,silverLoss:R,popLoss:V,ourPower:N.defenderPower||0,enemyPower:N.attackerPower||0,battleReport:N.battleReport||[],actionType:"raid",actionName:"叛军突袭"};s.push(`❗RAID_EVENT❗${JSON.stringify(F)}`)}const b=-(d.warScore||0);if(b>50&&(d.warDuration||0)>20){const C=d.lastSurrenderDemandDay||0;if(t-C>=30&&Math.random()<.05){d.lastSurrenderDemandDay=t;const x=p.silver||0,m=Math.floor((r||0)*.05),_=Math.floor(b/4),A=Math.max(0,(r||100)-10),k=Math.min(Math.max(m,_,10),A),D=Math.max(100,Math.floor(x*.1)),P=D*3,T=Math.ceil(P/365);let R="reform";b>200?R="massacre":b>100&&(R="concession"),s.push(`REBEL_DEMAND_SURRENDER:${JSON.stringify({nationId:d.id,nationName:d.name,rebellionStratum:d.rebellionStratum,coalitionStrata:d.coalitionStrata||[d.rebellionStratum],warScore:d.warScore,warAdvantage:b,primaryDemandType:R,massacreAmount:k,reformAmount:D,subsidyTotalAmount:P,subsidyDailyAmount:T})}`)}}return{raidPopulationLoss:f}},Sl=({nation:e,tick:t,logs:o})=>{const i=e,r=i.warScore||0,a=i.warDuration||0,s=Number.isFinite(i.lastPeaceRequestDay)?i.lastPeaceRequestDay:-1/0;if(t-s>=30&&!i.isPeaceRequesting){const l=Math.max(0,r-20)/100+Math.max(0,a-60)/500,f=Math.min(.4,l*.5);r>30&&Math.random()<f?(i.isPeaceRequesting=!0,i.peaceTribute=0,i.lastPeaceRequestDay=t,o.push(`🏳️ ${i.name} 已陷入绝境，请求投降！`)):r>60&&a>90&&(i.isPeaceRequesting=!0,i.peaceTribute=0,i.lastPeaceRequestDay=t,o.push(`🏳️ ${i.name} 已经崩溃，恳求投降！`))}},Il=({nation:e,tick:t,epoch:o,resources:i,army:r,logs:a,difficultyLevel:s=Ea,onTreasuryChange:u,onResourceChange:l})=>{var xe,Ve;let f=0;const p=e,d=i;if(o<1)return{raidPopulationLoss:f};if(Ar(t,s))return{raidPopulationLoss:f};const v=p.lastMilitaryActionDay||0,h=c0(s);p.militaryCooldownDays||(p.militaryCooldownDays=Math.max(5,7+Math.floor(Math.random()*24)+h));const b=t-v>=p.militaryCooldownDays,M=Math.max(0,-(p.warScore||0));let g=Math.min(.18,.02+(p.aggression||.2)*.04+M/400);if(g=r0(g,s),!b||Math.random()>=g)return{raidPopulationLoss:f};p.lastMilitaryActionDay=t,p.militaryCooldownDays=Math.max(5,7+Math.floor(Math.random()*24)+h);const C=Math.max(p.appearEpoch||0,Math.min(o,(xe=p.expireEpoch)!=null?xe:o)),x=(Ve=p.militaryStrength)!=null?Ve:1,m=Math.max(.3,Math.min(1.5,(p.wealth||500)/800)),_=1+(p.aggression||.2),A=1+Math.max(-.5,(p.warScore||0)/120),k=p.aggression||.2;Object.values(r).reduce((ye,z)=>ye+z,0);const D=-(p.warScore||0),P=(p.traits||[]).includes("maritime")||(p.name||"").includes("海")||(p.name||"").includes("威尼斯");let T="raid",R="light",V={min:2,max:6},N="边境掠夺",F=1;const B=Math.random();x>.7&&k>.5&&D>30&&C>=2?B<.25?(T="siege",R="heavy",V={min:15,max:25},N="围城压制",F=1.5):B<.6?(T="assault",R="medium",V={min:12,max:18},N="正面攻势",F=1.3):B<.75&&k>.6&&(T="scorched_earth",R="heavy",V={min:12,max:20},N="焦土战术",F=1.4):x>.5&&D>10&&C>=1?B<.35?(T="assault",R="medium",V={min:10,max:15},N="正面攻势",F=1.2):B<.5&&P&&C>=2&&(T="naval_raid",R="medium",V={min:8,max:14},N="海上劫掠",F=1.1):D<-20&&k>.6&&B<.3&&(T="scorched_earth",R="medium",V={min:8,max:15},N="焦土战术",F=1.1);const O=(.05+k*.05+M/1200)*F,H=x*m*_*A,le={},se=or(C,R),$=V.min+Math.random()*(V.max-V.min),Y=Math.floor($*H);se.forEach(ye=>{if(To[ye]){const z=.5+Math.random()*.8,Oe=Math.floor(Y/se.length*z);Oe>0&&(le[ye]=Oe)}});const ce={...r},oe=Object.values(ce).reduce((ye,z)=>ye+z,0),fe={raid:1,assault:1.5,siege:2,naval_raid:1.2,scorched_earth:1.8}[T]||1,Te={raid:{win:-8,lose:6},assault:{win:-15,lose:12},siege:{win:-25,lose:20},naval_raid:{win:-12,lose:10},scorched_earth:{win:-18,lose:15}}[T]||{win:-8,lose:6};if(oe===0){let ye=Math.floor((d.food||0)*O*fe),z=Math.floor((d.silver||0)*(O/2)*fe),Oe=0;ye=Bi(ye,s),z=Bi(z,s),T==="scorched_earth"&&(Oe=Math.floor((d.wood||0)*O*.8),Oe=Bi(Oe,s),Oe>0&&on(d,"wood",-Oe,"ai_scorched_earth",l)),ye>0&&on(d,"food",-ye,"ai_war_action_loss",l),z>0&&Ra(d,-z,"ai_war_action_loss",u);let Ze=Math.min(Math.floor(3*fe),Math.max(1,Math.floor(O*20*fe)));Ze=Pr(Ze,s),f+=Ze;const je={nationName:p.name,victory:!1,attackerArmy:le,defenderArmy:{},attackerLosses:{},defenderLosses:{},foodLoss:ye,silverLoss:z,woodLoss:Oe,popLoss:Ze,ourPower:0,enemyPower:0,actionType:T,actionName:N};a.push(`❗RAID_EVENT❗${JSON.stringify(je)}`),p.warScore=(p.warScore||0)+Te.win;const Ct=ye+z+Oe;p.wealth=(p.wealth||0)+Math.floor(Ct*.08)}else{const ye={raid:.1,assault:0,siege:-.1,naval_raid:.15,scorched_earth:.05}[T]||.1,z={army:le,militaryBuffs:ye},Oe={army:ce,militaryBuffs:0,wealth:(d.food||0)+(d.silver||0)+(d.wood||0)},Ze=mr(z,Oe);let je=0,Ct=0,K=0,pe=0;if(Ze.victory){let $e=Math.floor((d.food||0)*O*fe),mt=Math.floor((d.silver||0)*(O/2)*fe);$e=Bi($e,s),mt=Bi(mt,s),T==="scorched_earth"&&(K=Math.floor((d.wood||0)*O*.8),K=Bi(K,s),K>0&&on(d,"wood",-K,"ai_scorched_earth",l)),$e>0&&on(d,"food",-$e,"ai_war_action_loss",l),mt>0&&Ra(d,-mt,"ai_war_action_loss",u);let _t=Math.min(Math.floor(3*fe),Math.max(1,Math.floor(O*20*fe)));_t=Pr(_t,s),f+=_t;const Ut=$e+mt+K;p.wealth=(p.wealth||0)+Math.floor(Ut*.08)}const he=Ze.defenderLosses||{},It={};Object.entries(he).forEach(([$e,mt])=>{if(r[$e]){const _t=Math.min(r[$e],mt);r[$e]=Math.max(0,r[$e]-_t),_t>0&&(It[$e]=_t)}}),Object.keys(It).length>0&&a.push(`AUTO_REPLENISH_LOSSES:${JSON.stringify(It)}`);const ie=Object.values(Ze.attackerLosses||{}).reduce(($e,mt)=>$e+(mt||0),0);ie>0&&(p.enemyLosses=(p.enemyLosses||0)+ie);const ot=Ze.victory?Te.win:Te.lose;p.warScore=(p.warScore||0)+ot;const zt={nationName:p.name,victory:!Ze.victory,attackerArmy:le,defenderArmy:ce,attackerLosses:Ze.attackerLosses||{},defenderLosses:Ze.defenderLosses||{},foodLoss:je,silverLoss:Ct,woodLoss:K,popLoss:pe,ourPower:Ze.defenderPower,enemyPower:Ze.attackerPower,battleReport:Ze.battleReport||[],actionType:T,actionName:N};a.push(`❗RAID_EVENT❗${JSON.stringify(zt)}`)}return{raidPopulationLoss:f}},kl=({nation:e,tick:t,lastGlobalPeaceRequest:o=-1/0,logs:i})=>{const r=e,a=Number.isFinite(r.lastPeaceRequestDay)?r.lastPeaceRequestDay:-1/0,s=t-a>=Uc,u=$c,l=t-o>=u;if((r.warScore||0)>12&&s&&l){const f=Math.min(.5,.03+(r.warScore||0)/120+(r.warDuration||0)/400)+Math.min(.15,(r.enemyLosses||0)/500);if(Math.random()<f){const p=r.warScore||0,d=r.enemyLosses||0,v=r.warDuration||0,h=Math.max(0,r.wealth||0),b=cc(p,d,v,h);return i.push(`🤝 ${r.name} 请求和平，愿意支付 ${b} 银币作为赔款。`),r.isPeaceRequesting=!0,r.peaceTribute=b,r.lastPeaceRequestDay=t,!0}}return!1},Dl=({nation:e,tick:t,population:o,playerWealth:i,logs:r})=>{const a=e,s=-(a.warScore||0);if(s>25&&(a.warDuration||0)>30){const u=a.lastSurrenderDemandDay||0;if(t-u>=60&&Math.random()<.03){a.lastSurrenderDemandDay=t;let l="tribute";const f=a.warDuration||0;let p=lc(s,f,i);s>100?(l="territory",p=Math.min(50,Math.max(3,Math.floor(o*.05)))):s>50&&Math.random()<.5&&(l="open_market",p=365*2),r.push(`AI_DEMAND_SURRENDER:${JSON.stringify({nationId:a.id,nationName:a.name,warScore:a.warScore,demandType:l,demandAmount:p})}`)}}},Wl=({nation:e,tick:t,population:o,playerWealth:i,resources:r,logs:a})=>{const s=e;if(!s.isAtWar||s.isPeaceRequesting)return;const u=s.lastMercyPeaceOfferDay||0;if(t-u<30)return;const f=(r==null?void 0:r.silver)||0,p=(r==null?void 0:r.food)||0,d=f+p+((r==null?void 0:r.wood)||0),v=o<20,h=i<50&&f<30,b=d<100&&o<50,M=s.warDuration||0;if(!(M>=30&&(v||h&&o<50||b&&h)))return;const x=s.aggression||.3,m=Math.min(1,(v?.4:0)+(h?.3:0)+(b?.2:0)+(o<10?.3:0)),_=.05+M/500+m*.3,A=x*.15,k=Math.min(.5,Math.max(.1,_-A));Math.random()<k&&(s.lastMercyPeaceOfferDay=t,s.isMercyPeaceOffering=!0,s.mercyPeaceOfferDay=t,a.push(`🕊️ ${s.name} 见你已无力继续战斗，愿意无条件议和。`),a.push(`AI_MERCY_PEACE_OFFER:${JSON.stringify({nationId:s.id,nationName:s.name,warScore:s.warScore,warDuration:M,playerPopulation:o,playerWealth:i})}`))},Bl=({nation:e,nations:t,tick:o,epoch:i,resources:r,stabilityValue:a,logs:s,difficultyLevel:u=Ea,diplomacyOrganizations:l})=>{var V,N,F;const f=e,p=r,d=(V=f.relation)!=null?V:50,v=(N=f.aggression)!=null?N:.2,h=s0(u);if(Ar(o,u))return;const b=(t||[]).filter(B=>B.isAtWar===!0&&B.id!==f.id&&!B.isRebelNation).length,M=(t||[]).some(B=>B.isAtWar&&B.warStartDay&&o-B.warStartDay<Yc&&B.id!==f.id),g=b>0?Math.pow(.3,b):1,C=Math.max(0,(50-d)/70),x=a<35?.02:0,m=v>.5?v*.03:0;let _=i>=h?Math.min(.08,v*.04+C*.025+x+m):0;_=Tr(_,u),_*=g;const A=f.peaceTreatyUntil&&o<f.peaceTreatyUntil,k=nn(f.id,"player",l==null?void 0:l.organizations);!f.isAtWar&&!A&&!k&&d<25&&b<wa&&!M&&Math.random()<_&&(f.isAtWar=!0,f.warStartDay=o,f.warDuration=0,f.warDeclarationPending=!0,s.push(`⚠️ ${f.name} 对你发动了战争！`),s.push(`WAR_DECLARATION_EVENT:${JSON.stringify({nationId:f.id,nationName:f.name})}`),t&&t.forEach(B=>{var O;if(B.vassalOf==="player"){const H=Rn[B.vassalType];(H==null?void 0:H.militaryObligation)==="auto_join"&&(f.foreignWars||(f.foreignWars={}),B.foreignWars||(B.foreignWars={}),(O=f.foreignWars[B.id])!=null&&O.isAtWar||(f.foreignWars[B.id]={isAtWar:!0,warStartDay:o,warScore:0},B.foreignWars[f.id]={isAtWar:!0,warStartDay:o,warScore:0},s.push(`⚔️ ${B.name} 作为您的${H.name}，自动对 ${f.name} 宣战！`)))}}));const P=(p.food||0)+(p.silver||0)+(p.wood||0),T=f.wealth||500,R=(F=f.militaryStrength)!=null?F:1;if(!f.isAtWar&&!A&&!k&&i>=h&&P>T*2&&R>.8&&d<50&&v>.4&&b<wa&&!M){let B=.001*v*(P/T-1);B=Tr(B,u),Math.random()<B&&(f.isAtWar=!0,f.warStartDay=o,f.warDuration=0,f.warDeclarationPending=!0,s.push(`⚠️ ${f.name} 觊觎你的财富，发动了战争！`),s.push(`WAR_DECLARATION_EVENT:${JSON.stringify({nationId:f.id,nationName:f.name,reason:"wealth"})}`),t&&t.forEach(O=>{var H;if(O.vassalOf==="player"){const le=Rn[O.vassalType];(le==null?void 0:le.militaryObligation)==="auto_join"&&(f.foreignWars||(f.foreignWars={}),O.foreignWars||(O.foreignWars={}),(H=f.foreignWars[O.id])!=null&&H.isAtWar||(f.foreignWars[O.id]={isAtWar:!0,warStartDay:o,warScore:0},O.foreignWars[f.id]={isAtWar:!0,warStartDay:o,warScore:0},s.push(`⚔️ ${O.name} 作为您的${le.name}，自动对 ${f.name} 宣战！`)))}}))}},Ol=(e,t,o,i)=>{e.forEach(r=>{if(Object.values(r.foreignWars||{}).filter(l=>l==null?void 0:l.isAtWar).length<3||e.filter(l=>{var f,p;return((p=(f=l.foreignWars)==null?void 0:f[r.id])==null?void 0:p.isAtWar)&&l.id!==r.id}).length>=2)return;const u=e.filter(l=>{var p,d,v,h;return l.id===r.id||(d=(p=l.foreignWars)==null?void 0:p[r.id])!=null&&d.isAtWar||nn(l.id,r.id,i==null?void 0:i.organizations)?!1:((h=(v=l.foreignRelations)==null?void 0:v[r.id])!=null?h:50)<40});if(u.length>=2&&Math.random()<.005){const l=u[Math.floor(Math.random()*u.length)];l.foreignWars||(l.foreignWars={}),r.foreignWars||(r.foreignWars={}),l.foreignWars[r.id]={isAtWar:!0,warStartDay:t,warScore:0},r.foreignWars[l.id]={isAtWar:!0,warStartDay:t,warScore:0},o.push(`⚔️ 国际新闻：${l.name} 认为 ${r.name} 的好战行为威胁地区稳定，对其宣战！`)}})},jl=(e,t,o,i,r)=>{e.forEach(a=>{a.foreignWars||(a.foreignWars={}),e.forEach(s=>{var T,R,V,N,F;if(s.id===a.id||(T=a.foreignWars[s.id])!=null&&T.isAtWar)return;const u=((R=a.foreignWars[s.id])==null?void 0:R.peaceTreatyUntil)||0;if(o<u||nn(a.id,s.id,r==null?void 0:r.organizations))return;const f=Object.values(a.foreignWars||{}).filter(B=>B==null?void 0:B.isAtWar).length,p=a.aggression>.7?2:1;if(f>=p)return;const d=a.population||100,v=a.wealth||500;if(d<30||v<300)return;const h=B=>{var O;return((O=B.militaryStrength)!=null?O:1)*(B.population||100)*(1+(B.aggression||.3))};let b=h(a),M=h(s);e.forEach(B=>{if(B.id===a.id||B.id===s.id)return;nn(a.id,B.id,r==null?void 0:r.organizations)&&(b+=h(B)),nn(s.id,B.id,r==null?void 0:r.organizations)&&(M+=h(B))});const g=b/Math.max(1,M),C=a.aggression>.7?.5:.7;if(g<C)return;const m=Object.values(s.foreignWars||{}).filter(B=>B==null?void 0:B.isAtWar).length>0?.002:0,_=(N=(V=a.foreignRelations)==null?void 0:V[s.id])!=null?N:50,A=(F=a.aggression)!=null?F:.3,k=_<50,D=A>.25,P=_<15;if(s.vassalOf==="player"&&a.isAtWar,k&&D||P){let B=A*.003+(50-_)/5e3;_<10?B+=.01:_<20&&(B+=.003),g>2?B*=2:g>1.5?B*=1.5:g>1.2?B*=1.2:g<.8&&(B*=.1),B+=m*.5;const O=s.wealth||500;if(O>v*1.5&&g>.8){const H=.003*A*(O/v-1);B+=H}if(B=Math.min(.003,B),Math.random()<B){a.foreignWars[s.id]={isAtWar:!0,warStartDay:o,warScore:0},s.foreignWars||(s.foreignWars={}),s.foreignWars[a.id]={isAtWar:!0,warStartDay:o,warScore:0};const H=[`📢 国际新闻：${a.name} 向 ${s.name} 宣战了！`,`📢 国际新闻：${a.name} 正式对 ${s.name} 宣战！`,`📢 国际新闻：战争爆发！${a.name} 对 ${s.name} 发起了战争！`];i.push(H[Math.floor(Math.random()*H.length)]),s.vassalOf==="player"&&(a.isAtWar||(a.isAtWar=!0,a.warStartDay=o,a.warDuration=0,a.warDeclarationPending=!0,i.push(`⚠️ ${a.name} 攻击了您的附庸 ${s.name}，自动对您宣战！`)));const le=s.alliedWithPlayer===!0,se=a.alliedWithPlayer===!0,$=le&&se,Y=e.filter(ce=>ce.isAtWar===!0&&!ce.isRebelNation).length;$?i.push(`⚖️ 你的盟友 ${a.name} 与 ${s.name} 发生冲突，你选择保持中立。`):(le&&!a.isAtWar&&i.push(`ALLY_ATTACKED_EVENT:${JSON.stringify({allyId:s.id,allyName:s.name,attackerId:a.id,attackerName:a.name,currentPlayerWars:Y})}`),se&&!s.isAtWar&&(Y>=wa?i.push(`⚖️ 你的盟友 ${a.name} 向 ${s.name} 宣战！但你已陷入多场战争，选择不介入。`):(s.isAtWar=!0,s.warStartDay=o,s.warDuration=0,s.relation=Math.max(0,(s.relation||50)-40),i.push(`⚔️ 你的盟友 ${a.name} 向 ${s.name} 宣战！作为同盟，你被迫与 ${s.name} 进入战争状态！`)))),e.forEach(ce=>{if(ce.id===a.id||ce.id===s.id)return;((s.allies||[]).includes(ce.id)||(ce.allies||[]).includes(s.id))&&(ce.foreignWars||(ce.foreignWars={}),ce.foreignWars[a.id]={isAtWar:!0,warStartDay:o,warScore:0},a.foreignWars||(a.foreignWars={}),a.foreignWars[ce.id]={isAtWar:!0,warStartDay:o,warScore:0},i.push(`⚔️ ${ce.name} 作为 ${s.name} 的盟友，加入对 ${a.name} 的战争！`))})}}})})},Nl=(e,t,o,i)=>{const r=new Set(e.map(a=>a.id));e.forEach(a=>{Object.keys(a.foreignWars||{}).forEach(s=>{var C,x;const u=a.foreignWars[s];if(!(u!=null&&u.isAtWar))return;const l=t.find(m=>m.id===s);if(!l||!r.has(s)){a.foreignWars[s]={isAtWar:!1},l&&i.push(`⚔️ ${a.name} 与 ${l.name} 的战争因对方势力消亡而结束。`);return}l.foreignWars||(l.foreignWars={}),l.foreignWars[a.id]||(l.foreignWars[a.id]={isAtWar:!0,warStartDay:u.warStartDay||o,warScore:-(u.warScore||0)});const f=o-(u.warStartDay||o),p=Math.min(2,1+f/500),d=.995-p*.003,v=.998-p*.002,h=Object.values(a.foreignWars||{}).filter(m=>m==null?void 0:m.isAtWar).length,b=Object.values(l.foreignWars||{}).filter(m=>m==null?void 0:m.isAtWar).length,M=Math.pow(.998,h-1),g=Math.pow(.998,b-1);if(a.wealth=Math.max(100,(a.wealth||500)*d*M),a.population=Math.max(10,(a.population||100)*v*M),l.wealth=Math.max(100,(l.wealth||500)*d*g),l.population=Math.max(10,(l.population||100)*v*g),(o-u.warStartDay)%10===0&&o>u.warStartDay){const m=((C=a.militaryStrength)!=null?C:1)*(a.population||100)*(1+(a.aggression||.3)),_=((x=l.militaryStrength)!=null?x:1)*(l.population||100)*(1+(l.aggression||.3)),A=m+_,k=m/A,D=.02+Math.random()*.03;if(a.population=Math.max(10,(a.population||100)*(1-D*(1-k))),l.population=Math.max(10,(l.population||100)*(1-D*k)),Math.random()<k){u.warScore=(u.warScore||0)+5,l.foreignWars[a.id].warScore=(l.foreignWars[a.id].warScore||0)-5;const N=Math.floor((l.wealth||500)*.08);a.wealth=(a.wealth||500)+N,l.wealth=Math.max(100,(l.wealth||500)-N)}else{u.warScore=(u.warScore||0)-5,l.foreignWars[a.id].warScore=(l.foreignWars[a.id].warScore||0)+5;const N=Math.floor((a.wealth||500)*.08);l.wealth=(l.wealth||500)+N,a.wealth=Math.max(100,(a.wealth||500)-N)}u.endScoreThreshold||(u.endScoreThreshold=25+Math.floor(Math.random()*56));const P=Math.abs(u.warScore||0),T=(a.population||100)<30||(a.wealth||500)<200,R=(l.population||100)<30||(l.wealth||500)<200,V=T||R?.03:.005;if(P>=u.endScoreThreshold||Math.random()<V){const N=(u.warScore||0)>0?a:l,F=N.id===a.id?l:a,B=Math.abs(u.warScore||0);let O="draw",H=0,le=0,se=365,$="僵持";B>=200?(O="overwhelming",H=.25,le=.35,se=365*3,$="压倒性胜利"):B>=100?(O="major",H=.15,le=.25,se=Math.floor(365*2.5),$="大胜"):B>=50?(O="minor",H=.08,le=.12,se=365*2,$="小胜"):B>=25&&(O="pyrrhic",H=.03,le=.05,se=Math.floor(365*1.5),$="惨胜");const Y=Math.floor((F.population||100)*H),ce=Math.floor((F.wealth||500)*le);N.population=(N.population||100)+Y,N.wealth=(N.wealth||500)+ce,F.population=Math.max(10,(F.population||100)-Y),F.wealth=Math.max(100,(F.wealth||500)-ce);let oe=!1;O==="overwhelming"&&(F.population||100)<30&&(F.wealth||500)<300&&(N.population=(N.population||100)+(F.population||0),N.wealth=(N.wealth||500)+(F.wealth||0),F.isAnnexed=!0,F.annexedBy=N.id,F.annexedAt=o,F.population=0,F.wealth=0,oe=!0),a.foreignWars[s]={isAtWar:!1,peaceTreatyUntil:o+se},l.foreignWars[a.id]={isAtWar:!1,peaceTreatyUntil:o+se};const fe=10+Math.floor(B/10);a.foreignRelations||(a.foreignRelations={}),l.foreignRelations||(l.foreignRelations={}),a.foreignRelations[s]=Ft((a.foreignRelations[s]||50)-fe,0,100),l.foreignRelations[a.id]=Ft((l.foreignRelations[a.id]||50)-fe,0,100);const Te=o-(u.warStartDay||o);oe?i.push(`📢 国际新闻：${N.name} 在历时${Te}天的战争中彻底击败 ${F.name}，将其吞并！`):O==="draw"?i.push(`📢 国际新闻：${a.name} 与 ${l.name} 经过${Te}天的战争后握手言和。`):i.push(`📢 国际新闻：${N.name} 在与 ${F.name} 历时${Te}天的战争中取得${$}！`)}}})})},Jr={military_alliance:{id:"military_alliance",name:"军事联盟",minEra:3,minMembers:2,maxMembers:6,createCost:.05,memberFee:.001,minRelation:60,leaveCost:.03,founderLeaveCost:.08,leaveRelationPenalty:-15,founderLeaveRelationPenalty:-25,founderLeaveDisbands:!0,kickRelationPenalty:-20,effects:{mutualDefense:!0,relationBonus:5,militaryBonus:.1},description:"成员国互相保护，共同对抗外敌"},economic_bloc:{id:"economic_bloc",name:"经济共同体",minEra:5,minMembers:2,maxMembers:10,createCost:.08,memberFee:.002,minRelation:45,leaveCost:.05,founderLeaveCost:.12,leaveRelationPenalty:-10,founderLeaveRelationPenalty:-20,founderLeaveDisbands:!0,kickRelationPenalty:-15,effects:{tariffDiscount:.3,relationBonus:5,tradeEfficiency:.2,priceConvergence:.03},description:"成员国共享经济利益，减免关税，促进贸易自由化"}};function Zr({type:e,founderId:t,founderName:o,name:i=null,epoch:r=0,daysElapsed:a=0}){var f;const s=Jr[e];if(!s)throw new Error(`无效的组织类型: ${e}`);if(!hi("organizations",e,r))return{success:!1,reason:`需要 ${(f=ir.organizations[e])==null?void 0:f.name} 时代解锁`};const u=`org_${e}_${Date.now()}`,l=i||`${o}主导的${s.name}`;return{success:!0,organization:{id:u,type:e,name:l,founderId:t,members:[t],createdDay:a,isActive:!0}}}function Ll({organizations:e=[],nations:t=[],playerWealth:o=0,daysElapsed:i=0}){const r=[],a={player:0,ai:{}},s=[];for(const u of e){if(!u.isActive){s.push(u);continue}const l=Jr[u.type];if(!l){s.push(u);continue}for(const f of u.members)if(f==="player"){const p=Math.floor(o*l.memberFee);a.player+=p,p>0&&r.push(`🏛️ ${u.name}成员费: -${p.toLocaleString()}银`)}else{const p=t.find(d=>d.id===f);if(p){const d=Math.floor((p.wealth||1e3)*l.memberFee);a.ai[f]=(a.ai[f]||0)+d}}s.push(u)}return{updatedOrganizations:s,fees:a,logs:r}}const Qr=(e,t,o,i)=>{if(!e||!Number.isFinite(t)||t===0)return 0;const r=Number(e.silver||0),a=Math.max(0,r+t),s=a-r;return e.silver=a,typeof i=="function"&&s!==0&&i(s,o),s},Fl=e=>Array.isArray(e)?e.map(t=>(t.foreignRelations||(t.foreignRelations={}),e.forEach(o=>{if(o.id!==t.id){if(t.foreignRelations[o.id]===void 0){const i=((t.aggression||.3)+(o.aggression||.3))/2;t.foreignRelations[o.id]=Math.floor(50-i*30+(Math.random()-.5)*20)}if(Math.random()<.05){const i=(Math.random()-.5)*6;t.foreignRelations[o.id]=Ft((t.foreignRelations[o.id]||50)+i,0,100)}}}),t)):[],Ul=(e,t)=>!(t%30===0)||!Array.isArray(e)?e||[]:e.map(i=>{var l;if(i.isRebelNation)return i;const r=(l=i.relation)!=null?l:50,s=i.alliedWithPlayer===!0?.1:.5;let u=r;return r>50?u=Math.max(50,r-s):r<50&&(u=Math.min(50,r+s)),{...i,relation:u}}),$l=(e,t,o,i="normal")=>{if(!Array.isArray(e))return;const r=f0(i),a=d0(i);e.forEach(s=>{var l,f;if(s.isRebelNation||s.alliedWithPlayer!==!0||((l=s.relation)!=null?l:50)>=70)return;const u=s.lastAllyColdEventDay||0;t-u<r||Math.random()<a&&(s.lastAllyColdEventDay=t,o.push(`ALLY_COLD_EVENT:${JSON.stringify({nationId:s.id,nationName:s.name,relation:Math.round((f=s.relation)!=null?f:50)})}`))})},Gl=(e,t)=>{e.forEach(o=>{var l;if(Math.random()>.02)return;const i=(l=o.aggression)!=null?l:.3,r=o.wealth||500;if(i>.6||r<300)return;const a=e.filter(f=>{var d,v,h,b;if(f.id===o.id||(v=(d=o.foreignWars)==null?void 0:d[f.id])!=null&&v.isAtWar)return!1;const p=(b=(h=o.foreignRelations)==null?void 0:h[f.id])!=null?b:50;return p>=40&&p<80});if(a.length===0)return;const s=a[Math.floor(Math.random()*a.length)],u=rr(r,s.wealth);if(r>u*3){o.wealth=Math.max(0,(o.wealth||0)-u),s.wealth=(s.wealth||0)+u;const f=Math.floor(5+Math.random()*8);o.foreignRelations||(o.foreignRelations={}),s.foreignRelations||(s.foreignRelations={}),o.foreignRelations[s.id]=Ft((o.foreignRelations[s.id]||50)+f,0,100),s.foreignRelations[o.id]=Ft((s.foreignRelations[o.id]||50)+f,0,100),o.foreignRelations[s.id]>=80&&s.foreignRelations[o.id]>=80?t.push(`🤝 国际新闻：${o.name} 与 ${s.name} 达成同盟协议！`):Math.random()<.3&&t.push(`💝 国际新闻：${o.name} 向 ${s.name} 赠送了外交礼物，两国关系升温。`)}})},Vl=(e,t,o)=>{const i=e==null?void 0:e.organizations;return Array.isArray(i)?i.reduce((r,a)=>{if(!a||!Array.isArray(a.members)||!a.members.includes(t)||!a.members.includes(o))return r;const s=Ma[a.type]||{};return{tariffDiscount:Math.max(r.tariffDiscount,s.tariffDiscount||0),relationBonus:Math.max(r.relationBonus,s.relationBonus||0)}},{tariffDiscount:0,relationBonus:0}):{tariffDiscount:0,relationBonus:0}},ql=(e,t,o=null)=>{e.forEach(i=>{if(Math.random()>.02||i.isAtWar||!Oi(i,"trade").allowed||(i.wealth||500)<300)return;const s=e.filter(b=>{var C,x,m,_;return b.id===i.id||b.isAtWar||(x=(C=i.foreignWars)==null?void 0:C[b.id])!=null&&x.isAtWar||!Oi(b,"trade").allowed?!1:((_=(m=i.foreignRelations)==null?void 0:m[b.id])!=null?_:50)>=30});if(s.length===0)return;const u=s[Math.floor(Math.random()*s.length)],l=Math.floor(20+Math.random()*60),f=.08,p=Vl(o,i.id,u.id),d=f*(1-p.tariffDiscount);if(l*(1-d)-l*.5<=0)return;i.wealth=(i.wealth||0)+l*.05,u.wealth=(u.wealth||0)+l*.05,i.foreignRelations||(i.foreignRelations={}),u.foreignRelations||(u.foreignRelations={});const h=1+(p.relationBonus||0);i.foreignRelations[u.id]=Math.min(100,(i.foreignRelations[u.id]||50)+h),u.foreignRelations[i.id]=Math.min(100,(u.foreignRelations[i.id]||50)+h)})},Hl=(e,t,o,i,r,a={},s=null,u=null)=>{const l=o,f=(s==null?void 0:s.organizations)||[],p=d=>{var h;const v=f.find(b=>Array.isArray(b==null?void 0:b.members)&&b.members.includes("player")&&b.members.includes(d));return v&&((h=Ma[v.type])==null?void 0:h.tariffDiscount)||0};e.forEach(d=>{var R,V,N,F,B,O,H,le,se,$,Y,ce;if(Math.random()>.005||d.isAtWar||((R=d.relation)!=null?R:50)<40)return;const v=d.wealth||500;if(v<400)return;const h=d.openMarketUntil&&t<d.openMarketUntil,b=Math.random()>.5,M=["food","wood","stone","iron"],g=M[Math.floor(Math.random()*M.length)],C=((V=i==null?void 0:i.prices)==null?void 0:V[g])||((N=De[g])==null?void 0:N.basePrice)||1,x=((F=a==null?void 0:a.resourceTaxRates)==null?void 0:F[g])||0,m=b?(le=(H=(B=a==null?void 0:a.exportTariffMultipliers)==null?void 0:B[g])!=null?H:(O=a==null?void 0:a.resourceTariffMultipliers)==null?void 0:O[g])!=null?le:0:(ce=(Y=(se=a==null?void 0:a.importTariffMultipliers)==null?void 0:se[g])!=null?Y:($=a==null?void 0:a.resourceTariffMultipliers)==null?void 0:$[g])!=null?ce:0,_=p(d.id),A=m*(1-_),k=h?0:x+A,D=Math.floor(10+Math.random()*40),P=D*C,T=Math.floor(P*k);if(b){const oe=C*1.5,fe=D*oe,Te=P+T;if(fe<=Te)return;(l[g]||0)>=D&&(l[g]=(l[g]||0)-D,Qr(l,T,"ai_trade_tariff",u),d.wealth=Math.max(0,(d.wealth||0)-P-T),d.inventory||(d.inventory={}),d.inventory[g]=(d.inventory[g]||0)+D,r.push(`AI_TRADE_EVENT:${JSON.stringify({nationId:d.id,nationName:d.name,tradeType:"export",resourceKey:g,quantity:D,baseValue:P,tariff:T,isOpenMarket:h})}`),d.relation=Math.min(100,(d.relation||50)+2))}else{const oe=D*C*.6;if(P-T<=oe)return;v>=P*.6&&(l[g]=(l[g]||0)+D,Qr(l,T,"ai_trade_tariff",u),d.wealth=(d.wealth||0)+P-T,d.inventory||(d.inventory={}),d.inventory[g]=Math.max(0,(d.inventory[g]||0)-D),r.push(`AI_TRADE_EVENT:${JSON.stringify({nationId:d.id,nationName:d.name,tradeType:"import",resourceKey:g,quantity:D,baseValue:P,tariff:T,isOpenMarket:h})}`),d.relation=Math.min(100,(d.relation||50)+2))}})},Yl=(e,t,o,i)=>{e.forEach(r=>{var m;const a=r.wealth||500,s=(m=r.aggression)!=null?m:.3,u=r.relation||0;if(r.isAtWar===!0)return;if(Oi(r,"treaty"),r.peaceTreatyUntil&&t<r.peaceTreatyUntil){const _=sc(o),A=Number.isFinite(r.lastTreatyBreachDay)?r.lastTreatyBreachDay:-1/0,k=t-A>=_.cooldownDays,D=u<15&&s>.55;if(k&&D){const P=Math.min(.05,.005+.02*(s-.55)+Math.max(0,(15-u)/500));Math.random()<P&&(r.relation=Math.max(0,u-_.relationPenalty),r.peaceTreatyUntil=void 0,Array.isArray(r.treaties)&&(r.treaties=r.treaties.filter(T=>!nc.includes(T.type))),r.lastTreatyBreachDay=t,i.push(`AI_TREATY_BREACH:${JSON.stringify({nationId:r.id,nationName:r.name,relationPenalty:_.relationPenalty})}`),i.push(`⚠️ ${r.name} 撕毁了与你的和平条约，关系恶化（-${_.relationPenalty}）。`))}}const f=r.lastGiftToPlayerDay||0,d=t-f>=1825,v=2e-5+u/1e6+a/1e8;if(d&&a>1e3&&u>=70&&s<.4&&Math.random()<v){const _=rr(a);r.wealth=Math.max(0,r.wealth-_),r.lastGiftToPlayerDay=t,i.push(`AI_GIFT_EVENT:${JSON.stringify({nationId:r.id,nationName:r.name,amount:Math.floor(_)})}`)}const h=5e-5+Math.max(0,(400-a)/1e6);if(o>=1&&a<400&&Math.random()<h){const _=Math.floor(80+Math.random()*120);i.push(`AI_REQUEST_EVENT:${JSON.stringify({nationId:r.id,nationName:r.name,resourceKey:"silver",resourceName:"银币",amount:_})}`)}const b=r.alliedWithPlayer===!0,M=r.lastAllianceRequestDay||0,C=t-M>=1095,x=5e-5+(u-70)/1e5;C&&!b&&u>=70&&s<.5&&Math.random()<x&&(r.lastAllianceRequestDay=t,i.push(`AI_ALLIANCE_REQUEST:${JSON.stringify({nationId:r.id,nationName:r.name})}`))})},Xl=(e,t,o,i,r)=>{const a=(i==null?void 0:i.organizations)||[],s={createdOrganizations:[],memberJoinRequests:[]};return[...e].sort(()=>Math.random()-.5).forEach(l=>{if(Math.random()>.005||(l.wealth||0)<2e3||a.find(h=>h.type==="economic_bloc"&&h.members.includes(l.id)))return;const p=e.filter(h=>{var C,x,m,_;if(h.id===l.id||(h.wealth||0)<2e3||!Oi(h,"alliance").allowed)return!1;const M=(x=(C=l.foreignRelations)==null?void 0:C[h.id])!=null?x:50,g=(_=(m=h.foreignRelations)==null?void 0:m[l.id])!=null?_:50;return M>=60&&g>=60});if(p.length===0)return;const d=p[Math.floor(Math.random()*p.length)],v=a.find(h=>h.type==="economic_bloc"&&h.members.includes(d.id));if(v)v.members.map(M=>e.find(g=>g.id===M)).filter(M=>M).every(M=>{var g,C;return((C=(g=M.foreignRelations)==null?void 0:g[l.id])!=null?C:50)>=50})&&(s.memberJoinRequests.push({orgId:v.id,nationId:l.id,orgName:v.name}),o.push(`💰 ${l.name} 此刻申请加入 "${v.name}" 以寻求经济合作。`));else{const h=["贸易同盟","经济共同体","自由市场协定","关税同盟","繁荣互助会","商业联合会"],b=h[Math.floor(Math.random()*h.length)]+(Math.random()>.5?"":` (${l.name})`),M=Zr({type:"economic_bloc",founderId:l.id,founderName:l.name,name:b,epoch:r,daysElapsed:t});if(M.success){const g=M.organization;g.members.push(d.id),s.createdOrganizations.push(g),o.push(`💰 国际新闻：${l.name} 与 ${d.name} 宣布共同建立 "${b}"！`)}}}),s},zl=(e,t,o,i,r)=>{const a=(i==null?void 0:i.organizations)||[],s={createdOrganizations:[],memberJoinRequests:[]};if([...e].sort(()=>Math.random()-.5).forEach(l=>{var b;if(Math.random()>.005||!Oi(l,"alliance").allowed||((b=l.aggression)!=null,a.find(M=>M.type==="military_alliance"&&M.members.includes(l.id))))return;const d=e.filter(M=>{var m,_,A,k,D,P,T,R;if(M.id===l.id||!Oi(M,"alliance").allowed||(_=(m=l.foreignWars)==null?void 0:m[M.id])!=null&&_.isAtWar||(k=(A=M.foreignWars)==null?void 0:A[l.id])!=null&&k.isAtWar)return!1;const C=(P=(D=l.foreignRelations)==null?void 0:D[M.id])!=null?P:50,x=(R=(T=M.foreignRelations)==null?void 0:T[l.id])!=null?R:50;return C>=75&&x>=75});if(d.length===0)return;const v=d[Math.floor(Math.random()*d.length)],h=a.find(M=>M.type==="military_alliance"&&M.members.includes(v.id));if(h)h.members.map(C=>e.find(x=>x.id===C)).filter(C=>C).every(C=>{var m,_;return((_=(m=C.foreignRelations)==null?void 0:m[l.id])!=null?_:50)>=60})&&(s.memberJoinRequests.push({orgId:h.id,nationId:l.id,orgName:h.name}),o.push(`🛡️ ${l.name} 加入了由 ${v.name} 所在的 "${h.name}"！`));else{const M=["北方","南方","东方","西方","神圣","大","自由","联合"],g=["协约","同盟","公约组织","防卫阵线","联盟"],C=M[Math.floor(Math.random()*M.length)],x=g[Math.floor(Math.random()*g.length)],m=`${C}${x}`,_=Zr({type:"military_alliance",founderId:l.id,founderName:l.name,name:m,epoch:r,daysElapsed:t});if(_.success){const A=_.organization;A.members.push(v.id),s.createdOrganizations.push(A),o.push(`🤝 国际新闻：${l.name} 与 ${v.name} 共同建立了新的军事同盟——"${m}"！`)}}}),r>=5){const l=Xl(e,t,o,i,r);s.createdOrganizations.push(...l.createdOrganizations),s.memberJoinRequests.push(...l.memberJoinRequests)}return s},Jl=(e,t,o)=>{var s;if(!o)return null;const i=(o.organizations||[]).filter(u=>u.type==="military_alliance"&&u.members.includes(e.id)&&u.members.includes("player"));if(i.length===0)return null;if(((s=e.relation)!=null?s:50)<30||(e.allianceStrain||0)>=3){const u=i.map(l=>({orgId:l.id,nationId:e.id,orgName:l.name}));return e.allianceStrain=0,u.forEach(l=>{t.push(`💔 ${e.name} 由于与你的关系恶化，退出了 "${l.orgName}"。`)}),{memberLeaveRequests:u}}return null},Zl=(e,t="normal")=>{var s;const o=(s=e.relation)!=null?s:50;let i=0;const r=Sr(t),a=u0(t);o>50?i=-a*r.bad:o<50&&(i=a*r.good),e.relation=Math.max(0,Math.min(100,o+i)),e.foreignRelations&&Object.keys(e.foreignRelations).forEach(u=>{var f;let l=(f=e.foreignRelations[u])!=null?f:50;l>50?l-=a*r.bad:l<50&&(l+=a*r.good),e.foreignRelations[u]=Math.max(0,Math.min(100,l))})},Ql=(e,t,o,i)=>{if(!e||!Number.isFinite(t)||t===0)return 0;const r=Number(e.silver||0),a=Math.max(0,r+t),s=a-r;return e.silver=a,typeof i=="function"&&s!==0&&i(s,o),s},Kl=({nation:e,tick:t,gameSpeed:o})=>{var f;const i=e;i.inventory?i.inventory={...i.inventory}:i.inventory={},typeof i.budget!="number"&&(i.budget=(i.wealth||800)*.5);const r=((f=i.economyTraits)==null?void 0:f.resourceBias)||{},a=Object.keys(De).filter(Jt);if(a.length>0){const d=i.isAtWar||i.foreignWars&&Object.values(i.foreignWars).some(M=>M==null?void 0:M.isAtWar)?1.3+(i.aggression||.2)*.5:1,v=i.epoch||0,h=1+v*.5+Math.pow(v,1.3)*.1,b=Math.max(.8,Math.min(2,(i.wealth||1e3)/1e3));a.forEach(M=>{var xe;const g=(xe=r[M])!=null?xe:1,C=i.inventory[M]||0,x=Math.round(500*Math.pow(g,1.2)),m=Math.round(x*h*b),_=5*o*h*b,A=5*o*h*b*d,k=M.split("").reduce((Ve,ye)=>Ve+ye.charCodeAt(0),0),D=600+k%200,P=Math.sin(t*2*Math.PI/D+k*.1),T=.35+Math.abs(g-1)*.45,R=g>1?1+Math.max(0,P)*T+.2:1-Math.max(0,P)*T*.4,V=g<1?1+Math.max(0,P)*T+.15:1-Math.max(0,P)*T*.25,N=_*Math.pow(g,1.2)*R,F=A*Math.pow(1/g,.8)*V,B=C/m;let O=1,H=1;B>1.5?(O*=.5,H*=1.15):B>1.1?(O*=.8,H*=1.05):B<.5?(O*=1.5,H*=.85):B<.9&&(O*=1.2,H*=.95);const le=(m-C)*.01*o,se=(Math.random()-.5)*m*.1*o,$=N*O,Y=F*H,ce=$-Y+le+se,oe=m*.2,fe=m*3,Te=C+ce;i.inventory[M]=Math.max(oe,Math.min(fe,Te))})}const s=(i.wealth||800)*.5,u=.02,l=s-i.budget;i.budget=i.budget+l*u*o,i.budget=Math.max(0,i.budget)},eu=({nation:e,tick:t})=>{var i;const o=e;if(!((i=o.economyTraits)!=null&&i.ownBasePopulation)){const a=(o.wealthTemplate||800)/800;o.economyTraits={...o.economyTraits||{},ownBasePopulation:Math.max(5,Math.round(16*a*(.8+Math.random()*.4))),ownBaseWealth:Math.max(500,Math.round(1e3*a*(.8+Math.random()*.4))),developmentRate:.8+(o.aggression||.3)*.3+Math.random()*.4,lastGrowthTick:t}}},tu=({nation:e,tick:t})=>{const o=e;if(!o.economyTraits)return;const i=o.economyTraits.ownBasePopulation,r=o.economyTraits.ownBaseWealth,a=o.economyTraits.developmentRate||1;if(t-(o.economyTraits.lastGrowthTick||0)>=100){const u=Math.max(1,(i||10)/200),l=Ft(1/(1+u*.6),.2,1),f=.3*a*l;if(Math.random()<f&&!o.isAtWar){const p=(1.03+Math.random()*.05)*l,d=(1.04+Math.random()*.08)*Math.max(.4,l);o.economyTraits.ownBasePopulation=Math.round(i*p),o.economyTraits.ownBaseWealth=Math.round(r*d)}o.economyTraits.lastGrowthTick=t}},ou=({nation:e,epoch:t,playerPopulationBaseline:o,playerWealthBaseline:i,tick:r})=>{var Ve,ye,z,Oe,Ze,je,Ct,K,pe,he,It,ie;const a=e,s=a.foreignPower||{},u=Ft((ye=(Ve=s.volatility)!=null?Ve:a.marketVolatility)!=null?ye:.3,.1,.9),l=Ft((Oe=(z=s.populationFactor)!=null?z:s.baseRating)!=null?Oe:1,.6,2.5),f=Ft((Ze=s.wealthFactor)!=null?Ze:s.baseRating?s.baseRating*1.1:1.1,.5,3.5),p=1+Math.max(0,t-((je=s.appearEpoch)!=null?je:0))*.03,d=1+Math.max(0,t)*.15,v=(((Ct=a.economyTraits)==null?void 0:Ct.ownBasePopulation)||16)*d*l,h=(((K=a.economyTraits)==null?void 0:K.ownBaseWealth)||1e3)*d*f,b=.05,M=o*l*p,g=i*f*p,C=v*(1-b)+M*b,x=h*(1-b)+g*b,m=Math.max(1,(a.wealthTemplate||800)/Math.max(800,i)*.8),_=Math.max(1,(a.wealthTemplate||800)/Math.max(800,i)*1.1),A=ki("food",a,r),k=A.isShortage?Ft(1-A.shortageAmount/Math.max(1,A.target),.5,1):1,D=A.isSurplus?Ft(1+A.surplusAmount/Math.max(1,A.target)*.08,1,1.15):1,P=Ft(k*D,.5,1.15),T=Math.max(3,C*m*P),R=Math.max(200,o*1.5,(((pe=a.economyTraits)==null?void 0:pe.ownBasePopulation)||16)*25),V=Math.max(0,T-R),N=V>0?R+V/(1+V/R):T,F=Math.max(100,x*_);a.economyTraits={...a.economyTraits||{},basePopulation:N,baseWealth:F};const B=(he=a.population)!=null?he:N,O=Ft(1+u*.6+p*.08,1,1.8),H=Ft(1/(1+Math.pow(B/Math.max(1,R),1.3)),.25,1),le=(a.isAtWar?.032:.12)*O*H,se=(Math.random()-.5)*u*N*.04*H;let $=B+(N-B)*le+se;if(a.isAtWar&&($-=B*.012),a.population=Math.max(3,Math.round($)),A.isShortage){const ot=Ft(A.shortageAmount/Math.max(1,A.target),0,1),zt=(It=a.militaryStrength)!=null?It:1;a.militaryStrength=Math.max(.6,zt-ot*.01)}const Y=(ie=a.wealth)!=null?ie:F,ce=(a.isAtWar?.03:.11)*O,oe=(Math.random()-.5)*u*F*.05;let fe=Y+(F-Y)*ce+oe;a.isAtWar&&(fe-=Y*.015),a.wealth=Math.max(100,Math.round(fe));const Te=a.wealth*.45,xe=Number.isFinite(a.budget)?a.budget:Te;a.budget=Math.max(0,xe+(Te-xe)*.35)},iu=e=>{var s;const t=e;t.economyTraits||(t.economyTraits={});const o=Math.max(5,t.economyTraits.basePopulation||t.population||10),i=Math.max(100,t.economyTraits.baseWealth||t.wealth||200);t.economyTraits.basePopulation=o,t.economyTraits.baseWealth=i;const r=Math.max(o,Math.floor(o*1.1)),a=Math.max(i,Math.floor(i*1.15));t.population=Ft(Math.round(t.population||o),5,r),t.wealth=Ft(Math.round(t.wealth||i),i*.5,a),t.budget=Math.min(t.wealth,Math.max(0,(s=t.budget)!=null?s:Math.floor(t.wealth*.3)))},nu=e=>{var t;if(!e.isAtWar){const o=(t=e.militaryStrength)!=null?t:1;o<1&&(e.militaryStrength=Math.min(1,o+.005))}},au=({nation:e,resources:t,logs:o,onTreasuryChange:i})=>{let r=0;const a=e,s=t;if(a.installmentPayment&&a.installmentPayment.remainingDays>0){const u=a.installmentPayment.amount;Ql(s,u,"installment_payment_income",i),r+=u,a.installmentPayment.paidAmount+=u,a.installmentPayment.remainingDays-=1,a.installmentPayment.remainingDays===0&&(o.push(`💰 ${a.name} 完成了所有分期赔款支付（共${a.installmentPayment.totalAmount}银币）。`),delete a.installmentPayment)}return r},ru=(e,t)=>{var u,l,f;if(!e||e.isRebelNation)return;const o=e.epoch||0;if(o>=pi.length-1)return;const i=o+1,r=pi.find(p=>p.id===i);if(!r)return;const a=((u=r.req)==null?void 0:u.population)||0,s=(((l=r.cost)==null?void 0:l.silver)||1e3)*2.5;if((e.population||0)>=a&&(e.wealth||0)>=s){e.epoch=i;const p=((f=r.cost)==null?void 0:f.silver)||0;e.wealth=Math.max(0,(e.wealth||0)-p),t.push(`🚀 ${e.name} 迈入了新的时代：${r.name}！`)}},Kr={economic_migration:{name:"经济移民",description:"人口从低收入国家流向高收入国家",minEra:3,trigger:"income_gap",baseMonthlyRate:.002,stratumWeights:{worker:.35,peasant:.25,artisan:.2,merchant:.1,engineer:.05,official:.05}},war_refugees:{name:"战争难民",description:"战争期间人口逃往和平国家",minEra:2,trigger:"war",baseMonthlyRate:.01,stratumWeights:{peasant:.4,worker:.3,artisan:.15,merchant:.1,capitalist:.05}},political_exile:{name:"政治流亡",description:"政治迫害导致精英阶层出逃",minEra:4,trigger:"low_approval",baseMonthlyRate:.003,stratumWeights:{official:.25,merchant:.2,capitalist:.2,engineer:.15,artisan:.1,scribe:.1},approvalThreshold:25}},su=(e,t,o)=>{const i=(e==null?void 0:e.wealth)||1e3,r=(o==null?void 0:o.silver)||1e3,a=i/Math.max(1,(e==null?void 0:e.population)||1e3);return(r/Math.max(1,(t==null?void 0:t.population)||1e3)-a)/Math.max(a,1)},cu=(e,t,o)=>!hi("migration","economic_migration",o)||e.isAtWar||e.vassalOf==="player"?!1:t>.5,es=(e,t,o)=>{var a,s;if(!hi("migration","political_exile",o))return{canExile:!1};const i=Kr.political_exile.approvalThreshold;if((((s=(a=e.socialStructure)==null?void 0:a.elites)==null?void 0:s.satisfaction)||50)<40&&!e.isAtWar)return{canExile:!0,exileFrom:"foreign"};for(const[u,l]of Object.entries(t||{}))if(l<i)return{canExile:!0,exileFrom:"domestic",stratum:u};return{canExile:!1}},Sa=(e,t,o=1)=>{const i=Kr[e];if(!i)return{totalMigrants:0,byStratum:{}};const r=(t==null?void 0:t.population)||1e3,a=Math.floor(r*i.baseMonthlyRate*o),s={};let u=a;for(const[l,f]of Object.entries(i.stratumWeights)){const p=Math.floor(a*f);p>0&&(s[l]=p,u-=p)}if(u>0){const l=Object.keys(i.stratumWeights)[0];s[l]=(s[l]||0)+u}return{totalMigrants:a,byStratum:s}},lu=({nations:e,epoch:t,playerPopulation:o,playerResources:i,classApproval:r,daysElapsed:a,maxPop:s=1/0})=>{if(!hi("migration","economic_migration",t)&&!hi("migration","war_refugees",t)&&!hi("migration","political_exile",t))return{immigrantsIn:0,emigrantsOut:0,byStratum:{},events:[]};let u=0,l=0;const f={},p=[],d={};let v=0;if(Array.isArray(e))for(const g of e){if(!g||g.id==="player")continue;const C=su(g,{population:o},i);if(cu(g,C,t)){const m=Math.min(2,Math.max(.5,C)),_=Sa("economic_migration",g,m);_.totalMigrants>0&&(v+=_.totalMigrants,Object.entries(_.byStratum).forEach(([A,k])=>{d[A]=(d[A]||0)+k}),p.push({type:"economic_migration",sourceNation:g.name,amount:_.totalMigrants,day:a,isPotential:!0}))}if(g.foreignWars&&g.foreignWars.length>0&&hi("migration","war_refugees",t)){const m=Sa("war_refugees",g,.5);m.totalMigrants>0&&(v+=m.totalMigrants,Object.entries(m.byStratum).forEach(([_,A])=>{d[_]=(d[_]||0)+A}),p.push({type:"war_refugees",sourceNation:g.name,amount:m.totalMigrants,day:a,isPotential:!0}))}const x=es(g,r,t);if(x.canExile&&x.exileFrom==="foreign"){const m=Sa("political_exile",g,.3);m.totalMigrants>0&&(v+=m.totalMigrants,Object.entries(m.byStratum).forEach(([_,A])=>{d[_]=(d[_]||0)+A}),p.push({type:"political_exile",sourceNation:g.name,amount:m.totalMigrants,day:a,isPotential:!0}))}}const h=Math.max(0,s-o);let b=1;v>h&&(h<=0?(b=0,p.push({type:"info",message:"Border closed due to overpopulation."})):b=h/v),v>0&&(Object.entries(d).forEach(([g,C])=>{const x=Math.floor(C*b);x>0&&(f[g]=(f[g]||0)+x,u+=x)}),p.forEach(g=>{g.isPotential&&(g.amount=Math.floor(g.amount*b),delete g.isPotential)}));const M=es({},r,t);if(M.canExile&&M.exileFrom==="domestic"){const g=M.stratum,x=(25-((r==null?void 0:r[g])||50))/25,m=Math.floor(o*.001*x);m>0&&(l+=m,f[g]=(f[g]||0)-m,p.push({type:"political_exile",direction:"out",stratum:g,amount:m,day:a}))}return{immigrantsIn:u,emigrantsOut:l,byStratum:f,events:p.filter(g=>g.amount>0||g.type==="info")}},uu=(e,t,o)=>{if(!e||!t)return e;const i={...e};return Object.entries(t).forEach(([r,a])=>{if(typeof a=="number"&&a!==0){const s=i[r]||0,u=Math.floor(s+a);i[r]=Math.max(0,u)}}),i},fu=e=>{if(!Array.isArray(e)||e.length===0)return[];const t=[],o={economic_migration:"经济移民",war_refugees:"战争难民",political_exile:"政治流亡"};for(const i of e){const r=o[i.type]||i.type;i.direction==="out"?t.push(`📤 ${r}：${i.amount}名${i.stratum||""}人口移居海外`):t.push(`📥 ${r}：${i.amount}人从${i.sourceNation}移入`)}return t},vt={BASE_STABILITY:50,MAX_STABILITY:100,MIN_STABILITY:0,THRESHOLDS:{VERY_STABLE:80,STABLE:60,UNSTABLE:40,VERY_UNSTABLE:20},FACTORS:{war:-15,warLosing:-10,economicDecline:-8,lowEliteSatisfaction:-5,lowCommonersSatisfaction:-8,lowUnderclassSatisfaction:-3,recentDefeat:-20,strongEconomy:5,peacetime:3,vassalStatus:-10}},ni={BASE_DAILY_GROWTH:.2,STABILITY_COEFFICIENT:.02,REBELLION_THRESHOLD:100,RESET_VALUE:20,PLAYER_SUPPORT_BONUS:2},Ro={MIN_DURATION:60,MAX_DURATION:365,REBEL_INITIAL_STRENGTH:.4,DAILY_CASUALTY_RATE:.02,FOREIGN_AID_MULTIPLIER:1.3,VICTORY_THRESHOLD:.2,ECONOMIC_DAMAGE_RATE:.01},Ln={monarchy:{name:"君主制",baseStability:55,rebellionRisk:.8,possibleSuccessors:["republic","constitutional_monarchy","military_junta"]},republic:{name:"共和制",baseStability:50,rebellionRisk:.7,possibleSuccessors:["monarchy","military_junta","theocracy"]},constitutional_monarchy:{name:"君主立宪制",baseStability:60,rebellionRisk:.6,possibleSuccessors:["republic","monarchy"]},military_junta:{name:"军政府",baseStability:45,rebellionRisk:1,possibleSuccessors:["republic","monarchy","dictatorship"]},theocracy:{name:"神权政治",baseStability:55,rebellionRisk:.9,possibleSuccessors:["republic","monarchy"]},dictatorship:{name:"独裁政权",baseStability:40,rebellionRisk:1.2,possibleSuccessors:["republic","military_junta"]}};function du(e,t={}){const o=[];let i=e.baseStability||vt.BASE_STABILITY;if(e.isAtWar?(o.push({name:"战争中",value:vt.FACTORS.war}),i+=vt.FACTORS.war,(e.warScore||0)<-30&&(o.push({name:"战争失利",value:vt.FACTORS.warLosing}),i+=vt.FACTORS.warLosing)):(o.push({name:"和平时期",value:vt.FACTORS.peacetime}),i+=vt.FACTORS.peacetime),e.recentDefeatDay&&t.daysElapsed){const s=t.daysElapsed-e.recentDefeatDay;if(s<180){const u=vt.FACTORS.recentDefeat*(1-s/180);o.push({name:"近期战败",value:Math.round(u)}),i+=u}}const r=e.socialStructure||{};if(r.elites&&r.elites.satisfaction<40&&(o.push({name:"精英不满",value:vt.FACTORS.lowEliteSatisfaction}),i+=vt.FACTORS.lowEliteSatisfaction),r.commoners&&r.commoners.satisfaction<30&&(o.push({name:"平民不满",value:vt.FACTORS.lowCommonersSatisfaction}),i+=vt.FACTORS.lowCommonersSatisfaction),r.underclass&&r.underclass.satisfaction<20&&(o.push({name:"下层不满",value:vt.FACTORS.lowUnderclassSatisfaction}),i+=vt.FACTORS.lowUnderclassSatisfaction),e.economicGrowth!==void 0&&(e.economicGrowth<-5?(o.push({name:"经济衰退",value:vt.FACTORS.economicDecline}),i+=vt.FACTORS.economicDecline):e.economicGrowth>5&&(o.push({name:"经济繁荣",value:vt.FACTORS.strongEconomy}),i+=vt.FACTORS.strongEconomy)),(e.isVassal||e.overlordId)&&(o.push({name:"附庸状态",value:vt.FACTORS.vassalStatus}),i+=vt.FACTORS.vassalStatus),e.foreignDestabilization>0){const s=Math.min(e.foreignDestabilization,30);o.push({name:"外国颠覆",value:-s}),i-=s}if(e.foreignSupport>0){const s=Math.min(e.foreignSupport,20);o.push({name:"外国支持",value:s}),i+=s}i=Math.max(vt.MIN_STABILITY,Math.min(vt.MAX_STABILITY,i));let a="stable";return i>=vt.THRESHOLDS.VERY_STABLE?a="very_stable":i>=vt.THRESHOLDS.STABLE?a="stable":i>=vt.THRESHOLDS.UNSTABLE?a="unstable":i>=vt.THRESHOLDS.VERY_UNSTABLE?a="very_unstable":a="crisis",{value:Math.round(i),level:a,factors:o}}function pu(e,t){let o=e.dissidentOrganization||0,i=0;if(t<50){const r=50-t;i=ni.BASE_DAILY_GROWTH*(1+r*ni.STABILITY_COEFFICIENT),e.playerSupportingRebels&&(i*=ni.PLAYER_SUPPORT_BONUS),o+=i}else t>60&&(i=-.3,o=Math.max(0,o+i));return{value:Math.min(o,ni.REBELLION_THRESHOLD*1.5),dailyChange:i,rebellionProgress:Math.min(100,o/ni.REBELLION_THRESHOLD*100)}}function hu(e){const t=e.dissidentOrganization||0;if(t>=ni.REBELLION_THRESHOLD){let o=.1;const i=t-ni.REBELLION_THRESHOLD;return o+=i*.02,e.playerSupportingRebels&&(o*=1.5),Math.random()<o}return!1}function mu(e,t){const o=ts(e),i=o*Ro.REBEL_INITIAL_STRENGTH,r=Ro.MIN_DURATION+Math.random()*(Ro.MAX_DURATION-Ro.MIN_DURATION);return{isInCivilWar:!0,civilWarStartDay:t,civilWarData:{governmentStrength:o,rebelStrength:i,governmentSupport:[],rebelSupport:[],casualties:{government:0,rebels:0,civilian:0},economicDamage:0,estimatedDuration:Math.round(r)},dissidentOrganization:ni.RESET_VALUE}}function ts(e){const t=e.wealth||1e3,o=e.militaryTradition||50;return Math.round(t*.5+o*10)}function gu(e,t){if(!e.isInCivilWar||!e.civilWarData)return null;const o={...e.civilWarData},i=t-e.civilWarStartDay;let r=1,a=1;o.governmentSupport.length>0&&(r*=Ro.FOREIGN_AID_MULTIPLIER),o.rebelSupport.length>0&&(a*=Ro.FOREIGN_AID_MULTIPLIER);const s=o.governmentStrength*r,u=o.rebelStrength*a,l=s+u,f=o.governmentStrength*Ro.DAILY_CASUALTY_RATE*(u/l),p=o.rebelStrength*Ro.DAILY_CASUALTY_RATE*(s/l);o.governmentStrength=Math.max(0,o.governmentStrength-f),o.rebelStrength=Math.max(0,o.rebelStrength-p),o.casualties.government+=f,o.casualties.rebels+=p,o.casualties.civilian+=(f+p)*.5;const d=(e.wealth||1e3)*Ro.ECONOMIC_DAMAGE_RATE;o.economicDamage+=d;const v=ts(e),h=v*Ro.REBEL_INITIAL_STRENGTH;let b=null;return o.governmentStrength<v*Ro.VICTORY_THRESHOLD?b={winner:"rebels",warDuration:i,casualties:o.casualties,economicDamage:o.economicDamage}:o.rebelStrength<h*Ro.VICTORY_THRESHOLD&&(b={winner:"government",warDuration:i,casualties:o.casualties,economicDamage:o.economicDamage}),{civilWarData:o,result:b,wealthLoss:d}}function yu(e,t,o){const i={isInCivilWar:!1,civilWarData:null,civilWarEndDay:o};if(t==="rebels"){const r=e.governmentType||"monarchy",s=(Ln[r]||Ln.monarchy).possibleSuccessors||["republic"],u=s[Math.floor(Math.random()*s.length)];i.governmentType=u,i.previousGovernmentType=r,i.regimeChangeDay=o;const l=Ln[u]||Ln.republic;i.baseStability=l.baseStability,i.stability=l.baseStability-10,i.relationResetPending=!0,i.treaties=[],(e.isVassal||e.overlordId)&&(i.isVassal=!1,i.overlordId=null,i.vassalType=null,i.independenceWar=!1,i.becameIndependentDay=o),i.wealth=Math.max(100,(e.wealth||1e3)*.5),i.socialStructure=bu(u)}else i.stability=Math.min(60,(e.stability||40)+10),i.dissidentOrganization=10,i.wealth=Math.max(100,(e.wealth||1e3)*.7);return i}function bu(e){const t={elites:{ratio:.1,satisfaction:40,influence:.4},commoners:{ratio:.8,satisfaction:35,influence:.4},underclass:{ratio:.1,satisfaction:30,influence:.2}};return e==="republic"?(t.commoners.satisfaction+=10,t.elites.satisfaction-=5):e==="military_junta"&&(t.elites.satisfaction+=5,t.commoners.satisfaction-=10),t}function Mu(e,t){const{daysElapsed:o=0}=t,i=[],r=[];for(const a of e){if(!a||a.isPlayer)continue;const s={id:a.id},u=du(a,t);if(s.stability=u.value,s.stabilityLevel=u.level,s.stabilityFactors=u.factors,a.isInCivilWar){const l=gu(a,o);if(l&&(s.civilWarData=l.civilWarData,s.wealth=Math.max(0,(a.wealth||0)-l.wealthLoss),l.result)){const f=yu(a,l.result.winner,o);Object.assign(s,f),r.push({type:"civil_war_ended",nationId:a.id,nationName:a.name,winner:l.result.winner,newGovernment:f.governmentType,day:o})}}else{const l=pu(a,u.value);if(s.dissidentOrganization=l.value,s.dissidentDailyChange=l.dailyChange,s.rebellionProgress=l.rebellionProgress,hu({...a,...s})){const f=mu(a,o);Object.assign(s,f),r.push({type:"civil_war_started",nationId:a.id,nationName:a.name,day:o})}}a.foreignSupport>0&&(s.foreignSupport=Math.max(0,a.foreignSupport-.5)),a.foreignDestabilization>0&&(s.foreignDestabilization=Math.max(0,a.foreignDestabilization-.3)),i.push(s)}return{updates:i,events:r}}const vu={config:{transportCostRate:.15}};function os(e,t,o=0){const i=e==null?void 0:e.treaties;if(!i)return!1;if(Array.isArray(i))return i.some(a=>!a||a.type!==t||a.withPlayer===!1?!1:a.status==="active"||!a.status&&(a.endDay==null||a.endDay>o));const r=i[t];return!r||r.withPlayer===!1?!1:r.status==="active"||!r.status&&(r.endDay==null||r.endDay>o)}function is(e,t=[]){return!t||!e?!1:t.some(o=>o.type==="economic_bloc"&&o.isActive&&o.members&&o.members.includes(e.id)&&o.members.includes("player"))}function ns(e,t,o,i={}){var D;const r=Vt.find(P=>P.id===e.buildingId);if(!r)return{outputValue:0,inputCost:0,wageCost:0,businessTaxCost:0,profit:0,transportCost:0};const a=e.strategy||"PROFIT_MAX",s=vu.config.transportCostRate,u=P=>{var T,R,V,N;return(N=(V=(R=(((T=t.market)==null?void 0:T.prices)||{})[P])!=null?R:(t.nationPrices||{})[P])!=null?V:(t.prices||{})[P])!=null?N:as(P)},l=P=>{var T;return(T=i[P])!=null?T:as(P)},f=(P,T)=>{const R=(t.inventories||{})[P]||0;if(R>0)return R;const V=Math.max(.5,(t.wealth||1e3)/2e3);return Math.floor(T*2*V)};let p=0,d=0,v=!0;const h={},b={},M={inputs:{},outputs:{}};if(Object.entries(r.input||{}).forEach(([P,T])=>{const R=u(P),V=l(P),N=V*(1+s);let F=!0;if(a==="PROFIT_MAX"?N<R&&(F=!1):(a==="MARKET_DUMPING"||a==="RESOURCE_EXTRACTION"&&N<R*.8)&&(F=!1),M.inputs[P]=F?"local":"home",F)f(P,T)<T&&(v=!1),p+=T*R,v&&(h[P]=(h[P]||0)-T);else{const B=T*V;p+=B,d+=B*s,b[P]=(b[P]||0)-T}}),!v)return{outputValue:0,inputCost:0,wageCost:0,businessTaxCost:0,profit:0,transportCost:0,inputAvailable:!1,decisions:M};let g=0;Object.entries(r.output||{}).forEach(([P,T])=>{if(P==="maxPop"||P==="militaryCapacity")return;const R=u(P),V=l(P),N=V*(1-s);let F=!0;if(a==="PROFIT_MAX"?N>R&&(F=!1):a==="RESOURCE_EXTRACTION"?F=!1:a==="MARKET_DUMPING"&&(F=!0),M.outputs[P]=F?"local":"home",F)g+=T*R,h[P]=(h[P]||0)+T;else{const B=T*V,O=B*s;g+=B-O,d+=O,b[P]=(b[P]||0)+T}});const{total:C,breakdown:x}=xu(r,t),A=((D=r.businessTaxBase)!=null?D:.1)*1,k=g-p-C-A;return{outputValue:g,inputCost:p,wageCost:C,wageBreakdown:x,businessTaxCost:A,transportCost:d,profit:k,inputAvailable:!0,localResourceChanges:h,playerResourceChanges:b,decisions:M}}const wu={elites:15,commoners:3,underclass:1};function xu(e,t){var u,l;if(!e.jobs)return{total:0,breakdown:[]};const o=((u=t==null?void 0:t.vassalPolicy)==null?void 0:u.labor)||"standard",i=rc(o);let r=0;const a=[],s=((l=t.market)==null?void 0:l.prices)||t.prices||{};return Object.entries(e.jobs).forEach(([f,p])=>{const d=ae[f];if(!d){console.log(`[Overseas] Missing stratum config for ${f}. STRATA keys: ${Object.keys(ae||{})}`);return}let v=0;d.needs&&Object.entries(d.needs).forEach(([x,m])=>{var A;const _=s[x]||((A=De[x])==null?void 0:A.basePrice)||1;v+=m*_});const h=wu[f]||1,b=v*h;let M=1;if(t.socialStructure&&t.socialStructure[f]){const x=t.socialStructure[f].population||1e3;x<500?M=1.5:x>1e4&&(M=.8),(t.socialStructure[f].sol||1)>h&&(M*=1.1)}const g=b*M*i,C=p*g;r+=C,a.push({stratumId:f,count:p,wagePerWorker:g,total:C,laborPolicy:o,laborMultiplier:i,baseWage:b,supplyFactor:M})}),{total:r,breakdown:a}}function as(e){const t=De[e];return(t==null?void 0:t.basePrice)||1}function Eu({overseasInvestments:e=[],nations:t=[],organizations:o=[],resources:i={},marketPrices:r={},classWealth:a={},daysElapsed:s=0}){const u=[];let l=0;const f={},p=[],d={},v={};return e.forEach(h=>{var V,N,F,B,O;if(h.status!=="operating"){p.push(h);return}const b=t.find(H=>H.id===h.targetNationId);if(!b){p.push({...h,status:"suspended"});return}if(b.isAtWar&&b.warTarget==="player"){const H={...h};H.operatingData={...H.operatingData},u.push(`⚠️ 与 ${b.name} 处于战争状态，海外投资利润被冻结`),p.push(H);return}const M=ns(h,b,i,r);M.localResourceChanges&&(d[h.targetNationId]||(d[h.targetNationId]={}),Object.entries(M.localResourceChanges).forEach(([H,le])=>{d[h.targetNationId][H]=(d[h.targetNationId][H]||0)+le})),M.playerResourceChanges&&Object.entries(M.playerResourceChanges).forEach(([H,le])=>{v[H]=(v[H]||0)+le});let g=.6;const C=b.vassalOf==="player",x=os(b,"investment_pact",s),m=is(b,o);if(C){const H=Rn[b.vassalType];g=.25*(1-(((V=H==null?void 0:H.economicPrivileges)==null?void 0:V.profitTaxExemption)||0))}else m?g=.1:x?g=.25:g=.6;const _=M.profit>0?M.profit*g:0,A=M.profit-_,k=_,D={...h},P=[...((N=h.operatingData)==null?void 0:N.profitHistory)||[]];P.push({day:s,profit:M.profit,repatriated:A}),P.length>30&&P.shift();const R=A<=0?(((F=D.operatingData)==null?void 0:F.consecutiveLossDays)||0)+1:0;if(R>=30){let H=.01;const le=(R-30)*.005;if(H+=le,M.profit<0){const se=Math.abs(M.profit)/(D.investmentAmount||1e3);H+=se}if(H=Math.min(.5,H),Math.random()<H){u.push(`📉 由于长期入不敷出（${R}天），${((B=ae[D.ownerStratum])==null?void 0:B.name)||"业主"}决定关闭在 ${b.name} 的 ${(O=Vt.find($=>$.id===D.buildingId))==null?void 0:O.name}。`);const se=(D.investmentAmount||0)*.1;f[D.ownerStratum]=(f[D.ownerStratum]||0)+se;return}}D.operatingData={...D.operatingData,...M,repatriatedProfit:A,retainedProfit:k,profitHistory:P,consecutiveLossDays:R},l+=A,f[h.ownerStratum]=(f[h.ownerStratum]||0)+A,p.push(D)}),s%30===0&&l>0&&(u.push(`💰 海外投资本月利润汇回: ${l.toFixed(1)} 银币`),Object.entries(f).forEach(([h,b])=>{b>0&&u.push(`  • ${h}阶层: +${b.toFixed(1)}`)})),{updatedInvestments:p,totalProfit:l,profitByStratum:f,logs:u,marketChanges:d,playerInventoryChanges:v}}function Cu(e,t){const o={totalValue:0,estimatedMonthlyProfit:0,estimatedDailyProfit:0,byNation:{},byStratum:{},count:0};return!e||!Array.isArray(e)||e.forEach(i=>{var s;if(i.status!=="operating")return;o.count++,o.totalValue+=i.investmentAmount||0;const r=((s=i.operatingData)==null?void 0:s.profit)||0,a=r*30;o.estimatedDailyProfit+=r,o.estimatedMonthlyProfit+=a,o.byNation[i.targetNationId]||(o.byNation[i.targetNationId]={count:0,value:0,profit:0,dailyProfit:0}),o.byNation[i.targetNationId].count++,o.byNation[i.targetNationId].value+=i.investmentAmount||0,o.byNation[i.targetNationId].profit+=a,o.byNation[i.targetNationId].dailyProfit+=r,o.byStratum[i.ownerStratum]||(o.byStratum[i.ownerStratum]={count:0,value:0,profit:0,dailyProfit:0}),o.byStratum[i.ownerStratum].count++,o.byStratum[i.ownerStratum].value+=i.investmentAmount||0,o.byStratum[i.ownerStratum].profit+=a,o.byStratum[i.ownerStratum].dailyProfit+=r}),o}function _u({foreignInvestments:e=[],nations:t=[],organizations:o=[],playerMarket:i={},playerResources:r={},foreignInvestmentPolicy:a="normal",daysElapsed:s=0,jobFill:u={},buildings:l={}}){const f=[];let p=0,d=0;const v=[],h={};return e.forEach(b=>{var fe,Te;if(b.status!=="operating"){v.push(b);return}const M=Vt.find(xe=>xe.id===b.buildingId);if(!M){v.push(b);return}const g=t.find(xe=>xe.id===b.ownerNationId),C=((fe=g==null?void 0:g.market)==null?void 0:fe.prices)||(g==null?void 0:g.nationPrices)||(g==null?void 0:g.prices)||{},x=(g==null?void 0:g.inventories)||{},m={market:i,inventories:r,wealth:1e4,vassalPolicy:{labor:"standard"}},_={...b,strategy:b.strategy||"PROFIT_MAX"},A=ns(_,m,x,C),k=M.jobs||{},D=l[M.id]||0,P=u[M.id]||{};let T=0,R=0;Object.entries(k).forEach(([xe,Ve])=>{const ye=Ve*D;T+=ye,R+=Math.min(P[xe]||0,ye)});let V=1;T>0&&D>0&&(V=R/T);const N=A.profit||0,F=N*V;let B=.6;const O=g&&g.vassalOf==="player",H=g?os(g,"investment_pact",s):!1,le=is(g,o);O?(B=.25,le&&(B=.1)):le?B=.1:H?B=.25:B=.6;const se=F>0?F*B:0,$=F>0?F*(1-B):0;p+=se,d+=$,A.localResourceChanges&&Object.entries(A.localResourceChanges).forEach(([xe,Ve])=>{h[xe]=(h[xe]||0)+Ve});const ce=$<=0?(((Te=b.operatingData)==null?void 0:Te.consecutiveLossDays)||0)+1:0;if(ce>=30){let xe=.01;const Ve=(ce-30)*.005;if(xe+=Ve,F<0&&(xe+=Math.abs(F)/1e3),xe=Math.min(.5,xe),Math.random()<xe){f.push(`📉 ${(g==null?void 0:g.name)||"外资"} 因长期亏损（${ce}天），撤出了在我国的 ${M.name} 投资。`);return}}const oe=M.jobs?Object.values(M.jobs).reduce((xe,Ve)=>xe+Ve,0):0;v.push({..._,dailyProfit:F,jobsProvided:oe,operatingData:{...A,taxPaid:se,profitRepatriated:$,consecutiveLossDays:ce,staffingRatio:V,theoreticalProfit:N,profit:F}})}),s%30===0&&e.length>0&&f.push(`🏭 外资月报: 税收+${(p*30).toFixed(0)}, 利润外流-${(d*30).toFixed(0)}`),{updatedInvestments:v,taxRevenue:p,profitOutflow:d,logs:f,marketChanges:h}}function Tu({foreignInvestments:e=[],nations:t=[],playerMarket:o={},playerResources:i={},buildingUpgrades:r={},buildingCounts:a={},daysElapsed:s=0}){const u=[],l=[],f=[...e],p=60,d=.03,v=.05,h=1e4;return e.forEach((b,M)=>{var $,Y,ce;if(b.status!=="operating")return;const g=b.lastUpgradeDay||0;if(s-g<p||Math.random()>d)return;const C=Vt.find(oe=>oe.id===b.buildingId);if(!C)return;const x=In(C.id);if(x<=0)return;const m=t.find(oe=>oe.id===b.ownerNationId),_=(m==null?void 0:m.wealth)||0;if(_<h)return;const A=b.upgradeLevel||0;if(A>=x)return;const k=A+1,D=(($=m==null?void 0:m.market)==null?void 0:$.prices)||(m==null?void 0:m.prices)||{},P=kn(C.id,k,0);if(!P)return;let T=0;for(const[oe,fe]of Object.entries(P))if(oe==="silver")T+=fe;else{const Te=D[oe]||((Y=o==null?void 0:o.prices)==null?void 0:Y[oe])||((ce=De[oe])==null?void 0:ce.basePrice)||1;T+=fe*Te}const R=_*.3;if(T>R)return;const V=Ot(C,A),N=Ot(C,k),F=Fn(C,V,o),B=Fn(C,N,o),O=B-F;if(O<=0)return;const le=O*365/T;if(le<v)return;Ki("overseas",`🏭 [外资升级] ${(m==null?void 0:m.name)||"外国"} 升级 ${C.name} Lv${A} → Lv${k}，花费 ${T.toFixed(0)}，预计ROI ${(le*100).toFixed(1)}%`),l.push({investmentId:b.id,investmentIndex:M,buildingId:C.id,fromLevel:A,toLevel:k,cost:T,ownerNationId:b.ownerNationId,profitGain:O,roi:le}),f[M]={...b,upgradeLevel:k,lastUpgradeDay:s,dailyProfit:B};const se=(m==null?void 0:m.name)||"外国";u.push(`🏭 ${se}升级了在本国的 ${C.name}（Lv${A} → Lv${k}，花费 ${Math.ceil(T)} 银）`)}),{updatedInvestments:f,upgrades:l,logs:u}}function Fn(e,t,o){const i=(o==null?void 0:o.prices)||{};let r=0;const a=(t==null?void 0:t.output)||e.output||{};Object.entries(a).forEach(([p,d])=>{var h;if(p==="maxPop"||p==="militaryCapacity")return;const v=i[p]||((h=De[p])==null?void 0:h.basePrice)||1;r+=d*v});let s=0;const u=(t==null?void 0:t.input)||e.input||{};Object.entries(u).forEach(([p,d])=>{var h;const v=i[p]||((h=De[p])==null?void 0:h.basePrice)||1;s+=d*v});let l=0;const f=(t==null?void 0:t.jobs)||e.jobs||{};return Object.entries(f).forEach(([p,d])=>{e.owner&&p===e.owner||(l+=d*10)}),r-s-l}function Pu({overseasInvestments:e=[],nations:t=[],classWealth:o={},marketPrices:i={},daysElapsed:r=0}){const a=[],s=[],u=[...e],l={},f=60,p=.03,d=.05,v=1e4;return e.forEach((h,b)=>{var Y,ce;if(h.status!=="operating")return;const M=h.lastUpgradeDay||0;if(r-M<f||Math.random()>p)return;const g=Vt.find(oe=>oe.id===h.buildingId);if(!g)return;const C=In(g.id);if(C<=0)return;const x=h.ownerStratum||"capitalist",m=o[x]||0;if(m<v)return;const _=h.upgradeLevel||0;if(_>=C)return;const A=_+1,k=t.find(oe=>oe.id===h.targetNationId),D=((Y=k==null?void 0:k.market)==null?void 0:Y.prices)||(k==null?void 0:k.prices)||{},P=kn(g.id,A,0);if(!P)return;let T=0;for(const[oe,fe]of Object.entries(P))if(oe==="silver")T+=fe;else{const Te=i[oe]||1;T+=fe*Te}const R=m*.2;if(T>R)return;const V=Ot(g,_),N=Ot(g,A),F=Fn(g,V,{prices:D}),B=Fn(g,N,{prices:D}),O=B-F;if(O<=0)return;const le=O*365/T;if(le<d)return;const se=(k==null?void 0:k.name)||"海外";Ki("overseas",`🏭 [海外升级] ${x} 升级 ${se} 的 ${g.name} Lv${_} → Lv${A}，花费 ${T.toFixed(0)}，预计ROI ${(le*100).toFixed(1)}%`),s.push({investmentId:h.id,investmentIndex:b,buildingId:g.id,fromLevel:_,toLevel:A,cost:T,ownerStratum:x,targetNationId:h.targetNationId,profitGain:O,roi:le}),u[b]={...h,upgradeLevel:A,lastUpgradeDay:r,dailyProfit:B},l[x]=(l[x]||0)-T;const $=((ce=ae[x])==null?void 0:ce.name)||x;a.push(`🏭 ${$}升级了在 ${se} 的 ${g.name}（Lv${_} → Lv${A}，花费 ${Math.ceil(T)} 银）`)}),{updatedInvestments:u,upgrades:s,wealthChanges:l,logs:a}}const Au=({tradeRoutes:e,nations:t,resources:o,daysElapsed:i,market:r,popStructure:a,taxPolicies:s,diplomacyOrganizations:u})=>{const l=(e==null?void 0:e.routes)||[];if(!l.length)return null;const f=(u==null?void 0:u.organizations)||[],p=D=>f.find(P=>Array.isArray(P==null?void 0:P.members)&&P.members.includes("player")&&P.members.includes(D)),d=(D,P)=>{var V,N,F,B;let T=0;const R=p(D);if(R&&(T=Math.max(T,((V=Ma[R.type])==null?void 0:V.tariffDiscount)||0)),P&&P.vassalOf==="player"){const O=(N=P.vassalPolicy)==null?void 0:N.tradePolicy,H=((F=nr[O])==null?void 0:F.tariffDiscount)||0,le=((B=Rn[P.vassalType])==null?void 0:B.tariffDiscount)||0;T=Math.max(T,H,le)}return T},v=(D,P)=>{var V,N;if(!D||D.vassalOf!=="player")return 1;const T=(V=D.vassalPolicy)==null?void 0:V.tradePolicy,R=((N=nr[T])==null?void 0:N.playerPriceMod)||0;return P==="import"?1+Math.min(0,R):1+Math.max(0,R)},h=.05,b=.1,M=(a==null?void 0:a.merchant)||0,g=[],C=[];let x=0;const m={},_={},A=(D,P)=>{!Number.isFinite(P)||P===0||(m[D]=(m[D]||0)+P)},k=(D,P)=>{!D||!P||(_[D]||(_[D]={budget:0,relation:0,inventory:{}}),Number.isFinite(P.budget)&&(_[D].budget+=P.budget),Number.isFinite(P.relation)&&(_[D].relation+=P.relation),P.inventory&&Object.entries(P.inventory).forEach(([T,R])=>{!Number.isFinite(R)||R===0||(_[D].inventory[T]=(_[D].inventory[T]||0)+R)}))};return l.forEach((D,P)=>{var oe,fe,Te,xe,Ve,ye,z,Oe,Ze,je,Ct,K,pe,he;const{nationId:T,resource:R,type:V}=D,N=t.find(It=>It.id===T);if(!N){g.push(D);return}if(P>=M||N.isAtWar)return;const F=ki(R,N,i),B=(Te=(oe=r==null?void 0:r.prices)==null?void 0:oe[R])!=null?Te:((fe=De[R])==null?void 0:fe.basePrice)||1,O=vr(R,N,i),H=(D==null?void 0:D.mode)||"normal",le=H==="force_sell",se=H==="force_buy",$=!!(N!=null&&N.openMarketUntil&&i<N.openMarketUntil),Y=_a(N,i),ce=$||Y.allowForceTrade||Y.bypassRelationCap;if(V==="export"){if(!le&&(!F.isShortage||F.shortageAmount<=0))return;const It=(o[R]||0)+(m[R]||0),ot=Math.max(0,It-500);if(ot<=b)return;const zt=Math.max(0,F.shortageAmount||0),mt=(le?ot:Math.min(ot,zt))*h;if(mt<b)return;const _t=B*mt,Ut=((xe=s==null?void 0:s.resourceTaxRates)==null?void 0:xe[R])||0,Oo=(Oe=(z=(Ve=s==null?void 0:s.exportTariffMultipliers)==null?void 0:Ve[R])!=null?z:(ye=s==null?void 0:s.resourceTariffMultipliers)==null?void 0:ye[R])!=null?Oe:0,mi=d(T,N),Ee=Oo*(1-mi),Le=Ut+Ee,pt=_t*Le;let it=le?O*.6:O;it*=v(N,"export");const oo=it*mt;if(oo-_t-pt<=0)return;A(R,-mt),x+=pt,k(T,{budget:-oo,relation:le?ce?.2:-.6:.2,inventory:{[R]:mt}})}else if(V==="import"){if(!se&&(!F.isSurplus||F.surplusAmount<=0))return;const It=Math.max(0,F.surplusAmount||0),ie=Math.max(10,F.target||0),zt=(se?ie:It)*h;if(zt<b)return;let mt=se?O*1.3:O;mt*=v(N,"import");const _t=mt*zt,Ut=B*zt,Oo=((Ze=s==null?void 0:s.resourceTaxRates)==null?void 0:Ze[R])||0,mi=(pe=(K=(je=s==null?void 0:s.importTariffMultipliers)==null?void 0:je[R])!=null?K:(Ct=s==null?void 0:s.resourceTariffMultipliers)==null?void 0:Ct[R])!=null?pe:0,Ee=d(T,N),Le=mi*(1-Ee),pt=Oo+Le,kt=Ut*pt,it=Ut-_t-kt;if(it<=0)return;A(R,zt),x+=kt,k(T,{budget:_t,relation:se?ce?.2:-.6:.2,inventory:{[R]:-zt}}),zt>=1&&!se&&C.push(`🚢 进口 ${zt.toFixed(1)} ${((he=De[R])==null?void 0:he.name)||R} 从 ${N.name}：商人国外购 ${_t.toFixed(1)} 银币，国内售 ${Ut.toFixed(1)} 银币（税 ${kt.toFixed(1)}），商人赚 ${it.toFixed(1)} 银币。`)}}),{tradeTax:x,resourceDelta:m,nationDelta:_,routesToRemove:g,tradeLog:C}},Ru=e=>ic[e]||e,Su=(e,t)=>!Number.isFinite(e==null?void 0:e.endDay)||t<e.endDay,Iu=({nation:e,tick:t,resources:o,logs:i,onTreasuryChange:r})=>{const a=Array.isArray(e.treaties)?e.treaties:[],s=[],u=[];let l=0;if(a.forEach(f=>{Su(f,t)?(s.push(f),f.direction==="player_to_ai"&&Number.isFinite(f.maintenancePerDay)&&(l+=Math.max(0,f.maintenancePerDay))):u.push(f)}),u.length>0&&u.forEach(f=>{i.push(`Treaty with ${e.name} expired (${Ru(f.type)}).`)}),l>0&&o){const f=o.silver||0,p=Math.max(0,Math.min(f,l));o.silver=f-p,typeof r=="function"&&p>0&&r(-p,"treaty_maintenance"),e.budget=(e.budget||0)+p,e.wealth=(e.wealth||0)+p}e.treaties=s},ku=({resources:e,buildings:t,population:o,popStructure:i={},birthAccumulator:r=0,decrees:a,gameSpeed:s,epoch:u,market:l,classWealth:f,classApproval:p={},activeBuffs:d=[],activeDebuffs:v=[],taxPolicies:h,army:b={},militaryWageRatio:M=1,militaryQueue:g=[],nations:C=[],diplomacyOrganizations:x=null,tick:m=0,techsUnlocked:_=[],activeFestivalEffects:A=[],classWealthHistory:k,classNeedsHistory:D,merchantState:P={pendingTrades:[],lastTradeTime:0},tradeRouteTax:T=0,maxPopBonus:R=0,eventApprovalModifiers:V={},eventStabilityModifier:N=0,currentStability:F=50,eventResourceDemandModifiers:B={},eventStratumDemandModifiers:O={},eventBuildingProductionModifiers:H={},livingStandardStreaks:le={},buildingUpgrades:se={},rulingCoalition:$=[],previousLegitimacy:Y=0,migrationCooldowns:ce={},difficulty:oe,officials:fe=[],activeDecrees:Te,officialsPaid:xe=!0,quotaTargets:Ve={},expansionSettings:ye={},cabinetStatus:z={},priceControls:Oe=null,previousTaxShock:Ze={},eventEffectSettings:je={},foreignInvestments:Ct=[],overseasInvestments:K=[],tradeRoutes:pe={},foreignInvestmentPolicy:he="normal",tradeOpportunities:It=null})=>{var js,Ns,Ls,Fs,Us,$s,Gs,Vs,qs,Hs,Ys,Xs,zs,Js,Zs,Qs,Ks,ec,tc,oc;const ie={...e},ot={...(l==null?void 0:l.prices)||{}};let zt=0,$e=null;pe&&pe.routes&&pe.routes.length>0&&($e=Au({tradeRoutes:pe,nations:C,resources:ie,daysElapsed:m,market:{prices:ot},popStructure:i,taxPolicies:h,diplomacyOrganizations:x}),$e&&(zt=$e.tradeTax||0));const mt=new Map,_t={record:(n,c)=>{if(!Number.isFinite(n)||n===0)return;const y=c||"unknown";mt.set(y,(mt.get(y)||0)+n)},push:n=>{if(!n||!Number.isFinite(n.amount)||n.amount===0)return;const c=n.reason||"unknown";mt.set(c,(mt.get(c)||0)+n.amount)},toArray:()=>Array.from(mt.entries()).map(([n,c])=>({amount:c,reason:n})),get length(){return mt.size}},Ut=(n,c)=>{_t.record(n,c)},Oo={},mi=(n,c,y)=>{Oo[n]||(Oo[n]=[]),Oo[n].push({amount:c,reason:y,balance:ie[n]||0})},Ee=(n,c,y)=>{c!==0&&(ie[n]=(ie[n]||0)+c,mi(n,c,y),n==="silver"&&Ut(c,y))},Le=(n,c)=>{Ee("silver",n,c)},pt=zt;$e&&$e.resourceDelta&&Object.entries($e.resourceDelta).forEach(([n,c])=>{Ee(n,c,"trade_route_transaction")});const kt=(n,c,y)=>{Ee(y,n,c)},it={},oo=ie.silver||0;let co=[...K],Vo=[...Ct],So=[];const jo={},ht={},vo={},rs={};Object.keys(ae).length>0&&Object.keys(ae).forEach(n=>{ht[n]={income:{wage:0,ownerRevenue:0,subsidy:0,salary:0,militaryPay:0,tradeImportRevenue:0,layoffTransfer:0},expense:{headTax:0,transactionTax:0,businessTax:0,tariffs:0,essentialNeeds:{},luxuryNeeds:{},decay:0,productionCosts:0,wages:0,tradeExportPurchase:0,capitalFlight:0,buildingCost:0,layoffTransfer:0}}});const Un=(C||[]).some(n=>n.isAtWar===!0),ss=3,qt=h||{},cs=qt.headTaxRates||{},ls=qt.resourceTaxRates||{},Du=qt.businessTaxRates||{},$n=L0(ot,cs,ls);jn($n,(Lt==null?void 0:Lt.price)||{});const Yo=jn($n,(Lt==null?void 0:Lt.wage)||{}),gi=(l==null?void 0:l.wages)||{},an=n=>{const c=Yo==null?void 0:Yo[n];return!Number.isFinite(c)||c<=0?Wn*.8:Math.max(Wn*.8,c*1.1)},ho=n=>{var w;const c=gi==null?void 0:gi[n];if(Number.isFinite(c)&&c>0)return Math.max(Wi,c);const y=(w=ae[n])==null?void 0:w.startingWealth;return Number.isFinite(y)&&y>0?Math.max(Wn*.5,y/40,an(n)):Math.max(Xu,an(n))},mo={},rn={},Io={},We=K0(f),ai=n=>jr(n,cs),ji=n=>{const c=ls[n];return typeof c=="number"?c:0},Wu=n=>{const c=Du[n];return typeof c=="number"?c:1},$t=N0(),nt=new U0({resources:ie,wealth:We,officials:fe,classFinancialData:ht,taxBreakdown:$t,silverChangeLog:_t,buildingFinancialData:vo,classWealthChangeLog:it},{safeWealth:Ji}),W=nl();if(K.length>0){const n=Eu({overseasInvestments:K,nations:C,organizations:(x==null?void 0:x.organizations)||[],resources:ie,marketPrices:ot,classWealth:We,daysElapsed:m});co=n.updatedInvestments,So.push(...n.logs),n.profitByStratum&&Object.entries(n.profitByStratum).forEach(([y,w])=>{w>0&&(We[y]=(We[y]||0)+w,ht[y]&&(ht[y].income.ownerRevenue=(ht[y].income.ownerRevenue||0)+w))}),n.playerInventoryChanges&&Object.entries(n.playerInventoryChanges).forEach(([y,w])=>{Ee(y,w,"overseas_investment_return")}),n.marketChanges&&Object.entries(n.marketChanges).forEach(([y,w])=>{const E=C.find(I=>I.id===y);E&&E.inventory&&Object.entries(w).forEach(([I,q])=>{E.inventory[I]=Math.max(0,(E.inventory[I]||0)+q)})});const c=Pu({overseasInvestments:co,nations:C,classWealth:We,marketPrices:ot,daysElapsed:m});c.upgrades&&c.upgrades.length>0&&(co=c.updatedInvestments,So.push(...c.logs),c.wealthChanges&&Object.entries(c.wealthChanges).forEach(([y,w])=>{We[y]=Math.max(0,(We[y]||0)+w)}))}z.effects&&(z.effects.adminEfficiency&&(W.taxEfficiencyBonus=(W.taxEfficiencyBonus||0)+z.effects.adminEfficiency),z.effects.stabilityMod&&(W.stabilityBonus=(W.stabilityBonus||0)+z.effects.stabilityMod),z.effects.tradeBonusMod&&(W.tradeBonusMod=(W.tradeBonusMod||0)+z.effects.tradeBonusMod),z.effects.diplomaticRelationsMod&&(W.diplomaticBonus=(W.diplomaticBonus||0)+z.effects.diplomaticRelationsMod),z.effects.approvalBonus&&Object.entries(z.effects.approvalBonus).forEach(([n,c])=>{W.stanceApprovalEffects=W.stanceApprovalEffects||{},W.stanceApprovalEffects[n]=(W.stanceApprovalEffects[n]||0)+c}),z.effects.organizationGrowthMod&&(W.organizationGrowthMod=(W.organizationGrowthMod||0)+z.effects.organizationGrowthMod),z.effects.researchSpeed&&(W.scienceBonus=(W.scienceBonus||0)+z.effects.researchSpeed)),z.decreeEffects&&Ho(z.decreeEffects,W);const lt=Cl(fe,xe),Bu={...lt,passive:lt.passiveGains,passivePercent:lt.passivePercentGains,resourceDemandMod:lt.decreeResourceDemandMod,stratumDemandMod:lt.decreeStratumDemandMod,maxPop:lt.extraMaxPop,incomePercent:lt.incomePercentBonus};Ho(Bu,W),lt.researchSpeed&&(W.scienceBonus=(W.scienceBonus||0)+lt.researchSpeed),W.taxEfficiencyBonus=lt.taxEfficiency||0,W.corruption=lt.corruption||0,lt.incomePercentBonus&&(W.incomePercentBonus=(W.incomePercentBonus||0)+lt.incomePercentBonus),W.populationGrowthBonus=lt.populationGrowth||0,W.militaryUpkeepMod=lt.militaryUpkeep||0,W.tradeBonusMod=lt.tradeBonus||0,W.buildingCostMod=lt.buildingCostMod||0,W.wartimeProduction=lt.wartimeProduction||0,W.resourceWaste=lt.resourceWaste||{},W.coalitionApproval=lt.coalitionApproval||0,W.legitimacyBonus=lt.legitimacyBonus||0,W.organizationGrowthMod=(W.organizationGrowthMod||0)+(lt.organizationDecay||0),W.factionConflict=(W.factionConflict||0)+(lt.factionConflict||0),W.diplomaticCooldown=lt.diplomaticCooldown||0,W.diplomaticIncident=lt.diplomaticIncident||0,W.diplomaticBonus=lt.diplomaticBonus||0,W.officialProductionInputCost=lt.productionInputCost||{};const Ou={classApproval:p,classInfluence:(l==null?void 0:l.classInfluence)||{},totalInfluence:(l==null?void 0:l.totalInfluence)||1,classLivingStandard:(l==null?void 0:l.classLivingStandard)||{},classIncome:(l==null?void 0:l.classIncome)||{},stability:F/100,legitimacy:Y,taxPolicies:qt,rulingCoalition:$,atWar:Un,population:o,epoch:u,buildings:t},Qe=Pl(fe,Ou).aggregatedEffects;Qe.stability&&(W.stabilityBonus=(W.stabilityBonus||0)+Qe.stability),Qe.legitimacyBonus&&(W.legitimacyBonus=(W.legitimacyBonus||0)+Qe.legitimacyBonus),Qe.gatherBonus&&(W.categoryBonuses.gather=(W.categoryBonuses.gather||0)+Qe.gatherBonus),Qe.industryBonus&&(W.categoryBonuses.industry=(W.categoryBonuses.industry||0)+Qe.industryBonus),Qe.tradeBonus&&(W.tradeBonusMod=(W.tradeBonusMod||0)+Qe.tradeBonus),Qe.researchSpeed&&(W.scienceBonus=(W.scienceBonus||0)+Qe.researchSpeed),Qe.taxEfficiency&&(W.taxEfficiencyBonus=(W.taxEfficiencyBonus||0)+Qe.taxEfficiency),Qe.incomePercentBonus&&(W.incomePercentBonus=(W.incomePercentBonus||0)+Qe.incomePercentBonus),Qe.buildingCostMod&&(W.buildingCostMod=(W.buildingCostMod||0)+Qe.buildingCostMod),Qe.needsReduction&&(W.needsReduction=(W.needsReduction||0)+Qe.needsReduction),Qe.populationGrowth&&(W.populationGrowthBonus=(W.populationGrowthBonus||0)+Qe.populationGrowth),Qe.militaryBonus&&(W.militaryBonus=(W.militaryBonus||0)+Qe.militaryBonus),Qe.organizationDecay&&(W.organizationGrowthMod=(W.organizationGrowthMod||0)+Qe.organizationDecay),Qe.cultureBonus&&(W.cultureBonus=(W.cultureBonus||0)+Qe.cultureBonus),Qe.diplomaticBonus&&(W.diplomaticBonus=(W.diplomaticBonus||0)+Qe.diplomaticBonus),W.stanceApprovalEffects=Qe.approval||{},W.stanceProductionInputCost=Qe.productionInputCost||{};const{buildingBonuses:Gn,categoryBonuses:Vn,passiveGains:ju,passivePercentGains:Nu,perPopPassiveGains:Lu,decreeResourceDemandMod:sn,decreeStratumDemandMod:cn,decreeResourceSupplyMod:Ia}=W;let{decreeSilverIncome:yi,decreeSilverExpense:Ni,extraMaxPop:us,maxPopPercent:ka,productionBonus:Da,industryBonus:Wa,taxBonus:Fu,needsReduction:fs}=W;al(_,W);const Uu=Te?Object.entries(Te).map(([n,c])=>({id:n,active:!0,modifiers:(c==null?void 0:c.effects)||(c==null?void 0:c.modifiers)})):[],$u=Array.isArray(a)?a.filter(n=>n&&n.active):[];rl([...Uu,...$u],W),sl(A,W),Array.isArray(d)&&d.forEach(n=>{Ho(n,W)}),Array.isArray(v)&&v.forEach(n=>{Ho(n,W)});let qn=null;if($&&$.length>0){const n=ol({popStructure:i,classWealthResult:f}),c=W0($,n.classInfluence);qn=C0(c.name),cl(qn,W)}pi&&pi[u]&&pi[u].bonuses&&Ho(pi[u].bonuses,W),yi=W.decreeSilverIncome,Ni=W.decreeSilverExpense,us=W.extraMaxPop,ka=W.maxPopPercent,Da=W.productionBonus,Wa=W.industryBonus,Fu=W.taxBonus,fs=W.needsReduction;const Gu=W.incomePercentBonus||0,io=n=>(ot[n]||(ot[n]=Ao(n)),ot[n]=Math.max(Wi,ot[n]),ot[n]);let Hn=null;const Vu=(n,c,y)=>{var w,E;if(n==="silver"&&c>0){ut[y]=(ut[y]||0)+c,nt.transfer("void",y,c,Z.INCOME.OWNER_REVENUE,Z.INCOME.OWNER_REVENUE,{buildingId:Hn});return}if(!(c<=0)&&(ie[n]=(ie[n]||0)+c,Jt(n))){Io[n]=(Io[n]||0)+c;const I=io(n),S=((w=z==null?void 0:z.dominance)==null?void 0:w.panelType)==="plannedEconomy"&&(Oe==null?void 0:Oe.enabled)&&((E=Oe.governmentBuyPrices)==null?void 0:E[n])!==void 0;let G=I;if(S){const te=a0({resourceKey:n,amount:c,marketPrice:I,priceControls:Oe,taxBreakdown:$t,resources:ie,onTreasuryChange:Ut});te.success&&(G=te.effectivePrice)}const X=G*c;ut[y]=(ut[y]||0)+X,nt.transfer("void",y,X,Z.INCOME.OWNER_REVENUE,Z.INCOME.OWNER_REVENUE,{buildingId:Hn})}},_e={},no=t,qu=new Set,Zt={},Xo={},ut={},Yn={};let No=5,ds=0;No+=us,No+=R,gr(b),uc(b),Object.values(b).reduce((n,c)=>n+c,0),Ht.forEach(n=>Zt[n]=0),Ht.forEach(n=>{Xo[n]={totalSlots:0,weightedWage:0},ut[n]=0});const Lo={},bi={};Ht.forEach(n=>{Lo[n]=0,bi[n]=0});const wt={};Object.keys(ae).forEach(n=>{wt[n]=0});const Mi={};Object.keys(ae).forEach(n=>{Mi[n]=0}),Object.keys(ae).forEach(n=>{}),Vt.forEach(n=>{const c=no[n.id]||0;if(c>0){const y=se[n.id]||{};let w=0;Object.entries(y).forEach(([q,S])=>{const G=parseInt(q);Number.isFinite(G)&&G>0&&S>0&&(w+=S)});const I={0:Math.max(0,c-w)};Object.entries(y).forEach(([q,S])=>{const G=parseInt(q);Number.isFinite(G)&&G>0&&S>0&&(I[G]=S)}),Object.entries(I).forEach(([q,S])=>{var be,me;if(S<=0)return;const G=parseInt(q),U=Ot(n,G);let X=1+(Gn[n.id]||0);const te=1+(Vn[n.cat]||0);if(X*=te,(be=U.output)!=null&&be.maxPop&&(No+=U.output.maxPop*X*S),(me=U.output)!=null&&me.militaryCapacity&&(ds+=U.output.militaryCapacity*X*S),U.jobs)for(let Me in U.jobs)Zt[Me]=(Zt[Me]||0)+U.jobs[Me]*S;U.output&&Object.entries(U.output).forEach(([Me,at])=>{De[Me]&&(at||0)>0&&qu.add(Me)})})}});const Ba={};(fe||[]).forEach(n=>{(n.ownedProperties||[]).forEach(c=>{c.buildingId&&(Ba[c.buildingId]=(Ba[c.buildingId]||0)+1)})}),Object.entries(Ba).forEach(([n,c])=>{const y=Vt.find(I=>I.id===n);if(!y||!y.owner||!y.jobs)return;const w=y.owner,E=y.jobs[w]||0;if(E>0&&Zt[w]){const I=E*c;Zt[w]=Math.max(0,Zt[w]-I)}});const Oa={};(Ct||[]).forEach(n=>{n.status==="operating"&&n.buildingId&&(Oa[n.buildingId]=(Oa[n.buildingId]||0)+1)}),Object.entries(Oa).forEach(([n,c])=>{const y=Vt.find(I=>I.id===n);if(!y||!y.owner||!y.jobs)return;const w=y.owner,E=y.jobs[w]||0;if(E>0&&Zt[w]){const I=E*c;Zt[w]=Math.max(0,Zt[w]-I)}});const ln=new Set;if(Vt.forEach(n=>{var w;const c=((w=n.epoch)!=null?w:0)<=u,y=!n.requiresTech||_.includes(n.requiresTech);c&&y&&n.output&&Object.entries(n.output).forEach(([E,I])=>{De[E]&&(I||0)>0&&ln.add(E)})}),ka!==0){const n=Math.max(0,1+ka);No=Math.max(0,No*n)}No=Math.floor(No);let ps=0;Object.entries(b).forEach(([n,c])=>{if(!c||c<=0)return;const y=To[n],w=(y==null?void 0:y.populationCost)||1;ps+=c*w});const Hu=(g||[]).reduce((n,c)=>{if(c.status==="waiting"||c.status==="training"){const y=To[c.unitId],w=(y==null?void 0:y.populationCost)||1;return n+w}return n},0),hs=ps+Hu;hs>0&&(Zt.soldier=(Zt.soldier||0)+hs);const Yu=i&&Object.keys(i).length>0;let J={},un=0;if(Yu){Ht.forEach(c=>{const y=i[c]||0;J[c]=Math.max(0,y)}),J.unemployed=Math.max(0,i.unemployed||0);const n=Ht.reduce((c,y)=>c+(J[y]||0),0)+(J.unemployed||0);if(un=o-n,un>0)J.unemployed=(J.unemployed||0)+un;else if(un<0){let c=-un;const y=Math.min(J.unemployed||0,c);if(y>0&&(J.unemployed-=y,c-=y),c>0){const w=Ht.reduce((E,I)=>E+(J[I]||0),0);if(w>0){const E=c;Ht.forEach((I,q)=>{if(c<=0)return;const S=J[I]||0;if(S<=0)return;const G=S/w;let U=Math.floor(G*E);U<=0&&c>0&&(U=1),q===Ht.length-1?U=Math.min(S,c):U=Math.min(S,Math.min(U,c)),!(U<=0)&&(J[I]=S-U,c-=U)}),c>0&&Ht.forEach(I=>{if(c<=0)return;const q=J[I]||0;if(q<=0)return;const S=Math.min(q,c);J[I]=q-S,c-=S})}}}}else{let n=o;Ht.forEach(c=>{const y=Math.max(0,Zt[c]||0),w=Math.min(n,y);J[c]=w,n-=w}),J.unemployed=Math.max(0,n)}J.unemployed=Math.max(0,J.unemployed||0);const Xu=F0(J,gi);Ht.forEach(n=>{if(n==="official")return;const c=J[n]||0,y=Math.max(0,Zt[n]||0);if(c>y){const w=c-y,E=We[n]||0,I=c>0?E/c:0;if(J[n]=y,J.unemployed=(J.unemployed||0)+w,I>0){const q=I*w;nt.transfer(n,"unemployed",q,Z.EXPENSE.LAYOFF_TRANSFER,Z.EXPENSE.LAYOFF_TRANSFER)}}});const zu=Array.isArray(fe)?fe.length:0;J.official=zu,We.official=0;let Ju=1,fn=0,ja=Br(Y);const ri=Math.max(0,Ju*ja*(1+(W.taxBonus||0))),Zu=n=>{let y=0,w=0,E=0,I=0;Vt.forEach(U=>{var at,ft,Xe,Ke,ge,Ne,He;const X=no[U.id]||0;if(X<=0)return;const te=Ot(U,0),be=te.jobs||{},me=be[n]||0;if(me<=0)return;if(U.owner===n){let Pe=0;te.output&&Object.entries(te.output).forEach(([Ie,Re])=>{if(!De[Ie])return;const Ce=ot[Ie]||Ao(Ie);Pe+=Re*Ce});let ze=0;te.input&&Object.entries(te.input).forEach(([Ie,Re])=>{const Ce=ot[Ie]||Ao(Ie);ze+=Re*Ce});let de=0;Object.entries(be).forEach(([Ie,Re])=>{var Tt,Et;if(Ie===n||!Re||Re<=0)return;const Ce=(Et=(Tt=l==null?void 0:l.wages)==null?void 0:Tt[Ie])!=null?Et:ho(Ie);de+=Ce*Re});const qe=((ft=(at=ae[n])==null?void 0:at.headTaxBase)!=null?ft:.01)*ai(n)*ri,Se=(Xe=U.businessTaxBase)!=null?Xe:.1,dt=(ge=(Ke=qt==null?void 0:qt.businessTaxRates)==null?void 0:Ke[U.id])!=null?ge:1,et=Se*dt,Wt=Pe-ze-de-qe-et,Fe=me>0?Wt/me:0;y+=Fe*me*X,w+=me*X}else{const Pe=(He=(Ne=l==null?void 0:l.wages)==null?void 0:Ne[n])!=null?He:ho(n);E+=Pe*me*X,I+=me*X}});const q=w+I;if(q<=0)return ho(n);const G=(y+E)/q;return Math.max(ho(n),G*1.2)};Z0({popStructure:J,jobsAvailable:Zt,wealth:We,getExpectedWage:n=>{if((J[n]||0)<=5){const y=Zu(n),w=ho(n);return Math.max(y,w)}return ho(n)},getHeadTaxRate:ai,effectiveTaxModifier:ri});const wo={},lo={},uo={},xt={},Ge=[],Xn=new Map,dn={},Na={},vi=n=>{if(!n)return;const c=Xn.get(n)||0;Xn.set(n,c+1)};Object.entries(ju).forEach(([n,c])=>{if(!c)return;const y=c,w=ie[n]||0;if(y>=0)Ee(n,y,"passive_gain"),_e[n]=(_e[n]||0)+y;else{const E=Math.abs(y),I=Math.min(w,E);I>0&&(Ee(n,-I,"passive_cost"),_e[n]=(_e[n]||0)-I)}});const La=o||0;Object.entries(Lu||{}).forEach(([n,c])=>{if(!c||La<=0)return;const y=c*La,w=ie[n]||0;if(y>=0)Ee(n,y,"passive_pop_gain"),_e[n]=(_e[n]||0)+y;else{const E=Math.abs(y),I=Math.min(w,E);I>0&&(Ee(n,-I,"passive_pop_cost"),_e[n]=(_e[n]||0)-I)}}),Object.entries(Nu||{}).forEach(([n,c])=>{if(!c)return;const y=_e[n]||0;if(y!==0){const w=Math.abs(y)*c;y>=0?(Ee(n,w,"passive_percent_gain"),_e[n]=y+w):(Ee(n,-w,"passive_percent_cost"),_e[n]=y-w)}else{const E=La*.01*c;Ee(n,E,"passive_percent_base_gain"),_e[n]=(_e[n]||0)+E}});const Fa={},Ua=1-Math.max(-2,Math.min(.95,fs||0)),ms={};Object.keys(ae).forEach(n=>{ms[n]=We[n]||0}),Object.keys(ae).forEach(n=>{var X,te,be;if(n==="official")return;const c=J[n]||0;if(c===0)return;const y=ae[n];We[n]===void 0&&(We[n]=y.startingWealth||0);const w=ai(n),I=((te=(X=ae[n])==null?void 0:X.headTaxBase)!=null?te:.01)*w*ri,q=Math.max(0,We[n]||0),S=q/Math.max(1,c),G=I>=0?Math.min(I,S):I,U=c*G;if(U!==0)if(U>0){const me=Math.min(q,U);nt.transfer(n,"state",me,Z.EXPENSE.HEAD_TAX,Z.EXPENSE.HEAD_TAX),Mi[n]=(Mi[n]||0)+me,wt[n]=(wt[n]||0)+me,bi[n]=(bi[n]||0)+me}else{const me=-U;(ie.silver||0)>=me&&(nt.transfer("state",n,me,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),ut[n]=(ut[n]||0)+me,Lo[n]=(Lo[n]||0)+me)}wo[n]=(be=p[n])!=null?be:50,(wo[n]||0)<=0&&(Fa[n]=!0)});const Qu=!!(Te&&Te.forced_labor);Vt.forEach(n=>{var En,qo,Cn,_n,ya,$o,Tn,oi,_o;const c=no[n.id]||0;if(c===0)return;const y=se[n.id]||{},w={input:{},output:{},jobs:{}};let E=0,I=!1;Object.entries(y).forEach(([j,L])=>{const Q=parseInt(j);Number.isFinite(Q)&&Q>0&&L>0&&(E+=L,I=!0)});const q=Math.max(0,c-E),S={0:q};Object.entries(y).forEach(([j,L])=>{const Q=parseInt(j);Number.isFinite(Q)&&Q>0&&L>0&&(S[Q]=L)});const G={};Object.entries(S).forEach(([j,L])=>{if(L<=0)return;const Q=parseInt(j),ne=Ot(n,Q).owner||"state";G[ne]||(G[ne]={levels:{},totalCount:0}),G[ne].levels[Q]=L,G[ne].totalCount+=L}),Object.keys(G).forEach(j=>{var L;We[j]===void 0&&(We[j]=((L=ae[j])==null?void 0:L.startingWealth)||0)}),n.owner;let U=1;if(!I&&q===c){if(n.input)for(const[j,L]of Object.entries(n.input))w.input[j]=L*c;if(n.output)for(const[j,L]of Object.entries(n.output))w.output[j]=L*c;if(n.jobs)for(const[j,L]of Object.entries(n.jobs))w.jobs[j]=L*c}else for(const[j,L]of Object.entries(S)){if(L<=0)continue;const Q=parseInt(j),ee=Ot(n,Q);if(ee.input)for(const[ne,ue]of Object.entries(ee.input))w.input[ne]=(w.input[ne]||0)+ue*L;if(ee.output)for(const[ne,ue]of Object.entries(ee.output))w.output[ne]=(w.output[ne]||0)+ue*L;if(ee.jobs)for(const[ne,ue]of Object.entries(ee.jobs))w.jobs[ne]=(w.jobs[ne]||0)+ue*L}const X=pi[u];let te=0;X&&X.bonuses&&(n.cat==="gather"&&X.bonuses.gatherBonus&&(te+=X.bonuses.gatherBonus),n.cat==="industry"&&X.bonuses.industryBonus&&(te+=X.bonuses.industryBonus));let be=0,me=0;d.forEach(j=>{j.production&&(be+=j.production),j.industryBonus&&(me+=j.industryBonus)}),v.forEach(j=>{j.production&&(be+=j.production),j.industryBonus&&(me+=j.industryBonus)}),be+=Da,me+=Wa,(n.cat==="gather"||n.cat==="civic")&&(te+=be),n.cat==="industry"&&(te+=me),Un&&W.wartimeProduction&&(te+=W.wartimeProduction);const Me=Vn[n.cat];Me&&Me!==0&&(te+=Me);const at=H[n.id]||0,ft=H[n.cat]||0,Xe=H.all||0;te+=at+ft+Xe;const Ke=Gn[n.id];Ke&&Ke!==0&&(te+=Ke),U*=1+te,vo[n.id]||(vo[n.id]={wagesByRole:{},paidWagePerWorkerByRole:{},filledByRole:{},wagePaidRatioByOwner:{},ownerRevenue:0,productionCosts:0,businessTaxPaid:0});let ge=1,Ne=0,He=0;const Pe={};let ze=0;const de=[];if(Object.keys(w.jobs).length>0){dn[n.id]=dn[n.id]||{};let j=1/0,L=!1;for(let Q in w.jobs){const ee=w.jobs[Q];Xo[Q]||(Xo[Q]={totalSlots:0,weightedWage:0}),Ne+=ee;const ne=Zt[Q],ue=J[Q],we=ne>0?Math.min(1,ue/ne):0,Be=ee*we;He+=Be,dn[n.id][Q]=Be,vo[n.id].filledByRole[Q]=(vo[n.id].filledByRole[Q]||0)+Be;const Ae=Object.keys(G).includes(Q);if(!Ae&&ee>0){L=!0;const Mt=ee>0?Be/ee:0;j=Math.min(j,Mt)}const Ye=Math.max(0,ee-Be);if(Ye>.001){const Mt=Ye>=1?Math.floor(Ye):1;(Yn[Q]||(Yn[Q]=[])).push({buildingId:n.id,buildingName:n.name||n.id,availableSlots:Mt})}if(!Ae&&Be>0){const Mt=(En=Pe[Q])!=null?En:ho(Q),tt=an(Q),Nt=Math.max(Mt,tt);Pe[Q]=Nt,ze+=Be*Nt,de.push({role:Q,ownerKey:n.owner||"state",roleSlots:ee,filled:Be,baseWage:Nt})}}L?ge=j===1/0?0:j:Ne>0&&(ge=He/Ne),Ne>0&&(Na[n.id]=ge)}const rt=U;U*=ge,Qu&&((qo=n.jobs)!=null&&qo.serf||(Cn=n.jobs)!=null&&Cn.miner)&&(U*=1.2);const qe=U,Se=qe>0?qe:rt;let dt=1,et=0,Wt=!1;const Fe=Object.keys(w.input).length>0,Ie=Object.keys(w.output).some(j=>j!=="maxPop"&&j!=="militaryCapacity");if(Fe&&Ie){const j=((_n=W.officialProductionInputCost)==null?void 0:_n[n.id])||0,L=((ya=W.stanceProductionInputCost)==null?void 0:ya[n.id])||0,Q=j+L;if(Q!==0){const ee=1+Q,ne=Math.max(.2,ee);for(const[ue,we]of Object.entries(w.input))w.input[ue]=we*ne}if(W.resourceWaste)for(const[ee,ne]of Object.entries(w.input)){const ue=(($o=W.resourceWaste)==null?void 0:$o[ee])||0;if(!ue)continue;const we=Math.max(0,1+ue);w.input[ee]=ne*we}}if(Object.keys(w.input).length>0)for(const[j,L]of Object.entries(w.input)){if(!Ii(j,u,_))continue;const Q=L,ee=Q*Se;if(ee<=0)continue;const ne=ie[j]||0;if(ne<=0?dt=0:dt=Math.min(dt,ne/ee),Jt(j)){const ue=io(j),we=ji(j);et+=Q*ue*(1+we)}}let Re=qe*Math.max(0,Math.min(1,dt)),Ce=Se*Math.max(0,Math.min(1,dt));if(n.cat==="gather"&&dt===0&&Object.keys(w.input).length>0){Re=qe*.2,Ce=Se*.2,Wt=!0,et=0;const j=Object.keys(w.input).map(L=>{var Q;return((Q=De[L])==null?void 0:Q.name)||L}).join("、");m%30===0&&vi(`?? ${n.name} 缺少 ${j}，工人正在徒手作业（效率20%）`)}let Tt=0,Et=!1;if(Object.keys(w.output).length>0)for(const[j,L]of Object.entries(w.output)){if(j==="maxPop"||!Jt(j))continue;Et=!0;const ne=L*io(j);Tt+=ne}const jt=Se>0?ze/Se:ze,ke=Tt*Ce,Ue=et*Ce,Je=jt*Ce,Pt=Math.max(0,ke-Ue),At=Je>0?Pt/Je:1,ro=Number.isFinite(At)?At>=1?Math.min(3,1+(At-1)*.5):Math.max(.65,1-(1-At)*.5):1,st=jt*ro,Eo=st*Ce,ct=n.cat==="civic"&&!n.owner&&((Tn=n.output)==null?void 0:Tn.maxPop)>0,Yt=n.cat==="military",Qt=(oi=n.businessTaxBase)!=null?oi:.1,Rt=ct||Yt?0:Wu(n.id),St=Qt*Rt,Bo=St*c*Ce,Co=et+st;let ve=Re,gt=Ce,Xt=null,Bt=null;const Qo=Math.min(Eo,Pt),fi=Re>0?Qo/Re:0,Ko=et+fi;if(Et){const j=Ue+Qo+Math.max(0,Bo);if(j>0&&ke<=0)ve=0,Xt=0;else if(j>0&&ke<j*.98){const L=Math.max(0,Math.min(1,ke/j));Xt=L,ve=Re*L,gt=Ce*L}else Xt=j>0?ke/j:null;Bt={baseMultiplier:qe,resourceLimit:dt,targetMultiplier:Re,estimatedRevenue:ke,estimatedInputCost:Ue,estimatedWageCost:Eo,actualPayableWageCost:Qo,actualWageCostPerMultiplier:fi,actualOperatingCostPerMultiplier:Ko,estimatedBusinessTax:Bo,estimatedCost:j,marginRatio:Xt,actualMultiplierAfterMargin:ve,outputValuePerMultiplier:Tt,inputCostPerMultiplier:et,wageCostPerMultiplier:st,count:c,expectedWageBillBase:ze,baseWageCostPerMultiplier:jt,wagePressure:ro,baseWageCost:Je,wageCoverage:At,valueAvailableForLabor:Pt,wagePlans:de}}if(Ko>0){let j=1/0;const L=[];Object.entries(G).forEach(([ne,ue])=>{const we=ue.totalCount/c,Be=Ko*we,Ae=We[ne]||0,Ye=Be>0?Ae/Be:1/0;j=Math.min(j,Ye),L.push({owner:ne,proportion:we,operatingCost:Be,cash:Ae,affordable:Ye})});const Q=j===1/0?Re:j,ee=j===1/0?Ce:j;ve=Math.min(ve,Math.max(0,Q)),gt=Math.min(gt,Math.max(0,ee)),Bt&&(Bt.totalOperatingCostPerMultiplier=Co,Bt.minAffordableMultiplier=j,Bt.affordableMultiplier=Q,Bt.actualMultiplierAfterAffordable=ve,Bt.ownerDetails=L)}Bt&&(rs[n.id]=Bt),(!Number.isFinite(ve)||ve<0)&&(ve=0);const re=.3;let bt=1;Object.keys(G).forEach(j=>{Fa[j]&&(bt=Math.min(bt,re))}),Object.keys(w.jobs).length>0&&Object.keys(w.jobs).forEach(j=>{Fa[j]&&(bt=Math.min(bt,re))}),ve*=bt,gt*=bt;const so=qe>0?Math.min(1,ve/qe):0,Kt=Se>0?Math.min(1,gt/Se):0;let bo=0;if(Object.keys(w.input).length>0&&!Wt){const j={};Object.entries(S).forEach(([L,Q])=>{if(Q<=0)return;const ee=parseInt(L),ne=Ot(n,ee);!ne.input||Object.keys(ne.input).length===0||(j[ee]={},Object.entries(ne.input).forEach(([ue,we])=>{j[ee][ue]=we*Q*ve}))});for(const[L,Q]of Object.entries(w.input)){if(!Ii(L,u,_))continue;const ee=Q*ve;if(!ee||ee<=0)continue;const ne=ie[L]||0,ue=Math.min(ee,ne),we=ee>0?ue/ee:0;if(Jt(L)){const Be=io(L),Ae=ji(L);Object.entries(j).forEach(([Ye,Mt])=>{const tt=parseInt(Ye),Nt=Mt[L]||0;if(Nt<=0)return;const Gt=Nt*we;if(Gt<=0)return;const fo=Ot(n,tt).owner||"state",Hi=Gt*Be,Ri=Hi*Ae;let Yi=Hi;if(Ri<0){const Xi=Math.abs(Ri);(ie.silver||0)>=Xi&&(nt.transfer("state",fo,Xi,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),Yi-=Xi,ut[fo]=(ut[fo]||0)+Xi)}else Ri>0&&(nt.transfer(fo,"state",Ri,Z.EXPENSE.RESOURCE_TAX,Z.EXPENSE.RESOURCE_TAX),Yi+=Ri);nt.transfer(fo,"void",Hi,Z.EXPENSE.PRODUCTION_COST,Z.EXPENSE.PRODUCTION_COST,{buildingId:n.id}),wt[fo]=(wt[fo]||0)+Yi,vo[n.id].productionCosts+=Yi}),mo[L]=(mo[L]||0)+ue,rn[L]||(rn[L]={buildings:{},pop:0}),rn[L].buildings[n.id]=(rn[L].buildings[n.id]||0)+ue}ue<=0||(ie[L]=ne-ue,_e[L]=(_e[L]||0)-ue)}}Object.keys(w.jobs).length>0&&Object.entries(w.jobs).forEach(([j,L])=>{const Q=L;Q<=0||(Xo[j]||(Xo[j]={totalSlots:0,weightedWage:0}),Xo[j].totalSlots+=Q)});const ei={};Object.entries(S).forEach(([j,L])=>{const Q=parseInt(j),ee=Ot(n,Q);let ne=0;ee.output&&Object.entries(ee.output).forEach(([tt,Nt])=>{if(tt==="maxPop"||!Jt(tt))return;const eo=Nt*io(tt);ne+=eo});let ue=0;ee.input&&Object.entries(ee.input).forEach(([tt,Nt])=>{Ii(tt,u,_)&&Jt(tt)&&(ue+=Nt*io(tt))});let we=0;const Be=ee.owner||"state";ee.jobs&&Object.entries(ee.jobs).forEach(([tt,Nt])=>{var eo;if(tt===Be)return;const Gt=(eo=Pe[tt])!=null?eo:ho(tt);we+=Nt*Gt});const Ae=Math.max(0,ne-ue),Ye=we>0?Ae/we:1;let Mt=1;Number.isFinite(Ye)?Ye>=1?Mt=Math.min(3,1+(Ye-1)*.5):Mt=Math.max(.65,1-(1-Ye)*.5):Mt=1,ei[Q]=Mt});let xn=0,Uo=0;Object.entries(S).forEach(([j,L])=>{const Q=parseInt(j),ee=ei[Q]||1;xn+=ee*L,Uo+=L});const ti=Uo>0?xn/Uo:ro,Gi=((_o=n.marketConfig)==null?void 0:_o.wage)||{},di=Gi.wageMode,Vi=Gi.subsistenceMultiplier||1.5,qi=de.map(j=>{const L=j.ownerKey||n.owner||"state";let Q=ti;if(Object.keys(S).length>1){let ue=0,we=0;Object.entries(S).forEach(([Be,Ae])=>{var Nt;const Ye=parseInt(Be),tt=((Nt=Ot(n,Ye).jobs)==null?void 0:Nt[j.role])||0;if(tt>0){const Gt=ei[Ye]||1;ue+=Gt*tt*Ae,we+=tt*Ae}}),we>0&&(Q=ue/we)}let ee=j.baseWage*so*Q;di==="subsistence"&&(ee=((Yo==null?void 0:Yo[j.role])||an(j.role))*Vi);const ne=ee*j.filled;return bo+=ne,{...j,ownerKey:L,expectedSlotWage:ee,wagePressure:Q,wageMode:di,subsistenceMultiplier:di==="subsistence"?Vi:void 0}}),Ai={};if(vo[n.id].wagePaidRatioByOwner=Ai,bo>0){const j={};Object.entries(S).forEach(([L,Q])=>{if(Q<=0)return;const ee=parseInt(L),ne=Ot(n,ee),ue=ne.owner||"state";j[ue]||(j[ue]=0),ne.jobs&&Object.entries(ne.jobs).forEach(([we,Be])=>{if(we===ue)return;let Ae;di==="subsistence"?Ae=((Yo==null?void 0:Yo[we])||an(we))*Vi:Ae=ho(we);const Ye=Be*Q*Ae*so*(ei[ee]||1);j[ue]+=Ye})}),Object.entries(j).forEach(([L,Q])=>{if(Q<=0){Ai[L]=0;return}const ee=We[L]||0;let ne=0;const ue=ae[L];ue&&ue.needs&&(Object.entries(ue.needs).forEach(([Ae,Ye])=>{const Mt=io(Ae);ne+=Ye*Mt}),ne*=1.2);const we=Math.max(0,ee-ne),Be=Math.min(we,Q);nt.transfer(L,"void",Be,Z.EXPENSE.WAGES_PAID,Z.EXPENSE.WAGES_PAID,{buildingId:n.id}),wt[L]=(wt[L]||0)+Be,Ai[L]=Q>0?Be/Q:0})}if(qi.forEach(j=>{var ne;const L=(ne=Ai[j.ownerKey])!=null?ne:0,Q=j.expectedSlotWage*L,ee=j.baseWage*Kt*j.wagePressure;if(Xo[j.role].weightedWage+=ee*j.roleSlots,j.filled>0&&Q>0){const ue=Q*j.filled;vo[n.id].wagesByRole[j.role]=(vo[n.id].wagesByRole[j.role]||0)+ue,nt.transfer("void",j.role,ue,Z.INCOME.WAGE,Z.INCOME.WAGE,{buildingId:n.id}),ut[j.role]=(ut[j.role]||0)+ue,Lo[j.role]=(Lo[j.role]||0)+ue}}),Object.entries(vo[n.id].wagesByRole).forEach(([j,L])=>{const Q=vo[n.id].filledByRole[j]||0;Q>0&&(vo[n.id].paidWagePerWorkerByRole[j]=L/Q)}),Object.keys(w.output).length>0){const j={};Object.entries(S).forEach(([L,Q])=>{if(Q<=0)return;const ee=parseInt(L),ne=Ot(n,ee);!ne.output||Object.keys(ne.output).length===0||(j[ee]={},Object.entries(ne.output).forEach(([ue,we])=>{j[ee][ue]=we*Q*ve}))});for(const[L,Q]of Object.entries(w.output)){let ee=Q*ve;if(!ee||ee<=0)continue;let ne=1;if(Jt(L)&&L!=="silver"){const ue=De[L],we=(ue==null?void 0:ue.marketConfig)||{},Be=(Lt==null?void 0:Lt.market)||{},Ae=we.outputVariation!==void 0?we.outputVariation:Be.outputVariation||.2;ne=1+(Math.random()*2-1)*Ae,ee*=ne;const Ye=Ia[L]||0;Ye!==0&&(ee*=1+Ye),L==="science"&&W.scienceBonus&&(ee*=1+W.scienceBonus),L==="culture"&&W.cultureBonus&&(ee*=1+W.cultureBonus)}L!=="maxPop"&&(Jt(L)?(Object.entries(j).forEach(([ue,we])=>{const Be=parseInt(ue),Ae=we[L]||0;if(Ae<=0)return;const Ye=Q*ve,Mt=Ye>0?Ae/Ye:0,tt=ee*Mt;if(tt<=0)return;const Gt=Ot(n,Be).owner||"state";Hn=n.id,Vu(L,tt,Gt),Hn=null}),_e[L]=(_e[L]||0)+ee,jo[L]||(jo[L]={buildings:{},imports:0}),jo[L].buildings[n.id]=(jo[L].buildings[n.id]||0)+ee):L==="silver"?Object.entries(j).forEach(([ue,we])=>{const Be=parseInt(ue),Ae=we[L]||0;if(Ae<=0)return;const Ye=Q*ve,Mt=Ye>0?Ae/Ye:0,tt=ee*Mt;if(tt<=0)return;const Gt=Ot(n,Be).owner||"state";Gt==="state"?Ee(L,tt,"building_production_direct"):nt.transfer("void",Gt,tt,"building_production_direct","building_production_direct",{buildingId:n.id})}):Ee(L,ee,"building_production_direct"))}}if(St!==0&&c>0){const j=St*c*ve;if(j>0)Object.entries(G).forEach(([L,Q])=>{var we;const ee=Q.totalCount/c,ne=j*ee,ue=We[L]||0;ue>=ne?(nt.transfer(L,"state",ne,Z.EXPENSE.BUSINESS_TAX,Z.EXPENSE.BUSINESS_TAX,{buildingId:n.id}),wt[L]=(wt[L]||0)+ne):m%30===0&&ue<ne*.5&&vi(`?? ${((we=ae[L])==null?void 0:we.name)||L} 无力支付 ${n.name} 的营业税，政府放弃征收。`)});else if(j<0){const L=Math.abs(j);(ie.silver||0)>=L?Object.entries(G).forEach(([ee,ne])=>{const ue=ne.totalCount/c,we=L*ue;nt.transfer("state",ee,we,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),ut[ee]=(ut[ee]||0)+we}):m%30===0&&vi(`?? 国库空虚，无法为 ${n.name} 支付营业补贴！`)}}if(n.id==="market"){const j=n.owner||"merchant",L=(J[j]||0)>0,Q=m%5===0;if(L&&Q){let ne=We[j]||0;if(!(ne<=0)){const ue=[];if(Object.entries(ie).forEach(([we,Be])=>{if(!Jt(we)||we==="silver"||(Be||0)<=300||(_e[we]||0)<0)return;const Ae=io(we);ue.push({resource:we,stock:Be,localPrice:Ae})}),ue.length>0){const we=[];if(Object.keys(De).forEach(Be=>{if(!Jt(Be)||Be==="silver")return;const Ae=ie[Be]||0,Ye=_e[Be]||0,Mt=Math.max(0,(mo[Be]||0)-(Io[Be]||0)),tt=Math.max(0,200-Ae),Nt=Ye<0?Math.abs(Ye):0,Gt=Math.max(Mt,tt,Nt);if(Gt<=0)return;const eo=Math.max(Wi,io(Be)*1.15),fo=Gt*eo;fo<=0||we.push({resource:Be,shortageAmount:Gt,importPrice:eo,requiredValue:fo})}),we.length>0){we.sort((Ae,Ye)=>Ye.requiredValue-Ae.requiredValue);const Be=10;we.forEach(Ae=>{var tt,Nt;if(ne<=0)return;let Ye=Ae.shortageAmount,Mt=Ae.requiredValue;for(const Gt of ue){if(ne<=0||Ye<=0||Mt<=0)break;const eo=Gt.resource,fo=Gt.localPrice;if(fo<=0)continue;const Hi=ie[eo]||0;if(Hi<=0)continue;const Ri=Mt/fo,Yi=Hi*.05,Xi=ne/fo,Si=Math.min(Ri,Yi,Xi);if(!Number.isFinite(Si)||Si<=0)continue;const Pn=Si*fo;if(ne-=Pn,nt.transfer(j,"void",Pn,Z.EXPENSE.TRADE_EXPORT_PURCHASE,Z.EXPENSE.TRADE_EXPORT_PURCHASE),wt[j]=(wt[j]||0)+Pn,Ee(eo,-Si,"trade_export_deduction"),Io[eo]=(Io[eo]||0)+Si,_e[eo]=(_e[eo]||0)-Si,Gt.stock=Math.max(0,Gt.stock-Si),Mt=Math.max(0,Mt-Pn),Ae.importPrice<=0)continue;let Go=Pn/Ae.importPrice;if(!Number.isFinite(Go)||Go<=0||(Go=Math.min(Go,Ye),Go<=0))continue;const An=Go*Ae.importPrice;nt.transfer("void",j,An,Z.INCOME.TRADE_IMPORT_REVENUE,Z.INCOME.TRADE_IMPORT_REVENUE),ne+=An,Ee(Ae.resource,Go,"trade_import_gain"),Io[Ae.resource]=(Io[Ae.resource]||0)+Go,_e[Ae.resource]=(_e[Ae.resource]||0)+Go,jo[Ae.resource]||(jo[Ae.resource]={buildings:{},imports:0}),jo[Ae.resource].imports=(jo[Ae.resource].imports||0)+Go,Ye=Math.max(0,Ye-Go),An>0&&(ut[j]=(ut[j]||0)+An),An>Be&&((tt=De[eo])!=null&&tt.name,(Nt=De[Ae.resource])!=null&&Nt.name||Ae.resource)}})}}}}}n.jobs&&Object.entries(n.jobs).forEach(([j,L])=>{L*c<=0})});const Ku=h0(oe),zn=bc(b);Object.keys(zn).forEach(n=>{zn[n]=Math.ceil((zn[n]||0)*Ku)});const gs={};Object.entries(zn).forEach(([n,c])=>{gs[n]=Un?c*ss:c});let Jn=0;const ys={};Object.entries(gs).forEach(([n,c])=>{var q;if(c<=0)return;if(n==="silver"){Jn+=c;return}const y=ie[n]||0,w=Math.min(y,c);w>0&&(ie[n]=y-w,_e[n]=(_e[n]||0)-w,ys[n]=w,mo[n]=(mo[n]||0)+c);const E=io(n);let I=E;if(Oe!=null&&Oe.enabled&&(I=Cr({resourceKey:n,amount:c,marketPrice:E,priceControls:Oe,taxBreakdown:$t,resources:ie,onTreasuryChange:Ut}).effectivePrice),Jn+=c*I,w<c&&m%30===0){const S=c-w;vi(`?? 军队维护资源不足：缺少 ${((q=De[n])==null?void 0:q.name)||n} ${S.toFixed(1)}/日`)}});const bs=1+u*.1,ef=gr(b),Ms=Mc(ef,o),vs=Math.max(.5,M!=null?M:1),ko=Jn*bs*Ms*vs,Zn={dailyExpense:ko,resourceCost:Jn,epochMultiplier:bs,scalePenalty:Ms,wageMultiplier:vs,resourceConsumption:ys};let pn={totalArmyCost:ko,availableSilver:ie.silver,applied:!1,reason:null,logSizeBefore:_t.length};if(ko>0){console.log("[Simulation] Applying military cost:",ko,"Reason:","expense_army_maintenance");const n=ie.silver||0;if(n>=ko){Le(-ko,"expense_army_maintenance"),pn.applied=!0,pn.reason="expense_army_maintenance",_e.silver=(_e.silver||0)-ko,ut.soldier=(ut.soldier||0)+ko,Lo.soldier=(Lo.soldier||0)+ko,ht.soldier&&(ht.soldier.income.militaryPay=(ht.soldier.income.militaryPay||0)+ko);const c=_t[_t.length-1];pn.logEntryFound=c&&c.reason==="expense_army_maintenance",pn.logSizeAfter=_t.length}else if(ko>0){const c=n*.9;c>0&&(Le(-c,"expense_army_maintenance_partial"),_e.silver=(_e.silver||0)-c,ut.soldier=(ut.soldier||0)+c,ht.soldier&&(ht.soldier.income.militaryPay=(ht.soldier.income.militaryPay||0)+c)),Ge.push(`?? 军饷不足！应付${ko.toFixed(0)}银币，仅能支付${c.toFixed(0)}银币，军心不稳。`)}}const wi={},xo={},Qn={},zo={};Object.keys(ae).forEach(n=>{var ge,Ne,He,Pe,ze;if(n==="official"){wi[n]={satisfactionRatio:1,totalTrackedNeeds:0},xo[n]=[];return}const c=ae[n],y=J[n]||0;if(y===0||!c.needs){wi[n]={satisfactionRatio:1,totalTrackedNeeds:0},xo[n]=[];return}let w=0,E=0;const I=[],q=c.startingWealth||1,G=(We[n]||0)/Math.max(1,y)/q,U=c.needs||{};let X=0;["food","cloth"].forEach(de=>{var rt;if(U[de]){const qe=io(de),Se=((rt=De[de])==null?void 0:rt.basePrice)||1,dt=Math.max(qe,Se);X+=U[de]*dt}});const te=(ut[n]||0)/Math.max(1,y),be=X>0?te/X:te>0?10:0,me=Math.max(1,(c.maxConsumptionMultiplier||6)+Ir(oe)),Me=zi(be,G,c.wealthElasticity||1,me),at=Sc(be).level,ft=Tc({consumptionMultiplier:Me,incomeRatio:be,wealthRatio:G,livingStandardLevel:at}),Xe=Pc(be,G,c.wealthElasticity||1,at),Ke={...c.needs};if(c.luxuryNeeds){const de=Object.keys(c.luxuryNeeds).map(Number).sort((rt,qe)=>rt-qe);for(const rt of de)if(Xe>=rt){const qe=c.luxuryNeeds[rt];for(const[Se,dt]of Object.entries(qe))Ke[Se]=(Ke[Se]||0)+dt*ft}}for(const[de,rt]of Object.entries(Ke)){const qe=De[de];if(qe&&qe.unlockTech){if(!_.includes(qe.unlockTech))continue}else if(qe&&typeof qe.unlockEpoch=="number"&&qe.unlockEpoch>u)continue;if(!ln.has(de))continue;let Se=rt*y*Ua;if(Se<=0)continue;const dt=((ge=W.resourceWaste)==null?void 0:ge[de])||0;dt!==0&&(Se*=1+dt);const et=B[de]||0,Wt=sn[de]||0,Fe=et+Wt;Fe!==0&&(Se*=1+Fe);const Ie=O[n]||0,Re=cn[n]||0,Ce=Ie+Re;Ce!==0&&(Se*=1+Ce),Un&&(n==="soldier"||n==="knight")&&(Se*=ss);let Tt=1;if(n==="official"&&fe&&fe.length>0&&(Tt=fe.reduce((Ue,Je)=>Ue+(Je.greed||1),0)/fe.length),Jt(de)){const ke=(qe==null?void 0:qe.marketConfig)||{},Ue=(Lt==null?void 0:Lt.market)||{},Je=ke.demandElasticity!==void 0?ke.demandElasticity:Ue.demandElasticity||.5,Pt=c.startingWealth||1,At=(We[n]||0)/Math.max(1,y),ro=(ut[n]||0)/Math.max(1,y),st=Math.max(0,ro)*30,ct=Math.max(At,st)/Pt;let Yt=c.wealthElasticity||1;n==="official"&&(Yt*=Tt);const Qt=Math.max(1,(c.maxConsumptionMultiplier||6)+Ir(oe)),Rt=zi(ct,ct,Yt,Qt);(!Qn[n]||Math.abs(Rt-1)>Math.abs(Qn[n]-1))&&(Qn[n]=Rt);const St=io(de),Bo=qe.basePrice||1,Co=St/Bo,ve=Math.pow(Co,-Je),gt=.8+Math.random()*.4;Se*=Rt*ve*gt,Se=Math.max(0,Se),Se=Math.min(Se,rt*y*Ua*8)}const Et=ie[de]||0;let jt=0;if(Jt(de)){const ke=io(de),Je=((Ne=z==null?void 0:z.dominance)==null?void 0:Ne.panelType)==="plannedEconomy"&&(Oe==null?void 0:Oe.enabled)&&((He=Oe.governmentSellPrices)==null?void 0:He[de])!==void 0&&Oe.governmentSellPrices[de]!==null;let Pt=ke;Je&&(Pt=Oe.governmentSellPrices[de]);const At=Pt*(1+ji(de)),ro=At>0?Math.min(Se,(We[n]||0)/At):Se,st=Math.min(Se,Et,ro);if(st>0){ie[de]=Et-st,_e[de]=(_e[de]||0)-st;let ct=ke;Je&&(ct=Cr({resourceKey:de,amount:st,marketPrice:ke,priceControls:Oe,taxBreakdown:$t,resources:ie,onTreasuryChange:Ut}).effectivePrice);const Yt=ji(de),Qt=st*ct,Rt=Qt*Yt;let St=Qt;if(Rt<0){const ve=Math.abs(Rt);(ie.silver||0)>=ve?(nt.transfer("state",n,ve,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),St-=ve,ut[n]=(ut[n]||0)+ve,Lo[n]=(Lo[n]||0)+ve):m%20===0&&vi(`国库空虚，无法为 ${((Pe=ae[n])==null?void 0:Pe.name)||n} 支付 ${((ze=De[de])==null?void 0:ze.name)||de} 消费补贴！`)}else Rt>0&&(nt.transfer(n,"state",Rt,Z.EXPENSE.RESOURCE_TAX,Z.EXPENSE.RESOURCE_TAX),St+=Rt);const Co=c.needs&&c.needs.hasOwnProperty(de)?Z.EXPENSE.ESSENTIAL_CONSUMPTION:Z.EXPENSE.LUXURY_CONSUMPTION;nt.transfer(n,"void",St,Co,Co,{resource:de,quantity:st,price:ct}),wt[n]=(wt[n]||0)+St,bi[n]=(bi[n]||0)+St,jt=st,mo[de]=(mo[de]||0)+st,zo[n]||(zo[n]={}),zo[n][de]=(zo[n][de]||0)+st}const Eo=Se>0?jt/Se:1;if(w+=Eo,E+=1,Eo<.99){const ct=ro>=Se*.99,Yt=Et>=Se*.99;let Qt="both";ct&&!Yt?Qt="outOfStock":!ct&&Yt&&(Qt="unaffordable"),I.push({resource:de,reason:Qt})}}else{const ke=Math.min(Se,Et);ke>0&&(ie[de]=Et-ke,jt=ke);const Ue=Se>0?jt/Se:1;w+=Ue,E+=1,Ue<.99&&I.push({resource:de,reason:"outOfStock"})}}wi[n]={satisfactionRatio:E>0?w/E:1,totalTrackedNeeds:E},xo[n]=I});let ws=0,hn=0,$a=0;Object.keys(ae).forEach(n=>{var E,I;const c=J[n]||0;if(c<=0)return;hn+=c;const y=(I=(E=wi[n])==null?void 0:E.satisfactionRatio)!=null?I:1;ws+=y*c;const w=ae[n];w&&w.needs&&(xo[n]||[]).some(G=>G.resource==="food"||G.resource==="cloth")&&($a+=c)});let Kn=.3+.7*(hn>0?ws/hn:1);if($a>0&&hn>0){const n=$a/hn,c=n*.4;Kn=Math.max(.1,Kn-c),n>.1&&Ge.push("基础需求（食物/布料）严重短缺，劳动效率大幅下降！")}Kn<.999&&Object.entries(_e).forEach(([n,c])=>{const y=De[n];if(!(!y||n==="silver"||y.type&&y.type==="virtual")&&c>0){const w=c*(1-Kn);_e[n]=c-w,ie[n]=Math.max(0,(ie[n]||0)-w)}});const tf=Te?Object.entries(Te).map(([n,c])=>({id:n,active:!0,modifiers:(c==null?void 0:c.effects)||(c==null?void 0:c.modifiers)})):[];let of=el(tf);if(Te!=null&&Te.tithe){const n=(J.cleric||0)*2*ri;if(n>0){const c=We.cleric||0,y=Math.min(c,n);nt.transfer("cleric","state",y,Z.EXPENSE.HEAD_TAX,Z.EXPENSE.HEAD_TAX),wt.cleric=(wt.cleric||0)+y}}const Li=Ve&&typeof Ve=="object"&&Object.prototype.hasOwnProperty.call(Ve,"targets")?Ve:{enabled:!0,targets:Ve||{}};if(((js=z.dominance)==null?void 0:js.faction)==="left"&&(Li!=null&&Li.enabled)&&Li.targets&&Object.keys(Li.targets).length>0){const{adjustments:n,approvalPenalties:c,adminCost:y}=Kc(J,Li.targets),w=Object.values(J).reduce((G,U)=>G+U,0);let E=0,I=null,q=-1;Object.entries(n).forEach(([G,U])=>{J[G]!==void 0&&(J[G]=Math.max(0,Math.round(J[G]+U)))}),Object.keys(J).forEach(G=>{const U=J[G];E+=U,U>q&&(q=U,I=G)});const S=w-E;S!==0&&I&&(J[I]+=S,J[I]<0&&(J[I]=0)),Object.entries(c).forEach(([G,U])=>{wo[G]&&(wo[G]-=U*.05)})}let ea={...t};const nf={cabinetStatusReceived:{hasCabinetStatus:!!z,hasDominance:!!(z!=null&&z.dominance),dominanceFaction:(Ns=z==null?void 0:z.dominance)==null?void 0:Ns.faction,synergy:z==null?void 0:z.synergy,level:z==null?void 0:z.level},expansionSettings:{hasSettings:!!ye,settingsKeys:ye?Object.keys(ye):[],allowedCount:ye?Object.values(ye).filter(n=>n==null?void 0:n.allowed).length:0},conditionCheck:{isDominanceRight:((Ls=z==null?void 0:z.dominance)==null?void 0:Ls.faction)==="right",hasExpansionSettings:!!ye,willProcess:((Fs=z==null?void 0:z.dominance)==null?void 0:Fs.faction)==="right"&&!!ye},epochParam:u};if(console.log("[FREE MARKET SIMULATION DEBUG]",{dominanceCheck:{hasDominance:!!(z!=null&&z.dominance),faction:(Us=z==null?void 0:z.dominance)==null?void 0:Us.faction,isRightWing:(($s=z==null?void 0:z.dominance)==null?void 0:$s.faction)==="right"},expansionCheck:{hasSettings:!!ye,settingsCount:ye?Object.keys(ye).length:0,allowedBuildings:ye?Object.entries(ye).filter(([n,c])=>c==null?void 0:c.allowed).map(([n])=>n):[]},willCallProcessExpansions:!!(z!=null&&z.dominance)&&z.dominance.faction==="right"&&!!ye}),((Gs=z.dominance)==null?void 0:Gs.faction)==="right"&&ye){const n={prices:ot,wages:(l==null?void 0:l.wages)||{}},{expansions:c,wealthDeductions:y}=o0(Vt,We,ye,ea,n,h,Na);c.length>0&&(c.forEach(w=>{const E=w.buildingId;ea[E]=(ea[E]||0)+1}),Object.entries(y).forEach(([w,E])=>{We[w]&&nt.transfer(w,"void",E,Z.EXPENSE.BUILDING_COST,Z.EXPENSE.BUILDING_COST)}),Object.assign(no,ea))}let mn=0,xs=0,Fi=0,ta=0;const Ga=[],Va={prices:ot,wages:(l==null?void 0:l.wages)||{}},xi=(fe||[]).map(n=>{var Bo,Co,ve,gt,Xt,Bt,Qo,fi,Ko;if(!n)return n;const c=Al(n,m),y=1e12;let w=typeof c.wealth=="number"?c.wealth:400;(!Number.isFinite(w)||w<0)&&(w=400);let E=Math.min(w,y);const I=E;xe&&typeof c.salary=="number"?(E+=c.salary,Fi+=c.salary,ta+=c.salary,console.log(`[OFFICIAL DEBUG] ${c.name}: Salary paid! +${c.salary}, wealth: ${I} -> ${E}`),ht.official&&(ht.official.income.salary=(ht.official.income.salary||0)+c.salary)):console.log(`[OFFICIAL DEBUG] ${c.name}: NO SALARY! officialsPaid=${xe}, salary=${c.salary}, wealth=${E}`);const q=((Bo=ae.official)==null?void 0:Bo.needs)||{food:1.2,cloth:.2},S=((Co=ae.official)==null?void 0:Co.luxuryNeeds)||{};let G=0,U=0,X=0;const te={},be=(re,bt,so=!1)=>{var Ai,En;if(!re||bt<=0)return;const Kt=De[re];if(Kt!=null&&Kt.unlockTech&&!_.includes(Kt.unlockTech)||Kt&&typeof Kt.unlockEpoch=="number"&&Kt.unlockEpoch>u||ln&&!ln.has(re))return;let bo=bt*Ua;if(bo<=0)return;const ei=((Ai=W.resourceWaste)==null?void 0:Ai[re])||0;ei!==0&&(bo*=1+ei);const xn=B[re]||0,Uo=sn[re]||0,ti=xn+Uo;ti!==0&&(bo*=1+ti);const Gi=O.official||0,di=cn.official||0,Vi=Gi+di;Vi!==0&&(bo*=1+Vi);const qi=ie[re]||0;if(Jt(re)){const qo=io(re),Cn=ji(re),_n=qo*(1+Cn),ya=_n>0?Math.min(bo,E/_n):bo,$o=Math.min(bo,qi,ya);if($o<=0)return;ie[re]=qi-$o,_e[re]=(_e[re]||0)-$o,mo[re]=(mo[re]||0)+$o;const Tn=$o*qo,oi=Tn*Cn;let _o=Tn;if(oi<0){const L=Math.abs(oi);(ie.silver||0)>=L?(nt.transfer("state","official",L,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),_o-=L,Fi+=L,ta+=L):m%20===0&&vi(`国库空虚，无法为 官员 支付 ${((En=De[re])==null?void 0:En.name)||re} 消费补贴！`)}else oi>0&&(nt.transfer("official","state",oi,Z.EXPENSE.RESOURCE_TAX,Z.EXPENSE.RESOURCE_TAX),_o+=oi);E=Math.max(0,E-_o),G+=_o,so?U+=_o:X+=_o,te[re]||(te[re]={amount:0,cost:0,tax:0,luxuryCost:0,essentialCost:0}),te[re].amount+=$o,te[re].cost+=_o,te[re].tax+=oi,so?te[re].luxuryCost+=_o:te[re].essentialCost+=_o,zo.official||(zo.official={}),zo.official[re]=(zo.official[re]||0)+$o;const j=so?Z.EXPENSE.LUXURY_CONSUMPTION:Z.EXPENSE.ESSENTIAL_CONSUMPTION;nt.transfer("official","void",_o,j,j,{resource:re,quantity:$o,price:qo})}else{const qo=Math.min(bo,qi);qo>0&&(ie[re]=qi-qo,te[re]||(te[re]={amount:0,cost:0,tax:0,luxuryCost:0,essentialCost:0}),te[re].amount+=qo)}};Object.entries(q).forEach(([re,bt])=>{be(re,bt,!1)});const me=E/400,Me=Math.min(me,1e9);if(Me>=1&&S){const re=Math.max(1,Math.min(E/400,1e9)),bt=1+Math.log10(re)*1.6,so=Math.min(100,Number.isFinite(bt)?bt:1),Kt=Math.max(1,Math.min((c.salary||0)/400,1e9)),bo=1+Math.log10(Kt)*1.2,ei=Math.min(8,Number.isFinite(bo)?bo:1);Object.keys(S).map(Number).filter(Uo=>Uo<=Me).sort((Uo,ti)=>ti-Uo).forEach(Uo=>{const ti=S[Uo];ti&&Object.entries(ti).forEach(([Gi,di])=>{be(Gi,di*so*ei,!0)})})}const at=E,ft=ai("official"),Ke=((ve=ae.official)==null?void 0:ve.headTaxBase)*ft*ri;let ge=0;if(Ke!==0)if(Ke>0){const re=Math.min(E,Ke);ge=re,E=Math.max(0,E-re),nt.transfer("official","state",re,Z.EXPENSE.HEAD_TAX,Z.EXPENSE.HEAD_TAX),Mi.official=(Mi.official||0)+re,wt.official=(wt.official||0)+re}else{const re=Math.abs(Ke);(ie.silver||0)>=re&&(nt.transfer("state","official",re,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),E+=re,Fi+=re,ta+=re)}const Ne=E,He=Ke;let Pe=0;(gt=c.ownedProperties)!=null&&gt.length&&c.ownedProperties.forEach(re=>{const bt=bl(re,Va,h,Na,no);bt>0?Pe+=bt:bt<0&&(E=Math.max(0,E+bt))}),Pe>0&&(E+=Pe,Fi+=Pe,nt.transfer("void","official",Pe,Z.INCOME.OWNER_REVENUE,Z.INCOME.OWNER_REVENUE));const ze=E,de=(c.salary||0)+Pe,rt=gl({...c,wealth:E},G,de),qe=Number.isFinite(c.baseSalary)?c.baseSalary:c.salary||0,Se=qe>0?(c.salary||0)/qe:1;let dt="satisfied";Se<.4?dt="desperate":Se<.7?dt="struggling":Se<.95&&(dt="uncomfortable");const et=["satisfied","uncomfortable","struggling","desperate"];let Wt;if(rt==="satisfied")Wt="satisfied";else{const re=Math.max(et.indexOf(rt),et.indexOf(dt));Wt=et[re]||rt}const Fe=vl({...c,wealth:E},m,Va,h,z,no,oe,u,_),Ie=Array.isArray(c.ownedProperties)?[...c.ownedProperties]:[],Re={...c.investmentProfile};if(Fe&&E>=Fe.cost){E=Math.max(0,E-Fe.cost);const re=`${Fe.buildingId}_off_${c.id}_${m}_${Math.floor(Math.random()*1e3)}`;Ie.push({buildingId:Fe.buildingId,instanceId:re,purchaseDay:m,purchaseCost:Fe.cost,level:0}),Re.lastInvestmentDay=m,no[Fe.buildingId]=(no[Fe.buildingId]||0)+1,Fe.buildingId&&((Bt=(Xt=je==null?void 0:je.logVisibility)==null?void 0:Xt.showOfficialLogs)==null||Bt)&&Ge.push(`🏗️ 官员${c.name}投资了 ${Fe.buildingId}（花费 ${Math.ceil(Fe.cost)} 银）`)}const Ce=wl({...c,wealth:E,ownedProperties:Ie,investmentProfile:Re},m,Va,h,z,no,se,oe);if(Ce&&E>=Ce.cost){E=Math.max(0,E-Ce.cost);const re=Ie[Ce.propertyIndex];re&&(re.level=Ce.toLevel,Re.lastUpgradeDay=m,Ga.push({buildingId:Ce.buildingId,fromLevel:Ce.fromLevel,toLevel:Ce.toLevel,officialName:c.name,cost:Ce.cost}))}const Tt=E,Et=(Fe==null?void 0:Fe.cost)||0,jt=(Ce==null?void 0:Ce.cost)||0;mn+=E,xs+=G;let ke=(Qo=c.loyalty)!=null?Qo:75,Ue=(fi=c.lowLoyaltyDays)!=null?fi:0;const Je=typeof c.politicalStance=="string"?c.politicalStance:(Ko=c.politicalStance)==null?void 0:Ko.stanceId,Pt=c.stanceConditionParams||[],At=Object.values(lo||{}).reduce((re,bt)=>re+(bt||0),0),ro={...ut,official:xe?(c.salary||0)+(c.lastDayPropertyIncome||0):0},st={classApproval:wo,classInfluence:lo,classIncome:ro,totalInfluence:At,stability:(F!=null?F:50)/100,rulingCoalition:$,legitimacy:Y!=null?Y:0,taxPolicies:h,prices:ot,epoch:u,population:i?Object.values(i).reduce((re,bt)=>re+(bt||0),0):0,atWar:(C||[]).some(re=>re.isAtWar)},Eo=br(Je,st,Pt),{DAILY_CHANGES:ct,COUP_THRESHOLD:Yt,MAX:Qt,MIN:Rt}=Dn;ke+=Eo?ct.stanceSatisfied:ct.stanceUnsatisfied,Wt==="satisfied"?ke+=ct.financialSatisfied:Wt==="uncomfortable"?ke+=ct.financialUncomfortable:Wt==="struggling"?ke+=ct.financialStruggling:Wt==="desperate"&&(ke+=ct.financialDesperate);const St=(F!=null?F:50)/100;return St>.7?ke+=ct.stabilityHigh:St<.3&&(ke+=ct.stabilityLow),ke+=xe?ct.salaryPaid:ct.salaryUnpaid,ke=Math.max(Rt,Math.min(Qt,ke)),ke<Yt?Ue+=1:Ue=0,{...c,wealth:Math.min(y,Number.isFinite(E)?Math.max(0,E):400),lastDayExpense:G,financialSatisfaction:Wt,ownedProperties:Ie,investmentProfile:Re,lastDayPropertyIncome:Pe,lastDayExpenseBreakdown:te,lastDayLuxuryExpense:U,lastDayEssentialExpense:X,loyalty:ke,lowLoyaltyDays:Ue,isStanceSatisfied:Eo,_debug:{initialWealth:I,salaryPaid:xe,salaryAmount:c.salary||0,wealthAfterSalary:I+(xe&&c.salary||0),dailyExpense:G,wealthAfterGoods:at,headTaxPlanned:He,headTaxPaid:ge,wealthAfterTax:Ne,propertyIncome:Pe,wealthAfterProperty:ze,investmentCost:Et,upgradeCost:jt,wealthAfterInvestment:Tt,wealthFinal:E}}});We.official=mn,wt.official=(wt.official||0)+xs,bi.official=wt.official,Lo.official=ta;const oa=m0({popStructure:{...J,official:0},wealth:We,classIncome:ut,classExpense:wt,classShortages:xo,epoch:u,techsUnlocked:_,priceMap:io,livingStandardStreaks:le}),Es=xi.length;if(Es>0){const n=mn/Es;let c="赤贫",y=30;n>300?(c="奢华",y=95):n>100?(c="富裕",y=85):n>50?(c="小康",y=75):n>20?(c="温饱",y=60):(c="贫困",y=45);const w=n/400,E={奢华:{icon:"Crown",color:"text-purple-400"},富裕:{icon:"Gem",color:"text-blue-400"},小康:{icon:"Home",color:"text-green-400"},温饱:{icon:"UtensilsCrossed",color:"text-yellow-400"},贫困:{icon:"AlertTriangle",color:"text-orange-400"},赤贫:{icon:"Skull",color:"text-red-500"}},I=E[c]||E.赤贫;oa.classLivingStandard.official={level:c,satisfaction:1,satisfactionRate:1,approvalCap:y,needsMet:1,wealthRatio:w,wealthPerCapita:n,wealthMultiplier:Math.min(6,1+Math.log(Math.max(1,n/100))*.5),icon:I.icon,color:I.color,bgColor:I.color.replace("text-","bg-").replace("-400","-900/20"),borderColor:I.color.replace("text-","border-").replace("-400","-500/30"),score:n>300?90:n>100?75:n>50?60:n>20?45:25};const q=le.official||{},S=q.level===c;oa.livingStandardStreaks.official={level:c,streak:S?(q.streak||0)+1:1}}const Ui=oa.classLivingStandard,Cs=oa.livingStandardStreaks,_s={};Object.keys(ae).forEach(n=>{var ct,Yt,Qt,Rt,St,Bo,Co;const c=J[n]||0;if(c===0)return;const y=wi[n],w=(ct=y==null?void 0:y.satisfactionRatio)!=null?ct:1,E=Ui[n];let I=(Yt=E==null?void 0:E.approvalCap)!=null?Yt:100;const q=S0(n,$);if(q){const ve=(E==null?void 0:E.level)||"温饱",gt=I0(ve);I=Math.max(0,I-gt)}let S=70;const G=E==null?void 0:E.level;G==="奢华"?S=95:G==="富裕"?S=85:G==="小康"&&(S=75),q&&W.coalitionApproval&&(S+=W.coalitionApproval);const U=ai(n);(Rt=(Qt=ae[n])==null?void 0:Qt.headTaxBase)!=null;const X=Math.max(0,(Mi[n]||0)/Math.max(1,c)),te=(ut[n]||0)/Math.max(1,c),be=(We[n]||0)/Math.max(1,c),me=te>.001&&X>te*.5,Me=be>X*100;me&&!Me?S=Math.min(S,40):U<.6&&(S+=5);const at=(Mi[n]||0)/Math.max(1,c),ft=(ms[n]||0)/Math.max(1,c),Xe=ft>.01?at/ft:0,Ke=.05,ge=.2,Ne=1;let He=0;Xe>Ke&&at>0&&(Xe<=ge?He=(Xe-Ke)/(ge-Ke)*25:He=25+Math.min(25,(Xe-ge)/(Ne-ge)*25));const Pe=Ze[n]||0,rt=Math.max(0,Pe*(1-.03)+He*.5);_s[n]=rt;const qe=Math.max(He,rt),Se=xo[n]||[],dt=Se.filter(ve=>ve.isBasic),et=Se.filter(ve=>!ve.isBasic),Wt=(St=y==null?void 0:y.totalTrackedNeeds)!=null?St:0;if(dt.length>0&&Wt>0&&(dt.length>=Object.keys(((Bo=ae[n])==null?void 0:Bo.needs)||{}).length?S=Math.min(S,0):S=Math.min(S,30)),et.length>0){const ve=Math.min(15,et.length*3);S-=ve}const Fe=Cs[n]||{};if(Fe.level==="赤贫"||Fe.level==="贫困"){const ve=Fe.level==="赤贫"?2.5:1.5,gt=Math.min(30,Math.ceil((Fe.streak||0)*ve));gt>0&&(S-=gt)}let Ie=0;const Re=(D||{})[n];if(Re&&Re.length>0){let Xt=0;for(let Bt=Re.length-1;Bt>=0&&Xt<20&&Re[Bt]>=.95;Bt--)Xt+=1;Xt>=3&&(Ie=Math.min(15,Xt*.6),S=Math.min(100,S+Ie))}let Ce=0,Tt=0;const Et=(k||{})[n];if(Et&&Et.length>=20){const ve=Et.slice(-10).reduce((Xt,Bt)=>Xt+Bt,0)/10,gt=Et.slice(-20,-10).reduce((Xt,Bt)=>Xt+Bt,0)/10;gt>1&&(Ce=(ve-gt)/gt,Tt=Math.min(15,Math.abs(Ce)*50),Ce>.05?S+=Tt:Ce<-.05&&(S-=Tt))}if(w>=.98&&(S=Math.min(100,S+10)),n==="unemployed"){const gt=2+c/Math.max(1,o)*30;S-=gt}if(xt[n]={baseTarget:0,livingStandardBase:0,taxReliefBonus:0,luxuryShortagePenalty:0,povertyPenalty:0,sustainedNeedsBonus:0,wealthTrendBonus:0,positiveSatisfactionBonus:0,unemployedPenalty:0,eventBonus:0,decreeBonus:0,officialTargetBonus:0,legitimacyPenalty:0,taxShockPenalty:0,shockCapApplied:null,currentApprovalStart:0,targetApprovalPreShockCap:0,targetApprovalFinal:0,adjustmentSpeed:.02,inertiaDelta:0,effectiveApprovalCap:I,capApplied:null,approvalAfterCap:0,approvalFinal:0},xt[n].baseTarget=70,xt[n].livingStandardBase=S-70,U<.6&&(xt[n].taxReliefBonus=5),((et==null?void 0:et.length)||0)>0&&(xt[n].luxuryShortagePenalty=-Math.min(15,et.length*3)),(Fe==null?void 0:Fe.level)==="赤贫"||(Fe==null?void 0:Fe.level)==="贫困"){const ve=Fe.level==="赤贫"?2.5:1.5,gt=Math.min(30,Math.ceil((Fe.streak||0)*ve));xt[n].povertyPenalty=-gt}if(Ie&&(xt[n].sustainedNeedsBonus=Ie),Tt&&Ce&&Math.abs(Ce)>.05&&(xt[n].wealthTrendBonus=Ce>0?Tt:-Tt),w>=.98&&(xt[n].positiveSatisfactionBonus=10),n==="unemployed"){const gt=2+c/Math.max(1,o)*30;xt[n].unemployedPenalty=-gt}const jt=(V==null?void 0:V[n])||0;jt&&(S+=jt,xt[n].eventBonus=jt);const ke=of[n]||0;ke&&(S+=ke,xt[n].decreeBonus=ke);const Ue=((Co=lt==null?void 0:lt.approval)==null?void 0:Co[n])||0;Ue>0&&(S+=Ue,xt[n].officialTargetBonus=Ue);const Je=R0(Y);Je<0&&(S+=Je,xt[n].legitimacyPenalty=Je);let Pt=I;Ue<0&&(Pt=Math.max(0,I+Ue)),xt[n].effectiveApprovalCap=Pt;let At=wo[n]||50;if(xt[n].currentApprovalStart=At,xt[n].adjustmentSpeed=.02,qe>1&&(At=Math.max(0,At-qe),xt[n].taxShockPenalty=-qe,qe>5)){const ve=Math.max(0,70-qe*2);xt[n].shockCapApplied=ve,S=Math.min(S,ve)}xt[n].targetApprovalPreShockCap=S,xt[n].targetApprovalFinal=S;let st=At+(S-At)*.02;xt[n].inertiaDelta=st-At;const Eo=st;st=Math.min(st,Pt),st!==Eo&&(xt[n].capApplied=Pt),xt[n].approvalAfterCap=st,xt[n].approvalFinal=Math.max(0,Math.min(100,st)),wo[n]=Math.max(0,Math.min(100,st))}),(J.unemployed||0)===0&&p.unemployed!==void 0&&(wo.unemployed=Math.min(100,p.unemployed+5));let ao=o,ia=0;Object.keys(ae).forEach(n=>{const c=We[n]||0,y=J[n]||0;if(c>0&&y>0){const w=Ui[n],E=w==null?void 0:w.level;if(E==="赤贫"||E==="贫困"||E==="温饱")return;const I=c/y;if(I/Er<1.2&&E!=="奢华")return;let S=.005;E==="小康"?S=.001:E==="富裕"&&(S=.003);const U=I*S*y;let X=parseFloat(U.toFixed(2)),te=0;ht[n]&&ht[n].expense&&ht[n].expense.luxuryNeeds&&Object.values(ht[n].expense.luxuryNeeds).forEach(me=>{te+=me.cost||0});const be=parseFloat((te*.5).toFixed(2));X=Math.min(X,be),X>0&&(nt.transfer(n,"void",X,Z.EXPENSE.DECAY,Z.EXPENSE.DECAY),wt[n]=(wt[n]||0)+X)}}),Object.keys(ae).forEach(n=>{uo[n]=Ji(We[n]||0)});let si=Object.values(uo).reduce((n,c)=>n+c,0);Object.keys(ae).forEach(n=>{const c=J[n]||0;if(c===0)return;const y=ae[n],w=uo[n]||0,E=si>0?w/si:0;lo[n]=y.influenceBase*c+E*10});const af=Object.values(lo).reduce((n,c)=>n+c,0),rf=Tl(fe||[],xe,{classInfluence:lo,totalInfluence:af,polityEffects:qn,currentDay:m});Object.entries(rf).forEach(([n,c])=>{lo[n]!==void 0&&c>0&&(lo[n]+=c)});let ci=Object.values(lo).reduce((n,c)=>n+c,0);const sf=T0($,lo,ci);fn=P0(sf),W.legitimacyBonus&&(fn=Math.max(0,Math.min(100,fn*(1+W.legitimacyBonus)))),ja=Br(fn);let qa=0;W.factionConflict&&(qa+=W.factionConflict),Object.keys(ae).forEach(n=>{var I;const c=J[n]||0;if(c===0)return;const y=wo[n]||50;if(y>=25)return;const w=ci>0?(lo[n]||0)/ci:0,E=((I=ae[n])==null?void 0:I.name)||n;if(y<20&&w<.07){const q=Math.max(.03,(20-y)/200),S=Math.min(c,Math.max(1,Math.floor(c*q)));if(S>0){const X=We[n]||0,be=(c>0?X/c:0)*S;be>0&&nt.transfer(n,"void",be,Z.EXPENSE.CAPITAL_FLIGHT,Z.EXPENSE.CAPITAL_FLIGHT),J[n]=Math.max(0,c-S)}const G=(xo[n]||[]).map(X=>{var Me;const te=typeof X=="string"?X:X.resource,be=typeof X=="string"?"outOfStock":X.reason,me=((Me=De[te])==null?void 0:Me.name)||te;return be==="unaffordable"?`${me}(买不起)`:be==="outOfStock"?`${me}(缺货)`:be==="both"?`${me}(缺货且买不起)`:me}).join("、"),U=G?`，短缺资源：${G}`:"";Ge.push(`${E} 阶层对政局失望，${S} 人离开了国家，带走了 ${(S*(We[n]||0)/Math.max(1,c)).toFixed(1)} 银币${U}。`)}else if(w>=.12){const q=Math.min(.2,.05+w*.15);qa+=q;const S=(xo[n]||[]).map(U=>{var me;const X=typeof U=="string"?U:U.resource,te=typeof U=="string"?"outOfStock":U.reason,be=((me=De[X])==null?void 0:me.name)||X;return te==="unaffordable"?`${be}(买不起)`:te==="outOfStock"?`${be}(缺货)`:te==="both"?`${be}(缺货且买不起)`:be}).join("、"),G=S?`（短缺：${S}）`:"";Ge.push(`${E} 阶层的愤怒正在削弱社会稳定${G}。`)}});const Ha=[],Ya=[];Object.keys(ae).forEach(n=>{var G,U;const c=ae[n];if(!c.buffs||(J[n]||0)===0)return;const y=wo[n]||50,w=((U=(G=wi[n])==null?void 0:G.satisfactionRatio)!=null?U:1)>=.9,E=ci>0?(lo[n]||0)/ci:0,I=E>.8?2:E>.5?1.5:1,q=y>=85&&E>=.3,S=y>=85&&w;if((q||S)&&c.buffs.satisfied){const X=xa(c.buffs.satisfied,I);Ha.push({class:n,...X})}else if(y<40&&c.buffs.dissatisfied&&E>=.3){const X=xa(c.buffs.dissatisfied,I);Ya.push({class:n,...X})}});const{stabilityValue:Ts,efficiency:na}=tl({popStructure:J,classApproval:wo,classInfluence:lo,totalInfluence:ci,newActiveBuffs:Ha,newActiveDebuffs:Ya,eventStabilityModifier:N,extraStabilityPenalty:qa,currentStability:F,stabilityBonus:W.stabilityBonus||0}),Ei=u;let li=0;const Xa=Math.max(5,o||5),gn=Math.max(100,(qs=(Vs=ie.silver)!=null?Vs:e==null?void 0:e.silver)!=null?qs:0);let aa=-1/0;const cf=On(m,"priceUpdate"),ra=On(m,"tradeUpdate"),Fo=On(m,"diplomacyUpdate"),sa=On(m,"aiDecision");(C||[]).forEach(n=>{n.lastPeaceRequestDay&&n.lastPeaceRequestDay>aa&&(aa=n.lastPeaceRequestDay)});let go=x!=null&&x.organizations?[...x.organizations]:[],ca=!1,yt=(C||[]).map(n=>{var S,G,U,X,te,be,me,Me,at,ft,Xe,Ke;const c={...n};if(c.alliedWithPlayer=go.some(ge=>ge.type==="military_alliance"&&ge.members.includes(n.id)&&ge.members.includes("player")),$e!=null&&$e.nationDelta&&$e.nationDelta[n.id]){const ge=$e.nationDelta[n.id];c.budget=Math.max(0,(c.budget||0)+(ge.budget||0)),c.relation=Math.min(100,Math.max(-100,(c.relation||0)+(ge.relation||0))),ge.inventory&&(c.inventory=c.inventory||{},Object.entries(ge.inventory).forEach(([Ne,He])=>{c.inventory[Ne]=Math.max(0,(c.inventory[Ne]||0)+He)}))}if(!(Ei>=((S=n.appearEpoch)!=null?S:0)&&(n.expireEpoch==null||Ei<=n.expireEpoch)))return c.isAtWar&&(c.isAtWar=!1,c.warScore=0,c.warDuration=0,c.warStartDay=null,c.enemyLosses=0,c.warTarget=null,c.isPeaceRequesting=!1,c.peaceTribute=null),c;if(c.epoch===void 0&&((G=c.foreignPower)!=null&&G.initializedAtTick?c.epoch=Ei:c.epoch=(U=c.appearEpoch)!=null?U:0),Iu({nation:c,tick:m,resources:ie,logs:Ge,onTreasuryChange:Ut}),c.isRebelNation){if(iu(c),c.isAtWar){const ge=Rl({nation:c,tick:m,epoch:u,resources:ie,population:o,army:b,logs:Ge,onTreasuryChange:Ut,onResourceChange:kt});ia+=ge.raidPopulationLoss}return Sl({nation:c,tick:m,logs:Ge}),c}c.foreignPower={...c.foreignPower||{}};const w=c.foreignPower,E=c.wealthTemplate||c.wealth||800;w.baseRating==null&&(w.baseRating=Math.max(.4,E/800));const I=Math.min(.9,Math.max(.1,(te=(X=w.volatility)!=null?X:c.marketVolatility)!=null?te:.3));if(w.volatility=I,w.appearEpoch==null&&(w.appearEpoch=(be=c.appearEpoch)!=null?be:0),w.populationFactor==null){const ge=(me=c.culturalTraits)!=null&&me.agriculturalFocus?1.15:1;w.populationFactor=Ft(w.baseRating*ge,.6,2.5)}if(w.wealthFactor==null){const ge=1+Math.max(0,w.appearEpoch)*.05;w.wealthFactor=Ft(w.baseRating*ge,.5,3.5)}if(!w.initializedAtTick){const Ne=1+Math.max(0,Ei-((Me=w.appearEpoch)!=null?Me:0))*.08,He=.9+Math.random()*.25,Pe=Ft(w.populationFactor*Ne*He,.6,2.5),ze=Ft(w.wealthFactor*Ne*He,.5,3.5),de=Math.max(3,Math.round(Xa*Pe)),rt=Math.max(100,Math.round(gn*ze));c.population=de,c.wealth=rt,c.budget=Math.max(50,rt*.5),c.economyTraits={...c.economyTraits||{},basePopulation:de,baseWealth:rt},w.populationFactor=Pe,w.wealthFactor=ze,w.initializedAtTick=m,w.playerSnapshot={population:Xa,wealth:gn},c.wealthTemplate||(c.wealthTemplate=rt)}if(ra&&Kl({nation:c,tick:m,gameSpeed:s}),c.isAtWar){c.warDuration=(c.warDuration||0)+1;const ge=(C||[]).filter(He=>He.isAtWar).length||1,Ne=((Zn==null?void 0:Zn.dailyExpense)||0)/ge;if(c.warTotalExpense=(c.warTotalExpense||0)+Ne,Ei>=1&&sa){const He=Il({nation:c,tick:m,epoch:u,resources:ie,army:b,logs:Ge,difficultyLevel:oe,onTreasuryChange:Ut,onResourceChange:kt});ia+=He.raidPopulationLoss}sa&&(kl({nation:c,tick:m,lastGlobalPeaceRequest:aa,logs:Ge})&&(aa=m),Dl({nation:c,tick:m,population:o,playerWealth:gn,logs:Ge}),Wl({nation:c,tick:m,population:o,playerWealth:gn,resources:ie,logs:Ge}))}else c.warDuration&&(c.warDuration=0,c.warTotalExpense=0);(at=c.relation)!=null,Fo&&Zl(c,oe);const q=Sr(oe);if(W.diplomaticIncident&&!c.isRebelNation&&!c.isAtWar){const ge=W.diplomaticIncident/30*q.bad;c.relation=Math.min(100,Math.max(0,((ft=c.relation)!=null?ft:50)-ge))}if(W.diplomaticBonus&&!c.isRebelNation&&!c.isAtWar){const ge=W.diplomaticBonus/30*q.good;c.relation=Math.min(100,Math.max(0,((Xe=c.relation)!=null?Xe:50)+ge))}if(Fo){const ge=Jl(c,Ge,{organizations:go});ge&&ge.memberLeaveRequests&&ge.memberLeaveRequests.forEach(Ne=>{const He=go.findIndex(Pe=>Pe.id===Ne.orgId);if(He>=0){const Pe=go[He];go[He]={...Pe,members:Pe.members.filter(ze=>ze!==Ne.nationId)},ca=!0}})}return(Ke=c.aggression)!=null,sa&&Bl({nation:c,nations:C,tick:m,epoch:Ei,resources:ie,stabilityValue:Ts,logs:Ge,difficultyLevel:oe,diplomacyOrganizations:{organizations:go}}),li+=au({nation:c,resources:ie,logs:Ge,onTreasuryChange:Ut}),nu(c),ra&&(eu({nation:c,tick:m}),tu({nation:c,tick:m}),ru(c,Ge),ou({nation:c,epoch:c.epoch,playerPopulationBaseline:Xa,playerWealthBaseline:gn,tick:m})),c});yt=Fl(yt);const za=m%30===0;za&&Fo&&(yt=Ul(yt,oe));let $i=null;if(za&&Fo&&((Hs=x==null?void 0:x.organizations)==null?void 0:Hs.length)>0){if($i=Ll({organizations:x.organizations,nations:yt,playerWealth:ie.silver||0,daysElapsed:m}),$i.fees.player>0){const n=Math.min(ie.silver||0,$i.fees.player);n>0&&Le(-n,"organization_membership_fee")}if($i.fees.ai)for(const[n,c]of Object.entries($i.fees.ai)){const y=yt.find(w=>w.id===n);y&&(y.wealth=Math.max(0,(y.wealth||0)-c))}$i.logs.forEach(n=>Ge.push(n))}let ui=null;if(za&&Fo&&(ui=lu({nations:yt,epoch:u,playerPopulation:ao,playerResources:ie,classApproval:p,daysElapsed:m,maxPop:No}),ui.immigrantsIn>0||ui.emigrantsOut>0)){const n=ui.immigrantsIn-ui.emigrantsOut;ao=Math.max(10,ao+n),Object.keys(ui.byStratum).length>0&&(J=uu(J,ui.byStratum)),fu(ui.events).forEach(y=>Ge.push(y))}let Ci=null;if(Fo){if(Ci=Mu(yt,{daysElapsed:m}),Ci&&Ci.updates)for(const n of Ci.updates){const c=yt.findIndex(y=>y.id===n.id);c>=0&&(yt[c]={...yt[c],...n})}if(Ci&&Ci.events)for(const n of Ci.events)n.type==="civil_war_started"?Ge.push(`⚔️ ${n.nationName} 爆发内战！反对派势力与政府军交战中...`):n.type==="civil_war_ended"&&(n.winner==="rebels"?Ge.push(`🏴 ${n.nationName} 的叛军取得胜利，政权更迭为${n.newGovernment||"新政府"}！`):Ge.push(`🏛️ ${n.nationName} 的政府军平定叛乱，恢复秩序。`))}const Jo=yt.filter(n=>{var c;return u>=((c=n.appearEpoch)!=null?c:0)&&(n.expireEpoch==null||u<=n.expireEpoch)&&!n.isRebelNation});let _i=null;if(Fo&&(l!=null&&l.prices)){if(_i=x0(l.prices,yt,m),_i.marketPrices&&(l={...l,prices:_i.marketPrices}),_i.nationPriceUpdates)for(const n of _i.nationPriceUpdates){const c=yt.findIndex(y=>y.id===n.nationId);c>=0&&(yt[c]={...yt[c],nationPrices:n.nationPrices})}_i.logs&&_i.logs.forEach(n=>Ge.push(n))}if(Fo&&$l(Jo,m,Ge,oe),Fo&&Gl(Jo,Ge),ra&&ql(Jo,Ge,x),ra&&Hl(Jo,m,ie,l,Ge,qt,x,Ut),Fo&&Yl(Jo,m,u,Ge),Fo){const n=zl(Jo,m,Ge,{organizations:go},Ei);n&&n.createdOrganizations.length>0&&(go.push(...n.createdOrganizations),ca=!0),n&&n.memberJoinRequests.length>0&&n.memberJoinRequests.forEach(c=>{const y=go.findIndex(w=>w.id===c.orgId);if(y>=0){const w=go[y];w.members.includes(c.nationId)||(go[y]={...w,members:[...w.members,c.nationId]},ca=!0)}})}sa&&(Ol(Jo,m,Ge,{organizations:go}),jl(Jo,yt,m,Ge,{organizations:go}),Nl(Jo,yt,m,Ge));let yn=0,bn=Math.max(0,r||0),Ti=Math.max(0,No-ao);if(Ti>0){const n=p0(oe);Math.random()<.01&&console.log(`[DEBUG] PopGrowth: diff=${oe}, mult=${n}`);const c=Math.max(0,o||0)*Vc*n;if(bn+=c,o<Bn){const w=Math.max(0,(Bn-o)/Bn);bn+=qc*w*n}const y=Math.min(Ti,Math.floor(bn));y>0&&(yn+=y,bn-=y,Ti-=y)}if(Ti>0&&Object.keys(ae).forEach(n=>{var be;if(Ti<=0)return;const c=J[n]||0;if(c<=0)return;const y=(be=wo[n])!=null?be:50,w=Math.max(0,(y-25)/75);if(w<=0)return;const E=uo[n]||0,I=c>0?E/c:0,q=Math.max(.3,Math.min(2,I/Er)),S=Gc*w*q*(1+(W.populationGrowthBonus||0));if(S<=0)return;let G=c*S;if(G<=0)return;const U=Math.floor(G);let X=U;const te=G-U;Math.random()<te&&(X+=1),!(X<=0)&&(X=Math.min(X,Ti),!(X<=0)&&(yn+=X,Ti-=X))}),yn>0&&(J.unemployed=(J.unemployed||0)+yn,ao=Math.min(No,ao+yn)),(ie.food||0)<=0&&(ie.food=0,Math.random()>.9&&ao>2)){if(ao=ao-1,(J.unemployed||0)>0)J.unemployed=J.unemployed-1;else{const n=Ht.filter(c=>(J[c]||0)>0);if(n.length>0){const c=n[Math.floor(Math.random()*n.length)];J[c]=Math.max(0,(J[c]||0)-1)}}Ge.push("饥荒导致人口减少！")}if(Object.keys(ae).forEach(n=>{if(n==="official")return;const c=J[n]||0;if(c===0)return;const y=ae[n];if(!y||!y.needs)return;const w=xo[n]||[],E=w.some(S=>(typeof S=="string"?S:S.resource)==="food"),I=w.some(S=>(typeof S=="string"?S:S.resource)==="cloth"),q=(D||{})[n];if(q&&q.length>=5){const S=q.slice(-5),G=S.reduce((U,X)=>U+X,0)/S.length;if((E||I)&&G<.85){const U=y.name||n;let X=0;G<.5?X=.02+(.5-G)/.5*.08:X=.005+(.85-G)/.35*.015;const te=Math.max(1,Math.floor(c*X));te>0&&(J[n]=Math.max(0,c-te),vi(`${U} 阶层因长期缺乏${E&&I?"食物和布料":E?"食物":"布料"}，${te} 人死亡！`))}}}),Ht.reduce((n,c)=>n+(J[c]||0),0)+(J.unemployed||0),ia>0){let n=ia;if((J.unemployed||0)>=n)J.unemployed=J.unemployed-n;else{const c=J.unemployed||0;J.unemployed=0,n-=c;const y=Ht.reduce((w,E)=>w+(J[E]||0),0);y>0&&n>0&&Ht.forEach(w=>{if(n<=0)return;const E=J[w]||0;if(E<=0)return;const I=E/y,q=Math.min(E,Math.max(1,Math.floor(I*n)));J[w]=E-q,n-=q})}}ao=Ht.reduce((n,c)=>n+(J[c]||0),0)+(J.unemployed||0),ao=Math.max(0,Math.floor(ao)),Object.keys(ie).forEach(n=>{ie[n]<0&&(ie[n]=0)});let Mn={...ot},yo={...(l==null?void 0:l.wages)||{}};const lf=.35;if(cf){yo={},Object.entries(Xo).forEach(([S,G])=>{let U=0;const X=J[S]||0;if(X>0){const me=Lo[S]||0,Me=bi[S]||0;let at=me,ft=Me;me===0&&Xo[S].totalSlots===0?U=gi[S]||0:U=(at-ft)/X}else G.weightedWage>0&&G.totalSlots>0?U=G.weightedWage/G.totalSlots:U=gi[S]||0;U=Math.max(0,U);const te=gi[S]||0,be=te+(U-te)*lf;yo[S]=parseFloat(be.toFixed(2))});const n=Math.max(0,(Ys=ao!=null?ao:o)!=null?Ys:0),c=(Lt==null?void 0:Lt.market)||{},y=Math.max(0,(Xs=c.supplyDemandWeight)!=null?Xs:1),w=Math.max(0,c.virtualDemandPerPop||0),E=l0(oe),I=Math.max(.1,((zs=c.inventoryTargetDays)!=null?zs:1.5)*E),q=Math.max(0,(Js=c.inventoryPriceImpact)!=null?Js:.25);Object.keys(De).forEach(S=>{var Wt,Fe;if(!Jt(S))return;const G=De[S],U=(G==null?void 0:G.marketConfig)||{};U.supplyDemandWeight!==void 0&&Math.max(0,U.supplyDemandWeight);const X=U.virtualDemandPerPop!==void 0?Math.max(0,U.virtualDemandPerPop):w,te=U.inventoryTargetDays!==void 0?Math.max(.1,U.inventoryTargetDays*E):I;U.inventoryPriceImpact!==void 0&&Math.max(0,U.inventoryPriceImpact),Io[S];const be=mo[S]||0,me=X*n,at=be+me,ft=ie[S]||0,Xe=ft<=0?.01:at>0?ft/at:te,Ke=[];let ge=0;Vt.forEach(Ie=>{const Re=no[Ie.id]||0;if(Re<=0)return;const Ce=se[Ie.id]||{};let Tt=0;Object.entries(Ce).forEach(([jt,ke])=>{const Ue=parseInt(jt);Number.isFinite(Ue)&&Ue>0&&ke>0&&(Tt+=ke)});const Et={0:Math.max(0,Re-Tt)};Object.entries(Ce).forEach(([jt,ke])=>{const Ue=parseInt(jt);Number.isFinite(Ue)&&Ue>0&&ke>0&&(Et[Ue]=ke)}),Object.entries(Et).forEach(([jt,ke])=>{var Qo,fi,Ko,re,bt;const Ue=parseInt(jt),Je=Ot(Ie,Ue),Pt=(Qo=Je.output)==null?void 0:Qo[S];if(!Pt||Pt<=0)return;const At=Ie.marketConfig||{},ro=At.price||(Lt==null?void 0:Lt.price)||{},st=At.wage||(Lt==null?void 0:Lt.wage)||{};jn($n,ro);const Eo=jn($n,st);Je.input&&Object.entries(Je.input).forEach(([so,Kt])=>{!Kt||Kt<=0||(ot[so]||Ao(so),ji(so))});const ct=Ie.owner,Yt=Je.jobs||{},Qt=ct&&Yt[ct];Object.keys(Yt).length>0&&!Qt&&Object.entries(Yt).forEach(([so,Kt])=>{!Kt||Kt<=0||yo[so]||ho(so)}),(Ko=(fi=qt==null?void 0:qt.businessTaxRates)==null?void 0:fi[Ie.id])!=null,(re=Ie.businessTaxBase)!=null,ct&&(Eo[ct]||0)*(Yt[ct]||0);const Rt=Xe/te;let St=1;Rt<.5?St=1+(1-Rt*2)*5:Rt<1?St=1+(1-Rt)*1:Rt>2?(St=.7-(Rt-2)*.3,St=Math.max(.1,St)):Rt>1&&(St=1-(Rt-1)*.3);let ve=Ao(S)*St;const gt=(bt=G.minPrice)!=null?bt:Wi,Xt=G.maxPrice;ve=Math.max(ve,gt),Xt!==void 0&&(ve=Math.min(ve,Xt));const Bt=Pt*ke;ge+=Bt,Ke.push({price:ve,output:Bt})})});let Ne=0;if(ge>0&&Ke.length>0){let Ie=0;Ke.forEach(Re=>{Ie+=Re.price*Re.output}),Ne=Ie/ge}else{const Ie=Ao(S),Re=Xe/te;let Ce=1;Re<.5?Ce=1+(1-Re*2)*5:Re<1?Ce=1+(1-Re)*1:Re>2?(Ce=.7-(Re-2)*.3,Ce=Math.max(.1,Ce)):Re>1&&(Ce=1-(Re-1)*.3),Ne=Ie*Ce;const Tt=(Wt=G.minPrice)!=null?Wt:Wi,Et=G.maxPrice;Ne=Math.max(Ne,Tt),Et!==void 0&&(Ne=Math.min(Ne,Et))}let He=0;yt.forEach(Ie=>{Ie.isAtWar===!0&&He++});let Pe=0;yt.forEach(Ie=>{!Ie.isPlayer&&Ie.foreignWars&&Object.values(Ie.foreignWars).forEach(Re=>{Re!=null&&Re.isAtWar&&Pe++})}),Pe=Math.floor(Pe/2);const ze=1+He*.025+Pe*.01,de=Ne*ze,rt=ot[S]||de,qe=rt+(de-rt)*.1,Se=(Fe=G.minPrice)!=null?Fe:Wi,dt=G.maxPrice;let et=qe;et=Math.max(et,Se),dt!==void 0&&(et=Math.min(et,dt)),Mn[S]=parseFloat(et.toFixed(2))})}const uf=n=>{const c=(k||{})[n];if(!c||c.length<2)return null;const y=c[c.length-1],w=c[c.length-2],E=Math.max(1,(i==null?void 0:i[n])||0);return(y-w)/E},ff=n=>{const c=Yn[n];return!c||c.length===0?!1:c.some(y=>y&&y.availableSlots>0)},df=(n,c)=>{const y=Yn[n];if(!y||y.length===0||c<=0)return null;let w=-1,E=0;for(let G=0;G<y.length;G++){const U=y[G];if(!U)continue;const X=U.availableSlots>=1?Math.floor(U.availableSlots):U.availableSlots>0?1:0;X>E&&(E=X,w=G)}if(w===-1||E<=0)return null;const I=y[w],q=Math.min(c,E),S={buildingId:I.buildingId,buildingName:I.buildingName,count:q};return I.availableSlots-=q,I.availableSlots<=0&&y.splice(w,1),S},Ps=(n=[])=>Array.isArray(n)?n.reduce((c,y)=>c+Math.max(0,(y==null?void 0:y.capitalLocked)||0),0):0,pf=Math.max(0,(Zs=P==null?void 0:P.lockedCapital)!=null?Zs:Ps((P==null?void 0:P.pendingTrades)||[])),hf=uo.merchant||0;Ki("simulation","[SIMULATION DEBUG] Calling simulateMerchantTrade, policies:",{hasExportTariff:!!qt.exportTariffMultipliers,hasImportTariff:!!qt.importTariffMultipliers,merchantPop:(J==null?void 0:J.merchant)||0});const Do=Y0({ledger:nt,res:ie,wealth:We,popStructure:J,supply:Io,demand:mo,nations:yt,tick:m,taxPolicies:qt,taxBreakdown:$t,getLocalPrice:io,roleExpense:wt,roleWagePayout:ut,pendingTrades:P.pendingTrades||[],lastTradeTime:P.lastTradeTime||0,gameSpeed:s,classFinancialData:ht,logs:Ge,potentialResources:ln,merchantAssignments:P.merchantAssignments||P.assignments||null,merchantTradePreferences:P.merchantTradePreferences||null,shouldLogMerchantTrades:(Ks=(Qs=je==null?void 0:je.logVisibility)==null?void 0:Qs.showMerchantTradeLogs)!=null?Ks:!0,shouldLogOfficialEvents:(tc=(ec=je==null?void 0:je.logVisibility)==null?void 0:ec.showOfficialLogs)!=null?tc:!0,onTreasuryChange:Le}),As=Math.max(0,(oc=Do.lockedCapital)!=null?oc:Ps(Do.pendingTrades));Do.lockedCapital=As;const mf=Do.capitalInvestedThisTick||0;"capitalInvestedThisTick"in Do&&delete Do.capitalInvestedThisTick;const Rs=Do.completedTrades||[];if(Rs.length>0){const n={export:{},import:{}},c={};let y=0;Rs.forEach(E=>{var G;const I=E.resource;n[E.type][I]||(n[E.type][I]={amount:0,profit:0}),n[E.type][I].amount+=E.amount,n[E.type][I].profit+=E.profit,y+=E.profit;const q=E.partnerId||"unknown";if(!c[q]){const U=yt.find(X=>(X==null?void 0:X.id)===q);c[q]={name:(U==null?void 0:U.name)||q,exports:[],imports:[]}}const S=((G=De[I])==null?void 0:G.name)||I;E.type==="export"?c[q].exports.push(`${S}x${E.amount.toFixed(1)}`):c[q].imports.push(`${S}x${E.amount.toFixed(1)}`)});const w=[];if(Object.values(c).forEach(E=>{const I=[];E.exports.length>0&&I.push(`出口${E.exports.join(",")}`),E.imports.length>0&&I.push(`进口${E.imports.join(",")}`),I.length>0&&w.push(`${E.name}(${I.join(", ")})`)}),w.length>0&&Do.shouldLogMerchantTrades){const E=y>=0?`盈利${y.toFixed(1)}`:`亏损${Math.abs(y).toFixed(1)}`;Ge.push(`📦 商人贸易完成: ${w.join("; ")}，${E}银币`)}if(W.tradeBonusMod&&y>0){const E=y*W.tradeBonusMod;We.merchant=(We.merchant||0)+E,ht!=null&&ht.merchant&&(ht.merchant.income.ownerRevenue=(ht.merchant.income.ownerRevenue||0)+E)}}"completedTrades"in Do&&delete Do.completedTrades;const Ss={};Ht.forEach(n=>{Ss[n]=Math.max(0,(Zt[n]||0)-(J[n]||0))});const gf=n=>n==="merchant"?(uo.merchant||0)+As:uo[n]||0,yf=n=>n==="merchant"?((f==null?void 0:f.merchant)||0)+pf:(f==null?void 0:f[n])||0,la=j0.getOrCompute(m,"vacantRoleIncomeCache",()=>new Map),bf=n=>{var X,te,be;if(la.has(n))return la.get(n);const c=1.2;let y=0,w=0,E=0,I=0;Vt.forEach(me=>{var ge,Ne,He,Pe,ze,de,rt,qe,Se,dt;const Me=no[me.id]||0;if(Me<=0)return;const at=Ot(me,0),ft=at.jobs||{},Xe=ft[n]||0;if(Xe<=0)return;if(me.owner===n){let et=0;at.output&&Object.entries(at.output).forEach(([Ue,Je])=>{if(!Je||Je<=0||!De[Ue])return;const Pt=ot[Ue]||Ao(Ue);et+=Je*Pt});let Wt=0;at.input&&Object.entries(at.input).forEach(([Ue,Je])=>{if(!Je||Je<=0)return;const Pt=ot[Ue]||Ao(Ue);Wt+=Je*Pt});let Fe=0;Object.entries(ft).forEach(([Ue,Je])=>{var At,ro,st;if(Ue===n||!Je||Je<=0)return;const Pt=(st=(ro=yo==null?void 0:yo[Ue])!=null?ro:(At=l==null?void 0:l.wages)==null?void 0:At[Ue])!=null?st:ho(Ue);Fe+=Pt*Je});const Re=((Ne=(ge=ae[n])==null?void 0:ge.headTaxBase)!=null?Ne:.01)*ai(n)*ri,Ce=(He=me.businessTaxBase)!=null?He:.1,Tt=(ze=(Pe=qt==null?void 0:qt.businessTaxRates)==null?void 0:Pe[me.id])!=null?ze:1,Et=Ce*Tt,jt=et-Wt-Fe-Re-Et,ke=Xe>0?jt/Xe:0;y+=ke*Xe*Me,w+=Xe*Me}else{const et=(qe=(rt=yo==null?void 0:yo[n])!=null?rt:(de=l==null?void 0:l.wages)==null?void 0:de[n])!=null?qe:ho(n),Fe=((dt=(Se=ae[n])==null?void 0:Se.headTaxBase)!=null?dt:.01)*ai(n)*ri,Ie=et-Fe;E+=Ie*Xe*Me,I+=Xe*Me}});const q=w+I;if(q<=0){const Me=((be=(te=yo==null?void 0:yo[n])!=null?te:(X=l==null?void 0:l.wages)==null?void 0:X[n])!=null?be:ho(n))*c;return la.set(n,Me),Me}const G=(y+E)/q,U=Math.max(0,G*c);return la.set(n,U),U},ua=Ht.map(n=>{var ze,de;const c=J[n]||0,y=gf(n),w=yf(n),E=y-w,I=c>0?y/c:0,q=c>0?E/c:0,S=ut[n]||0,G=wt[n]||0,U=n==="merchant"?mf:0,te=(S-G+U)/Math.max(1,c),be=yo[n]||ho(n),Me=((de=(ze=ae[n])==null?void 0:ze.headTaxBase)!=null?de:.01)*ai(n)*ri,at=be-Me,ft=uf(n),Xe=n==="merchant"?te:q,Ke=ft!==null?ft:Xe,ge=te!==0?te:at;let Ne;c===0?Ne=bf(n):n==="merchant"||Ke!==0?Ne=n==="merchant"?ge:Ke:Ne=ge;const He=I>0?I*.002:0,Pe=Ne+He;return{role:n,pop:c,perCap:I,perCapDelta:Xe,potentialIncome:Pe,vacancy:Ss[n]||0}}).filter(n=>n.role!=="official"),fa=ua.reduce((n,c)=>c.pop>0?n+c.pop:n,0);fa>0&&ua.reduce((n,c)=>n+c.potentialIncome*c.pop,0)/fa,fa>0&&ua.reduce((n,c)=>n+c.perCap*c.pop,0)/fa;const Is={};Object.keys(De).forEach(n=>{const c=Io[n]||0,y=mo[n]||0;Is[n]=y>0?c/y:c>0?999:1});const Zo={};Vt.forEach(n=>{if((no[n.id]||0)<=0)return;const y=Ot(n,0),w=y.output||{},E=y.jobs||{},I=Object.keys(w).filter(q=>De[q]);I.length!==0&&(Object.keys(E).forEach(q=>{Zo[q]||(Zo[q]=[]),I.forEach(S=>{Zo[q].includes(S)||Zo[q].push(S)})}),n.owner&&!Zo[n.owner]&&(Zo[n.owner]=[]),n.owner&&I.forEach(q=>{Zo[n.owner].includes(q)||Zo[n.owner].push(q)}))});const Ja=Q0({popStructure:J,wealth:We,roleMetrics:ua,hasBuildingVacancyForRole:ff,reserveBuildingVacancyForRole:df,logs:Ge,migrationCooldowns:ce,supplyDemandRatio:Is,roleProducesResource:Zo});Object.assign(J,Ja.popStructure),Object.assign(We,Ja.wealth);const ks=Ja.migrationCooldowns;Object.keys(ae).forEach(n=>{uo[n]=Math.max(0,We[n]||0)}),si=Object.values(uo).reduce((n,c)=>n+c,0),Object.keys(ae).forEach(n=>{var c;if(n!=="official"&&Ui[n]){const y=J[n]||0,w=uo[n]||0,E=((c=ae[n])==null?void 0:c.startingWealth)||100,I=y>0?w/y:0;Ui[n].wealthPerCapita=I,Ui[n].wealthRatio=E>0?I/E:0}});const Ds=Math.max(0,We.merchant||0);if(Ds-hf!==0){const n=ae.merchant;if(n){const c=J.merchant||0,y=n.influenceBase*c+(si>0?Ds/si*10:0),w=y-(lo.merchant||0);lo.merchant=y,ci+=w}}const Dt={...se},Mf=1.5,vf=.02;Vt.forEach(n=>{var te,be,me;const c=n.id,y=no[c]||0;if(y<=0)return;const w=In(c);if(w<=0)return;const E=n.owner;if(!E||E==="state")return;const I=J[E]||0;if(I<=0)return;const q=We[E]||0,S=q/I,G=Dt[c]||{};let U=0;for(const[,Me]of Object.entries(G))typeof Me=="number"&&Me>0&&(U+=Me);const X=y-U;for(let Me=0;Me<w;Me++){if((Me===0?X:G[Me]||0)<=0)continue;const ft=kn(c,Me+1,0);if(!ft)continue;let Xe=0;for(const[Pe,ze]of Object.entries(ft))if(Pe==="silver")Xe+=ze;else{const de=ot[Pe]||1;Xe+=ze*de}if(S<Mf*Xe||Math.random()>vf||!Object.entries(ft).every(([Pe,ze])=>Pe==="silver"?!0:(ie[Pe]||0)>=ze)||q<Xe)continue;Object.entries(ft).forEach(([Pe,ze])=>{Pe!=="silver"&&Ee(Pe,-ze,"building_construction_cost")}),nt.transfer(E,"void",Xe,Z.EXPENSE.BUILDING_COST,Z.EXPENSE.BUILDING_COST),Dt[c]||(Dt[c]={}),Me>0&&(Dt[c][Me]=Math.max(0,(Dt[c][Me]||0)-1),Dt[c][Me]<=0&&delete Dt[c][Me]);const ge=Me+1;Dt[c][ge]=(Dt[c][ge]||0)+1,Object.keys(Dt[c]).length===0&&delete Dt[c];const Ne=((te=ae[E])==null?void 0:te.name)||E,He=((me=(be=Sn[c])==null?void 0:be[Me])==null?void 0:me.name)||`等级${ge}`;Ge.push(`??? ${Ne}自发投资了自己的产业 ${n.name} → ${He}（花费 ${Math.ceil(Xe)} 银币）`);break}}),Ga.length>0&&Ga.forEach(n=>{const{buildingId:c,fromLevel:y,toLevel:w,officialName:E,cost:I}=n;Dt[c]||(Dt[c]={}),y>0&&(Dt[c][y]=Math.max(0,(Dt[c][y]||0)-1),Dt[c][y]<=0&&delete Dt[c][y]),Dt[c][w]=(Dt[c][w]||0)+1,Object.keys(Dt[c]).length===0&&delete Dt[c],Ge.push(`??? 官员${E}升级了 ${c}（花费 ${Math.ceil(I)} 银）`)}),Object.keys(ae).forEach(n=>{uo[n]=Math.max(0,We[n]||0)}),si=Object.values(uo).reduce((n,c)=>n+c,0);const Ws=na*(1+(W.taxEfficiencyBonus||0)-(W.corruption||0)),Pi=Math.max(0,Math.min(1,Ws)),da=$t.headTax*Pi,pa=$t.industryTax*Pi,ha=$t.businessTax*Pi,ma=($t.tariff||0)*Pi,Za=$t.headTax+$t.industryTax+$t.businessTax+($t.tariff||0),wf=Math.max(0,Math.min(1,na*(1+(W.taxEfficiencyBonus||0)))),ga=Za*(1-Pi);console.log("[TAX DEBUG] Efficiency Calc:",{efficiency:na,bonuses:W.taxEfficiencyBonus,rawTaxEfficiency:Ws,effectiveTaxEfficiency:Pi,taxBase:Za,efficiencyLoss:ga,officialsCount:xi.length}),ga>0&&(Le(-ga,"tax_efficiency_loss"),console.log("[TAX DEBUG] Applied efficiency loss:",-ga));const Qa=Math.max(0,Za*(wf-Pi));if(Qa>0&&xi.length>0){const n=xe?1:.5,c=xi.map(I=>{var G,U,X;const q=(((G=I.effects)==null?void 0:G.corruption)||0)+(((U=I.drawbacks)==null?void 0:U.corruption)||0),S=((X=Aa[I.financialSatisfaction])==null?void 0:X.corruption)||0;return Math.max(0,(q+S)*n)}),y=c.reduce((I,q)=>I+q,0),w=Qa/xi.length;let E=0;xi.forEach((I,q)=>{const S=y>0?Qa*(c[q]/y):w;S<=0||(I.wealth=Math.max(0,(I.wealth||0)+S),E+=S)}),E>0&&(mn+=E,We.official=mn,uo.official=Math.max(0,We.official),si=Object.values(uo).reduce((I,q)=>I+q,0),Fi+=E,nt.transfer("void","official",E,Z.INCOME.CORRUPTION,Z.INCOME.CORRUPTION))}const Bs=$t.tariffSubsidy||0,Ka=da+pa+ha+ma,xf=Ka+li,Wo=Math.max(0,1+Gu),Ef=da*Wo,Cf=pa*Wo,_f=ha*Wo,Tf=ma*Wo;if(Wo>1){const n=da*(Wo-1),c=pa*(Wo-1),y=ha*(Wo-1),w=ma*(Wo-1);n>0&&Le(n,"headTax"),c>0&&Le(c,"transactionTax"),y>0&&Le(y,"businessTax"),w>0&&Le(w,"tariffs")}_e.silver=(_e.silver||0)+Ef+Cf+_f+Tf;const er=li*(Wo-1);if(er>0&&(Le(er,"income_war_indemnity_bonus"),_e.silver=(_e.silver||0)+er),li>0&&(_e.silver=(_e.silver||0)+li),yi>0&&(Le(yi,"income_policy"),_e.silver=(_e.silver||0)+yi),Ni>0){const n=Math.min(ie.silver||0,Ni);n>0&&(Le(-n,"expense_policy"),_e.silver=(_e.silver||0)-n)}$t.policyIncome=yi,$t.policyExpense=Ni;const Pf=(Ka+li)*Wo,vn=$t.priceControlIncome||0,Os=$t.priceControlExpense||0,wn=Number.isFinite(pt)?pt:0;vn!==0&&(Le(vn,"income_price_control"),_e.silver=(_e.silver||0)+vn),wn!==0&&(Le(wn,"income_trade_route"),_e.silver=(_e.silver||0)+wn);const Af={total:Ka-$t.subsidy-Bs+li+yi-Ni+wn+vn-Os,efficiency:na,breakdown:{headTax:da,industryTax:pa,businessTax:ha,tariff:ma,tariffSubsidy:Bs,subsidy:$t.subsidy,warIndemnity:li,policyIncome:yi,policyExpense:Ni,priceControlIncome:vn,priceControlExpense:Os,tradeRouteTax:wn,baseFiscalIncome:xf,totalFiscalIncome:Pf,incomePercentMultiplier:Wo,_debug_tariffPolicies:{hasExport:!!qt.exportTariffMultipliers,hasImport:!!qt.importTariffMultipliers,rawTariff:$t.tariff||0}}};if(ut.official=Fi||0,xo&&(xo.official=[]),Xn.size>0&&Xn.forEach((n,c)=>{Ge.push(n>1?`${c}（共${n}处）`:c)}),Ct.length>0){const n=_u({foreignInvestments:Vo,nations:yt,organizations:(x==null?void 0:x.organizations)||[],playerMarket:{prices:Mn},playerResources:ie,foreignInvestmentPolicy:he,daysElapsed:m,jobFill:dn,buildings:no});Vo=n.updatedInvestments,So.push(...n.logs),n.taxRevenue>0&&Le(n.taxRevenue,"foreign_investment_tax"),n.marketChanges&&Object.entries(n.marketChanges).forEach(([y,w])=>{y!=="silver"&&Ee(y,w,"autonomous_investment_return")});const c=Tu({foreignInvestments:Vo,nations:yt,playerMarket:{prices:Mn},playerResources:ie,buildingUpgrades:Dt,buildingCounts:no,daysElapsed:m});c.upgrades&&c.upgrades.length>0&&(Vo=c.updatedInvestments,So.push(...c.logs),c.upgrades.forEach(y=>{const w=yt.find(E=>E.id===y.ownerNationId);w&&(w.wealth=Math.max(0,(w.wealth||0)-y.cost))}))}Ge.push(...So),$e!=null&&$e.tradeLog&&Ge.push(...$e.tradeLog);const Rf=m%10===0?H0({nations:yt,res:ie,supply:Io,demand:mo,market:{prices:Mn},tick:m,taxPolicies:qt,merchantTradePreferences:Do.merchantTradePreferences}):It,Sf=Cu(Vo);return{tradeOpportunities:Rf,tradeRoutes:pe?{...pe,routes:pe.routes.filter(n=>{var c;return!((c=$e==null?void 0:$e.routesToRemove)!=null&&c.includes(n))})}:void 0,overseasInvestments:co,foreignInvestments:Vo,resources:ie,rates:_e,popStructure:J,maxPop:No,militaryCapacity:ds,population:ao,birthAccumulator:bn,classApproval:wo,approvalBreakdown:xt,classInfluence:lo,classWealth:uo,classLivingStandard:Ui,totalInfluence:ci,totalWealth:si,activeBuffs:Ha,activeDebuffs:Ya,stability:Ts,legitimacy:fn,legitimacyTaxModifier:ja,logs:Ge,market:{prices:Mn,demand:mo,supply:Io,wages:yo,needsShortages:xo,stratumConsumption:zo,supplyBreakdown:jo,demandBreakdown:rn},classIncome:ut,classExpense:wt,jobFill:dn,jobsAvailable:Zt,taxes:Af,classFinancialData:ht,buildingFinancialData:vo,buildingDebugData:rs,dailyMilitaryExpense:Zn,needsShortages:xo,needsReport:wi,livingStandardStreaks:Cs,nations:yt,merchantState:Do,buildingUpgrades:Dt,migrationCooldowns:ks,migrationCooldowns:ks,diplomacyOrganizations:ca?{organizations:go}:null,taxShock:_s,modifiers:{resourceDemand:{...sn,...Object.fromEntries(Object.entries(B).map(([n,c])=>[n,(sn[n]||0)+c]))},stratumDemand:{...cn,...Object.fromEntries(Object.entries(O).map(([n,c])=>[n,(cn[n]||0)+c]))},resourceSupply:Ia,buildingProduction:{...Gn,...H},categoryProduction:Vn,sources:{decreeResourceDemand:sn,decreeStratumDemand:cn,decreeResourceSupply:Ia,eventResourceDemand:B,eventStratumDemand:O,eventBuildingProduction:H,techBuildingBonus:Gn,techCategoryBonus:Vn,productionBonus:Da,industryBonus:Wa,militaryBonus:W.militaryBonus,stratumWealthMultiplier:Qn,productionInputCost:(()=>{const n={},c=W.officialProductionInputCost||{},y=W.stanceProductionInputCost||{};return new Set([...Object.keys(c),...Object.keys(y)]).forEach(E=>{n[E]=(c[E]||0)+(y[E]||0)}),n})()},officialEffects:{buildingCostMod:W.buildingCostMod||0,militaryUpkeepMod:W.militaryUpkeepMod||0,taxEfficiencyBonus:W.taxEfficiencyBonus||0,corruption:W.corruption||0,populationGrowthBonus:W.populationGrowthBonus||0,tradeBonusMod:W.tradeBonusMod||0,organizationGrowthMod:W.organizationGrowthMod||0,wartimeProduction:W.wartimeProduction||0,resourceWaste:W.resourceWaste||{},coalitionApproval:W.coalitionApproval||0,legitimacyBonus:W.legitimacyBonus||0,factionConflict:W.factionConflict||0,diplomaticCooldown:W.diplomaticCooldown||0,diplomaticIncident:W.diplomaticIncident||0}},foreignInvestmentStats:Sf,army:b,officials:xi,effectiveOfficialCapacity:El(u,qn||{},_),buildings:no,_debug:{freeMarket:nf,silverChangeLog:(()=>{const n=_t.toArray(),c=n.some(y=>y.reason==="expense_army_maintenance");return console.log("[Simulation End] silverChangeLog has military?",c,"Entries:",n.length),n})(),classWealthChangeLog:it,startingSilver:oo,endingSilver:ie.silver||0,militaryDebugInfo:pn}}};self.onmessage=function(e){const{type:t,payload:o}=e.data;if(t==="SIMULATE")try{const i=ku(o);self.postMessage({type:"RESULT",payload:i})}catch(i){self.postMessage({type:"ERROR",error:i.message||"Unknown simulation error"})}else t==="PING"&&self.postMessage({type:"PONG"})},self.postMessage({type:"READY"})})();
