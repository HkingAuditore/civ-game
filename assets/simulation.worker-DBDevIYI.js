(function(){"use strict";const Ut={price:{livingCostWeight:.15,taxCostWeight:.1},wage:{livingCostWeight:.1,taxCostWeight:.1},market:{virtualDemandPerPop:.01,supplyDemandWeight:1,inventoryTargetDays:365,inventoryPriceImpact:.25,demandElasticity:.5,outputVariation:.2}},Oe={food:{name:"粮食",icon:"Wheat",color:"text-yellow-400",basePrice:1,minPrice:.1,maxPrice:10,defaultOwner:"peasant",unlockEpoch:0,tags:["essential","raw_material"],marketConfig:{supplyDemandWeight:.4,inventoryTargetDays:730,inventoryPriceImpact:.15,demandElasticity:.2,outputVariation:.2}},wood:{name:"木材",icon:"Trees",color:"text-emerald-400",basePrice:2,minPrice:.02,maxPrice:20,defaultOwner:"lumberjack",unlockEpoch:0,tags:["raw_material"],marketConfig:{supplyDemandWeight:.7,inventoryTargetDays:550,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},stone:{name:"石料",icon:"Pickaxe",color:"text-stone-400",basePrice:3,minPrice:.03,maxPrice:30,defaultOwner:"miner",unlockEpoch:0,tags:["raw_material"],marketConfig:{supplyDemandWeight:.7,inventoryTargetDays:550,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},cloth:{name:"布料",icon:"Shirt",color:"text-indigo-300",basePrice:1.5,minPrice:.015,maxPrice:15,defaultOwner:"worker",unlockEpoch:0,tags:["essential","raw_material","manufactured"],marketConfig:{supplyDemandWeight:.8,inventoryTargetDays:600,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},brick:{name:"砖块",icon:"Home",color:"text-red-400",basePrice:6,minPrice:.06,maxPrice:60,defaultOwner:"artisan",unlockEpoch:0,unlockTech:"pottery",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:270,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},tools:{name:"工具",icon:"Anvil",color:"text-blue-300",basePrice:16,minPrice:.16,maxPrice:160,defaultOwner:"artisan",unlockEpoch:0,unlockTech:"tool_making",tags:["industrial"],marketConfig:{supplyDemandWeight:1.2,inventoryTargetDays:300,inventoryPriceImpact:.35,demandElasticity:.6,outputVariation:.2}},plank:{name:"木板",icon:"TreeDeciduous",color:"text-amber-600",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"worker",unlockEpoch:1,unlockTech:"tools",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:240,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},copper:{name:"铜矿",icon:"Pickaxe",color:"text-orange-400",basePrice:5.5,minPrice:.055,maxPrice:55,defaultOwner:"miner",unlockEpoch:1,unlockTech:"copper_mining",tags:["raw_material"],marketConfig:{supplyDemandWeight:.9,inventoryTargetDays:300,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},dye:{name:"染料",icon:"Droplets",color:"text-pink-500",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"artisan",unlockEpoch:1,tags:["industrial","raw_material"],marketConfig:{supplyDemandWeight:1.1,inventoryTargetDays:200,inventoryPriceImpact:.35,demandElasticity:.6,outputVariation:.2}},papyrus:{name:"纸张",icon:"ScrollText",color:"text-lime-300",basePrice:6.5,minPrice:.065,maxPrice:65,defaultOwner:"scribe",unlockEpoch:2,unlockTech:"papyrus_cultivation",tags:["raw_material","manufactured"],marketConfig:{supplyDemandWeight:1.1,inventoryTargetDays:240,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},delicacies:{name:"珍馐",icon:"UtensilsCrossed",color:"text-rose-400",basePrice:24,minPrice:.24,maxPrice:240,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"culinary_arts",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.5,inventoryTargetDays:90,inventoryPriceImpact:.45,demandElasticity:1.3,outputVariation:.2}},furniture:{name:"家具",icon:"Armchair",color:"text-amber-500",basePrice:28,minPrice:.28,maxPrice:280,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"carpentry",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.5,inventoryTargetDays:120,inventoryPriceImpact:.4,demandElasticity:1.2,outputVariation:.2}},ale:{name:"美酒",icon:"Wine",color:"text-purple-400",basePrice:18,minPrice:.18,maxPrice:180,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"brewing",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.6,inventoryTargetDays:150,inventoryPriceImpact:.5,demandElasticity:1.5,outputVariation:.2}},fine_clothes:{name:"华服",icon:"Shirt",color:"text-purple-400",basePrice:32,minPrice:.32,maxPrice:320,defaultOwner:"artisan",unlockEpoch:2,tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.6,inventoryTargetDays:100,inventoryPriceImpact:.5,demandElasticity:1.5,outputVariation:.2}},iron:{name:"铁矿",icon:"Pickaxe",color:"text-zinc-400",basePrice:8,minPrice:.08,maxPrice:80,defaultOwner:"miner",unlockEpoch:2,unlockTech:"ironworking",tags:["raw_material"],marketConfig:{supplyDemandWeight:.8,inventoryTargetDays:500,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},spice:{name:"香料",icon:"Leaf",color:"text-amber-400",basePrice:26,minPrice:.26,maxPrice:260,defaultOwner:"merchant",unlockEpoch:4,unlockTech:"cartography",tags:["essential","manufactured"],marketConfig:{supplyDemandWeight:1.4,inventoryTargetDays:180,inventoryPriceImpact:.4,demandElasticity:.9,outputVariation:.2}},coffee:{name:"咖啡",icon:"Coffee",color:"text-amber-700",basePrice:24,minPrice:.24,maxPrice:240,defaultOwner:"merchant",unlockEpoch:5,unlockTech:"coffee_agronomy",tags:["essential","manufactured"],marketConfig:{supplyDemandWeight:1.2,inventoryTargetDays:240,inventoryPriceImpact:.35,demandElasticity:.8,outputVariation:.2}},coal:{name:"煤炭",icon:"Flame",color:"text-slate-300",basePrice:7.5,minPrice:.075,maxPrice:75,defaultOwner:"miner",unlockEpoch:6,unlockTech:"coal_gasification",tags:["raw_material"],marketConfig:{supplyDemandWeight:.9,inventoryTargetDays:365,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},steel:{name:"钢材",icon:"Cog",color:"text-gray-300",basePrice:40,minPrice:.4,maxPrice:400,defaultOwner:"engineer",unlockEpoch:6,unlockTech:"steel_alloys",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:300,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},silver:{name:"银币",icon:"Coins",color:"text-slate-200",type:"currency",basePrice:1,minPrice:1,maxPrice:1,unlockEpoch:0,tags:["currency"]},science:{name:"科研",icon:"Cpu",color:"text-cyan-400",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"official",unlockEpoch:0,tags:["special","manufactured"],marketConfig:{supplyDemandWeight:.5,inventoryTargetDays:730,inventoryPriceImpact:.15,demandElasticity:.2,outputVariation:.1}},culture:{name:"文化",icon:"ScrollText",color:"text-pink-400",basePrice:2,minPrice:.025,maxPrice:10,defaultOwner:"cleric",unlockEpoch:1,unlockTech:"amphitheater_design",tags:["special","manufactured"],marketConfig:{supplyDemandWeight:.6,inventoryTargetDays:600,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.15}},maxPop:{name:"人口上限",icon:"Users",color:"text-blue-400",type:"virtual",tags:["special"]},militaryCapacity:{name:"军事容量",icon:"Shield",color:"text-red-400",type:"virtual",tags:["special"]}},ba={MAX_HEAD_TAX:1e4},gi=[{id:0,name:"石器时代",color:"text-stone-400",bg:"bg-stone-900",tileColor:"bg-stone-700",req:{science:0},cost:{},bonuses:{desc:"文明的起源，一切从这里开始。",gatherBonus:.2}},{id:1,name:"青铜时代",color:"text-orange-400",bg:"bg-orange-950",tileColor:"bg-orange-800",req:{science:600,population:25},cost:{food:6e3,wood:3500,stone:1200,silver:600,science:600},bonuses:{desc:"掌握青铜冶炼与畜力生产，资源获取加速。",gatherBonus:.4,militaryBonus:.2,industryBonus:.2}},{id:2,name:"古典时代",color:"text-amber-300",bg:"bg-amber-900",tileColor:"bg-amber-700",req:{science:1800,population:90,culture:250},cost:{food:2e4,wood:1e4,brick:3600,silver:5e3,tools:1200,science:1800},bonuses:{desc:"哲学与艺术的萌芽，文明全方位提升。",gatherBonus:.6,militaryBonus:.3,cultureBonus:.2,scienceBonus:.2,industryBonus:.3,maxPop:.1}},{id:3,name:"封建时代",color:"text-blue-400",bg:"bg-blue-950",tileColor:"bg-blue-800",req:{science:4500,population:170,culture:600},cost:{food:1e5,wood:5e4,brick:25e3,iron:12500,papyrus:5e3,silver:15e3,science:4500},bonuses:{desc:"封建制度确立，人口与经济快速增长。",gatherBonus:.8,militaryBonus:.4,cultureBonus:.3,scienceBonus:.3,industryBonus:.4,taxIncome:.2}},{id:4,name:"探索时代",color:"text-cyan-300",bg:"bg-cyan-900",tileColor:"bg-cyan-700",req:{science:8e3,population:320,culture:1400},cost:{food:26e4,plank:7e4,brick:6e4,iron:35e3,silver:4e4,science:8e3},bonuses:{desc:"大航海开启，贸易与工业蓬勃发展。",gatherBonus:1.2,militaryBonus:.45,cultureBonus:.4,scienceBonus:.5,industryBonus:.6,incomePercent:.5}},{id:5,name:"启蒙时代",color:"text-purple-400",bg:"bg-purple-950",tileColor:"bg-purple-800",req:{science:12e3,population:450,culture:2500},cost:{food:35e4,plank:8e4,papyrus:3e4,spice:2e4,silver:5e4,science:12e3},bonuses:{desc:"理性的光辉照耀，科学与文化大幅提升。",gatherBonus:1.5,militaryBonus:.5,cultureBonus:.6,scienceBonus:.8,industryBonus:1,stability:10}},{id:6,name:"工业时代",color:"text-gray-200",bg:"bg-gray-800",tileColor:"bg-gray-600",req:{science:2e4,population:650,culture:4e3},cost:{food:75e4,brick:18e4,iron:12e4,tools:75e3,spice:3e4,silver:12e4,science:2e4},bonuses:{desc:"机械化大生产，工业产能爆炸式增长。",gatherBonus:2,militaryBonus:.6,cultureBonus:.8,scienceBonus:1.2,industryBonus:2,maxPop:.2}},{id:7,name:"信息时代",color:"text-green-400",bg:"bg-green-950",tileColor:"bg-green-800",req:{science:35e3,population:1e3,culture:8e3},cost:{food:2e6,tools:3e5,silver:25e4,spice:8e4,papyrus:1e5,science:35e3},bonuses:{desc:"数字革命改变世界，知识和信息成为核心生产力。",gatherBonus:3,militaryBonus:.8,cultureBonus:1.5,scienceBonus:3,industryBonus:3,incomePercent:1}}],ae={peasant:{name:"自耕农",icon:"Wheat",weight:1,tax:1,headTaxBase:.01,desc:"社会的基础，提供稳定的粮食和兵源。",wealthWeight:1,influenceBase:.5,startingWealth:80,defaultResource:"food",wealthElasticity:.5,maxConsumptionMultiplier:3,needs:{food:.42,cloth:.06},luxuryNeeds:{1:{ale:.05},1.5:{wood:.03,culture:.02},2:{plank:.045,stone:.015},2.5:{furniture:.03,tools:.03},3:{spice:.06,brick:.03,culture:.04},4.5:{copper:.006,plank:.02},5.5:{delicacies:.04,fine_clothes:.02,culture:.05},7:{coffee:.04,spice:.03},8:{delicacies:.05,culture:.06,furniture:.02}},buffs:{satisfied:{desc:"民心稳定",taxIncome:.1,production:.05},dissatisfied:{desc:"民怨沸腾",taxIncome:-.2,production:-.1}}},lumberjack:{name:"樵夫",icon:"Trees",weight:.8,tax:1.2,headTaxBase:.02,desc:"专职砍伐木材，维系城市建设。",wealthWeight:1,influenceBase:.4,startingWealth:90,defaultResource:"wood",wealthElasticity:.6,maxConsumptionMultiplier:3,needs:{food:.46,cloth:.07},luxuryNeeds:{1:{ale:.05},1.5:{stone:.015,culture:.02},2:{plank:.06,wood:.06},2.5:{tools:.03,furniture:.03},3:{spice:.045,brick:.035,culture:.045},4.5:{copper:.01,tools:.04,plank:.02},5.5:{delicacies:.04,fine_clothes:.02,culture:.05},7:{coffee:.05,spice:.03},8:{delicacies:.05,culture:.06,furniture:.02}},buffs:{satisfied:{desc:"林场顺畅",production:.06},dissatisfied:{desc:"供应迟滞",production:-.1}}},serf:{name:"佃农",icon:"Users",weight:.5,tax:2,headTaxBase:.015,desc:"依附于地主的农民，产出归地主所有。",wealthWeight:.5,influenceBase:.3,startingWealth:50,defaultResource:"food",wealthElasticity:.4,maxConsumptionMultiplier:3,needs:{food:.36,cloth:.05},luxuryNeeds:{1:{ale:.035},2:{culture:.015},2.5:{food:.08},3:{furniture:.015,plank:.03,tools:.01},4:{spice:.03,stone:.01,culture:.025},5:{ale:.03,cloth:.015},6:{delicacies:.02,brick:.02,culture:.03},7.5:{fine_clothes:.015,copper:.006},9:{coffee:.02,furniture:.01},10:{delicacies:.02,culture:.035}},buffs:{satisfied:{desc:"佃农勤恳",production:.08},dissatisfied:{desc:"佃农怠工",production:-.15}}},worker:{name:"工人",icon:"Hammer",weight:2,tax:3,headTaxBase:.03,desc:"工业时代的基石，推动生产力发展。",wealthWeight:2,influenceBase:1,startingWealth:80,defaultResource:"plank",wealthElasticity:.7,maxConsumptionMultiplier:3,needs:{food:.52,cloth:.09},luxuryNeeds:{1:{tools:.06,ale:.09},1.5:{plank:.03,culture:.03},2.5:{furniture:.045,spice:.03},3:{coffee:.04,brick:.04,culture:.04},4:{fine_clothes:.05,delicacies:.07,stone:.02},5:{steel:.02,copper:.015,culture:.08},6.5:{delicacies:.06,fine_clothes:.04,brick:.03,culture:.07},8:{papyrus:.035,furniture:.02},10:{coffee:.04,spice:.04,furniture:.04,culture:.07},12:{delicacies:.08,fine_clothes:.05,culture:.1}},buffs:{satisfied:{desc:"工人积极",industryBonus:.15},dissatisfied:{desc:"工人罢工",industryBonus:-.25}}},artisan:{name:"工匠",icon:"Anvil",weight:1.5,tax:3.5,headTaxBase:.035,desc:"技艺精湛的手工业者，负责加工铜器与印刷制品。",wealthWeight:2.5,influenceBase:1.2,startingWealth:200,defaultResource:"tools",wealthElasticity:.8,maxConsumptionMultiplier:6,needs:{food:.62,cloth:.11},luxuryNeeds:{1:{tools:.07,ale:.1,furniture:.05,culture:.04},1.8:{copper:.02,spice:.05},2.5:{coffee:.04,fine_clothes:.035,brick:.04,culture:.09},3.5:{delicacies:.09,stone:.035,dye:.025},4.5:{steel:.015,iron:.02,culture:.12},6:{tools:.06,copper:.03,furniture:.04,culture:.1},8:{papyrus:.05,furniture:.03},10:{coffee:.05,fine_clothes:.05,dye:.03,culture:.13},12:{delicacies:.1,culture:.18,spice:.04}},buffs:{satisfied:{desc:"坊市繁盛",production:.1},dissatisfied:{desc:"工坊停工",production:-.15}}},miner:{name:"矿工",icon:"Pickaxe",weight:1.2,tax:2.5,headTaxBase:.025,desc:"深入地下采集矿石，承担艰苦劳动。",wealthWeight:1.5,influenceBase:.8,startingWealth:120,defaultResource:"stone",wealthElasticity:.6,maxConsumptionMultiplier:4,needs:{food:.56,cloth:.1},luxuryNeeds:{1:{ale:.06},1.8:{wood:.04,tools:.015},2:{culture:.02},2.5:{furniture:.03,spice:.02,food:.2},3:{plank:.04,brick:.03,coffee:.025},4:{delicacies:.05,culture:.04},5.5:{copper:.015,steel:.01},7:{fine_clothes:.035,culture:.07},9:{ale:.06,delicacies:.05,culture:.06},11:{coffee:.04,fine_clothes:.035,culture:.08}},buffs:{satisfied:{desc:"矿脉稳定",gatherBonus:.1},dissatisfied:{desc:"矿难隐患",stability:-.1}}},merchant:{name:"商人",icon:"Coins",weight:6,tax:5,headTaxBase:.09,desc:"控制贸易网络的阶层，主宽港口与市场。",wealthWeight:8,influenceBase:3.5,startingWealth:500,defaultResource:"spice",wealthElasticity:1.5,maxConsumptionMultiplier:10,needs:{food:.7,cloth:.14},luxuryNeeds:{1:{delicacies:.6,spice:.2,furniture:.12,plank:.08,ale:.15,fine_clothes:.1,culture:.12,dye:.02},1.5:{coffee:.14},2:{delicacies:.35,plank:.12,brick:.05,culture:.2},3:{steel:.05,coal:.03},5:{papyrus:.08,copper:.06,stone:.05,culture:.3},8:{coffee:.1,spice:.18,fine_clothes:.1,culture:.2},12:{delicacies:.35,furniture:.1,culture:.35,dye:.03},18:{delicacies:.45,fine_clothes:.14,culture:.45,papyrus:.08}},buffs:{satisfied:{desc:"商贸兴隆",taxIncome:.15,gatherBonus:.05},dissatisfied:{desc:"贸易停滞",taxIncome:-.2,stability:-.1}},tradeConfig:{minProfitMargin:.1,maxPurchaseAmount:10,exportProbability:.5,maxInventoryRatio:.1,minWealthForTrade:10,tradeDuration:3,tradeCooldown:0,enableDebugLog:!0}},navigator:{name:"水手",icon:"Compass",weight:4,tax:3,headTaxBase:.06,desc:"探索时代的海员与测绘师，推动航海扩张。",wealthWeight:3,influenceBase:2.5,startingWealth:300,defaultResource:"spice",wealthElasticity:.7,maxConsumptionMultiplier:6,needs:{food:.6,cloth:.1},luxuryNeeds:{1:{spice:.12,ale:.12,culture:.05},1.8:{tools:.05},2.5:{coffee:.07,furniture:.07,culture:.09},3.5:{fine_clothes:.08,delicacies:.12,plank:.07},5:{copper:.05,steel:.03,culture:.15},7:{papyrus:.05},10:{brick:.08},14:{spice:.1,coffee:.06,fine_clothes:.06,culture:.2}},buffs:{satisfied:{desc:"海权扩张",gatherBonus:.1},dissatisfied:{desc:"航员哗变",gatherBonus:-.1,stability:-.1}}},scribe:{name:"学者",icon:"Feather",weight:2.5,tax:2,headTaxBase:.04,desc:"记录知识的学者，为图书馆与学院服务。",wealthWeight:2.5,influenceBase:1.5,startingWealth:250,defaultResource:"papyrus",wealthElasticity:1,maxConsumptionMultiplier:6,needs:{food:.62,cloth:.11},luxuryNeeds:{1:{papyrus:.1,furniture:.05,culture:.08},1.5:{coffee:.07},2:{fine_clothes:.05,plank:.025,culture:.15,science:.01},3:{delicacies:.09,spice:.05},5:{copper:.035,brick:.025,culture:.2,science:.03},7:{papyrus:.08,coffee:.05,culture:.12},10:{stone:.04},14:{cloth:.07},18:{steel:.015}},buffs:{satisfied:{desc:"文献井然",scienceBonus:.15},dissatisfied:{desc:"文献损失",scienceBonus:-.2}}},soldier:{name:"军人",icon:"Swords",weight:3,tax:1,headTaxBase:.04,desc:"维护国家安全，但也可能造成动荡。",wealthWeight:2,influenceBase:2,startingWealth:180,defaultResource:"tools",wealthElasticity:.6,maxConsumptionMultiplier:6,needs:{food:.6,cloth:.1},luxuryNeeds:{1:{ale:.08},1.5:{culture:.04},2:{tools:.07,copper:.025,iron:.02},2.5:{furniture:.05,spice:.05},3:{culture:.07},3.5:{fine_clothes:.07,delicacies:.07,steel:.025},5:{brick:.05,culture:.12},7:{coffee:.09,stone:.05},10:{steel:.03,tools:.04,culture:.1,delicacies:.06},14:{copper:.04,brick:.04,culture:.14}},buffs:{satisfied:{desc:"军心稳固",militaryPower:.2},dissatisfied:{desc:"军队哗变风险",militaryPower:-.3,stability:-.2}}},cleric:{name:"神职人员",icon:"Cross",weight:4,tax:.5,headTaxBase:.05,desc:"提供信仰和文化，安抚民心。",wealthWeight:3,influenceBase:3,startingWealth:220,defaultResource:"culture",wealthElasticity:.9,maxConsumptionMultiplier:6,needs:{food:.65,cloth:.11},luxuryNeeds:{1:{papyrus:.08,ale:.06,culture:.1},1.5:{plank:.02},2:{fine_clothes:.06,furniture:.06,stone:.04,culture:.18},3:{delicacies:.08,spice:.04},4.5:{copper:.04,brick:.04,culture:.25},6:{coffee:.05,steel:.01},8:{papyrus:.09},10:{culture:.15,fine_clothes:.05,delicacies:.06}},buffs:{satisfied:{desc:"宗教和谐",cultureBonus:.2,stability:.1},dissatisfied:{desc:"信仰危机",cultureBonus:-.15,stability:-.1}}},official:{name:"官员",icon:"ScrollText",weight:5,tax:2,headTaxBase:.08,desc:"政府管理者。",wealthWeight:5,influenceBase:4,startingWealth:400,defaultResource:"science",wealthElasticity:2.5,maxConsumptionMultiplier:50,greedy:!0,needs:{food:.85,cloth:.14},luxuryNeeds:{1:{delicacies:.5,papyrus:.12,coffee:.08,furniture:.1,stone:.04,fine_clothes:.1,culture:.15},1.3:{coffee:.06,culture:.08},1.8:{delicacies:.3,spice:.12,plank:.08,brick:.06},2:{culture:.25},2.5:{steel:.04,iron:.03,coal:.03},4:{papyrus:.08,copper:.04,stone:.04,culture:.35,science:.02},6:{fine_clothes:.15},9:{delicacies:.35,coffee:.1,culture:.4,science:.04},14:{delicacies:.45,fine_clothes:.12,papyrus:.08,culture:.55},20:{delicacies:.6,spice:.18,furniture:.1,culture:.7}},buffs:{satisfied:{desc:"吏治清明",taxIncome:.1},dissatisfied:{desc:"官员腐败",taxIncome:-.2}}},landowner:{name:"地主",icon:"Castle",weight:10,tax:5,headTaxBase:.07,desc:"传统精英，掌控土地和农业。",wealthWeight:10,influenceBase:5,startingWealth:800,defaultResource:"food",wealthElasticity:1.4,maxConsumptionMultiplier:10,needs:{food:.95,cloth:.15},luxuryNeeds:{1:{delicacies:.8,spice:.2,furniture:.18,brick:.1,plank:.1,fine_clothes:.15,culture:.2},1.3:{delicacies:.4,fine_clothes:.12},1.5:{culture:.28},1.8:{spice:.2,coffee:.1,stone:.08},2.5:{plank:.12,steel:.04,brick:.08,culture:.35},4:{copper:.06,papyrus:.04},6:{delicacies:.5,fine_clothes:.12,culture:.35},9:{delicacies:.65,coffee:.14,furniture:.12,culture:.45},14:{delicacies:.85,spice:.22,fine_clothes:.18,culture:.6},20:{delicacies:1.1,fine_clothes:.22,furniture:.16,culture:.8}},buffs:{satisfied:{desc:"贵族支持",taxIncome:.15,stability:.15},dissatisfied:{desc:"贵族叛乱",taxIncome:-.3,stability:-.25}}},capitalist:{name:"资本家",icon:"Briefcase",weight:15,tax:8,headTaxBase:.08,desc:"工业精英，提供投资和工业加成。",wealthWeight:20,influenceBase:6,startingWealth:1200,defaultResource:"steel",wealthElasticity:1.8,maxConsumptionMultiplier:10,needs:{food:1,cloth:.16},luxuryNeeds:{1:{delicacies:.7,coffee:.15,furniture:.15,steel:.05,culture:.25},1.3:{fine_clothes:.12},1.5:{culture:.3},1.8:{delicacies:.3,spice:.15,brick:.08},2.5:{stone:.06,plank:.1,coal:.04,iron:.03,culture:.45},4:{copper:.08,papyrus:.06,science:.03},6:{steel:.1,coal:.06,tools:.06,culture:.4},10:{delicacies:.55,coffee:.18,fine_clothes:.16,culture:.6,science:.06},15:{steel:.14,coal:.1,copper:.1,culture:.75},22:{delicacies:.85,spice:.25,furniture:.18,culture:1}},buffs:{satisfied:{desc:"资本繁荣",industryBonus:.25,scienceBonus:.15},dissatisfied:{desc:"资本外逃",industryBonus:-.3,taxIncome:-.25}}},knight:{name:"骑士",icon:"Shield",weight:8,tax:2,headTaxBase:.09,desc:"军事贵族，强大的战斗力。",wealthWeight:8,influenceBase:4,startingWealth:600,defaultResource:"tools",wealthElasticity:1,maxConsumptionMultiplier:10,needs:{food:.9,cloth:.14},luxuryNeeds:{1:{delicacies:.9,coffee:.1,furniture:.15,ale:.15,culture:.15},1.3:{delicacies:.4,fine_clothes:.1},1.5:{culture:.2},1.8:{spice:.12,steel:.04},2.5:{coffee:.08,brick:.06,stone:.04,culture:.3},4:{tools:.06,copper:.04,plank:.06},6:{steel:.06,tools:.04,culture:.25,delicacies:.25},10:{delicacies:.55,fine_clothes:.14,culture:.45},15:{steel:.1,copper:.06,culture:.6},22:{delicacies:.85,spice:.22,fine_clothes:.18,culture:.8}},buffs:{satisfied:{desc:"骑士忠诚",militaryPower:.25,stability:.1},dissatisfied:{desc:"骑士不满",militaryPower:-.2,stability:-.15}}},engineer:{name:"工程师",icon:"Cog",weight:7,tax:6,headTaxBase:.1,desc:"掌控蒸汽与机器的技术阶层。",wealthWeight:6,influenceBase:3.5,startingWealth:700,defaultResource:"steel",wealthElasticity:1.1,maxConsumptionMultiplier:10,needs:{food:.75,cloth:.12},luxuryNeeds:{1:{coffee:.12,ale:.08,furniture:.1,culture:.12},1.3:{fine_clothes:.08},1.8:{delicacies:.15,spice:.08,tools:.06},2:{culture:.2,science:.02},2.5:{plank:.08,copper:.04,stone:.04},4:{papyrus:.06,brick:.06,steel:.04,coal:.05,iron:.03,culture:.25},6:{steel:.08,tools:.08,coal:.08,culture:.25,science:.05},10:{coffee:.12,fine_clothes:.1,culture:.45,delicacies:.25},15:{steel:.12,copper:.08,coal:.12,culture:.6},22:{delicacies:.6,spice:.2,furniture:.14,culture:.75}},buffs:{satisfied:{desc:"工艺革新",industryBonus:.2,scienceBonus:.1},dissatisfied:{desc:"技术流失",industryBonus:-.25}}},unemployed:{name:"失业者",icon:"AlertTriangle",weight:.2,tax:1,headTaxBase:.01,desc:"暂时没有工作的平民，如果得不到安排会渐渐不满。",wealthWeight:.2,influenceBase:.3,startingWealth:30,wealthElasticity:.3,maxConsumptionMultiplier:3,needs:{food:.3,cloth:.04},luxuryNeeds:{2.5:{ale:.04,food:.1},3.5:{furniture:.01},4.5:{plank:.01,culture:.002},5.5:{tools:.004},7:{spice:.008},9:{brick:.006}},buffs:{satisfied:{desc:"等待机会",stability:.02},dissatisfied:{desc:"失业动荡",stability:-.1}}}},Vt=[{id:"farm",name:"农田",desc:"提供自耕农岗位。",baseCost:{wood:12},output:{food:4.8},jobs:{peasant:3},owner:"peasant",epoch:0,cat:"gather",visual:{icon:"Wheat",color:"bg-yellow-700",text:"text-yellow-200"},marketConfig:{price:{livingCostWeight:.08,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.05}}},{id:"trading_post",name:"贸易站",desc:"原始的物资交换场所，提供商人岗位。",baseCost:{wood:50,stone:10},output:{food:4,silver:1.6},jobs:{merchant:2},owner:"merchant",epoch:0,cat:"civic",requiresTech:"barter",visual:{icon:"Handshake",color:"bg-amber-800",text:"text-amber-200"}},{id:"large_estate",name:"庄园",desc:"地主控制的土地，雇佣佃农。",baseCost:{wood:100,plank:25},output:{food:24},jobs:{serf:8,landowner:1},owner:"landowner",epoch:3,cat:"gather",requiresTech:"feudalism",visual:{icon:"Castle",color:"bg-amber-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05,wageMode:"subsistence",subsistenceMultiplier:1.5}}},{id:"lumber_camp",name:"伐木场",desc:"砍伐木材，基础采集建筑。",baseCost:{food:18},input:{},output:{wood:3.84},jobs:{lumberjack:3},owner:"lumberjack",epoch:0,cat:"gather",visual:{icon:"Trees",color:"bg-emerald-800",text:"text-emerald-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"quarry",name:"采石场",desc:"开采石料，基础采集建筑。",baseCost:{wood:55},input:{},output:{stone:3},jobs:{miner:3},owner:"miner",epoch:0,cat:"gather",visual:{icon:"Pickaxe",color:"bg-stone-600",text:"text-stone-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"copper_mine",name:"铜矿井",desc:"开采铜矿石，需要少量工具维护。",baseCost:{food:120,wood:120},input:{tools:.0267},output:{copper:.6667},jobs:{miner:4},owner:"miner",epoch:1,cat:"gather",requiresTech:"copper_mining",visual:{icon:"Gem",color:"bg-orange-700",text:"text-orange-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"reed_works",name:"造纸工坊",desc:"生产纸张的手工作坊。",baseCost:{food:140,wood:80},input:{wood:.75},output:{papyrus:.9},jobs:{worker:3},owner:"worker",epoch:2,cat:"industry",requiresTech:"papyrus_cultivation",visual:{icon:"ScrollText",color:"bg-lime-800",text:"text-lime-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"culinary_kitchen",name:"烹饪坊",desc:"将粮食烹饪为珍馐，供上层阶级享用。",baseCost:{wood:100,stone:60,brick:30},input:{tools:.1333,food:2},output:{delicacies:2},jobs:{artisan:3,peasant:1},owner:"artisan",epoch:2,cat:"industry",requiresTech:"culinary_arts",visual:{icon:"UtensilsCrossed",color:"bg-rose-800",text:"text-rose-200"}},{id:"brewery",name:"酿造坊",desc:"将粮食发酵酿造成美酒，供贸易与享用。",baseCost:{wood:90,stone:50,brick:25},input:{food:1.8,wood:.3},output:{ale:1.8},jobs:{worker:3},owner:"worker",epoch:2,cat:"industry",requiresTech:"brewing",visual:{icon:"Wine",color:"bg-purple-800",text:"text-purple-200"},marketConfig:{price:{livingCostWeight:.4,taxCostWeight:.5},wage:{livingCostWeight:.25,taxCostWeight:.25}}},{id:"furniture_workshop",name:"家具工坊",desc:"将木板与布料雕刻成精美家具，提升上层阶级的生活品质。",baseCost:{plank:120,stone:80},input:{tools:.1333,plank:1.3333,cloth:.4},output:{furniture:1.6},jobs:{artisan:4},owner:"artisan",epoch:2,cat:"industry",requiresTech:"carpentry",visual:{icon:"Armchair",color:"bg-amber-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.4},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"loom_house",name:"织布坊",desc:"家庭式纺纱织布，保障民众衣物供应。",baseCost:{wood:35,food:20},output:{cloth:2.88},jobs:{worker:3},owner:"worker",epoch:0,cat:"industry",visual:{icon:"Shirt",color:"bg-indigo-800",text:"text-indigo-200"},marketConfig:{price:{livingCostWeight:.12,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"dye_works",name:"染坊",desc:"从植物中提取染料，用于制作高级织物。",baseCost:{wood:60,stone:20},input:{food:.75},output:{dye:.9},jobs:{worker:3},owner:"worker",epoch:1,cat:"industry",visual:{icon:"Paintbrush",color:"bg-pink-800",text:"text-pink-200"}},{id:"tailor_workshop",name:"成衣作坊",desc:"使用布料和染料制作精美的华服，供上层阶级享用。",baseCost:{wood:100,stone:40},input:{tools:.06,cloth:1.5,dye:.3},output:{fine_clothes:1.2,culture:.5},jobs:{artisan:3},owner:"artisan",epoch:1,cat:"industry",requiresTech:"tools",visual:{icon:"Package",color:"bg-indigo-900",text:"text-indigo-100"}},{id:"mine",name:"铁矿井",desc:"深入岩层采集铁矿，需要工具维护。",baseCost:{plank:120,food:220},input:{tools:.072},output:{iron:.9},jobs:{miner:9,landowner:1},owner:"landowner",epoch:2,cat:"gather",requiresTech:"ironworking",visual:{icon:"Mountain",color:"bg-zinc-700",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"coffee_plantation",name:"咖啡种植园",desc:"开垦远方殖民地的咖啡种植地。",baseCost:{wood:200,spice:30},output:{coffee:.6},jobs:{serf:6,merchant:1},owner:"merchant",epoch:5,cat:"gather",requiresTech:"coffee_agronomy",visual:{icon:"Coffee",color:"bg-amber-900",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.05,taxCostWeight:.05,wageMode:"subsistence",subsistenceMultiplier:1.3}}},{id:"coal_mine",name:"煤矿",desc:"开采地下煤炭，工业能源基石。",baseCost:{plank:200,tools:60},input:{tools:.2},output:{coal:3},jobs:{miner:12,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"coal_gasification",visual:{icon:"Flame",color:"bg-slate-700",text:"text-slate-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"hut",name:"简陋小屋",desc:"增加人口上限。",baseCost:{wood:20,food:20},output:{maxPop:3},epoch:0,cat:"civic",visual:{icon:"Tent",color:"bg-orange-800",text:"text-orange-200"}},{id:"house",name:"木屋",desc:"以木板与砖块搭建的整洁居所。",baseCost:{plank:60,brick:40},output:{maxPop:8},epoch:2,cat:"civic",requiresTech:"urban_planning",visual:{icon:"Home",color:"bg-amber-700",text:"text-amber-100"}},{id:"manor_house",name:"石砌宅邸",desc:"贵族风格的石砌住宅，坚固耐久，彰显领主权威。",baseCost:{brick:120,plank:80,iron:15},output:{maxPop:9},epoch:3,cat:"civic",requiresTech:"manor_architecture",visual:{icon:"Castle",color:"bg-blue-800",text:"text-blue-200"}},{id:"townhouse",name:"联排住宅",desc:"港口城市流行的多层联排建筑，高效利用城市空间。",baseCost:{brick:180,plank:120,tools:25},output:{maxPop:10},epoch:4,cat:"civic",requiresTech:"colonial_architecture",visual:{icon:"Building",color:"bg-cyan-800",text:"text-cyan-200"}},{id:"civic_apartment",name:"阁楼公馆",desc:"启蒙时代流行的多层砖石建筑，优雅的阁楼设计为新兴中产阶级提供舒适居所。",baseCost:{brick:250,plank:150,iron:40,furniture:20},output:{maxPop:11},epoch:5,cat:"civic",requiresTech:"enlightened_urbanism",visual:{icon:"Building2",color:"bg-purple-800",text:"text-purple-200"}},{id:"granary",name:"粮仓",desc:"加固的干燥粮仓，提升人口承载。",baseCost:{wood:120,brick:40,stone:30},output:{maxPop:6},epoch:1,cat:"civic",requiresTech:"granary_architecture",visual:{icon:"Boxes",color:"bg-yellow-900",text:"text-yellow-200"}},{id:"town_hall",name:"市政厅",desc:"官员办公地，提供官员岗位，需要少量维护。",baseCost:{brick:200,plank:200,cloth:20},input:{brick:.2,papyrus:.02,delicacies:.1,fine_clothes:.05,culture:.03,science:.05},output:{},jobs:{official:7},epoch:3,cat:"civic",requiresTech:"bureaucracy",visual:{icon:"Scale",color:"bg-slate-800",text:"text-slate-200"}},{id:"church",name:"教堂",desc:"安抚民心，产出文化。",baseCost:{stone:150,plank:50,brick:60},input:{furniture:.1333,fine_clothes:.1333,brick:.0533},output:{culture:3.2,silver:.6667},jobs:{cleric:4},owner:"cleric",epoch:3,cat:"civic",requiresTech:"theology",visual:{icon:"Cross",color:"bg-purple-900",text:"text-purple-200"}},{id:"monastery_cellar",name:"修道院酒窖",desc:"修道士传承的酿酒技艺，出产上等美酒，彰显宗教文化。",baseCost:{stone:120,brick:60,tools:15},input:{food:2.7,wood:.45},output:{ale:3,culture:1.2},jobs:{cleric:1,worker:3},owner:"cleric",epoch:3,cat:"industry",requiresTech:"monastic_brewing",visual:{icon:"Wine",color:"bg-purple-800",text:"text-purple-200"}},{id:"wool_workshop",name:"纺织工场",desc:"规模化的羊毛加工作坊，封建领地的重要经济支柱。",baseCost:{plank:100,brick:50,tools:15},input:{food:.9,tools:.045},output:{cloth:4.8,fine_clothes:.3},jobs:{serf:4,worker:3},owner:"worker",epoch:3,cat:"industry",requiresTech:"wool_trade",visual:{icon:"Shirt",color:"bg-indigo-700",text:"text-indigo-200"},marketConfig:{price:{livingCostWeight:.12,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.08,wageMode:"subsistence",subsistenceMultiplier:1.8}}},{id:"stone_workshop",name:"采石工场",desc:"使用铁器工具的专业采石场，为城堡和教堂建设提供大量优质石料。",baseCost:{plank:80,iron:30,tools:20},input:{tools:.075},output:{stone:4.375},jobs:{miner:4,worker:1},owner:"miner",epoch:3,cat:"gather",requiresTech:"masonry_guild",visual:{icon:"Pickaxe",color:"bg-stone-700",text:"text-stone-200"}},{id:"hardwood_camp",name:"硬木林场",desc:"有计划的森林采伐，提供大量木材与优质硬木。",baseCost:{plank:100,iron:25,tools:25},input:{tools:.096},output:{wood:5.76},jobs:{lumberjack:5,worker:1},owner:"lumberjack",epoch:3,cat:"gather",requiresTech:"forestry_management",visual:{icon:"Trees",color:"bg-emerald-900",text:"text-emerald-200"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"amphitheater",name:"剧场",desc:"古典时代的文化舞台，激发灵感。",baseCost:{stone:200,brick:80,dye:10},input:{fine_clothes:.225,brick:.045},output:{culture:5.4},jobs:{cleric:3},owner:"cleric",epoch:1,cat:"civic",requiresTech:"amphitheater_design",visual:{icon:"Music2",color:"bg-rose-900",text:"text-rose-200"}},{id:"navigator_school",name:"航海学院",desc:"培养探索时代的开路者，产出科研文化。",baseCost:{wood:160,papyrus:80,brick:70},output:{science:.75,culture:1},jobs:{navigator:3,scribe:1,official:1},owner:"official",epoch:4,cat:"civic",requiresTech:"navigator_schooling",visual:{icon:"Navigation",color:"bg-cyan-900",text:"text-cyan-200"}},{id:"shaft_mine",name:"竖井矿场",desc:"利用绞盘与更好的通风设施深入地下，同时开采铜铁矿脉。",baseCost:{brick:150,plank:100,tools:50},input:{tools:.144,wood:.3,science:.05},output:{iron:1.44,copper:.96},jobs:{miner:6,engineer:1},owner:"miner",epoch:4,cat:"gather",requiresTech:"advanced_metallurgy",visual:{icon:"Mountain",color:"bg-zinc-600",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"dye_workshop",name:"印染工坊",desc:"使用新世界染料的专业印染作坊，如珍贵的胭脂虫红。",baseCost:{brick:100,plank:80,tools:20},input:{food:1.2,cloth:.6,spice:.075,science:.02},output:{dye:1.8,fine_clothes:.45},jobs:{artisan:3,worker:2},owner:"artisan",epoch:4,cat:"industry",requiresTech:"new_world_dyes",visual:{icon:"Paintbrush",color:"bg-rose-800",text:"text-rose-200"}},{id:"coffee_house",name:"咖啡馆",desc:"啜饮咖啡、交流思想的启蒙沙龙。",baseCost:{plank:140,coffee:40,cloth:20,delicacies:15,science:100},input:{coffee:.5333,delicacies:.2667},output:{culture:4,science:1.3333},jobs:{merchant:1,scribe:3},owner:"merchant",epoch:5,cat:"civic",requiresTech:"coffeehouse_philosophy",visual:{icon:"Coffee",color:"bg-brown-900",text:"text-amber-200"}},{id:"rail_depot",name:"铁路枢纽",desc:"蒸汽时代的交通心脏，连接全国贸易，提供岗位和人口上限。",baseCost:{steel:180,coal:120,science:300},input:{coal:.72,ale:.36,delicacies:.18,science:.15},output:{silver:2.7,maxPop:14},jobs:{engineer:4,merchant:3,capitalist:1},owner:"capitalist",epoch:6,cat:"civic",requiresTech:"rail_network",visual:{icon:"Train",color:"bg-gray-900",text:"text-gray-100"}},{id:"sawmill",name:"锯木厂",desc:"在铜制工具辅助下高效加工木板。",baseCost:{wood:75,stone:35},input:{wood:1.6},output:{plank:3.47},jobs:{worker:4},owner:"worker",epoch:1,requiresTech:"tools",cat:"industry",visual:{icon:"Hammer",color:"bg-amber-900",text:"text-amber-300"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"brickworks",name:"砖窯",desc:"烧制砖块，供城墙与民宅所用。",baseCost:{wood:140,stone:90},input:{stone:1.5,wood:.45},output:{brick:3.6},jobs:{worker:3},owner:"worker",epoch:0,cat:"industry",requiresTech:"pottery",visual:{icon:"Factory",color:"bg-red-900",text:"text-red-300"}},{id:"stone_tool_workshop",name:"石器作坊",desc:"用燧石和木料打制粗糙的工具。",baseCost:{wood:40,stone:25},input:{wood:1.5,stone:1.2},output:{tools:.75},jobs:{artisan:3},owner:"artisan",epoch:0,cat:"industry",requiresTech:"tool_making",visual:{icon:"Hammer",color:"bg-stone-700",text:"text-stone-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"bronze_foundry",name:"青铜铸坊",desc:"熔炼铜与木炭，制造精良工具。",baseCost:{wood:140,stone:75,copper:35},input:{copper:.8,wood:.5333},output:{tools:1.3333},jobs:{worker:3,artisan:1},owner:"artisan",epoch:1,cat:"industry",requiresTech:"bronze_working",visual:{icon:"Anvil",color:"bg-orange-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"iron_tool_workshop",name:"铁器铺",desc:"以铁为原料，锻造坚固耐用的工具。",baseCost:{plank:150,brick:80},input:{wood:.6667,iron:1.0667},output:{tools:2},jobs:{worker:3,artisan:1},owner:"artisan",epoch:2,cat:"industry",requiresTech:"ironworking",visual:{icon:"Cog",color:"bg-zinc-800",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"factory",name:"工厂",desc:"蒸汽驱动的流水线生产工具与机械。",baseCost:{brick:400,steel:200,science:350},input:{steel:2,coal:2,science:.5},output:{tools:15},jobs:{worker:20,engineer:4,capitalist:1},owner:"capitalist",epoch:6,requiresTech:"industrialization",cat:"industry",visual:{icon:"Factory",color:"bg-blue-900",text:"text-blue-200"}},{id:"printing_house",name:"印刷所",desc:"启蒙时代的出版重镇，大量复制知识。",baseCost:{brick:200,papyrus:80,wood:60,science:150},input:{papyrus:.8,coffee:.2,brick:.08,science:.3},output:{science:2.4,culture:2},jobs:{artisan:5,scribe:3,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"printing_press",visual:{icon:"BookOpen",color:"bg-indigo-900",text:"text-indigo-200"}},{id:"steel_foundry",name:"炼钢厂",desc:"以煤炭为燃料的炼钢炉，供应工业时代钢材。",baseCost:{brick:300,iron:200,science:280},input:{iron:.7,coal:.7,science:.2},output:{steel:.7},jobs:{engineer:5,worker:7,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"steel_alloys",visual:{icon:"Cog",color:"bg-gray-900",text:"text-gray-200"}},{id:"library",name:"图书馆",desc:"编目典籍，持续产出科研。",baseCost:{wood:200,stone:100},output:{science:1.0667},jobs:{scribe:4},owner:"scribe",epoch:0,cat:"civic",visual:{icon:"Landmark",color:"bg-cyan-800",text:"text-cyan-200"}},{id:"market",name:"市场",desc:"自动平衡市场供需：将盈余的滞销资源出口，换取急需的短缺资源。产出少量商业税收。",baseCost:{plank:100},input:{brick:.075},output:{food:3},jobs:{merchant:3},owner:"merchant",epoch:1,requiresTech:"caravan_trade",cat:"civic",visual:{icon:"Handshake",color:"bg-yellow-800",text:"text-yellow-200"}},{id:"magistrate_office",name:"官署",desc:"早期行政机构，管理青铜时代的税收与民政。提供少量官员岗位。",baseCost:{plank:80,stone:60,brick:40},input:{papyrus:.015,brick:.03},output:{},jobs:{official:3,scribe:1},epoch:1,cat:"civic",requiresTech:"early_administration",visual:{icon:"Scroll",color:"bg-slate-700",text:"text-slate-200"}},{id:"dockyard",name:"船坞",desc:"建造远洋船队，换取异域香料。",baseCost:{plank:200,tools:40},input:{wood:.6},output:{spice:.84},jobs:{navigator:3,worker:2,merchant:1},owner:"merchant",epoch:4,cat:"industry",requiresTech:"cartography",visual:{icon:"Anchor",color:"bg-sky-900",text:"text-sky-200"}},{id:"trade_port",name:"贸易港",desc:"汇聚香料、银币与海外特许的繁忙港口。",baseCost:{plank:220,spice:60},input:{spice:.4},output:{food:2.6667},jobs:{merchant:4},owner:"merchant",epoch:4,cat:"civic",requiresTech:"charter_companies",visual:{icon:"Ship",color:"bg-indigo-900",text:"text-indigo-200"}},{id:"barracks",name:"兵营",desc:"训练和驻扎军队的基地，提供军事容量。",baseCost:{wood:80,stone:40},output:{militaryCapacity:10},epoch:0,cat:"military",visual:{icon:"Shield",color:"bg-red-900",text:"text-red-200"}},{id:"training_ground",name:"训练场",desc:"专业的军事训练设施，大幅提升军事容量。",baseCost:{plank:150,brick:80,iron:30},output:{militaryCapacity:20},epoch:2,cat:"military",requiresTech:"military_training",visual:{icon:"Swords",color:"bg-red-800",text:"text-red-100"}},{id:"fortress",name:"要塞",desc:"坚固的军事堡垒，可容纳大量军队。",baseCost:{brick:300,iron:150,steel:50},output:{militaryCapacity:40},epoch:4,cat:"military",requiresTech:"fortification",visual:{icon:"Castle",color:"bg-red-950",text:"text-red-100"}},{id:"textile_mill",name:"纺织厂",desc:"水力驱动的纺织机，大幅提升布料和成衣产量。",baseCost:{brick:180,plank:120,tools:60,science:150},input:{food:2,dye:.75},output:{cloth:12.5,fine_clothes:1.5},jobs:{worker:15,artisan:4,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"mechanized_weaving",visual:{icon:"Shirt",color:"bg-indigo-700",text:"text-indigo-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"garment_factory",name:"服装工厂",desc:"蒸汽动力缝纫机的大规模成衣生产线。",baseCost:{brick:350,steel:150,tools:100,science:300},input:{cloth:3.75,dye:.75,coal:.45},output:{fine_clothes:4.2,culture:.45},jobs:{worker:18,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"assembly_line",visual:{icon:"Factory",color:"bg-indigo-900",text:"text-indigo-100"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"lumber_mill",name:"木材加工厂",desc:"水力锯木机与烘干设备，高效生产优质木板。",baseCost:{brick:160,plank:100,tools:50},input:{wood:6.4286},output:{plank:17.1429},jobs:{worker:10,artisan:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"hydraulic_sawing",visual:{icon:"Axe",color:"bg-amber-700",text:"text-amber-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.12,taxCostWeight:.12}}},{id:"furniture_factory",name:"家具工厂",desc:"流水线生产标准化家具，满足城市中产阶级需求。",baseCost:{brick:280,steel:120,tools:80,science:280},input:{plank:5.625,cloth:1.8,coal:.5625},output:{furniture:7.875,culture:.45},jobs:{worker:17,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"mass_production",visual:{icon:"Armchair",color:"bg-amber-900",text:"text-amber-100"},marketConfig:{price:{livingCostWeight:.28,taxCostWeight:.32},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"metallurgy_workshop",name:"冶金工坊",desc:"改良的熔炉与锻造技术，高效生产精良工具。",baseCost:{brick:200,iron:100,tools:60},input:{iron:1.7143,copper:.3429,wood:.9143},output:{tools:3.4286},jobs:{worker:5,artisan:2,engineer:1},owner:"artisan",epoch:4,cat:"industry",requiresTech:"advanced_metallurgy",visual:{icon:"Anvil",color:"bg-zinc-700",text:"text-zinc-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"steel_works",name:"钢铁联合体",desc:"垂直整合的大型钢铁企业，从矿石到成品一条龙生产。",baseCost:{brick:500,steel:250,tools:150,science:400},input:{iron:1.44,coal:1.2,science:.4},output:{steel:1.44,tools:.96},jobs:{worker:18,engineer:5,capitalist:2},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"bessemer_process",visual:{icon:"Factory",color:"bg-gray-800",text:"text-gray-100"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"building_materials_plant",name:"建材厂",desc:"规模化生产砖块和预制建材，加速城市建设。",baseCost:{brick:200,plank:100,tools:50},input:{stone:4.5,wood:1.35,coal:.45},output:{brick:12.375},jobs:{worker:14,engineer:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"industrial_ceramics",visual:{icon:"Building2",color:"bg-red-800",text:"text-red-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.12,taxCostWeight:.12}}},{id:"prefab_factory",name:"预制构件厂",desc:"生产标准化建筑构件，革命性地改变建筑行业。",baseCost:{brick:400,steel:200,tools:100,science:350},input:{brick:3,steel:.4,stone:2,coal:.8},output:{brick:22},jobs:{worker:20,engineer:4,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"standardized_construction",visual:{icon:"Building",color:"bg-slate-700",text:"text-slate-100"},marketConfig:{price:{livingCostWeight:.28,taxCostWeight:.32},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"cannery",name:"罐头厂",desc:"革命性的食品保存技术，将珍馐装罐长期保存。",baseCost:{brick:250,steel:100,tools:60,science:280},input:{food:5.625,iron:.675,coal:.5625},output:{delicacies:7.875},jobs:{worker:17,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"food_preservation",visual:{icon:"Package",color:"bg-orange-800",text:"text-orange-100"},marketConfig:{price:{livingCostWeight:.22,taxCostWeight:.28},wage:{livingCostWeight:.14,taxCostWeight:.14}}},{id:"distillery",name:"蒸馏酒厂",desc:"工业化的酿酒设施，生产高度烈酒供出口贸易。",baseCost:{brick:220,copper:80,tools:50,science:140},input:{food:4.5,coal:.45},output:{ale:7.875,silver:1.8},jobs:{worker:12,artisan:2,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"distillation",visual:{icon:"Wine",color:"bg-purple-700",text:"text-purple-100"},marketConfig:{price:{livingCostWeight:.35,taxCostWeight:.4},wage:{livingCostWeight:.22,taxCostWeight:.22}}},{id:"paper_mill",name:"造纸厂",desc:"工业化造纸设备，用木浆大规模生产纸张。",baseCost:{brick:180,plank:100,tools:50,science:130},input:{wood:3,coal:.3},output:{papyrus:5},jobs:{worker:10,engineer:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"wood_pulp_process",visual:{icon:"ScrollText",color:"bg-lime-700",text:"text-lime-100"},marketConfig:{price:{livingCostWeight:.18,taxCostWeight:.22},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"publishing_house",name:"出版社",desc:"现代印刷与发行一体化，传播知识启迪民智。",baseCost:{brick:300,steel:80,papyrus:100,science:320},input:{papyrus:2,coffee:.4,coal:.3},output:{science:5,culture:2},jobs:{scribe:8,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"mass_media",visual:{icon:"Newspaper",color:"bg-cyan-800",text:"text-cyan-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"industrial_mine",name:"工业矿场",desc:"蒸汽动力的深井采矿设备，大幅提升矿石产量。",baseCost:{brick:350,steel:200,tools:100},input:{tools:.2615,coal:.5231},output:{iron:2.9616,copper:.9577},jobs:{miner:17,engineer:2,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"deep_shaft_mining",visual:{icon:"Mountain",color:"bg-zinc-800",text:"text-zinc-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"mechanized_farm",name:"机械化农场",desc:"蒸汽拖拉机与收割机，农业产量飞跃式提升。",baseCost:{brick:200,steel:150,tools:80},input:{tools:.175,coal:.35},output:{food:38.5},jobs:{peasant:8,worker:8,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"agricultural_machinery",visual:{icon:"Tractor",color:"bg-green-800",text:"text-green-100"},marketConfig:{price:{livingCostWeight:.18,taxCostWeight:.22},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"logging_company",name:"伐木公司",desc:"配备蒸汽锯和运输铁路的大型伐木企业。",baseCost:{brick:180,steel:100,tools:60},input:{tools:.1333,coal:.25},output:{wood:20},jobs:{lumberjack:11,worker:7,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"steam_logging",visual:{icon:"TreeDeciduous",color:"bg-emerald-700",text:"text-emerald-100"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"apartment_block",name:"公寓楼",desc:"多层住宅建筑，容纳大量城市人口。",baseCost:{brick:400,steel:100,plank:150},output:{maxPop:11},epoch:6,cat:"civic",requiresTech:"urban_architecture",visual:{icon:"Building2",color:"bg-slate-600",text:"text-slate-100"}},{id:"university",name:"大学",desc:"高等学府，培养工程师和学者，产出大量科研。",baseCost:{brick:400,plank:200,papyrus:100,science:200},input:{papyrus:.36,coffee:.24,delicacies:.18,brick:.072,science:.5},output:{science:3.6,culture:.96},jobs:{scribe:5,engineer:2,official:2},owner:"official",epoch:5,cat:"civic",requiresTech:"higher_education",visual:{icon:"GraduationCap",color:"bg-blue-900",text:"text-blue-100"}},{id:"opera_house",name:"歌剧院",desc:"华丽的艺术殿堂，展示文明的文化成就。",baseCost:{brick:350,plank:150,furniture:80,culture:40,dye:20,science:160},input:{fine_clothes:.2857,delicacies:.2286,brick:.0571},output:{culture:4,silver:1.1429},jobs:{cleric:5,artisan:2,merchant:1},owner:"cleric",epoch:5,cat:"civic",requiresTech:"grand_arts",visual:{icon:"Music",color:"bg-rose-800",text:"text-rose-100"}},{id:"stock_exchange",name:"证券交易所",desc:"金融资本的神经中枢，调配全国资金流向。",baseCost:{brick:500,steel:150,papyrus:100,science:400},input:{papyrus:.32,coffee:.24},output:{silver:8,culture:.8},jobs:{merchant:10,scribe:3,capitalist:2},owner:"capitalist",epoch:6,cat:"civic",requiresTech:"financial_capitalism",visual:{icon:"TrendingUp",color:"bg-emerald-900",text:"text-emerald-100"}}],tr=[{id:"barter",name:"物物交换",desc:"允许建造贸易站，让商人阶层登上历史舞台。财政收入 +2%。",cost:{science:150},epoch:0,effects:{incomePercent:.02}},{id:"stone_axes",name:"磨制石斧",desc:"伐木场产出提升 25%。",cost:{science:150},epoch:0,effects:{buildings:{lumber_camp:.12}}},{id:"flint_knapping",name:"打制燧石",desc:"采石场效率增加 25%。",cost:{science:210},epoch:0,effects:{buildings:{quarry:.12}}},{id:"animal_husbandry",name:"畜牧业",desc:"驯养牲畜，每人每日额外获得 0.1 粮食。",cost:{science:240},epoch:0,effects:{perPopPassive:{food:.1}}},{id:"pottery",name:"陶器",desc:"农田储粮效率 +10%。",cost:{science:300},epoch:0,effects:{buildings:{farm:.05}}},{id:"tool_making",name:"工具制作",desc:"解锁石器作坊，提供早期稳定的工具来源。采集建筑效率 +10%。",cost:{science:270},epoch:0,effects:{categories:{gather:.05}}},{id:"basic_irrigation",name:"基础灌溉",desc:"开凿浅渠把河水引入农田，产量提升 15%。",cost:{science:360},epoch:0,effects:{buildings:{farm:.08}}},{id:"oral_tradition",name:"口述传统",desc:"长者口述史诗，图书馆的整理效率提升 15%。",cost:{science:330},epoch:0,effects:{buildings:{library:.08}}},{id:"communal_granary",name:"公共粮仓",desc:"人口上限 +10%。",cost:{science:390},epoch:0,effects:{maxPop:.1}},{id:"river_fishing",name:"河湾捕鱼",desc:"每人每日额外获得 0.05 粮食，财政收入 +1%。",cost:{science:450},epoch:0,effects:{perPopPassive:{food:.05},incomePercent:.01}},{id:"wheel",name:"车轮",desc:"采集建筑整体效率 +20%。",cost:{science:480},epoch:0,effects:{categories:{gather:.1}}},{id:"sailing",name:"航海术",desc:"解锁船坞建设，开启海上贸易与军事行动。财政收入 +3%，每人每日获得 0.02 粮食。",cost:{science:1050},epoch:1,effects:{incomePercent:.03,perPopPassive:{food:.02}}},{id:"tools",name:"铜制工具",desc:"允许建造锯木厂，工业效率 +5%。",cost:{science:750},epoch:1,effects:{categories:{industry:.03}}},{id:"copper_mining",name:"铜脉勘探",desc:"解锁铜矿开采。",cost:{science:840},epoch:1,effects:{}},{id:"bronze_working",name:"青铜冶炼",desc:"青铜铸坊产出 +30%，铁矿井同步获得 +15%。",cost:{science:960},epoch:1,effects:{buildings:{bronze_foundry:.15,mine:.08}}},{id:"horse_collar",name:"牛项圈",desc:"农田与庄园增产 10%。",cost:{science:780},epoch:1,effects:{buildings:{farm:.05,large_estate:.05}}},{id:"caravan_trade",name:"驼队贸易",desc:"市场银币收入 +35%。",cost:{science:900},epoch:1,effects:{buildings:{market:.18}}},{id:"granary_architecture",name:"粮仓结构",desc:"粮仓产出 +25%，并额外提供 +5% 人口上限。",cost:{science:960},epoch:1,effects:{buildings:{granary:.12},maxPop:.05}},{id:"primitive_weaving",name:"原始纺织",desc:"使用简易织机将羊毛加工为布料。织布坊效率 +10%。",cost:{science:820},epoch:1,effects:{buildings:{loom_house:.05}}},{id:"early_administration",name:"早期行政",desc:"解锁官署，建立初步的税收与民政管理体系。启用官员系统，官员容量 +2。",cost:{science:880},epoch:1,effects:{categories:{civic:.05}}},{id:"papyrus_cultivation",name:"改进造纸术",desc:"造纸工坊效率 +20%。",cost:{science:1575},epoch:2,effects:{buildings:{reed_works:.12}}},{id:"culinary_arts",name:"烹饪艺术",desc:"解锁烹饪坊，将粮食加工为珍馐，满足上层阶级的饮食需求。",cost:{science:1680},epoch:2,effects:{}},{id:"brewing",name:"酿造工艺",desc:"解锁酿造坊，将粮食发酵为美酒，供贸易与享用。",cost:{science:1610},epoch:2,effects:{}},{id:"carpentry",name:"精细木工",desc:"解锁家具工坊，将木材与石料加工为精美家具，提升上层阶级的生活品质。",cost:{science:1750},epoch:2,effects:{}},{id:"library_catalogs",name:"图书编目",desc:"图书馆科研 +25%。",cost:{science:1645},epoch:2,effects:{buildings:{library:.15}}},{id:"amphitheater_design",name:"剧场设计",desc:"解锁剧场建筑。",cost:{science:1470},epoch:1,effects:{}},{id:"urban_planning",name:"城市规划",desc:"木屋效率 +20%，人口上限 +5%。",cost:{science:1820},epoch:2,effects:{buildings:{house:.12},maxPop:.05}},{id:"republican_code",name:"共和法典",desc:"完善的法律体系提升社会运转效率。民生建筑效率 +15%，人口上限 +5%。",cost:{science:1960},epoch:2,effects:{categories:{civic:.09},maxPop:.05}},{id:"road_system",name:"道路网络",desc:"采集作业效率 +10%。",cost:{science:2100},epoch:2,effects:{categories:{gather:.06}}},{id:"advanced_weaving",name:"高级纺织",desc:"改进织布工具和织机设计，提升纺织效率。织布坊效率 +20%。",cost:{science:1950},epoch:2,effects:{buildings:{loom_house:.12}}},{id:"feudalism",name:"封建制度",desc:"庄园耕作效率 +15%。",cost:{science:3500},epoch:3,effects:{buildings:{large_estate:.09}}},{id:"basic_weaving",name:"织布机",desc:"新型的纺织工具。织布坊效率 +25%。",cost:{science:3150},epoch:3,effects:{buildings:{loom_house:.15}}},{id:"theology",name:"神学",desc:"教堂文化产出 +30%。",cost:{science:3850},epoch:3,effects:{buildings:{church:.18}}},{id:"bureaucracy",name:"官僚制度",desc:"解锁市政厅，建立高效的行政管理体系。采集、工业、市政建筑效率 +5%，每人每日获得 0.002 文化。官员容量 +3。",cost:{science:4200},epoch:3,effects:{categories:{gather:.03,industry:.03,civic:.03},perPopPassive:{culture:.002}}},{id:"civil_service",name:"文官制度",desc:"建立系统化的文官选拔与考核体系，提升行政效率。税收收入 +5%，官员容量 +3。",cost:{science:8750},epoch:4,effects:{incomePercent:.05}},{id:"administrative_reform",name:"行政改革",desc:"改革行政体系，提升官僚机构运转效率。民生建筑效率 +10%，官员容量 +4。",cost:{science:18900},epoch:5,effects:{categories:{civic:.07}}},{id:"centralization",name:"中央集权",desc:"加强中央政府权威，统一政令。税收收入 +8%，稳定度 +5%，官员容量 +2。",cost:{science:27900},epoch:6,effects:{incomePercent:.08}},{id:"three_field_system",name:"三圃制",desc:"农田与庄园额外 +15% 产量。",cost:{science:3850},epoch:3,effects:{buildings:{farm:.09,large_estate:.09}}},{id:"stone_keep_engineering",name:"石垒堡舍",desc:"居住建筑人口上限加成 10%。",cost:{science:4025},epoch:3,effects:{buildings:{hut:.06,house:.06}}},{id:"manor_architecture",name:"庄园建筑学",desc:"解锁石砌宅邸，贵族风格的坚固住宅，提供更多人口容量。宅邸效率 +15%，人口上限 +5%。",cost:{science:4550},epoch:3,effects:{buildings:{manor_house:.15},maxPop:.05}},{id:"monastic_brewing",name:"修道院酿造",desc:"解锁修道院酒窖，修士传承的高级酿酒工艺。酒窖效率 +15%，教堂文化 +10%。",cost:{science:4200},epoch:3,effects:{buildings:{monastery_cellar:.15,church:.1}}},{id:"wool_trade",name:"羊毛贸易",desc:"解锁纺织工场，封建时代最重要的纺织产业。纺织工场效率 +15%，织布坊效率 +10%。",cost:{science:3850},epoch:3,effects:{buildings:{wool_workshop:.15,loom_house:.1}}},{id:"masonry_guild",name:"石匠行会",desc:"解锁采石工场，行会组织的专业采石作业。采石工场效率 +15%，采石场效率 +10%。",cost:{science:4025},epoch:3,effects:{buildings:{stone_workshop:.15,quarry:.1}}},{id:"forestry_management",name:"林业管理",desc:"解锁硬木林场，有计划的森林采伐与维护。硬木林场效率 +15%，伐木场效率 +10%。",cost:{science:3675},epoch:3,effects:{buildings:{hardwood_camp:.15,lumber_camp:.1}}},{id:"ritual_priesthood",name:"仪式司祭",desc:"礼拜设施文化产出提升 15%。",cost:{science:1190},epoch:3,effects:{buildings:{church:.09}}},{id:"ironworking",name:"锻铁术",desc:"解锁铁器铺，并且铁矿井效率 +30%。",cost:{science:1500},epoch:2,effects:{buildings:{mine:.18}}},{id:"cartography",name:"海图绘制",desc:"船坞香料获取 +25%。",cost:{science:6300},epoch:4,effects:{buildings:{dockyard:.18}}},{id:"charter_companies",name:"特许公司",desc:"贸易港银币产出 +30%，财政收入 +5%。",cost:{science:6650},epoch:4,effects:{buildings:{trade_port:.21},incomePercent:.05}},{id:"navigator_schooling",name:"领航学",desc:"航海学院科研提升 30%。",cost:{science:7e3},epoch:4,effects:{buildings:{navigator_school:.21}}},{id:"naval_artillery",name:"舰炮试验",desc:"船坞额外获得 15% 产量。",cost:{science:7350},epoch:4,effects:{buildings:{dockyard:.1}}},{id:"colonial_ledgers",name:"殖民档案",desc:"系统化的殖民地档案管理，提升海外贸易效率。船坞和贸易港效率 +20%，财政收入 +5%。",cost:{science:7700},epoch:4,effects:{buildings:{dockyard:.14,trade_port:.14},incomePercent:.05}},{id:"spice_monopolies",name:"香料垄断",desc:"贸易港再获 15% 产量。",cost:{science:8050},epoch:4,effects:{buildings:{trade_port:.1}}},{id:"colonial_architecture",name:"殖民建筑",desc:"解锁联排住宅，港口城市流行的高效多层建筑。联排住宅效率 +15%，人口上限 +5%。",cost:{science:8400},epoch:4,effects:{buildings:{townhouse:.15},maxPop:.05}},{id:"new_world_dyes",name:"新世界染料",desc:"解锁印染工坊，使用胭脂虫红等新世界珍贵染料。印染工坊效率 +15%，染坊效率 +10%。",cost:{science:7875},epoch:4,effects:{buildings:{dye_workshop:.15,dye_works:.1}}},{id:"coffee_agronomy",name:"咖啡栽培学",desc:"解锁咖啡种植园。",cost:{science:14400},epoch:5,effects:{}},{id:"coffeehouse_philosophy",name:"咖啡馆哲学",desc:"解锁咖啡馆，每人每日获得 0.002 文化。",cost:{science:15300},epoch:5,effects:{perPopPassive:{culture:.002}}},{id:"printing_press",name:"印刷机",desc:"解锁印刷所。",cost:{science:16200},epoch:5,effects:{}},{id:"public_schooling",name:"公共教育",desc:"图书馆 +25% 科研，每人每日获得 0.001 文化。",cost:{science:17100},epoch:5,effects:{buildings:{library:.18},perPopPassive:{culture:.001}}},{id:"social_contract",name:"社会契约",desc:"启蒙思想推动社会进步。民生建筑效率 +20%，人口上限 +5%，每人每日获得 0.003 文化。",cost:{science:18e3},epoch:5,effects:{categories:{civic:.14},maxPop:.05,perPopPassive:{culture:.003}}},{id:"salon_debates",name:"沙龙辩论",desc:"剧场文化再增 15%。",cost:{science:18900},epoch:5,effects:{buildings:{amphitheater:.1}}},{id:"enlightened_urbanism",name:"启蒙城市主义",desc:"解锁阁楼公馆，兼具优雅与实用的新式住宅区。阁楼公馆效率 +15%，人口上限 +6%。",cost:{science:19800},epoch:5,effects:{buildings:{civic_apartment:.15},maxPop:.06}},{id:"coal_gasification",name:"煤气化",desc:"解锁煤矿开采。",cost:{science:23400},epoch:6,effects:{}},{id:"steel_alloys",name:"钢合金",desc:"解锁炼钢厂。",cost:{science:24300},epoch:6,effects:{}},{id:"industrialization",name:"工业化",desc:"解锁工厂，工业建筑效率 +10%。",cost:{science:27e3},epoch:6,effects:{categories:{industry:.07}}},{id:"steam_power",name:"蒸汽动力",desc:"工业建筑再获 +20% 产量。",cost:{science:28800},epoch:6,effects:{categories:{industry:.14}}},{id:"chemical_fertilizer",name:"化学施肥",desc:"农田与庄园 +20% 产出。",cost:{science:27e3},epoch:6,effects:{buildings:{farm:.14,large_estate:.14}}},{id:"rail_network",name:"铁路网",desc:"铁路枢纽效率 +30%，采集 +10%。",cost:{science:27900},epoch:6,effects:{buildings:{rail_depot:.21},categories:{gather:.07}}},{id:"precision_tools",name:"精密机具",desc:"工厂产出 +25%。",cost:{science:28800},epoch:6,effects:{buildings:{factory:.18}}},{id:"military_training",name:"军事训练",desc:"解锁训练场，提供更多军事容量。军事建筑效率 +15%。",cost:{science:2800},epoch:2,effects:{categories:{military:.1}}},{id:"fortification",name:"要塞工程",desc:"解锁要塞，大幅提升军事容量。军事建筑效率 +25%，人口上限 +5%。",cost:{science:8400},epoch:4,effects:{categories:{military:.18},maxPop:.05}},{id:"mechanized_weaving",name:"机械织布",desc:"解锁织布坊和成衣作坊，水力驱动的飞梭织机大幅提升布料产量。织布坊效率 +20%，成衣作坊效率 +15%。",cost:{science:13500},epoch:5,effects:{buildings:{loom_house:.14,tailor_workshop:.1}}},{id:"assembly_line",name:"流水线生产",desc:"解锁纺织厂和服装工厂，标准化分工使产量大幅提升。纺织厂效率 +25%，服装工厂效率 +20%。",cost:{science:26100},epoch:6,effects:{buildings:{textile_mill:.18,garment_factory:.14}}},{id:"hydraulic_sawing",name:"水力锯切",desc:"解锁锯木厂和伐木场升级，水轮驱动的圆锯效率远超手工。锯木厂效率 +25%，伐木场效率 +15%。",cost:{science:12600},epoch:5,effects:{buildings:{sawmill:.18,lumber_camp:.1}}},{id:"mass_production",name:"大规模生产",desc:"解锁木材加工厂和家具工坊，标准化零件实现批量生产。木材加工厂效率 +20%，家具工坊效率 +25%。",cost:{science:25200},epoch:6,effects:{buildings:{lumber_mill:.14,furniture_workshop:.18}}},{id:"advanced_metallurgy",name:"先进冶金",desc:"解锁竖井矿场，改良熔炉与合金配方提升工具质量。铁器铺效率 +20%，青铜铸坊效率 +15%。",cost:{science:7700},epoch:4,effects:{buildings:{iron_tool_workshop:.14,bronze_foundry:.1}}},{id:"bessemer_process",name:"贝塞麦炼钢法",desc:"解锁炼钢厂和冶金工坊，吹入空气快速去碳，钢铁产量剧增。炼钢厂效率 +30%，冶金工坊效率 +25%。",cost:{science:27900},epoch:6,effects:{buildings:{steel_foundry:.21,metallurgy_workshop:.18}}},{id:"industrial_ceramics",name:"工业陶瓷",desc:"解锁砖窯升级，环形窑与传送带实现连续烧制。砖窯效率 +25%。",cost:{science:11700},epoch:5,effects:{buildings:{brickworks:.18}}},{id:"standardized_construction",name:"标准化建筑",desc:"解锁建材厂，预制构件加速建设、降低成本。建材厂效率 +25%，人口上限 +5%。",cost:{science:24300},epoch:6,effects:{buildings:{building_materials_plant:.18},maxPop:.05}},{id:"food_preservation",name:"食品保鲜",desc:"解锁罐头厂，密封罐装技术延长食品保质期。",cost:{science:22500},epoch:6,effects:{buildings:{culinary_kitchen:.18}}},{id:"distillation",name:"蒸馏技术",desc:"解锁蒸馏酒厂，分离提纯出高度烈酒。",cost:{science:14400},epoch:5,effects:{buildings:{brewery:.21}}},{id:"wood_pulp_process",name:"木浆造纸",desc:"解锁造纸厂，木材纤维取代手工纸浆，产量倍增。",cost:{science:13050},epoch:5,effects:{buildings:{reed_works:.21}}},{id:"mass_media",name:"大众传媒",desc:"解锁印刷所和出版社，报纸杂志覆盖全民，舆论力量崛起。印刷所效率 +30%，出版社效率 +20%。",cost:{science:24750},epoch:6,effects:{buildings:{printing_house:.21,publishing_house:.14}}},{id:"deep_shaft_mining",name:"深井采矿",desc:"解锁工业矿场，蒸汽泵排水、铁轨运矿，开采深层矿脉。",cost:{science:23400},epoch:6,effects:{buildings:{mine:.18,coal_mine:.14}}},{id:"agricultural_machinery",name:"农业机械",desc:"解锁机械化农场，蒸汽拖拉机与收割机解放大量人力。",cost:{science:25200},epoch:6,effects:{buildings:{farm:.18,large_estate:.21}}},{id:"steam_logging",name:"蒸汽伐木",desc:"解锁伐木公司，蒸汽锯与窄轨铁路运输原木。",cost:{science:22500},epoch:6,effects:{buildings:{lumber_camp:.21}}},{id:"higher_education",name:"高等教育",desc:"解锁大学，系统化培养专业人才。",cost:{science:15750},epoch:5,effects:{buildings:{library:.14,navigator_school:.14}}},{id:"grand_arts",name:"高雅艺术",desc:"解锁歌剧院，戏剧与音乐的殿堂。",cost:{science:17100},epoch:5,effects:{buildings:{amphitheater:.18,church:.1}}},{id:"urban_architecture",name:"城市建筑学",desc:"解锁公寓楼，多层建筑容纳更多城市人口。人口上限 +6%。",cost:{science:26100},epoch:6,effects:{buildings:{house:.14},maxPop:.06}},{id:"financial_capitalism",name:"金融资本主义",desc:"解锁证券交易所，股票与债券调配社会资本。贸易港效率 +20%，铁路枢纽效率 +15%，财政收入 +8%。",cost:{science:29250},epoch:6,effects:{buildings:{trade_port:.14,rail_depot:.1},incomePercent:.08}}],or=(e,t)=>{const o={0:{light:["militia","slinger"],medium:["militia","slinger"],heavy:["militia","slinger"]},1:{light:["militia","slinger","spearman"],medium:["spearman","archer","chariot"],heavy:["spearman","archer","chariot"]},2:{light:["spearman","archer","light_cavalry"],medium:["hoplite","composite_archer","light_cavalry"],heavy:["hoplite","composite_archer","light_cavalry","battering_ram"]},3:{light:["heavy_infantry","crossbowman","knight"],medium:["heavy_infantry","crossbowman","knight","trebuchet"],heavy:["heavy_infantry","crossbowman","knight","trebuchet"]},4:{light:["pikeman","arquebus","cuirassier"],medium:["pikeman","arquebus","cuirassier","bombard"],heavy:["pikeman","arquebus","cuirassier","bombard"]},5:{light:["musketeer","dragoon"],medium:["musketeer","rifleman","dragoon","cannon"],heavy:["musketeer","rifleman","dragoon","cannon"]},6:{light:["line_infantry","lancer"],medium:["line_infantry","gatling","lancer","artillery"],heavy:["line_infantry","gatling","lancer","artillery"]}},i=o[Math.min(e,6)]||o[0];return i[t]||i.medium},ir={treaties:{peace_treaty:{minEra:1,name:"和平条约"},non_aggression:{minEra:2,name:"互不侵犯条约"},trade_agreement:{minEra:2,name:"贸易协定"},free_trade:{minEra:4,name:"自由贸易协定"},investment_pact:{minEra:4,name:"投资协议"},open_market:{minEra:2,name:"开放市场"},academic_exchange:{minEra:3,name:"学术交流"},defensive_pact:{minEra:3,name:"共同防御"}},sovereignty:{vassal:{minEra:2,name:"附庸国"}},organizations:{military_alliance:{minEra:3,name:"军事联盟"},economic_bloc:{minEra:5,name:"经济共同体"}},economy:{merchant_stationing:{minEra:3,name:"商人驻留"},overseas_building:{minEra:4,name:"海外建筑"},price_convergence:{minEra:6,name:"市场价格联动"},multi_round_negotiation:{minEra:2,name:"多轮谈判"}},migration:{economic_migration:{minEra:3,name:"经济移民"},war_refugees:{minEra:2,name:"战争难民"},political_exile:{minEra:4,name:"政治流亡"}}},ac={peace_treaty:"和平条约",non_aggression:"互不侵犯",trade_agreement:"贸易协定",free_trade:"自由贸易",investment_pact:"投资协议",open_market:"开放市场",academic_exchange:"学术交流",defensive_pact:"共同防御",military_alliance:"军事同盟",economic_bloc:"经济共同体"},rc=["peace_treaty","non_aggression"],Ma={military_alliance:{mutualDefense:!0,relationBonus:5,militaryBonus:.1},economic_bloc:{tariffDiscount:.3,relationBonus:5,tradeEfficiency:.2}},sc={standard:{id:"standard",name:"正常雇佣",description:"按当地生活成本支付正常工资",wageMultiplier:1,unrestPerDay:0,relationPerDay:0,independenceGrowthMod:1},exploitation:{id:"exploitation",name:"压榨剥削",description:"低于市场价的工资，劳动条件恶劣",wageMultiplier:.6,unrestPerDay:.05,relationPerDay:-.5,independenceGrowthMod:1.2},slavery:{id:"slavery",name:"强制劳动",description:"几乎无偿的强制劳动，极高独立风险",wageMultiplier:.3,unrestPerDay:.15,relationPerDay:-2,independenceGrowthMod:1.8,minEra:2}},nr={free:{id:"free",name:"自由贸易",description:"附庸可与任何国家贸易",playerPriceMod:0,tariffDiscount:0,tributeMod:.8,independenceGrowthMod:.8},preferential:{id:"preferential",name:"优惠准入",description:"玩家商人享有优先贸易权",playerPriceMod:-.1,tariffDiscount:.5,tributeMod:1,independenceGrowthMod:1},exclusive:{id:"exclusive",name:"排他贸易",description:"附庸只能与玩家贸易",playerPriceMod:-.25,tariffDiscount:1,tributeMod:1.2,independenceGrowthMod:1.3},dumping:{id:"dumping",name:"倾销市场",description:"强制附庸购买玩家过剩商品",playerPriceMod:.2,tariffDiscount:1,tributeMod:1,independenceGrowthMod:1.4,forcedExports:!0},looting:{id:"looting",name:"资源掠夺",description:"以极低价格获取附庸资源",playerPriceMod:-.4,tariffDiscount:1,tributeMod:1.5,independenceGrowthMod:1.6,forcedImports:!0,minEra:3}},cc=e=>{var t,o;return(o=(t=sc[e])==null?void 0:t.wageMultiplier)!=null?o:1},lc=e=>e>=6?{relationPenalty:50,cooldownDays:365}:e>=4?{relationPenalty:35,cooldownDays:180}:{relationPenalty:20,cooldownDays:90},Ao=(e,t,o)=>{var r;const i=(r=ir[e])==null?void 0:r[t];return i?o>=i.minEra:!1},ar={vassal:{name:"附庸国",minEra:2,minRelation:50,autonomy:80,tributeRate:.1,exploitationFactor:1,tariffDiscount:.5,description:"接受宗主国保护与指导的国家。具体权利义务由政策决定。",canFormAlliance:!0,canSignTreaties:!0,canTrade:!0,militaryObligation:"pay_to_call",economicPrivileges:{investmentCostDiscount:.1,profitTaxExemption:.1,tradePolicyLocked:!1}},protectorate:{name:"附庸国",minEra:2,autonomy:80,minRelation:50},tributary:{name:"附庸国",minEra:2,autonomy:60,minRelation:50},puppet:{name:"附庸国",minEra:2,autonomy:40,minRelation:50},colony:{name:"附庸国",minEra:2,autonomy:20,minRelation:50}},In={farm:[{name:"灌溉田",cost:{wood:50,stone:20,tools:5,silver:300},input:{tools:.04,wood:.06},output:{food:6.24},jobs:{peasant:3}},{name:"精耕田",cost:{plank:80,brick:40,tools:15,silver:800},input:{tools:.08,wood:.1},output:{food:10.8},jobs:{peasant:4}}],lumber_camp:[{name:"大伐木场",cost:{wood:80,stone:30,tools:10,silver:250},input:{tools:.05,food:.15},output:{wood:4.992},jobs:{lumberjack:3}},{name:"林场",cost:{plank:60,brick:30,tools:20,silver:600},input:{tools:.1},output:{wood:8.64,food:.15},jobs:{lumberjack:4}}],quarry:[{name:"深坑采石场",cost:{wood:80,stone:50,tools:15,silver:300},input:{tools:.06,wood:.15,food:.15},output:{stone:3.9},jobs:{miner:3}},{name:"大采石场",cost:{plank:80,stone:100,tools:30,silver:700},input:{tools:.12,wood:.25,food:.25},output:{stone:6.75,copper:.02},jobs:{miner:4}}],loom_house:[{name:"织布坊",cost:{wood:80,stone:40,tools:10,silver:250},input:{tools:.02},output:{cloth:2.5},jobs:{worker:3}},{name:"大织布坊",cost:{plank:60,brick:40,tools:20,silver:600},input:{tools:.04,dye:.03},output:{cloth:4.32,culture:.05},jobs:{worker:4}}],brickworks:[{name:"改良砖窑",cost:{stone:80,wood:40,tools:15,silver:300},input:{stone:1,wood:.35,tools:.02},output:{brick:3.12},jobs:{worker:3}},{name:"大砖窑",cost:{stone:120,brick:80,tools:30,silver:700},input:{stone:1.5,wood:.5,tools:.04},output:{brick:5.4,tools:.02},jobs:{worker:4}}],stone_tool_workshop:[{name:"工匠铺",cost:{stone:50,wood:50,silver:200},input:{wood:1.65,stone:1.35},output:{tools:.975},jobs:{artisan:3}},{name:"大工匠铺",cost:{brick:40,plank:40,silver:500},input:{wood:2.25,stone:1.8},output:{tools:1.35},jobs:{artisan:3}}],trading_post:[{name:"商铺",cost:{wood:100,stone:40,silver:400},input:{tools:.01},output:{food:5.2,silver:2.08},jobs:{merchant:2}},{name:"商会",cost:{plank:80,brick:60,silver:900},input:{tools:.02,papyrus:.01},output:{food:9,silver:3.6,spice:.02},jobs:{merchant:3}}],library:[{name:"学堂",cost:{stone:150,plank:40,papyrus:30,brick:40,silver:600,science:80},input:{papyrus:.08},output:{science:1.3867},jobs:{scribe:4}},{name:"书院",cost:{brick:120,plank:60,papyrus:80,silver:1400,science:200},input:{papyrus:.15,science:.15},output:{science:2.4,culture:.12},jobs:{scribe:5}}],copper_mine:[{name:"深铜矿",cost:{wood:120,tools:20,silver:350},input:{tools:.05,wood:.2,food:.2},output:{copper:.8667},jobs:{miner:4}},{name:"大铜矿",cost:{plank:80,tools:40,silver:800},input:{tools:.1,wood:.35,food:.35},output:{copper:1.5,stone:.15},jobs:{miner:5}}],dye_works:[{name:"大染坊",cost:{wood:60,stone:25,tools:10,silver:250},input:{food:.6,tools:.02},output:{dye:1.17},jobs:{worker:3}},{name:"染色工坊",cost:{plank:50,brick:30,tools:20,silver:600},input:{food:.9,tools:.04,cloth:.05},output:{dye:2.025,culture:.05},jobs:{worker:4}}],sawmill:[{name:"水力锯木坊",cost:{wood:120,stone:40,tools:15,silver:350},input:{wood:1.4,tools:.03},output:{plank:4.511},jobs:{worker:4}},{name:"大锯木坊",cost:{plank:80,brick:50,tools:30,silver:800},input:{wood:2,tools:.06,cloth:.05},output:{plank:7.8075,furniture:.05},jobs:{worker:5}}],bronze_foundry:[{name:"改良铸坊",cost:{stone:60,copper:25,silver:300},input:{copper:.75,wood:.45,tools:.015},output:{tools:1.95},jobs:{worker:3,artisan:1}},{name:"大铸坊",cost:{brick:50,copper:40,silver:700},input:{copper:1.05,wood:.675,tools:.03},output:{tools:2.7},jobs:{worker:3,artisan:1}}],amphitheater:[{name:"大剧场",cost:{stone:120,brick:40,silver:400},input:{fine_clothes:.06},output:{culture:6.5,silver:.8},jobs:{cleric:2}},{name:"宏伟剧场",cost:{brick:80,furniture:20,silver:900},input:{fine_clothes:.08,ale:.03},output:{culture:9,silver:1.5},jobs:{cleric:2}}],reed_works:[{name:"改良造纸坊",cost:{wood:60,tools:10,silver:220},input:{tools:.01},output:{papyrus:1.17},jobs:{worker:3}},{name:"大造纸坊",cost:{plank:50,tools:20,silver:500},input:{tools:.02},output:{papyrus:2.025,science:.05},jobs:{worker:4}}],culinary_kitchen:[{name:"精致厨房",cost:{brick:40,tools:15,cloth:8,silver:350},input:{tools:.08,food:1.2},output:{delicacies:2.6},jobs:{artisan:3,peasant:1}},{name:"御膳房",cost:{brick:60,furniture:15,delicacies:20,silver:800},input:{tools:.12,food:1.8,spice:.06},output:{delicacies:4.5,culture:.08},jobs:{artisan:3,peasant:2}}],brewery:[{name:"大酒坊",cost:{brick:30,tools:12,cloth:6,silver:280},input:{food:1,wood:.15,tools:.01},output:{ale:2.34},jobs:{worker:3}},{name:"酿酒工坊",cost:{brick:50,tools:25,dye:10,ale:15,silver:650},input:{food:1.5,wood:.25,tools:.02,spice:.03},output:{ale:4.05,culture:.05},jobs:{worker:4}}],furniture_workshop:[{name:"精工家具坊",cost:{plank:80,tools:20,silver:400},input:{tools:.08,plank:1,cloth:.25},output:{furniture:2.08},jobs:{artisan:4}},{name:"大家具坊",cost:{plank:120,furniture:15,silver:900},input:{tools:.12,plank:1.5,cloth:.35},output:{furniture:3.6},jobs:{artisan:5}}],tailor_workshop:[{name:"高级成衣坊",cost:{plank:50,tools:15,silver:350},input:{tools:.035,cloth:.85,dye:.17},output:{fine_clothes:1.04,culture:.6},jobs:{artisan:3}},{name:"御用成衣坊",cost:{brick:40,fine_clothes:10,silver:800},input:{tools:.05,cloth:1.3,dye:.25},output:{fine_clothes:1.8,culture:.8},jobs:{artisan:4}}],mine:[{name:"深井铁矿",cost:{plank:80,tools:25,silver:400},input:{tools:.08,wood:.2,food:.3},output:{iron:1.65},jobs:{miner:7,landowner:1}},{name:"大铁矿",cost:{brick:60,tools:40,silver:900},input:{tools:.15,wood:.35,food:.45},output:{iron:2.86,coal:.05},jobs:{miner:9,landowner:1}}],iron_tool_workshop:[{name:"精铁工坊",cost:{brick:60,iron:30,silver:400},input:{wood:.6,iron:.975,tools:.015},output:{tools:2.925},jobs:{worker:3,artisan:1}},{name:"大铁匠铺",cost:{brick:100,iron:50,silver:900},input:{wood:.9,iron:1.5,tools:.03},output:{tools:4.05},jobs:{worker:3,artisan:1}}],large_estate:[{name:"繁荣庄园",cost:{plank:60,tools:20,silver:400},input:{tools:.1,wood:.15},output:{food:23.4},jobs:{serf:8,landowner:1}},{name:"领主庄园",cost:{brick:50,furniture:15,silver:900},input:{tools:.18,wood:.25,cloth:.05},output:{food:40.5,cloth:.1,ale:.03},jobs:{serf:9,landowner:1}}],church:[{name:"大教堂",cost:{brick:80,furniture:25,silver:500},input:{furniture:.05,fine_clothes:.04},output:{culture:3.8,silver:1.2},jobs:{cleric:3}},{name:"主教座堂",cost:{brick:150,furniture:40,silver:1200},input:{furniture:.06,fine_clothes:.05,papyrus:.02},output:{culture:5.5,silver:2,science:.15},jobs:{cleric:4}}],monastery_cellar:[{name:"修道院大酒窖",cost:{stone:80,tools:20,silver:400},input:{food:2,wood:.35},output:{ale:2.6,culture:1.4},jobs:{cleric:1,worker:3}},{name:"酿酒修道院",cost:{brick:100,furniture:20,silver:900},input:{food:2.7,wood:.5},output:{ale:4.5,culture:2,science:.08},jobs:{cleric:2,worker:2}}],wool_workshop:[{name:"大纺织工场",cost:{plank:80,tools:20,silver:380},input:{food:.7,tools:.04},output:{cloth:4.16,fine_clothes:.26},jobs:{serf:4,worker:3}},{name:"领主纺织工场",cost:{brick:60,tools:35,silver:850},input:{food:1,tools:.06,dye:.05},output:{cloth:7.2,fine_clothes:.45,culture:.05},jobs:{serf:5,worker:3}}],stone_workshop:[{name:"大采石工场",cost:{plank:60,iron:25,silver:350},input:{tools:.08,food:.15},output:{stone:4.55},jobs:{miner:4,worker:1}},{name:"皇家采石场",cost:{brick:80,iron:40,silver:800},input:{tools:.12,food:.25},output:{stone:7.875,brick:.15},jobs:{miner:5,worker:1}}],hardwood_camp:[{name:"特用林场",cost:{plank:80,tools:30,silver:450},input:{tools:.1,food:.2},output:{wood:6.24},jobs:{lumberjack:5,worker:1}},{name:"皇家御林",cost:{brick:80,tools:50,silver:900},input:{tools:.15,food:.35},output:{wood:10.8,food:.2},jobs:{lumberjack:6,worker:1}}],dockyard:[{name:"大船坞",cost:{plank:120,tools:30,silver:500},input:{wood:.4,tools:.02},output:{spice:.9},jobs:{navigator:2,worker:2,merchant:1}},{name:"皇家船厂",cost:{plank:200,iron:40,silver:1100},input:{wood:.6,tools:.03,cloth:.06},output:{spice:1.55,silver:.25,science:.05},jobs:{navigator:3,worker:2,merchant:1}}],navigator_school:[{name:"航海学府",cost:{plank:80,papyrus:40,silver:400},input:{papyrus:.05},output:{science:.78,culture:1.2},jobs:{navigator:3,scribe:1,official:1}},{name:"皇家航海学院",cost:{brick:60,papyrus:80,silver:900},input:{papyrus:.08,coffee:.03},output:{science:1.35,culture:1.8},jobs:{navigator:4,scribe:1,official:1}}],trade_port:[{name:"繁荣港口",cost:{plank:150,spice:30,silver:600},input:{spice:.25},output:{food:2.6,silver:.15},jobs:{merchant:4}},{name:"贸易枢纽",cost:{brick:120,spice:60,silver:1300},input:{spice:.35,cloth:.06},output:{food:4.5,silver:.4},jobs:{merchant:5}}],shaft_mine:[{name:"通风矿井",cost:{brick:120,tools:45,silver:650},input:{tools:.14,wood:.3,science:.065},output:{iron:1.872,copper:1.248},jobs:{miner:6,engineer:1}},{name:"蒸汽矿井",cost:{brick:200,steel:50,tools:80,silver:1200},input:{tools:.2,coal:.15,wood:.4,science:.11},output:{iron:3.24,copper:2.16,coal:.1},jobs:{miner:7,engineer:1}}],dye_workshop:[{name:"大印染工坊",cost:{brick:80,tools:25,silver:480},input:{food:.9,cloth:.5,spice:.06,science:.026},output:{dye:2.34,fine_clothes:.585},jobs:{artisan:3,worker:2}},{name:"皇家印染工坊",cost:{brick:140,tools:45,silver:1050},input:{food:1.2,cloth:.7,spice:.08,iron:.02,science:.045},output:{dye:4.05,fine_clothes:1.0125,culture:.08},jobs:{artisan:4,worker:2}}],coffee_plantation:[{name:"大种植园",cost:{wood:300,spice:40,silver:800},input:{tools:.03},output:{coffee:.52},jobs:{serf:6,merchant:1}},{name:"种植园庄园",cost:{plank:200,tools:60,silver:1800},input:{tools:.06},output:{coffee:.9,spice:.02,food:.5},jobs:{serf:8,merchant:1}}],coffee_house:[{name:"文人咖啡馆",cost:{plank:80,coffee:25,silver:400},input:{coffee:.2,delicacies:.08},output:{culture:4.8,science:1.733,silver:.6},jobs:{merchant:1,scribe:2}},{name:"沙龙",cost:{brick:60,furniture:25,silver:900},input:{coffee:.3,delicacies:.1},output:{culture:7,science:3,silver:1.2},jobs:{merchant:1,scribe:3}}],printing_house:[{name:"大印刷所",cost:{brick:120,papyrus:40,silver:500,science:100},input:{papyrus:.48,coffee:.09,science:.2},output:{science:3.12,culture:2.4},jobs:{artisan:5,scribe:3,capitalist:1}},{name:"出版社",cost:{brick:200,papyrus:80,silver:1100,science:250},input:{papyrus:.75,coffee:.15,science:.35},output:{science:5.4,culture:3.6},jobs:{artisan:5,scribe:3,capitalist:1}}],textile_mill:[{name:"大纺织厂",cost:{brick:120,tools:40,silver:600},input:{food:2.6,dye:.975,tools:.04},output:{cloth:16.25,fine_clothes:1.95},jobs:{worker:15,artisan:4,capitalist:1}},{name:"纺织工场",cost:{brick:200,tools:60,silver:1300},input:{food:4.5,dye:1.6875,tools:.0692,coffee:.0533},output:{cloth:28.125,fine_clothes:3.375},jobs:{worker:16,artisan:4,capitalist:1}}],lumber_mill:[{name:"大木材厂",cost:{brick:100,tools:35,silver:500},input:{wood:8.3572,tools:.024},output:{plank:22.2858},jobs:{worker:10,artisan:1,capitalist:1}},{name:"木业公司",cost:{brick:180,tools:50,silver:1100},input:{wood:14.4644,tools:.048},output:{plank:38.5715,furniture:.144},jobs:{worker:11,artisan:1,capitalist:1}}],building_materials_plant:[{name:"大建材厂",cost:{brick:120,tools:35,silver:550},input:{stone:5.85,wood:1.755,coal:.585},output:{brick:16.0875},jobs:{worker:14,engineer:1,capitalist:1}},{name:"建材公司",cost:{brick:200,tools:50,silver:1200},input:{stone:10.125,wood:3.0375,coal:1.0125},output:{brick:27.84375},jobs:{worker:15,engineer:1,capitalist:1}}],distillery:[{name:"大蒸馏厂",cost:{brick:150,copper:50,silver:600},input:{food:5.85,coal:.585},output:{ale:10.2375,silver:2.34},jobs:{worker:12,artisan:2,capitalist:1}},{name:"酒业公司",cost:{brick:250,copper:80,silver:1300},input:{food:10.125,coal:1.0125},output:{ale:17.71875,silver:4.05,culture:.12},jobs:{worker:13,artisan:2,capitalist:1}}],paper_mill:[{name:"大造纸厂",cost:{brick:120,tools:35,silver:500},input:{wood:3.9,coal:.39},output:{papyrus:6.5},jobs:{worker:10,engineer:1,capitalist:1}},{name:"造纸公司",cost:{brick:200,tools:50,silver:1100},input:{wood:6.75,coal:.675},output:{papyrus:11.25,tools:.06},jobs:{worker:11,engineer:1,capitalist:1}}],university:[{name:"著名学府",cost:{brick:250,papyrus:60,silver:750,science:150},input:{papyrus:.3125,coffee:.1875,delicacies:.125,science:.4},output:{science:4.875,culture:1.3},jobs:{scribe:5,engineer:2,official:2}},{name:"皇家学院",cost:{brick:400,papyrus:120,silver:1700,science:400},input:{papyrus:.4375,coffee:.25,delicacies:.15,science:.7},output:{science:8.4375,culture:2.25},jobs:{scribe:6,engineer:2,official:2}}],opera_house:[{name:"大歌剧院",cost:{brick:250,furniture:50,silver:700},input:{fine_clothes:.25,delicacies:.15},output:{culture:5.6875,silver:1.625},jobs:{cleric:5,artisan:2,merchant:1}},{name:"皇家歌剧院",cost:{brick:400,furniture:80,silver:1500},input:{fine_clothes:.375,delicacies:.225,coffee:.1},output:{culture:9.8438,silver:2.8125,science:.1875},jobs:{cleric:6,artisan:2,merchant:1}}],coal_mine:[{name:"深煤矿",cost:{plank:150,tools:40,silver:500},input:{tools:.35,wood:.5,food:.8},output:{coal:5},jobs:{miner:13,capitalist:1}},{name:"大煤矿",cost:{brick:100,tools:60,silver:1100},input:{tools:.55,wood:.8,food:1.2},output:{coal:8,iron:.2},jobs:{miner:9,capitalist:1}}],steel_foundry:[{name:"大炼钢厂",cost:{brick:200,iron:120,silver:750,science:150},input:{iron:1.2,coal:1.2,science:.3},output:{steel:1.2},jobs:{engineer:5,worker:7,capitalist:1}},{name:"钢铁联合厂",cost:{steel:100,iron:200,silver:1700,science:350},input:{iron:2.4,coal:2.4,science:.6},output:{steel:2.4,tools:.2},jobs:{engineer:5,worker:8,capitalist:1}}],factory:[{name:"大工厂",cost:{brick:300,steel:120,silver:850,science:200},input:{steel:3,coal:3,science:.75},output:{tools:22},jobs:{worker:20,engineer:4,capitalist:1}},{name:"制造中心",cost:{steel:200,tools:80,silver:1900,science:450},input:{steel:4.2,coal:4.2,science:1},output:{tools:32,steel:.1,science:.2},jobs:{worker:21,engineer:4,capitalist:1}}],industrial_mine:[{name:"大工业矿场",cost:{steel:150,tools:60,silver:850},input:{tools:.33995,coal:.68,wood:.4,food:.8},output:{iron:3.85,copper:1.245},jobs:{miner:17,engineer:2,capitalist:1}},{name:"矿业公司",cost:{steel:250,tools:100,silver:1900},input:{tools:.588375,coal:1.125,wood:.6,food:1},output:{iron:6.663075,copper:2.153925},jobs:{miner:18,engineer:2,capitalist:1}}],mechanized_farm:[{name:"大机械农场",cost:{steel:100,tools:50,silver:750},input:{tools:.2275,coal:.455,iron:.06},output:{food:50.05},jobs:{peasant:8,worker:8,engineer:1,capitalist:1}},{name:"工业农场",cost:{steel:170,tools:80,silver:1700},input:{tools:.39375,coal:.7875,iron:.1,dye:.03},output:{food:86.625,cloth:.2},jobs:{peasant:9,worker:8,engineer:1,capitalist:1}}],logging_company:[{name:"大伐木公司",cost:{steel:60,tools:40,silver:650},input:{tools:.1563,coal:.325,food:.4},output:{wood:26},jobs:{lumberjack:11,worker:7,engineer:1,capitalist:1}},{name:"林业公司",cost:{steel:120,tools:60,silver:1500},input:{tools:.270825,coal:.5625,food:.55},output:{wood:45},jobs:{lumberjack:12,worker:7,engineer:1,capitalist:1}}],prefab_factory:[{name:"大预制厂",cost:{steel:150,tools:60,silver:850},input:{brick:3.9,steel:.52,stone:2.6,coal:1.04},output:{brick:28.6},jobs:{worker:20,engineer:4,capitalist:1}},{name:"建筑材料公司",cost:{steel:250,tools:100,silver:1900},input:{brick:6.75,steel:.9,stone:4.5,coal:1.8},output:{brick:49.5},jobs:{worker:21,engineer:4,capitalist:1}}],cannery:[{name:"大罐头厂",cost:{steel:60,tools:40,silver:650},input:{food:7.3125,iron:.8775,coal:.73125},output:{delicacies:10.2375},jobs:{worker:17,artisan:4,engineer:1,capitalist:1}},{name:"食品公司",cost:{steel:120,tools:60,silver:1500},input:{food:12.65625,iron:1.51875,coal:1.265625},output:{delicacies:17.71875,ale:.3},jobs:{worker:18,artisan:5,engineer:1,capitalist:1}}],garment_factory:[{name:"大服装厂",cost:{steel:100,tools:60,silver:850},input:{cloth:4.875,dye:.975,coal:.585},output:{fine_clothes:5.46,culture:.585},jobs:{worker:18,artisan:4,engineer:1,capitalist:1}},{name:"服装公司",cost:{steel:170,tools:100,silver:1900},input:{cloth:8.4375,dye:1.6875,coal:1.0125},output:{fine_clothes:9.45,culture:1.0125,cloth:.5},jobs:{worker:20,artisan:4,engineer:1,capitalist:1}}],furniture_factory:[{name:"大家具厂",cost:{steel:80,tools:50,silver:750},input:{plank:7.3125,cloth:2.34,coal:.73125},output:{furniture:10.2375,culture:.585},jobs:{worker:17,artisan:4,engineer:1,capitalist:1}},{name:"家具公司",cost:{steel:150,tools:80,silver:1700},input:{plank:12.65625,cloth:4.05,coal:1.265625},output:{furniture:17.71875,culture:1.0125,plank:.4},jobs:{worker:18,artisan:4,engineer:1,capitalist:1}}],market:[{name:"大市场",cost:{brick:300,papyrus:60,cloth:15,silver:1e3},input:{papyrus:.12,coffee:.075},output:{food:3.9,silver:.45},jobs:{merchant:4,scribe:1}},{name:"交易所",cost:{steel:200,papyrus:120,delicacies:30,silver:2200},input:{papyrus:.18,coffee:.12},output:{food:6.75,silver:.75,culture:.225},jobs:{merchant:5,scribe:1}}],rail_depot:[{name:"大铁路站",cost:{steel:120,coal:80,silver:850},input:{coal:.375,ale:.1,delicacies:.05,science:.195},output:{silver:3.51,maxPop:15},jobs:{engineer:4,merchant:3,capitalist:1}},{name:"铁路枢纽",cost:{steel:220,coal:150,silver:1900},input:{coal:.5625,ale:.15,delicacies:.075,science:.3375},output:{silver:6.075,maxPop:16,food:.625,culture:.125},jobs:{engineer:5,merchant:4,capitalist:1}}],metallurgy_workshop:[{name:"精密冶金坊",cost:{brick:120,iron:60,silver:600},input:{iron:1.2,copper:.25,wood:.6},output:{tools:3.9},jobs:{worker:4,artisan:2,engineer:1}},{name:"大冶金坊",cost:{brick:200,iron:100,silver:1300},input:{iron:1.8,copper:.4,wood:.9,coal:.08},output:{tools:6.75},jobs:{worker:5,artisan:2,engineer:1}}]},Nt=(e,t=0)=>{if(!t||t===0)return{name:e.name,input:e.input||{},output:e.output||{},jobs:e.jobs||{},owner:e.owner||null};const o=In[e.id];if(!o||!o[t-1])return{name:e.name,input:e.input||{},output:e.output||{},jobs:e.jobs||{},owner:e.owner||null};const i=o[t-1];return{name:i.name||e.name,input:i.input||e.input||{},output:i.output||e.output||{},jobs:i.jobs||e.jobs||{},owner:i.owner||e.owner||null}},kn=e=>{const t=In[e];return t?t.length:0},Dn=(e,t,o=0,i=1.15)=>{const r=In[e];if(!r||!r[t-1])return null;const a=r[t-1].cost||{};if(o<=0)return a;const c=1+Math.max(0,i-1)*Math.pow(o,.9),f={};for(const[p,d]of Object.entries(a))f[p]=Math.ceil(d*c);return f},rr={demanding:{high:120,standard:80,low:50},offering:{high:60,standard:40,low:25}},va=2e6;function sr(e,t=null){const o=t?Math.min(e||0,t||0):e||0,i=Math.floor(o*.02);return Math.max(30,Math.min(1e4,i))}function cr(e,t,o,i,r="demanding",a=0){const s=Math.abs(e||0),u=t||0,c=o||0,f=i||0,p=a||0,d=rr[r]||rr.demanding,M=s*d.high,h=u*80,y=c*25,x=p*.3,m=Math.ceil(M+h+y+x),E=Math.ceil(s*d.standard+u*50+c*18+p*.2),v=Math.ceil(s*d.low+u*35+c*12+p*.1),g=Math.floor(f*.18),_=Math.floor(f*.12),A=Math.floor(f*.06),k=f*1,D=Math.max(5e4,k);let P=va;if(p>0&&r==="demanding"){const I=1+s/100;P=p*I,P=Math.max(p*.5,P)}const T=Math.min(va,D,P);return{high:Math.max(600,g,Math.min(T,m)),standard:Math.max(400,_,Math.min(T,E)),low:Math.max(200,A,Math.min(T,v)),breakdown:{scoreComponent:M,lossComponent:h,durationComponent:y,expenseComponent:x,rawHigh:m,rawStandard:E,rawLow:v},caps:{hardCap:va,wealthCap:D,armyExpenseCap:P,effectiveCap:T}}}function uc(e,t,o,i){return cr(e,t,o,i,"offering").standard}function fc(e,t,o=1e4){return cr(e,0,t,o,"offering").standard}const Ro={militia:{id:"militia",name:"民兵",desc:"由农民临时组成的武装力量，战斗力较弱但成本低廉。",epoch:0,icon:"Users",category:"infantry",attack:6,defense:4,speed:3,range:1,recruitCost:{food:125,wood:60},maintenanceCost:{food:1.75,silver:.6},trainingTime:2,populationCost:1,abilities:["快速征召"],counters:{cavalry:1.2,siege:1.3},weakAgainst:["archer"],obsoleteAfterEpochs:2},slinger:{id:"slinger",name:"投石兵",desc:"使用投石索的远程单位，对轻甲单位有效。",epoch:0,icon:"Circle",category:"archer",attack:6,defense:2,speed:3,range:3,recruitCost:{food:150,wood:75,stone:25},maintenanceCost:{food:2,silver:.75,stone:.5},trainingTime:3,populationCost:1,abilities:["远程攻击"],counters:{infantry:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},spearman:{id:"spearman",name:"长矛兵",desc:"装备青铜长矛的步兵，对骑兵有显著克制效果。",epoch:1,icon:"Sword",category:"infantry",attack:12,defense:9,speed:3,range:1,recruitCost:{food:275,wood:175,copper:60},maintenanceCost:{food:2.75,silver:1.75,copper:.25},trainingTime:4,populationCost:1,abilities:["反骑兵"],counters:{cavalry:1.8,siege:1.2},weakAgainst:["archer"],obsoleteAfterEpochs:2},archer:{id:"archer",name:"弓箭手",desc:"装备复合弓的远程单位，克制步兵。",epoch:1,icon:"Target",category:"archer",attack:14,defense:6,speed:4,range:4,recruitCost:{food:325,wood:225,silver:125},maintenanceCost:{food:3.25,silver:2.25,wood:1},trainingTime:5,populationCost:1,abilities:["远程攻击","高机动"],counters:{infantry:1.5,siege:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},chariot:{id:"chariot",name:"战车",desc:"青铜时代的机动战力，由马匹牵引的战车。",epoch:1,icon:"Truck",category:"cavalry",attack:15,defense:8,speed:6,range:1,recruitCost:{food:500,wood:300,copper:150,silver:200},maintenanceCost:{food:6,silver:3.5,wood:1.5},trainingTime:6,populationCost:1,abilities:["冲锋","机动"],counters:{archer:1.6},weakAgainst:["infantry"],obsoleteAfterEpochs:2},hoplite:{id:"hoplite",name:"重装步兵",desc:"装备圆盾和长矛的古典精锐步兵，方阵作战威力强大。",epoch:2,icon:"Shield",category:"infantry",attack:16,defense:14,speed:2,range:1,recruitCost:{food:500,copper:200,iron:100,silver:250},maintenanceCost:{food:3.75,silver:2.75,iron:.4},trainingTime:6,populationCost:1,abilities:["方阵","坚守"],counters:{cavalry:1.7,siege:1.3},weakAgainst:["archer"],obsoleteAfterEpochs:2},composite_archer:{id:"composite_archer",name:"复合弓手",desc:"使用复合弓的精锐射手，穿透力更强。",epoch:2,icon:"Target",category:"archer",attack:18,defense:7,speed:4,range:5,recruitCost:{food:425,wood:250,copper:125,silver:225},maintenanceCost:{food:3.5,silver:2.5,wood:1.25,copper:.25},trainingTime:6,populationCost:1,abilities:["远程攻击","穿甲"],counters:{infantry:1.6,siege:1.3},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},light_cavalry:{id:"light_cavalry",name:"轻骑兵",desc:"快速机动的骑兵单位，克制弓箭手。",epoch:2,icon:"Navigation",category:"cavalry",attack:18,defense:8,speed:8,range:1,recruitCost:{food:600,silver:300,iron:125},maintenanceCost:{food:6,silver:4,iron:.3},trainingTime:7,populationCost:1,abilities:["快速移动","冲锋"],counters:{archer:1.8},weakAgainst:["infantry"],obsoleteAfterEpochs:2},battering_ram:{id:"battering_ram",name:"攻城槌",desc:"古典时代的攻城器械，对建筑极为有效。",epoch:2,icon:"Hammer",category:"siege",attack:30,defense:15,speed:1,range:1,recruitCost:{food:750,wood:1e3,iron:250,silver:400},maintenanceCost:{food:6,silver:4,wood:2.5,iron:.5},trainingTime:10,populationCost:2,abilities:["攻城"],counters:{},weakAgainst:["cavalry","archer","infantry"],obsoleteAfterEpochs:2},heavy_infantry:{id:"heavy_infantry",name:"重甲步兵",desc:"装备锁子甲的精锐步兵，防御力强。",epoch:3,icon:"ShieldAlert",category:"infantry",attack:20,defense:18,speed:2,range:1,recruitCost:{food:700,iron:300,silver:400},maintenanceCost:{food:4.5,silver:3.5,iron:.6,cloth:.2},trainingTime:8,populationCost:1,abilities:["重甲","坚守"],counters:{cavalry:1.6,siege:1.4},weakAgainst:["archer"],obsoleteAfterEpochs:2},crossbowman:{id:"crossbowman",name:"弩兵",desc:"装备十字弩的远程单位，穿透力强。",epoch:3,icon:"Crosshair",category:"archer",attack:22,defense:9,speed:3,range:5,recruitCost:{food:550,wood:350,iron:225,silver:275},maintenanceCost:{food:4,silver:3,wood:.75,iron:.5},trainingTime:7,populationCost:1,abilities:["远程攻击","穿甲"],counters:{infantry:1.7,siege:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},knight:{id:"knight",name:"骑士",desc:"装备板甲的精锐骑兵，封建时代的主力。",epoch:3,icon:"Crown",category:"cavalry",attack:28,defense:22,speed:6,range:1,recruitCost:{food:1250,iron:500,copper:150,silver:800},maintenanceCost:{food:9,silver:6.5,iron:.8,copper:.3},trainingTime:10,populationCost:1,abilities:["重甲","冲锋","贵族"],counters:{archer:1.9},weakAgainst:["infantry"],obsoleteAfterEpochs:2},trebuchet:{id:"trebuchet",name:"投石机",desc:"中世纪的重型攻城器械，可投掷巨石。",epoch:3,icon:"Mountain",category:"siege",attack:45,defense:8,speed:1,range:6,recruitCost:{food:1e3,wood:1e3,plank:400,iron:400,silver:750},maintenanceCost:{food:7.5,silver:6,plank:1.5,iron:.6,stone:1.2},trainingTime:12,populationCost:3,abilities:["攻城","范围伤害"],counters:{infantry:1.3},weakAgainst:["cavalry","archer"],obsoleteAfterEpochs:2},pikeman:{id:"pikeman",name:"长枪兵",desc:"装备长枪的步兵，方阵抵御骑兵冲锋。",epoch:4,icon:"Swords",category:"infantry",attack:22,defense:20,speed:2,range:2,recruitCost:{food:800,wood:300,iron:350,silver:450},maintenanceCost:{food:5,silver:4,iron:.5},trainingTime:8,populationCost:1,abilities:["反骑兵","方阵"],counters:{cavalry:2,siege:1.3},weakAgainst:["archer","gunpowder"],obsoleteAfterEpochs:2},arquebus:{id:"arquebus",name:"火绳枪手",desc:"早期火器部队，虽然装填慢但威力巨大，克制传统步兵和骑兵。",epoch:4,icon:"Flame",category:"gunpowder",attack:28,defense:8,speed:2,range:4,recruitCost:{food:700,iron:300,tools:200,copper:80,silver:500},maintenanceCost:{food:4.5,silver:4,iron:.35,tools:.9,copper:.15},trainingTime:9,populationCost:1,abilities:["火器","穿甲","装填缓慢"],counters:{infantry:1.5,cavalry:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},cuirassier:{id:"cuirassier",name:"胸甲骑兵",desc:"装备胸甲的重装骑兵，可抵抗早期火器。",epoch:4,icon:"Shield",category:"cavalry",attack:32,defense:24,speed:6,range:1,recruitCost:{food:1500,iron:600,silver:1e3},maintenanceCost:{food:10,silver:7.5,iron:1.25},trainingTime:11,populationCost:1,abilities:["重甲","冲锋","抗火器"],counters:{archer:1.9,gunpowder:1.5},weakAgainst:["infantry"],obsoleteAfterEpochs:2},bombard:{id:"bombard",name:"射石炮",desc:"早期火炮，可攻破城墙。",epoch:4,icon:"Bomb",category:"siege",attack:55,defense:10,speed:1,range:6,recruitCost:{food:1250,iron:600,copper:250,tools:350,silver:1e3},maintenanceCost:{food:9,silver:7.5,iron:1.2,copper:.4,tools:1.5},trainingTime:14,populationCost:3,abilities:["攻城","范围伤害","火器"],counters:{infantry:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},musketeer:{id:"musketeer",name:"刺刀火枪兵",desc:"装备滑膛枪和刺刀的步兵，可远程射击也可近战。",epoch:5,icon:"Zap",category:"infantry",attack:30,defense:14,speed:3,range:3,recruitCost:{food:900,iron:350,tools:250,silver:550},maintenanceCost:{food:5.5,silver:5,iron:.45,tools:1,cloth:.15},trainingTime:9,populationCost:1,abilities:["火器","刺刀冲锋","齐射"],counters:{cavalry:1.6,siege:1.4},weakAgainst:["gunpowder"],obsoleteAfterEpochs:2},rifleman:{id:"rifleman",name:"线膛枪手",desc:"装备线膛枪的精确射手，射程远、精度高。",epoch:5,icon:"Target",category:"gunpowder",attack:35,defense:10,speed:3,range:5,recruitCost:{food:1e3,iron:400,tools:300,silver:650},maintenanceCost:{food:6,silver:5.5,iron:.5,tools:1.3},trainingTime:10,populationCost:1,abilities:["火器","精确射击","穿甲"],counters:{infantry:1.7,cavalry:1.5,siege:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},dragoon:{id:"dragoon",name:"龙骑兵",desc:"骑马机动的火枪兵，可下马作战，机动性和火力兼备。",epoch:5,icon:"Navigation",category:"cavalry",attack:35,defense:18,speed:7,range:2,recruitCost:{food:1400,iron:450,tools:225,silver:900},maintenanceCost:{food:10,silver:7.5,iron:.75,tools:1},trainingTime:12,populationCost:1,abilities:["火器","快速移动","下马作战"],counters:{archer:1.8,gunpowder:1.6},weakAgainst:["infantry"],obsoleteAfterEpochs:2},cannon:{id:"cannon",name:"野战炮",desc:"启蒙时代的标准火炮，可用于攻城和野战。",epoch:5,icon:"Bomb",category:"siege",attack:60,defense:12,speed:2,range:7,recruitCost:{food:1500,iron:700,copper:300,tools:450,silver:1250},maintenanceCost:{food:10,silver:9,iron:1.4,copper:.5,tools:2},trainingTime:15,populationCost:3,abilities:["攻城","范围伤害","火器"],counters:{infantry:1.7,gunpowder:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},line_infantry:{id:"line_infantry",name:"线列步兵",desc:"工业化训练的步兵，装备后装步枪和刺刀。",epoch:6,icon:"Users",category:"infantry",attack:40,defense:20,speed:3,range:4,recruitCost:{food:1250,steel:150,tools:200,silver:800},maintenanceCost:{food:7,silver:6.5,steel:.3,coal:.15},trainingTime:10,populationCost:1,abilities:["火器","齐射","刺刀冲锋"],counters:{cavalry:1.7,siege:1.5},weakAgainst:["gunpowder"],obsoleteAfterEpochs:3},gatling:{id:"gatling",name:"加特林机枪组",desc:"早期机枪，火力密集，克制密集阵型的步兵和骑兵。",epoch:6,icon:"Zap",category:"gunpowder",attack:50,defense:12,speed:2,range:5,recruitCost:{food:1500,steel:300,tools:350,coal:200,silver:1250},maintenanceCost:{food:8,silver:9,steel:.6,coal:.8},trainingTime:12,populationCost:2,abilities:["火器","压制火力","范围伤害"],counters:{infantry:2,cavalry:1.8},weakAgainst:["siege"],obsoleteAfterEpochs:3},lancer:{id:"lancer",name:"枪骑兵",desc:"工业时代的精锐骑兵，适合侦察、追击和近身突袭火器阵地。",epoch:6,icon:"Compass",category:"cavalry",attack:38,defense:20,speed:8,range:1,recruitCost:{food:1600,steel:120,tools:180,silver:1e3},maintenanceCost:{food:11,silver:8,steel:.25,iron:.4},trainingTime:11,populationCost:1,abilities:["冲锋","快速移动","侦察"],counters:{archer:1.9,gunpowder:1.7},weakAgainst:["infantry"],obsoleteAfterEpochs:3},artillery:{id:"artillery",name:"重型火炮",desc:"工业化生产的重型火炮，威力巨大。",epoch:6,icon:"Bomb",category:"siege",attack:80,defense:15,speed:1,range:8,recruitCost:{food:2e3,steel:500,coal:400,tools:300,silver:1750},maintenanceCost:{food:10,silver:11,steel:1.2,coal:1.5},trainingTime:18,populationCost:4,abilities:["攻城","范围伤害","精确打击"],counters:{infantry:2,gunpowder:1.8,siege:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:3}},dc=(e={})=>{let t=0;return Object.entries(e).forEach(([o,i])=>{var s;if(i<=0)return;const r=Ro[o];if(!r)return;const a=((s=r.maintenanceCost)==null?void 0:s.food)||0;t+=a*i}),t},lr=(e,t)=>{let o=1,i=0;return Object.entries(e).forEach(([r,a])=>{if(a<=0)return;const s=Ro[r];s&&Object.entries(t).forEach(([u,c])=>{if(c<=0)return;const f=Ro[u];if(f&&s.counters[f.category]){const p=s.counters[f.category],d=a*c/100;o+=(p-1)*d,i++}})}),{multiplier:o,counterCount:i}},pc={范围伤害:.12,压制火力:.1,火器:.06,齐射:.05,远程攻击:.05,穿甲:.06,冲锋:.06,机动:.04,快速移动:.04,侦察:.03,攻城:.08,精确打击:.08},hc={坚守:.08,方阵:.08,盾墙:.08},ur=(e,t)=>Array.isArray(e)?e.reduce((o,i)=>o+(t[i]||0),0):0,mc=(e={})=>{const t=Object.values(e).reduce((o,i)=>o+(i||0),0);return t<=0?{infantry:0,cavalry:0,archer:0,gunpowder:0,siege:0}:{infantry:(e.infantry||0)/t,cavalry:(e.cavalry||0)/t,archer:(e.archer||0)/t,gunpowder:(e.gunpowder||0)/t,siege:(e.siege||0)/t}},fr=(e={})=>{const t={};return Object.entries(e).forEach(([o,i])=>{if(i<=0)return;const r=Ro[o];r&&(t[r.category]=(t[r.category]||0)+i)}),t},gc=(e,t,o)=>{if(!e||o<=0)return 1;let i=1;return Object.entries(e.counters||{}).forEach(([r,a])=>{const s=(t[r]||0)/o;s>0&&(i+=(a-1)*s)}),i},dr=(e={})=>{const t={infantry:1,cavalry:1,archer:1,gunpowder:1,siege:1},o=Object.values(e).reduce((i,r)=>i+(r||0),0);return o<=0||Object.entries(e).forEach(([i,r])=>{if(r<=0)return;const a=Ro[i];if(!a||!a.counters)return;const s=r/o;Object.entries(a.counters).forEach(([u,c])=>{t[u]+=(c-1)*s})}),t},pr=({army:e,enemyCategoryCounts:t,enemyCounterPressure:o,militaryBuffs:i=0,defenseMultiplier:r=1})=>{let a=0,s=0,u=0;const c={},f=Object.values(t||{}).reduce((d,M)=>d+(M||0),0),p=mc(t);return Object.entries(e||{}).forEach(([d,M])=>{if(M<=0)return;const h=Ro[d];if(!h)return;const y=gc(h,t||{},f),x=ur(h.abilities,pc),m=ur(h.abilities,hc),E=Math.min(.3,(h.range||1)*.03),v=Math.min(.2,(h.speed||1)*.02);let g=0,_=0,A=0;const k=Array.isArray(h.abilities)?h.abilities:[];k.includes("范围伤害")&&(g+=.18*(p.infantry+p.archer)),k.includes("压制火力")&&(g+=.12*(p.infantry+p.archer)),k.includes("火器")&&(g+=.1*(p.infantry+p.cavalry),_-=.08*p.cavalry),k.includes("穿甲")&&(g+=.08*(p.infantry+p.gunpowder+p.siege)),k.includes("冲锋")&&(h.speed||0)>=6&&(g+=.1*(p.gunpowder+p.archer)),k.includes("刺刀冲锋")&&(g+=.06*p.cavalry),k.includes("装填缓慢")&&(g-=.12*p.cavalry),k.includes("重甲")&&(_+=.12,g-=.05),k.includes("抗火器")&&(A-=.15*p.gunpowder,_+=.05*p.gunpowder),(k.includes("精确射击")||k.includes("精确打击"))&&(g+=.08*(p.siege+p.infantry)),k.includes("下马作战")&&(_+=.08*p.cavalry);const D=h.attack*(1+E+v+x+g)*(1+i)*y,P=h.defense*(1+v*.5+m+_)*r*(1+i),T=Math.max(.6,((o==null?void 0:o[h.category])||1)*(1+A)),I=P/T;a+=D*M,s+=P*M,u+=M,c[d]={count:M,attackPerUnit:D,defensePerUnit:P,adjustedDefensePerUnit:I,category:h.category}}),{totalAttack:a,totalDefense:s,totalUnits:u,unitProfiles:c}},yc=(e={})=>{const t={};Object.values(e).forEach(r=>{r&&(t[r.category]=(t[r.category]||0)+r.count)});let o=null,i=0;return Object.entries(t).forEach(([r,a])=>{a>i&&(i=a,o=r)}),o},hr=e=>{const t=Math.floor(e),o=e-t;return t+(Math.random()<o?1:0)},bc=(e,t)=>{if(t<=0)return{};const o={...e};let i=Object.values(o).reduce((u,c)=>u+(c||0),0);if(i<=t)return o;const r=t/i;if(Object.keys(o).forEach(u=>{o[u]=hr(o[u]*r)}),i=Object.values(o).reduce((u,c)=>u+(c||0),0),i<=t)return o;const a=Object.keys(o).sort((u,c)=>(o[c]||0)-(o[u]||0));let s=0;for(;i>t&&a.length>0;){const u=a[s%a.length];(o[u]||0)>0&&(o[u]-=1,i-=1),s+=1}return o},mr=({sideProfile:e,enemyProfile:t,enemyCounterPressure:o,isWinner:i,powerRatio:r,decisive:a,dominanceRatio:s,ownPowerScore:u,enemyPowerScore:c})=>{if(!e||e.totalUnits<=0||t.totalAttack<=0)return{};const f=c/(c+u);let p=.12*Math.pow(f,.9);if(i&&(p*=.75),a&&(p*=i?.6:1.1),p*=.9+Math.random()*.2,!i){const y=Math.max(1,s||1);p*=1+Math.min(.8,(y-1)*.18)}const d=t.totalAttack*p;if(d<=0)return{};let M=0;if(Object.values(e.unitProfiles).forEach(y=>{M+=y.count/y.adjustedDefensePerUnit}),M<=0)return{};const h={};if(Object.entries(e.unitProfiles).forEach(([y,x])=>{const m=x.count/x.adjustedDefensePerUnit,v=d*(m/M)/x.adjustedDefensePerUnit;h[y]=Math.min(x.count,hr(v))}),!i){const y=Math.max(1,s||1);if(y>=3&&(a||y>=6)){const x=Math.min(.75,.2+(y-3)*.12+(a?.15:0));if(Math.random()<x){const m={};return Object.entries(e.unitProfiles).forEach(([E,v])=>{m[E]=v.count}),m}}}if(i&&r>=3&&t.totalUnits>0){let y;r>=10?y=Math.floor(Math.sqrt(t.totalUnits)*.2):r>=6?y=Math.floor(Math.sqrt(t.totalUnits)*.3):y=Math.floor(Math.sqrt(t.totalUnits)*.4);const x=yc(e.unitProfiles);return((o==null?void 0:o[x])||1)>=1.4&&y===0&&t.totalUnits>=5&&(y=1),bc(h,y)}return h},gr=(e,t)=>{const{army:o,militaryBuffs:i=0}=e,{army:r,militaryBuffs:a=0,wealth:s=1e3}=t,u=fr(o),c=fr(r),f=dr(o),p=dr(r),d=pr({army:o,enemyCategoryCounts:c,enemyCounterPressure:p,militaryBuffs:i,defenseMultiplier:1}),M=pr({army:r,enemyCategoryCounts:u,enemyCounterPressure:f,militaryBuffs:a,defenseMultiplier:1.2});let h=d.totalAttack*.65+d.totalDefense*.35,y=M.totalAttack*.65+M.totalDefense*.35;h*=.9+Math.random()*.2,y*=.9+Math.random()*.2;const x=h+y,m=x>0?h/x:0,E=x>0?y/x:0,v=m>.5,g=Math.abs(m-.5)>.28,_=y>0?h/y:100,A=mr({sideProfile:d,enemyProfile:M,enemyCounterPressure:p,isWinner:v,powerRatio:_,decisive:g,dominanceRatio:v?_:1/_,ownPowerScore:h,enemyPowerScore:y}),k=mr({sideProfile:M,enemyProfile:d,enemyCounterPressure:f,isWinner:!v,powerRatio:_>0?1/_:100,decisive:g,dominanceRatio:v?_:1/_,ownPowerScore:y,enemyPowerScore:h}),D=lr(o,r),P=lr(r,o);let T={};if(v){const V=s*(g?.08:.04),N={food:500,wood:300,stone:200,silver:1500,iron:150,copper:100,cloth:100,tools:80};T={food:Math.min(N.food,Math.floor(V*.25)),wood:Math.min(N.wood,Math.floor(V*.12)),stone:Math.min(N.stone,Math.floor(V*.08)),silver:Math.min(N.silver,Math.floor(V*.3)),iron:Math.min(N.iron,Math.floor(V*.1)),copper:Math.min(N.copper,Math.floor(V*.05)),cloth:Math.min(N.cloth,Math.floor(V*.05)),tools:Math.min(N.tools,Math.floor(V*.05))},Object.keys(T).forEach(L=>{T[L]<=0&&delete T[L]})}return{victory:v,decisive:g,attackerPower:Math.floor(h),defenderPower:Math.floor(y),attackerAdvantage:(m*100).toFixed(1),defenderAdvantage:(E*100).toFixed(1),attackerLosses:A,defenderLosses:k,attackerCounter:D.counterCount,defenderCounter:P.counterCount,loot:T,battleReport:Mc({victory:v,decisive:g,attackerPower:h,defenderPower:y,attackerCounter:D.counterCount,defenderCounter:P.counterCount,attackerLosses:A,defenderLosses:k,loot:T})}},Mc=e=>{const{victory:t,decisive:o,attackerPower:i,defenderPower:r,attackerCounter:a,defenderCounter:s,attackerLosses:u,defenderLosses:c,loot:f}=e;let p=[];t?o?p.push("🎉 压倒性胜利！敌军溃不成军！"):p.push("✓ 艰难的胜利，我军成功击退敌人。"):o?p.push("💀 惨败！我军遭受重创！"):p.push("✗ 战败，我军被迫撤退。"),p.push(`战斗力对比：我方 ${Math.floor(i)} vs 敌方 ${Math.floor(r)}`),a>0&&p.push(`✓ 我方兵种克制生效 ${a} 次`),s>0&&p.push(`✗ 敌方兵种克制生效 ${s} 次`);const d=Object.values(u).reduce((h,y)=>h+y,0),M=Object.values(c).reduce((h,y)=>h+y,0);if(p.push(`我方损失：${d} 人`),p.push(`敌方损失：${M} 人`),t&&f){const h=Object.entries(f).filter(([,y])=>y>0).map(([y,x])=>`${y} ${x}`).join(", ");h&&p.push(`掠夺资源：${h}`)}return p},vc=e=>{const t={};return Object.entries(e).forEach(([o,i])=>{if(i<=0)return;const r=Ro[o];r&&Object.entries(r.maintenanceCost).forEach(([a,s])=>{t[a]=(t[a]||0)+s*i})}),t},yr=e=>{let t=0;return Object.entries(e).forEach(([o,i])=>{if(i<=0)return;const r=Ro[o];r&&(t+=r.populationCost*i)}),t},wc=(e,t)=>{if(t<=0||e<=0)return 1;const o=e/t;return o<=.1?1:o<=.2?1+(o-.1)*2.5:o<=.3?1.25+(o-.2)*2.5:o<=.4?1.5+(o-.3)*2.5:1.75+(o-.4)*2.5},yo=["peasant","worker","artisan","merchant","landowner","cleric","scribe","soldier","official","capitalist","miner","engineer","serf"],xc={stratum_approval_above:{generate:()=>{const e=yo[Math.floor(Math.random()*yo.length)],t=40+Math.floor(Math.random()*40);return{stratum:e,threshold:t}},check:(e,t)=>{var o;return(((o=t.classApproval)==null?void 0:o[e.stratum])||50)>=e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}满意度 ≥ ${e.threshold}`}},stratum_approval_below:{generate:()=>{const e=yo[Math.floor(Math.random()*yo.length)],t=20+Math.floor(Math.random()*30);return{stratum:e,threshold:t}},check:(e,t)=>{var o;return(((o=t.classApproval)==null?void 0:o[e.stratum])||50)<e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}满意度 < ${e.threshold}`}},stratum_influence_above:{generate:()=>{const e=yo[Math.floor(Math.random()*yo.length)],t=10+Math.floor(Math.random()*25);return{stratum:e,threshold:t}},check:(e,t)=>{var r;const o=t.totalInfluence||1;return(((r=t.classInfluence)==null?void 0:r[e.stratum])||0)/o*100>=e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}影响力 ≥ ${e.threshold}%`}},stratum_influence_below:{generate:()=>{const e=yo[Math.floor(Math.random()*yo.length)],t=5+Math.floor(Math.random()*15);return{stratum:e,threshold:t}},check:(e,t)=>{var r;const o=t.totalInfluence||1;return(((r=t.classInfluence)==null?void 0:r[e.stratum])||0)/o*100<e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}影响力 < ${e.threshold}%`}},stratum_living_standard:{generate:()=>{const e=yo[Math.floor(Math.random()*yo.length)],t=["赤贫","贫困","温饱","小康","富裕","奢华"],o=Math.floor(Math.random()*4);return{stratum:e,minLevel:o,levelName:t[o]}},check:(e,t)=>{var a,s;const o=["赤贫","贫困","温饱","小康","富裕","奢华"],i=((s=(a=t.classLivingStandard)==null?void 0:a[e.stratum])==null?void 0:s.level)||"温饱",r=o.indexOf(i);return r===-1?!1:r>=e.minLevel},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}生活水平 ≥ ${e.levelName}`}},stratum_income_above:{generate:()=>{const e=yo[Math.floor(Math.random()*yo.length)],t=50+Math.floor(Math.random()*200);return{stratum:e,threshold:t}},check:(e,t)=>{var o;return(((o=t.classIncome)==null?void 0:o[e.stratum])||0)>=e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}日均收入 ≥ ${e.threshold}`}},stability_above:{generate:()=>({threshold:50+Math.floor(Math.random()*40)}),check:(e,t)=>(t.stability||.5)*100>=e.threshold,text:e=>`稳定度 ≥ ${e.threshold}%`},stability_below:{generate:()=>({threshold:20+Math.floor(Math.random()*40)}),check:(e,t)=>(t.stability||.5)*100<e.threshold,text:e=>`稳定度 < ${e.threshold}%`},avg_tax_above:{generate:()=>({threshold:8+Math.floor(Math.random()*15)}),check:(e,t)=>{var r;const o=Object.values(((r=t.taxPolicies)==null?void 0:r.headTaxRates)||{});return(o.length>0?o.reduce((a,s)=>a+s,0)/o.length:.1)*100>=e.threshold},text:e=>`平均税率 ≥ ${e.threshold}%`},avg_tax_below:{generate:()=>({threshold:5+Math.floor(Math.random()*10)}),check:(e,t)=>{var r;const o=Object.values(((r=t.taxPolicies)==null?void 0:r.headTaxRates)||{});return(o.length>0?o.reduce((a,s)=>a+s,0)/o.length:.1)*100<e.threshold},text:e=>`平均税率 < ${e.threshold}%`},coalition_size_above:{generate:()=>({threshold:2+Math.floor(Math.random()*3)}),check:(e,t)=>{var o;return(((o=t.rulingCoalition)==null?void 0:o.length)||0)>=e.threshold},text:e=>`执政联盟 ≥ ${e.threshold}个阶层`},coalition_size_below:{generate:()=>({threshold:2+Math.floor(Math.random()*2)}),check:(e,t)=>{var o;return(((o=t.rulingCoalition)==null?void 0:o.length)||0)<=e.threshold},text:e=>`执政联盟 ≤ ${e.threshold}个阶层`},coalition_includes:{generate:()=>({stratum:yo[Math.floor(Math.random()*yo.length)]}),check:(e,t)=>{var o;return(o=t.rulingCoalition)==null?void 0:o.includes(e.stratum)},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}参与执政`}},legitimacy_above:{generate:()=>({threshold:40+Math.floor(Math.random()*40)}),check:(e,t)=>(t.legitimacy||50)>=e.threshold,text:e=>`合法性 ≥ ${e.threshold}`},at_war:{generate:()=>({}),check:(e,t)=>{var o;return t.atWar===!0||((o=t.nations)==null?void 0:o.some(i=>i.isAtWar))},text:()=>"处于战争状态"},at_peace:{generate:()=>({}),check:(e,t)=>{var o;return t.atWar!==!0&&!((o=t.nations)!=null&&o.some(i=>i.isAtWar))},text:()=>"处于和平状态"},population_above:{generate:()=>({threshold:500+Math.floor(Math.random()*2e3)}),check:(e,t)=>(t.population||0)>=e.threshold,text:e=>`人口 ≥ ${e.threshold}`},population_below:{generate:()=>({threshold:200+Math.floor(Math.random()*500)}),check:(e,t)=>(t.population||0)<e.threshold,text:e=>`人口 < ${e.threshold}`},epoch_at_least:{generate:()=>({epoch:Math.floor(Math.random()*5)}),check:(e,t)=>(t.epoch||0)>=e.epoch,text:e=>`达到${["石器时代","青铜时代","古典时代","封建时代","探索时代","启蒙时代","工业时代","信息时代"][e.epoch]||`时代${e.epoch}`}`},resource_price_above:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","ale","coal","delicacies","furniture","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",ale:"美酒",coal:"煤炭",delicacies:"珍馐",furniture:"家具",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=1.1+Math.random()*.4,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)>=e.threshold},text:e=>`${e.resourceName}物价 ≥ ${e.threshold}`},resource_price_below:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","ale","coal","delicacies","furniture","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",ale:"美酒",coal:"煤炭",delicacies:"珍馐",furniture:"家具",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=.7+Math.random()*.25,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)<e.threshold},text:e=>`${e.resourceName}物价 < ${e.threshold}`},price_stability:{generate:()=>{const e=.3+Math.random()*.4;return{threshold:Math.round(e*100)/100}},check:(e,t)=>{if(!t.prices||Object.keys(t.prices).length===0)return!0;const o=Object.values(t.prices),i=o.reduce((a,s)=>a+s,0)/o.length,r=o.reduce((a,s)=>a+Math.pow(s-i,2),0)/o.length;return Math.sqrt(r)<=e.threshold},text:e=>`物价波动 ≤ ${(e.threshold*100).toFixed(0)}%`},food_affordable:{generate:e=>{var r;const t=((r=e==null?void 0:e.prices)==null?void 0:r.food)||1,o=.75+Math.random()*.2;return{threshold:Math.round(t*o*10)/10}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i.food)||1)<=e.threshold},text:e=>`粮价 ≤ ${e.threshold}`},food_scarce:{generate:e=>{var r;const t=((r=e==null?void 0:e.prices)==null?void 0:r.food)||1,o=1.1+Math.random()*.3;return{threshold:Math.round(t*o*10)/10}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i.food)||1)>=e.threshold},text:e=>`粮价 ≥ ${e.threshold}`},inflation_above:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","coal","delicacies","furniture","ale","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",coal:"煤炭",delicacies:"珍馐",furniture:"家具",ale:"美酒",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=1.15+Math.random()*.35,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)>=e.threshold},text:e=>`${e.resourceName}物价 ≥ ${e.threshold}`},deflation_below:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","coal","delicacies","furniture","ale","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",coal:"煤炭",delicacies:"珍馐",furniture:"家具",ale:"美酒",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=.65+Math.random()*.25,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)<e.threshold},text:e=>`${e.resourceName}物价 < ${e.threshold}`}},Ec={primitive_communism:{name:"原始公社",spectrum:"left",icon:"Users",color:"text-red-400",unlockEpoch:0,maxEpoch:3,historicalRef:"氏族共有制",description:"一切资源归部落共有",issues:["equality","collectivism"],conditionTypes:["stratum_approval_above","stability_above","coalition_size_above"],preferredStrata:["peasant","worker","artisan","serf"],stratumWeights:{peasant:2,worker:2,serf:1.5,landowner:.2,merchant:.3,capitalist:.1},activeEffects:{stability:.05,approval:{peasant:4,worker:4}},unsatisfiedPenalty:{approval:{peasant:-2,worker:-2}}},tribal_elder:{name:"部落长老制",spectrum:"right",icon:"Crown",color:"text-amber-400",unlockEpoch:0,maxEpoch:2,historicalRef:"早期酋长",description:"尊崇长老权威",issues:["tradition","hierarchy"],conditionTypes:["legitimacy_above","stratum_influence_above","population_below"],preferredStrata:["landowner","cleric","official"],stratumWeights:{landowner:2,cleric:1.5,peasant:1},activeEffects:{stability:.04,legitimacyBonus:.04},unsatisfiedPenalty:{stability:-.02}},animism:{name:"万物有灵论",spectrum:"center",icon:"Leaf",color:"text-green-400",unlockEpoch:0,maxEpoch:3,historicalRef:"原始宗教",description:"敬畏自然神灵",issues:["spiritual","nature"],conditionTypes:["stratum_approval_above","stability_above"],preferredStrata:["cleric","peasant"],stratumWeights:{cleric:3,peasant:1.5},activeEffects:{approval:{cleric:6},needsReduction:.02},unsatisfiedPenalty:{}},warrior_cult:{name:"尚武精神",spectrum:"right",icon:"Sword",color:"text-red-500",unlockEpoch:0,maxEpoch:5,historicalRef:"原始部落战争",description:"崇尚武力与征服",issues:["military","expansion"],conditionTypes:["at_war","stratum_approval_above"],preferredStrata:["soldier","landowner"],stratumWeights:{soldier:3},activeEffects:{militaryBonus:.15},unsatisfiedPenalty:{approval:{soldier:-4}}},aristocratic_oligarchy:{name:"贵族寡头制",spectrum:"right",icon:"Castle",color:"text-purple-400",unlockEpoch:1,historicalRef:"斯巴达双王制",description:"政权归于少数贵族",issues:["hierarchy","tradition"],conditionTypes:["stratum_influence_above","coalition_includes","legitimacy_above"],preferredStrata:["landowner","official","merchant"],stratumWeights:{landowner:3,official:1.5},activeEffects:{militaryBonus:.12,taxEfficiency:.08},unsatisfiedPenalty:{approval:{landowner:-6}}},theocracy:{name:"神权政治",spectrum:"right",icon:"Church",color:"text-yellow-300",unlockEpoch:1,historicalRef:"古埃及法老",description:"神的代言人统治",issues:["spiritual","hierarchy"],conditionTypes:["coalition_includes","stratum_approval_above"],preferredStrata:["cleric"],stratumWeights:{cleric:4},activeEffects:{legitimacyBonus:.15,approval:{cleric:15}},unsatisfiedPenalty:{approval:{cleric:-8}}},republicanism:{name:"共和主义",spectrum:"center",icon:"Scale",color:"text-blue-400",unlockEpoch:2,historicalRef:"罗马共和国",description:"公民参与公共事务",issues:["liberty","law"],conditionTypes:["coalition_size_above","legitimacy_above","stability_above"],preferredStrata:["scribe","merchant","artisan","official"],stratumWeights:{scribe:2,merchant:1.5,artisan:1.5},activeEffects:{legitimacyBonus:.12,stability:.08},unsatisfiedPenalty:{stability:-.02}},populares:{name:"平民派",spectrum:"left",icon:"Users",color:"text-orange-400",unlockEpoch:2,historicalRef:"格拉古兄弟",description:"为平民争取权益",issues:["equality","reform"],conditionTypes:["stratum_approval_above","stratum_living_standard","food_affordable"],preferredStrata:["peasant","worker","artisan","serf"],stratumWeights:{peasant:2.5,worker:2.5,artisan:1.5},activeEffects:{populationGrowth:.08,approval:{peasant:8,worker:8}},unsatisfiedPenalty:{approval:{peasant:-4,worker:-4}}},legalism:{name:"法家",spectrum:"right",icon:"Gavel",color:"text-gray-300",unlockEpoch:2,historicalRef:"商鞅变法",description:"严刑峻法治国",issues:["law","efficiency"],conditionTypes:["avg_tax_above","stability_above"],preferredStrata:["official","soldier","scribe"],stratumWeights:{official:2.5,soldier:1.5},activeEffects:{taxEfficiency:.15,stability:-.06},unsatisfiedPenalty:{}},confucianism:{name:"儒家",spectrum:"center",icon:"Book",color:"text-amber-300",unlockEpoch:2,historicalRef:"孔孟之道",description:"礼教治国",issues:["tradition","education"],conditionTypes:["stratum_approval_above","stability_above","legitimacy_above"],preferredStrata:["scribe","cleric","official"],stratumWeights:{scribe:3,cleric:1.5,official:2},activeEffects:{stability:.15,researchSpeed:.08},unsatisfiedPenalty:{stability:-.02}},mohism:{name:"墨家",spectrum:"left",icon:"Wrench",color:"text-gray-400",unlockEpoch:2,historicalRef:"墨子兼爱非攻",description:"兼爱非攻，尚同尚贤",issues:["equality","efficiency"],conditionTypes:["at_peace","stratum_approval_above"],preferredStrata:["artisan","worker","engineer"],stratumWeights:{artisan:2.5,worker:2,engineer:1.5},activeEffects:{industryBonus:.12,buildingCostMod:-.08,productionInputCost:{sawmill:-.15,brickworks:-.15,metallurgy_workshop:-.18}},unsatisfiedPenalty:{approval:{artisan:-2}}},taoism:{name:"道家",spectrum:"center",icon:"Circle",color:"text-slate-300",unlockEpoch:2,historicalRef:"老庄无为",description:"无为而治",issues:["liberty","nature"],conditionTypes:["avg_tax_below","stability_above"],preferredStrata:["cleric","peasant","scribe"],stratumWeights:{cleric:2,peasant:1.5,scribe:1.5},activeEffects:{needsReduction:.12,stability:.08},unsatisfiedPenalty:{}},feudalism:{name:"封建主义",spectrum:"right",icon:"Castle",color:"text-blue-500",unlockEpoch:3,historicalRef:"中世纪欧洲分封",description:"领主-附庸关系",issues:["hierarchy","land"],conditionTypes:["stratum_influence_above","legitimacy_above"],preferredStrata:["landowner","official"],stratumWeights:{landowner:3,peasant:.5},activeEffects:{gatherBonus:.08,approval:{landowner:12}},unsatisfiedPenalty:{approval:{landowner:-6}}},peasant_revolt:{name:"农民起义派",spectrum:"left",icon:"Flame",color:"text-red-600",unlockEpoch:3,historicalRef:"黄巾起义、扎克雷起义",description:"推翻压迫者",issues:["equality","revolution"],conditionTypes:["stratum_approval_below","avg_tax_above","food_scarce","inflation_above"],preferredStrata:["peasant","serf","worker"],stratumWeights:{peasant:3,serf:3,worker:2},activeEffects:{organizationDecay:-.22},unsatisfiedPenalty:{}},guild_corporatism:{name:"行会主义",spectrum:"center",icon:"Hammer",color:"text-orange-300",unlockEpoch:3,historicalRef:"中世纪行会",description:"同业互助，质量至上",issues:["trade","tradition"],conditionTypes:["stratum_approval_above","stratum_income_above","resource_price_below","price_stability"],preferredStrata:["artisan","merchant"],stratumWeights:{artisan:3,merchant:2},activeEffects:{tradeBonus:.12,approval:{artisan:8,merchant:8},productionInputCost:{furniture_workshop:-.18,tailor_workshop:-.18,loom_house:-.15}},unsatisfiedPenalty:{approval:{artisan:-4},productionInputCost:{furniture_workshop:.05,tailor_workshop:.05}}},mercantilism:{name:"重商主义",spectrum:"center",icon:"Ship",color:"text-cyan-400",unlockEpoch:4,historicalRef:"东印度公司",description:"贸易国富之本",issues:["trade","wealth"],conditionTypes:["stratum_income_above","stratum_influence_above","resource_price_above","inflation_above"],preferredStrata:["merchant","capitalist"],stratumWeights:{merchant:3,capitalist:2},activeEffects:{tradeBonus:.18,incomePercentBonus:.08},unsatisfiedPenalty:{approval:{merchant:-4}}},absolutism:{name:"绝对君主制",spectrum:"right",icon:"Crown",color:"text-purple-500",unlockEpoch:4,historicalRef:"路易十四、彼得大帝",description:"朕即国家",issues:["hierarchy","centralization"],conditionTypes:["coalition_size_below","legitimacy_above"],preferredStrata:["official","landowner"],stratumWeights:{official:2},activeEffects:{taxEfficiency:.15,buildingCostMod:-.12},unsatisfiedPenalty:{}},humanism:{name:"人文主义",spectrum:"center",icon:"Book",color:"text-rose-300",unlockEpoch:4,historicalRef:"文艺复兴",description:"以人为本",issues:["education","progress"],conditionTypes:["stratum_approval_above","epoch_at_least"],preferredStrata:["scribe","artisan","engineer"],stratumWeights:{scribe:3,artisan:2},activeEffects:{researchSpeed:.15,cultureBonus:.12},unsatisfiedPenalty:{}},colonialism:{name:"殖民主义",spectrum:"right",icon:"Globe",color:"text-emerald-500",unlockEpoch:4,historicalRef:"大航海时代",description:"开拓新世界",issues:["expansion","trade"],conditionTypes:["stratum_income_above","at_war"],preferredStrata:["merchant","soldier","navigator"],stratumWeights:{merchant:2,soldier:1.5},activeEffects:{tradeBonus:.15,diplomaticBonus:.8},unsatisfiedPenalty:{}},classical_liberalism:{name:"古典自由主义",spectrum:"center",icon:"Lightbulb",color:"text-yellow-400",unlockEpoch:5,historicalRef:"洛克、亚当斯密",description:"自由放任经济",issues:["liberty","free_market"],conditionTypes:["avg_tax_below","stratum_approval_above","price_stability","deflation_below"],preferredStrata:["merchant","capitalist","artisan"],stratumWeights:{merchant:2,capitalist:2.5,artisan:1.5},activeEffects:{incomePercentBonus:.12,populationGrowth:.08},unsatisfiedPenalty:{approval:{merchant:-4,capitalist:-4}}},enlightened_despotism:{name:"开明专制",spectrum:"center",icon:"GraduationCap",color:"text-indigo-400",unlockEpoch:5,historicalRef:"腎特烈大帝、叶卡捷琳娜",description:"国王为国家第一仆人",issues:["reform","centralization"],conditionTypes:["coalition_size_below","legitimacy_above","stability_above"],preferredStrata:["official","scribe","engineer"],stratumWeights:{official:2,scribe:2,engineer:1.5},activeEffects:{researchSpeed:.18,buildingCostMod:-.08},unsatisfiedPenalty:{}},conservatism:{name:"保守主义",spectrum:"right",icon:"Shield",color:"text-gray-400",unlockEpoch:5,historicalRef:"伯克、梅特涅",description:"维护传统秩序",issues:["tradition","stability"],conditionTypes:["stability_above","legitimacy_above"],preferredStrata:["landowner","cleric","official"],stratumWeights:{landowner:2,cleric:2},activeEffects:{stability:.12,legitimacyBonus:.08},unsatisfiedPenalty:{stability:-.04}},utopian_socialism:{name:"空想社会主义",spectrum:"left",icon:"Sparkles",color:"text-pink-400",unlockEpoch:5,historicalRef:"莫尔乌托邦、欧文",description:"构建理想社会",issues:["equality","progress"],conditionTypes:["stratum_approval_above","stratum_living_standard"],preferredStrata:["worker","artisan","peasant","scribe"],stratumWeights:{scribe:2,worker:1.5,artisan:1.5},activeEffects:{researchSpeed:.12,approval:{worker:8}},unsatisfiedPenalty:{}},physiocracy:{name:"重农主义",spectrum:"center",icon:"Wheat",color:"text-lime-400",unlockEpoch:5,historicalRef:"魁奈学派",description:"土地是财富之源",issues:["land","free_market"],conditionTypes:["stratum_influence_above","stratum_approval_above","food_affordable","resource_price_below"],preferredStrata:["landowner","peasant"],stratumWeights:{landowner:2.5,peasant:2},activeEffects:{gatherBonus:.15,approval:{peasant:8,landowner:8}},unsatisfiedPenalty:{approval:{landowner:-4}}},marxism:{name:"马克思主义",spectrum:"left",icon:"Factory",color:"text-red-500",unlockEpoch:6,historicalRef:"共产党宣言",description:"工人阶级专政",issues:["equality","revolution","collectivism"],conditionTypes:["coalition_includes","stratum_influence_above"],preferredStrata:["worker","miner","artisan"],stratumWeights:{worker:4,miner:2},activeEffects:{industryBonus:.18,approval:{worker:15,miner:12},productionInputCost:{steel_foundry:-.22,textile_mill:-.18,building_materials_plant:-.18}},unsatisfiedPenalty:{approval:{worker:-6},organizationDecay:-.08,productionInputCost:{steel_foundry:.08,textile_mill:.06}}},social_democracy:{name:"社会民主主义",spectrum:"left",icon:"HeartHandshake",color:"text-rose-400",unlockEpoch:6,historicalRef:"伯恩斯坦修正主义",description:"渐进改良",issues:["equality","welfare"],conditionTypes:["stratum_approval_above","stratum_living_standard","stability_above","food_affordable","price_stability"],preferredStrata:["worker","scribe","artisan","peasant"],stratumWeights:{worker:2,scribe:1.5,artisan:1.5},activeEffects:{approval:{worker:12,peasant:8},stability:.08},unsatisfiedPenalty:{approval:{worker:-4}}},anarchism:{name:"无政府主义",spectrum:"left",icon:"CircleSlash",color:"text-gray-500",unlockEpoch:6,historicalRef:"巴枯宁、克鲁泡特金",description:"废除一切权威",issues:["liberty","revolution"],conditionTypes:["stability_below","stratum_approval_below"],preferredStrata:["worker","artisan","peasant"],stratumWeights:{worker:2,artisan:2},activeEffects:{needsReduction:.15},unsatisfiedPenalty:{stability:-.06}},nationalism:{name:"民族主义",spectrum:"right",icon:"Flag",color:"text-orange-500",unlockEpoch:6,historicalRef:"俨斯麦统一德国",description:"民族国家至上",issues:["nation","military"],conditionTypes:["at_war","stratum_approval_above"],preferredStrata:["soldier","official","landowner"],stratumWeights:{soldier:2.5,official:1.5},activeEffects:{militaryBonus:.22,approval:{soldier:12}},unsatisfiedPenalty:{}},neoliberalism:{name:"新自由主义",spectrum:"right",icon:"TrendingUp",color:"text-emerald-400",unlockEpoch:6,historicalRef:"哈耶克、弗里德曼",description:"市场万能",issues:["free_market","privatization"],conditionTypes:["stratum_income_above","avg_tax_below","resource_price_above","inflation_above"],preferredStrata:["capitalist","merchant"],stratumWeights:{capitalist:4,merchant:2},activeEffects:{incomePercentBonus:.18,tradeBonus:.12},unsatisfiedPenalty:{approval:{capitalist:-6}}},technocracy:{name:"技术官僚主义",spectrum:"center",icon:"Cpu",color:"text-sky-400",unlockEpoch:6,historicalRef:"圣西门、专家治国",description:"让专家决策",issues:["efficiency","progress"],conditionTypes:["epoch_at_least","stratum_influence_above"],preferredStrata:["engineer","scribe","official"],stratumWeights:{engineer:3,scribe:2},activeEffects:{researchSpeed:.22,industryBonus:.12,productionInputCost:{printing_house:-.28,factory:-.22,steel_foundry:-.15}},unsatisfiedPenalty:{}},digital_democracy:{name:"数字民主",spectrum:"center",icon:"Monitor",color:"text-cyan-300",unlockEpoch:7,historicalRef:"电子政务、区块链投票",description:"网络参与决策",issues:["liberty","progress"],conditionTypes:["coalition_size_above","stability_above","legitimacy_above"],preferredStrata:["engineer","scribe","worker"],stratumWeights:{engineer:2,scribe:2,worker:1.5},activeEffects:{legitimacyBonus:.18,stability:.12},unsatisfiedPenalty:{}},eco_socialism:{name:"生态社会主义",spectrum:"left",icon:"Leaf",color:"text-green-500",unlockEpoch:7,historicalRef:"绿色新政",description:"环境公正",issues:["equality","nature"],conditionTypes:["stratum_approval_above","stability_above"],preferredStrata:["worker","peasant","engineer"],stratumWeights:{worker:2,peasant:2,engineer:1.5},activeEffects:{needsReduction:.15,stability:.08},unsatisfiedPenalty:{}},transhumanism:{name:"超人类主义",spectrum:"right",icon:"Zap",color:"text-violet-400",unlockEpoch:7,historicalRef:"技术奇点",description:"超越人类极限",issues:["progress","efficiency"],conditionTypes:["epoch_at_least","stratum_income_above"],preferredStrata:["engineer","capitalist"],stratumWeights:{engineer:4,capitalist:2},activeEffects:{researchSpeed:.28,populationGrowth:.08},unsatisfiedPenalty:{}}},br={};Object.entries(Ec).forEach(([e,t])=>{br[e]={id:e,...t,triggerCondition:()=>!1,conditionText:"条件待生成"}});function Mr(e,t,o){return!o||o.length===0?!1:o.every(i=>{const r=xc[i.typeId];return r?r.check(i.params,t):!1})}const Wn={INITIAL_MIN:50,MAX:100,MIN:0,COUP_THRESHOLD:25,DAILY_CHANGES:{stanceSatisfied:.4,stanceUnsatisfied:-.3,financialSatisfied:.3,financialUncomfortable:-.1,financialStruggling:-.2,financialDesperate:-.25,stabilityHigh:.2,stabilityLow:-.1,salaryPaid:.15,salaryUnpaid:-.3}},Di=(e,t,o=[])=>{const i=Oe[e];return!(!i||i.unlockTech&&!o.includes(i.unlockTech)||typeof i.unlockEpoch=="number"&&i.unlockEpoch>t)},vr=e=>{var t;return((t=Oe[e])==null?void 0:t.basePrice)||1},wr=(e,t,o=0)=>{var D,P,T,I;if(!t)return vr(e);const i=vr(e),r=(T=(P=(D=t==null?void 0:t.economyTraits)==null?void 0:D.resourceBias)==null?void 0:P[e])!=null?T:1,a=((I=t.inventory)==null?void 0:I[e])||0,s=Math.round(500*Math.pow(r,1.2)),u=Math.max(.8,Math.min(1.5,(t.wealth||1e3)/1e3)),c=t.epoch||0,f=1+c*.5+Math.pow(c,1.3)*.1,p=s*u*f,d=p>0?a/p:1,M=Math.max(0,1-d),h=Math.max(0,d-1),y=1+Math.min(2.5,M*.9),x=1-Math.min(.95,h*.6),m=y*x,v=1+(Math.max(.6,Math.min(1.6,r))-1)*.25,g=t.foreignWars?Object.values(t.foreignWars).filter(V=>V==null?void 0:V.isAtWar).length:0,_=(t.isAtWar?1:0)+g,A=_>0?1+Math.min(.75,_*.15):1;let k=i*v*m*A;return k=Math.max(i*.25,Math.min(i*4,k)),Math.max(.5,parseFloat(k.toFixed(2)))},Cc=(e="")=>e?e.split("").reduce((t,o)=>t+o.charCodeAt(0),0):0,Wi=(e,t={},o=0)=>{var _,A,k,D;const i=(k=(A=(_=t==null?void 0:t.economyTraits)==null?void 0:_.resourceBias)==null?void 0:A[e])!=null?k:1,r=Math.round(500*Math.pow(i,1.2)),a=Math.max(.8,Math.min(1.5,(t.wealth||1e3)/1e3)),s=t.epoch||0,u=1+s*.5+Math.pow(s,1.3)*.1,c=r*a*u,f=typeof t.marketVolatility=="number"?t.marketVolatility:.3,p=((D=t==null?void 0:t.inventory)==null?void 0:D[e])||0,d=Cc(e),M=Math.sin(o*.015+d),h=c*(1+M*f),y=i>1?.3:i<1?1.5:.8,x=i>1?.4:i<1?2:1.2,m=h*y,E=h*x,v=Math.max(0,m-p),g=Math.max(0,p-E);return{isShortage:v>0,isSurplus:g>0,shortageAmount:v,surplusAmount:g,target:h}},Bi={DESTITUTE:{level:"赤贫",icon:"Skull",color:"text-gray-400",bgColor:"bg-gray-900/30",borderColor:"border-gray-500/30",approvalCap:30},POOR:{level:"贫困",icon:"AlertTriangle",color:"text-red-400",bgColor:"bg-red-900/20",borderColor:"border-red-500/30",approvalCap:50},SUBSISTENCE:{level:"温饱",icon:"UtensilsCrossed",color:"text-yellow-400",bgColor:"bg-yellow-900/20",borderColor:"border-yellow-500/30",approvalCap:70},COMFORTABLE:{level:"小康",icon:"Home",color:"text-green-400",bgColor:"bg-green-900/20",borderColor:"border-green-500/30",approvalCap:85},PROSPEROUS:{level:"富裕",icon:"Gem",color:"text-blue-400",bgColor:"bg-blue-900/20",borderColor:"border-blue-500/30",approvalCap:95},LUXURIOUS:{level:"奢华",icon:"Crown",color:"text-purple-400",bgColor:"bg-purple-900/20",borderColor:"border-purple-500/30",approvalCap:100}};function _c(e,t,o=0,i=100){if(t<=0){const a=i>0?o/i:0;return a<.5?a*20:a<1?10+(a-.5)*30:a<2?25+(a-1)*10:Math.min(50,35+(a-2)*5)}const r=(e-t)/t;return r>=1?50:r>=0?25+r*25:r>=-1?Math.max(0,25+r*25):0}function Tc(e,t,o=30,i=100){if(t<=0){const a=i>0?e/i:0;return a<.5?a*10:a<1?5+(a-.5)*10:Math.min(20,10+(a-1)*5)}const r=e/t;return Math.min(20,r/o*20)}function Pc(e){return e<20?Bi.DESTITUTE:e<40?Bi.POOR:e<55?Bi.SUBSISTENCE:e<70?Bi.COMFORTABLE:e<85?Bi.PROSPEROUS:Bi.LUXURIOUS}function Zi(e,t=1,o=1,i=6,r=!1){const a=Math.max(e,t*.3);let s;a<=0?s=.3:a<1?s=.3+a*.7:r?s=1+(a-1)*.8:s=1+Math.log(a)*.5;let u;s<=1?u=s*(.7+.3*Math.min(1.2,o)):u=1+(s-1)*o;let c;t<.3?c=.5:t<1?c=.5+(t-.3)*(.5/.7):t<2?c=1:r?c=1+(t-2)*.05*o:c=1+Math.min(.15,(t-2)*.025*o);let f=u*c;return t<.5?f=Math.min(f,.8):t<1?f=Math.min(f,1):t<2&&(f=Math.min(f,1.2)),Math.max(.3,Math.min(i,f))}function Ac({consumptionMultiplier:e=1,incomeRatio:t=null,wealthRatio:o=null,livingStandardLevel:i=null}={}){var M;const r=(h,y,x)=>Math.min(x,Math.max(y,h)),a=Number.isFinite(e)?Math.max(.3,e):1,s=Number.isFinite(t)?r(.4+.6*Math.min(1.5,t),.3,1.2):1,u=Number.isFinite(o)?r(.4+.6*Math.min(2,o)/2,.3,1.2):1,c=.6+.4*((s+u)/2),p=i&&(M={赤贫:.05,贫困:.15,温饱:.4,小康:.9,富裕:1.1,奢华:1.25}[i])!=null?M:1,d=a*p*c;return r(d,.05,1.6)}function Rc(e,t=1,o=1,i=null){if(e<1&&t<2)return 0;const r=Math.max(e,t*.5);let a;r<=0?a=.3:r<1?a=.3+r*.7:a=1+Math.log(r)*.7;const s=(o+1)/2;let u;a<=1?u=a*(.8+.2*Math.min(1.2,s)):u=1+(a-1)*s;let c;t<.3?c=.5:t<1?c=.5+(t-.3)*(.5/.7):t<2?c=1:c=1+Math.min(.25,(t-2)*.03);const f=u*c;let p=Math.max(.3,Math.min(10,f));if(!i)return p;const M={赤贫:0,贫困:0,温饱:1.49,小康:3,富裕:6,奢华:10}[i];return t<1&&(p=Math.min(p,.99)),M===void 0?p:Math.min(M,p)}function Sc(e,t,o,i=1,r=100){const a=t*30;let s=e+a+o,u=0;r>0&&(u=Math.min(60,.7*Math.sqrt(r)));let c=0;i>0&&(c=Math.min(40,40*(1-Math.exp(-i*.5))));const f=u+c;return s*.5+f*.5}function Ic({count:e,income:t=0,expense:o=0,wealthValue:i=0,startingWealth:r=100,essentialCost:a=0,shortagesCount:s=0,effectiveNeedsCount:u=0,unlockedLuxuryTiers:c=0,totalLuxuryTiers:f=0,previousScore:p=null,isNewStratum:d=!1,maxConsumptionMultiplier:M=6,wealthElasticity:h=1,greedy:y=!1}){if(e<=0)return null;const x=t/e,m=o/e,E=i/e,v=a/e,g=_c(x,v,E,r);let _;if(u>0)_=Math.max(0,(u-s)/u);else{const j=r>0?E/r:0;_=Math.min(1,j)}const A=Tc(E,m,30,r),k=r>0?E/r:0,D=Sc(g,_,A,k,E),P=d?1:.15,T=p!==null?p*(1-P)+D*P:D,I=Pc(T),V=v>0?x/v:x>0?10:0,N=Zi(V,k,h,M,y),L=f>0?c/f:0;return{score:T,targetScore:D,incomeAdequacyScore:g,satisfactionRate:_,financialSecurityScore:A,incomePerCapita:x,expensePerCapita:m,wealthPerCapita:E,wealthMultiplier:N,wealthRatio:k,luxuryUnlockRatio:L,unlockedLuxuryTiers:c,totalLuxuryTiers:f,level:I.level,icon:I.icon,color:I.color,bgColor:I.bgColor,borderColor:I.borderColor,approvalCap:I.approvalCap}}function kc(e){return e<.5?{icon:"Skull",color:"text-gray-400",level:"赤贫",approvalCap:30}:e<1?{icon:"AlertTriangle",color:"text-red-400",level:"贫困",approvalCap:50}:e<1.5?{icon:"UtensilsCrossed",color:"text-yellow-400",level:"温饱",approvalCap:70}:e<2.5?{icon:"Home",color:"text-green-400",level:"小康",approvalCap:85}:e<4?{icon:"Gem",color:"text-blue-400",level:"富裕",approvalCap:95}:{icon:"Crown",color:"text-purple-400",level:"奢华",approvalCap:100}}tr.reduce((e,t)=>(e[t.id]=t,e),{});const zt=["official","cleric","capitalist","landowner","knight","engineer","navigator","merchant","soldier","scribe","worker","artisan","miner","lumberjack","serf","peasant"],Dc=.0025,Wc=.2,Bc=.25,Oc=1e-4,jc=1.5,Nc=2,Lc=1.5,Fc=.8,xr=5,Uc=.5,Er=["food","cloth"],Oi=1e-4,Bn=1,$c=new Set(["science","culture"]),Gc=45,qc=30,Vc=.003,Hc=.001,On=20,Yc=.4,Cr=200,zc=.05,wa=3,Xc=30,So={unemployed:0,serf:0,peasant:1,lumberjack:1,miner:1,worker:1,artisan:2,soldier:2,navigator:2,scribe:2,merchant:2,cleric:2,official:3,landowner:3,capitalist:3,knight:3,engineer:3},Jc={0:0,1:0,2:.5,3:.4},Zc={landowner:.35,capitalist:.35,soldier:0},Qc=2,Kc=.2,$t=(e,t,o)=>!Number.isFinite(e)||e<t?t:e>o?o:e,e0=1e12,Qi=(e,t=0)=>Number.isFinite(e)?Math.max(0,Math.min(e,e0)):t,Qt=e=>{if(e==="silver")return!1;const t=Oe[e];return t?$c.has(e)?!0:!t.type||t.type!=="virtual":!1},Io=e=>{if(e==="silver")return 1;const t=Oe[e];return(t==null?void 0:t.basePrice)||1},xa=(e={},t=1)=>{if(!e||typeof e!="object")return{};const o={};return Object.entries(e).forEach(([i,r])=>{typeof r=="number"?o[i]=r*t:r&&typeof r=="object"&&!Array.isArray(r)?o[i]=xa(r,t):o[i]=r}),o},t0=(e,t)=>{if(!e||!t)return{adjustments:{},approvalPenalties:{},adminCost:0};const o=Object.values(e).reduce((s,u)=>s+u,0),i={},r={};let a=0;return Object.entries(t).forEach(([s,u])=>{const c=e[s]||0,f=o>0?c/o*100:0,p=u-f;Math.abs(p)>1&&(i[s]=p*.1,p<-5&&(r[s]=Math.floor(p/2)),a+=Math.abs(p)*.5)}),{adjustments:i,approvalPenalties:r,adminCost:Math.round(a)}},o0=1,Ki=(e,t={},o={})=>{var y,x,m,E;if(!e)return{profit:0,outputValue:0,inputValue:0,wageCost:0,businessTax:0};const i=(t==null?void 0:t.prices)||{},r=(t==null?void 0:t.wages)||{},a=v=>{var g;return!v||v==="silver"?1:(g=i[v])!=null?g:1},s=Object.entries(e.output||{}).reduce((v,[g,_])=>v+a(g)*_,0),u=Object.entries(e.input||{}).reduce((v,[g,_])=>v+a(g)*_,0),c=(x=(y=o==null?void 0:o.businessTaxRates)==null?void 0:y[e.id])!=null?x:1,p=((m=e.businessTaxBase)!=null?m:.1)*c,d=e.owner;let M=0;for(const[v,g]of Object.entries(e.jobs||{})){if(v===d)continue;const _=(E=r[v])!=null?E:.1;M+=_*g}return{profit:s-u-p-M,outputValue:s,inputValue:u,wageCost:M,businessTax:p}},i0=(e,t,o,i,r,a={},s={},u={})=>{var E;if(!e||!t)return{canExpand:!1,reason:"无效建筑",cost:0,profit:0,roi:0};const c=i==null?void 0:i[e.id];if(!(c!=null&&c.allowed))return{canExpand:!1,reason:"未允许扩张",cost:0,profit:0,roi:0};const f=(a==null?void 0:a.prices)||{},p=e.baseCost||{};let d=0;for(const[v,g]of Object.entries(p)){const _=(E=f[v])!=null?E:1;d+=g*_}d=d>0?Math.round(d):100;const h=Ki(e,a,s).profit,y=d>0?h/d:0,x=u==null?void 0:u[e.id];return(Number.isFinite(x)?x:1)<o0?{canExpand:!1,reason:"岗位未满",cost:d,profit:h,roi:y}:h<=0?{canExpand:!1,reason:"建筑不盈利",cost:d,profit:h,roi:y}:o<d?{canExpand:!1,reason:"业主财富不足",cost:d,profit:h,roi:y}:{canExpand:!0,reason:null,cost:d,profit:h,roi:y}},n0=(e,t,o,i,r={},a={},s={})=>{const u=[],c={};if(!e||!t||!o)return console.log("[FREE MARKET] processOwnerExpansions early return:",{hasBuildings:!!e,hasClassWealth:!!t,hasExpansionSettings:!!o}),{expansions:u,wealthDeductions:c};const f=[],p={},d=[];for(const M of e){if(!M.owner)continue;const h=M.owner,y=t[h]||0,x=i[M.id]||0,{canExpand:m,reason:E,cost:v,profit:g,roi:_}=i0(M,h,y,o,x,r,a,s);if(m){const A=v>0?Math.max(.01,g*g/v):.01,k={buildingId:M.id,owner:h,cost:v,profit:g,roi:_,weight:A};f.push(k),p[h]||(p[h]=[]),p[h].push(k)}else d.push({buildingId:M.id,owner:h,ownerWealth:y,reason:E,cost:v,profit:g,roi:_,staffingRatio:s==null?void 0:s[M.id],settingsForBuilding:o[M.id]})}if(console.log("[FREE MARKET] processOwnerExpansions:",{totalBuildingsChecked:e.filter(M=>M.owner).length,candidatesFound:f.length,candidates:f.map(M=>({id:M.buildingId,profit:M.profit.toFixed(2),roi:(M.roi*100).toFixed(1)+"%",weight:M.weight.toFixed(2)})),firstFewRejections:d.slice(0,5)}),f.length>0){const M=[];Object.entries(p).forEach(([h,y])=>{if(!y.length)return;const x=e.filter(T=>T.owner===h).reduce((T,I)=>T+(i[I.id]||0),0),m=x%2===0?"roi":"profit",E=[...y].sort((T,I)=>I[m]-T[m]),v=Math.ceil(E.length/3),g=[E.slice(0,v),E.slice(v,v*2),E.slice(v*2)],_=x%3;let A=null;for(let T=0;T<g.length;T+=1){const I=(_+T)%g.length;if(g[I].length>0){A=g[I];break}}if(!A||A.length===0)return;const k=A.reduce((T,I)=>T+I.weight,0);let D=Math.random()*k,P=A[0];for(const T of A)if(D-=T.weight,D<=0){P=T;break}M.push({...P,_debug:{ownerBuildingTotal:x,metric:m,tierIndex:g.indexOf(A),probability:k>0?P.weight/k*100:0}})}),M.length>0&&(console.log("[FREE MARKET] Selected for expansion:",M.map(h=>({buildingId:h.buildingId,owner:h.owner,profit:h.profit.toFixed(2),roi:(h.roi*100).toFixed(1)+"%",weight:h.weight.toFixed(2),metric:h._debug.metric,tierIndex:h._debug.tierIndex,probability:h._debug.probability.toFixed(1)+"%"}))),M.forEach(h=>{u.push(h),c[h.owner]=(c[h.owner]||0)+h.cost}))}return{expansions:u,wealthDeductions:c}},a0=(e,t,o,i)=>{var u;if(!(i!=null&&i.enabled))return{adjustment:0,isIncome:!1,effectivePrice:o};const r=(u=i.governmentSellPrices)==null?void 0:u[e];if(r==null)return{adjustment:0,isIncome:!1,effectivePrice:o};const a=r,s=(r-o)*t;return s>0?{adjustment:s,isIncome:!0,effectivePrice:a}:s<0?{adjustment:Math.abs(s),isIncome:!1,effectivePrice:a}:{adjustment:0,isIncome:!1,effectivePrice:o}},r0=(e,t,o,i)=>{var u;if(!(i!=null&&i.enabled))return{adjustment:0,isIncome:!1,effectivePrice:o};const r=(u=i.governmentBuyPrices)==null?void 0:u[e];if(r==null)return{adjustment:0,isIncome:!1,effectivePrice:o};const a=r;return{adjustment:r*t,isIncome:!1,effectivePrice:a}},_r=({resourceKey:e,amount:t,marketPrice:o,priceControls:i,taxBreakdown:r,resources:a,onTreasuryChange:s,applyTreasuryChange:u})=>{const c=a0(e,t,o,i);if(c.adjustment>0)if(c.isIncome)r.priceControlIncome=(r.priceControlIncome||0)+c.adjustment;else{const f=a.silver||0;if(f>=c.adjustment)typeof u=="function"?u(-c.adjustment,"price_control_buy"):(a.silver=f-c.adjustment,typeof s=="function"&&s(-c.adjustment,"price_control_buy")),r.priceControlExpense=(r.priceControlExpense||0)+c.adjustment;else return{effectivePrice:o,success:!1}}return{effectivePrice:c.effectivePrice,success:!0}},s0=({resourceKey:e,amount:t,marketPrice:o,priceControls:i,taxBreakdown:r,resources:a,onTreasuryChange:s,applyTreasuryChange:u})=>{const c=r0(e,t,o,i);if(c.adjustment>0)if(c.isIncome)r.priceControlIncome=(r.priceControlIncome||0)+c.adjustment;else{const f=a.silver||0;if(f>=c.adjustment)typeof u=="function"?u(-c.adjustment,"price_control_sell"):(a.silver=f-c.adjustment,typeof s=="function"&&s(-c.adjustment,"price_control_sell")),r.priceControlExpense=(r.priceControlExpense||0)+c.adjustment;else return{effectivePrice:o,success:!1}}return{effectivePrice:c.effectivePrice,success:!0}},xo={VERY_EASY:"very_easy",EASY:"easy",NORMAL:"normal",HARD:"hard",VERY_HARD:"very_hard",EXTREME:"extreme"},Ea=xo.EASY,Tr={[xo.VERY_EASY]:{id:xo.VERY_EASY,name:"和平",description:"极其轻松，专注于建设，几乎没有战争威胁",icon:"🕊️",organizationGrowthMultiplier:.2,organizationDecayMultiplier:2,satisfactionThreshold:25,buildingCostGrowthFactor:1.05,aiWarDeclarationChance:.1,aiMilitaryActionChance:.2,aiMilitaryCooldownBonus:30,aiMinWarEpoch:4,raidDamageMultiplier:.3,raidPopulationLossMultiplier:.2,stabilityDampeningBonus:.25,newGameGracePeriod:150,inventoryTargetDaysMultiplier:.5,taxToleranceMultiplier:2,resourceConsumptionMultiplier:.9,buildingCostBaseMultiplier:1,techCostMultiplier:1,populationGrowthMultiplier:1.5,buildingUpgradeCostMultiplier:1,armyMaintenanceMultiplier:.5,maxConsumptionMultiplierBonus:-1,goodRelationChangeMultiplier:1.25,badRelationChangeMultiplier:.75,relationDailyDriftRate:.015,relationMonthlyDriftRateAlly:.04,relationMonthlyDriftRateNonAlly:.12,allyColdEventCooldown:120,allyColdEventChance:.002,initialBuildings:{farm:3,lumber_camp:3,quarry:2,loom_house:2,market:1}},[xo.EASY]:{id:xo.EASY,name:"简单",description:"适合新手，叛乱增长减半，敌人攻击概率降低",icon:"🌱",organizationGrowthMultiplier:.5,organizationDecayMultiplier:1.5,satisfactionThreshold:35,buildingCostGrowthFactor:1.1,aiWarDeclarationChance:.5,aiMilitaryActionChance:.5,aiMilitaryCooldownBonus:15,aiMinWarEpoch:3,raidDamageMultiplier:.6,raidPopulationLossMultiplier:.5,stabilityDampeningBonus:.15,newGameGracePeriod:100,inventoryTargetDaysMultiplier:.7,taxToleranceMultiplier:1.5,resourceConsumptionMultiplier:1,buildingCostBaseMultiplier:1.2,techCostMultiplier:1.2,populationGrowthMultiplier:1.2,buildingUpgradeCostMultiplier:1.2,armyMaintenanceMultiplier:.75,maxConsumptionMultiplierBonus:0,goodRelationChangeMultiplier:1.1,badRelationChangeMultiplier:.9,relationDailyDriftRate:.018,relationMonthlyDriftRateAlly:.045,relationMonthlyDriftRateNonAlly:.16,allyColdEventCooldown:90,allyColdEventChance:.003,initialBuildings:{farm:2,lumber_camp:2,quarry:1,loom_house:1}},[xo.NORMAL]:{id:xo.NORMAL,name:"普通",description:"标准游戏体验",icon:"⚖️",organizationGrowthMultiplier:1,organizationDecayMultiplier:1,satisfactionThreshold:45,buildingCostGrowthFactor:1.15,aiWarDeclarationChance:1,aiMilitaryActionChance:1,aiMilitaryCooldownBonus:0,aiMinWarEpoch:2,raidDamageMultiplier:1,raidPopulationLossMultiplier:1,stabilityDampeningBonus:0,newGameGracePeriod:0,inventoryTargetDaysMultiplier:1,taxToleranceMultiplier:1,resourceConsumptionMultiplier:1,buildingCostBaseMultiplier:1.5,techCostMultiplier:1.5,populationGrowthMultiplier:1,buildingUpgradeCostMultiplier:1.5,armyMaintenanceMultiplier:1,maxConsumptionMultiplierBonus:0,goodRelationChangeMultiplier:1,badRelationChangeMultiplier:1,relationDailyDriftRate:.02,relationMonthlyDriftRateAlly:.05,relationMonthlyDriftRateNonAlly:.2,allyColdEventCooldown:60,allyColdEventChance:.004,initialBuildings:{farm:1,lumber_camp:1,loom_house:1}},[xo.HARD]:{id:xo.HARD,name:"困难",description:"高难度挑战，叛乱更频繁，敌人更具侵略性",icon:"🔥",organizationGrowthMultiplier:1.5,organizationDecayMultiplier:.5,satisfactionThreshold:60,buildingCostGrowthFactor:1.25,aiWarDeclarationChance:2,aiMilitaryActionChance:1.5,aiMilitaryCooldownBonus:-5,aiMinWarEpoch:1,raidDamageMultiplier:1.5,raidPopulationLossMultiplier:1.5,stabilityDampeningBonus:-.1,newGameGracePeriod:0,inventoryTargetDaysMultiplier:3,taxToleranceMultiplier:.7,resourceConsumptionMultiplier:3,buildingCostBaseMultiplier:3,techCostMultiplier:3,startingSilverMultiplier:4,populationGrowthMultiplier:.8,buildingUpgradeCostMultiplier:3,armyMaintenanceMultiplier:1.5,maxConsumptionMultiplierBonus:2,goodRelationChangeMultiplier:.75,badRelationChangeMultiplier:1.25,relationDailyDriftRate:.03,relationMonthlyDriftRateAlly:.08,relationMonthlyDriftRateNonAlly:.35,allyColdEventCooldown:45,allyColdEventChance:.005,initialBuildings:{farm:1,lumber_camp:1}},[xo.VERY_HARD]:{id:xo.VERY_HARD,name:"灾厄",description:"极高难度，内忧外患接踵而至，生存即是胜利",icon:"☠️",organizationGrowthMultiplier:2,organizationDecayMultiplier:.2,satisfactionThreshold:75,buildingCostGrowthFactor:1.3,aiWarDeclarationChance:3.5,aiMilitaryActionChance:2.5,aiMilitaryCooldownBonus:-10,aiMinWarEpoch:0,raidDamageMultiplier:2.5,raidPopulationLossMultiplier:2.5,stabilityDampeningBonus:-.2,newGameGracePeriod:0,inventoryTargetDaysMultiplier:8,taxToleranceMultiplier:.4,resourceConsumptionMultiplier:5,buildingCostBaseMultiplier:5,techCostMultiplier:6,startingSilverMultiplier:6,populationGrowthMultiplier:.5,buildingUpgradeCostMultiplier:5,armyMaintenanceMultiplier:2,maxConsumptionMultiplierBonus:4,goodRelationChangeMultiplier:.6,badRelationChangeMultiplier:1.6,relationDailyDriftRate:.04,relationMonthlyDriftRateAlly:.1,relationMonthlyDriftRateNonAlly:.5,allyColdEventCooldown:60,allyColdEventChance:.004,initialBuildings:{farm:1}},[xo.EXTREME]:{id:xo.EXTREME,name:"地狱",description:"绝望的深渊，只有最完美的策略才能存活",icon:"👿",organizationGrowthMultiplier:3,organizationDecayMultiplier:.05,satisfactionThreshold:80,buildingCostGrowthFactor:1.4,aiWarDeclarationChance:5,aiMilitaryActionChance:5,aiMilitaryCooldownBonus:-20,aiMinWarEpoch:0,raidDamageMultiplier:5,raidPopulationLossMultiplier:5,stabilityDampeningBonus:-.5,newGameGracePeriod:0,inventoryTargetDaysMultiplier:20,taxToleranceMultiplier:.2,resourceConsumptionMultiplier:8,buildingCostBaseMultiplier:10,techCostMultiplier:10,startingSilverMultiplier:10,populationGrowthMultiplier:.2,buildingUpgradeCostMultiplier:10,armyMaintenanceMultiplier:3,maxConsumptionMultiplierBonus:8,goodRelationChangeMultiplier:.45,badRelationChangeMultiplier:2,relationDailyDriftRate:.05,relationMonthlyDriftRateAlly:.12,relationMonthlyDriftRateNonAlly:.7,allyColdEventCooldown:90,allyColdEventChance:.003,initialBuildings:{loom_house:1}}};function ao(e){return Tr[e]||Tr[Ea]}function Pr(e,t){const o=ao(t);return e*o.aiWarDeclarationChance}function c0(e,t){const o=ao(t);return e*o.aiMilitaryActionChance}function l0(e){return ao(e).aiMinWarEpoch}function u0(e){return ao(e).aiMilitaryCooldownBonus}function ji(e,t){const o=ao(t);return Math.floor(e*o.raidDamageMultiplier)}function Ar(e,t){const o=ao(t);return Math.floor(e*o.raidPopulationLossMultiplier)}function Rr(e,t){const o=ao(t);return e<o.newGameGracePeriod}function Sr(e){return ao(e).buildingCostGrowthFactor||1.15}function f0(e){return ao(e).inventoryTargetDaysMultiplier||1}function Ir(e){var o,i;const t=ao(e);return{good:(o=t.goodRelationChangeMultiplier)!=null?o:1,bad:(i=t.badRelationChangeMultiplier)!=null?i:1}}function d0(e){var o;return(o=ao(e).relationDailyDriftRate)!=null?o:.02}function p0(e){var o;return(o=ao(e).allyColdEventCooldown)!=null?o:60}function h0(e){var o;return(o=ao(e).allyColdEventChance)!=null?o:.004}function m0(e){return ao(e).populationGrowthMultiplier||1}function g0(e){return ao(e).armyMaintenanceMultiplier||1}function kr(e){return ao(e).maxConsumptionMultiplierBonus||0}const y0=({popStructure:e,wealth:t,classIncome:o,classExpense:i,classShortages:r,epoch:a,techsUnlocked:s,priceMap:u={},livingStandardStreaks:c={}})=>{const f={},p={};return Object.keys(ae).forEach(d=>{var de,Y,Re,Qe;const M=e[d]||0;if(M===0){f[d]=null,p[d]={streak:0,level:null,score:null};return}const h=ae[d],y=t[d]||0,x=(o==null?void 0:o[d])||0,m=(i==null?void 0:i[d])||0,E=h.startingWealth||100,v=(r[d]||[]).length,g=h.needs||{};let _=0;const A=["food","cloth"],k=Le=>typeof u=="function"?u(Le)||Io(Le):u[Le]||Io(Le);A.forEach(Le=>{if(g[Le]&&Di(Le,a,s)){const _t=g[Le]*M,K=k(Le),_e=Io(Le),fe=Math.max(K,_e);_+=_t*fe}});const D=h.luxuryNeeds||{},P=Object.keys(D).map(Number).sort((Le,_t)=>Le-_t),T=h.wealthElasticity||1,I=M>0?x/M:0,V=M>0?_/M:0,N=V>0?I/V:I>0?10:0,L=M>0?y/M:0,W=E>0?L/E:0,j=h.maxConsumptionMultiplier||6;Zi(N,W,T,j);const H=Zi(N,W,T,10),ce=h.needs?Object.keys(h.needs).filter(Le=>Di(Le,a,s)).length:0;let me=0,U=ce;for(const Le of P)if(H>=Le){me++;const _t=D[Le],_e=Object.keys(_t).filter(fe=>Di(fe,a,s)).filter(fe=>{var He;return!((He=h.needs)!=null&&He[fe])});U+=_e.length}const X=(c==null?void 0:c[d])||{},ye=(de=X.score)!=null?de:null,te=ye===null;f[d]=Ic({count:M,income:x,expense:m,wealthValue:y,startingWealth:E,essentialCost:_,shortagesCount:v,effectiveNeedsCount:U,unlockedLuxuryTiers:me,totalLuxuryTiers:P.length,previousScore:ye,isNewStratum:te,maxConsumptionMultiplier:j,wealthElasticity:T,greedy:h.greedy});const le=X.streak||0,we=((Y=f[d])==null?void 0:Y.level)||null,ue=(Qe=(Re=f[d])==null?void 0:Re.score)!=null?Qe:null;let Ie=le;we==="赤贫"||we==="贫困"?Ie=le+1:Ie=Math.max(0,le-1),p[d]={streak:Ie,level:we,score:ue}}),{classLivingStandard:f,livingStandardStreaks:p}},b0={event:!1,gameLoop:!1,mainThread:!1,simulation:!1,trade:!1,demands:!1},Dr=(e=[])=>{const t={};return e.forEach(o=>{const i=String(o||"").trim();i&&(t[i]=!0)}),t},Ca=e=>{if(e==null)return null;if(e===!0)return!0;if(e===!1)return null;if(typeof e=="string"){const t=e.trim();if(!t)return null;if(t==="true"||t==="all")return!0;try{const o=JSON.parse(t);return Ca(o)}catch(o){const i=t.split(",").map(r=>r.trim()).filter(Boolean);return i.length>0?Dr(i):null}}return Array.isArray(e)?Dr(e):typeof e=="object"?e:null};let en=null,Wr;const M0=()=>{const t=(typeof globalThis!="undefined"?globalThis:{}).__CIV_DEBUG__;if(t!==Wr&&(Wr=t,en=null),en)return en;let o=Ca(t);if(!o&&typeof localStorage!="undefined")try{o=Ca(localStorage.getItem("civ_debug_flags"))}catch(i){o=null}return en=o||b0,en},v0=e=>{const t=M0();return t===!0?!0:!!(t!=null&&t[e])},tn=(e,...t)=>{v0(e)&&console.log(...t)},w0={trade_agreement:{name:"贸易协定",tariffMultiplier:.85,extraMerchantSlotsPercent:.2,tradeEfficiencyBonus:.08,relationDecayReduction:.1},open_market:{name:"开放市场",tariffMultiplier:.9,extraMerchantSlots:1/0,tradeEfficiencyBonus:0,allowForceTrade:!0,bypassRelationCap:!0},free_trade:{name:"自由贸易协定",tariffMultiplier:0,extraMerchantSlotsPercent:.5,relationDecayReduction:.3},investment_pact:{name:"投资协议",tariffMultiplier:.9,extraMerchantSlots:1,overseasBuildingAccess:!0,profitRepatriationRate:1},non_aggression:{name:"互不侵犯条约",tariffMultiplier:1,extraMerchantSlots:0,relationDecayReduction:.5},peace_treaty:{name:"和平条约",tariffMultiplier:1,extraMerchantSlots:0},academic_exchange:{name:"学术交流",tariffMultiplier:1,extraMerchantSlots:0,techBonus:.05},defensive_pact:{name:"共同防御",tariffMultiplier:.9,extraMerchantSlots:1,mutualDefense:!0},military_alliance:{name:"军事同盟",tariffMultiplier:.85,extraMerchantSlots:2,mutualDefense:!0,relationDecayReduction:.8},economic_bloc:{name:"经济共同体",tariffMultiplier:.6,extraMerchantSlots:5,tradeEfficiencyBonus:.4,overseasBuildingAccess:!0}},x0=(e,t)=>!(e!=null&&e.treaties)||!Array.isArray(e.treaties)?[]:e.treaties.filter(o=>o&&(!Number.isFinite(o.endDay)||t<o.endDay)),_a=(e,t)=>{const o=x0(e,t),i={tariffMultiplier:1,extraMerchantSlots:0,extraMerchantSlotsPercent:0,tradeEfficiencyBonus:0,hasOverseasAccess:!1,hasMutualDefense:!1,relationDecayReduction:0,techBonus:0,hasPriceConvergence:!1,allowForceTrade:!1,bypassRelationCap:!1,activeTreatyTypes:[]};if(o.length===0)return i;i.activeTreatyTypes=o.map(r=>r.type);for(const r of o){const a=w0[r.type];a&&(a.tariffMultiplier!==void 0&&(i.tariffMultiplier=Math.min(i.tariffMultiplier,a.tariffMultiplier)),a.extraMerchantSlots!==void 0&&(a.extraMerchantSlots===1/0?i.extraMerchantSlots=1/0:i.extraMerchantSlots!==1/0&&(i.extraMerchantSlots+=a.extraMerchantSlots)),a.extraMerchantSlotsPercent!==void 0&&(i.extraMerchantSlotsPercent+=a.extraMerchantSlotsPercent),a.tradeEfficiencyBonus!==void 0&&(i.tradeEfficiencyBonus=Math.max(i.tradeEfficiencyBonus,a.tradeEfficiencyBonus)),a.overseasBuildingAccess&&(i.hasOverseasAccess=!0),a.mutualDefense&&(i.hasMutualDefense=!0),a.priceConvergence&&(i.hasPriceConvergence=!0),a.allowForceTrade&&(i.allowForceTrade=!0),a.bypassRelationCap&&(i.bypassRelationCap=!0),a.relationDecayReduction!==void 0&&(i.relationDecayReduction=Math.max(i.relationDecayReduction,a.relationDecayReduction)),a.techBonus!==void 0&&(i.techBonus+=a.techBonus))}return i},Br={DAILY_CONVERGENCE_RATE:.05,MIN_PRICE_DIFF_RATIO:.1};function E0(e,t,o=Br.DAILY_CONVERGENCE_RATE){if(!e||!t)return{playerPrice:e,nationPrice:t,changed:!1};const i=(e+t)/2,r=i*Br.MIN_PRICE_DIFF_RATIO;if(Math.abs(e-t)<=r)return{playerPrice:e,nationPrice:t,changed:!1};const s=e+(i-e)*o,u=t+(i-t)*o;return{playerPrice:Math.round(s*100)/100,nationPrice:Math.round(u*100)/100,changed:!0,convergenceAmount:Math.abs(s-e)}}function C0(e,t,o){const i={...e},r=[],a=[],s=t.filter(c=>!c||c.isPlayer?!1:_a(c,o).hasPriceConvergence);if(s.length===0)return{marketPrices:i,nationPriceUpdates:r,logs:a};const u=Object.keys(e);for(const c of s){const f=c.nationPrices||{},p={...f};let d=!1;for(const M of u){const h=i[M],y=f[M];if(!h||!y)continue;const x=E0(h,y);x.changed&&(i[M]=x.playerPrice,p[M]=x.nationPrice,d=!0)}d&&r.push({nationId:c.id,nationPrices:p})}if(r.length>0&&o%10===0){const c=s.slice(0,3).map(p=>p.name).join("、"),f=s.length>3?`等${s.length}国`:"";a.push(`📊 自由贸易效应：与${c}${f}的市场价格正在趋同。`)}return{marketPrices:i,nationPriceUpdates:r,logs:a}}const Ta=[{name:"封建地主专制",priority:1e3,description:"由大地主阶级独揽政权",icon:"Castle",color:"text-amber-500",conditions:{exactCoalition:["landowner"]},effects:{categories:{gather:.15},buildingProductionMod:{farm:.2,large_estate:.2},resourceDemandMod:{food:-.1}}},{name:"垄断资本独裁",priority:1e3,description:"资本家独占国家权力",icon:"Briefcase",color:"text-blue-400",conditions:{exactCoalition:["capitalist"]},effects:{industry:.2,buildingProductionMod:{factory:.25,steel_works:.2},taxIncome:.15}},{name:"军事贵族专政",priority:1e3,description:"骑士阶层掌控一切",icon:"Shield",color:"text-red-500",conditions:{exactCoalition:["knight"]},effects:{militaryBonus:.25,buildingProductionMod:{barracks:.2,training_ground:.2},stability:.05}},{name:"官僚集权",priority:1e3,description:"官僚阶层垄断政权",icon:"ScrollText",color:"text-purple-400",conditions:{exactCoalition:["official"]},effects:{production:.1,taxIncome:.12,cultureBonus:.08,officialCapacity:5}},{name:"商业寡头政治",priority:1e3,description:"商人阶层掌控国家",icon:"Coins",color:"text-yellow-400",conditions:{exactCoalition:["merchant"]},effects:{buildingProductionMod:{market:.25,trade_port:.2,trading_post:.15},taxIncome:.15}},{name:"神权政治",priority:1e3,description:"神职人员统治国家",icon:"Cross",color:"text-indigo-400",conditions:{exactCoalition:["cleric"]},effects:{cultureBonus:.25,stability:.1,scienceBonus:-.15}},{name:"军人专政",priority:1e3,description:"军队独揽大权",icon:"Swords",color:"text-red-400",conditions:{exactCoalition:["soldier"]},effects:{militaryBonus:.3,buildingProductionMod:{barracks:.25,fortress:.2},stability:-.05}},{name:"工人无产阶级专政",priority:1e3,description:"工人阶级独揽政权",icon:"Hammer",color:"text-red-600",conditions:{exactCoalition:["worker"]},effects:{industry:.18,stratumDemandMod:{worker:-.12},taxIncome:-.1}},{name:"农民专政",priority:1e3,description:"农民阶级掌控政权",icon:"Wheat",color:"text-green-500",conditions:{exactCoalition:["peasant"]},effects:{categories:{gather:.2},buildingProductionMod:{farm:.18},resourceDemandMod:{food:-.1}}},{name:"技术官僚政治",priority:1e3,description:"工程师主导国家",icon:"Cog",color:"text-cyan-400",conditions:{exactCoalition:["engineer"]},effects:{scienceBonus:.25,industry:.12,buildingProductionMod:{library:.2,university:.25},officialCapacity:4}},{name:"学者治国",priority:1e3,description:"知识分子掌权",icon:"Feather",color:"text-blue-300",conditions:{exactCoalition:["scribe"]},effects:{scienceBonus:.2,cultureBonus:.15,militaryBonus:-.1}},{name:"行会共和",priority:1e3,description:"工匠行会主政",icon:"Anvil",color:"text-orange-400",conditions:{exactCoalition:["artisan"]},effects:{buildingProductionMod:{loom_house:.25,furniture_workshop:.2,tailor_workshop:.15},industry:.15}},{name:"海上共和国",priority:1e3,description:"航海家主导政权",icon:"Compass",color:"text-teal-400",conditions:{exactCoalition:["navigator"]},effects:{buildingProductionMod:{dockyard:.3,trade_port:.25},taxIncome:.1}},{name:"矿业工人政权",priority:1e3,description:"矿工阶级执政",icon:"Pickaxe",color:"text-gray-400",conditions:{exactCoalition:["miner"]},effects:{buildingProductionMod:{mine:.3,quarry:.25},categories:{gather:.15}}},{name:"农奴起义政权",priority:1e3,description:"佃农阶级执政",icon:"Users",color:"text-brown-400",conditions:{exactCoalition:["serf"]},effects:{categories:{gather:.12},stratumDemandMod:{serf:-.1},stability:-.1}},{name:"林业工人政权",priority:1e3,description:"樵夫阶级执政",icon:"Trees",color:"text-green-600",conditions:{exactCoalition:["lumberjack"]},effects:{buildingProductionMod:{lumber_camp:.3},categories:{gather:.12}}},{name:"独裁政体",priority:999,description:"单一阶层执政",icon:"Crown",color:"text-amber-400",conditions:{maxSize:1},effects:{stability:-.05,taxIncome:.05,officialCapacity:2}},{name:"工农联合政府",priority:910,description:"工人和农民阶级联合执政",icon:"Handshake",color:"text-red-500",conditions:{includes:["worker","peasant"],minCategoryShare:{proletariat:.7},maxSize:2},effects:{categories:{gather:.12},industry:.1,stratumDemandMod:{peasant:-.08,worker:-.08}}},{name:"人民民主专政",priority:900,description:"以工农联盟为基础的人民政权",icon:"Users",color:"text-red-600",conditions:{includes:["worker","peasant"],minCategoryShare:{proletariat:.7}},effects:{categories:{gather:.1},industry:.12,stratumDemandMod:{peasant:-.15,worker:-.15},taxIncome:-.15}},{name:"资产阶级共和国",priority:900,description:"资产阶级主导的民主政体",icon:"Building2",color:"text-blue-400",conditions:{minCategoryShare:{bourgeoisie:.6},excludes:["landowner","knight"],includesAny:["worker","artisan"]},effects:{industry:.15,taxIncome:.12,buildingProductionMod:{market:.1},officialCapacity:3}},{name:"资本主义寡头政治",priority:890,description:"资产阶级独占政权",icon:"Briefcase",color:"text-blue-500",conditions:{minCategoryShare:{bourgeoisie:.6},excludes:["landowner","knight"]},effects:{industry:.18,taxIncome:.18,buildingProductionMod:{factory:.2}}},{name:"封建神权联盟",priority:900,description:"传统贵族与教会联合执政",icon:"Crown",color:"text-purple-500",conditions:{minCategoryShare:{aristocracy:.6},includes:["cleric"]},effects:{categories:{gather:.12},cultureBonus:.15,stability:.08,scienceBonus:-.1}},{name:"贵族寡头政治",priority:890,description:"传统贵族阶层联合执政",icon:"Castle",color:"text-amber-500",conditions:{minCategoryShare:{aristocracy:.6}},effects:{categories:{gather:.1},taxIncome:.12,stratumDemandMod:{landowner:.1}}},{name:"军事-精英联盟",priority:900,description:"军队与精英阶层联合执政",icon:"Shield",color:"text-red-500",conditions:{minCategoryShare:{military:.5},includesAny:["capitalist","landowner"]},effects:{militaryBonus:.2,buildingProductionMod:{barracks:.15},taxIncome:.08}},{name:"军人政府",priority:890,description:"军事力量主导的政权",icon:"Swords",color:"text-red-600",conditions:{minCategoryShare:{military:.5}},effects:{militaryBonus:.22,buildingProductionMod:{barracks:.2},stability:-.03}},{name:"全民联合政府",priority:850,description:"跨越阶级的广泛联盟",icon:"Globe",color:"text-green-400",conditions:{minSize:8,includesGroup:["upper","middle","lower"]},effects:{production:.08,stratumDemandMod:{peasant:-.05,worker:-.05},stability:.12,officialCapacity:4}},{name:"民族团结政府",priority:840,description:"各阶层联合执政",icon:"Users",color:"text-teal-400",conditions:{minSize:5,includesGroup:["upper","middle","lower"]},effects:{production:.05,stability:.1,maxPop:15}},{name:"人民阵线",priority:830,description:"以劳动阶层为主体的广泛联盟",icon:"Flag",color:"text-red-500",conditions:{minSize:5,minCategoryShare:{proletariat:.5}},effects:{categories:{gather:.1},industry:.1,stratumDemandMod:{peasant:-.1,worker:-.1}}},{name:"大联盟政府",priority:800,description:"多阶层联合执政",icon:"Users",color:"text-blue-400",conditions:{minSize:5},effects:{production:.05,stability:.05}},{name:"工业资本主义政府",priority:700,description:"工业资产阶级主导",icon:"Factory",color:"text-blue-500",conditions:{minCategoryShare:{industrial:.6},includes:["capitalist"]},effects:{industry:.2,buildingProductionMod:{factory:.18},taxIncome:.12,resourceDemandMod:{food:.1}}},{name:"劳工联合政府",priority:700,description:"工业劳动者联合执政",icon:"Hammer",color:"text-orange-500",conditions:{minCategoryShare:{industrial:.6},includes:["worker","artisan"]},effects:{industry:.15,buildingProductionMod:{loom_house:.12},stratumDemandMod:{worker:-.08,artisan:-.08}}},{name:"地主-农民联盟",priority:700,description:"农村阶层联合执政",icon:"Wheat",color:"text-green-500",conditions:{minCategoryShare:{agrarian:.6},includes:["landowner"],minCategoryShare2:{proletariat:.001}},conditions:{minCategoryShare:{agrarian:.6,proletariat:1e-4},includes:["landowner"]},effects:{categories:{gather:.18},buildingProductionMod:{farm:.15},resourceDemandMod:{food:-.08}}},{name:"农民政府",priority:690,description:"农民阶级主导政权",icon:"Wheat",color:"text-green-600",conditions:{minCategoryShare:{agrarian:.6,proletariat:.5}},effects:{categories:{gather:.18},buildingProductionMod:{farm:.18},resourceDemandMod:{food:-.1}}},{name:"商业共和国",priority:700,description:"商业阶层主导政权",icon:"Ship",color:"text-teal-400",conditions:{minCategoryShare:{commercial:.5}},effects:{buildingProductionMod:{market:.2,trade_port:.18},taxIncome:.12}},{name:"技术精英政府",priority:700,description:"知识分子联合执政",icon:"GraduationCap",color:"text-cyan-400",conditions:{includes:["scribe","engineer"]},effects:{scienceBonus:.18,industry:.1,buildingProductionMod:{library:.15,university:.15},officialCapacity:3}},{name:"无产阶级政府",priority:600,description:"劳动人民掌握政权",icon:"Hammer",color:"text-red-500",conditions:{minCategoryShare:{proletariat:.7}},effects:{categories:{gather:.12},industry:.12,stratumDemandMod:{peasant:-.1,worker:-.1},taxIncome:-.1}},{name:"精英联盟政府",priority:600,description:"上层阶级联合执政",icon:"Crown",color:"text-amber-400",conditions:{minTotalShare:[{categories:["bourgeoisie","aristocracy"],threshold:.7}]},effects:{taxIncome:.15,stratumDemandMod:{landowner:.08,capitalist:.08}}},{name:"双头政治",priority:100,description:"两个阶层联合执政",icon:"Scale",color:"text-gray-400",conditions:{exactSize:2},effects:{stability:.03}},{name:"三方联盟",priority:100,description:"三个阶层共同执政",icon:"Triangle",color:"text-gray-400",conditions:{exactSize:3},effects:{stability:.05}},{name:"联合政府",priority:0,description:"多阶层联合执政",icon:"Users",color:"text-gray-400",conditions:{},effects:{stability:.03}},{name:"无执政联盟",priority:-1,description:"尚未建立执政联盟，政府缺乏社会基础",icon:"HelpCircle",color:"text-gray-400",conditions:{maxSize:0},effects:{production:-.1,taxIncome:-.2,stability:-.15}}],_0=e=>Ta.find(t=>t.name===e),T0=e=>{const t=_0(e);return t?t.effects:null},on={HIGH:"high",MEDIUM:"medium",LOW:"low",ILLEGITIMATE:"illegitimate"},P0={赤贫:10,贫困:10,温饱:15,小康:15,富裕:10,奢华:0};function A0(e,t,o){if(!Array.isArray(e)||e.length===0||o<=0)return 0;let i=0;return e.forEach(r=>{i+=t[r]||0}),i/o}function R0(e,t={}){const{classApproval:o={},coalitionMembers:i=[],classInfluence:r={}}=t;let a=e*100;if(i.length>0&&Object.keys(o).length>0){let s=0,u=0;i.forEach(f=>{var M;const p=(M=o[f])!=null?M:50,d=r[f]||1;u+=p*d,s+=d});const c=s>0?u/s:50;if(c<50){const f=.5+c/100;a*=f}}return Math.min(100,Math.max(0,a))}function S0(e){return e>=80?on.HIGH:e>=60?on.MEDIUM:e>=40?on.LOW:on.ILLEGITIMATE}function Or(e){return .3+Math.min(100,Math.max(0,e))/100*.7}function I0(e){return S0(e)===on.ILLEGITIMATE?-15:0}function k0(e,t){return Array.isArray(t)&&t.includes(e)}function D0(e,t){return P0[e]||0}const W0={aristocracy:["landowner","knight","official"],bourgeoisie:["capitalist","merchant","engineer"],proletariat:["worker","miner","peasant","serf","lumberjack"],military:["soldier","knight"],clerical:["cleric"],intellectual:["scribe","engineer"],commercial:["merchant","navigator"],agrarian:["peasant","serf","landowner","lumberjack"],industrial:["worker","artisan","capitalist","engineer","miner"]},B0={upper:{name:"上流阶级",keys:["merchant","official","landowner","capitalist","knight","engineer"]},middle:{name:"中产阶级",keys:["artisan","soldier","cleric","scribe","navigator"]},lower:{name:"下层阶级",keys:["peasant","serf","lumberjack","worker","miner"]}};function O0(e,t,o){if(!Array.isArray(e)||e.length===0)return j0("无执政联盟")||{name:"无执政联盟",description:"尚未建立执政联盟，政府缺乏社会基础",icon:"HelpCircle",color:"text-gray-400"};let i=0;e.forEach(c=>{i+=t[c]||0});const r={},a=c=>{let f=0;return(W0[c]||[]).forEach(d=>{e.includes(d)&&(f+=t[d]||0)}),f},s=c=>{if(r[c]!==void 0)return r[c];if(i<=0)return 0;const f=a(c)/i;return r[c]=f,f},u=Ta.filter(c=>{const f=c.conditions;if(!f)return!0;const p=e.length;if(f.minSize!==void 0&&p<f.minSize||f.maxSize!==void 0&&p>f.maxSize||f.exactSize!==void 0&&p!==f.exactSize||f.exactCoalition&&(p!==f.exactCoalition.length||!f.exactCoalition.every(d=>e.includes(d)))||f.includes&&!f.includes.every(d=>e.includes(d))||f.excludes&&f.excludes.some(d=>e.includes(d))||f.includesAny&&!f.includesAny.some(d=>e.includes(d)))return!1;if(f.includesGroup)for(const d of f.includesGroup){const M=B0[d];if(M&&!M.keys.some(h=>e.includes(h)))return!1}if(f.minCategoryShare){for(const[d,M]of Object.entries(f.minCategoryShare))if(s(d)<M)return!1}if(f.minTotalShare)for(const d of f.minTotalShare){let M=0;if(d.categories.forEach(h=>M+=s(h)),M<d.threshold)return!1}return!0});return u.sort((c,f)=>(f.priority||0)-(c.priority||0)),u.length>0?u[0]:{name:"联合政府",description:"多阶层联合执政",icon:"Users",color:"text-gray-400"}}function j0(e){return Ta.find(t=>t.name===e)}const jr={priceUpdateFrequency:3,aiDecisionFrequency:5,tradeUpdateFrequency:3,diplomacyUpdateFrequency:5,buildingCacheValidation:10};function jn(e,t,o=!1){if(o)return!0;const i=jr[`${t}Frequency`]||jr[t]||1;return e%i===0}class N0{constructor(){this.cache=new Map,this.lastTick=-1}getOrCompute(t,o,i){if(t!==this.lastTick&&(this.cache.clear(),this.lastTick=t),this.cache.has(o))return this.cache.get(o);const r=i();return this.cache.set(o,r),r}get(t,o){if(t!==this.lastTick){this.cache.clear(),this.lastTick=t;return}return this.cache.get(o)}set(t,o,i){t!==this.lastTick&&(this.cache.clear(),this.lastTick=t),this.cache.set(o,i)}clear(){this.cache.clear(),this.lastTick=-1}}const L0=new N0,F0=()=>({headTax:0,industryTax:0,businessTax:0,tariff:0,tariffSubsidy:0,subsidy:0,policyIncome:0,policyExpense:0,priceControlIncome:0,priceControlExpense:0}),Nr=(e,t={})=>{let o=t[e];typeof o!="number"&&(o=1);const i=ba==null?void 0:ba.MAX_HEAD_TAX;return Math.max(-i,Math.min(i,o))},U0=(e={},t={},o={})=>{const a={};return Object.entries(ae).forEach(([s,u])=>{var y;let c=0,f=0;const p=u.needs||{};Object.entries(p).forEach(([x,m])=>{var g,_,A;if(!m||m<=0)return;const E=(A=(_=e==null?void 0:e[x])!=null?_:(g=Oe[x])==null?void 0:g.basePrice)!=null?A:Io(x);if(!Number.isFinite(E)||E<=0)return;const v=Math.max(0,(o==null?void 0:o[x])||0);c+=m*E,f+=m*E*v});const d=Math.max(0,(y=u.headTaxBase)!=null?y:0),M=Math.max(0,Nr(s,t)),h=4*(M/(M+4));f+=d*h,a[s]={needsCost:Number.isFinite(c)?c:0,taxCost:Number.isFinite(f)?f:0}}),a},Nn=(e={},t={})=>{const o=Number.isFinite(t.livingCostWeight)?t.livingCostWeight:1,i=Number.isFinite(t.taxCostWeight)?t.taxCostWeight:1,r={};return Object.entries(e).forEach(([a,s])=>{const u=(s==null?void 0:s.needsCost)||0,c=(s==null?void 0:s.taxCost)||0;r[a]=Math.max(0,u*o+c*i)}),r},$0=(e={},t={})=>{let o=0,i=0;return Object.keys(e).forEach(r=>{const a=e[r]||0,s=t[r]||0;a>0&&s>0&&(o+=s*a,i+=a)}),i>0?o/i:Bn},Z={INCOME:{WAGE:"wage",OWNER_REVENUE:"ownerRevenue",SUBSIDY:"subsidy",CORRUPTION:"corruption",TRADE_IMPORT_REVENUE:"tradeImportRevenue"},EXPENSE:{HEAD_TAX:"headTax",BUSINESS_TAX:"businessTax",RESOURCE_TAX:"transactionTax",TARIFF:"tariffs",PRODUCTION_COST:"productionCosts",WAGES_PAID:"wages",ESSENTIAL_CONSUMPTION:"essentialNeeds",LUXURY_CONSUMPTION:"luxuryNeeds",DECAY:"decay",TRADE_EXPORT:"tradeExport",TRADE_EXPORT_PURCHASE:"tradeExportPurchase",CAPITAL_FLIGHT:"capitalFlight",BUILDING_COST:"buildingCost",LAYOFF_TRANSFER:"layoffTransfer"}};class G0{constructor(t,o){this.resources=t.resources,this.wealth=t.wealth,this.officials=t.officials,this.classFinancialData=t.classFinancialData,this.taxBreakdown=t.taxBreakdown,this.silverChangeLog=t.silverChangeLog,this.buildingFinancialData=t.buildingFinancialData,this.classWealthChangeLog=t.classWealthChangeLog||{},this.safeWealth=o.safeWealth}transfer(t,o,i,r,a,s={}){i<=0||(t!=="void"&&(this._deduct(t,i,a,s),this._recordExpense(t,i,a,s)),o!=="void"&&(this._add(o,i,a,s),this._recordIncome(o,i,a,s)),this._updateSystemStats(t,o,i,a,s))}_trackClassWealthChange(t,o,i){t==="state"||t==="void"||(this.classWealthChangeLog[t]||(this.classWealthChangeLog[t]=[]),this.classWealthChangeLog[t].push({amount:o,reason:i,balance:this.wealth[t]||0}))}_deduct(t,o,i,r={}){t==="state"?this.resources.silver=Math.max(0,(this.resources.silver||0)-o):t==="official_pool"||(this.wealth[t]=Math.max(0,(this.wealth[t]||0)-o),this._trackClassWealthChange(t,-o,i))}_add(t,o,i,r={}){t==="state"?this.resources.silver=(this.resources.silver||0)+o:(this.wealth[t]=this.safeWealth((this.wealth[t]||0)+o),this._trackClassWealthChange(t,o,i))}_recordExpense(t,o,i,r){if(t==="state"){this.silverChangeLog.push({amount:-o,reason:i,balance:this.resources.silver});return}if(this.classFinancialData[t]){const a=this.classFinancialData[t].expense;if(i===Z.EXPENSE.ESSENTIAL_CONSUMPTION||i===Z.EXPENSE.LUXURY_CONSUMPTION){a[i]||(a[i]={}),typeof a[i]!="object"&&(a[i]={});const s=r.resource||"unknown";a[i][s]||(a[i][s]={cost:0,quantity:0,price:0}),a[i][s].cost+=o,a[i][s].quantity+=r.quantity||0,a[i][s].price=r.price||0}else a[i]!==void 0&&(a[i]+=o)}}_recordIncome(t,o,i,r){if(t==="state"){this.silverChangeLog.push({amount:o,reason:i,balance:this.resources.silver});return}if(this.classFinancialData[t]){const a=this.classFinancialData[t].income;a[i]!==void 0&&(a[i]+=o)}}_updateSystemStats(t,o,i,r,a={}){if(o==="state"&&(r===Z.EXPENSE.HEAD_TAX&&(this.taxBreakdown.headTax+=i),r===Z.EXPENSE.BUSINESS_TAX&&(this.taxBreakdown.businessTax+=i),r===Z.EXPENSE.RESOURCE_TAX&&(this.taxBreakdown.industryTax+=i),r===Z.EXPENSE.TARIFF&&(this.taxBreakdown.tariff=(this.taxBreakdown.tariff||0)+i)),t==="state"&&r===Z.INCOME.SUBSIDY&&(this.taxBreakdown.subsidy+=i),a.buildingId&&this.buildingFinancialData&&this.buildingFinancialData[a.buildingId]){const s=this.buildingFinancialData[a.buildingId];r===Z.EXPENSE.BUSINESS_TAX&&(s.businessTaxPaid+=i),r===Z.INCOME.OWNER_REVENUE&&(s.ownerRevenue+=i)}}}const Lr={minProfitMargin:.1,maxPurchaseAmount:20,exportProbability:.5,maxInventoryRatio:.3,minWealthForTrade:10,tradeDuration:3,tradeCooldown:0,enableDebugLog:!1,enableMerchantAssignments:!0,idleTradeEfficiency:.15,maxPartnersPerTick:4,maxResourcesScoredPerPartner:10,shortageWeight:2.2,surplusWeight:1.3},Fr=e=>Math.max(0,Math.min(1,e)),ri=(e,t=0)=>Number.isFinite(e)?e:t,nn=(e=[],t=10)=>!Array.isArray(e)||e.length===0?[]:[...e].sort((i,r)=>((r==null?void 0:r.score)||0)-((i==null?void 0:i.score)||0)).slice(0,Math.max(0,t)),q0=e=>ri(e==null?void 0:e.relation,50),V0=({partner:e})=>(e==null?void 0:e.isAtWar)===!0,H0=({merchantAssignments:e,nations:t})=>{if(!e||typeof e!="object")return null;const o={};return Object.entries(e).forEach(([i,r])=>{const a=Math.max(0,Math.floor(Number(r)||0));a<=0||!(!Array.isArray(t)||t.some(u=>(u==null?void 0:u.id)===i))||(o[i]=a)}),Object.keys(o).length>0?o:null},Y0=({nations:e,maxPartners:t})=>{const i=(Array.isArray(e)?e.filter(a=>a&&!a.isRebelNation):[]).map(a=>({nationId:a.id,relation:q0(a)})).sort((a,s)=>s.relation-a.relation).slice(0,Math.max(1,t)),r={};return i.forEach(a=>{r[a.nationId]=1}),r},Ur=({resourceKey:e,res:t,demand:o={},marketPrice:i=1})=>{const r=ri(t==null?void 0:t[e],0),a=Math.max(0,ri(o==null?void 0:o[e],0));if(a<=0)return 0;const c=(r<=0?0:r/a)/8,f=Fr(1-c),p=Math.min(1.5,Math.max(.7,ri(i,1)/3));return f*p},$r=({resourceKey:e,res:t,supply:o={},marketPrice:i=1})=>{const r=ri(t==null?void 0:t[e],0),a=Math.max(0,ri(o==null?void 0:o[e],0));if(a<=0)return 0;const c=(r<=0?0:r/a)/12,f=Fr((c-1)/2),p=Math.min(1.6,Math.max(.6,2.2/Math.max(.5,ri(i,1))));return f*p},Ln=({resourceKey:e,partner:t,tick:o})=>{const i=wr(e,t,o);return Number.isFinite(i)&&i>0?i:null},Gr=e=>{const t=Number(e);return Number.isFinite(t)?Math.max(.1,Math.min(5,t)):1},qr=({resourceKey:e,partner:t,tick:o,getLocalPrice:i,res:r,demand:a,tradeConfig:s,merchantTradePreferences:u,getImportTaxRate:c,tradeEfficiencyMultiplier:f=1})=>{var A,k;const p=i(e),d=Ln({resourceKey:e,partner:t,tick:o});if(p==null||d==null)return null;const M=c?c(e):0,h=d*(1+M),y=(p-h)/Math.max(.1,h)*f;if(y<=-.1)return null;const x=Ur({resourceKey:e,res:r,demand:a,marketPrice:p}),m=Wi(e,t,o),E=m!=null&&m.surplusAmount?Math.min(1,m.surplusAmount/Math.max(50,m.target||1)):0,v=s.shortageWeight*x+2*Math.max(0,y)+.6*E,g=Gr((k=(A=u==null?void 0:u.import)==null?void 0:A[e])!=null?k:1),_=v*g;return{type:"import",resourceKey:e,localPrice:p,foreignPrice:d,score:_,partnerSurplus:E,shortage:x,prefMultiplier:g}},Vr=({resourceKey:e,partner:t,tick:o,getLocalPrice:i,res:r,supply:a,tradeConfig:s,merchantTradePreferences:u,tradeEfficiencyMultiplier:c=1})=>{var g,_;const f=i(e),p=Ln({resourceKey:e,partner:t,tick:o});if(f==null||p==null)return null;const d=(p-f)/Math.max(1e-4,f)*c;if(d<=0||ri(r==null?void 0:r[e],0)<=0)return null;const h=$r({resourceKey:e,res:r,supply:a,marketPrice:f}),y=Wi(e,t,o),x=y!=null&&y.shortageAmount?Math.min(1,y.shortageAmount/Math.max(50,y.target||1)):0,m=s.surplusWeight*h+1*d+.6*x,E=Gr((_=(g=u==null?void 0:u.export)==null?void 0:g[e])!=null?_:1),v=m*E;return{type:"export",resourceKey:e,localPrice:f,foreignPrice:p,score:v,partnerShortage:x,surplus:h,prefMultiplier:E}},z0=({nations:e,res:t,supply:o,demand:i,market:r,tick:a,taxPolicies:s,tradeConfig:u=Lr,merchantTradePreferences:c=null})=>{const f={exports:[],imports:[]},p=E=>{var v;return(v=r==null?void 0:r.prices)==null?void 0:v[E]},d=(s==null?void 0:s.resourceTaxRates)||{},M=(s==null?void 0:s.importTariffMultipliers)||(s==null?void 0:s.resourceTariffMultipliers)||{},h=E=>{var _;const v=d[E]||0,g=(_=M[E])!=null?_:0;return v+g},y=Object.keys(Oe).filter(E=>Qt(E)),x=[],m=[];return(e||[]).forEach(E=>{!E||E.isAtWar||y.forEach(v=>{const g=Vr({resourceKey:v,partner:E,tick:a,getLocalPrice:p,res:t,supply:o,tradeConfig:u,merchantTradePreferences:c});g&&g.score>0&&x.push(g);const _=qr({resourceKey:v,partner:E,tick:a,getLocalPrice:p,res:t,demand:i,tradeConfig:u,merchantTradePreferences:c,getImportTaxRate:h});_&&_.score>0&&m.push(_)})}),f.exports=nn(x,10),f.imports=nn(m,10),f},X0=({ledger:e,res:t,wealth:o,popStructure:i,supply:r,demand:a,nations:s,tick:u,taxPolicies:c,taxBreakdown:f,getLocalPrice:p,roleExpense:d,roleWagePayout:M,pendingTrades:h=[],lastTradeTime:y=0,gameSpeed:x=1,classFinancialData:m,logs:E,potentialResources:v,merchantAssignments:g=null,merchantTradePreferences:_=null,shouldLogMerchantTrades:A=!0,onTreasuryChange:k=null})=>{var Qe,Le,_t;const D=(i==null?void 0:i.merchant)||0;if(D<=0)return{pendingTrades:h,lastTradeTime:y,lockedCapital:0,capitalInvestedThisTick:0,completedTrades:[]};let P=0;const T=[],I=(c==null?void 0:c.resourceTaxRates)||{},V=(c==null?void 0:c.importTariffMultipliers)||(c==null?void 0:c.resourceTariffMultipliers)||{},N=(c==null?void 0:c.exportTariffMultipliers)||(c==null?void 0:c.resourceTariffMultipliers)||{},L=K=>{var He;const _e=I[K]||0,fe=(He=V[K])!=null?He:0;return _e+fe},W=K=>{var He;const _e=I[K]||0,fe=(He=N[K])!=null?He:0;return _e+fe},j={...Lr,...((Qe=ae.merchant)==null?void 0:Qe.tradeConfig)||{}},H=[];if(h.forEach(K=>{if(K.daysRemaining-=1,K.daysRemaining<=0){if(e&&e.transfer("void","merchant",K.revenue,Z.INCOME.OWNER_REVENUE,Z.INCOME.OWNER_REVENUE),M.merchant=(M.merchant||0)+K.revenue,K.type==="import"){if(t[K.resource]=(t[K.resource]||0)+K.amount,r[K.resource]=(r[K.resource]||0)+K.amount,K.partnerId&&Array.isArray(s)){const _e=s.find(fe=>(fe==null?void 0:fe.id)===K.partnerId);if(_e){_e.inventory||(_e.inventory={});const fe=_e.inventory[K.resource]||0;_e.inventory[K.resource]=Math.max(0,fe-K.amount)}}}else if(K.type==="export"&&K.partnerId&&Array.isArray(s)){const _e=s.find(fe=>(fe==null?void 0:fe.id)===K.partnerId);if(_e){_e.inventory||(_e.inventory={});const fe=_e.inventory[K.resource]||0;_e.inventory[K.resource]=Math.max(0,fe+K.amount)}}T.push({type:K.type,resource:K.resource,amount:K.amount,revenue:K.revenue,profit:K.profit,partnerId:K.partnerId}),j.enableDebugLog&&tn("trade","[Merchant Debug] ✅ Trade complete:",{type:K.type==="export"?"Export":"Import",partnerId:K.partnerId,resource:K.resource,amount:K.amount,revenue:K.revenue,profit:K.profit})}else H.push(K)}),!(u-y>=j.tradeCooldown))return{pendingTrades:H,lastTradeTime:y,lockedCapital:0,capitalInvestedThisTick:0,completedTrades:T};const U=Object.keys(Oe).filter(K=>Qt(K)).filter(K=>!v||v.has(K)),X=H0({merchantAssignments:g,nations:s}),ye=j.enableMerchantAssignments&&!!X,te=ye?X:Y0({nations:s,maxPartners:j.maxPartnersPerTick}),le=Object.entries(te).map(([K,_e])=>({nationId:K,count:_e})).filter(K=>K.count>0).slice(0,Math.max(1,j.maxPartnersPerTick)),we=ye?1:j.idleTradeEfficiency,ue=D>100?100:D,Ie=D>100?D/100:1,de=le.reduce((K,_e)=>K+_e.count,0)||1,Y=le.map(K=>{const _e=K.count/de,fe=Math.max(1,Math.round(ue*_e));return{...K,batches:fe}});for(let K=0;K<Y.length;K++){const _e=Y[K],fe=Array.isArray(s)?s.find(Ee=>(Ee==null?void 0:Ee.id)===_e.nationId):null;if(!fe||V0({partner:fe}))continue;const He=_a(fe,u),ie=He.tariffMultiplier,Xe=1+Math.max(0,He.tradeEfficiencyBonus||0),Zt=Ee=>{var kt;L(Ee);const ht=((kt=V[Ee])!=null?kt:0)*ie;return(I[Ee]||0)+ht},Ye=Ee=>{var kt;W(Ee);const ht=((kt=N[Ee])!=null?kt:0)*ie;return(I[Ee]||0)+ht},Ke=[],Tt=[],Ht=[];U.forEach(Ee=>{const lt=p(Ee);if(lt==null)return;const ht=Ur({resourceKey:Ee,res:t,demand:a,marketPrice:lt}),kt=$r({resourceKey:Ee,res:t,supply:r,marketPrice:lt}),yt=Ln({resourceKey:Ee,partner:fe,tick:u});let Kt=0,ro=0;if(yt!=null){const Jo=Zt(Ee),so=yt*(1+Jo);lt>so&&(Kt=(lt-so)/Math.max(.1,so));const bt=Ye(Ee),eo=lt*(1+bt);yt>eo&&(ro=(yt-eo)/Math.max(.1,eo))}(ht>.01||Kt>.05)&&Tt.push({resourceKey:Ee,score:Math.max(ht,Kt)}),(kt>.01||ro>.05)&&Ht.push({resourceKey:Ee,score:Math.max(kt,ro)})});let Fo=nn(Tt,j.maxResourcesScoredPerPartner),Xo=nn(Ht,j.maxResourcesScoredPerPartner);if(Fo.length===0&&Xo.length===0){const Ee=Math.max(6,j.maxResourcesScoredPerPartner),lt=[];U.forEach(kt=>{const yt=p(kt);if(yt==null)return;const Kt=Ln({resourceKey:kt,partner:fe,tick:u});if(Kt==null)return;const ro=(yt-Kt)/Math.max(1e-4,yt),Jo=(Kt-yt)/Math.max(1e-4,yt),so=Math.max(ro,Jo);so<=0||lt.push({resourceKey:kt,score:so})});const ht=nn(lt,Ee);Fo=ht,Xo=ht,j.enableDebugLog&&tn("trade","[Merchant Debug] ⚠️ Trade 2.0 fallback prefilter active (no shortage/surplus signals).",{partnerId:fe==null?void 0:fe.id,fallbackCandidates:ht.length})}if(Fo.forEach(({resourceKey:Ee})=>{const lt=qr({tradeEfficiencyMultiplier:Xe,resourceKey:Ee,partner:fe,tick:u,getLocalPrice:p,res:t,demand:a,tradeConfig:j,merchantTradePreferences:_,getImportTaxRate:L});lt&&Ke.push(lt)}),Xo.forEach(({resourceKey:Ee})=>{const lt=Vr({tradeEfficiencyMultiplier:Xe,resourceKey:Ee,partner:fe,tick:u,getLocalPrice:p,res:t,supply:r,tradeConfig:j,merchantTradePreferences:_});lt&&Ke.push(lt)}),Ke.length===0)continue;Ke.sort((Ee,lt)=>lt.score-Ee.score);const Dt=Math.min(12,_e.batches);for(let Ee=0;Ee<Dt;Ee++){const lt=o.merchant||0;if(lt<=j.minWealthForTrade)break;const ht=Ke[Ee%Ke.length];if(!ht)break;const kt=lt/(ue+1)*we;if(ht.type==="export"){const yt=J0({tradeEfficiencyMultiplier:Xe,ledger:e,partner:fe,partnerId:fe.id,resourceKey:ht.resourceKey,wealthForThisBatch:kt,batchMultiplier:Ie,wealth:o,res:t,supply:r,taxBreakdown:f,tradeConfig:j,getLocalPrice:p,foreignUnitPrice:ht.foreignPrice,getResourceTaxRate:W,roleExpense:d,classFinancialData:m,taxPolicies:c,logs:E});if(yt.success){P+=yt.outlay,H.push(yt.trade),y=u;const Kt=((Le=Oe[ht.resourceKey])==null?void 0:Le.name)||ht.resourceKey,ro=(fe==null?void 0:fe.name)||(fe==null?void 0:fe.id)||"未知国家";E&&A&&yt.trade.amount>=.5&&E.push(`📦 商人发起贸易: 向${ro}出口 ${Kt} x${yt.trade.amount.toFixed(1)}`)}}else{const yt=Z0({tradeEfficiencyMultiplier:Xe,ledger:e,partner:fe,partnerId:fe.id,resourceKey:ht.resourceKey,wealthForThisBatch:kt,batchMultiplier:Ie,wealth:o,res:t,taxBreakdown:f,tradeConfig:j,getLocalPrice:p,foreignUnitPrice:ht.foreignPrice,getResourceTaxRate:L,roleExpense:d,classFinancialData:m,taxPolicies:c,logs:E});if(yt.success){P+=yt.cost,H.push(yt.trade),y=u;const Kt=((_t=Oe[ht.resourceKey])==null?void 0:_t.name)||ht.resourceKey,ro=(fe==null?void 0:fe.name)||(fe==null?void 0:fe.id)||"未知国家";E&&A&&yt.trade.amount>=.5&&E.push(`📦 商人发起贸易: 从${ro}进口 ${Kt} x${yt.trade.amount.toFixed(1)}`)}}}}const Re=H.reduce((K,_e)=>K+Math.max(0,(_e==null?void 0:_e.capitalLocked)||0),0);return{pendingTrades:H,lastTradeTime:y,lockedCapital:Re,capitalInvestedThisTick:P,completedTrades:T}},J0=({ledger:e,partner:t,partnerId:o,resourceKey:i,wealthForThisBatch:r,batchMultiplier:a,wealth:s,res:u,supply:c,taxBreakdown:f,tradeConfig:p,tradeEfficiencyMultiplier:d=1,getLocalPrice:M,foreignUnitPrice:h,getResourceTaxRate:y,classFinancialData:x,taxPolicies:m,roleExpense:E,logs:v})=>{var Re,Qe,Le,_t,K,_e,fe;const g=M(i),_=h;if(_===null||g===null||_<=g)return{success:!1};const A=y(i),k=g*(1+A),D=k>0?r/k:0,T=(u[i]||0)/a*p.maxInventoryRatio,I=Wi(i,t,0),V=Math.max(20,((I==null?void 0:I.shortageAmount)||0)+((I==null?void 0:I.target)||0)*.08),N=Math.min(p.maxPurchaseAmount,D,T,V);if(N<=.1)return{success:!1};const L=g*N,W=L*A,j=_*N;let H=L;if(W<0){const He=Math.abs(W);(u.silver||0)>=He*a?H-=He:v.push(`Treasury empty, cannot pay export subsidy for ${((Re=Oe[i])==null?void 0:Re.name)||i}!`)}else H+=W;const ce=((Qe=m==null?void 0:m.resourceTaxRates)==null?void 0:Qe[i])||0,me=(_e=(K=(Le=m==null?void 0:m.exportTariffMultipliers)==null?void 0:Le[i])!=null?K:(_t=m==null?void 0:m.resourceTariffMultipliers)==null?void 0:_t[i])!=null?_e:0,U=L*me;let X=0;if(U>0)H+=U,X=U;else if(U<0){const He=Math.abs(U)*a;(u.silver||0)>=He?(H-=Math.abs(U),X=U):v.push(`Treasury empty, cannot pay export tariff subsidy for ${((fe=Oe[i])==null?void 0:fe.name)||i}!`)}const te=(j-H)*d;if((H>0?te/H:te>0?1/0:-1/0)<p.minProfitMargin)return{success:!1};const we=N*a,ue=H*a;if((s.merchant||0)<ue)return{success:!1};if((u[i]||0)<we)return{success:!1};const Ie=L*a;e&&e.transfer("merchant","void",Ie,Z.EXPENSE.TRADE_EXPORT,Z.EXPENSE.TRADE_EXPORT),E.merchant=(E.merchant||0)+Ie;const de=L*ce*a;if(de>0)e&&e.transfer("merchant","state",de,Z.EXPENSE.RESOURCE_TAX,Z.EXPENSE.RESOURCE_TAX),E.merchant=(E.merchant||0)+de;else if(de<0){const He=Math.abs(de);(u.silver||0)>=He&&e&&e.transfer("state","merchant",He,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY)}const Y=X*a;if(Y>0)e&&e.transfer("merchant","state",Y,Z.EXPENSE.TARIFF,Z.EXPENSE.TARIFF),E.merchant=(E.merchant||0)+Y;else if(Y<0){const He=Math.abs(Y);(u.silver||0)>=He&&(e&&e.transfer("state","merchant",He,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),f.tariffSubsidy=(f.tariffSubsidy||0)+He)}return u[i]=Math.max(0,(u[i]||0)-we),c[i]=Math.max(0,(c[i]||0)-we),{success:!0,outlay:ue,trade:{type:"export",partnerId:o,resource:i,amount:we,revenue:j*a,profit:te*a,daysRemaining:p.tradeDuration,capitalLocked:ue}}},Z0=({ledger:e,partner:t,partnerId:o,resourceKey:i,wealthForThisBatch:r,batchMultiplier:a,wealth:s,res:u,taxBreakdown:c,tradeConfig:f,tradeEfficiencyMultiplier:p=1,getLocalPrice:d,foreignUnitPrice:M,getResourceTaxRate:h,roleExpense:y,classFinancialData:x,taxPolicies:m,logs:E})=>{var le,we,ue,Ie,de,Y;const v=d(i),g=M;if(g===null||v===null||g>=v)return{success:!1};const _=Wi(i,t,0),A=Math.max(10,((_==null?void 0:_.surplusAmount)||0)+((_==null?void 0:_.target)||0)*.05);(le=m==null?void 0:m.resourceTaxRates)!=null&&le[i];const k=(de=(Ie=(we=m==null?void 0:m.importTariffMultipliers)==null?void 0:we[i])!=null?Ie:(ue=m==null?void 0:m.resourceTariffMultipliers)==null?void 0:ue[i])!=null?de:0,D=g,P=D>0?r/(D*(1+Math.max(0,k))):0,T=Math.min(f.maxPurchaseAmount,P,A);if(T<=.1)return{success:!1};const I=g*T,V=I*k,N=I+V,L=v*T,j=(L-N)*p;if((N>0?j/N:j>0?1/0:-1/0)<f.minProfitMargin)return{success:!1};const ce=T*a,me=I*a,U=V*a,X=N*a;if((s.merchant||0)<X)return{success:!1};const ye=me;e&&e.transfer("merchant","void",ye,Z.EXPENSE.TRADE_IMPORT,Z.EXPENSE.TRADE_IMPORT),y.merchant=(y.merchant||0)+ye;const te=U;if(te>0)e&&e.transfer("merchant","state",te,Z.EXPENSE.TARIFF,Z.EXPENSE.TARIFF),y.merchant=(y.merchant||0)+te;else if(te<0){const Re=Math.abs(te);(u.silver||0)>=Re?(e&&e.transfer("state","merchant",Re,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),c.tariffSubsidy=(c.tariffSubsidy||0)+Re,y.merchant=(y.merchant||0)-Re):E.push(`Treasury empty, cannot pay import subsidy for ${((Y=Oe[i])==null?void 0:Y.name)||i}!`)}return{success:!0,cost:X,trade:{type:"import",partnerId:o,resource:i,amount:ce,revenue:L*a,profit:j*a,daysRemaining:f.tradeDuration,capitalLocked:X}}},Pa=(e,t,o,i,r)=>{i<=0||e&&(e[t]||(e[t]=[]),e[o]||(e[o]=[]),e[t].push({amount:-i,reason:`${r}_out`}),e[o].push({amount:i,reason:`${r}_in`}))},Q0=(e,t,o,i,r)=>{i!==0&&(e[o]=Math.max(0,(e[o]||0)+i),t&&(t[o]||(t[o]=[]),t[o].push({amount:i,reason:r})))},K0=({popStructure:e,jobsAvailable:t,wealth:o,getExpectedWage:i,getHeadTaxRate:r,effectiveTaxModifier:a,wealthChangeLog:s=null})=>{const u=d=>{var x,m;const M=i(d),y=((m=(x=ae[d])==null?void 0:x.headTaxBase)!=null?m:.01)*r(d)*a;return M-Math.max(0,y)},c=d=>{var m,E,v,g;const M=(m=So[d])!=null?m:0,h=Zc[d],y=Number.isFinite(h)?h:(E=Jc[M])!=null?E:0;return((g=(v=ae[d])==null?void 0:v.startingWealth)!=null?g:100)*y},f=(d,M)=>{var x,m;const h=(x=So[d])!=null?x:0,y=(m=So[M])!=null?m:0;return y<=2||h<=y};return zt.map((d,M)=>{var m;const h=Math.max(0,t[d]||0),y=e[d]||0,x=Math.max(0,h-y);return x<=0||d==="official"?null:{role:d,vacancy:x,netIncome:u(d),priorityIndex:M,tier:(m=So[d])!=null?m:0,wealthRequired:c(d)}}).filter(Boolean).sort((d,M)=>M.netIncome!==d.netIncome?M.netIncome-d.netIncome:d.priorityIndex-M.priorityIndex).forEach(d=>{var y;const M=Math.max(1,Math.floor(d.vacancy*Bc));let h=Math.min(d.vacancy,M);if(d.tier<=1){const x=e.unemployed||0;if(x<=0||h<=0)return;const m=Math.min(h,x);if(m<=0)return;const E=o.unemployed||0,v=x>0?E/x:0;if(e[d.role]=(e[d.role]||0)+m,e.unemployed=Math.max(0,x-m),v>0){const g=v*m;o.unemployed=Math.max(0,E-g),o[d.role]=Qi((o[d.role]||0)+g),Pa(s,"unemployed",d.role,g,"job_hire_tier01")}}else{const x=Object.keys(So).filter(m=>{var _;if(!f(m,d.role)||m===d.role||m==="soldier"||m==="official")return!1;const E=e[m]||0;if(E<=0)return!1;const v=(_=So[m])!=null?_:0,g=d.tier;if(v===g&&m!=="unemployed"){const A=t[m]||0;if(E<=A)return!1}return!0}).sort((m,E)=>{var _,A;const v=(_=So[m])!=null?_:0,g=(A=So[E])!=null?A:0;return m==="unemployed"?-1:E==="unemployed"?1:g-v});for(const m of x){if(h<=0)break;const E=e[m]||0;if(E<=0)continue;const v=o[m]||0,g=E>0?v/E:0,_=(y=So[m])!=null?y:0;let A=!1,k=0,D=0;if(_<d.tier&&g<d.wealthRequired){const T=E*Oc,I=Math.floor(T)+(Math.random()<T%1?1:0);if(I>0)D=I,A=!0,k=d.wealthRequired-g;else continue}else _===d.tier||d.wealthRequired<=0?D=E:D=g>=d.wealthRequired?E:0;const P=Math.min(h,D);if(!(P<=0)){if(e[d.role]=(e[d.role]||0)+P,e[m]=Math.max(0,E-P),g>0||A){const T=g*P;o[m]=Math.max(0,v-T);const I=A?k*P:0;o[d.role]=Qi((o[d.role]||0)+T+I);const V=A?"job_hire_lucky_promotion":"job_hire_tier23";Pa(s,m,d.role,T,V),I>0&&Q0(o,s,d.role,I,"job_hire_lucky_bonus")}h-=P}}}}),{popStructure:e,wealth:o}},el=({popStructure:e,wealth:t,roleMetrics:o,hasBuildingVacancyForRole:i,reserveBuildingVacancyForRole:r,logs:a,migrationCooldowns:s={},supplyDemandRatio:u={},roleProducesResource:c={},wealthChangeLog:f=null})=>{var H,ce,me;const p={};Object.entries(s).forEach(([U,X])=>{X>1&&(p[U]=X-1)});const d=o.filter(U=>U.role!=="soldier"&&U.role!=="official");if(d.length===0)return{popStructure:e,wealth:t,migrationCooldowns:p};const M=d.reduce((U,X)=>U+X.potentialIncome*X.pop,0),h=d.reduce((U,X)=>U+X.pop,0),y=h>0?M/h:0,x=Er.filter(U=>{const X=u[U];return X!==void 0&&X<Uc}),m=new Set;x.length>0&&Object.entries(c).forEach(([U,X])=>{X&&Array.isArray(X)&&X.some(te=>x.includes(te))&&m.add(U)}),x.length>0&&m.size>0;const E=.8,v=Er.filter(U=>{const X=u[U];return X!==void 0&&X<E}),g=new Set;v.length>0&&Object.entries(c).forEach(([U,X])=>{X&&Array.isArray(X)&&X.some(te=>v.includes(te))&&g.add(U)});const _=d.filter(U=>i(U.role)).reduce((U,X)=>Math.max(U,X.potentialIncome),0),A=d.filter(U=>{if(U.pop<=0||U.role==="soldier"||p[U.role]&&p[U.role]>0)return!1;const X=U.perCap*.05,ye=-Math.max(.5,Math.min(50,X));return U.potentialIncome<y*.7||U.perCapDelta<ye||_>0&&U.potentialIncome<_*.6}).reduce((U,X)=>!U||X.potentialIncome<U.potentialIncome||X.potentialIncome===U.potentialIncome&&X.perCapDelta<U.perCapDelta?X:U,null);if(!A)return{popStructure:e,wealth:t,migrationCooldowns:p};const k=(H=So[A.role])!=null?H:0,D=(me=(ce=ae[A.role])==null?void 0:ce.startingWealth)!=null?me:100,P=t[A.role]||0,T=A.pop>0?P/A.pop:0,I=T>=D*Qc,V=U=>{var te;const ye=((te=So[U])!=null?te:0)-k;if(ye>0)return Fc;if(ye===0)return jc;{const le=Math.abs(ye);return Nc*Math.pow(Lc,le-1)}},N=(U,X)=>{var we;const te=((we=So[U])!=null?we:0)-k;let le=X;if(I&&te>0){const ue=le*Kc*te;le+=ue}return le},L=d.filter(U=>{if(U.role===A.role||U.vacancy<=0)return!1;const ye=1.3*V(U.role);if(U.role==="soldier")return U.potentialIncome>A.potentialIncome*ye;const te=N(U.role,U.potentialIncome);return i(U.role)&&te>A.potentialIncome*ye}).reduce((U,X)=>{if(!U)return X;const ye=N(X.role,X.potentialIncome),te=N(U.role,U.potentialIncome);return ye>te?X:U},null);if(!L)return{popStructure:e,wealth:t,migrationCooldowns:p};const W=A.pop<On?Wc:Dc;let j=Math.floor(A.pop*W);if(j<=0&&A.pop>0&&(j=1),j=Math.min(j,L.vacancy),j>0){if(L.role!=="soldier"){const U=r(L.role,j);!U||U.count<=0?j=0:j=U.count}if(j>0){const U=T*j;U>0&&(t[A.role]=Math.max(0,P-U),t[L.role]=Qi((t[L.role]||0)+U),Pa(f,A.role,L.role,U,"job_migration")),e[A.role]=Math.max(0,A.pop-j),e[L.role]=(e[L.role]||0)+j,p[A.role]=xr,p[L.role]=xr}}return{popStructure:e,wealth:t,migrationCooldowns:p}},tl=(e={})=>{const t={...e};return Object.keys(ae).forEach(o=>{var i;t[o]===void 0&&(t[o]=((i=ae[o])==null?void 0:i.startingWealth)||0)}),t},ol=(e=[])=>{const t={};return Array.isArray(e)&&e.forEach(o=>{var i;o.active&&((i=o.modifiers)!=null&&i.approval)&&Object.entries(o.modifiers.approval).forEach(([r,a])=>{t[r]=(t[r]||0)+a})}),t},il=({popStructure:e,classApproval:t,classInfluence:o,totalInfluence:i,newActiveBuffs:r,newActiveDebuffs:a,eventStabilityModifier:s=0,extraStabilityPenalty:u=0,currentStability:c=50,stabilityBonus:f=0})=>{let p=0,d=0;Object.keys(ae).forEach(v=>{if((e[v]||0)===0)return;const _=t[v]||50,A=o[v]||0,k=i>0?A/i:0;p+=_*k,d+=k});let M=d>0?p:50;s&&(M+=s);let h=0;r.forEach(v=>{v.stability&&(h+=v.stability)}),a.forEach(v=>{v.stability&&(h+=v.stability)}),f&&(h+=M*f),h-=u;const y=Math.max(0,Math.min(100,M+h)),x=Math.max(0,Math.min(100,c+(y-c)*zc)),m=Math.min(1.5,Math.max(.5,1+(x-50)/100));return{stabilityValue:x,targetStability:y,efficiency:m,stabilityFactor:m}},nl=({popStructure:e,classWealthResult:t})=>{const o={},i=Object.values(t).reduce((a,s)=>a+s,0);Object.keys(ae).forEach(a=>{const s=e[a]||0;if(s===0)return;const u=ae[a],c=t[a]||0,f=i>0?c/i:0;o[a]=u.influenceBase*s+f*10});const r=Object.values(o).reduce((a,s)=>a+s,0);return{classInfluence:o,totalInfluence:r,totalWealth:i}},al=tr.reduce((e,t)=>(e[t.id]=t,e),{}),rl=()=>({buildingBonuses:{},categoryBonuses:{gather:0,industry:0,civic:0,military:0},passiveGains:{},passivePercentGains:{},perPopPassiveGains:{},incomePercentBonus:0,decreeResourceDemandMod:{},decreeStratumDemandMod:{},decreeResourceSupplyMod:{},decreeSilverIncome:0,decreeSilverExpense:0,extraMaxPop:0,maxPopPercent:0,productionBonus:0,industryBonus:0,taxBonus:0,needsReduction:0,stabilityBonus:0,scienceBonus:0,cultureBonus:0,militaryBonus:0}),zo=(e,t)=>{if(!e)return;const{buildingBonuses:o,categoryBonuses:i,passiveGains:r,decreeResourceDemandMod:a,decreeStratumDemandMod:s,decreeResourceSupplyMod:u}=t;if(e.buildings&&Object.entries(e.buildings).forEach(([c,f])=>{!c||typeof f!="number"||Number.isFinite(f)&&(o[c]=(o[c]||0)+f)}),e.buildingProductionMod&&Object.entries(e.buildingProductionMod).forEach(([c,f])=>{if(!c||typeof f!="number"||!Number.isFinite(f))return;["gather","industry","civic","military","all"].includes(c)?i[c]=(i[c]||0)+f:o[c]=(o[c]||0)+f}),e.categories&&Object.entries(e.categories).forEach(([c,f])=>{!c||typeof f!="number"||Number.isFinite(f)&&(i[c]=(i[c]||0)+f)}),e.passive&&Object.entries(e.passive).forEach(([c,f])=>{!c||typeof f!="number"||(r[c]=(r[c]||0)+f)}),e.passivePercent&&Object.entries(e.passivePercent).forEach(([c,f])=>{!c||typeof f!="number"||(t.passivePercentGains[c]=(t.passivePercentGains[c]||0)+f)}),e.maxPop){const c=e.maxPop;c>-1&&c<1&&c!==0?t.maxPopPercent+=c:t.extraMaxPop+=c}e.production&&(t.productionBonus+=e.production),e.industry&&(t.industryBonus+=e.industry),e.taxIncome&&(t.taxBonus+=e.taxIncome),e.needsReduction&&(t.needsReduction+=e.needsReduction),e.stability&&(t.stabilityBonus+=e.stability),e.scienceBonus&&(t.scienceBonus+=e.scienceBonus),e.cultureBonus&&(t.cultureBonus+=e.cultureBonus),e.militaryBonus&&(t.militaryBonus+=e.militaryBonus),e.gatherBonus&&(i.gather=(i.gather||0)+e.gatherBonus),e.industryBonus&&(t.industryBonus+=e.industryBonus),e.knowledgeBonus&&(t.scienceBonus+=e.knowledgeBonus),e.resourceDemandMod&&Object.entries(e.resourceDemandMod).forEach(([c,f])=>{typeof f=="number"&&(a[c]=(a[c]||0)+f)}),e.stratumDemandMod&&Object.entries(e.stratumDemandMod).forEach(([c,f])=>{typeof f=="number"&&(s[c]=(s[c]||0)+f)}),e.resourceSupplyMod&&Object.entries(e.resourceSupplyMod).forEach(([c,f])=>{typeof f=="number"&&(u[c]=(u[c]||0)+f)}),e.perPopPassive&&Object.entries(e.perPopPassive).forEach(([c,f])=>{!c||typeof f!="number"||(t.perPopPassiveGains[c]=(t.perPopPassiveGains[c]||0)+f)}),typeof e.incomePercent=="number"&&(t.incomePercentBonus+=e.incomePercent)},sl=(e,t)=>{Array.isArray(e)&&e.forEach(o=>{const i=al[o];!i||!i.effects||zo(i.effects,t)})},cl=(e,t)=>{Array.isArray(e)&&e.forEach(o=>{var r,a;if(!o||!o.active||!o.modifiers)return;const i=((a=(r=o.modifiers)==null?void 0:r.passive)==null?void 0:a.silver)||0;i>0?t.decreeSilverIncome+=i:i<0&&(t.decreeSilverExpense+=Math.abs(i)),zo(o.modifiers,t)})},ll=(e,t)=>{Array.isArray(e)&&e.forEach(o=>{!o||!o.effects||zo(o.effects,t)})},ul=(e,t)=>{e&&zo(e,t)},fl=(e,t,o=1.15,i=1)=>{const r={},u=1+Math.max(0,o-1)*Math.pow(t,.9);for(const[c,f]of Object.entries(e||{}))r[c]=Math.ceil(f*i*u);return r},dl=(e,t,o={})=>{let i=0;for(const[r,a]of Object.entries(o)){const s=parseInt(r);Number.isFinite(s)&&s>=e&&a>0&&(i+=a)}return i},Hr=90,Yr=60,pl=500,hl=.4,Aa={satisfied:{effectMult:1,corruption:0,description:null},uncomfortable:{effectMult:.9,corruption:.01,description:"生活拮据"},struggling:{effectMult:.7,corruption:.03,description:"入不敷出"},desperate:{effectMult:.3,corruption:.1,description:"濒临破产"}},ml={landowner:{cats:["gather"],risk:.4},merchant:{cats:["civic","industry"],risk:.7},capitalist:{cats:["industry","gather"],risk:.8},scribe:{cats:["civic"],risk:.3},cleric:{cats:["civic"],risk:.3},peasant:{cats:["gather"],risk:.4},worker:{cats:["industry"],risk:.5},artisan:{cats:["industry"],risk:.5},engineer:{cats:["industry"],risk:.6},navigator:{cats:["civic","gather"],risk:.6}},gl=(e,t)=>{var o,i;return!t||t==="silver"?1:(i=(o=e==null?void 0:e.prices)==null?void 0:o[t])!=null?i:1},yl=(e,t,o)=>{var s;const i=ml[e]||{cats:["gather"],risk:.5},r=(s=br[t])==null?void 0:s.spectrum;let a=[...i.cats];return r==="left"?(a=a.filter(u=>u!=="industry"),a.includes("gather")||a.push("gather")):r==="right"&&(a.includes("industry")||a.push("industry")),{preferredCategories:a,riskTolerance:i.risk*(.8+Math.random()*.4),investmentThreshold:.2+Math.random()*.3,lastInvestmentDay:o-Math.floor(Hr/2),lastUpgradeDay:o-Math.floor(Yr/2)}},bl=(e,t,o=null)=>{const i=Math.max(1,t||0),r=e.wealth||0,a={desperate:i*10,struggling:i*30,uncomfortable:i*60,wealthy:i*120},u=(Number.isFinite(o)?o:e.salary||0)/i;return r<a.desperate?"desperate":r>=a.wealthy?"satisfied":u<.8&&r<a.struggling?"struggling":r<a.uncomfortable?"uncomfortable":"satisfied"},zr=(e,t)=>Object.entries(e||{}).reduce((o,[i,r])=>i==="silver"?o+r:o+gl(t,i)*r,0),Ml=(e,t={},o={})=>{const i=Vt.find(c=>c.id===e);if(!(i!=null&&i.jobs))return 1;let r=0,a=0;const s=(o==null?void 0:o[e])||0,u=Math.max(1,s);return Object.entries(i.jobs).forEach(([c,f])=>{const p=u*f,d=t[c]||0;r+=p,a+=p*Math.min(1,d)}),r>0?a/r:1},vl=(e,t,o,i,r,a)=>{const s=Vt.find(h=>h.id===e.buildingId);if(!s)return 0;const u=e.level||0,c=Nt(s,u),f={...s,...c,id:s.id,owner:c.owner||s.owner},p=Ki(f,t,o).profit,d=i==null?void 0:i[e.buildingId],M=Number.isFinite(d)?d:Ml(e.buildingId,a,r);return p*M},wl=(e,t,o,i,r)=>{const a=Nt(e,t),s=Nt(e,o),u=Ki({...e,...a},i,r).profit;return Ki({...e,...s},i,r).profit-u},Xr={marxism:0,primitive_communism:.05,peasant_revolt:.1,utopian_socialism:.2,social_democracy:.4,legalism:.6,conservatism:.7,absolutism:.7,aristocratic_oligarchy:.8,feudalism:.8,mercantilism:.9,classical_liberalism:1},xl=(e,t,o,i,r,a,s,u=0,c=[])=>{var A;if(!(e!=null&&e.investmentProfile))return null;const f=e.politicalStance,p=Xr[f]!==void 0?Xr[f]:.5;if(p<=0||Math.random()>p)return null;const d=e.investmentProfile;if(t-d.lastInvestmentDay<Hr||e.wealth<pl)return null;const M=((A=r==null?void 0:r.dominance)==null?void 0:A.faction)==="left"?.5:1,h=Math.max(1,(e.wealth||0)/400),y=Math.min(2.2,1+Math.log10(h)*.6),x=d.riskTolerance*M*y;if(Math.random()>x)return null;const m=e.wealth*hl*d.riskTolerance*y;if(m<=0)return null;const E=Sr(s),v=Vt.filter(k=>{var I;return!(!k.owner||!k.baseCost||!(((I=k.epoch)!=null?I:0)<=u)||!(!k.requiresTech||c.includes(k.requiresTech))||((a==null?void 0:a[k.id])||0)<=0)}).map(k=>{const D=(a==null?void 0:a[k.id])||0,P=fl(k.baseCost,D,E),T=zr(P,o),I=Ki(k,o,i).profit,V=d.preferredCategories.includes(k.cat)?2:1;return{building:k,cost:T,profit:I,weight:Math.max(.01,I*V)}}).filter(k=>k.cost<=m&&k.profit>0).sort((k,D)=>D.weight-k.weight);if(v.length===0)return null;const g=v.reduce((k,D)=>k+D.weight,0);let _=Math.random()*g;for(const k of v)if(_-=k.weight,_<=0)return{buildingId:k.building.id,cost:k.cost,profit:k.profit};return null},El=(e,t,o,i,r,a,s,u)=>{var M,h,y,x;if(!((M=e.ownedProperties)!=null&&M.length))return null;const c=((h=e.investmentProfile)==null?void 0:h.lastUpgradeDay)||0;if(t-c<Yr||e.wealth<200)return null;const f=((y=r==null?void 0:r.dominance)==null?void 0:y.faction)==="left"?.7:1;if(Math.random()>(((x=e.investmentProfile)==null?void 0:x.riskTolerance)||.5)*f)return null;const p=Sr(u),d=[];return e.ownedProperties.forEach((m,E)=>{const v=Vt.find(N=>N.id===m.buildingId);if(!v)return;const g=kn(v.id),_=m.level||0,A=_+1;if(A>g)return;const k=(a==null?void 0:a[v.id])||0,D=(s==null?void 0:s[v.id])||{},P=dl(A,k,D),T=Dn(v.id,A,P,p);if(!T)return;const I=zr(T,o);if(I>e.wealth*.5)return;const V=wl(v,_,A,o,i);V<=0||d.push({propertyIndex:E,buildingId:v.id,fromLevel:_,toLevel:A,cost:I,profitGain:V,roi:V/I})}),d.length?(d.sort((m,E)=>E.roi-m.roi),d[0]):null},Cl={0:0,1:3,2:6,3:9,4:12,5:15,6:18,7:21},Jr={early_administration:2,bureaucracy:3,civil_service:3,administrative_reform:4,centralization:2},_l=(e=0,t={},o=[])=>{const r=Cl[e]||0,a=t.officialCapacity||0;let s=0;return o.forEach(u=>{Jr[u]&&(s+=Jr[u])}),Math.max(1,2+r+a+s)},Tl=(e,t)=>{const o={buildings:{},buildingProductionMod:{},wartimeProduction:0,tradeBonus:0,taxEfficiency:0,buildingCostMod:0,incomePercentBonus:0,passiveGains:{},passivePercentGains:{},corruption:0,decreeStratumDemandMod:{},decreeResourceDemandMod:{},resourceSupplyMod:{},resourceWaste:{},needsReduction:0,productionInputCost:{},extraMaxPop:0,populationGrowth:0,researchSpeed:0,approval:{},coalitionApproval:0,legitimacyBonus:0,organizationDecay:0,factionConflict:0,stability:0,militaryBonus:0,militaryUpkeep:0,diplomaticBonus:0,diplomaticCooldown:0,diplomaticIncident:0};if(!e||!Array.isArray(e))return o;const i=t?1:.5,r=(a,s=i)=>{if(!a||!a.type||typeof a.value!="number")return;const u=a.value*s;switch(a.type){case"buildings":a.target&&(o.buildings[a.target]=(o.buildings[a.target]||0)+u);break;case"buildingProductionMod":case"categories":a.target&&(o.buildingProductionMod[a.target]=(o.buildingProductionMod[a.target]||0)+u);break;case"wartimeProduction":o.wartimeProduction+=u;break;case"tradeBonus":o.tradeBonus+=u;break;case"taxEfficiency":o.taxEfficiency+=u;break;case"buildingCostMod":o.buildingCostMod+=u;break;case"incomePercent":o.incomePercentBonus+=u;break;case"passive":a.target&&(o.passiveGains[a.target]=(o.passiveGains[a.target]||0)+u);break;case"passivePercent":a.target&&(o.passivePercentGains[a.target]=(o.passivePercentGains[a.target]||0)+u);break;case"corruption":o.corruption+=u;break;case"stratumDemandMod":a.target&&(o.decreeStratumDemandMod[a.target]=(o.decreeStratumDemandMod[a.target]||0)+u);break;case"resourceDemandMod":a.target&&(o.decreeResourceDemandMod[a.target]=(o.decreeResourceDemandMod[a.target]||0)+u);break;case"resourceSupplyMod":a.target&&(o.resourceSupplyMod[a.target]=(o.resourceSupplyMod[a.target]||0)+u);break;case"resourceWaste":a.target&&(o.resourceWaste[a.target]=(o.resourceWaste[a.target]||0)+u);break;case"needsReduction":o.needsReduction+=u;break;case"maxPop":o.extraMaxPop+=u;break;case"populationGrowth":o.populationGrowth+=u;break;case"researchSpeed":o.researchSpeed+=u;break;case"approval":a.target&&(o.approval[a.target]=(o.approval[a.target]||0)+u);break;case"coalitionApproval":o.coalitionApproval+=u;break;case"legitimacyBonus":o.legitimacyBonus+=u;break;case"organizationDecay":o.organizationDecay+=u;break;case"factionConflict":o.factionConflict+=u;break;case"stability":o.stability+=u;break;case"militaryBonus":o.militaryBonus+=u;break;case"militaryUpkeep":o.militaryUpkeep+=u;break;case"diplomaticBonus":o.diplomaticBonus+=u;break;case"diplomaticCooldown":o.diplomaticCooldown+=u;break;case"diplomaticIncident":o.diplomaticIncident+=u;break;case"productionInputCost":a.target&&(o.productionInputCost[a.target]=(o.productionInputCost[a.target]||0)+u);break}};return e.forEach(a=>{if(!a||typeof a!="object")return;const s=Aa[a.financialSatisfaction]||Aa.satisfied,u=i*(s.effectMult||1);s.corruption&&(o.corruption+=s.corruption*i),a.effects&&typeof a.effects=="object"&&Object.entries(a.effects).forEach(([c,f])=>{typeof f=="object"&&f!==null?Object.entries(f).forEach(([p,d])=>{r({type:c,target:p,value:d},u)}):r({type:c,value:f},u)}),a.drawbacks&&typeof a.drawbacks=="object"&&Object.entries(a.drawbacks).forEach(([c,f])=>{typeof f=="object"&&f!==null?Object.entries(f).forEach(([p,d])=>{r({type:c,target:p,value:d},u)}):r({type:c,value:f},u)})}),o},Pl=(e,t={})=>{var N,L;if(!e)return 0;const o=(N=t.currentDay)!=null?N:0,i=t.polityEffects||{},r=e.sourceStratum,a=Math.max(0,e.wealth||0),s=Array.isArray(e.ownedProperties)?e.ownedProperties:[],u=s.length,c=s.reduce((W,j)=>W+Math.max(0,(j==null?void 0:j.level)||0),0),f=s.reduce((W,j)=>W+Math.max(0,(j==null?void 0:j.purchaseCost)||0),0),d=(e.hireDate!=null?Math.max(0,o-e.hireDate):0)/365,M=1+Math.min(2.5,Math.log2(d+1)*.9),y=(L={capitalist:260,landowner:240,knight:220,official:200,engineer:180,merchant:170,scribe:140,cleric:140,artisan:120,navigator:120,soldier:110,worker:90,miner:85,lumberjack:80,peasant:75,serf:65,unemployed:60}[r])!=null?L:100,x=t.classInfluence||{},m=Math.max(0,x[r]||0),E=Math.log10(m+1)*70,v=y+E,g=Math.log10(a+1)*60,_=Math.sqrt(u)*55,A=Math.sqrt(c)*45,k=Math.log10(f+1)*40,D=Math.max(0,i.officialCapacity||0),P=1+Math.min(1.2,D*.05),I=Math.max(0,e.stratumInfluenceBonus||0)*120,V=(v+g+_+A+k+I)*M*P;return Math.max(0,V)},Al=(e,t=!0,o={})=>{const i={},r=o.classInfluence||{},a=o.totalInfluence||0;if(!e||!Array.isArray(e))return i;const s=t?1:.5,u=2e4;return e.forEach(c=>{if(!c||!c.sourceStratum)return;const f=c.sourceStratum,p=Pl(c,o),d=Math.max(0,r[f]||0),M=a>0?d/a:0,h=1+Math.min(.35,M*.7);let x=p*10*h;x=Math.min(u,x)*s,!(x<=0)&&(i[f]=(i[f]||0)+x,f!=="official"&&(i.official=(i.official||0)+x*.25))}),i},Rl=(e,t)=>{const o={stability:0,legitimacyBonus:0,gatherBonus:0,industryBonus:0,tradeBonus:0,researchSpeed:0,cultureBonus:0,taxEfficiency:0,incomePercentBonus:0,buildingCostMod:0,needsReduction:0,productionInputCost:{},populationGrowth:0,militaryBonus:0,organizationDecay:0,approval:{},diplomaticBonus:0};let i=0,r=0;if(!e||!Array.isArray(e))return{aggregatedEffects:o,satisfiedCount:i,unsatisfiedCount:r};const a=s=>{!s||typeof s!="object"||Object.entries(s).forEach(([u,c])=>{typeof c=="object"&&c!==null?u==="approval"?Object.entries(c).forEach(([f,p])=>{typeof p=="number"&&(o.approval[f]=(o.approval[f]||0)+p)}):u==="productionInputCost"&&Object.entries(c).forEach(([f,p])=>{typeof p=="number"&&(o.productionInputCost[f]=(o.productionInputCost[f]||0)+p)}):typeof c=="number"&&o.hasOwnProperty(u)&&(o[u]+=c)})};return e.forEach(s=>{if(!s)return;const u=s.stanceConditionParams;Mr(s.politicalStance,t,u)?(i++,a(s.stanceActiveEffects)):(r++,a(s.stanceUnsatisfiedPenalty))}),{aggregatedEffects:o,satisfiedCount:i,unsatisfiedCount:r}},Sl=(e,t=0)=>{var p,d;if(!e||typeof e!="object")return e;const o=!!e.investmentProfile,i=Array.isArray(e.ownedProperties),r=e.loyalty===void 0||e.loyalty===null||e.loyalty===0&&((p=e.lowLoyaltyDays)!=null?p:0)>100,a=Number.isFinite(e.salary);if(o&&i&&!r&&a)return e;const s=e.sourceStratum||e.stratum||"peasant",u=e.politicalStance,c=Wn==null?void 0:Wn.INITIAL_MIN,f=r?c:e.loyalty;return{...e,financialSatisfaction:e.financialSatisfaction||"satisfied",salary:Number.isFinite(e.salary)?e.salary:Number.isFinite(e.baseSalary)?e.baseSalary:0,baseSalary:Number.isFinite(e.baseSalary)?e.baseSalary:e.salary||0,investmentProfile:o?e.investmentProfile:yl(s,u,t),ownedProperties:i?e.ownedProperties:[],lastDayPropertyIncome:typeof e.lastDayPropertyIncome=="number"?e.lastDayPropertyIncome:0,loyalty:f,lowLoyaltyDays:r?0:(d=e.lowLoyaltyDays)!=null?d:0}},yi=(e,t)=>{var r,a;if(e.vassalOf!=="player")return{allowed:!0,reason:null};const o=((r=e.vassalPolicy)==null?void 0:r.diplomaticControl)||"guided",i=((a=e.vassalPolicy)==null?void 0:a.tradePolicy)||"preferential";switch(t){case"alliance":if(o!=="autonomous")return{allowed:!1,reason:"当前外交政策禁止独立结盟"};break;case"treaty":if(o==="puppet")return{allowed:!1,reason:"傀儡外交政策禁止独立签署条约"};break;case"trade":if(["monopoly","exclusive","looting"].includes(i))return{allowed:!1,reason:"当前贸易政策禁止独立贸易"};break}return{allowed:!0,reason:null}},Ra=(e,t,o,i)=>{if(!e||!Number.isFinite(t)||t===0)return 0;const r=Number(e.silver||0),a=Math.max(0,r+t),s=a-r;return e.silver=a,typeof i=="function"&&s!==0&&i(s,o),s},an=(e,t,o,i,r)=>{if(!e||!Number.isFinite(o)||o===0)return 0;const a=Number(e[t]||0),s=Math.max(0,a+o),u=s-a;return e[t]=s,typeof r=="function"&&u!==0&&r(u,i,t),u},rn=(e,t,o)=>o?o.some(i=>i.type==="military_alliance"&&i.members.includes(e)&&i.members.includes(t)):!1,Zr=(e,t)=>{if(!Array.isArray(t))return[];const o=new Set;return t.forEach(i=>{!i||i.type!=="military_alliance"||!Array.isArray(i.members)||!i.members.includes(e)||i.members.forEach(r=>{r&&r!==e&&o.add(r)})}),Array.from(o)},Il=({nation:e,tick:t,epoch:o,resources:i,population:r,army:a,logs:s,onTreasuryChange:u,onResourceChange:c})=>{var x,m;let f=0;const p=i,d=e;if(!d.isAtWar)return{raidPopulationLoss:f};d.warDuration=(d.warDuration||0)+1;const M=(x=d.aggression)!=null?x:.7,h=Math.min(.35,.25+M*.1);if(Math.random()<h){const E=(m=d.militaryStrength)!=null?m:1,v=.08+M*.05,g={},_=or(o,"light"),A=3+Math.random()*5,k=Math.floor(A*E);_.forEach(W=>{if(Ro[W]){const j=Math.floor(k/_.length*(.5+Math.random()*.8));j>0&&(g[W]=j)}});const D={...a},P=Object.values(D).reduce((W,j)=>W+j,0);let T=0,I=0,V=0,N={victory:!0,attackerLosses:{},defenderLosses:{}};if(P===0)T=Math.floor((p.food||0)*v),I=Math.floor((p.silver||0)*(v/2)),V=Math.min(5,Math.max(1,Math.floor(v*25)));else{N=gr({army:g,militaryBuffs:.1},{army:D,militaryBuffs:0}),N.victory&&(T=Math.floor((p.food||0)*v),I=Math.floor((p.silver||0)*(v/2)),V=Math.min(5,Math.max(1,Math.floor(v*25))));const W=N.defenderLosses||{},j={};Object.entries(W).forEach(([H,ce])=>{if(a[H]){const me=Math.min(a[H],ce);a[H]=Math.max(0,a[H]-me),me>0&&(j[H]=me)}}),Object.keys(j).length>0&&s.push(`AUTO_REPLENISH_LOSSES:${JSON.stringify(j)}`)}T>0&&an(p,"food",-T,"rebel_raid_loss",c),I>0&&Ra(p,-I,"rebel_raid_loss",u),V>0&&(f+=V),d.warScore=(d.warScore||0)+(N.victory?-8:6);const L={nationName:d.name,victory:!N.victory,attackerArmy:g,defenderArmy:D,attackerLosses:N.attackerLosses||{},defenderLosses:N.defenderLosses||{},foodLoss:T,silverLoss:I,popLoss:V,ourPower:N.defenderPower||0,enemyPower:N.attackerPower||0,battleReport:N.battleReport||[],actionType:"raid",actionName:"叛军突袭"};s.push(`❗RAID_EVENT❗${JSON.stringify(L)}`)}const y=-(d.warScore||0);if(y>50&&(d.warDuration||0)>20){const E=d.lastSurrenderDemandDay||0;if(t-E>=30&&Math.random()<.05){d.lastSurrenderDemandDay=t;const v=p.silver||0,g=Math.floor((r||0)*.05),_=Math.floor(y/4),A=Math.max(0,(r||100)-10),k=Math.min(Math.max(g,_,10),A),D=Math.max(100,Math.floor(v*.1)),P=D*3,T=Math.ceil(P/365);let I="reform";y>200?I="massacre":y>100&&(I="concession"),s.push(`REBEL_DEMAND_SURRENDER:${JSON.stringify({nationId:d.id,nationName:d.name,rebellionStratum:d.rebellionStratum,coalitionStrata:d.coalitionStrata||[d.rebellionStratum],warScore:d.warScore,warAdvantage:y,primaryDemandType:I,massacreAmount:k,reformAmount:D,subsidyTotalAmount:P,subsidyDailyAmount:T})}`)}}return{raidPopulationLoss:f}},kl=({nation:e,tick:t,logs:o})=>{const i=e,r=i.warScore||0,a=i.warDuration||0,s=Number.isFinite(i.lastPeaceRequestDay)?i.lastPeaceRequestDay:-1/0;if(t-s>=30&&!i.isPeaceRequesting){const c=Math.max(0,r-20)/100+Math.max(0,a-60)/500,f=Math.min(.4,c*.5);r>30&&Math.random()<f?(i.isPeaceRequesting=!0,i.peaceTribute=0,i.lastPeaceRequestDay=t,o.push(`🏳️ ${i.name} 已陷入绝境，请求投降！`)):r>60&&a>90&&(i.isPeaceRequesting=!0,i.peaceTribute=0,i.lastPeaceRequestDay=t,o.push(`🏳️ ${i.name} 已经崩溃，恳求投降！`))}},Dl=({nation:e,tick:t,epoch:o,resources:i,army:r,logs:a,difficultyLevel:s=Ea,onTreasuryChange:u,onResourceChange:c})=>{var ue,Ie;let f=0;const p=e,d=i;if(o<1)return{raidPopulationLoss:f};if(Rr(t,s))return{raidPopulationLoss:f};const M=p.lastMilitaryActionDay||0,h=u0(s);p.militaryCooldownDays||(p.militaryCooldownDays=Math.max(5,7+Math.floor(Math.random()*24)+h));const y=t-M>=p.militaryCooldownDays,x=Math.max(0,-(p.warScore||0));let m=Math.min(.18,.02+(p.aggression||.2)*.04+x/400);if(m=c0(m,s),!y||Math.random()>=m)return{raidPopulationLoss:f};p.lastMilitaryActionDay=t,p.militaryCooldownDays=Math.max(5,7+Math.floor(Math.random()*24)+h);const E=Math.max(p.appearEpoch||0,Math.min(o,(ue=p.expireEpoch)!=null?ue:o)),v=(Ie=p.militaryStrength)!=null?Ie:1,g=Math.max(.3,Math.min(1.5,(p.wealth||500)/800)),_=1+(p.aggression||.2),A=1+Math.max(-.5,(p.warScore||0)/120),k=p.aggression||.2;Object.values(r).reduce((de,Y)=>de+Y,0);const D=-(p.warScore||0),P=(p.traits||[]).includes("maritime")||(p.name||"").includes("海")||(p.name||"").includes("威尼斯");let T="raid",I="light",V={min:2,max:6},N="边境掠夺",L=1;const W=Math.random();v>.7&&k>.5&&D>30&&E>=2?W<.25?(T="siege",I="heavy",V={min:15,max:25},N="围城压制",L=1.5):W<.6?(T="assault",I="medium",V={min:12,max:18},N="正面攻势",L=1.3):W<.75&&k>.6&&(T="scorched_earth",I="heavy",V={min:12,max:20},N="焦土战术",L=1.4):v>.5&&D>10&&E>=1?W<.35?(T="assault",I="medium",V={min:10,max:15},N="正面攻势",L=1.2):W<.5&&P&&E>=2&&(T="naval_raid",I="medium",V={min:8,max:14},N="海上劫掠",L=1.1):D<-20&&k>.6&&W<.3&&(T="scorched_earth",I="medium",V={min:8,max:15},N="焦土战术",L=1.1);const j=(.05+k*.05+x/1200)*L,H=v*g*_*A,ce={},me=or(E,I),U=V.min+Math.random()*(V.max-V.min),X=Math.floor(U*H);me.forEach(de=>{if(Ro[de]){const Y=.5+Math.random()*.8,Re=Math.floor(X/me.length*Y);Re>0&&(ce[de]=Re)}});const ye={...r},te=Object.values(ye).reduce((de,Y)=>de+Y,0),le={raid:1,assault:1.5,siege:2,naval_raid:1.2,scorched_earth:1.8}[T]||1,we={raid:{win:-8,lose:6},assault:{win:-15,lose:12},siege:{win:-25,lose:20},naval_raid:{win:-12,lose:10},scorched_earth:{win:-18,lose:15}}[T]||{win:-8,lose:6};if(te===0){let de=Math.floor((d.food||0)*j*le),Y=Math.floor((d.silver||0)*(j/2)*le),Re=0;de=ji(de,s),Y=ji(Y,s),T==="scorched_earth"&&(Re=Math.floor((d.wood||0)*j*.8),Re=ji(Re,s),Re>0&&an(d,"wood",-Re,"ai_scorched_earth",c)),de>0&&an(d,"food",-de,"ai_war_action_loss",c),Y>0&&Ra(d,-Y,"ai_war_action_loss",u);let Qe=Math.min(Math.floor(3*le),Math.max(1,Math.floor(j*20*le)));Qe=Ar(Qe,s),f+=Qe;const Le={nationName:p.name,victory:!1,attackerArmy:ce,defenderArmy:{},attackerLosses:{},defenderLosses:{},foodLoss:de,silverLoss:Y,woodLoss:Re,popLoss:Qe,ourPower:0,enemyPower:0,actionType:T,actionName:N};a.push(`❗RAID_EVENT❗${JSON.stringify(Le)}`),p.warScore=(p.warScore||0)+we.win;const _t=de+Y+Re;p.wealth=(p.wealth||0)+Math.floor(_t*.08)}else{const de={raid:.1,assault:0,siege:-.1,naval_raid:.15,scorched_earth:.05}[T]||.1,Y={army:ce,militaryBuffs:de},Re={army:ye,militaryBuffs:0,wealth:(d.food||0)+(d.silver||0)+(d.wood||0)},Qe=gr(Y,Re);let Le=0,_t=0,K=0,_e=0;if(Qe.victory){let Ye=Math.floor((d.food||0)*j*le),Ke=Math.floor((d.silver||0)*(j/2)*le);Ye=ji(Ye,s),Ke=ji(Ke,s),T==="scorched_earth"&&(K=Math.floor((d.wood||0)*j*.8),K=ji(K,s),K>0&&an(d,"wood",-K,"ai_scorched_earth",c)),Ye>0&&an(d,"food",-Ye,"ai_war_action_loss",c),Ke>0&&Ra(d,-Ke,"ai_war_action_loss",u);let Tt=Math.min(Math.floor(3*le),Math.max(1,Math.floor(j*20*le)));Tt=Ar(Tt,s),f+=Tt;const Ht=Ye+Ke+K;p.wealth=(p.wealth||0)+Math.floor(Ht*.08)}const fe=Qe.defenderLosses||{},He={};Object.entries(fe).forEach(([Ye,Ke])=>{if(r[Ye]){const Tt=Math.min(r[Ye],Ke);r[Ye]=Math.max(0,r[Ye]-Tt),Tt>0&&(He[Ye]=Tt)}}),Object.keys(He).length>0&&a.push(`AUTO_REPLENISH_LOSSES:${JSON.stringify(He)}`);const ie=Object.values(Qe.attackerLosses||{}).reduce((Ye,Ke)=>Ye+(Ke||0),0);ie>0&&(p.enemyLosses=(p.enemyLosses||0)+ie);const Xe=Qe.victory?we.win:we.lose;p.warScore=(p.warScore||0)+Xe;const Zt={nationName:p.name,victory:!Qe.victory,attackerArmy:ce,defenderArmy:ye,attackerLosses:Qe.attackerLosses||{},defenderLosses:Qe.defenderLosses||{},foodLoss:Le,silverLoss:_t,woodLoss:K,popLoss:_e,ourPower:Qe.defenderPower,enemyPower:Qe.attackerPower,battleReport:Qe.battleReport||[],actionType:T,actionName:N};a.push(`❗RAID_EVENT❗${JSON.stringify(Zt)}`)}return{raidPopulationLoss:f}},Wl=({nation:e,tick:t,lastGlobalPeaceRequest:o=-1/0,logs:i})=>{const r=e,a=Number.isFinite(r.lastPeaceRequestDay)?r.lastPeaceRequestDay:-1/0,s=t-a>=Gc,u=qc,c=t-o>=u;if((r.warScore||0)>12&&s&&c){const f=Math.min(.5,.03+(r.warScore||0)/120+(r.warDuration||0)/400)+Math.min(.15,(r.enemyLosses||0)/500);if(Math.random()<f){const p=r.warScore||0,d=r.enemyLosses||0,M=r.warDuration||0,h=Math.max(0,r.wealth||0),y=uc(p,d,M,h);return i.push(`🤝 ${r.name} 请求和平，愿意支付 ${y} 银币作为赔款。`),r.isPeaceRequesting=!0,r.peaceTribute=y,r.lastPeaceRequestDay=t,!0}}return!1},Bl=({nation:e,tick:t,population:o,playerWealth:i,logs:r})=>{const a=e,s=-(a.warScore||0);if(s>25&&(a.warDuration||0)>30){const u=a.lastSurrenderDemandDay||0;if(t-u>=60&&Math.random()<.03){a.lastSurrenderDemandDay=t;let c="tribute";const f=a.warDuration||0;let p=fc(s,f,i);s>100?(c="territory",p=Math.min(50,Math.max(3,Math.floor(o*.05)))):s>50&&Math.random()<.5&&(c="open_market",p=365*2),r.push(`AI_DEMAND_SURRENDER:${JSON.stringify({nationId:a.id,nationName:a.name,warScore:a.warScore,demandType:c,demandAmount:p})}`)}}},Ol=({nation:e,tick:t,population:o,playerWealth:i,resources:r,logs:a})=>{const s=e;if(!s.isAtWar||s.isPeaceRequesting)return;const u=s.lastMercyPeaceOfferDay||0;if(t-u<30)return;const f=(r==null?void 0:r.silver)||0,p=(r==null?void 0:r.food)||0,d=f+p+((r==null?void 0:r.wood)||0),M=o<20,h=i<50&&f<30,y=d<100&&o<50,x=s.warDuration||0;if(!(x>=30&&(M||h&&o<50||y&&h)))return;const v=s.aggression||.3,g=Math.min(1,(M?.4:0)+(h?.3:0)+(y?.2:0)+(o<10?.3:0)),_=.05+x/500+g*.3,A=v*.15,k=Math.min(.5,Math.max(.1,_-A));Math.random()<k&&(s.lastMercyPeaceOfferDay=t,s.isMercyPeaceOffering=!0,s.mercyPeaceOfferDay=t,a.push(`🕊️ ${s.name} 见你已无力继续战斗，愿意无条件议和。`),a.push(`AI_MERCY_PEACE_OFFER:${JSON.stringify({nationId:s.id,nationName:s.name,warScore:s.warScore,warDuration:x,playerPopulation:o,playerWealth:i})}`))},jl=({nation:e,nations:t,tick:o,epoch:i,resources:r,stabilityValue:a,logs:s,difficultyLevel:u=Ea,diplomacyOrganizations:c})=>{var V,N,L;const f=e,p=r,d=(V=f.relation)!=null?V:50,M=(N=f.aggression)!=null?N:.2,h=l0(u);if(Rr(o,u))return;const y=(t||[]).filter(W=>W.isAtWar===!0&&W.id!==f.id&&!W.isRebelNation).length,x=(t||[]).some(W=>W.isAtWar&&W.warStartDay&&o-W.warStartDay<Xc&&W.id!==f.id),m=y>0?Math.pow(.3,y):1,E=Math.max(0,(50-d)/70),v=a<35?.02:0,g=M>.5?M*.03:0;let _=i>=h?Math.min(.08,M*.04+E*.025+v+g):0;_=Pr(_,u),_*=m;const A=f.peaceTreatyUntil&&o<f.peaceTreatyUntil,k=rn(f.id,"player",c==null?void 0:c.organizations);!f.isAtWar&&!A&&!k&&d<25&&y<wa&&!x&&Math.random()<_&&(f.isAtWar=!0,f.warStartDay=o,f.warDuration=0,f.warDeclarationPending=!0,s.push(`⚠️ ${f.name} 对你发动了战争！`),s.push(`WAR_DECLARATION_EVENT:${JSON.stringify({nationId:f.id,nationName:f.name})}`),t&&t.forEach(W=>{var j,H;W.vassalOf==="player"&&(((j=W.vassalPolicy)==null?void 0:j.military)||"autonomous")==="auto_join"&&(f.foreignWars||(f.foreignWars={}),W.foreignWars||(W.foreignWars={}),(H=f.foreignWars[W.id])!=null&&H.isAtWar||(f.foreignWars[W.id]={isAtWar:!0,warStartDay:o,warScore:0},W.foreignWars[f.id]={isAtWar:!0,warStartDay:o,warScore:0,followingSuzerain:!0,suzerainTarget:"player"},s.push(`⚔️ ${W.name} 根据军事政策自动对 ${f.name} 宣战！`)))}));const P=(p.food||0)+(p.silver||0)+(p.wood||0),T=f.wealth||500,I=(L=f.militaryStrength)!=null?L:1;if(!f.isAtWar&&!A&&!k&&i>=h&&P>T*2&&I>.8&&d<50&&M>.4&&y<wa&&!x){let W=.001*M*(P/T-1);W=Pr(W,u),Math.random()<W&&(f.isAtWar=!0,f.warStartDay=o,f.warDuration=0,f.warDeclarationPending=!0,s.push(`⚠️ ${f.name} 觊觎你的财富，发动了战争！`),s.push(`WAR_DECLARATION_EVENT:${JSON.stringify({nationId:f.id,nationName:f.name,reason:"wealth"})}`),t&&t.forEach(j=>{var H,ce;j.vassalOf==="player"&&(((H=j.vassalPolicy)==null?void 0:H.military)||"autonomous")==="auto_join"&&(f.foreignWars||(f.foreignWars={}),j.foreignWars||(j.foreignWars={}),(ce=f.foreignWars[j.id])!=null&&ce.isAtWar||(f.foreignWars[j.id]={isAtWar:!0,warStartDay:o,warScore:0},j.foreignWars[f.id]={isAtWar:!0,warStartDay:o,warScore:0,followingSuzerain:!0,suzerainTarget:"player"},s.push(`⚔️ ${j.name} 根据军事政策自动对 ${f.name} 宣战！`)))}))}},Nl=(e,t,o,i)=>{e.forEach(r=>{if(Object.values(r.foreignWars||{}).filter(c=>c==null?void 0:c.isAtWar).length<3||e.filter(c=>{var f,p;return((p=(f=c.foreignWars)==null?void 0:f[r.id])==null?void 0:p.isAtWar)&&c.id!==r.id}).length>=2)return;const u=e.filter(c=>{var p,d,M,h;return c.id===r.id||(d=(p=c.foreignWars)==null?void 0:p[r.id])!=null&&d.isAtWar||rn(c.id,r.id,i==null?void 0:i.organizations)?!1:((h=(M=c.foreignRelations)==null?void 0:M[r.id])!=null?h:50)<40});if(u.length>=2&&Math.random()<.005){const c=u[Math.floor(Math.random()*u.length)];c.foreignWars||(c.foreignWars={}),r.foreignWars||(r.foreignWars={}),c.foreignWars[r.id]={isAtWar:!0,warStartDay:t,warScore:0},r.foreignWars[c.id]={isAtWar:!0,warStartDay:t,warScore:0},o.push(`⚔️ 国际新闻：${c.name} 认为 ${r.name} 的好战行为威胁地区稳定，对其宣战！`)}})},Ll=(e,t,o,i,r)=>{e.forEach(a=>{a.foreignWars||(a.foreignWars={}),e.forEach(s=>{var T,I,V,N,L;if(s.id===a.id||(T=a.foreignWars[s.id])!=null&&T.isAtWar)return;const u=((I=a.foreignWars[s.id])==null?void 0:I.peaceTreatyUntil)||0;if(o<u||rn(a.id,s.id,r==null?void 0:r.organizations))return;const f=Object.values(a.foreignWars||{}).filter(W=>W==null?void 0:W.isAtWar).length,p=a.aggression>.7?2:1;if(f>=p)return;const d=a.population||100,M=a.wealth||500;if(d<30||M<300)return;const h=W=>{var j;return((j=W.militaryStrength)!=null?j:1)*(W.population||100)*(1+(W.aggression||.3))};let y=h(a),x=h(s);e.forEach(W=>{if(W.id===a.id||W.id===s.id)return;rn(a.id,W.id,r==null?void 0:r.organizations)&&(y+=h(W)),rn(s.id,W.id,r==null?void 0:r.organizations)&&(x+=h(W))});const m=y/Math.max(1,x),E=a.aggression>.7?.5:.7;if(m<E)return;const g=Object.values(s.foreignWars||{}).filter(W=>W==null?void 0:W.isAtWar).length>0?.002:0,_=(N=(V=a.foreignRelations)==null?void 0:V[s.id])!=null?N:50,A=(L=a.aggression)!=null?L:.3,k=_<50,D=A>.25,P=_<15;if(s.vassalOf==="player"&&a.isAtWar,k&&D||P){let W=A*.003+(50-_)/5e3;_<10?W+=.01:_<20&&(W+=.003),m>2?W*=2:m>1.5?W*=1.5:m>1.2?W*=1.2:m<.8&&(W*=.1),W+=g*.5;const j=s.wealth||500;if(j>M*1.5&&m>.8){const H=.003*A*(j/M-1);W+=H}if(W=Math.min(.003,W),Math.random()<W){a.foreignWars[s.id]={isAtWar:!0,warStartDay:o,warScore:0},s.foreignWars||(s.foreignWars={}),s.foreignWars[a.id]={isAtWar:!0,warStartDay:o,warScore:0};const H=[`📢 国际新闻：${a.name} 向 ${s.name} 宣战了！`,`📢 国际新闻：${a.name} 正式对 ${s.name} 宣战！`,`📢 国际新闻：战争爆发！${a.name} 对 ${s.name} 发起了战争！`];i.push(H[Math.floor(Math.random()*H.length)]),s.vassalOf==="player"&&(a.isAtWar||(a.isAtWar=!0,a.warStartDay=o,a.warDuration=0,a.warDeclarationPending=!0,i.push(`⚠️ ${a.name} 攻击了您的附庸 ${s.name}，自动对您宣战！`)));const ce=s.alliedWithPlayer===!0,me=a.alliedWithPlayer===!0,U=ce&&me,X=e.filter(ue=>ue.isAtWar===!0&&!ue.isRebelNation).length;U?i.push(`⚖️ 你的盟友 ${a.name} 与 ${s.name} 发生冲突，你选择保持中立。`):(ce&&!a.isAtWar&&i.push(`ALLY_ATTACKED_EVENT:${JSON.stringify({allyId:s.id,allyName:s.name,attackerId:a.id,attackerName:a.name,currentPlayerWars:X})}`),me&&!s.isAtWar&&(X>=wa?i.push(`⚖️ 你的盟友 ${a.name} 向 ${s.name} 宣战！但你已陷入多场战争，选择不介入。`):(s.isAtWar=!0,s.warStartDay=o,s.warDuration=0,s.relation=Math.max(0,(s.relation||50)-40),i.push(`⚔️ 你的盟友 ${a.name} 向 ${s.name} 宣战！作为同盟，你被迫与 ${s.name} 进入战争状态！`))));const ye=(r==null?void 0:r.organizations)||[],te=Zr(a.id,ye),le=Zr(s.id,ye),we=new Set(te.filter(ue=>le.includes(ue)));le.forEach(ue=>{if(we.has(ue)||ue===a.id||ue===s.id)return;const Ie=e.find(de=>de.id===ue);Ie&&(Ie.foreignWars||(Ie.foreignWars={}),Ie.foreignWars[a.id]={isAtWar:!0,warStartDay:o,warScore:0},a.foreignWars||(a.foreignWars={}),a.foreignWars[Ie.id]={isAtWar:!0,warStartDay:o,warScore:0},i.push(`?? ${Ie.name} ?? ${s.name} ????????? ${a.name} ????`))}),we.size>0&&we.forEach(ue=>{const Ie=e.find(de=>de.id===ue);Ie&&i.push(`?? ${Ie.name} ???????????????`)})}}})})},Fl=(e,t,o,i)=>{const r=new Set(e.map(a=>a.id));e.forEach(a=>{Object.keys(a.foreignWars||{}).forEach(s=>{var E,v;const u=a.foreignWars[s];if(!(u!=null&&u.isAtWar))return;const c=t.find(g=>g.id===s);if(!c||!r.has(s)){a.foreignWars[s]={isAtWar:!1},c&&i.push(`⚔️ ${a.name} 与 ${c.name} 的战争因对方势力消亡而结束。`);return}c.foreignWars||(c.foreignWars={}),c.foreignWars[a.id]||(c.foreignWars[a.id]={isAtWar:!0,warStartDay:u.warStartDay||o,warScore:-(u.warScore||0)});const f=o-(u.warStartDay||o),p=Math.min(2,1+f/500),d=.995-p*.003,M=.998-p*.002,h=Object.values(a.foreignWars||{}).filter(g=>g==null?void 0:g.isAtWar).length,y=Object.values(c.foreignWars||{}).filter(g=>g==null?void 0:g.isAtWar).length,x=Math.pow(.998,h-1),m=Math.pow(.998,y-1);if(a.wealth=Math.max(100,(a.wealth||500)*d*x),a.population=Math.max(10,(a.population||100)*M*x),c.wealth=Math.max(100,(c.wealth||500)*d*m),c.population=Math.max(10,(c.population||100)*M*m),(o-u.warStartDay)%10===0&&o>u.warStartDay){const g=((E=a.militaryStrength)!=null?E:1)*(a.population||100)*(1+(a.aggression||.3)),_=((v=c.militaryStrength)!=null?v:1)*(c.population||100)*(1+(c.aggression||.3)),A=g+_,k=g/A,D=.02+Math.random()*.03;if(a.population=Math.max(10,(a.population||100)*(1-D*(1-k))),c.population=Math.max(10,(c.population||100)*(1-D*k)),Math.random()<k){u.warScore=(u.warScore||0)+5,c.foreignWars[a.id].warScore=(c.foreignWars[a.id].warScore||0)-5;const N=Math.floor((c.wealth||500)*.08);a.wealth=(a.wealth||500)+N,c.wealth=Math.max(100,(c.wealth||500)-N)}else{u.warScore=(u.warScore||0)-5,c.foreignWars[a.id].warScore=(c.foreignWars[a.id].warScore||0)+5;const N=Math.floor((a.wealth||500)*.08);c.wealth=(c.wealth||500)+N,a.wealth=Math.max(100,(a.wealth||500)-N)}u.endScoreThreshold||(u.endScoreThreshold=25+Math.floor(Math.random()*56));const P=Math.abs(u.warScore||0),T=(a.population||100)<30||(a.wealth||500)<200,I=(c.population||100)<30||(c.wealth||500)<200,V=T||I?.03:.005;if(P>=u.endScoreThreshold||Math.random()<V){const N=(u.warScore||0)>0?a:c,L=N.id===a.id?c:a,W=Math.abs(u.warScore||0);let j="draw",H=0,ce=0,me=365,U="僵持";W>=200?(j="overwhelming",H=.25,ce=.35,me=365*3,U="压倒性胜利"):W>=100?(j="major",H=.15,ce=.25,me=Math.floor(365*2.5),U="大胜"):W>=50?(j="minor",H=.08,ce=.12,me=365*2,U="小胜"):W>=25&&(j="pyrrhic",H=.03,ce=.05,me=Math.floor(365*1.5),U="惨胜");const X=Math.floor((L.population||100)*H),ye=Math.floor((L.wealth||500)*ce);N.population=(N.population||100)+X,N.wealth=(N.wealth||500)+ye,L.population=Math.max(10,(L.population||100)-X),L.wealth=Math.max(100,(L.wealth||500)-ye);let te=!1;j==="overwhelming"&&(L.population||100)<30&&(L.wealth||500)<300&&(N.population=(N.population||100)+(L.population||0),N.wealth=(N.wealth||500)+(L.wealth||0),L.isAnnexed=!0,L.annexedBy=N.id,L.annexedAt=o,L.population=0,L.wealth=0,te=!0),a.foreignWars[s]={isAtWar:!1,peaceTreatyUntil:o+me},c.foreignWars[a.id]={isAtWar:!1,peaceTreatyUntil:o+me};const le=10+Math.floor(W/10);a.foreignRelations||(a.foreignRelations={}),c.foreignRelations||(c.foreignRelations={}),a.foreignRelations[s]=$t((a.foreignRelations[s]||50)-le,0,100),c.foreignRelations[a.id]=$t((c.foreignRelations[a.id]||50)-le,0,100);const we=o-(u.warStartDay||o);te?i.push(`📢 国际新闻：${N.name} 在历时${we}天的战争中彻底击败 ${L.name}，将其吞并！`):j==="draw"?i.push(`📢 国际新闻：${a.name} 与 ${c.name} 经过${we}天的战争后握手言和。`):i.push(`📢 国际新闻：${N.name} 在与 ${L.name} 历时${we}天的战争中取得${U}！`)}}})})},Ni={military_alliance:{id:"military_alliance",name:"军事联盟",minEra:3,minMembers:2,maxMembers:6,createCost:.05,memberFee:.001,minRelation:60,leaveCost:.03,founderLeaveCost:.08,leaveRelationPenalty:-15,founderLeaveRelationPenalty:-25,founderLeaveDisbands:!0,kickRelationPenalty:-20,effects:{mutualDefense:!0,relationBonus:5,militaryBonus:.1},description:"成员国互相保护，共同对抗外敌"},economic_bloc:{id:"economic_bloc",name:"经济共同体",minEra:5,minMembers:2,maxMembers:10,createCost:.08,memberFee:.002,minRelation:45,leaveCost:.05,founderLeaveCost:.12,leaveRelationPenalty:-10,founderLeaveRelationPenalty:-20,founderLeaveDisbands:!0,kickRelationPenalty:-15,effects:{tariffDiscount:.3,relationBonus:5,tradeEfficiency:.2},description:"成员国共享经济利益，减免关税，促进贸易自由化"}};function Qr({type:e,founderId:t,founderName:o,name:i=null,epoch:r=0,daysElapsed:a=0}){var f;const s=Ni[e];if(!s)throw new Error(`无效的组织类型: ${e}`);if(!Ao("organizations",e,r))return{success:!1,reason:`需要 ${(f=ir.organizations[e])==null?void 0:f.name} 时代解锁`};const u=`org_${e}_${Date.now()}`,c=i||`${o}主导的${s.name}`;return{success:!0,organization:{id:u,type:e,name:c,founderId:t,members:[t],createdDay:a,isActive:!0}}}function Ul({organizations:e=[],nations:t=[],playerWealth:o=0,daysElapsed:i=0}){const r=[],a={player:0,ai:{}},s=[];for(const u of e){if(!u.isActive){s.push(u);continue}const c=Ni[u.type];if(!c){s.push(u);continue}for(const f of u.members)if(f==="player"){const p=Math.floor(o*c.memberFee);a.player+=p,p>0&&r.push(`🏛️ ${u.name}成员费: -${p.toLocaleString()}银`)}else{const p=t.find(d=>d.id===f);if(p){const d=Math.floor((p.wealth||1e3)*c.memberFee);a.ai[f]=(a.ai[f]||0)+d}}s.push(u)}return{updatedOrganizations:s,fees:a,logs:r}}function $l(e){const t=Ni[e.type];return!t||e.members.length<t.minMembers}const Kr=(e,t,o,i)=>{if(!e||!Number.isFinite(t)||t===0)return 0;const r=Number(e.silver||0),a=Math.max(0,r+t),s=a-r;return e.silver=a,typeof i=="function"&&s!==0&&i(s,o),s},Gl=e=>Array.isArray(e)?e.map(t=>(t.foreignRelations||(t.foreignRelations={}),e.forEach(o=>{if(o.id!==t.id){if(t.foreignRelations[o.id]===void 0){const i=((t.aggression||.3)+(o.aggression||.3))/2;t.foreignRelations[o.id]=Math.floor(50-i*30+(Math.random()-.5)*20)}if(Math.random()<.05){const i=(Math.random()-.5)*6;t.foreignRelations[o.id]=$t((t.foreignRelations[o.id]||50)+i,0,100)}}}),t)):[],ql=(e,t)=>!(t%30===0)||!Array.isArray(e)?e||[]:e.map(i=>{var c;if(i.isRebelNation)return i;const r=(c=i.relation)!=null?c:50,s=i.alliedWithPlayer===!0?.1:.5;let u=r;return r>50?u=Math.max(50,r-s):r<50&&(u=Math.min(50,r+s)),{...i,relation:u}}),Vl=(e,t,o,i="normal")=>{if(!Array.isArray(e))return;const r=p0(i),a=h0(i);e.forEach(s=>{var c,f;if(s.isRebelNation||s.alliedWithPlayer!==!0||((c=s.relation)!=null?c:50)>=70)return;const u=s.lastAllyColdEventDay||0;t-u<r||Math.random()<a&&(s.lastAllyColdEventDay=t,o.push(`ALLY_COLD_EVENT:${JSON.stringify({nationId:s.id,nationName:s.name,relation:Math.round((f=s.relation)!=null?f:50)})}`))})},Hl=(e,t)=>{e.forEach(o=>{var c;if(Math.random()>.02)return;const i=(c=o.aggression)!=null?c:.3,r=o.wealth||500;if(i>.6||r<300)return;const a=e.filter(f=>{var d,M,h,y;if(f.id===o.id||(M=(d=o.foreignWars)==null?void 0:d[f.id])!=null&&M.isAtWar)return!1;const p=(y=(h=o.foreignRelations)==null?void 0:h[f.id])!=null?y:50;return p>=40&&p<80});if(a.length===0)return;const s=a[Math.floor(Math.random()*a.length)],u=sr(r,s.wealth);if(r>u*3){o.wealth=Math.max(0,(o.wealth||0)-u),s.wealth=(s.wealth||0)+u;const f=Math.floor(5+Math.random()*8);o.foreignRelations||(o.foreignRelations={}),s.foreignRelations||(s.foreignRelations={}),o.foreignRelations[s.id]=$t((o.foreignRelations[s.id]||50)+f,0,100),s.foreignRelations[o.id]=$t((s.foreignRelations[o.id]||50)+f,0,100),o.foreignRelations[s.id]>=80&&s.foreignRelations[o.id]>=80?t.push(`🤝 国际新闻：${o.name} 与 ${s.name} 达成同盟协议！`):Math.random()<.3&&t.push(`💝 国际新闻：${o.name} 向 ${s.name} 赠送了外交礼物，两国关系升温。`)}})},Yl=(e,t,o)=>{const i=e==null?void 0:e.organizations;return Array.isArray(i)?i.reduce((r,a)=>{if(!a||!Array.isArray(a.members)||!a.members.includes(t)||!a.members.includes(o))return r;const s=Ma[a.type]||{};return{tariffDiscount:Math.max(r.tariffDiscount,s.tariffDiscount||0),relationBonus:Math.max(r.relationBonus,s.relationBonus||0)}},{tariffDiscount:0,relationBonus:0}):{tariffDiscount:0,relationBonus:0}},zl=(e,t,o=null)=>{e.forEach(i=>{if(Math.random()>.02||i.isAtWar||!yi(i,"trade").allowed||(i.wealth||500)<300)return;const s=e.filter(y=>{var E,v,g,_;return y.id===i.id||y.isAtWar||(v=(E=i.foreignWars)==null?void 0:E[y.id])!=null&&v.isAtWar||!yi(y,"trade").allowed?!1:((_=(g=i.foreignRelations)==null?void 0:g[y.id])!=null?_:50)>=30});if(s.length===0)return;const u=s[Math.floor(Math.random()*s.length)],c=Math.floor(20+Math.random()*60),f=.08,p=Yl(o,i.id,u.id),d=f*(1-p.tariffDiscount);if(c*(1-d)-c*.5<=0)return;i.wealth=(i.wealth||0)+c*.05,u.wealth=(u.wealth||0)+c*.05,i.foreignRelations||(i.foreignRelations={}),u.foreignRelations||(u.foreignRelations={});const h=1+(p.relationBonus||0);i.foreignRelations[u.id]=Math.min(100,(i.foreignRelations[u.id]||50)+h),u.foreignRelations[i.id]=Math.min(100,(u.foreignRelations[i.id]||50)+h)})},Xl=(e,t,o,i,r,a={},s=null,u=null)=>{const c=o,f=(s==null?void 0:s.organizations)||[],p=d=>{var h;const M=f.find(y=>Array.isArray(y==null?void 0:y.members)&&y.members.includes("player")&&y.members.includes(d));return M&&((h=Ma[M.type])==null?void 0:h.tariffDiscount)||0};e.forEach(d=>{var I,V,N,L,W,j,H,ce,me,U,X,ye;if(Math.random()>.005||d.isAtWar||((I=d.relation)!=null?I:50)<40)return;const M=d.wealth||500;if(M<400)return;const h=d.openMarketUntil&&t<d.openMarketUntil,y=Math.random()>.5,x=["food","wood","stone","iron"],m=x[Math.floor(Math.random()*x.length)],E=((V=i==null?void 0:i.prices)==null?void 0:V[m])||((N=Oe[m])==null?void 0:N.basePrice)||1,v=((L=a==null?void 0:a.resourceTaxRates)==null?void 0:L[m])||0,g=y?(ce=(H=(W=a==null?void 0:a.exportTariffMultipliers)==null?void 0:W[m])!=null?H:(j=a==null?void 0:a.resourceTariffMultipliers)==null?void 0:j[m])!=null?ce:0:(ye=(X=(me=a==null?void 0:a.importTariffMultipliers)==null?void 0:me[m])!=null?X:(U=a==null?void 0:a.resourceTariffMultipliers)==null?void 0:U[m])!=null?ye:0,_=p(d.id),A=g*(1-_),k=h?0:v+A,D=Math.floor(10+Math.random()*40),P=D*E,T=Math.floor(P*k);if(y){const te=E*1.5,le=D*te,we=P+T;if(le<=we)return;(c[m]||0)>=D&&(c[m]=(c[m]||0)-D,Kr(c,T,"ai_trade_tariff",u),d.wealth=Math.max(0,(d.wealth||0)-P-T),d.inventory||(d.inventory={}),d.inventory[m]=(d.inventory[m]||0)+D,r.push(`AI_TRADE_EVENT:${JSON.stringify({nationId:d.id,nationName:d.name,tradeType:"export",resourceKey:m,quantity:D,baseValue:P,tariff:T,isOpenMarket:h})}`),d.relation=Math.min(100,(d.relation||50)+2))}else{const te=D*E*.6;if(P-T<=te)return;M>=P*.6&&(c[m]=(c[m]||0)+D,Kr(c,T,"ai_trade_tariff",u),d.wealth=(d.wealth||0)+P-T,d.inventory||(d.inventory={}),d.inventory[m]=Math.max(0,(d.inventory[m]||0)-D),r.push(`AI_TRADE_EVENT:${JSON.stringify({nationId:d.id,nationName:d.name,tradeType:"import",resourceKey:m,quantity:D,baseValue:P,tariff:T,isOpenMarket:h})}`),d.relation=Math.min(100,(d.relation||50)+2))}})},Jl=(e,t,o,i)=>{e.forEach(r=>{var g;const a=r.wealth||500,s=(g=r.aggression)!=null?g:.3,u=r.relation||0;if(r.isAtWar===!0)return;if(yi(r,"treaty"),r.peaceTreatyUntil&&t<r.peaceTreatyUntil){const _=lc(o),A=Number.isFinite(r.lastTreatyBreachDay)?r.lastTreatyBreachDay:-1/0,k=t-A>=_.cooldownDays,D=u<15&&s>.55;if(k&&D){const P=Math.min(.05,.005+.02*(s-.55)+Math.max(0,(15-u)/500));Math.random()<P&&(r.relation=Math.max(0,u-_.relationPenalty),r.peaceTreatyUntil=void 0,Array.isArray(r.treaties)&&(r.treaties=r.treaties.filter(T=>!rc.includes(T.type))),r.lastTreatyBreachDay=t,i.push(`AI_TREATY_BREACH:${JSON.stringify({nationId:r.id,nationName:r.name,relationPenalty:_.relationPenalty})}`),i.push(`⚠️ ${r.name} 撕毁了与你的和平条约，关系恶化（-${_.relationPenalty}）。`))}}const f=r.lastGiftToPlayerDay||0,d=t-f>=1825,M=2e-5+u/1e6+a/1e8;if(d&&a>1e3&&u>=70&&s<.4&&Math.random()<M){const _=sr(a);r.wealth=Math.max(0,r.wealth-_),r.lastGiftToPlayerDay=t,i.push(`AI_GIFT_EVENT:${JSON.stringify({nationId:r.id,nationName:r.name,amount:Math.floor(_)})}`)}const h=5e-5+Math.max(0,(400-a)/1e6);if(o>=1&&a<400&&Math.random()<h){const _=Math.floor(80+Math.random()*120);i.push(`AI_REQUEST_EVENT:${JSON.stringify({nationId:r.id,nationName:r.name,resourceKey:"silver",resourceName:"银币",amount:_})}`)}const y=r.alliedWithPlayer===!0,x=r.lastAllianceRequestDay||0,E=t-x>=1095,v=5e-5+(u-70)/1e5;E&&!y&&u>=70&&s<.5&&Math.random()<v&&(r.lastAllianceRequestDay=t,i.push(`AI_ALLIANCE_REQUEST:${JSON.stringify({nationId:r.id,nationName:r.name})}`))})},Zl=(e,t,o,i,r)=>{if(!Ao("organizations","economic_bloc",r))return{createdOrganizations:[],memberJoinRequests:[]};const a=(i==null?void 0:i.organizations)||[],s={createdOrganizations:[],memberJoinRequests:[]};return[...e].sort(()=>Math.random()-.5).forEach(c=>{if(Math.random()>.015||(c.wealth||0)<1500||a.find(h=>h.type==="economic_bloc"&&h.members.includes(c.id)))return;const p=e.filter(h=>{var E,v,g,_;if(h.id===c.id||(h.wealth||0)<2e3||!yi(h,"alliance").allowed)return!1;const x=(v=(E=c.foreignRelations)==null?void 0:E[h.id])!=null?v:50,m=(_=(g=h.foreignRelations)==null?void 0:g[c.id])!=null?_:50;return x>=55&&m>=55});if(p.length===0)return;const d=p[Math.floor(Math.random()*p.length)],M=a.find(h=>h.type==="economic_bloc"&&h.members.includes(d.id));if(M)M.members.map(x=>e.find(m=>m.id===x)).filter(x=>x).every(x=>{var m,E;return((E=(m=x.foreignRelations)==null?void 0:m[c.id])!=null?E:50)>=50})&&(s.memberJoinRequests.push({orgId:M.id,nationId:c.id,orgName:M.name}),o.push(`💰 ${c.name} 此刻申请加入 "${M.name}" 以寻求经济合作。`));else{const h=["贸易同盟","经济共同体","自由市场协定","关税同盟","繁荣互助会","商业联合会"],y=h[Math.floor(Math.random()*h.length)]+(Math.random()>.5?"":` (${c.name})`),x=Qr({type:"economic_bloc",founderId:c.id,founderName:c.name,name:y,epoch:r,daysElapsed:t});if(x.success){const m=x.organization;m.members.push(d.id),s.createdOrganizations.push(m),o.push(`💰 国际新闻：${c.name} 与 ${d.name} 宣布共同建立 "${y}"！`)}}}),s},Ql=(e,t,o,i,r)=>{if(!Ao("organizations","military_alliance",r))return{createdOrganizations:[],memberJoinRequests:[]};const a=(i==null?void 0:i.organizations)||[],s={createdOrganizations:[],memberJoinRequests:[]};if([...e].sort(()=>Math.random()-.5).forEach(c=>{var y;if(Math.random()>.02||!yi(c,"alliance").allowed||((y=c.aggression)!=null,a.find(x=>x.type==="military_alliance"&&x.members.includes(c.id))))return;const d=e.filter(x=>{var g,_,A,k,D,P,T,I;if(x.id===c.id||!yi(x,"alliance").allowed||(_=(g=c.foreignWars)==null?void 0:g[x.id])!=null&&_.isAtWar||(k=(A=x.foreignWars)==null?void 0:A[c.id])!=null&&k.isAtWar)return!1;const E=(P=(D=c.foreignRelations)==null?void 0:D[x.id])!=null?P:50,v=(I=(T=x.foreignRelations)==null?void 0:T[c.id])!=null?I:50;return E>=65&&v>=65});if(d.length===0)return;const M=d[Math.floor(Math.random()*d.length)],h=a.find(x=>x.type==="military_alliance"&&x.members.includes(M.id));if(h)h.members.map(E=>e.find(v=>v.id===E)).filter(E=>E).every(E=>{var g,_;return((_=(g=E.foreignRelations)==null?void 0:g[c.id])!=null?_:50)>=60})&&(s.memberJoinRequests.push({orgId:h.id,nationId:c.id,orgName:h.name}),o.push(`🛡️ ${c.name} 加入了由 ${M.name} 所在的 "${h.name}"！`));else{const x=["北方","南方","东方","西方","神圣","大","自由","联合"],m=["协约","同盟","公约组织","防卫阵线","联盟"],E=x[Math.floor(Math.random()*x.length)],v=m[Math.floor(Math.random()*m.length)],g=`${E}${v}`,_=Qr({type:"military_alliance",founderId:c.id,founderName:c.name,name:g,epoch:r,daysElapsed:t});if(_.success){const A=_.organization;A.members.push(M.id),s.createdOrganizations.push(A),o.push(`🤝 国际新闻：${c.name} 与 ${M.name} 共同建立了新的军事同盟——"${g}"！`)}}}),r>=5){const c=Zl(e,t,o,i,r);s.createdOrganizations.push(...c.createdOrganizations),s.memberJoinRequests.push(...c.memberJoinRequests)}return s},Kl=(e,t,o,i,r)=>{const a=(i==null?void 0:i.organizations)||[],s={memberJoinRequests:[]},u=new Map(e.map(c=>[c.id,c]));return a.forEach(c=>{var E;if(!c||c.isActive===!1||!["military_alliance","economic_bloc"].includes(c.type)||!Ao("organizations",c.type,r))return;const f=Ni[c.type],p=(f==null?void 0:f.maxMembers)||10;if(((E=c.members)==null?void 0:E.length)>=p)return;const d=e.filter(v=>!(!v||v.isRebelNation||c.members.includes(v.id)||!yi(v,"alliance").allowed));if(d.length===0)return;const M=c.type==="military_alliance"?65:55,h=d.map(v=>{var D,P,T,I,V,N;let g=0,_=0,A=100;for(const L of c.members||[]){if(L==="player")continue;const W=u.get(L);if(!W)continue;if((P=(D=v.foreignWars)==null?void 0:D[L])!=null&&P.isAtWar)return null;const j=(I=(T=v.foreignRelations)==null?void 0:T[L])!=null?I:50,H=(N=(V=W.foreignRelations)==null?void 0:V[v.id])!=null?N:50;A=Math.min(A,j,H),g+=j+H,_+=2}if(_===0)return null;const k=g/_;return A<M-5?null:{candidate:v,avgRel:k}}).filter(Boolean);if(h.length===0)return;h.sort((v,g)=>g.avgRel-v.avgRel);const y=h[0],x=c.type==="military_alliance"?.04:.05,m=Math.max(0,(y.avgRel-60)/800);Math.random()>x+m||(s.memberJoinRequests.push({orgId:c.id,nationId:y.candidate.id,orgName:c.name}),o.push(`🏛️ ${y.candidate.name} 受邀加入 "${c.name}"。`))}),s},eu=(e,t,o,i,r)=>{const a=(i==null?void 0:i.organizations)||[],s={memberLeaveRequests:[]},u=new Map(e.map(c=>[c.id,c]));return a.forEach(c=>{var p,d,M,h,y;if(!c||c.isActive===!1||!["military_alliance","economic_bloc"].includes(c.type)||!Ao("organizations",c.type,r))return;const f=c.type==="military_alliance"?40:35;for(const x of c.members||[]){if(x==="player")continue;const m=u.get(x);if(!m)continue;let E=0,v=0,g=!1;for(const D of c.members||[]){if(D===x)continue;if(D==="player"){E+=(p=m.relation)!=null?p:50,v+=1;continue}const P=(M=(d=m.foreignRelations)==null?void 0:d[D])!=null?M:50;E+=P,v+=1,(y=(h=m.foreignWars)==null?void 0:h[D])!=null&&y.isAtWar&&(g=!0)}const _=v>0?E/v:50,k=.01+Math.max(0,f-_)/200+(g?.08:0);_<f&&Math.random()<k&&(s.memberLeaveRequests.push({orgId:c.id,nationId:x,orgName:c.name}),o.push(`💔 ${m.name} 退出了 "${c.name}"。`))}}),s},tu=(e,t,o,i,r)=>{const a=(i==null?void 0:i.organizations)||[];a.length!==0&&e.forEach(s=>{var x,m;if(!s||s.isRebelNation||s.isAtWar)return;const u=(x=s.relation)!=null?x:50;if(u<60)return;const c=s.lastOrgInviteDay||0;if(t-c<360)return;const p=a.filter(E=>{var v,g;return(E==null?void 0:E.isActive)!==!1&&["military_alliance","economic_bloc"].includes(E.type)&&((v=E.members)==null?void 0:v.includes(s.id))&&!((g=E.members)!=null&&g.includes("player"))});if(p.length===0)return;const d=p.find(E=>Ao("organizations",E.type,r));if(!d)return;const M=Ni[d.type],h=(M==null?void 0:M.maxMembers)||10;if(((m=d.members)==null?void 0:m.length)>=h)return;const y=.001+Math.max(0,(u-60)/5e4);Math.random()>y||(s.lastOrgInviteDay=t,o.push(`AI_ORG_INVITE:${JSON.stringify({nationId:s.id,nationName:s.name,orgId:d.id,orgName:d.name,orgType:d.type})}`))})},ou=(e,t,o)=>{var s;if(!o)return null;const i=(o.organizations||[]).filter(u=>u.type==="military_alliance"&&u.members.includes(e.id)&&u.members.includes("player"));if(i.length===0)return null;if(((s=e.relation)!=null?s:50)<30||(e.allianceStrain||0)>=3){const u=i.map(c=>({orgId:c.id,nationId:e.id,orgName:c.name}));return e.allianceStrain=0,u.forEach(c=>{t.push(`💔 ${e.name} 由于与你的关系恶化，退出了 "${c.orgName}"。`)}),{memberLeaveRequests:u}}return null},iu=(e,t="normal")=>{var s;const o=(s=e.relation)!=null?s:50;let i=0;const r=Ir(t),a=d0(t);o>50?i=-a*r.bad:o<50&&(i=a*r.good),e.relation=Math.max(0,Math.min(100,o+i)),e.foreignRelations&&Object.keys(e.foreignRelations).forEach(u=>{var f;let c=(f=e.foreignRelations[u])!=null?f:50;c>50?c-=a*r.bad:c<50&&(c+=a*r.good),e.foreignRelations[u]=Math.max(0,Math.min(100,c))})},nu=(e,t,o,i)=>{if(!e||!Number.isFinite(t)||t===0)return 0;const r=Number(e.silver||0),a=Math.max(0,r+t),s=a-r;return e.silver=a,typeof i=="function"&&s!==0&&i(s,o),s},au=({nation:e,tick:t,gameSpeed:o})=>{var f;const i=e;i.inventory?i.inventory={...i.inventory}:i.inventory={},typeof i.budget!="number"&&(i.budget=(i.wealth||800)*.5);const r=((f=i.economyTraits)==null?void 0:f.resourceBias)||{},a=Object.keys(Oe).filter(Qt);if(a.length>0){const d=i.isAtWar||i.foreignWars&&Object.values(i.foreignWars).some(x=>x==null?void 0:x.isAtWar)?1.3+(i.aggression||.2)*.5:1,M=i.epoch||0,h=1+M*.5+Math.pow(M,1.3)*.1,y=Math.max(.8,Math.min(2,(i.wealth||1e3)/1e3));a.forEach(x=>{var ue;const m=(ue=r[x])!=null?ue:1,E=i.inventory[x]||0,v=Math.round(500*Math.pow(m,1.2)),g=Math.round(v*h*y),_=5*o*h*y,A=5*o*h*y*d,k=x.split("").reduce((Ie,de)=>Ie+de.charCodeAt(0),0),D=600+k%200,P=Math.sin(t*2*Math.PI/D+k*.1),T=.35+Math.abs(m-1)*.45,I=m>1?1+Math.max(0,P)*T+.2:1-Math.max(0,P)*T*.4,V=m<1?1+Math.max(0,P)*T+.15:1-Math.max(0,P)*T*.25,N=_*Math.pow(m,1.2)*I,L=A*Math.pow(1/m,.8)*V,W=E/g;let j=1,H=1;W>1.5?(j*=.5,H*=1.15):W>1.1?(j*=.8,H*=1.05):W<.5?(j*=1.5,H*=.85):W<.9&&(j*=1.2,H*=.95);const ce=(g-E)*.01*o,me=(Math.random()-.5)*g*.1*o,U=N*j,X=L*H,ye=U-X+ce+me,te=g*.2,le=g*3,we=E+ye;i.inventory[x]=Math.max(te,Math.min(le,we))})}const s=(i.wealth||800)*.5,u=.02,c=s-i.budget;i.budget=i.budget+c*u*o,i.budget=Math.max(0,i.budget)},ru=({nation:e,tick:t})=>{var i;const o=e;if(!((i=o.economyTraits)!=null&&i.ownBasePopulation)){const a=(o.wealthTemplate||800)/800;o.economyTraits={...o.economyTraits||{},ownBasePopulation:Math.max(5,Math.round(16*a*(.8+Math.random()*.4))),ownBaseWealth:Math.max(500,Math.round(1e3*a*(.8+Math.random()*.4))),developmentRate:.8+(o.aggression||.3)*.3+Math.random()*.4,lastGrowthTick:t}}},su=({nation:e,tick:t})=>{const o=e;if(!o.economyTraits)return;const i=o.economyTraits.ownBasePopulation,r=o.economyTraits.ownBaseWealth,a=o.economyTraits.developmentRate||1;if(t-(o.economyTraits.lastGrowthTick||0)>=100){const u=Math.max(1,(i||10)/200),c=$t(1/(1+u*.6),.2,1),f=.3*a*c;if(Math.random()<f&&!o.isAtWar){const p=(1.03+Math.random()*.05)*c,d=(1.04+Math.random()*.08)*Math.max(.4,c);o.economyTraits.ownBasePopulation=Math.round(i*p),o.economyTraits.ownBaseWealth=Math.round(r*d)}o.economyTraits.lastGrowthTick=t}},cu=({nation:e,epoch:t,playerPopulationBaseline:o,playerWealthBaseline:i,tick:r})=>{var Ie,de,Y,Re,Qe,Le,_t,K,_e,fe,He,ie;const a=e,s=a.foreignPower||{},u=$t((de=(Ie=s.volatility)!=null?Ie:a.marketVolatility)!=null?de:.3,.1,.9),c=$t((Re=(Y=s.populationFactor)!=null?Y:s.baseRating)!=null?Re:1,.6,2.5),f=$t((Qe=s.wealthFactor)!=null?Qe:s.baseRating?s.baseRating*1.1:1.1,.5,3.5),p=1+Math.max(0,t-((Le=s.appearEpoch)!=null?Le:0))*.03,d=1+Math.max(0,t)*.15,M=(((_t=a.economyTraits)==null?void 0:_t.ownBasePopulation)||16)*d*c,h=(((K=a.economyTraits)==null?void 0:K.ownBaseWealth)||1e3)*d*f,y=.05,x=o*c*p,m=i*f*p,E=M*(1-y)+x*y,v=h*(1-y)+m*y,g=Math.max(1,(a.wealthTemplate||800)/Math.max(800,i)*.8),_=Math.max(1,(a.wealthTemplate||800)/Math.max(800,i)*1.1),A=Wi("food",a,r),k=A.isShortage?$t(1-A.shortageAmount/Math.max(1,A.target),.5,1):1,D=A.isSurplus?$t(1+A.surplusAmount/Math.max(1,A.target)*.08,1,1.15):1,P=$t(k*D,.5,1.15),T=Math.max(3,E*g*P),I=Math.max(200,o*1.5,(((_e=a.economyTraits)==null?void 0:_e.ownBasePopulation)||16)*25),V=Math.max(0,T-I),N=V>0?I+V/(1+V/I):T,L=Math.max(100,v*_);a.economyTraits={...a.economyTraits||{},basePopulation:N,baseWealth:L};const W=(fe=a.population)!=null?fe:N,j=$t(1+u*.6+p*.08,1,1.8),H=$t(1/(1+Math.pow(W/Math.max(1,I),1.3)),.25,1),ce=(a.isAtWar?.032:.12)*j*H,me=(Math.random()-.5)*u*N*.04*H;let U=W+(N-W)*ce+me;if(a.isAtWar&&(U-=W*.012),a.population=Math.max(3,Math.round(U)),A.isShortage){const Xe=$t(A.shortageAmount/Math.max(1,A.target),0,1),Zt=(He=a.militaryStrength)!=null?He:1;a.militaryStrength=Math.max(.6,Zt-Xe*.01)}const X=(ie=a.wealth)!=null?ie:L,ye=(a.isAtWar?.03:.11)*j,te=(Math.random()-.5)*u*L*.05;let le=X+(L-X)*ye+te;a.isAtWar&&(le-=X*.015),a.wealth=Math.max(100,Math.round(le));const we=a.wealth*.45,ue=Number.isFinite(a.budget)?a.budget:we;a.budget=Math.max(0,ue+(we-ue)*.35)},lu=e=>{var s;const t=e;t.economyTraits||(t.economyTraits={});const o=Math.max(5,t.economyTraits.basePopulation||t.population||10),i=Math.max(100,t.economyTraits.baseWealth||t.wealth||200);t.economyTraits.basePopulation=o,t.economyTraits.baseWealth=i;const r=Math.max(o,Math.floor(o*1.1)),a=Math.max(i,Math.floor(i*1.15));t.population=$t(Math.round(t.population||o),5,r),t.wealth=$t(Math.round(t.wealth||i),i*.5,a),t.budget=Math.min(t.wealth,Math.max(0,(s=t.budget)!=null?s:Math.floor(t.wealth*.3)))},uu=e=>{var t;if(!e.isAtWar){const o=(t=e.militaryStrength)!=null?t:1;o<1&&(e.militaryStrength=Math.min(1,o+.005))}},fu=({nation:e,resources:t,logs:o,onTreasuryChange:i})=>{let r=0;const a=e,s=t;if(a.installmentPayment&&a.installmentPayment.remainingDays>0){const u=a.installmentPayment.amount;nu(s,u,"installment_payment_income",i),r+=u,a.installmentPayment.paidAmount+=u,a.installmentPayment.remainingDays-=1,a.installmentPayment.remainingDays===0&&(o.push(`💰 ${a.name} 完成了所有分期赔款支付（共${a.installmentPayment.totalAmount}银币）。`),delete a.installmentPayment)}return r},du=(e,t)=>{var u,c,f;if(!e||e.isRebelNation)return;const o=e.epoch||0;if(o>=gi.length-1)return;const i=o+1,r=gi.find(p=>p.id===i);if(!r)return;const a=((u=r.req)==null?void 0:u.population)||0,s=(((c=r.cost)==null?void 0:c.silver)||1e3)*2.5;if((e.population||0)>=a&&(e.wealth||0)>=s){e.epoch=i;const p=((f=r.cost)==null?void 0:f.silver)||0;e.wealth=Math.max(0,(e.wealth||0)-p),t.push(`🚀 ${e.name} 迈入了新的时代：${r.name}！`)}},es={economic_migration:{name:"经济移民",description:"人口从低收入国家流向高收入国家",minEra:3,trigger:"income_gap",baseMonthlyRate:.002,stratumWeights:{worker:.35,peasant:.25,artisan:.2,merchant:.1,engineer:.05,official:.05}},war_refugees:{name:"战争难民",description:"战争期间人口逃往和平国家",minEra:2,trigger:"war",baseMonthlyRate:.01,stratumWeights:{peasant:.4,worker:.3,artisan:.15,merchant:.1,capitalist:.05}},political_exile:{name:"政治流亡",description:"政治迫害导致精英阶层出逃",minEra:4,trigger:"low_approval",baseMonthlyRate:.003,stratumWeights:{official:.25,merchant:.2,capitalist:.2,engineer:.15,artisan:.1,scribe:.1},approvalThreshold:25}},pu=(e,t,o)=>{const i=(e==null?void 0:e.wealth)||1e3,r=(o==null?void 0:o.silver)||1e3,a=i/Math.max(1,(e==null?void 0:e.population)||1e3);return(r/Math.max(1,(t==null?void 0:t.population)||1e3)-a)/Math.max(a,1)},hu=(e,t,o)=>!Ao("migration","economic_migration",o)||e.isAtWar||e.vassalOf==="player"?!1:t>.5,ts=(e,t,o)=>{var a,s;if(!Ao("migration","political_exile",o))return{canExile:!1};const i=es.political_exile.approvalThreshold;if((((s=(a=e.socialStructure)==null?void 0:a.elites)==null?void 0:s.satisfaction)||50)<40&&!e.isAtWar)return{canExile:!0,exileFrom:"foreign"};for(const[u,c]of Object.entries(t||{}))if(c<i)return{canExile:!0,exileFrom:"domestic",stratum:u};return{canExile:!1}},Sa=(e,t,o=1)=>{const i=es[e];if(!i)return{totalMigrants:0,byStratum:{}};const r=(t==null?void 0:t.population)||1e3,a=Math.floor(r*i.baseMonthlyRate*o),s={};let u=a;for(const[c,f]of Object.entries(i.stratumWeights)){const p=Math.floor(a*f);p>0&&(s[c]=p,u-=p)}if(u>0){const c=Object.keys(i.stratumWeights)[0];s[c]=(s[c]||0)+u}return{totalMigrants:a,byStratum:s}},mu=({nations:e,epoch:t,playerPopulation:o,playerResources:i,classApproval:r,daysElapsed:a,maxPop:s=1/0})=>{if(!Ao("migration","economic_migration",t)&&!Ao("migration","war_refugees",t)&&!Ao("migration","political_exile",t))return{immigrantsIn:0,emigrantsOut:0,byStratum:{},events:[]};let u=0,c=0;const f={},p=[],d={};let M=0;if(Array.isArray(e))for(const m of e){if(!m||m.id==="player")continue;const E=pu(m,{population:o},i);if(hu(m,E,t)){const g=Math.min(2,Math.max(.5,E)),_=Sa("economic_migration",m,g);_.totalMigrants>0&&(M+=_.totalMigrants,Object.entries(_.byStratum).forEach(([A,k])=>{d[A]=(d[A]||0)+k}),p.push({type:"economic_migration",sourceNation:m.name,amount:_.totalMigrants,day:a,isPotential:!0}))}if(m.foreignWars&&m.foreignWars.length>0&&Ao("migration","war_refugees",t)){const g=Sa("war_refugees",m,.5);g.totalMigrants>0&&(M+=g.totalMigrants,Object.entries(g.byStratum).forEach(([_,A])=>{d[_]=(d[_]||0)+A}),p.push({type:"war_refugees",sourceNation:m.name,amount:g.totalMigrants,day:a,isPotential:!0}))}const v=ts(m,r,t);if(v.canExile&&v.exileFrom==="foreign"){const g=Sa("political_exile",m,.3);g.totalMigrants>0&&(M+=g.totalMigrants,Object.entries(g.byStratum).forEach(([_,A])=>{d[_]=(d[_]||0)+A}),p.push({type:"political_exile",sourceNation:m.name,amount:g.totalMigrants,day:a,isPotential:!0}))}}const h=Math.max(0,s-o);let y=1;M>h&&(h<=0?(y=0,p.push({type:"info",message:"Border closed due to overpopulation."})):y=h/M),M>0&&(Object.entries(d).forEach(([m,E])=>{const v=Math.floor(E*y);v>0&&(f[m]=(f[m]||0)+v,u+=v)}),p.forEach(m=>{m.isPotential&&(m.amount=Math.floor(m.amount*y),delete m.isPotential)}));const x=ts({},r,t);if(x.canExile&&x.exileFrom==="domestic"){const m=x.stratum,v=(25-((r==null?void 0:r[m])||50))/25,g=Math.floor(o*.001*v);g>0&&(c+=g,f[m]=(f[m]||0)-g,p.push({type:"political_exile",direction:"out",stratum:m,amount:g,day:a}))}return{immigrantsIn:u,emigrantsOut:c,byStratum:f,events:p.filter(m=>m.amount>0||m.type==="info")}},gu=(e,t,o)=>{if(!e||!t)return e;const i={...e};return Object.entries(t).forEach(([r,a])=>{if(typeof a=="number"&&a!==0){const s=i[r]||0,u=Math.floor(s+a);i[r]=Math.max(0,u)}}),i},yu=e=>{if(!Array.isArray(e)||e.length===0)return[];const t=[],o={economic_migration:"经济移民",war_refugees:"战争难民",political_exile:"政治流亡"};for(const i of e){const r=o[i.type]||i.type;i.direction==="out"?t.push(`📤 ${r}：${i.amount}名${i.stratum||""}人口移居海外`):t.push(`📥 ${r}：${i.amount}人从${i.sourceNation}移入`)}return t},wt={BASE_STABILITY:50,MAX_STABILITY:100,MIN_STABILITY:0,THRESHOLDS:{VERY_STABLE:80,STABLE:60,UNSTABLE:40,VERY_UNSTABLE:20},FACTORS:{war:-15,warLosing:-10,economicDecline:-8,lowEliteSatisfaction:-5,lowCommonersSatisfaction:-8,lowUnderclassSatisfaction:-3,recentDefeat:-20,strongEconomy:5,peacetime:3,vassalStatus:-10}},si={BASE_DAILY_GROWTH:.2,STABILITY_COEFFICIENT:.02,REBELLION_THRESHOLD:100,RESET_VALUE:20,PLAYER_SUPPORT_BONUS:2},ko={MIN_DURATION:60,MAX_DURATION:365,REBEL_INITIAL_STRENGTH:.4,DAILY_CASUALTY_RATE:.02,FOREIGN_AID_MULTIPLIER:1.3,VICTORY_THRESHOLD:.2,ECONOMIC_DAMAGE_RATE:.01},Fn={monarchy:{name:"君主制",baseStability:55,rebellionRisk:.8,possibleSuccessors:["republic","constitutional_monarchy","military_junta"]},republic:{name:"共和制",baseStability:50,rebellionRisk:.7,possibleSuccessors:["monarchy","military_junta","theocracy"]},constitutional_monarchy:{name:"君主立宪制",baseStability:60,rebellionRisk:.6,possibleSuccessors:["republic","monarchy"]},military_junta:{name:"军政府",baseStability:45,rebellionRisk:1,possibleSuccessors:["republic","monarchy","dictatorship"]},theocracy:{name:"神权政治",baseStability:55,rebellionRisk:.9,possibleSuccessors:["republic","monarchy"]},dictatorship:{name:"独裁政权",baseStability:40,rebellionRisk:1.2,possibleSuccessors:["republic","military_junta"]}};function bu(e,t={}){const o=[];let i=e.baseStability||wt.BASE_STABILITY;if(e.isAtWar?(o.push({name:"战争中",value:wt.FACTORS.war}),i+=wt.FACTORS.war,(e.warScore||0)<-30&&(o.push({name:"战争失利",value:wt.FACTORS.warLosing}),i+=wt.FACTORS.warLosing)):(o.push({name:"和平时期",value:wt.FACTORS.peacetime}),i+=wt.FACTORS.peacetime),e.recentDefeatDay&&t.daysElapsed){const s=t.daysElapsed-e.recentDefeatDay;if(s<180){const u=wt.FACTORS.recentDefeat*(1-s/180);o.push({name:"近期战败",value:Math.round(u)}),i+=u}}const r=e.socialStructure||{};if(r.elites&&r.elites.satisfaction<40&&(o.push({name:"精英不满",value:wt.FACTORS.lowEliteSatisfaction}),i+=wt.FACTORS.lowEliteSatisfaction),r.commoners&&r.commoners.satisfaction<30&&(o.push({name:"平民不满",value:wt.FACTORS.lowCommonersSatisfaction}),i+=wt.FACTORS.lowCommonersSatisfaction),r.underclass&&r.underclass.satisfaction<20&&(o.push({name:"下层不满",value:wt.FACTORS.lowUnderclassSatisfaction}),i+=wt.FACTORS.lowUnderclassSatisfaction),e.economicGrowth!==void 0&&(e.economicGrowth<-5?(o.push({name:"经济衰退",value:wt.FACTORS.economicDecline}),i+=wt.FACTORS.economicDecline):e.economicGrowth>5&&(o.push({name:"经济繁荣",value:wt.FACTORS.strongEconomy}),i+=wt.FACTORS.strongEconomy)),(e.isVassal||e.overlordId)&&(o.push({name:"附庸状态",value:wt.FACTORS.vassalStatus}),i+=wt.FACTORS.vassalStatus),e.foreignDestabilization>0){const s=Math.min(e.foreignDestabilization,30);o.push({name:"外国颠覆",value:-s}),i-=s}if(e.foreignSupport>0){const s=Math.min(e.foreignSupport,20);o.push({name:"外国支持",value:s}),i+=s}i=Math.max(wt.MIN_STABILITY,Math.min(wt.MAX_STABILITY,i));let a="stable";return i>=wt.THRESHOLDS.VERY_STABLE?a="very_stable":i>=wt.THRESHOLDS.STABLE?a="stable":i>=wt.THRESHOLDS.UNSTABLE?a="unstable":i>=wt.THRESHOLDS.VERY_UNSTABLE?a="very_unstable":a="crisis",{value:Math.round(i),level:a,factors:o}}function Mu(e,t){let o=e.dissidentOrganization||0,i=0;if(t<50){const r=50-t;i=si.BASE_DAILY_GROWTH*(1+r*si.STABILITY_COEFFICIENT),e.playerSupportingRebels&&(i*=si.PLAYER_SUPPORT_BONUS),o+=i}else t>60&&(i=-.3,o=Math.max(0,o+i));return{value:Math.min(o,si.REBELLION_THRESHOLD*1.5),dailyChange:i,rebellionProgress:Math.min(100,o/si.REBELLION_THRESHOLD*100)}}function vu(e){const t=e.dissidentOrganization||0;if(t>=si.REBELLION_THRESHOLD){let o=.1;const i=t-si.REBELLION_THRESHOLD;return o+=i*.02,e.playerSupportingRebels&&(o*=1.5),Math.random()<o}return!1}function wu(e,t){const o=os(e),i=o*ko.REBEL_INITIAL_STRENGTH,r=ko.MIN_DURATION+Math.random()*(ko.MAX_DURATION-ko.MIN_DURATION);return{isInCivilWar:!0,civilWarStartDay:t,civilWarData:{governmentStrength:o,rebelStrength:i,governmentSupport:[],rebelSupport:[],casualties:{government:0,rebels:0,civilian:0},economicDamage:0,estimatedDuration:Math.round(r)},dissidentOrganization:si.RESET_VALUE}}function os(e){const t=e.wealth||1e3,o=e.militaryTradition||50;return Math.round(t*.5+o*10)}function xu(e,t){if(!e.isInCivilWar||!e.civilWarData)return null;const o={...e.civilWarData},i=t-e.civilWarStartDay;let r=1,a=1;o.governmentSupport.length>0&&(r*=ko.FOREIGN_AID_MULTIPLIER),o.rebelSupport.length>0&&(a*=ko.FOREIGN_AID_MULTIPLIER);const s=o.governmentStrength*r,u=o.rebelStrength*a,c=s+u,f=o.governmentStrength*ko.DAILY_CASUALTY_RATE*(u/c),p=o.rebelStrength*ko.DAILY_CASUALTY_RATE*(s/c);o.governmentStrength=Math.max(0,o.governmentStrength-f),o.rebelStrength=Math.max(0,o.rebelStrength-p),o.casualties.government+=f,o.casualties.rebels+=p,o.casualties.civilian+=(f+p)*.5;const d=(e.wealth||1e3)*ko.ECONOMIC_DAMAGE_RATE;o.economicDamage+=d;const M=os(e),h=M*ko.REBEL_INITIAL_STRENGTH;let y=null;return o.governmentStrength<M*ko.VICTORY_THRESHOLD?y={winner:"rebels",warDuration:i,casualties:o.casualties,economicDamage:o.economicDamage}:o.rebelStrength<h*ko.VICTORY_THRESHOLD&&(y={winner:"government",warDuration:i,casualties:o.casualties,economicDamage:o.economicDamage}),{civilWarData:o,result:y,wealthLoss:d}}function Eu(e,t,o){const i={isInCivilWar:!1,civilWarData:null,civilWarEndDay:o};if(t==="rebels"){const r=e.governmentType||"monarchy",s=(Fn[r]||Fn.monarchy).possibleSuccessors||["republic"],u=s[Math.floor(Math.random()*s.length)];i.governmentType=u,i.previousGovernmentType=r,i.regimeChangeDay=o;const c=Fn[u]||Fn.republic;i.baseStability=c.baseStability,i.stability=c.baseStability-10,i.relationResetPending=!0,i.treaties=[],(e.isVassal||e.overlordId)&&(i.isVassal=!1,i.overlordId=null,i.vassalType=null,i.independenceWar=!1,i.becameIndependentDay=o),i.wealth=Math.max(100,(e.wealth||1e3)*.5),i.socialStructure=Cu(u)}else i.stability=Math.min(60,(e.stability||40)+10),i.dissidentOrganization=10,i.wealth=Math.max(100,(e.wealth||1e3)*.7);return i}function Cu(e){const t={elites:{ratio:.1,satisfaction:40,influence:.4},commoners:{ratio:.8,satisfaction:35,influence:.4},underclass:{ratio:.1,satisfaction:30,influence:.2}};return e==="republic"?(t.commoners.satisfaction+=10,t.elites.satisfaction-=5):e==="military_junta"&&(t.elites.satisfaction+=5,t.commoners.satisfaction-=10),t}function _u(e,t){const{daysElapsed:o=0}=t,i=[],r=[];for(const a of e){if(!a||a.isPlayer)continue;const s={id:a.id},u=bu(a,t);if(s.stability=u.value,s.stabilityLevel=u.level,s.stabilityFactors=u.factors,a.isInCivilWar){const c=xu(a,o);if(c&&(s.civilWarData=c.civilWarData,s.wealth=Math.max(0,(a.wealth||0)-c.wealthLoss),c.result)){const f=Eu(a,c.result.winner,o);Object.assign(s,f),r.push({type:"civil_war_ended",nationId:a.id,nationName:a.name,winner:c.result.winner,newGovernment:f.governmentType,day:o})}}else{const c=Mu(a,u.value);if(s.dissidentOrganization=c.value,s.dissidentDailyChange=c.dailyChange,s.rebellionProgress=c.rebellionProgress,vu({...a,...s})){const f=wu(a,o);Object.assign(s,f),r.push({type:"civil_war_started",nationId:a.id,nationName:a.name,day:o})}}a.foreignSupport>0&&(s.foreignSupport=Math.max(0,a.foreignSupport-.5)),a.foreignDestabilization>0&&(s.foreignDestabilization=Math.max(0,a.foreignDestabilization-.3)),i.push(s)}return{updates:i,events:r}}const Tu={config:{transportCostRate:.15}};function is(e,t,o=0){const i=e==null?void 0:e.treaties;if(!i)return!1;if(Array.isArray(i))return i.some(a=>!a||a.type!==t||a.withPlayer===!1?!1:a.status==="active"||!a.status&&(a.endDay==null||a.endDay>o));const r=i[t];return!r||r.withPlayer===!1?!1:r.status==="active"||!r.status&&(r.endDay==null||r.endDay>o)}function ns(e,t=[]){return!t||!e?!1:t.some(o=>o.type==="economic_bloc"&&o.isActive&&o.members&&o.members.includes(e.id)&&o.members.includes("player"))}function as(e,t,o,i={}){var D;const r=Vt.find(P=>P.id===e.buildingId);if(!r)return{outputValue:0,inputCost:0,wageCost:0,businessTaxCost:0,profit:0,transportCost:0};const a=e.strategy||"PROFIT_MAX",s=Tu.config.transportCostRate,u=P=>{var T,I,V,N;return(N=(V=(I=(((T=t.market)==null?void 0:T.prices)||{})[P])!=null?I:(t.nationPrices||{})[P])!=null?V:(t.prices||{})[P])!=null?N:rs(P)},c=P=>{var T;return(T=i[P])!=null?T:rs(P)},f=(P,T)=>{const I=(t.inventories||{})[P]||0;if(I>0)return I;const V=Math.max(.5,(t.wealth||1e3)/2e3);return Math.floor(T*2*V)};let p=0,d=0,M=!0;const h={},y={},x={inputs:{},outputs:{}};if(Object.entries(r.input||{}).forEach(([P,T])=>{const I=u(P),V=c(P),N=V*(1+s);let L=!0;if(a==="PROFIT_MAX"?N<I&&(L=!1):(a==="MARKET_DUMPING"||a==="RESOURCE_EXTRACTION"&&N<I*.8)&&(L=!1),x.inputs[P]=L?"local":"home",L)f(P,T)<T&&(M=!1),p+=T*I,M&&(h[P]=(h[P]||0)-T);else{const W=T*V;p+=W,d+=W*s,y[P]=(y[P]||0)-T}}),!M)return{outputValue:0,inputCost:0,wageCost:0,businessTaxCost:0,profit:0,transportCost:0,inputAvailable:!1,decisions:x};let m=0;Object.entries(r.output||{}).forEach(([P,T])=>{if(P==="maxPop"||P==="militaryCapacity")return;const I=u(P),V=c(P),N=V*(1-s);let L=!0;if(a==="PROFIT_MAX"?N>I&&(L=!1):a==="RESOURCE_EXTRACTION"?L=!1:a==="MARKET_DUMPING"&&(L=!0),x.outputs[P]=L?"local":"home",L)m+=T*I,h[P]=(h[P]||0)+T;else{const W=T*V,j=W*s;m+=W-j,d+=j,y[P]=(y[P]||0)+T}});const{total:E,breakdown:v}=Au(r,t),A=((D=r.businessTaxBase)!=null?D:.1)*1,k=m-p-E-A;return{outputValue:m,inputCost:p,wageCost:E,wageBreakdown:v,businessTaxCost:A,transportCost:d,profit:k,inputAvailable:!0,localResourceChanges:h,playerResourceChanges:y,decisions:x}}const Pu={elites:15,commoners:3,underclass:1};function Au(e,t){var u,c;if(!e.jobs)return{total:0,breakdown:[]};const o=((u=t==null?void 0:t.vassalPolicy)==null?void 0:u.labor)||"standard",i=cc(o);let r=0;const a=[],s=((c=t.market)==null?void 0:c.prices)||t.prices||{};return Object.entries(e.jobs).forEach(([f,p])=>{const d=ae[f];if(!d){console.log(`[Overseas] Missing stratum config for ${f}. STRATA keys: ${Object.keys(ae||{})}`);return}let M=0;d.needs&&Object.entries(d.needs).forEach(([v,g])=>{var A;const _=s[v]||((A=Oe[v])==null?void 0:A.basePrice)||1;M+=g*_});const h=Pu[f]||1,y=M*h;let x=1;if(t.socialStructure&&t.socialStructure[f]){const v=t.socialStructure[f].population||1e3;v<500?x=1.5:v>1e4&&(x=.8),(t.socialStructure[f].sol||1)>h&&(x*=1.1)}const m=y*x*i,E=p*m;r+=E,a.push({stratumId:f,count:p,wagePerWorker:m,total:E,laborPolicy:o,laborMultiplier:i,baseWage:y,supplyFactor:x})}),{total:r,breakdown:a}}function rs(e){const t=Oe[e];return(t==null?void 0:t.basePrice)||1}function Ru({overseasInvestments:e=[],nations:t=[],organizations:o=[],resources:i={},marketPrices:r={},classWealth:a={},daysElapsed:s=0}){const u=[];let c=0;const f={},p=[],d={},M={};return e.forEach(h=>{var V,N,L,W,j;if(h.status!=="operating"){p.push(h);return}const y=t.find(H=>H.id===h.targetNationId);if(!y){p.push({...h,status:"suspended"});return}if(y.isAtWar&&y.warTarget==="player"){const H={...h};H.operatingData={...H.operatingData},u.push(`⚠️ 与 ${y.name} 处于战争状态，海外投资利润被冻结`),p.push(H);return}const x=as(h,y,i,r);x.localResourceChanges&&(d[h.targetNationId]||(d[h.targetNationId]={}),Object.entries(x.localResourceChanges).forEach(([H,ce])=>{d[h.targetNationId][H]=(d[h.targetNationId][H]||0)+ce})),x.playerResourceChanges&&Object.entries(x.playerResourceChanges).forEach(([H,ce])=>{M[H]=(M[H]||0)+ce});let m=.6;const E=y.vassalOf==="player",v=is(y,"investment_pact",s),g=ns(y,o);if(E){const H=ar[y.vassalType];m=.25*(1-(((V=H==null?void 0:H.economicPrivileges)==null?void 0:V.profitTaxExemption)||0))}else g?m=.1:v?m=.25:m=.6;const _=x.profit>0?x.profit*m:0,A=x.profit-_,k=_,D={...h},P=[...((N=h.operatingData)==null?void 0:N.profitHistory)||[]];P.push({day:s,profit:x.profit,repatriated:A}),P.length>30&&P.shift();const I=A<=0?(((L=D.operatingData)==null?void 0:L.consecutiveLossDays)||0)+1:0;if(I>=30){let H=.01;const ce=(I-30)*.005;if(H+=ce,x.profit<0){const me=Math.abs(x.profit)/(D.investmentAmount||1e3);H+=me}if(H=Math.min(.5,H),Math.random()<H){u.push(`📉 由于长期入不敷出（${I}天），${((W=ae[D.ownerStratum])==null?void 0:W.name)||"业主"}决定关闭在 ${y.name} 的 ${(j=Vt.find(U=>U.id===D.buildingId))==null?void 0:j.name}。`);const me=(D.investmentAmount||0)*.1;f[D.ownerStratum]=(f[D.ownerStratum]||0)+me;return}}D.operatingData={...D.operatingData,...x,repatriatedProfit:A,retainedProfit:k,profitHistory:P,consecutiveLossDays:I},c+=A,f[h.ownerStratum]=(f[h.ownerStratum]||0)+A,p.push(D)}),s%30===0&&c>0&&(u.push(`💰 海外投资本月利润汇回: ${c.toFixed(1)} 银币`),Object.entries(f).forEach(([h,y])=>{y>0&&u.push(`  • ${h}阶层: +${y.toFixed(1)}`)})),{updatedInvestments:p,totalProfit:c,profitByStratum:f,logs:u,marketChanges:d,playerInventoryChanges:M}}function Su(e,t){const o={totalValue:0,estimatedMonthlyProfit:0,estimatedDailyProfit:0,byNation:{},byStratum:{},count:0};return!e||!Array.isArray(e)||e.forEach(i=>{var s;if(i.status!=="operating")return;o.count++,o.totalValue+=i.investmentAmount||0;const r=((s=i.operatingData)==null?void 0:s.profit)||0,a=r*30;o.estimatedDailyProfit+=r,o.estimatedMonthlyProfit+=a,o.byNation[i.targetNationId]||(o.byNation[i.targetNationId]={count:0,value:0,profit:0,dailyProfit:0}),o.byNation[i.targetNationId].count++,o.byNation[i.targetNationId].value+=i.investmentAmount||0,o.byNation[i.targetNationId].profit+=a,o.byNation[i.targetNationId].dailyProfit+=r,o.byStratum[i.ownerStratum]||(o.byStratum[i.ownerStratum]={count:0,value:0,profit:0,dailyProfit:0}),o.byStratum[i.ownerStratum].count++,o.byStratum[i.ownerStratum].value+=i.investmentAmount||0,o.byStratum[i.ownerStratum].profit+=a,o.byStratum[i.ownerStratum].dailyProfit+=r}),o}function Iu({foreignInvestments:e=[],nations:t=[],organizations:o=[],playerMarket:i={},playerResources:r={},foreignInvestmentPolicy:a="normal",daysElapsed:s=0,jobFill:u={},buildings:c={}}){const f=[];let p=0,d=0;const M=[],h={};return e.forEach(y=>{var le,we;if(y.status!=="operating"){M.push(y);return}const x=Vt.find(ue=>ue.id===y.buildingId);if(!x){M.push(y);return}const m=t.find(ue=>ue.id===y.ownerNationId),E=((le=m==null?void 0:m.market)==null?void 0:le.prices)||(m==null?void 0:m.nationPrices)||(m==null?void 0:m.prices)||{},v=(m==null?void 0:m.inventories)||{},g={market:i,inventories:r,wealth:1e4,vassalPolicy:{labor:"standard"}},_={...y,strategy:y.strategy||"PROFIT_MAX"},A=as(_,g,v,E),k=x.jobs||{},D=c[x.id]||0,P=u[x.id]||{};let T=0,I=0;Object.entries(k).forEach(([ue,Ie])=>{const de=Ie*D;T+=de,I+=Math.min(P[ue]||0,de)});let V=1;T>0&&D>0&&(V=I/T);const N=A.profit||0,L=N*V;let W=.6;const j=m&&m.vassalOf==="player",H=m?is(m,"investment_pact",s):!1,ce=ns(m,o);j?(W=.25,ce&&(W=.1)):ce?W=.1:H?W=.25:W=.6;const me=L>0?L*W:0,U=L>0?L*(1-W):0;p+=me,d+=U,A.localResourceChanges&&Object.entries(A.localResourceChanges).forEach(([ue,Ie])=>{h[ue]=(h[ue]||0)+Ie});const ye=U<=0?(((we=y.operatingData)==null?void 0:we.consecutiveLossDays)||0)+1:0;if(ye>=30){let ue=.01;const Ie=(ye-30)*.005;if(ue+=Ie,L<0&&(ue+=Math.abs(L)/1e3),ue=Math.min(.5,ue),Math.random()<ue){f.push(`📉 ${(m==null?void 0:m.name)||"外资"} 因长期亏损（${ye}天），撤出了在我国的 ${x.name} 投资。`);return}}const te=x.jobs?Object.values(x.jobs).reduce((ue,Ie)=>ue+Ie,0):0;M.push({..._,dailyProfit:L,jobsProvided:te,operatingData:{...A,taxPaid:me,profitRepatriated:U,consecutiveLossDays:ye,staffingRatio:V,theoreticalProfit:N,profit:L}})}),s%30===0&&e.length>0&&f.push(`🏭 外资月报: 税收+${(p*30).toFixed(0)}, 利润外流-${(d*30).toFixed(0)}`),{updatedInvestments:M,taxRevenue:p,profitOutflow:d,logs:f,marketChanges:h}}function ku({foreignInvestments:e=[],nations:t=[],playerMarket:o={},playerResources:i={},buildingUpgrades:r={},buildingCounts:a={},daysElapsed:s=0}){const u=[],c=[],f=[...e],p=60,d=.03,M=.05,h=1e4;return e.forEach((y,x)=>{var U,X,ye;if(y.status!=="operating")return;const m=y.lastUpgradeDay||0;if(s-m<p||Math.random()>d)return;const E=Vt.find(te=>te.id===y.buildingId);if(!E)return;const v=kn(E.id);if(v<=0)return;const g=t.find(te=>te.id===y.ownerNationId),_=(g==null?void 0:g.wealth)||0;if(_<h)return;const A=y.upgradeLevel||0;if(A>=v)return;const k=A+1,D=((U=g==null?void 0:g.market)==null?void 0:U.prices)||(g==null?void 0:g.prices)||{},P=Dn(E.id,k,0);if(!P)return;let T=0;for(const[te,le]of Object.entries(P))if(te==="silver")T+=le;else{const we=D[te]||((X=o==null?void 0:o.prices)==null?void 0:X[te])||((ye=Oe[te])==null?void 0:ye.basePrice)||1;T+=le*we}const I=_*.3;if(T>I)return;const V=Nt(E,A),N=Nt(E,k),L=Un(E,V,o),W=Un(E,N,o),j=W-L;if(j<=0)return;const ce=j*365/T;if(ce<M)return;tn("overseas",`🏭 [外资升级] ${(g==null?void 0:g.name)||"外国"} 升级 ${E.name} Lv${A} → Lv${k}，花费 ${T.toFixed(0)}，预计ROI ${(ce*100).toFixed(1)}%`),c.push({investmentId:y.id,investmentIndex:x,buildingId:E.id,fromLevel:A,toLevel:k,cost:T,ownerNationId:y.ownerNationId,profitGain:j,roi:ce}),f[x]={...y,upgradeLevel:k,lastUpgradeDay:s,dailyProfit:W};const me=(g==null?void 0:g.name)||"外国";u.push(`🏭 ${me}升级了在本国的 ${E.name}（Lv${A} → Lv${k}，花费 ${Math.ceil(T)} 银）`)}),{updatedInvestments:f,upgrades:c,logs:u}}function Un(e,t,o){const i=(o==null?void 0:o.prices)||{};let r=0;const a=(t==null?void 0:t.output)||e.output||{};Object.entries(a).forEach(([p,d])=>{var h;if(p==="maxPop"||p==="militaryCapacity")return;const M=i[p]||((h=Oe[p])==null?void 0:h.basePrice)||1;r+=d*M});let s=0;const u=(t==null?void 0:t.input)||e.input||{};Object.entries(u).forEach(([p,d])=>{var h;const M=i[p]||((h=Oe[p])==null?void 0:h.basePrice)||1;s+=d*M});let c=0;const f=(t==null?void 0:t.jobs)||e.jobs||{};return Object.entries(f).forEach(([p,d])=>{e.owner&&p===e.owner||(c+=d*10)}),r-s-c}function Du({overseasInvestments:e=[],nations:t=[],classWealth:o={},marketPrices:i={},daysElapsed:r=0}){const a=[],s=[],u=[...e],c={},f=60,p=.03,d=.05,M=1e4;return e.forEach((h,y)=>{var X,ye;if(h.status!=="operating")return;const x=h.lastUpgradeDay||0;if(r-x<f||Math.random()>p)return;const m=Vt.find(te=>te.id===h.buildingId);if(!m)return;const E=kn(m.id);if(E<=0)return;const v=h.ownerStratum||"capitalist",g=o[v]||0;if(g<M)return;const _=h.upgradeLevel||0;if(_>=E)return;const A=_+1,k=t.find(te=>te.id===h.targetNationId),D=((X=k==null?void 0:k.market)==null?void 0:X.prices)||(k==null?void 0:k.prices)||{},P=Dn(m.id,A,0);if(!P)return;let T=0;for(const[te,le]of Object.entries(P))if(te==="silver")T+=le;else{const we=i[te]||1;T+=le*we}const I=g*.2;if(T>I)return;const V=Nt(m,_),N=Nt(m,A),L=Un(m,V,{prices:D}),W=Un(m,N,{prices:D}),j=W-L;if(j<=0)return;const ce=j*365/T;if(ce<d)return;const me=(k==null?void 0:k.name)||"海外";tn("overseas",`🏭 [海外升级] ${v} 升级 ${me} 的 ${m.name} Lv${_} → Lv${A}，花费 ${T.toFixed(0)}，预计ROI ${(ce*100).toFixed(1)}%`),s.push({investmentId:h.id,investmentIndex:y,buildingId:m.id,fromLevel:_,toLevel:A,cost:T,ownerStratum:v,targetNationId:h.targetNationId,profitGain:j,roi:ce}),u[y]={...h,upgradeLevel:A,lastUpgradeDay:r,dailyProfit:W},c[v]=(c[v]||0)-T;const U=((ye=ae[v])==null?void 0:ye.name)||v;a.push(`🏭 ${U}升级了在 ${me} 的 ${m.name}（Lv${_} → Lv${A}，花费 ${Math.ceil(T)} 银）`)}),{updatedInvestments:u,upgrades:s,wealthChanges:c,logs:a}}const Wu=({tradeRoutes:e,nations:t,resources:o,daysElapsed:i,market:r,popStructure:a,taxPolicies:s,diplomacyOrganizations:u})=>{const c=(e==null?void 0:e.routes)||[];if(!c.length)return null;const f=(u==null?void 0:u.organizations)||[],p=D=>f.find(P=>Array.isArray(P==null?void 0:P.members)&&P.members.includes("player")&&P.members.includes(D)),d=(D,P)=>{var V,N,L,W;let T=0;const I=p(D);if(I&&(T=Math.max(T,((V=Ma[I.type])==null?void 0:V.tariffDiscount)||0)),P&&P.vassalOf==="player"){const j=(N=P.vassalPolicy)==null?void 0:N.tradePolicy,H=((L=nr[j])==null?void 0:L.tariffDiscount)||0,ce=((W=ar[P.vassalType])==null?void 0:W.tariffDiscount)||0;T=Math.max(T,H,ce)}return T},M=(D,P)=>{var V,N;if(!D||D.vassalOf!=="player")return 1;const T=(V=D.vassalPolicy)==null?void 0:V.tradePolicy,I=((N=nr[T])==null?void 0:N.playerPriceMod)||0;return P==="import"?1+Math.min(0,I):1+Math.max(0,I)},h=.05,y=.1,x=(a==null?void 0:a.merchant)||0,m=[],E=[];let v=0;const g={},_={},A=(D,P)=>{!Number.isFinite(P)||P===0||(g[D]=(g[D]||0)+P)},k=(D,P)=>{!D||!P||(_[D]||(_[D]={budget:0,relation:0,inventory:{}}),Number.isFinite(P.budget)&&(_[D].budget+=P.budget),Number.isFinite(P.relation)&&(_[D].relation+=P.relation),P.inventory&&Object.entries(P.inventory).forEach(([T,I])=>{!Number.isFinite(I)||I===0||(_[D].inventory[T]=(_[D].inventory[T]||0)+I)}))};return c.forEach((D,P)=>{var te,le,we,ue,Ie,de,Y,Re,Qe,Le,_t,K,_e,fe;const{nationId:T,resource:I,type:V}=D,N=t.find(He=>He.id===T);if(!N){m.push(D);return}if(P>=x||N.isAtWar)return;const L=Wi(I,N,i),W=(we=(te=r==null?void 0:r.prices)==null?void 0:te[I])!=null?we:((le=Oe[I])==null?void 0:le.basePrice)||1,j=wr(I,N,i),H=(D==null?void 0:D.mode)||"normal",ce=H==="force_sell",me=H==="force_buy",U=!!(N!=null&&N.openMarketUntil&&i<N.openMarketUntil),X=_a(N,i),ye=U||X.allowForceTrade||X.bypassRelationCap;if(V==="export"){if(!ce&&(!L.isShortage||L.shortageAmount<=0))return;const He=(o[I]||0)+(g[I]||0),Xe=Math.max(0,He-500);if(Xe<=y)return;const Zt=Math.max(0,L.shortageAmount||0),Ke=(ce?Xe:Math.min(Xe,Zt))*h;if(Ke<y)return;const Tt=W*Ke,Ht=((ue=s==null?void 0:s.resourceTaxRates)==null?void 0:ue[I])||0,Fo=(Re=(Y=(Ie=s==null?void 0:s.exportTariffMultipliers)==null?void 0:Ie[I])!=null?Y:(de=s==null?void 0:s.resourceTariffMultipliers)==null?void 0:de[I])!=null?Re:0,Xo=d(T,N),Dt=Fo*(1-Xo),Ee=Ht+Dt,lt=Tt*Ee;let kt=ce?j*.6:j;kt*=M(N,"export");const yt=kt*Ke;if(yt-Tt-lt<=0)return;A(I,-Ke),v+=lt,k(T,{budget:-yt,relation:ce?ye?.2:-.6:.2,inventory:{[I]:Ke}})}else if(V==="import"){if(!me&&(!L.isSurplus||L.surplusAmount<=0))return;const He=Math.max(0,L.surplusAmount||0),ie=Math.max(10,L.target||0),Zt=(me?ie:He)*h;if(Zt<y)return;let Ke=me?j*1.3:j;Ke*=M(N,"import");const Tt=Ke*Zt,Ht=W*Zt,Fo=((Qe=s==null?void 0:s.resourceTaxRates)==null?void 0:Qe[I])||0,Xo=(_e=(K=(Le=s==null?void 0:s.importTariffMultipliers)==null?void 0:Le[I])!=null?K:(_t=s==null?void 0:s.resourceTariffMultipliers)==null?void 0:_t[I])!=null?_e:0,Dt=d(T,N),Ee=Xo*(1-Dt),lt=Fo+Ee,ht=Ht*lt,kt=Ht-Tt-ht;if(kt<=0)return;A(I,Zt),v+=ht,k(T,{budget:Tt,relation:me?ye?.2:-.6:.2,inventory:{[I]:-Zt}}),Zt>=1&&!me&&E.push(`🚢 进口 ${Zt.toFixed(1)} ${((fe=Oe[I])==null?void 0:fe.name)||I} 从 ${N.name}：商人国外购 ${Tt.toFixed(1)} 银币，国内售 ${Ht.toFixed(1)} 银币（税 ${ht.toFixed(1)}），商人赚 ${kt.toFixed(1)} 银币。`)}}),{tradeTax:v,resourceDelta:g,nationDelta:_,routesToRemove:m,tradeLog:E}},Bu=e=>ac[e]||e,Ou=(e,t)=>!Number.isFinite(e==null?void 0:e.endDay)||t<e.endDay,ju=({nation:e,tick:t,resources:o,logs:i,onTreasuryChange:r})=>{const a=Array.isArray(e.treaties)?e.treaties:[],s=[],u=[];let c=0;if(a.forEach(f=>{Ou(f,t)?(s.push(f),f.direction==="player_to_ai"&&Number.isFinite(f.maintenancePerDay)&&(c+=Math.max(0,f.maintenancePerDay))):u.push(f)}),u.length>0&&u.forEach(f=>{i.push(`Treaty with ${e.name} expired (${Bu(f.type)}).`)}),c>0&&o){const f=o.silver||0,p=Math.max(0,Math.min(f,c));o.silver=f-p,typeof r=="function"&&p>0&&r(-p,"treaty_maintenance"),e.budget=(e.budget||0)+p,e.wealth=(e.wealth||0)+p}e.treaties=s},Nu=({resources:e,buildings:t,population:o,popStructure:i={},birthAccumulator:r=0,decrees:a,gameSpeed:s,epoch:u,market:c,classWealth:f,classApproval:p={},activeBuffs:d=[],activeDebuffs:M=[],taxPolicies:h,army:y={},militaryWageRatio:x=1,militaryQueue:m=[],nations:E=[],diplomacyOrganizations:v=null,tick:g=0,techsUnlocked:_=[],activeFestivalEffects:A=[],classWealthHistory:k,classNeedsHistory:D,merchantState:P={pendingTrades:[],lastTradeTime:0},tradeRouteTax:T=0,maxPopBonus:I=0,eventApprovalModifiers:V={},eventStabilityModifier:N=0,currentStability:L=50,eventResourceDemandModifiers:W={},eventStratumDemandModifiers:j={},eventBuildingProductionModifiers:H={},livingStandardStreaks:ce={},buildingUpgrades:me={},rulingCoalition:U=[],previousLegitimacy:X=0,migrationCooldowns:ye={},difficulty:te,officials:le=[],activeDecrees:we,officialsPaid:ue=!0,quotaTargets:Ie={},expansionSettings:de={},cabinetStatus:Y={},priceControls:Re=null,previousTaxShock:Qe={},eventEffectSettings:Le={},foreignInvestments:_t=[],overseasInvestments:K=[],tradeRoutes:_e={},foreignInvestmentPolicy:fe="normal",tradeOpportunities:He=null})=>{var Ns,Ls,Fs,Us,$s,Gs,qs,Vs,Hs,Ys,zs,Xs,Js,Zs,Qs,Ks,ec,tc,oc,ic,nc;const ie={...e},Xe={...(c==null?void 0:c.prices)||{}};let Zt=0,Ye=null;_e&&_e.routes&&_e.routes.length>0&&(Ye=Wu({tradeRoutes:_e,nations:E,resources:ie,daysElapsed:g,market:{prices:Xe},popStructure:i,taxPolicies:h,diplomacyOrganizations:v}),Ye&&(Zt=Ye.tradeTax||0));const Ke=new Map,Tt={record:(n,l)=>{if(!Number.isFinite(n)||n===0)return;const b=l||"unknown";Ke.set(b,(Ke.get(b)||0)+n)},push:n=>{if(!n||!Number.isFinite(n.amount)||n.amount===0)return;const l=n.reason||"unknown";Ke.set(l,(Ke.get(l)||0)+n.amount)},toArray:()=>Array.from(Ke.entries()).map(([n,l])=>({amount:l,reason:n})),get length(){return Ke.size}},Ht=(n,l)=>{Tt.record(n,l)},Fo={},Xo=(n,l,b)=>{Fo[n]||(Fo[n]=[]),Fo[n].push({amount:l,reason:b,balance:ie[n]||0})},Dt=(n,l,b)=>{l!==0&&(ie[n]=(ie[n]||0)+l,Xo(n,l,b),n==="silver"&&Ht(l,b))},Ee=(n,l)=>{Dt("silver",n,l)},lt=Zt;Ye&&Ye.resourceDelta&&Object.entries(Ye.resourceDelta).forEach(([n,l])=>{Dt(n,l,"trade_route_transaction")});const ht=(n,l,b)=>{Dt(b,n,l)},kt={},yt=ie.silver||0;let Kt=[...K],ro=[..._t],Jo=[];const so={},bt={},eo={},ss={};Object.keys(ae).length>0&&Object.keys(ae).forEach(n=>{bt[n]={income:{wage:0,ownerRevenue:0,subsidy:0,salary:0,militaryPay:0,tradeImportRevenue:0,layoffTransfer:0},expense:{headTax:0,transactionTax:0,businessTax:0,tariffs:0,essentialNeeds:{},luxuryNeeds:{},decay:0,productionCosts:0,wages:0,tradeExportPurchase:0,capitalFlight:0,buildingCost:0,layoffTransfer:0}}});const $n=(E||[]).some(n=>n.isAtWar===!0),cs=3,Yt=h||{},ls=Yt.headTaxRates||{},us=Yt.resourceTaxRates||{},Lu=Yt.businessTaxRates||{},Gn=U0(Xe,ls,us);Nn(Gn,(Ut==null?void 0:Ut.price)||{});const Zo=Nn(Gn,(Ut==null?void 0:Ut.wage)||{}),bi=(c==null?void 0:c.wages)||{},sn=n=>{const l=Zo==null?void 0:Zo[n];return!Number.isFinite(l)||l<=0?Bn*.8:Math.max(Bn*.8,l*1.1)},bo=n=>{var w;const l=bi==null?void 0:bi[n];if(Number.isFinite(l)&&l>0)return Math.max(Oi,l);const b=(w=ae[n])==null?void 0:w.startingWealth;return Number.isFinite(b)&&b>0?Math.max(Bn*.5,b/40,sn(n)):Math.max(ef,sn(n))},Mo={},cn={},Do={},je=tl(f),ci=n=>Nr(n,ls),Li=n=>{const l=us[n];return typeof l=="number"?l:0},Fu=n=>{const l=Lu[n];return typeof l=="number"?l:1},Gt=F0(),nt=new G0({resources:ie,wealth:je,officials:le,classFinancialData:bt,taxBreakdown:Gt,silverChangeLog:Tt,buildingFinancialData:eo,classWealthChangeLog:kt},{safeWealth:Qi}),B=rl();if(K.length>0){const n=Ru({overseasInvestments:K,nations:E,organizations:(v==null?void 0:v.organizations)||[],resources:ie,marketPrices:Xe,classWealth:je,daysElapsed:g});Kt=n.updatedInvestments,Jo.push(...n.logs),n.profitByStratum&&Object.entries(n.profitByStratum).forEach(([b,w])=>{w>0&&(je[b]=(je[b]||0)+w,bt[b]&&(bt[b].income.ownerRevenue=(bt[b].income.ownerRevenue||0)+w))}),n.playerInventoryChanges&&Object.entries(n.playerInventoryChanges).forEach(([b,w])=>{Dt(b,w,"overseas_investment_return")}),n.marketChanges&&Object.entries(n.marketChanges).forEach(([b,w])=>{const C=E.find(S=>S.id===b);C&&C.inventory&&Object.entries(w).forEach(([S,q])=>{C.inventory[S]=Math.max(0,(C.inventory[S]||0)+q)})});const l=Du({overseasInvestments:Kt,nations:E,classWealth:je,marketPrices:Xe,daysElapsed:g});l.upgrades&&l.upgrades.length>0&&(Kt=l.updatedInvestments,Jo.push(...l.logs),l.wealthChanges&&Object.entries(l.wealthChanges).forEach(([b,w])=>{je[b]=Math.max(0,(je[b]||0)+w)}))}Y.effects&&(Y.effects.adminEfficiency&&(B.taxEfficiencyBonus=(B.taxEfficiencyBonus||0)+Y.effects.adminEfficiency),Y.effects.stabilityMod&&(B.stabilityBonus=(B.stabilityBonus||0)+Y.effects.stabilityMod),Y.effects.tradeBonusMod&&(B.tradeBonusMod=(B.tradeBonusMod||0)+Y.effects.tradeBonusMod),Y.effects.diplomaticRelationsMod&&(B.diplomaticBonus=(B.diplomaticBonus||0)+Y.effects.diplomaticRelationsMod),Y.effects.approvalBonus&&Object.entries(Y.effects.approvalBonus).forEach(([n,l])=>{B.stanceApprovalEffects=B.stanceApprovalEffects||{},B.stanceApprovalEffects[n]=(B.stanceApprovalEffects[n]||0)+l}),Y.effects.organizationGrowthMod&&(B.organizationGrowthMod=(B.organizationGrowthMod||0)+Y.effects.organizationGrowthMod),Y.effects.researchSpeed&&(B.scienceBonus=(B.scienceBonus||0)+Y.effects.researchSpeed)),Y.decreeEffects&&zo(Y.decreeEffects,B);const ut=Tl(le,ue),Uu={...ut,passive:ut.passiveGains,passivePercent:ut.passivePercentGains,resourceDemandMod:ut.decreeResourceDemandMod,stratumDemandMod:ut.decreeStratumDemandMod,maxPop:ut.extraMaxPop,incomePercent:ut.incomePercentBonus};zo(Uu,B),ut.researchSpeed&&(B.scienceBonus=(B.scienceBonus||0)+ut.researchSpeed),B.taxEfficiencyBonus=ut.taxEfficiency||0,B.corruption=ut.corruption||0,ut.incomePercentBonus&&(B.incomePercentBonus=(B.incomePercentBonus||0)+ut.incomePercentBonus),B.populationGrowthBonus=ut.populationGrowth||0,B.militaryUpkeepMod=ut.militaryUpkeep||0,B.tradeBonusMod=ut.tradeBonus||0,B.buildingCostMod=ut.buildingCostMod||0,B.wartimeProduction=ut.wartimeProduction||0,B.resourceWaste=ut.resourceWaste||{},B.coalitionApproval=ut.coalitionApproval||0,B.legitimacyBonus=ut.legitimacyBonus||0,B.organizationGrowthMod=(B.organizationGrowthMod||0)+(ut.organizationDecay||0),B.factionConflict=(B.factionConflict||0)+(ut.factionConflict||0),B.diplomaticCooldown=ut.diplomaticCooldown||0,B.diplomaticIncident=ut.diplomaticIncident||0,B.diplomaticBonus=ut.diplomaticBonus||0,B.officialProductionInputCost=ut.productionInputCost||{};const $u={classApproval:p,classInfluence:(c==null?void 0:c.classInfluence)||{},totalInfluence:(c==null?void 0:c.totalInfluence)||1,classLivingStandard:(c==null?void 0:c.classLivingStandard)||{},classIncome:(c==null?void 0:c.classIncome)||{},stability:L/100,legitimacy:X,taxPolicies:Yt,rulingCoalition:U,atWar:$n,population:o,epoch:u,buildings:t},et=Rl(le,$u).aggregatedEffects;et.stability&&(B.stabilityBonus=(B.stabilityBonus||0)+et.stability),et.legitimacyBonus&&(B.legitimacyBonus=(B.legitimacyBonus||0)+et.legitimacyBonus),et.gatherBonus&&(B.categoryBonuses.gather=(B.categoryBonuses.gather||0)+et.gatherBonus),et.industryBonus&&(B.categoryBonuses.industry=(B.categoryBonuses.industry||0)+et.industryBonus),et.tradeBonus&&(B.tradeBonusMod=(B.tradeBonusMod||0)+et.tradeBonus),et.researchSpeed&&(B.scienceBonus=(B.scienceBonus||0)+et.researchSpeed),et.taxEfficiency&&(B.taxEfficiencyBonus=(B.taxEfficiencyBonus||0)+et.taxEfficiency),et.incomePercentBonus&&(B.incomePercentBonus=(B.incomePercentBonus||0)+et.incomePercentBonus),et.buildingCostMod&&(B.buildingCostMod=(B.buildingCostMod||0)+et.buildingCostMod),et.needsReduction&&(B.needsReduction=(B.needsReduction||0)+et.needsReduction),et.populationGrowth&&(B.populationGrowthBonus=(B.populationGrowthBonus||0)+et.populationGrowth),et.militaryBonus&&(B.militaryBonus=(B.militaryBonus||0)+et.militaryBonus),et.organizationDecay&&(B.organizationGrowthMod=(B.organizationGrowthMod||0)+et.organizationDecay),et.cultureBonus&&(B.cultureBonus=(B.cultureBonus||0)+et.cultureBonus),et.diplomaticBonus&&(B.diplomaticBonus=(B.diplomaticBonus||0)+et.diplomaticBonus),B.stanceApprovalEffects=et.approval||{},B.stanceProductionInputCost=et.productionInputCost||{};const{buildingBonuses:qn,categoryBonuses:Vn,passiveGains:Gu,passivePercentGains:qu,perPopPassiveGains:Vu,decreeResourceDemandMod:ln,decreeStratumDemandMod:un,decreeResourceSupplyMod:Ia}=B;let{decreeSilverIncome:Mi,decreeSilverExpense:Fi,extraMaxPop:fs,maxPopPercent:ka,productionBonus:Da,industryBonus:Wa,taxBonus:Hu,needsReduction:ds}=B;sl(_,B);const Yu=we?Object.entries(we).map(([n,l])=>({id:n,active:!0,modifiers:(l==null?void 0:l.effects)||(l==null?void 0:l.modifiers)})):[],zu=Array.isArray(a)?a.filter(n=>n&&n.active):[];cl([...Yu,...zu],B),ll(A,B),Array.isArray(d)&&d.forEach(n=>{zo(n,B)}),Array.isArray(M)&&M.forEach(n=>{zo(n,B)});let Hn=null;if(U&&U.length>0){const n=nl({popStructure:i,classWealthResult:f}),l=O0(U,n.classInfluence);Hn=T0(l.name),ul(Hn,B)}gi&&gi[u]&&gi[u].bonuses&&zo(gi[u].bonuses,B),Mi=B.decreeSilverIncome,Fi=B.decreeSilverExpense,fs=B.extraMaxPop,ka=B.maxPopPercent,Da=B.productionBonus,Wa=B.industryBonus,Hu=B.taxBonus,ds=B.needsReduction;const Xu=B.incomePercentBonus||0,co=n=>(Xe[n]||(Xe[n]=Io(n)),Xe[n]=Math.max(Oi,Xe[n]),Xe[n]);let Yn=null;const Ju=(n,l,b)=>{var w,C;if(n==="silver"&&l>0){ft[b]=(ft[b]||0)+l,nt.transfer("void",b,l,Z.INCOME.OWNER_REVENUE,Z.INCOME.OWNER_REVENUE,{buildingId:Yn});return}if(!(l<=0)&&(ie[n]=(ie[n]||0)+l,Qt(n))){Do[n]=(Do[n]||0)+l;const S=co(n),R=((w=Y==null?void 0:Y.dominance)==null?void 0:w.panelType)==="plannedEconomy"&&(Re==null?void 0:Re.enabled)&&((C=Re.governmentBuyPrices)==null?void 0:C[n])!==void 0;let $=S;if(R){const oe=s0({resourceKey:n,amount:l,marketPrice:S,priceControls:Re,taxBreakdown:Gt,resources:ie,onTreasuryChange:Ht});oe.success&&($=oe.effectivePrice)}const z=$*l;ft[b]=(ft[b]||0)+z,nt.transfer("void",b,z,Z.INCOME.OWNER_REVENUE,Z.INCOME.OWNER_REVENUE,{buildingId:Yn})}},Te={},lo=t,Zu=new Set,to={},Qo={},ft={},zn={};let Uo=5,ps=0;Uo+=fs,Uo+=I,yr(y),dc(y),Object.values(y).reduce((n,l)=>n+l,0),zt.forEach(n=>to[n]=0),zt.forEach(n=>{Qo[n]={totalSlots:0,weightedWage:0},ft[n]=0});const $o={},vi={};zt.forEach(n=>{$o[n]=0,vi[n]=0});const xt={};Object.keys(ae).forEach(n=>{xt[n]=0});const wi={};Object.keys(ae).forEach(n=>{wi[n]=0}),Object.keys(ae).forEach(n=>{}),Vt.forEach(n=>{const l=lo[n.id]||0;if(l>0){const b=me[n.id]||{};let w=0;Object.entries(b).forEach(([q,R])=>{const $=parseInt(q);Number.isFinite($)&&$>0&&R>0&&(w+=R)});const S={0:Math.max(0,l-w)};Object.entries(b).forEach(([q,R])=>{const $=parseInt(q);Number.isFinite($)&&$>0&&R>0&&(S[$]=R)}),Object.entries(S).forEach(([q,R])=>{var be,he;if(R<=0)return;const $=parseInt(q),G=Nt(n,$);let z=1+(qn[n.id]||0);const oe=1+(Vn[n.cat]||0);if(z*=oe,(be=G.output)!=null&&be.maxPop&&(Uo+=G.output.maxPop*z*R),(he=G.output)!=null&&he.militaryCapacity&&(ps+=G.output.militaryCapacity*z*R),G.jobs)for(let Me in G.jobs)to[Me]=(to[Me]||0)+G.jobs[Me]*R;G.output&&Object.entries(G.output).forEach(([Me,at])=>{Oe[Me]&&(at||0)>0&&Zu.add(Me)})})}});const Ba={};(le||[]).forEach(n=>{(n.ownedProperties||[]).forEach(l=>{l.buildingId&&(Ba[l.buildingId]=(Ba[l.buildingId]||0)+1)})}),Object.entries(Ba).forEach(([n,l])=>{const b=Vt.find(S=>S.id===n);if(!b||!b.owner||!b.jobs)return;const w=b.owner,C=b.jobs[w]||0;if(C>0&&to[w]){const S=C*l;to[w]=Math.max(0,to[w]-S)}});const Oa={};(_t||[]).forEach(n=>{n.status==="operating"&&n.buildingId&&(Oa[n.buildingId]=(Oa[n.buildingId]||0)+1)}),Object.entries(Oa).forEach(([n,l])=>{const b=Vt.find(S=>S.id===n);if(!b||!b.owner||!b.jobs)return;const w=b.owner,C=b.jobs[w]||0;if(C>0&&to[w]){const S=C*l;to[w]=Math.max(0,to[w]-S)}});const fn=new Set;if(Vt.forEach(n=>{var w;const l=((w=n.epoch)!=null?w:0)<=u,b=!n.requiresTech||_.includes(n.requiresTech);l&&b&&n.output&&Object.entries(n.output).forEach(([C,S])=>{Oe[C]&&(S||0)>0&&fn.add(C)})}),ka!==0){const n=Math.max(0,1+ka);Uo=Math.max(0,Uo*n)}Uo=Math.floor(Uo);let hs=0;Object.entries(y).forEach(([n,l])=>{if(!l||l<=0)return;const b=Ro[n],w=(b==null?void 0:b.populationCost)||1;hs+=l*w});const Qu=(m||[]).reduce((n,l)=>{if(l.status==="waiting"||l.status==="training"){const b=Ro[l.unitId],w=(b==null?void 0:b.populationCost)||1;return n+w}return n},0),ms=hs+Qu;ms>0&&(to.soldier=(to.soldier||0)+ms);const Ku=i&&Object.keys(i).length>0;let J={},dn=0;if(Ku){zt.forEach(l=>{const b=i[l]||0;J[l]=Math.max(0,b)}),J.unemployed=Math.max(0,i.unemployed||0);const n=zt.reduce((l,b)=>l+(J[b]||0),0)+(J.unemployed||0);if(dn=o-n,dn>0)J.unemployed=(J.unemployed||0)+dn;else if(dn<0){let l=-dn;const b=Math.min(J.unemployed||0,l);if(b>0&&(J.unemployed-=b,l-=b),l>0){const w=zt.reduce((C,S)=>C+(J[S]||0),0);if(w>0){const C=l;zt.forEach((S,q)=>{if(l<=0)return;const R=J[S]||0;if(R<=0)return;const $=R/w;let G=Math.floor($*C);G<=0&&l>0&&(G=1),q===zt.length-1?G=Math.min(R,l):G=Math.min(R,Math.min(G,l)),!(G<=0)&&(J[S]=R-G,l-=G)}),l>0&&zt.forEach(S=>{if(l<=0)return;const q=J[S]||0;if(q<=0)return;const R=Math.min(q,l);J[S]=q-R,l-=R})}}}}else{let n=o;zt.forEach(l=>{const b=Math.max(0,to[l]||0),w=Math.min(n,b);J[l]=w,n-=w}),J.unemployed=Math.max(0,n)}J.unemployed=Math.max(0,J.unemployed||0);const ef=$0(J,bi);zt.forEach(n=>{if(n==="official")return;const l=J[n]||0,b=Math.max(0,to[n]||0);if(l>b){const w=l-b,C=je[n]||0,S=l>0?C/l:0;if(J[n]=b,J.unemployed=(J.unemployed||0)+w,S>0){const q=S*w;nt.transfer(n,"unemployed",q,Z.EXPENSE.LAYOFF_TRANSFER,Z.EXPENSE.LAYOFF_TRANSFER)}}});const tf=Array.isArray(le)?le.length:0;J.official=tf,je.official=0;let of=1,pn=0,ja=Or(X);const li=Math.max(0,of*ja*(1+(B.taxBonus||0))),nf=n=>{let b=0,w=0,C=0,S=0;Vt.forEach(G=>{var at,dt,ze,tt,ge,Fe,qe;const z=lo[G.id]||0;if(z<=0)return;const oe=Nt(G,0),be=oe.jobs||{},he=be[n]||0;if(he<=0)return;if(G.owner===n){let Pe=0;oe.output&&Object.entries(oe.output).forEach(([De,Se])=>{if(!Oe[De])return;const Ce=Xe[De]||Io(De);Pe+=Se*Ce});let Je=0;oe.input&&Object.entries(oe.input).forEach(([De,Se])=>{const Ce=Xe[De]||Io(De);Je+=Se*Ce});let pe=0;Object.entries(be).forEach(([De,Se])=>{var Pt,Ct;if(De===n||!Se||Se<=0)return;const Ce=(Ct=(Pt=c==null?void 0:c.wages)==null?void 0:Pt[De])!=null?Ct:bo(De);pe+=Ce*Se});const Ge=((dt=(at=ae[n])==null?void 0:at.headTaxBase)!=null?dt:.01)*ci(n)*li,ke=(ze=G.businessTaxBase)!=null?ze:.1,pt=(ge=(tt=Yt==null?void 0:Yt.businessTaxRates)==null?void 0:tt[G.id])!=null?ge:1,ot=ke*pt,Ot=Pe-Je-pe-Ge-ot,Ue=he>0?Ot/he:0;b+=Ue*he*z,w+=he*z}else{const Pe=(qe=(Fe=c==null?void 0:c.wages)==null?void 0:Fe[n])!=null?qe:bo(n);C+=Pe*he*z,S+=he*z}});const q=w+S;if(q<=0)return bo(n);const $=(b+C)/q;return Math.max(bo(n),$*1.2)};K0({popStructure:J,jobsAvailable:to,wealth:je,getExpectedWage:n=>{if((J[n]||0)<=5){const b=nf(n),w=bo(n);return Math.max(b,w)}return bo(n)},getHeadTaxRate:ci,effectiveTaxModifier:li});const Eo={},ho={},mo={},Et={},We=[],Xn=new Map,hn={},Na={},xi=n=>{if(!n)return;const l=Xn.get(n)||0;Xn.set(n,l+1)};Object.entries(Gu).forEach(([n,l])=>{if(!l)return;const b=l,w=ie[n]||0;if(b>=0)Dt(n,b,"passive_gain"),Te[n]=(Te[n]||0)+b;else{const C=Math.abs(b),S=Math.min(w,C);S>0&&(Dt(n,-S,"passive_cost"),Te[n]=(Te[n]||0)-S)}});const La=o||0;Object.entries(Vu||{}).forEach(([n,l])=>{if(!l||La<=0)return;const b=l*La,w=ie[n]||0;if(b>=0)Dt(n,b,"passive_pop_gain"),Te[n]=(Te[n]||0)+b;else{const C=Math.abs(b),S=Math.min(w,C);S>0&&(Dt(n,-S,"passive_pop_cost"),Te[n]=(Te[n]||0)-S)}}),Object.entries(qu||{}).forEach(([n,l])=>{if(!l)return;const b=Te[n]||0;if(b!==0){const w=Math.abs(b)*l;b>=0?(Dt(n,w,"passive_percent_gain"),Te[n]=b+w):(Dt(n,-w,"passive_percent_cost"),Te[n]=b-w)}else{const C=La*.01*l;Dt(n,C,"passive_percent_base_gain"),Te[n]=(Te[n]||0)+C}});const Fa={},Ua=1-Math.max(-2,Math.min(.95,ds||0)),gs={};Object.keys(ae).forEach(n=>{gs[n]=je[n]||0}),Object.keys(ae).forEach(n=>{var z,oe,be;if(n==="official")return;const l=J[n]||0;if(l===0)return;const b=ae[n];je[n]===void 0&&(je[n]=b.startingWealth||0);const w=ci(n),S=((oe=(z=ae[n])==null?void 0:z.headTaxBase)!=null?oe:.01)*w*li,q=Math.max(0,je[n]||0),R=q/Math.max(1,l),$=S>=0?Math.min(S,R):S,G=l*$;if(G!==0)if(G>0){const he=Math.min(q,G);nt.transfer(n,"state",he,Z.EXPENSE.HEAD_TAX,Z.EXPENSE.HEAD_TAX),wi[n]=(wi[n]||0)+he,xt[n]=(xt[n]||0)+he,vi[n]=(vi[n]||0)+he}else{const he=-G;(ie.silver||0)>=he&&(nt.transfer("state",n,he,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),ft[n]=(ft[n]||0)+he,$o[n]=($o[n]||0)+he)}Eo[n]=(be=p[n])!=null?be:50,(Eo[n]||0)<=0&&(Fa[n]=!0)});const af=!!(we&&we.forced_labor);Vt.forEach(n=>{var _n,Yo,Tn,Pn,ya,qo,An,ai,Po;const l=lo[n.id]||0;if(l===0)return;const b=me[n.id]||{},w={input:{},output:{},jobs:{}};let C=0,S=!1;Object.entries(b).forEach(([O,F])=>{const Q=parseInt(O);Number.isFinite(Q)&&Q>0&&F>0&&(C+=F,S=!0)});const q=Math.max(0,l-C),R={0:q};Object.entries(b).forEach(([O,F])=>{const Q=parseInt(O);Number.isFinite(Q)&&Q>0&&F>0&&(R[Q]=F)});const $={};Object.entries(R).forEach(([O,F])=>{if(F<=0)return;const Q=parseInt(O),ne=Nt(n,Q).owner||"state";$[ne]||($[ne]={levels:{},totalCount:0}),$[ne].levels[Q]=F,$[ne].totalCount+=F}),Object.keys($).forEach(O=>{var F;je[O]===void 0&&(je[O]=((F=ae[O])==null?void 0:F.startingWealth)||0)}),n.owner;let G=1;if(!S&&q===l){if(n.input)for(const[O,F]of Object.entries(n.input))w.input[O]=F*l;if(n.output)for(const[O,F]of Object.entries(n.output))w.output[O]=F*l;if(n.jobs)for(const[O,F]of Object.entries(n.jobs))w.jobs[O]=F*l}else for(const[O,F]of Object.entries(R)){if(F<=0)continue;const Q=parseInt(O),ee=Nt(n,Q);if(ee.input)for(const[ne,se]of Object.entries(ee.input))w.input[ne]=(w.input[ne]||0)+se*F;if(ee.output)for(const[ne,se]of Object.entries(ee.output))w.output[ne]=(w.output[ne]||0)+se*F;if(ee.jobs)for(const[ne,se]of Object.entries(ee.jobs))w.jobs[ne]=(w.jobs[ne]||0)+se*F}const z=gi[u];let oe=0;z&&z.bonuses&&(n.cat==="gather"&&z.bonuses.gatherBonus&&(oe+=z.bonuses.gatherBonus),n.cat==="industry"&&z.bonuses.industryBonus&&(oe+=z.bonuses.industryBonus));let be=0,he=0;d.forEach(O=>{O.production&&(be+=O.production),O.industryBonus&&(he+=O.industryBonus)}),M.forEach(O=>{O.production&&(be+=O.production),O.industryBonus&&(he+=O.industryBonus)}),be+=Da,he+=Wa,(n.cat==="gather"||n.cat==="civic")&&(oe+=be),n.cat==="industry"&&(oe+=he),$n&&B.wartimeProduction&&(oe+=B.wartimeProduction);const Me=Vn[n.cat];Me&&Me!==0&&(oe+=Me);const at=H[n.id]||0,dt=H[n.cat]||0,ze=H.all||0;oe+=at+dt+ze;const tt=qn[n.id];tt&&tt!==0&&(oe+=tt),G*=1+oe,eo[n.id]||(eo[n.id]={wagesByRole:{},paidWagePerWorkerByRole:{},filledByRole:{},wagePaidRatioByOwner:{},ownerRevenue:0,productionCosts:0,businessTaxPaid:0});let ge=1,Fe=0,qe=0;const Pe={};let Je=0;const pe=[];if(Object.keys(w.jobs).length>0){hn[n.id]=hn[n.id]||{};let O=1/0,F=!1;for(let Q in w.jobs){const ee=w.jobs[Q];Qo[Q]||(Qo[Q]={totalSlots:0,weightedWage:0}),Fe+=ee;const ne=to[Q],se=J[Q],xe=ne>0?Math.min(1,se/ne):0,Ne=ee*xe;qe+=Ne,hn[n.id][Q]=Ne,eo[n.id].filledByRole[Q]=(eo[n.id].filledByRole[Q]||0)+Ne;const Ae=Object.keys($).includes(Q);if(!Ae&&ee>0){F=!0;const vt=ee>0?Ne/ee:0;O=Math.min(O,vt)}const Ve=Math.max(0,ee-Ne);if(Ve>.001){const vt=Ve>=1?Math.floor(Ve):1;(zn[Q]||(zn[Q]=[])).push({buildingId:n.id,buildingName:n.name||n.id,availableSlots:vt})}if(!Ae&&Ne>0){const vt=(_n=Pe[Q])!=null?_n:bo(Q),it=sn(Q),Ft=Math.max(vt,it);Pe[Q]=Ft,Je+=Ne*Ft,pe.push({role:Q,ownerKey:n.owner||"state",roleSlots:ee,filled:Ne,baseWage:Ft})}}F?ge=O===1/0?0:O:Fe>0&&(ge=qe/Fe),Fe>0&&(Na[n.id]=ge)}const rt=G;G*=ge,af&&((Yo=n.jobs)!=null&&Yo.serf||(Tn=n.jobs)!=null&&Tn.miner)&&(G*=1.2);const Ge=G,ke=Ge>0?Ge:rt;let pt=1,ot=0,Ot=!1;const Ue=Object.keys(w.input).length>0,De=Object.keys(w.output).some(O=>O!=="maxPop"&&O!=="militaryCapacity");if(Ue&&De){const O=((Pn=B.officialProductionInputCost)==null?void 0:Pn[n.id])||0,F=((ya=B.stanceProductionInputCost)==null?void 0:ya[n.id])||0,Q=O+F;if(Q!==0){const ee=1+Q,ne=Math.max(.2,ee);for(const[se,xe]of Object.entries(w.input))w.input[se]=xe*ne}if(B.resourceWaste)for(const[ee,ne]of Object.entries(w.input)){const se=((qo=B.resourceWaste)==null?void 0:qo[ee])||0;if(!se)continue;const xe=Math.max(0,1+se);w.input[ee]=ne*xe}}if(Object.keys(w.input).length>0)for(const[O,F]of Object.entries(w.input)){if(!Di(O,u,_))continue;const Q=F,ee=Q*ke;if(ee<=0)continue;const ne=ie[O]||0;if(ne<=0?pt=0:pt=Math.min(pt,ne/ee),Qt(O)){const se=co(O),xe=Li(O);ot+=Q*se*(1+xe)}}let Se=Ge*Math.max(0,Math.min(1,pt)),Ce=ke*Math.max(0,Math.min(1,pt));if(n.cat==="gather"&&pt===0&&Object.keys(w.input).length>0){Se=Ge*.2,Ce=ke*.2,Ot=!0,ot=0;const O=Object.keys(w.input).map(F=>{var Q;return((Q=Oe[F])==null?void 0:Q.name)||F}).join("、");g%30===0&&xi(`?? ${n.name} 缺少 ${O}，工人正在徒手作业（效率20%）`)}let Pt=0,Ct=!1;if(Object.keys(w.output).length>0)for(const[O,F]of Object.entries(w.output)){if(O==="maxPop"||!Qt(O))continue;Ct=!0;const ne=F*co(O);Pt+=ne}const Lt=ke>0?Je/ke:Je,Be=Pt*Ce,$e=ot*Ce,Ze=Lt*Ce,At=Math.max(0,Be-$e),Rt=Ze>0?At/Ze:1,fo=Number.isFinite(Rt)?Rt>=1?Math.min(3,1+(Rt-1)*.5):Math.max(.65,1-(1-Rt)*.5):1,st=Lt*fo,_o=st*Ce,ct=n.cat==="civic"&&!n.owner&&((An=n.output)==null?void 0:An.maxPop)>0,Xt=n.cat==="military",oo=(ai=n.businessTaxBase)!=null?ai:.1,St=ct||Xt?0:Fu(n.id),It=oo*St,Lo=It*l*Ce,To=ot+st;let ve=Se,gt=Ce,Jt=null,jt=null;const ti=Math.min(_o,At),hi=Se>0?ti/Se:0,oi=ot+hi;if(Ct){const O=$e+ti+Math.max(0,Lo);if(O>0&&Be<=0)ve=0,Jt=0;else if(O>0&&Be<O*.98){const F=Math.max(0,Math.min(1,Be/O));Jt=F,ve=Se*F,gt=Ce*F}else Jt=O>0?Be/O:null;jt={baseMultiplier:Ge,resourceLimit:pt,targetMultiplier:Se,estimatedRevenue:Be,estimatedInputCost:$e,estimatedWageCost:_o,actualPayableWageCost:ti,actualWageCostPerMultiplier:hi,actualOperatingCostPerMultiplier:oi,estimatedBusinessTax:Lo,estimatedCost:O,marginRatio:Jt,actualMultiplierAfterMargin:ve,outputValuePerMultiplier:Pt,inputCostPerMultiplier:ot,wageCostPerMultiplier:st,count:l,expectedWageBillBase:Je,baseWageCostPerMultiplier:Lt,wagePressure:fo,baseWageCost:Ze,wageCoverage:Rt,valueAvailableForLabor:At,wagePlans:pe}}if(oi>0){let O=1/0;const F=[];Object.entries($).forEach(([ne,se])=>{const xe=se.totalCount/l,Ne=oi*xe,Ae=je[ne]||0,Ve=Ne>0?Ae/Ne:1/0;O=Math.min(O,Ve),F.push({owner:ne,proportion:xe,operatingCost:Ne,cash:Ae,affordable:Ve})});const Q=O===1/0?Se:O,ee=O===1/0?Ce:O;ve=Math.min(ve,Math.max(0,Q)),gt=Math.min(gt,Math.max(0,ee)),jt&&(jt.totalOperatingCostPerMultiplier=To,jt.minAffordableMultiplier=O,jt.affordableMultiplier=Q,jt.actualMultiplierAfterAffordable=ve,jt.ownerDetails=F)}jt&&(ss[n.id]=jt),(!Number.isFinite(ve)||ve<0)&&(ve=0);const re=.3;let Mt=1;Object.keys($).forEach(O=>{Fa[O]&&(Mt=Math.min(Mt,re))}),Object.keys(w.jobs).length>0&&Object.keys(w.jobs).forEach(O=>{Fa[O]&&(Mt=Math.min(Mt,re))}),ve*=Mt,gt*=Mt;const po=Ge>0?Math.min(1,ve/Ge):0,io=ke>0?Math.min(1,gt/ke):0;let wo=0;if(Object.keys(w.input).length>0&&!Ot){const O={};Object.entries(R).forEach(([F,Q])=>{if(Q<=0)return;const ee=parseInt(F),ne=Nt(n,ee);!ne.input||Object.keys(ne.input).length===0||(O[ee]={},Object.entries(ne.input).forEach(([se,xe])=>{O[ee][se]=xe*Q*ve}))});for(const[F,Q]of Object.entries(w.input)){if(!Di(F,u,_))continue;const ee=Q*ve;if(!ee||ee<=0)continue;const ne=ie[F]||0,se=Math.min(ee,ne),xe=ee>0?se/ee:0;if(Qt(F)){const Ne=co(F),Ae=Li(F);Object.entries(O).forEach(([Ve,vt])=>{const it=parseInt(Ve),Ft=vt[F]||0;if(Ft<=0)return;const qt=Ft*xe;if(qt<=0)return;const go=Nt(n,it).owner||"state",zi=qt*Ne,Ii=zi*Ae;let Xi=zi;if(Ii<0){const Ji=Math.abs(Ii);(ie.silver||0)>=Ji&&(nt.transfer("state",go,Ji,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),Xi-=Ji,ft[go]=(ft[go]||0)+Ji)}else Ii>0&&(nt.transfer(go,"state",Ii,Z.EXPENSE.RESOURCE_TAX,Z.EXPENSE.RESOURCE_TAX),Xi+=Ii);nt.transfer(go,"void",zi,Z.EXPENSE.PRODUCTION_COST,Z.EXPENSE.PRODUCTION_COST,{buildingId:n.id}),xt[go]=(xt[go]||0)+Xi,eo[n.id].productionCosts+=Xi}),Mo[F]=(Mo[F]||0)+se,cn[F]||(cn[F]={buildings:{},pop:0}),cn[F].buildings[n.id]=(cn[F].buildings[n.id]||0)+se}se<=0||(ie[F]=ne-se,Te[F]=(Te[F]||0)-se)}}Object.keys(w.jobs).length>0&&Object.entries(w.jobs).forEach(([O,F])=>{const Q=F;Q<=0||(Qo[O]||(Qo[O]={totalSlots:0,weightedWage:0}),Qo[O].totalSlots+=Q)});const ii={};Object.entries(R).forEach(([O,F])=>{const Q=parseInt(O),ee=Nt(n,Q);let ne=0;ee.output&&Object.entries(ee.output).forEach(([it,Ft])=>{if(it==="maxPop"||!Qt(it))return;const no=Ft*co(it);ne+=no});let se=0;ee.input&&Object.entries(ee.input).forEach(([it,Ft])=>{Di(it,u,_)&&Qt(it)&&(se+=Ft*co(it))});let xe=0;const Ne=ee.owner||"state";ee.jobs&&Object.entries(ee.jobs).forEach(([it,Ft])=>{var no;if(it===Ne)return;const qt=(no=Pe[it])!=null?no:bo(it);xe+=Ft*qt});const Ae=Math.max(0,ne-se),Ve=xe>0?Ae/xe:1;let vt=1;Number.isFinite(Ve)?Ve>=1?vt=Math.min(3,1+(Ve-1)*.5):vt=Math.max(.65,1-(1-Ve)*.5):vt=1,ii[Q]=vt});let Cn=0,Go=0;Object.entries(R).forEach(([O,F])=>{const Q=parseInt(O),ee=ii[Q]||1;Cn+=ee*F,Go+=F});const ni=Go>0?Cn/Go:fo,Vi=((Po=n.marketConfig)==null?void 0:Po.wage)||{},mi=Vi.wageMode,Hi=Vi.subsistenceMultiplier||1.5,Yi=pe.map(O=>{const F=O.ownerKey||n.owner||"state";let Q=ni;if(Object.keys(R).length>1){let se=0,xe=0;Object.entries(R).forEach(([Ne,Ae])=>{var Ft;const Ve=parseInt(Ne),it=((Ft=Nt(n,Ve).jobs)==null?void 0:Ft[O.role])||0;if(it>0){const qt=ii[Ve]||1;se+=qt*it*Ae,xe+=it*Ae}}),xe>0&&(Q=se/xe)}let ee=O.baseWage*po*Q;mi==="subsistence"&&(ee=((Zo==null?void 0:Zo[O.role])||sn(O.role))*Hi);const ne=ee*O.filled;return wo+=ne,{...O,ownerKey:F,expectedSlotWage:ee,wagePressure:Q,wageMode:mi,subsistenceMultiplier:mi==="subsistence"?Hi:void 0}}),Si={};if(eo[n.id].wagePaidRatioByOwner=Si,wo>0){const O={};Object.entries(R).forEach(([F,Q])=>{if(Q<=0)return;const ee=parseInt(F),ne=Nt(n,ee),se=ne.owner||"state";O[se]||(O[se]=0),ne.jobs&&Object.entries(ne.jobs).forEach(([xe,Ne])=>{if(xe===se)return;let Ae;mi==="subsistence"?Ae=((Zo==null?void 0:Zo[xe])||sn(xe))*Hi:Ae=bo(xe);const Ve=Ne*Q*Ae*po*(ii[ee]||1);O[se]+=Ve})}),Object.entries(O).forEach(([F,Q])=>{if(Q<=0){Si[F]=0;return}const ee=je[F]||0;let ne=0;const se=ae[F];se&&se.needs&&(Object.entries(se.needs).forEach(([Ae,Ve])=>{const vt=co(Ae);ne+=Ve*vt}),ne*=1.2);const xe=Math.max(0,ee-ne),Ne=Math.min(xe,Q);nt.transfer(F,"void",Ne,Z.EXPENSE.WAGES_PAID,Z.EXPENSE.WAGES_PAID,{buildingId:n.id}),xt[F]=(xt[F]||0)+Ne,Si[F]=Q>0?Ne/Q:0})}if(Yi.forEach(O=>{var ne;const F=(ne=Si[O.ownerKey])!=null?ne:0,Q=O.expectedSlotWage*F,ee=O.baseWage*io*O.wagePressure;if(Qo[O.role].weightedWage+=ee*O.roleSlots,O.filled>0&&Q>0){const se=Q*O.filled;eo[n.id].wagesByRole[O.role]=(eo[n.id].wagesByRole[O.role]||0)+se,nt.transfer("void",O.role,se,Z.INCOME.WAGE,Z.INCOME.WAGE,{buildingId:n.id}),ft[O.role]=(ft[O.role]||0)+se,$o[O.role]=($o[O.role]||0)+se}}),Object.entries(eo[n.id].wagesByRole).forEach(([O,F])=>{const Q=eo[n.id].filledByRole[O]||0;Q>0&&(eo[n.id].paidWagePerWorkerByRole[O]=F/Q)}),Object.keys(w.output).length>0){const O={};Object.entries(R).forEach(([F,Q])=>{if(Q<=0)return;const ee=parseInt(F),ne=Nt(n,ee);!ne.output||Object.keys(ne.output).length===0||(O[ee]={},Object.entries(ne.output).forEach(([se,xe])=>{O[ee][se]=xe*Q*ve}))});for(const[F,Q]of Object.entries(w.output)){let ee=Q*ve;if(!ee||ee<=0)continue;let ne=1;if(Qt(F)&&F!=="silver"){const se=Oe[F],xe=(se==null?void 0:se.marketConfig)||{},Ne=(Ut==null?void 0:Ut.market)||{},Ae=xe.outputVariation!==void 0?xe.outputVariation:Ne.outputVariation||.2;ne=1+(Math.random()*2-1)*Ae,ee*=ne;const Ve=Ia[F]||0;Ve!==0&&(ee*=1+Ve),F==="science"&&B.scienceBonus&&(ee*=1+B.scienceBonus),F==="culture"&&B.cultureBonus&&(ee*=1+B.cultureBonus)}F!=="maxPop"&&(Qt(F)?(Object.entries(O).forEach(([se,xe])=>{const Ne=parseInt(se),Ae=xe[F]||0;if(Ae<=0)return;const Ve=Q*ve,vt=Ve>0?Ae/Ve:0,it=ee*vt;if(it<=0)return;const qt=Nt(n,Ne).owner||"state";Yn=n.id,Ju(F,it,qt),Yn=null}),Te[F]=(Te[F]||0)+ee,so[F]||(so[F]={buildings:{},imports:0}),so[F].buildings[n.id]=(so[F].buildings[n.id]||0)+ee):F==="silver"?Object.entries(O).forEach(([se,xe])=>{const Ne=parseInt(se),Ae=xe[F]||0;if(Ae<=0)return;const Ve=Q*ve,vt=Ve>0?Ae/Ve:0,it=ee*vt;if(it<=0)return;const qt=Nt(n,Ne).owner||"state";qt==="state"?Dt(F,it,"building_production_direct"):nt.transfer("void",qt,it,"building_production_direct","building_production_direct",{buildingId:n.id})}):Dt(F,ee,"building_production_direct"))}}if(It!==0&&l>0){const O=It*l*ve;if(O>0)Object.entries($).forEach(([F,Q])=>{var xe;const ee=Q.totalCount/l,ne=O*ee,se=je[F]||0;se>=ne?(nt.transfer(F,"state",ne,Z.EXPENSE.BUSINESS_TAX,Z.EXPENSE.BUSINESS_TAX,{buildingId:n.id}),xt[F]=(xt[F]||0)+ne):g%30===0&&se<ne*.5&&xi(`?? ${((xe=ae[F])==null?void 0:xe.name)||F} 无力支付 ${n.name} 的营业税，政府放弃征收。`)});else if(O<0){const F=Math.abs(O);(ie.silver||0)>=F?Object.entries($).forEach(([ee,ne])=>{const se=ne.totalCount/l,xe=F*se;nt.transfer("state",ee,xe,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),ft[ee]=(ft[ee]||0)+xe}):g%30===0&&xi(`?? 国库空虚，无法为 ${n.name} 支付营业补贴！`)}}if(n.id==="market"){const O=n.owner||"merchant",F=(J[O]||0)>0,Q=g%5===0;if(F&&Q){let ne=je[O]||0;if(!(ne<=0)){const se=[];if(Object.entries(ie).forEach(([xe,Ne])=>{if(!Qt(xe)||xe==="silver"||(Ne||0)<=300||(Te[xe]||0)<0)return;const Ae=co(xe);se.push({resource:xe,stock:Ne,localPrice:Ae})}),se.length>0){const xe=[];if(Object.keys(Oe).forEach(Ne=>{if(!Qt(Ne)||Ne==="silver")return;const Ae=ie[Ne]||0,Ve=Te[Ne]||0,vt=Math.max(0,(Mo[Ne]||0)-(Do[Ne]||0)),it=Math.max(0,200-Ae),Ft=Ve<0?Math.abs(Ve):0,qt=Math.max(vt,it,Ft);if(qt<=0)return;const no=Math.max(Oi,co(Ne)*1.15),go=qt*no;go<=0||xe.push({resource:Ne,shortageAmount:qt,importPrice:no,requiredValue:go})}),xe.length>0){xe.sort((Ae,Ve)=>Ve.requiredValue-Ae.requiredValue);const Ne=10;xe.forEach(Ae=>{var it,Ft;if(ne<=0)return;let Ve=Ae.shortageAmount,vt=Ae.requiredValue;for(const qt of se){if(ne<=0||Ve<=0||vt<=0)break;const no=qt.resource,go=qt.localPrice;if(go<=0)continue;const zi=ie[no]||0;if(zi<=0)continue;const Ii=vt/go,Xi=zi*.05,Ji=ne/go,ki=Math.min(Ii,Xi,Ji);if(!Number.isFinite(ki)||ki<=0)continue;const Rn=ki*go;if(ne-=Rn,nt.transfer(O,"void",Rn,Z.EXPENSE.TRADE_EXPORT_PURCHASE,Z.EXPENSE.TRADE_EXPORT_PURCHASE),xt[O]=(xt[O]||0)+Rn,Dt(no,-ki,"trade_export_deduction"),Do[no]=(Do[no]||0)+ki,Te[no]=(Te[no]||0)-ki,qt.stock=Math.max(0,qt.stock-ki),vt=Math.max(0,vt-Rn),Ae.importPrice<=0)continue;let Vo=Rn/Ae.importPrice;if(!Number.isFinite(Vo)||Vo<=0||(Vo=Math.min(Vo,Ve),Vo<=0))continue;const Sn=Vo*Ae.importPrice;nt.transfer("void",O,Sn,Z.INCOME.TRADE_IMPORT_REVENUE,Z.INCOME.TRADE_IMPORT_REVENUE),ne+=Sn,Dt(Ae.resource,Vo,"trade_import_gain"),Do[Ae.resource]=(Do[Ae.resource]||0)+Vo,Te[Ae.resource]=(Te[Ae.resource]||0)+Vo,so[Ae.resource]||(so[Ae.resource]={buildings:{},imports:0}),so[Ae.resource].imports=(so[Ae.resource].imports||0)+Vo,Ve=Math.max(0,Ve-Vo),Sn>0&&(ft[O]=(ft[O]||0)+Sn),Sn>Ne&&((it=Oe[no])!=null&&it.name,(Ft=Oe[Ae.resource])!=null&&Ft.name||Ae.resource)}})}}}}}n.jobs&&Object.entries(n.jobs).forEach(([O,F])=>{F*l<=0})});const rf=g0(te),Jn=vc(y);Object.keys(Jn).forEach(n=>{Jn[n]=Math.ceil((Jn[n]||0)*rf)});const ys={};Object.entries(Jn).forEach(([n,l])=>{ys[n]=$n?l*cs:l});let Zn=0;const bs={};Object.entries(ys).forEach(([n,l])=>{var q;if(l<=0)return;if(n==="silver"){Zn+=l;return}const b=ie[n]||0,w=Math.min(b,l);w>0&&(ie[n]=b-w,Te[n]=(Te[n]||0)-w,bs[n]=w,Mo[n]=(Mo[n]||0)+l);const C=co(n);let S=C;if(Re!=null&&Re.enabled&&(S=_r({resourceKey:n,amount:l,marketPrice:C,priceControls:Re,taxBreakdown:Gt,resources:ie,onTreasuryChange:Ht}).effectivePrice),Zn+=l*S,w<l&&g%30===0){const R=l-w;xi(`?? 军队维护资源不足：缺少 ${((q=Oe[n])==null?void 0:q.name)||n} ${R.toFixed(1)}/日`)}});const Ms=1+u*.1,sf=yr(y),vs=wc(sf,o),ws=Math.max(.5,x!=null?x:1),Wo=Zn*Ms*vs*ws,Qn={dailyExpense:Wo,resourceCost:Zn,epochMultiplier:Ms,scalePenalty:vs,wageMultiplier:ws,resourceConsumption:bs};let mn={totalArmyCost:Wo,availableSilver:ie.silver,applied:!1,reason:null,logSizeBefore:Tt.length};if(Wo>0){console.log("[Simulation] Applying military cost:",Wo,"Reason:","expense_army_maintenance");const n=ie.silver||0;if(n>=Wo){Ee(-Wo,"expense_army_maintenance"),mn.applied=!0,mn.reason="expense_army_maintenance",Te.silver=(Te.silver||0)-Wo,ft.soldier=(ft.soldier||0)+Wo,$o.soldier=($o.soldier||0)+Wo,bt.soldier&&(bt.soldier.income.militaryPay=(bt.soldier.income.militaryPay||0)+Wo);const l=Tt[Tt.length-1];mn.logEntryFound=l&&l.reason==="expense_army_maintenance",mn.logSizeAfter=Tt.length}else if(Wo>0){const l=n*.9;l>0&&(Ee(-l,"expense_army_maintenance_partial"),Te.silver=(Te.silver||0)-l,ft.soldier=(ft.soldier||0)+l,bt.soldier&&(bt.soldier.income.militaryPay=(bt.soldier.income.militaryPay||0)+l)),We.push(`?? 军饷不足！应付${Wo.toFixed(0)}银币，仅能支付${l.toFixed(0)}银币，军心不稳。`)}}const Ei={},Co={},Kn={},Ko={};Object.keys(ae).forEach(n=>{var ge,Fe,qe,Pe,Je;if(n==="official"){Ei[n]={satisfactionRatio:1,totalTrackedNeeds:0},Co[n]=[];return}const l=ae[n],b=J[n]||0;if(b===0||!l.needs){Ei[n]={satisfactionRatio:1,totalTrackedNeeds:0},Co[n]=[];return}let w=0,C=0;const S=[],q=l.startingWealth||1,$=(je[n]||0)/Math.max(1,b)/q,G=l.needs||{};let z=0;["food","cloth"].forEach(pe=>{var rt;if(G[pe]){const Ge=co(pe),ke=((rt=Oe[pe])==null?void 0:rt.basePrice)||1,pt=Math.max(Ge,ke);z+=G[pe]*pt}});const oe=(ft[n]||0)/Math.max(1,b),be=z>0?oe/z:oe>0?10:0,he=Math.max(1,(l.maxConsumptionMultiplier||6)+kr(te)),Me=Zi(be,$,l.wealthElasticity||1,he),at=kc(be).level,dt=Ac({consumptionMultiplier:Me,incomeRatio:be,wealthRatio:$,livingStandardLevel:at}),ze=Rc(be,$,l.wealthElasticity||1,at),tt={...l.needs};if(l.luxuryNeeds){const pe=Object.keys(l.luxuryNeeds).map(Number).sort((rt,Ge)=>rt-Ge);for(const rt of pe)if(ze>=rt){const Ge=l.luxuryNeeds[rt];for(const[ke,pt]of Object.entries(Ge))tt[ke]=(tt[ke]||0)+pt*dt}}for(const[pe,rt]of Object.entries(tt)){const Ge=Oe[pe];if(Ge&&Ge.unlockTech){if(!_.includes(Ge.unlockTech))continue}else if(Ge&&typeof Ge.unlockEpoch=="number"&&Ge.unlockEpoch>u)continue;if(!fn.has(pe))continue;let ke=rt*b*Ua;if(ke<=0)continue;const pt=((ge=B.resourceWaste)==null?void 0:ge[pe])||0;pt!==0&&(ke*=1+pt);const ot=W[pe]||0,Ot=ln[pe]||0,Ue=ot+Ot;Ue!==0&&(ke*=1+Ue);const De=j[n]||0,Se=un[n]||0,Ce=De+Se;Ce!==0&&(ke*=1+Ce),$n&&(n==="soldier"||n==="knight")&&(ke*=cs);let Pt=1;if(n==="official"&&le&&le.length>0&&(Pt=le.reduce(($e,Ze)=>$e+(Ze.greed||1),0)/le.length),Qt(pe)){const Be=(Ge==null?void 0:Ge.marketConfig)||{},$e=(Ut==null?void 0:Ut.market)||{},Ze=Be.demandElasticity!==void 0?Be.demandElasticity:$e.demandElasticity||.5,At=l.startingWealth||1,Rt=(je[n]||0)/Math.max(1,b),fo=(ft[n]||0)/Math.max(1,b),st=Math.max(0,fo)*30,ct=Math.max(Rt,st)/At;let Xt=l.wealthElasticity||1;n==="official"&&(Xt*=Pt);const oo=Math.max(1,(l.maxConsumptionMultiplier||6)+kr(te)),St=Zi(ct,ct,Xt,oo);(!Kn[n]||Math.abs(St-1)>Math.abs(Kn[n]-1))&&(Kn[n]=St);const It=co(pe),Lo=Ge.basePrice||1,To=It/Lo,ve=Math.pow(To,-Ze),gt=.8+Math.random()*.4;ke*=St*ve*gt,ke=Math.max(0,ke),ke=Math.min(ke,rt*b*Ua*8)}const Ct=ie[pe]||0;let Lt=0;if(Qt(pe)){const Be=co(pe),Ze=((Fe=Y==null?void 0:Y.dominance)==null?void 0:Fe.panelType)==="plannedEconomy"&&(Re==null?void 0:Re.enabled)&&((qe=Re.governmentSellPrices)==null?void 0:qe[pe])!==void 0&&Re.governmentSellPrices[pe]!==null;let At=Be;Ze&&(At=Re.governmentSellPrices[pe]);const Rt=At*(1+Li(pe)),fo=Rt>0?Math.min(ke,(je[n]||0)/Rt):ke,st=Math.min(ke,Ct,fo);if(st>0){ie[pe]=Ct-st,Te[pe]=(Te[pe]||0)-st;let ct=Be;Ze&&(ct=_r({resourceKey:pe,amount:st,marketPrice:Be,priceControls:Re,taxBreakdown:Gt,resources:ie,onTreasuryChange:Ht}).effectivePrice);const Xt=Li(pe),oo=st*ct,St=oo*Xt;let It=oo;if(St<0){const ve=Math.abs(St);(ie.silver||0)>=ve?(nt.transfer("state",n,ve,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),It-=ve,ft[n]=(ft[n]||0)+ve,$o[n]=($o[n]||0)+ve):g%20===0&&xi(`国库空虚，无法为 ${((Pe=ae[n])==null?void 0:Pe.name)||n} 支付 ${((Je=Oe[pe])==null?void 0:Je.name)||pe} 消费补贴！`)}else St>0&&(nt.transfer(n,"state",St,Z.EXPENSE.RESOURCE_TAX,Z.EXPENSE.RESOURCE_TAX),It+=St);const To=l.needs&&l.needs.hasOwnProperty(pe)?Z.EXPENSE.ESSENTIAL_CONSUMPTION:Z.EXPENSE.LUXURY_CONSUMPTION;nt.transfer(n,"void",It,To,To,{resource:pe,quantity:st,price:ct}),xt[n]=(xt[n]||0)+It,vi[n]=(vi[n]||0)+It,Lt=st,Mo[pe]=(Mo[pe]||0)+st,Ko[n]||(Ko[n]={}),Ko[n][pe]=(Ko[n][pe]||0)+st}const _o=ke>0?Lt/ke:1;if(w+=_o,C+=1,_o<.99){const ct=fo>=ke*.99,Xt=Ct>=ke*.99;let oo="both";ct&&!Xt?oo="outOfStock":!ct&&Xt&&(oo="unaffordable"),S.push({resource:pe,reason:oo})}}else{const Be=Math.min(ke,Ct);Be>0&&(ie[pe]=Ct-Be,Lt=Be);const $e=ke>0?Lt/ke:1;w+=$e,C+=1,$e<.99&&S.push({resource:pe,reason:"outOfStock"})}}Ei[n]={satisfactionRatio:C>0?w/C:1,totalTrackedNeeds:C},Co[n]=S});let xs=0,gn=0,$a=0;Object.keys(ae).forEach(n=>{var C,S;const l=J[n]||0;if(l<=0)return;gn+=l;const b=(S=(C=Ei[n])==null?void 0:C.satisfactionRatio)!=null?S:1;xs+=b*l;const w=ae[n];w&&w.needs&&(Co[n]||[]).some($=>$.resource==="food"||$.resource==="cloth")&&($a+=l)});let ea=.3+.7*(gn>0?xs/gn:1);if($a>0&&gn>0){const n=$a/gn,l=n*.4;ea=Math.max(.1,ea-l),n>.1&&We.push("基础需求（食物/布料）严重短缺，劳动效率大幅下降！")}ea<.999&&Object.entries(Te).forEach(([n,l])=>{const b=Oe[n];if(!(!b||n==="silver"||b.type&&b.type==="virtual")&&l>0){const w=l*(1-ea);Te[n]=l-w,ie[n]=Math.max(0,(ie[n]||0)-w)}});const cf=we?Object.entries(we).map(([n,l])=>({id:n,active:!0,modifiers:(l==null?void 0:l.effects)||(l==null?void 0:l.modifiers)})):[];let lf=ol(cf);if(we!=null&&we.tithe){const n=(J.cleric||0)*2*li;if(n>0){const l=je.cleric||0,b=Math.min(l,n);nt.transfer("cleric","state",b,Z.EXPENSE.HEAD_TAX,Z.EXPENSE.HEAD_TAX),xt.cleric=(xt.cleric||0)+b}}const Ui=Ie&&typeof Ie=="object"&&Object.prototype.hasOwnProperty.call(Ie,"targets")?Ie:{enabled:!0,targets:Ie||{}};if(((Ns=Y.dominance)==null?void 0:Ns.faction)==="left"&&(Ui!=null&&Ui.enabled)&&Ui.targets&&Object.keys(Ui.targets).length>0){const{adjustments:n,approvalPenalties:l,adminCost:b}=t0(J,Ui.targets),w=Object.values(J).reduce(($,G)=>$+G,0);let C=0,S=null,q=-1;Object.entries(n).forEach(([$,G])=>{J[$]!==void 0&&(J[$]=Math.max(0,Math.round(J[$]+G)))}),Object.keys(J).forEach($=>{const G=J[$];C+=G,G>q&&(q=G,S=$)});const R=w-C;R!==0&&S&&(J[S]+=R,J[S]<0&&(J[S]=0)),Object.entries(l).forEach(([$,G])=>{Eo[$]&&(Eo[$]-=G*.05)})}let ta={...t};const uf={cabinetStatusReceived:{hasCabinetStatus:!!Y,hasDominance:!!(Y!=null&&Y.dominance),dominanceFaction:(Ls=Y==null?void 0:Y.dominance)==null?void 0:Ls.faction,synergy:Y==null?void 0:Y.synergy,level:Y==null?void 0:Y.level},expansionSettings:{hasSettings:!!de,settingsKeys:de?Object.keys(de):[],allowedCount:de?Object.values(de).filter(n=>n==null?void 0:n.allowed).length:0},conditionCheck:{isDominanceRight:((Fs=Y==null?void 0:Y.dominance)==null?void 0:Fs.faction)==="right",hasExpansionSettings:!!de,willProcess:((Us=Y==null?void 0:Y.dominance)==null?void 0:Us.faction)==="right"&&!!de},epochParam:u};if(console.log("[FREE MARKET SIMULATION DEBUG]",{dominanceCheck:{hasDominance:!!(Y!=null&&Y.dominance),faction:($s=Y==null?void 0:Y.dominance)==null?void 0:$s.faction,isRightWing:((Gs=Y==null?void 0:Y.dominance)==null?void 0:Gs.faction)==="right"},expansionCheck:{hasSettings:!!de,settingsCount:de?Object.keys(de).length:0,allowedBuildings:de?Object.entries(de).filter(([n,l])=>l==null?void 0:l.allowed).map(([n])=>n):[]},willCallProcessExpansions:!!(Y!=null&&Y.dominance)&&Y.dominance.faction==="right"&&!!de}),((qs=Y.dominance)==null?void 0:qs.faction)==="right"&&de){const n={prices:Xe,wages:(c==null?void 0:c.wages)||{}},{expansions:l,wealthDeductions:b}=n0(Vt,je,de,ta,n,h,Na);l.length>0&&(l.forEach(w=>{const C=w.buildingId;ta[C]=(ta[C]||0)+1}),Object.entries(b).forEach(([w,C])=>{je[w]&&nt.transfer(w,"void",C,Z.EXPENSE.BUILDING_COST,Z.EXPENSE.BUILDING_COST)}),Object.assign(lo,ta))}let yn=0,Es=0,$i=0,oa=0;const Ga=[],qa={prices:Xe,wages:(c==null?void 0:c.wages)||{}},Ci=(le||[]).map(n=>{var Lo,To,ve,gt,Jt,jt,ti,hi,oi;if(!n)return n;const l=Sl(n,g),b=1e12;let w=typeof l.wealth=="number"?l.wealth:400;(!Number.isFinite(w)||w<0)&&(w=400);let C=Math.min(w,b);const S=C;ue&&typeof l.salary=="number"?(C+=l.salary,$i+=l.salary,oa+=l.salary,console.log(`[OFFICIAL DEBUG] ${l.name}: Salary paid! +${l.salary}, wealth: ${S} -> ${C}`),bt.official&&(bt.official.income.salary=(bt.official.income.salary||0)+l.salary)):console.log(`[OFFICIAL DEBUG] ${l.name}: NO SALARY! officialsPaid=${ue}, salary=${l.salary}, wealth=${C}`);const q=((Lo=ae.official)==null?void 0:Lo.needs)||{food:1.2,cloth:.2},R=((To=ae.official)==null?void 0:To.luxuryNeeds)||{};let $=0,G=0,z=0;const oe={},be=(re,Mt,po=!1)=>{var Si,_n;if(!re||Mt<=0)return;const io=Oe[re];if(io!=null&&io.unlockTech&&!_.includes(io.unlockTech)||io&&typeof io.unlockEpoch=="number"&&io.unlockEpoch>u||fn&&!fn.has(re))return;let wo=Mt*Ua;if(wo<=0)return;const ii=((Si=B.resourceWaste)==null?void 0:Si[re])||0;ii!==0&&(wo*=1+ii);const Cn=W[re]||0,Go=ln[re]||0,ni=Cn+Go;ni!==0&&(wo*=1+ni);const Vi=j.official||0,mi=un.official||0,Hi=Vi+mi;Hi!==0&&(wo*=1+Hi);const Yi=ie[re]||0;if(Qt(re)){const Yo=co(re),Tn=Li(re),Pn=Yo*(1+Tn),ya=Pn>0?Math.min(wo,C/Pn):wo,qo=Math.min(wo,Yi,ya);if(qo<=0)return;ie[re]=Yi-qo,Te[re]=(Te[re]||0)-qo,Mo[re]=(Mo[re]||0)+qo;const An=qo*Yo,ai=An*Tn;let Po=An;if(ai<0){const F=Math.abs(ai);(ie.silver||0)>=F?(nt.transfer("state","official",F,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),Po-=F,$i+=F,oa+=F):g%20===0&&xi(`国库空虚，无法为 官员 支付 ${((_n=Oe[re])==null?void 0:_n.name)||re} 消费补贴！`)}else ai>0&&(nt.transfer("official","state",ai,Z.EXPENSE.RESOURCE_TAX,Z.EXPENSE.RESOURCE_TAX),Po+=ai);C=Math.max(0,C-Po),$+=Po,po?G+=Po:z+=Po,oe[re]||(oe[re]={amount:0,cost:0,tax:0,luxuryCost:0,essentialCost:0}),oe[re].amount+=qo,oe[re].cost+=Po,oe[re].tax+=ai,po?oe[re].luxuryCost+=Po:oe[re].essentialCost+=Po,Ko.official||(Ko.official={}),Ko.official[re]=(Ko.official[re]||0)+qo;const O=po?Z.EXPENSE.LUXURY_CONSUMPTION:Z.EXPENSE.ESSENTIAL_CONSUMPTION;nt.transfer("official","void",Po,O,O,{resource:re,quantity:qo,price:Yo})}else{const Yo=Math.min(wo,Yi);Yo>0&&(ie[re]=Yi-Yo,oe[re]||(oe[re]={amount:0,cost:0,tax:0,luxuryCost:0,essentialCost:0}),oe[re].amount+=Yo)}};Object.entries(q).forEach(([re,Mt])=>{be(re,Mt,!1)});const he=C/400,Me=Math.min(he,1e9);if(Me>=1&&R){const re=Math.max(1,Math.min(C/400,1e9)),Mt=1+Math.log10(re)*1.6,po=Math.min(100,Number.isFinite(Mt)?Mt:1),io=Math.max(1,Math.min((l.salary||0)/400,1e9)),wo=1+Math.log10(io)*1.2,ii=Math.min(8,Number.isFinite(wo)?wo:1);Object.keys(R).map(Number).filter(Go=>Go<=Me).sort((Go,ni)=>ni-Go).forEach(Go=>{const ni=R[Go];ni&&Object.entries(ni).forEach(([Vi,mi])=>{be(Vi,mi*po*ii,!0)})})}const at=C,dt=ci("official"),tt=((ve=ae.official)==null?void 0:ve.headTaxBase)*dt*li;let ge=0;if(tt!==0)if(tt>0){const re=Math.min(C,tt);ge=re,C=Math.max(0,C-re),nt.transfer("official","state",re,Z.EXPENSE.HEAD_TAX,Z.EXPENSE.HEAD_TAX),wi.official=(wi.official||0)+re,xt.official=(xt.official||0)+re}else{const re=Math.abs(tt);(ie.silver||0)>=re&&(nt.transfer("state","official",re,Z.INCOME.SUBSIDY,Z.INCOME.SUBSIDY),C+=re,$i+=re,oa+=re)}const Fe=C,qe=tt;let Pe=0;(gt=l.ownedProperties)!=null&&gt.length&&l.ownedProperties.forEach(re=>{const Mt=vl(re,qa,h,Na,lo);Mt>0?Pe+=Mt:Mt<0&&(C=Math.max(0,C+Mt))}),Pe>0&&(C+=Pe,$i+=Pe,nt.transfer("void","official",Pe,Z.INCOME.OWNER_REVENUE,Z.INCOME.OWNER_REVENUE));const Je=C,pe=(l.salary||0)+Pe,rt=bl({...l,wealth:C},$,pe),Ge=Number.isFinite(l.baseSalary)?l.baseSalary:l.salary||0,ke=Ge>0?(l.salary||0)/Ge:1;let pt="satisfied";ke<.4?pt="desperate":ke<.7?pt="struggling":ke<.95&&(pt="uncomfortable");const ot=["satisfied","uncomfortable","struggling","desperate"];let Ot;if(rt==="satisfied")Ot="satisfied";else{const re=Math.max(ot.indexOf(rt),ot.indexOf(pt));Ot=ot[re]||rt}const Ue=xl({...l,wealth:C},g,qa,h,Y,lo,te,u,_),De=Array.isArray(l.ownedProperties)?[...l.ownedProperties]:[],Se={...l.investmentProfile};if(Ue&&C>=Ue.cost){C=Math.max(0,C-Ue.cost);const re=`${Ue.buildingId}_off_${l.id}_${g}_${Math.floor(Math.random()*1e3)}`;De.push({buildingId:Ue.buildingId,instanceId:re,purchaseDay:g,purchaseCost:Ue.cost,level:0}),Se.lastInvestmentDay=g,lo[Ue.buildingId]=(lo[Ue.buildingId]||0)+1,Ue.buildingId&&((jt=(Jt=Le==null?void 0:Le.logVisibility)==null?void 0:Jt.showOfficialLogs)==null||jt)&&We.push(`🏗️ 官员${l.name}投资了 ${Ue.buildingId}（花费 ${Math.ceil(Ue.cost)} 银）`)}const Ce=El({...l,wealth:C,ownedProperties:De,investmentProfile:Se},g,qa,h,Y,lo,me,te);if(Ce&&C>=Ce.cost){C=Math.max(0,C-Ce.cost);const re=De[Ce.propertyIndex];re&&(re.level=Ce.toLevel,Se.lastUpgradeDay=g,Ga.push({buildingId:Ce.buildingId,fromLevel:Ce.fromLevel,toLevel:Ce.toLevel,officialName:l.name,cost:Ce.cost}))}const Pt=C,Ct=(Ue==null?void 0:Ue.cost)||0,Lt=(Ce==null?void 0:Ce.cost)||0;yn+=C,Es+=$;let Be=(ti=l.loyalty)!=null?ti:75,$e=(hi=l.lowLoyaltyDays)!=null?hi:0;const Ze=typeof l.politicalStance=="string"?l.politicalStance:(oi=l.politicalStance)==null?void 0:oi.stanceId,At=l.stanceConditionParams||[],Rt=Object.values(ho||{}).reduce((re,Mt)=>re+(Mt||0),0),fo={...ft,official:ue?(l.salary||0)+(l.lastDayPropertyIncome||0):0},st={classApproval:Eo,classInfluence:ho,classIncome:fo,totalInfluence:Rt,stability:(L!=null?L:50)/100,rulingCoalition:U,legitimacy:X!=null?X:0,taxPolicies:h,prices:Xe,epoch:u,population:i?Object.values(i).reduce((re,Mt)=>re+(Mt||0),0):0,atWar:(E||[]).some(re=>re.isAtWar)},_o=Mr(Ze,st,At),{DAILY_CHANGES:ct,COUP_THRESHOLD:Xt,MAX:oo,MIN:St}=Wn;Be+=_o?ct.stanceSatisfied:ct.stanceUnsatisfied,Ot==="satisfied"?Be+=ct.financialSatisfied:Ot==="uncomfortable"?Be+=ct.financialUncomfortable:Ot==="struggling"?Be+=ct.financialStruggling:Ot==="desperate"&&(Be+=ct.financialDesperate);const It=(L!=null?L:50)/100;return It>.7?Be+=ct.stabilityHigh:It<.3&&(Be+=ct.stabilityLow),Be+=ue?ct.salaryPaid:ct.salaryUnpaid,Be=Math.max(St,Math.min(oo,Be)),Be<Xt?$e+=1:$e=0,{...l,wealth:Math.min(b,Number.isFinite(C)?Math.max(0,C):400),lastDayExpense:$,financialSatisfaction:Ot,ownedProperties:De,investmentProfile:Se,lastDayPropertyIncome:Pe,lastDayExpenseBreakdown:oe,lastDayLuxuryExpense:G,lastDayEssentialExpense:z,loyalty:Be,lowLoyaltyDays:$e,isStanceSatisfied:_o,_debug:{initialWealth:S,salaryPaid:ue,salaryAmount:l.salary||0,wealthAfterSalary:S+(ue&&l.salary||0),dailyExpense:$,wealthAfterGoods:at,headTaxPlanned:qe,headTaxPaid:ge,wealthAfterTax:Fe,propertyIncome:Pe,wealthAfterProperty:Je,investmentCost:Ct,upgradeCost:Lt,wealthAfterInvestment:Pt,wealthFinal:C}}});je.official=yn,xt.official=(xt.official||0)+Es,vi.official=xt.official,$o.official=oa;const ia=y0({popStructure:{...J,official:0},wealth:je,classIncome:ft,classExpense:xt,classShortages:Co,epoch:u,techsUnlocked:_,priceMap:co,livingStandardStreaks:ce}),Cs=Ci.length;if(Cs>0){const n=yn/Cs;let l="赤贫",b=30;n>300?(l="奢华",b=95):n>100?(l="富裕",b=85):n>50?(l="小康",b=75):n>20?(l="温饱",b=60):(l="贫困",b=45);const w=n/400,C={奢华:{icon:"Crown",color:"text-purple-400"},富裕:{icon:"Gem",color:"text-blue-400"},小康:{icon:"Home",color:"text-green-400"},温饱:{icon:"UtensilsCrossed",color:"text-yellow-400"},贫困:{icon:"AlertTriangle",color:"text-orange-400"},赤贫:{icon:"Skull",color:"text-red-500"}},S=C[l]||C.赤贫;ia.classLivingStandard.official={level:l,satisfaction:1,satisfactionRate:1,approvalCap:b,needsMet:1,wealthRatio:w,wealthPerCapita:n,wealthMultiplier:Math.min(6,1+Math.log(Math.max(1,n/100))*.5),icon:S.icon,color:S.color,bgColor:S.color.replace("text-","bg-").replace("-400","-900/20"),borderColor:S.color.replace("text-","border-").replace("-400","-500/30"),score:n>300?90:n>100?75:n>50?60:n>20?45:25};const q=ce.official||{},R=q.level===l;ia.livingStandardStreaks.official={level:l,streak:R?(q.streak||0)+1:1}}const Gi=ia.classLivingStandard,_s=ia.livingStandardStreaks,Ts={};Object.keys(ae).forEach(n=>{var ct,Xt,oo,St,It,Lo,To;const l=J[n]||0;if(l===0)return;const b=Ei[n],w=(ct=b==null?void 0:b.satisfactionRatio)!=null?ct:1,C=Gi[n];let S=(Xt=C==null?void 0:C.approvalCap)!=null?Xt:100;const q=k0(n,U);if(q){const ve=(C==null?void 0:C.level)||"温饱",gt=D0(ve);S=Math.max(0,S-gt)}let R=70;const $=C==null?void 0:C.level;$==="奢华"?R=95:$==="富裕"?R=85:$==="小康"&&(R=75),q&&B.coalitionApproval&&(R+=B.coalitionApproval);const G=ci(n);(St=(oo=ae[n])==null?void 0:oo.headTaxBase)!=null;const z=Math.max(0,(wi[n]||0)/Math.max(1,l)),oe=(ft[n]||0)/Math.max(1,l),be=(je[n]||0)/Math.max(1,l),he=oe>.001&&z>oe*.5,Me=be>z*100;he&&!Me?R=Math.min(R,40):G<.6&&(R+=5);const at=(wi[n]||0)/Math.max(1,l),dt=(gs[n]||0)/Math.max(1,l),ze=dt>.01?at/dt:0,tt=.05,ge=.2,Fe=1;let qe=0;ze>tt&&at>0&&(ze<=ge?qe=(ze-tt)/(ge-tt)*25:qe=25+Math.min(25,(ze-ge)/(Fe-ge)*25));const Pe=Qe[n]||0,rt=Math.max(0,Pe*(1-.03)+qe*.5);Ts[n]=rt;const Ge=Math.max(qe,rt),ke=Co[n]||[],pt=ke.filter(ve=>ve.isBasic),ot=ke.filter(ve=>!ve.isBasic),Ot=(It=b==null?void 0:b.totalTrackedNeeds)!=null?It:0;if(pt.length>0&&Ot>0&&(pt.length>=Object.keys(((Lo=ae[n])==null?void 0:Lo.needs)||{}).length?R=Math.min(R,0):R=Math.min(R,30)),ot.length>0){const ve=Math.min(15,ot.length*3);R-=ve}const Ue=_s[n]||{};if(Ue.level==="赤贫"||Ue.level==="贫困"){const ve=Ue.level==="赤贫"?2.5:1.5,gt=Math.min(30,Math.ceil((Ue.streak||0)*ve));gt>0&&(R-=gt)}let De=0;const Se=(D||{})[n];if(Se&&Se.length>0){let Jt=0;for(let jt=Se.length-1;jt>=0&&Jt<20&&Se[jt]>=.95;jt--)Jt+=1;Jt>=3&&(De=Math.min(15,Jt*.6),R=Math.min(100,R+De))}let Ce=0,Pt=0;const Ct=(k||{})[n];if(Ct&&Ct.length>=20){const ve=Ct.slice(-10).reduce((Jt,jt)=>Jt+jt,0)/10,gt=Ct.slice(-20,-10).reduce((Jt,jt)=>Jt+jt,0)/10;gt>1&&(Ce=(ve-gt)/gt,Pt=Math.min(15,Math.abs(Ce)*50),Ce>.05?R+=Pt:Ce<-.05&&(R-=Pt))}if(w>=.98&&(R=Math.min(100,R+10)),n==="unemployed"){const gt=2+l/Math.max(1,o)*30;R-=gt}if(Et[n]={baseTarget:0,livingStandardBase:0,taxReliefBonus:0,luxuryShortagePenalty:0,povertyPenalty:0,sustainedNeedsBonus:0,wealthTrendBonus:0,positiveSatisfactionBonus:0,unemployedPenalty:0,eventBonus:0,decreeBonus:0,officialTargetBonus:0,legitimacyPenalty:0,taxShockPenalty:0,shockCapApplied:null,currentApprovalStart:0,targetApprovalPreShockCap:0,targetApprovalFinal:0,adjustmentSpeed:.02,inertiaDelta:0,effectiveApprovalCap:S,capApplied:null,approvalAfterCap:0,approvalFinal:0},Et[n].baseTarget=70,Et[n].livingStandardBase=R-70,G<.6&&(Et[n].taxReliefBonus=5),((ot==null?void 0:ot.length)||0)>0&&(Et[n].luxuryShortagePenalty=-Math.min(15,ot.length*3)),(Ue==null?void 0:Ue.level)==="赤贫"||(Ue==null?void 0:Ue.level)==="贫困"){const ve=Ue.level==="赤贫"?2.5:1.5,gt=Math.min(30,Math.ceil((Ue.streak||0)*ve));Et[n].povertyPenalty=-gt}if(De&&(Et[n].sustainedNeedsBonus=De),Pt&&Ce&&Math.abs(Ce)>.05&&(Et[n].wealthTrendBonus=Ce>0?Pt:-Pt),w>=.98&&(Et[n].positiveSatisfactionBonus=10),n==="unemployed"){const gt=2+l/Math.max(1,o)*30;Et[n].unemployedPenalty=-gt}const Lt=(V==null?void 0:V[n])||0;Lt&&(R+=Lt,Et[n].eventBonus=Lt);const Be=lf[n]||0;Be&&(R+=Be,Et[n].decreeBonus=Be);const $e=((To=ut==null?void 0:ut.approval)==null?void 0:To[n])||0;$e>0&&(R+=$e,Et[n].officialTargetBonus=$e);const Ze=I0(X);Ze<0&&(R+=Ze,Et[n].legitimacyPenalty=Ze);let At=S;$e<0&&(At=Math.max(0,S+$e)),Et[n].effectiveApprovalCap=At;let Rt=Eo[n]||50;if(Et[n].currentApprovalStart=Rt,Et[n].adjustmentSpeed=.02,Ge>1&&(Rt=Math.max(0,Rt-Ge),Et[n].taxShockPenalty=-Ge,Ge>5)){const ve=Math.max(0,70-Ge*2);Et[n].shockCapApplied=ve,R=Math.min(R,ve)}Et[n].targetApprovalPreShockCap=R,Et[n].targetApprovalFinal=R;let st=Rt+(R-Rt)*.02;Et[n].inertiaDelta=st-Rt;const _o=st;st=Math.min(st,At),st!==_o&&(Et[n].capApplied=At),Et[n].approvalAfterCap=st,Et[n].approvalFinal=Math.max(0,Math.min(100,st)),Eo[n]=Math.max(0,Math.min(100,st))}),(J.unemployed||0)===0&&p.unemployed!==void 0&&(Eo.unemployed=Math.min(100,p.unemployed+5));let uo=o,na=0;Object.keys(ae).forEach(n=>{const l=je[n]||0,b=J[n]||0;if(l>0&&b>0){const w=Gi[n],C=w==null?void 0:w.level;if(C==="赤贫"||C==="贫困"||C==="温饱")return;const S=l/b;if(S/Cr<1.2&&C!=="奢华")return;let R=.005;C==="小康"?R=.001:C==="富裕"&&(R=.003);const G=S*R*b;let z=parseFloat(G.toFixed(2)),oe=0;bt[n]&&bt[n].expense&&bt[n].expense.luxuryNeeds&&Object.values(bt[n].expense.luxuryNeeds).forEach(he=>{oe+=he.cost||0});const be=parseFloat((oe*.5).toFixed(2));z=Math.min(z,be),z>0&&(nt.transfer(n,"void",z,Z.EXPENSE.DECAY,Z.EXPENSE.DECAY),xt[n]=(xt[n]||0)+z)}}),Object.keys(ae).forEach(n=>{mo[n]=Qi(je[n]||0)});let ui=Object.values(mo).reduce((n,l)=>n+l,0);Object.keys(ae).forEach(n=>{const l=J[n]||0;if(l===0)return;const b=ae[n],w=mo[n]||0,C=ui>0?w/ui:0;ho[n]=b.influenceBase*l+C*10});const ff=Object.values(ho).reduce((n,l)=>n+l,0),df=Al(le||[],ue,{classInfluence:ho,totalInfluence:ff,polityEffects:Hn,currentDay:g});Object.entries(df).forEach(([n,l])=>{ho[n]!==void 0&&l>0&&(ho[n]+=l)});let fi=Object.values(ho).reduce((n,l)=>n+l,0);const pf=A0(U,ho,fi);pn=R0(pf),B.legitimacyBonus&&(pn=Math.max(0,Math.min(100,pn*(1+B.legitimacyBonus)))),ja=Or(pn);let Va=0;B.factionConflict&&(Va+=B.factionConflict),Object.keys(ae).forEach(n=>{var S;const l=J[n]||0;if(l===0)return;const b=Eo[n]||50;if(b>=25)return;const w=fi>0?(ho[n]||0)/fi:0,C=((S=ae[n])==null?void 0:S.name)||n;if(b<20&&w<.07){const q=Math.max(.03,(20-b)/200),R=Math.min(l,Math.max(1,Math.floor(l*q)));if(R>0){const z=je[n]||0,be=(l>0?z/l:0)*R;be>0&&nt.transfer(n,"void",be,Z.EXPENSE.CAPITAL_FLIGHT,Z.EXPENSE.CAPITAL_FLIGHT),J[n]=Math.max(0,l-R)}const $=(Co[n]||[]).map(z=>{var Me;const oe=typeof z=="string"?z:z.resource,be=typeof z=="string"?"outOfStock":z.reason,he=((Me=Oe[oe])==null?void 0:Me.name)||oe;return be==="unaffordable"?`${he}(买不起)`:be==="outOfStock"?`${he}(缺货)`:be==="both"?`${he}(缺货且买不起)`:he}).join("、"),G=$?`，短缺资源：${$}`:"";We.push(`${C} 阶层对政局失望，${R} 人离开了国家，带走了 ${(R*(je[n]||0)/Math.max(1,l)).toFixed(1)} 银币${G}。`)}else if(w>=.12){const q=Math.min(.2,.05+w*.15);Va+=q;const R=(Co[n]||[]).map(G=>{var he;const z=typeof G=="string"?G:G.resource,oe=typeof G=="string"?"outOfStock":G.reason,be=((he=Oe[z])==null?void 0:he.name)||z;return oe==="unaffordable"?`${be}(买不起)`:oe==="outOfStock"?`${be}(缺货)`:oe==="both"?`${be}(缺货且买不起)`:be}).join("、"),$=R?`（短缺：${R}）`:"";We.push(`${C} 阶层的愤怒正在削弱社会稳定${$}。`)}});const Ha=[],Ya=[];Object.keys(ae).forEach(n=>{var $,G;const l=ae[n];if(!l.buffs||(J[n]||0)===0)return;const b=Eo[n]||50,w=((G=($=Ei[n])==null?void 0:$.satisfactionRatio)!=null?G:1)>=.9,C=fi>0?(ho[n]||0)/fi:0,S=C>.8?2:C>.5?1.5:1,q=b>=85&&C>=.3,R=b>=85&&w;if((q||R)&&l.buffs.satisfied){const z=xa(l.buffs.satisfied,S);Ha.push({class:n,...z})}else if(b<40&&l.buffs.dissatisfied&&C>=.3){const z=xa(l.buffs.dissatisfied,S);Ya.push({class:n,...z})}});const{stabilityValue:Ps,efficiency:aa}=il({popStructure:J,classApproval:Eo,classInfluence:ho,totalInfluence:fi,newActiveBuffs:Ha,newActiveDebuffs:Ya,eventStabilityModifier:N,extraStabilityPenalty:Va,currentStability:L,stabilityBonus:B.stabilityBonus||0}),Ho=u;let di=0;const za=Math.max(5,o||5),bn=Math.max(100,(Hs=(Vs=ie.silver)!=null?Vs:e==null?void 0:e.silver)!=null?Hs:0);let ra=-1/0;const hf=jn(g,"priceUpdate"),sa=jn(g,"tradeUpdate"),Bo=jn(g,"diplomacyUpdate"),ca=jn(g,"aiDecision");(E||[]).forEach(n=>{n.lastPeaceRequestDay&&n.lastPeaceRequestDay>ra&&(ra=n.lastPeaceRequestDay)});let Wt=v!=null&&v.organizations?[...v.organizations]:[],_i=!1,mt=(E||[]).map(n=>{var R,$,G,z,oe,be,he,Me,at,dt,ze,tt;const l={...n};if(l.alliedWithPlayer=Wt.some(ge=>ge.type==="military_alliance"&&ge.members.includes(n.id)&&ge.members.includes("player")),Ye!=null&&Ye.nationDelta&&Ye.nationDelta[n.id]){const ge=Ye.nationDelta[n.id];l.budget=Math.max(0,(l.budget||0)+(ge.budget||0)),l.relation=Math.min(100,Math.max(-100,(l.relation||0)+(ge.relation||0))),ge.inventory&&(l.inventory=l.inventory||{},Object.entries(ge.inventory).forEach(([Fe,qe])=>{l.inventory[Fe]=Math.max(0,(l.inventory[Fe]||0)+qe)}))}if(!(Ho>=((R=n.appearEpoch)!=null?R:0)&&(n.expireEpoch==null||Ho<=n.expireEpoch)))return l.isAtWar&&(l.isAtWar=!1,l.warScore=0,l.warDuration=0,l.warStartDay=null,l.enemyLosses=0,l.warTarget=null,l.isPeaceRequesting=!1,l.peaceTribute=null),l;if(l.epoch===void 0&&(($=l.foreignPower)!=null&&$.initializedAtTick?l.epoch=Ho:l.epoch=(G=l.appearEpoch)!=null?G:0),ju({nation:l,tick:g,resources:ie,logs:We,onTreasuryChange:Ht}),l.isRebelNation){if(lu(l),l.isAtWar){const ge=Il({nation:l,tick:g,epoch:u,resources:ie,population:o,army:y,logs:We,onTreasuryChange:Ht,onResourceChange:ht});na+=ge.raidPopulationLoss}return kl({nation:l,tick:g,logs:We}),l}l.foreignPower={...l.foreignPower||{}};const w=l.foreignPower,C=l.wealthTemplate||l.wealth||800;w.baseRating==null&&(w.baseRating=Math.max(.4,C/800));const S=Math.min(.9,Math.max(.1,(oe=(z=w.volatility)!=null?z:l.marketVolatility)!=null?oe:.3));if(w.volatility=S,w.appearEpoch==null&&(w.appearEpoch=(be=l.appearEpoch)!=null?be:0),w.populationFactor==null){const ge=(he=l.culturalTraits)!=null&&he.agriculturalFocus?1.15:1;w.populationFactor=$t(w.baseRating*ge,.6,2.5)}if(w.wealthFactor==null){const ge=1+Math.max(0,w.appearEpoch)*.05;w.wealthFactor=$t(w.baseRating*ge,.5,3.5)}if(!w.initializedAtTick){const Fe=1+Math.max(0,Ho-((Me=w.appearEpoch)!=null?Me:0))*.08,qe=.9+Math.random()*.25,Pe=$t(w.populationFactor*Fe*qe,.6,2.5),Je=$t(w.wealthFactor*Fe*qe,.5,3.5),pe=Math.max(3,Math.round(za*Pe)),rt=Math.max(100,Math.round(bn*Je));l.population=pe,l.wealth=rt,l.budget=Math.max(50,rt*.5),l.economyTraits={...l.economyTraits||{},basePopulation:pe,baseWealth:rt},w.populationFactor=Pe,w.wealthFactor=Je,w.initializedAtTick=g,w.playerSnapshot={population:za,wealth:bn},l.wealthTemplate||(l.wealthTemplate=rt)}if(sa&&au({nation:l,tick:g,gameSpeed:s}),l.isAtWar){l.warDuration=(l.warDuration||0)+1;const ge=(E||[]).filter(qe=>qe.isAtWar).length||1,Fe=((Qn==null?void 0:Qn.dailyExpense)||0)/ge;if(l.warTotalExpense=(l.warTotalExpense||0)+Fe,Ho>=1&&ca){const qe=Dl({nation:l,tick:g,epoch:u,resources:ie,army:y,logs:We,difficultyLevel:te,onTreasuryChange:Ht,onResourceChange:ht});na+=qe.raidPopulationLoss}ca&&(Wl({nation:l,tick:g,lastGlobalPeaceRequest:ra,logs:We})&&(ra=g),Bl({nation:l,tick:g,population:o,playerWealth:bn,logs:We}),Ol({nation:l,tick:g,population:o,playerWealth:bn,resources:ie,logs:We}))}else l.warDuration&&(l.warDuration=0,l.warTotalExpense=0);(at=l.relation)!=null,Bo&&iu(l,te);const q=Ir(te);if(B.diplomaticIncident&&!l.isRebelNation&&!l.isAtWar){const ge=B.diplomaticIncident/30*q.bad;l.relation=Math.min(100,Math.max(0,((dt=l.relation)!=null?dt:50)-ge))}if(B.diplomaticBonus&&!l.isRebelNation&&!l.isAtWar){const ge=B.diplomaticBonus/30*q.good;l.relation=Math.min(100,Math.max(0,((ze=l.relation)!=null?ze:50)+ge))}if(Bo){const ge=ou(l,We,{organizations:Wt});ge&&ge.memberLeaveRequests&&ge.memberLeaveRequests.forEach(Fe=>{const qe=Wt.findIndex(Pe=>Pe.id===Fe.orgId);if(qe>=0){const Pe=Wt[qe];Wt[qe]={...Pe,members:Pe.members.filter(Je=>Je!==Fe.nationId)},_i=!0}})}return(tt=l.aggression)!=null,ca&&jl({nation:l,nations:E,tick:g,epoch:Ho,resources:ie,stabilityValue:Ps,logs:We,difficultyLevel:te,diplomacyOrganizations:{organizations:Wt}}),di+=fu({nation:l,resources:ie,logs:We,onTreasuryChange:Ht}),uu(l),sa&&(ru({nation:l,tick:g}),su({nation:l,tick:g}),du(l,We),cu({nation:l,epoch:l.epoch,playerPopulationBaseline:za,playerWealthBaseline:bn,tick:g})),l});mt=Gl(mt);const Xa=g%30===0;Xa&&Bo&&(mt=ql(mt,te));let qi=null;if(Xa&&Bo&&((Ys=v==null?void 0:v.organizations)==null?void 0:Ys.length)>0){if(qi=Ul({organizations:v.organizations,nations:mt,playerWealth:ie.silver||0,daysElapsed:g}),qi.fees.player>0){const n=Math.min(ie.silver||0,qi.fees.player);n>0&&Ee(-n,"organization_membership_fee")}if(qi.fees.ai)for(const[n,l]of Object.entries(qi.fees.ai)){const b=mt.find(w=>w.id===n);b&&(b.wealth=Math.max(0,(b.wealth||0)-l))}qi.logs.forEach(n=>We.push(n))}let pi=null;if(Xa&&Bo&&(pi=mu({nations:mt,epoch:u,playerPopulation:uo,playerResources:ie,classApproval:p,daysElapsed:g,maxPop:Uo}),pi.immigrantsIn>0||pi.emigrantsOut>0)){const n=pi.immigrantsIn-pi.emigrantsOut;uo=Math.max(10,uo+n),Object.keys(pi.byStratum).length>0&&(J=gu(J,pi.byStratum)),yu(pi.events).forEach(b=>We.push(b))}let Ti=null;if(Bo){if(Ti=_u(mt,{daysElapsed:g}),Ti&&Ti.updates)for(const n of Ti.updates){const l=mt.findIndex(b=>b.id===n.id);l>=0&&(mt[l]={...mt[l],...n})}if(Ti&&Ti.events)for(const n of Ti.events)n.type==="civil_war_started"?We.push(`⚔️ ${n.nationName} 爆发内战！反对派势力与政府军交战中...`):n.type==="civil_war_ended"&&(n.winner==="rebels"?We.push(`🏴 ${n.nationName} 的叛军取得胜利，政权更迭为${n.newGovernment||"新政府"}！`):We.push(`🏛️ ${n.nationName} 的政府军平定叛乱，恢复秩序。`))}const Oo=mt.filter(n=>{var l;return u>=((l=n.appearEpoch)!=null?l:0)&&(n.expireEpoch==null||u<=n.expireEpoch)&&!n.isRebelNation});let Pi=null;if(Bo&&(c!=null&&c.prices)){if(Pi=C0(c.prices,mt,g),Pi.marketPrices&&(c={...c,prices:Pi.marketPrices}),Pi.nationPriceUpdates)for(const n of Pi.nationPriceUpdates){const l=mt.findIndex(b=>b.id===n.nationId);l>=0&&(mt[l]={...mt[l],nationPrices:n.nationPrices})}Pi.logs&&Pi.logs.forEach(n=>We.push(n))}if(Bo&&Vl(Oo,g,We,te),Bo&&Hl(Oo,We),sa&&zl(Oo,We,v),sa&&Xl(Oo,g,ie,c,We,Yt,v,Ht),Bo&&Jl(Oo,g,u,We),Bo&&tu(Oo,g,We,{organizations:Wt},Ho),Bo){const n=Ql(Oo,g,We,{organizations:Wt},Ho),l=Kl(Oo,g,We,{organizations:Wt},Ho);n&&n.createdOrganizations.length>0&&(Wt.push(...n.createdOrganizations),_i=!0);const b=[...(n==null?void 0:n.memberJoinRequests)||[],...(l==null?void 0:l.memberJoinRequests)||[]];b.length>0&&b.forEach(S=>{const q=Wt.findIndex(R=>R.id===S.orgId);if(q>=0){const R=Wt[q],$=Ni[R.type],G=($==null?void 0:$.maxMembers)||1/0;!R.members.includes(S.nationId)&&R.members.length<G&&(Wt[q]={...R,members:[...R.members,S.nationId]},_i=!0)}});const w=eu(Oo,g,We,{organizations:Wt},Ho);(zs=w==null?void 0:w.memberLeaveRequests)!=null&&zs.length&&w.memberLeaveRequests.forEach(S=>{const q=Wt.findIndex(R=>R.id===S.orgId);if(q>=0){const R=Wt[q];R.members.includes(S.nationId)&&(Wt[q]={...R,members:R.members.filter($=>$!==S.nationId)},_i=!0)}});const C=[];Wt.forEach(S=>{var R;const q=((R=S==null?void 0:S.members)==null?void 0:R.includes("player"))&&S.members.length===1;if($l(S)&&!q){We.push(`🏛️ "${S.name}" 因成员不足而解散。`),_i=!0;return}C.push(S)}),Wt=C}ca&&(Nl(Oo,g,We,{organizations:Wt}),Ll(Oo,mt,g,We,{organizations:Wt}),Fl(Oo,mt,g,We));let Mn=0,vn=Math.max(0,r||0),Ai=Math.max(0,Uo-uo);if(Ai>0){const n=m0(te);Math.random()<.01&&console.log(`[DEBUG] PopGrowth: diff=${te}, mult=${n}`);const l=Math.max(0,o||0)*Hc*n;if(vn+=l,o<On){const w=Math.max(0,(On-o)/On);vn+=Yc*w*n}const b=Math.min(Ai,Math.floor(vn));b>0&&(Mn+=b,vn-=b,Ai-=b)}if(Ai>0&&Object.keys(ae).forEach(n=>{var be;if(Ai<=0)return;const l=J[n]||0;if(l<=0)return;const b=(be=Eo[n])!=null?be:50,w=Math.max(0,(b-25)/75);if(w<=0)return;const C=mo[n]||0,S=l>0?C/l:0,q=Math.max(.3,Math.min(2,S/Cr)),R=Vc*w*q*(1+(B.populationGrowthBonus||0));if(R<=0)return;let $=l*R;if($<=0)return;const G=Math.floor($);let z=G;const oe=$-G;Math.random()<oe&&(z+=1),!(z<=0)&&(z=Math.min(z,Ai),!(z<=0)&&(Mn+=z,Ai-=z))}),Mn>0&&(J.unemployed=(J.unemployed||0)+Mn,uo=Math.min(Uo,uo+Mn)),(ie.food||0)<=0&&(ie.food=0,Math.random()>.9&&uo>2)){if(uo=uo-1,(J.unemployed||0)>0)J.unemployed=J.unemployed-1;else{const n=zt.filter(l=>(J[l]||0)>0);if(n.length>0){const l=n[Math.floor(Math.random()*n.length)];J[l]=Math.max(0,(J[l]||0)-1)}}We.push("饥荒导致人口减少！")}if(Object.keys(ae).forEach(n=>{if(n==="official")return;const l=J[n]||0;if(l===0)return;const b=ae[n];if(!b||!b.needs)return;const w=Co[n]||[],C=w.some(R=>(typeof R=="string"?R:R.resource)==="food"),S=w.some(R=>(typeof R=="string"?R:R.resource)==="cloth"),q=(D||{})[n];if(q&&q.length>=5){const R=q.slice(-5),$=R.reduce((G,z)=>G+z,0)/R.length;if((C||S)&&$<.85){const G=b.name||n;let z=0;$<.5?z=.02+(.5-$)/.5*.08:z=.005+(.85-$)/.35*.015;const oe=Math.max(1,Math.floor(l*z));oe>0&&(J[n]=Math.max(0,l-oe),xi(`${G} 阶层因长期缺乏${C&&S?"食物和布料":C?"食物":"布料"}，${oe} 人死亡！`))}}}),zt.reduce((n,l)=>n+(J[l]||0),0)+(J.unemployed||0),na>0){let n=na;if((J.unemployed||0)>=n)J.unemployed=J.unemployed-n;else{const l=J.unemployed||0;J.unemployed=0,n-=l;const b=zt.reduce((w,C)=>w+(J[C]||0),0);b>0&&n>0&&zt.forEach(w=>{if(n<=0)return;const C=J[w]||0;if(C<=0)return;const S=C/b,q=Math.min(C,Math.max(1,Math.floor(S*n)));J[w]=C-q,n-=q})}}uo=zt.reduce((n,l)=>n+(J[l]||0),0)+(J.unemployed||0),uo=Math.max(0,Math.floor(uo)),Object.keys(ie).forEach(n=>{ie[n]<0&&(ie[n]=0)});let wn={...Xe},vo={...(c==null?void 0:c.wages)||{}};const mf=.35;if(hf){vo={},Object.entries(Qo).forEach(([R,$])=>{let G=0;const z=J[R]||0;if(z>0){const he=$o[R]||0,Me=vi[R]||0;let at=he,dt=Me;he===0&&Qo[R].totalSlots===0?G=bi[R]||0:G=(at-dt)/z}else $.weightedWage>0&&$.totalSlots>0?G=$.weightedWage/$.totalSlots:G=bi[R]||0;G=Math.max(0,G);const oe=bi[R]||0,be=oe+(G-oe)*mf;vo[R]=parseFloat(be.toFixed(2))});const n=Math.max(0,(Xs=uo!=null?uo:o)!=null?Xs:0),l=(Ut==null?void 0:Ut.market)||{},b=Math.max(0,(Js=l.supplyDemandWeight)!=null?Js:1),w=Math.max(0,l.virtualDemandPerPop||0),C=f0(te),S=Math.max(.1,((Zs=l.inventoryTargetDays)!=null?Zs:1.5)*C),q=Math.max(0,(Qs=l.inventoryPriceImpact)!=null?Qs:.25);Object.keys(Oe).forEach(R=>{var Ot,Ue;if(!Qt(R))return;const $=Oe[R],G=($==null?void 0:$.marketConfig)||{};G.supplyDemandWeight!==void 0&&Math.max(0,G.supplyDemandWeight);const z=G.virtualDemandPerPop!==void 0?Math.max(0,G.virtualDemandPerPop):w,oe=G.inventoryTargetDays!==void 0?Math.max(.1,G.inventoryTargetDays*C):S;G.inventoryPriceImpact!==void 0&&Math.max(0,G.inventoryPriceImpact),Do[R];const be=Mo[R]||0,he=z*n,at=be+he,dt=ie[R]||0,ze=dt<=0?.01:at>0?dt/at:oe,tt=[];let ge=0;Vt.forEach(De=>{const Se=lo[De.id]||0;if(Se<=0)return;const Ce=me[De.id]||{};let Pt=0;Object.entries(Ce).forEach(([Lt,Be])=>{const $e=parseInt(Lt);Number.isFinite($e)&&$e>0&&Be>0&&(Pt+=Be)});const Ct={0:Math.max(0,Se-Pt)};Object.entries(Ce).forEach(([Lt,Be])=>{const $e=parseInt(Lt);Number.isFinite($e)&&$e>0&&Be>0&&(Ct[$e]=Be)}),Object.entries(Ct).forEach(([Lt,Be])=>{var ti,hi,oi,re,Mt;const $e=parseInt(Lt),Ze=Nt(De,$e),At=(ti=Ze.output)==null?void 0:ti[R];if(!At||At<=0)return;const Rt=De.marketConfig||{},fo=Rt.price||(Ut==null?void 0:Ut.price)||{},st=Rt.wage||(Ut==null?void 0:Ut.wage)||{};Nn(Gn,fo);const _o=Nn(Gn,st);Ze.input&&Object.entries(Ze.input).forEach(([po,io])=>{!io||io<=0||(Xe[po]||Io(po),Li(po))});const ct=De.owner,Xt=Ze.jobs||{},oo=ct&&Xt[ct];Object.keys(Xt).length>0&&!oo&&Object.entries(Xt).forEach(([po,io])=>{!io||io<=0||vo[po]||bo(po)}),(oi=(hi=Yt==null?void 0:Yt.businessTaxRates)==null?void 0:hi[De.id])!=null,(re=De.businessTaxBase)!=null,ct&&(_o[ct]||0)*(Xt[ct]||0);const St=ze/oe;let It=1;St<.5?It=1+(1-St*2)*5:St<1?It=1+(1-St)*1:St>2?(It=.7-(St-2)*.3,It=Math.max(.1,It)):St>1&&(It=1-(St-1)*.3);let ve=Io(R)*It;const gt=(Mt=$.minPrice)!=null?Mt:Oi,Jt=$.maxPrice;ve=Math.max(ve,gt),Jt!==void 0&&(ve=Math.min(ve,Jt));const jt=At*Be;ge+=jt,tt.push({price:ve,output:jt})})});let Fe=0;if(ge>0&&tt.length>0){let De=0;tt.forEach(Se=>{De+=Se.price*Se.output}),Fe=De/ge}else{const De=Io(R),Se=ze/oe;let Ce=1;Se<.5?Ce=1+(1-Se*2)*5:Se<1?Ce=1+(1-Se)*1:Se>2?(Ce=.7-(Se-2)*.3,Ce=Math.max(.1,Ce)):Se>1&&(Ce=1-(Se-1)*.3),Fe=De*Ce;const Pt=(Ot=$.minPrice)!=null?Ot:Oi,Ct=$.maxPrice;Fe=Math.max(Fe,Pt),Ct!==void 0&&(Fe=Math.min(Fe,Ct))}let qe=0;mt.forEach(De=>{De.isAtWar===!0&&qe++});let Pe=0;mt.forEach(De=>{!De.isPlayer&&De.foreignWars&&Object.values(De.foreignWars).forEach(Se=>{Se!=null&&Se.isAtWar&&Pe++})}),Pe=Math.floor(Pe/2);const Je=1+qe*.025+Pe*.01,pe=Fe*Je,rt=Xe[R]||pe,Ge=rt+(pe-rt)*.1,ke=(Ue=$.minPrice)!=null?Ue:Oi,pt=$.maxPrice;let ot=Ge;ot=Math.max(ot,ke),pt!==void 0&&(ot=Math.min(ot,pt)),wn[R]=parseFloat(ot.toFixed(2))})}const gf=n=>{const l=(k||{})[n];if(!l||l.length<2)return null;const b=l[l.length-1],w=l[l.length-2],C=Math.max(1,(i==null?void 0:i[n])||0);return(b-w)/C},yf=n=>{const l=zn[n];return!l||l.length===0?!1:l.some(b=>b&&b.availableSlots>0)},bf=(n,l)=>{const b=zn[n];if(!b||b.length===0||l<=0)return null;let w=-1,C=0;for(let $=0;$<b.length;$++){const G=b[$];if(!G)continue;const z=G.availableSlots>=1?Math.floor(G.availableSlots):G.availableSlots>0?1:0;z>C&&(C=z,w=$)}if(w===-1||C<=0)return null;const S=b[w],q=Math.min(l,C),R={buildingId:S.buildingId,buildingName:S.buildingName,count:q};return S.availableSlots-=q,S.availableSlots<=0&&b.splice(w,1),R},As=(n=[])=>Array.isArray(n)?n.reduce((l,b)=>l+Math.max(0,(b==null?void 0:b.capitalLocked)||0),0):0,Mf=Math.max(0,(Ks=P==null?void 0:P.lockedCapital)!=null?Ks:As((P==null?void 0:P.pendingTrades)||[])),vf=mo.merchant||0;tn("simulation","[SIMULATION DEBUG] Calling simulateMerchantTrade, policies:",{hasExportTariff:!!Yt.exportTariffMultipliers,hasImportTariff:!!Yt.importTariffMultipliers,merchantPop:(J==null?void 0:J.merchant)||0});const jo=X0({ledger:nt,res:ie,wealth:je,popStructure:J,supply:Do,demand:Mo,nations:mt,tick:g,taxPolicies:Yt,taxBreakdown:Gt,getLocalPrice:co,roleExpense:xt,roleWagePayout:ft,pendingTrades:P.pendingTrades||[],lastTradeTime:P.lastTradeTime||0,gameSpeed:s,classFinancialData:bt,logs:We,potentialResources:fn,merchantAssignments:P.merchantAssignments||P.assignments||null,merchantTradePreferences:P.merchantTradePreferences||null,shouldLogMerchantTrades:(tc=(ec=Le==null?void 0:Le.logVisibility)==null?void 0:ec.showMerchantTradeLogs)!=null?tc:!0,shouldLogOfficialEvents:(ic=(oc=Le==null?void 0:Le.logVisibility)==null?void 0:oc.showOfficialLogs)!=null?ic:!0,onTreasuryChange:Ee}),Rs=Math.max(0,(nc=jo.lockedCapital)!=null?nc:As(jo.pendingTrades));jo.lockedCapital=Rs;const wf=jo.capitalInvestedThisTick||0;"capitalInvestedThisTick"in jo&&delete jo.capitalInvestedThisTick;const Ss=jo.completedTrades||[];if(Ss.length>0){const n={export:{},import:{}},l={};let b=0;Ss.forEach(C=>{var $;const S=C.resource;n[C.type][S]||(n[C.type][S]={amount:0,profit:0}),n[C.type][S].amount+=C.amount,n[C.type][S].profit+=C.profit,b+=C.profit;const q=C.partnerId||"unknown";if(!l[q]){const G=mt.find(z=>(z==null?void 0:z.id)===q);l[q]={name:(G==null?void 0:G.name)||q,exports:[],imports:[]}}const R=(($=Oe[S])==null?void 0:$.name)||S;C.type==="export"?l[q].exports.push(`${R}x${C.amount.toFixed(1)}`):l[q].imports.push(`${R}x${C.amount.toFixed(1)}`)});const w=[];if(Object.values(l).forEach(C=>{const S=[];C.exports.length>0&&S.push(`出口${C.exports.join(",")}`),C.imports.length>0&&S.push(`进口${C.imports.join(",")}`),S.length>0&&w.push(`${C.name}(${S.join(", ")})`)}),w.length>0&&jo.shouldLogMerchantTrades){const C=b>=0?`盈利${b.toFixed(1)}`:`亏损${Math.abs(b).toFixed(1)}`;We.push(`📦 商人贸易完成: ${w.join("; ")}，${C}银币`)}if(B.tradeBonusMod&&b>0){const C=b*B.tradeBonusMod;je.merchant=(je.merchant||0)+C,bt!=null&&bt.merchant&&(bt.merchant.income.ownerRevenue=(bt.merchant.income.ownerRevenue||0)+C)}}"completedTrades"in jo&&delete jo.completedTrades;const Is={};zt.forEach(n=>{Is[n]=Math.max(0,(to[n]||0)-(J[n]||0))});const xf=n=>n==="merchant"?(mo.merchant||0)+Rs:mo[n]||0,Ef=n=>n==="merchant"?((f==null?void 0:f.merchant)||0)+Mf:(f==null?void 0:f[n])||0,la=L0.getOrCompute(g,"vacantRoleIncomeCache",()=>new Map),Cf=n=>{var z,oe,be;if(la.has(n))return la.get(n);const l=1.2;let b=0,w=0,C=0,S=0;Vt.forEach(he=>{var ge,Fe,qe,Pe,Je,pe,rt,Ge,ke,pt;const Me=lo[he.id]||0;if(Me<=0)return;const at=Nt(he,0),dt=at.jobs||{},ze=dt[n]||0;if(ze<=0)return;if(he.owner===n){let ot=0;at.output&&Object.entries(at.output).forEach(([$e,Ze])=>{if(!Ze||Ze<=0||!Oe[$e])return;const At=Xe[$e]||Io($e);ot+=Ze*At});let Ot=0;at.input&&Object.entries(at.input).forEach(([$e,Ze])=>{if(!Ze||Ze<=0)return;const At=Xe[$e]||Io($e);Ot+=Ze*At});let Ue=0;Object.entries(dt).forEach(([$e,Ze])=>{var Rt,fo,st;if($e===n||!Ze||Ze<=0)return;const At=(st=(fo=vo==null?void 0:vo[$e])!=null?fo:(Rt=c==null?void 0:c.wages)==null?void 0:Rt[$e])!=null?st:bo($e);Ue+=At*Ze});const Se=((Fe=(ge=ae[n])==null?void 0:ge.headTaxBase)!=null?Fe:.01)*ci(n)*li,Ce=(qe=he.businessTaxBase)!=null?qe:.1,Pt=(Je=(Pe=Yt==null?void 0:Yt.businessTaxRates)==null?void 0:Pe[he.id])!=null?Je:1,Ct=Ce*Pt,Lt=ot-Ot-Ue-Se-Ct,Be=ze>0?Lt/ze:0;b+=Be*ze*Me,w+=ze*Me}else{const ot=(Ge=(rt=vo==null?void 0:vo[n])!=null?rt:(pe=c==null?void 0:c.wages)==null?void 0:pe[n])!=null?Ge:bo(n),Ue=((pt=(ke=ae[n])==null?void 0:ke.headTaxBase)!=null?pt:.01)*ci(n)*li,De=ot-Ue;C+=De*ze*Me,S+=ze*Me}});const q=w+S;if(q<=0){const Me=((be=(oe=vo==null?void 0:vo[n])!=null?oe:(z=c==null?void 0:c.wages)==null?void 0:z[n])!=null?be:bo(n))*l;return la.set(n,Me),Me}const $=(b+C)/q,G=Math.max(0,$*l);return la.set(n,G),G},ua=zt.map(n=>{var Je,pe;const l=J[n]||0,b=xf(n),w=Ef(n),C=b-w,S=l>0?b/l:0,q=l>0?C/l:0,R=ft[n]||0,$=xt[n]||0,G=n==="merchant"?wf:0,oe=(R-$+G)/Math.max(1,l),be=vo[n]||bo(n),Me=((pe=(Je=ae[n])==null?void 0:Je.headTaxBase)!=null?pe:.01)*ci(n)*li,at=be-Me,dt=gf(n),ze=n==="merchant"?oe:q,tt=dt!==null?dt:ze,ge=oe!==0?oe:at;let Fe;l===0?Fe=Cf(n):n==="merchant"||tt!==0?Fe=n==="merchant"?ge:tt:Fe=ge;const qe=S>0?S*.002:0,Pe=Fe+qe;return{role:n,pop:l,perCap:S,perCapDelta:ze,potentialIncome:Pe,vacancy:Is[n]||0}}).filter(n=>n.role!=="official"),fa=ua.reduce((n,l)=>l.pop>0?n+l.pop:n,0);fa>0&&ua.reduce((n,l)=>n+l.potentialIncome*l.pop,0)/fa,fa>0&&ua.reduce((n,l)=>n+l.perCap*l.pop,0)/fa;const ks={};Object.keys(Oe).forEach(n=>{const l=Do[n]||0,b=Mo[n]||0;ks[n]=b>0?l/b:l>0?999:1});const ei={};Vt.forEach(n=>{if((lo[n.id]||0)<=0)return;const b=Nt(n,0),w=b.output||{},C=b.jobs||{},S=Object.keys(w).filter(q=>Oe[q]);S.length!==0&&(Object.keys(C).forEach(q=>{ei[q]||(ei[q]=[]),S.forEach(R=>{ei[q].includes(R)||ei[q].push(R)})}),n.owner&&!ei[n.owner]&&(ei[n.owner]=[]),n.owner&&S.forEach(q=>{ei[n.owner].includes(q)||ei[n.owner].push(q)}))});const Ja=el({popStructure:J,wealth:je,roleMetrics:ua,hasBuildingVacancyForRole:yf,reserveBuildingVacancyForRole:bf,logs:We,migrationCooldowns:ye,supplyDemandRatio:ks,roleProducesResource:ei});Object.assign(J,Ja.popStructure),Object.assign(je,Ja.wealth);const Ds=Ja.migrationCooldowns;Object.keys(ae).forEach(n=>{mo[n]=Math.max(0,je[n]||0)}),ui=Object.values(mo).reduce((n,l)=>n+l,0),Object.keys(ae).forEach(n=>{var l;if(n!=="official"&&Gi[n]){const b=J[n]||0,w=mo[n]||0,C=((l=ae[n])==null?void 0:l.startingWealth)||100,S=b>0?w/b:0;Gi[n].wealthPerCapita=S,Gi[n].wealthRatio=C>0?S/C:0}});const Ws=Math.max(0,je.merchant||0);if(Ws-vf!==0){const n=ae.merchant;if(n){const l=J.merchant||0,b=n.influenceBase*l+(ui>0?Ws/ui*10:0),w=b-(ho.merchant||0);ho.merchant=b,fi+=w}}const Bt={...me},_f=1.5,Tf=.02;Vt.forEach(n=>{var oe,be,he;const l=n.id,b=lo[l]||0;if(b<=0)return;const w=kn(l);if(w<=0)return;const C=n.owner;if(!C||C==="state")return;const S=J[C]||0;if(S<=0)return;const q=je[C]||0,R=q/S,$=Bt[l]||{};let G=0;for(const[,Me]of Object.entries($))typeof Me=="number"&&Me>0&&(G+=Me);const z=b-G;for(let Me=0;Me<w;Me++){if((Me===0?z:$[Me]||0)<=0)continue;const dt=Dn(l,Me+1,0);if(!dt)continue;let ze=0;for(const[Pe,Je]of Object.entries(dt))if(Pe==="silver")ze+=Je;else{const pe=Xe[Pe]||1;ze+=Je*pe}if(R<_f*ze||Math.random()>Tf||!Object.entries(dt).every(([Pe,Je])=>Pe==="silver"?!0:(ie[Pe]||0)>=Je)||q<ze)continue;Object.entries(dt).forEach(([Pe,Je])=>{Pe!=="silver"&&Dt(Pe,-Je,"building_construction_cost")}),nt.transfer(C,"void",ze,Z.EXPENSE.BUILDING_COST,Z.EXPENSE.BUILDING_COST),Bt[l]||(Bt[l]={}),Me>0&&(Bt[l][Me]=Math.max(0,(Bt[l][Me]||0)-1),Bt[l][Me]<=0&&delete Bt[l][Me]);const ge=Me+1;Bt[l][ge]=(Bt[l][ge]||0)+1,Object.keys(Bt[l]).length===0&&delete Bt[l];const Fe=((oe=ae[C])==null?void 0:oe.name)||C,qe=((he=(be=In[l])==null?void 0:be[Me])==null?void 0:he.name)||`等级${ge}`;We.push(`??? ${Fe}自发投资了自己的产业 ${n.name} → ${qe}（花费 ${Math.ceil(ze)} 银币）`);break}}),Ga.length>0&&Ga.forEach(n=>{const{buildingId:l,fromLevel:b,toLevel:w,officialName:C,cost:S}=n;Bt[l]||(Bt[l]={}),b>0&&(Bt[l][b]=Math.max(0,(Bt[l][b]||0)-1),Bt[l][b]<=0&&delete Bt[l][b]),Bt[l][w]=(Bt[l][w]||0)+1,Object.keys(Bt[l]).length===0&&delete Bt[l],We.push(`??? 官员${C}升级了 ${l}（花费 ${Math.ceil(S)} 银）`)}),Object.keys(ae).forEach(n=>{mo[n]=Math.max(0,je[n]||0)}),ui=Object.values(mo).reduce((n,l)=>n+l,0);const Bs=aa*(1+(B.taxEfficiencyBonus||0)-(B.corruption||0)),Ri=Math.max(0,Math.min(1,Bs)),da=Gt.headTax*Ri,pa=Gt.industryTax*Ri,ha=Gt.businessTax*Ri,ma=(Gt.tariff||0)*Ri,Za=Gt.headTax+Gt.industryTax+Gt.businessTax+(Gt.tariff||0),Pf=Math.max(0,Math.min(1,aa*(1+(B.taxEfficiencyBonus||0)))),ga=Za*(1-Ri);console.log("[TAX DEBUG] Efficiency Calc:",{efficiency:aa,bonuses:B.taxEfficiencyBonus,rawTaxEfficiency:Bs,effectiveTaxEfficiency:Ri,taxBase:Za,efficiencyLoss:ga,officialsCount:Ci.length}),ga>0&&(Ee(-ga,"tax_efficiency_loss"),console.log("[TAX DEBUG] Applied efficiency loss:",-ga));const Qa=Math.max(0,Za*(Pf-Ri));if(Qa>0&&Ci.length>0){const n=ue?1:.5,l=Ci.map(S=>{var $,G,z;const q=((($=S.effects)==null?void 0:$.corruption)||0)+(((G=S.drawbacks)==null?void 0:G.corruption)||0),R=((z=Aa[S.financialSatisfaction])==null?void 0:z.corruption)||0;return Math.max(0,(q+R)*n)}),b=l.reduce((S,q)=>S+q,0),w=Qa/Ci.length;let C=0;Ci.forEach((S,q)=>{const R=b>0?Qa*(l[q]/b):w;R<=0||(S.wealth=Math.max(0,(S.wealth||0)+R),C+=R)}),C>0&&(yn+=C,je.official=yn,mo.official=Math.max(0,je.official),ui=Object.values(mo).reduce((S,q)=>S+q,0),$i+=C,nt.transfer("void","official",C,Z.INCOME.CORRUPTION,Z.INCOME.CORRUPTION))}const Os=Gt.tariffSubsidy||0,Ka=da+pa+ha+ma,Af=Ka+di,No=Math.max(0,1+Xu),Rf=da*No,Sf=pa*No,If=ha*No,kf=ma*No;if(No>1){const n=da*(No-1),l=pa*(No-1),b=ha*(No-1),w=ma*(No-1);n>0&&Ee(n,"headTax"),l>0&&Ee(l,"transactionTax"),b>0&&Ee(b,"businessTax"),w>0&&Ee(w,"tariffs")}Te.silver=(Te.silver||0)+Rf+Sf+If+kf;const er=di*(No-1);if(er>0&&(Ee(er,"income_war_indemnity_bonus"),Te.silver=(Te.silver||0)+er),di>0&&(Te.silver=(Te.silver||0)+di),Mi>0&&(Ee(Mi,"income_policy"),Te.silver=(Te.silver||0)+Mi),Fi>0){const n=Math.min(ie.silver||0,Fi);n>0&&(Ee(-n,"expense_policy"),Te.silver=(Te.silver||0)-n)}Gt.policyIncome=Mi,Gt.policyExpense=Fi;const Df=(Ka+di)*No,xn=Gt.priceControlIncome||0,js=Gt.priceControlExpense||0,En=Number.isFinite(lt)?lt:0;xn!==0&&(Ee(xn,"income_price_control"),Te.silver=(Te.silver||0)+xn),En!==0&&(Ee(En,"income_trade_route"),Te.silver=(Te.silver||0)+En);const Wf={total:Ka-Gt.subsidy-Os+di+Mi-Fi+En+xn-js,efficiency:aa,breakdown:{headTax:da,industryTax:pa,businessTax:ha,tariff:ma,tariffSubsidy:Os,subsidy:Gt.subsidy,warIndemnity:di,policyIncome:Mi,policyExpense:Fi,priceControlIncome:xn,priceControlExpense:js,tradeRouteTax:En,baseFiscalIncome:Af,totalFiscalIncome:Df,incomePercentMultiplier:No,_debug_tariffPolicies:{hasExport:!!Yt.exportTariffMultipliers,hasImport:!!Yt.importTariffMultipliers,rawTariff:Gt.tariff||0}}};if(ft.official=$i||0,Co&&(Co.official=[]),Xn.size>0&&Xn.forEach((n,l)=>{We.push(n>1?`${l}（共${n}处）`:l)}),_t.length>0){const n=Iu({foreignInvestments:ro,nations:mt,organizations:(v==null?void 0:v.organizations)||[],playerMarket:{prices:wn},playerResources:ie,foreignInvestmentPolicy:fe,daysElapsed:g,jobFill:hn,buildings:lo});ro=n.updatedInvestments,Jo.push(...n.logs),n.taxRevenue>0&&Ee(n.taxRevenue,"foreign_investment_tax"),n.marketChanges&&Object.entries(n.marketChanges).forEach(([b,w])=>{b!=="silver"&&Dt(b,w,"autonomous_investment_return")});const l=ku({foreignInvestments:ro,nations:mt,playerMarket:{prices:wn},playerResources:ie,buildingUpgrades:Bt,buildingCounts:lo,daysElapsed:g});l.upgrades&&l.upgrades.length>0&&(ro=l.updatedInvestments,Jo.push(...l.logs),l.upgrades.forEach(b=>{const w=mt.find(C=>C.id===b.ownerNationId);w&&(w.wealth=Math.max(0,(w.wealth||0)-b.cost))}))}We.push(...Jo),Ye!=null&&Ye.tradeLog&&We.push(...Ye.tradeLog);const Bf=g%10===0?z0({nations:mt,res:ie,supply:Do,demand:Mo,market:{prices:wn},tick:g,taxPolicies:Yt,merchantTradePreferences:jo.merchantTradePreferences}):He,Of=Su(ro);return _i&&(mt=mt.map(n=>{const l=Wt.filter(b=>{var w;return(w=b.members)==null?void 0:w.includes(n.id)}).map(b=>b.id);return{...n,organizationMemberships:l}})),{tradeOpportunities:Bf,tradeRoutes:_e?{..._e,routes:_e.routes.filter(n=>{var l;return!((l=Ye==null?void 0:Ye.routesToRemove)!=null&&l.includes(n))})}:void 0,overseasInvestments:Kt,foreignInvestments:ro,resources:ie,rates:Te,popStructure:J,maxPop:Uo,militaryCapacity:ps,population:uo,birthAccumulator:vn,classApproval:Eo,approvalBreakdown:Et,classInfluence:ho,classWealth:mo,classLivingStandard:Gi,totalInfluence:fi,totalWealth:ui,activeBuffs:Ha,activeDebuffs:Ya,stability:Ps,legitimacy:pn,legitimacyTaxModifier:ja,logs:We,market:{prices:wn,demand:Mo,supply:Do,wages:vo,needsShortages:Co,stratumConsumption:Ko,supplyBreakdown:so,demandBreakdown:cn},classIncome:ft,classExpense:xt,jobFill:hn,jobsAvailable:to,taxes:Wf,classFinancialData:bt,buildingFinancialData:eo,buildingDebugData:ss,dailyMilitaryExpense:Qn,needsShortages:Co,needsReport:Ei,livingStandardStreaks:_s,nations:mt,merchantState:jo,buildingUpgrades:Bt,migrationCooldowns:Ds,migrationCooldowns:Ds,diplomacyOrganizations:_i?{organizations:Wt}:null,taxShock:Ts,modifiers:{resourceDemand:{...ln,...Object.fromEntries(Object.entries(W).map(([n,l])=>[n,(ln[n]||0)+l]))},stratumDemand:{...un,...Object.fromEntries(Object.entries(j).map(([n,l])=>[n,(un[n]||0)+l]))},resourceSupply:Ia,buildingProduction:{...qn,...H},categoryProduction:Vn,sources:{decreeResourceDemand:ln,decreeStratumDemand:un,decreeResourceSupply:Ia,eventResourceDemand:W,eventStratumDemand:j,eventBuildingProduction:H,techBuildingBonus:qn,techCategoryBonus:Vn,productionBonus:Da,industryBonus:Wa,militaryBonus:B.militaryBonus,stratumWealthMultiplier:Kn,productionInputCost:(()=>{const n={},l=B.officialProductionInputCost||{},b=B.stanceProductionInputCost||{};return new Set([...Object.keys(l),...Object.keys(b)]).forEach(C=>{n[C]=(l[C]||0)+(b[C]||0)}),n})()},officialEffects:{buildingCostMod:B.buildingCostMod||0,militaryUpkeepMod:B.militaryUpkeepMod||0,taxEfficiencyBonus:B.taxEfficiencyBonus||0,corruption:B.corruption||0,populationGrowthBonus:B.populationGrowthBonus||0,tradeBonusMod:B.tradeBonusMod||0,organizationGrowthMod:B.organizationGrowthMod||0,wartimeProduction:B.wartimeProduction||0,resourceWaste:B.resourceWaste||{},coalitionApproval:B.coalitionApproval||0,legitimacyBonus:B.legitimacyBonus||0,factionConflict:B.factionConflict||0,diplomaticCooldown:B.diplomaticCooldown||0,diplomaticIncident:B.diplomaticIncident||0}},foreignInvestmentStats:Of,army:y,officials:Ci,effectiveOfficialCapacity:_l(u,Hn||{},_),buildings:lo,_debug:{freeMarket:uf,silverChangeLog:(()=>{const n=Tt.toArray(),l=n.some(b=>b.reason==="expense_army_maintenance");return console.log("[Simulation End] silverChangeLog has military?",l,"Entries:",n.length),n})(),classWealthChangeLog:kt,startingSilver:yt,endingSilver:ie.silver||0,militaryDebugInfo:mn}}};self.onmessage=function(e){const{type:t,payload:o}=e.data;if(t==="SIMULATE")try{const i=Nu(o);self.postMessage({type:"RESULT",payload:i})}catch(i){self.postMessage({type:"ERROR",error:i.message||"Unknown simulation error"})}else t==="PING"&&self.postMessage({type:"PONG"})},self.postMessage({type:"READY"})})();
