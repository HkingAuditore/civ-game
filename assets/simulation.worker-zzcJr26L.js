(function(){"use strict";const Ut={price:{livingCostWeight:.15,taxCostWeight:.1},wage:{livingCostWeight:.1,taxCostWeight:.1},market:{virtualDemandPerPop:.01,supplyDemandWeight:1,inventoryTargetDays:365,inventoryPriceImpact:.25,demandElasticity:.5,outputVariation:.2}},Be={food:{name:"粮食",icon:"Wheat",color:"text-yellow-400",basePrice:1,minPrice:.1,maxPrice:10,defaultOwner:"peasant",unlockEpoch:0,tags:["essential","raw_material"],marketConfig:{supplyDemandWeight:.4,inventoryTargetDays:730,inventoryPriceImpact:.15,demandElasticity:.2,outputVariation:.2}},wood:{name:"木材",icon:"Trees",color:"text-emerald-400",basePrice:2,minPrice:.02,maxPrice:20,defaultOwner:"lumberjack",unlockEpoch:0,tags:["raw_material"],marketConfig:{supplyDemandWeight:.7,inventoryTargetDays:550,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},stone:{name:"石料",icon:"Pickaxe",color:"text-stone-400",basePrice:3,minPrice:.03,maxPrice:30,defaultOwner:"miner",unlockEpoch:0,tags:["raw_material"],marketConfig:{supplyDemandWeight:.7,inventoryTargetDays:550,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},cloth:{name:"布料",icon:"Shirt",color:"text-indigo-300",basePrice:1.5,minPrice:.015,maxPrice:15,defaultOwner:"worker",unlockEpoch:0,tags:["essential","raw_material","manufactured"],marketConfig:{supplyDemandWeight:.8,inventoryTargetDays:600,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},brick:{name:"砖块",icon:"Home",color:"text-red-400",basePrice:6,minPrice:.06,maxPrice:60,defaultOwner:"artisan",unlockEpoch:0,unlockTech:"pottery",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:270,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},tools:{name:"工具",icon:"Anvil",color:"text-blue-300",basePrice:16,minPrice:.16,maxPrice:160,defaultOwner:"artisan",unlockEpoch:0,unlockTech:"tool_making",tags:["industrial"],marketConfig:{supplyDemandWeight:1.2,inventoryTargetDays:300,inventoryPriceImpact:.35,demandElasticity:.6,outputVariation:.2}},plank:{name:"木板",icon:"TreeDeciduous",color:"text-amber-600",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"worker",unlockEpoch:1,unlockTech:"tools",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:240,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},copper:{name:"铜矿",icon:"Pickaxe",color:"text-orange-400",basePrice:5.5,minPrice:.055,maxPrice:55,defaultOwner:"miner",unlockEpoch:1,unlockTech:"copper_mining",tags:["raw_material"],marketConfig:{supplyDemandWeight:.9,inventoryTargetDays:300,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},dye:{name:"染料",icon:"Droplets",color:"text-pink-500",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"artisan",unlockEpoch:1,tags:["industrial","raw_material"],marketConfig:{supplyDemandWeight:1.1,inventoryTargetDays:200,inventoryPriceImpact:.35,demandElasticity:.6,outputVariation:.2}},papyrus:{name:"纸张",icon:"ScrollText",color:"text-lime-300",basePrice:6.5,minPrice:.065,maxPrice:65,defaultOwner:"scribe",unlockEpoch:2,unlockTech:"papyrus_cultivation",tags:["raw_material","manufactured"],marketConfig:{supplyDemandWeight:1.1,inventoryTargetDays:240,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},delicacies:{name:"珍馐",icon:"UtensilsCrossed",color:"text-rose-400",basePrice:24,minPrice:.24,maxPrice:240,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"culinary_arts",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.5,inventoryTargetDays:90,inventoryPriceImpact:.45,demandElasticity:1.3,outputVariation:.2}},furniture:{name:"家具",icon:"Armchair",color:"text-amber-500",basePrice:28,minPrice:.28,maxPrice:280,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"carpentry",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.5,inventoryTargetDays:120,inventoryPriceImpact:.4,demandElasticity:1.2,outputVariation:.2}},ale:{name:"美酒",icon:"Wine",color:"text-purple-400",basePrice:18,minPrice:.18,maxPrice:180,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"brewing",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.6,inventoryTargetDays:150,inventoryPriceImpact:.5,demandElasticity:1.5,outputVariation:.2}},fine_clothes:{name:"华服",icon:"Shirt",color:"text-purple-400",basePrice:32,minPrice:.32,maxPrice:320,defaultOwner:"artisan",unlockEpoch:2,tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.6,inventoryTargetDays:100,inventoryPriceImpact:.5,demandElasticity:1.5,outputVariation:.2}},iron:{name:"铁矿",icon:"Pickaxe",color:"text-zinc-400",basePrice:8,minPrice:.08,maxPrice:80,defaultOwner:"miner",unlockEpoch:2,unlockTech:"ironworking",tags:["raw_material"],marketConfig:{supplyDemandWeight:.8,inventoryTargetDays:500,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},spice:{name:"香料",icon:"Leaf",color:"text-amber-400",basePrice:26,minPrice:.26,maxPrice:260,defaultOwner:"merchant",unlockEpoch:4,unlockTech:"cartography",tags:["essential","manufactured"],marketConfig:{supplyDemandWeight:1.4,inventoryTargetDays:180,inventoryPriceImpact:.4,demandElasticity:.9,outputVariation:.2}},coffee:{name:"咖啡",icon:"Coffee",color:"text-amber-700",basePrice:24,minPrice:.24,maxPrice:240,defaultOwner:"merchant",unlockEpoch:5,unlockTech:"coffee_agronomy",tags:["essential","manufactured"],marketConfig:{supplyDemandWeight:1.2,inventoryTargetDays:240,inventoryPriceImpact:.35,demandElasticity:.8,outputVariation:.2}},coal:{name:"煤炭",icon:"Flame",color:"text-slate-300",basePrice:7.5,minPrice:.075,maxPrice:75,defaultOwner:"miner",unlockEpoch:6,unlockTech:"coal_gasification",tags:["raw_material"],marketConfig:{supplyDemandWeight:.9,inventoryTargetDays:365,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},steel:{name:"钢材",icon:"Cog",color:"text-gray-300",basePrice:40,minPrice:.4,maxPrice:400,defaultOwner:"engineer",unlockEpoch:6,unlockTech:"steel_alloys",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:300,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},silver:{name:"银币",icon:"Coins",color:"text-slate-200",type:"currency",basePrice:1,minPrice:1,maxPrice:1,unlockEpoch:0,tags:["currency"]},science:{name:"科研",icon:"Cpu",color:"text-cyan-400",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"official",unlockEpoch:0,tags:["special","manufactured"],marketConfig:{supplyDemandWeight:.5,inventoryTargetDays:730,inventoryPriceImpact:.15,demandElasticity:.2,outputVariation:.1}},culture:{name:"文化",icon:"ScrollText",color:"text-pink-400",basePrice:2,minPrice:.025,maxPrice:10,defaultOwner:"cleric",unlockEpoch:1,unlockTech:"amphitheater_design",tags:["special","manufactured"],marketConfig:{supplyDemandWeight:.6,inventoryTargetDays:600,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.15}},maxPop:{name:"人口上限",icon:"Users",color:"text-blue-400",type:"virtual",tags:["special"]},militaryCapacity:{name:"军事容量",icon:"Shield",color:"text-red-400",type:"virtual",tags:["special"]}},va={MAX_HEAD_TAX:1e4},gi=[{id:0,name:"石器时代",color:"text-stone-400",bg:"bg-stone-900",tileColor:"bg-stone-700",req:{science:0},cost:{},bonuses:{desc:"文明的起源，一切从这里开始。",gatherBonus:.2}},{id:1,name:"青铜时代",color:"text-orange-400",bg:"bg-orange-950",tileColor:"bg-orange-800",req:{science:600,population:25},cost:{food:6e3,wood:3500,stone:1200,silver:600,science:600},bonuses:{desc:"掌握青铜冶炼与畜力生产，资源获取加速。",gatherBonus:.4,militaryBonus:.2,industryBonus:.2}},{id:2,name:"古典时代",color:"text-amber-300",bg:"bg-amber-900",tileColor:"bg-amber-700",req:{science:1800,population:90,culture:250},cost:{food:2e4,wood:1e4,brick:3600,silver:5e3,tools:1200,science:1800},bonuses:{desc:"哲学与艺术的萌芽，文明全方位提升。",gatherBonus:.6,militaryBonus:.3,cultureBonus:.2,scienceBonus:.2,industryBonus:.3,maxPop:.1}},{id:3,name:"封建时代",color:"text-blue-400",bg:"bg-blue-950",tileColor:"bg-blue-800",req:{science:4500,population:170,culture:600},cost:{food:1e5,wood:5e4,brick:25e3,iron:12500,papyrus:5e3,silver:15e3,science:4500},bonuses:{desc:"封建制度确立，人口与经济快速增长。",gatherBonus:.8,militaryBonus:.4,cultureBonus:.3,scienceBonus:.3,industryBonus:.4,taxIncome:.2}},{id:4,name:"探索时代",color:"text-cyan-300",bg:"bg-cyan-900",tileColor:"bg-cyan-700",req:{science:8e3,population:320,culture:1400},cost:{food:26e4,plank:7e4,brick:6e4,iron:35e3,silver:4e4,science:8e3},bonuses:{desc:"大航海开启，贸易与工业蓬勃发展。",gatherBonus:1.2,militaryBonus:.45,cultureBonus:.4,scienceBonus:.5,industryBonus:.6,incomePercent:.5}},{id:5,name:"启蒙时代",color:"text-purple-400",bg:"bg-purple-950",tileColor:"bg-purple-800",req:{science:12e3,population:450,culture:2500},cost:{food:35e4,plank:8e4,papyrus:3e4,spice:2e4,silver:5e4,science:12e3},bonuses:{desc:"理性的光辉照耀，科学与文化大幅提升。",gatherBonus:1.5,militaryBonus:.5,cultureBonus:.6,scienceBonus:.8,industryBonus:1,stability:10}},{id:6,name:"工业时代",color:"text-gray-200",bg:"bg-gray-800",tileColor:"bg-gray-600",req:{science:2e4,population:650,culture:4e3},cost:{food:75e4,brick:18e4,iron:12e4,tools:75e3,spice:3e4,silver:12e4,science:2e4},bonuses:{desc:"机械化大生产，工业产能爆炸式增长。",gatherBonus:2,militaryBonus:.6,cultureBonus:.8,scienceBonus:1.2,industryBonus:2,maxPop:.2}},{id:7,name:"信息时代",color:"text-green-400",bg:"bg-green-950",tileColor:"bg-green-800",req:{science:35e3,population:1e3,culture:8e3},cost:{food:2e6,tools:3e5,silver:25e4,spice:8e4,papyrus:1e5,science:35e3},bonuses:{desc:"数字革命改变世界，知识和信息成为核心生产力。",gatherBonus:3,militaryBonus:.8,cultureBonus:1.5,scienceBonus:3,industryBonus:3,incomePercent:1}}],ae={peasant:{name:"自耕农",icon:"Wheat",weight:1,tax:1,headTaxBase:.01,desc:"社会的基础，提供稳定的粮食和兵源。",wealthWeight:1,influenceBase:.5,startingWealth:80,defaultResource:"food",wealthElasticity:.5,maxConsumptionMultiplier:3,needs:{food:.42,cloth:.06},luxuryNeeds:{1:{ale:.05},1.5:{wood:.03,culture:.02},2:{plank:.045,stone:.015},2.5:{furniture:.03,tools:.03},3:{spice:.06,brick:.03,culture:.04},4.5:{copper:.006,plank:.02},5.5:{delicacies:.04,fine_clothes:.02,culture:.05},7:{coffee:.04,spice:.03},8:{delicacies:.05,culture:.06,furniture:.02}},buffs:{satisfied:{desc:"民心稳定",taxIncome:.1,production:.05},dissatisfied:{desc:"民怨沸腾",taxIncome:-.2,production:-.1}}},lumberjack:{name:"樵夫",icon:"Trees",weight:.8,tax:1.2,headTaxBase:.02,desc:"专职砍伐木材，维系城市建设。",wealthWeight:1,influenceBase:.4,startingWealth:90,defaultResource:"wood",wealthElasticity:.6,maxConsumptionMultiplier:3,needs:{food:.46,cloth:.07},luxuryNeeds:{1:{ale:.05},1.5:{stone:.015,culture:.02},2:{plank:.06,wood:.06},2.5:{tools:.03,furniture:.03},3:{spice:.045,brick:.035,culture:.045},4.5:{copper:.01,tools:.04,plank:.02},5.5:{delicacies:.04,fine_clothes:.02,culture:.05},7:{coffee:.05,spice:.03},8:{delicacies:.05,culture:.06,furniture:.02}},buffs:{satisfied:{desc:"林场顺畅",production:.06},dissatisfied:{desc:"供应迟滞",production:-.1}}},serf:{name:"佃农",icon:"Users",weight:.5,tax:2,headTaxBase:.015,desc:"依附于地主的农民，产出归地主所有。",wealthWeight:.5,influenceBase:.3,startingWealth:50,defaultResource:"food",wealthElasticity:.4,maxConsumptionMultiplier:3,needs:{food:.36,cloth:.05},luxuryNeeds:{1:{ale:.035},2:{culture:.015},2.5:{food:.08},3:{furniture:.015,plank:.03,tools:.01},4:{spice:.03,stone:.01,culture:.025},5:{ale:.03,cloth:.015},6:{delicacies:.02,brick:.02,culture:.03},7.5:{fine_clothes:.015,copper:.006},9:{coffee:.02,furniture:.01},10:{delicacies:.02,culture:.035}},buffs:{satisfied:{desc:"佃农勤恳",production:.08},dissatisfied:{desc:"佃农怠工",production:-.15}}},worker:{name:"工人",icon:"Hammer",weight:2,tax:3,headTaxBase:.03,desc:"工业时代的基石，推动生产力发展。",wealthWeight:2,influenceBase:1,startingWealth:80,defaultResource:"plank",wealthElasticity:.7,maxConsumptionMultiplier:3,needs:{food:.52,cloth:.09},luxuryNeeds:{1:{tools:.06,ale:.09},1.5:{plank:.03,culture:.03},2.5:{furniture:.045,spice:.03},3:{coffee:.04,brick:.04,culture:.04},4:{fine_clothes:.05,delicacies:.07,stone:.02},5:{steel:.02,copper:.015,culture:.08},6.5:{delicacies:.06,fine_clothes:.04,brick:.03,culture:.07},8:{papyrus:.035,furniture:.02},10:{coffee:.04,spice:.04,furniture:.04,culture:.07},12:{delicacies:.08,fine_clothes:.05,culture:.1}},buffs:{satisfied:{desc:"工人积极",industryBonus:.15},dissatisfied:{desc:"工人罢工",industryBonus:-.25}}},artisan:{name:"工匠",icon:"Anvil",weight:1.5,tax:3.5,headTaxBase:.035,desc:"技艺精湛的手工业者，负责加工铜器与印刷制品。",wealthWeight:2.5,influenceBase:1.2,startingWealth:200,defaultResource:"tools",wealthElasticity:.8,maxConsumptionMultiplier:6,needs:{food:.62,cloth:.11},luxuryNeeds:{1:{tools:.07,ale:.1,furniture:.05,culture:.04},1.8:{copper:.02,spice:.05},2.5:{coffee:.04,fine_clothes:.035,brick:.04,culture:.09},3.5:{delicacies:.09,stone:.035,dye:.025},4.5:{steel:.015,iron:.02,culture:.12},6:{tools:.06,copper:.03,furniture:.04,culture:.1},8:{papyrus:.05,furniture:.03},10:{coffee:.05,fine_clothes:.05,dye:.03,culture:.13},12:{delicacies:.1,culture:.18,spice:.04}},buffs:{satisfied:{desc:"坊市繁盛",production:.1},dissatisfied:{desc:"工坊停工",production:-.15}}},miner:{name:"矿工",icon:"Pickaxe",weight:1.2,tax:2.5,headTaxBase:.025,desc:"深入地下采集矿石，承担艰苦劳动。",wealthWeight:1.5,influenceBase:.8,startingWealth:120,defaultResource:"stone",wealthElasticity:.6,maxConsumptionMultiplier:4,needs:{food:.56,cloth:.1},luxuryNeeds:{1:{ale:.06},1.8:{wood:.04,tools:.015},2:{culture:.02},2.5:{furniture:.03,spice:.02,food:.2},3:{plank:.04,brick:.03,coffee:.025},4:{delicacies:.05,culture:.04},5.5:{copper:.015,steel:.01},7:{fine_clothes:.035,culture:.07},9:{ale:.06,delicacies:.05,culture:.06},11:{coffee:.04,fine_clothes:.035,culture:.08}},buffs:{satisfied:{desc:"矿脉稳定",gatherBonus:.1},dissatisfied:{desc:"矿难隐患",stability:-.1}}},merchant:{name:"商人",icon:"Coins",weight:6,tax:5,headTaxBase:.09,desc:"控制贸易网络的阶层，主宽港口与市场。",wealthWeight:8,influenceBase:3.5,startingWealth:500,defaultResource:"spice",wealthElasticity:1.5,maxConsumptionMultiplier:10,needs:{food:.7,cloth:.14},luxuryNeeds:{1:{delicacies:.6,spice:.2,furniture:.12,plank:.08,ale:.15,fine_clothes:.1,culture:.12,dye:.02},1.5:{coffee:.14},2:{delicacies:.35,plank:.12,brick:.05,culture:.2},3:{steel:.05,coal:.03},5:{papyrus:.08,copper:.06,stone:.05,culture:.3},8:{coffee:.1,spice:.18,fine_clothes:.1,culture:.2},12:{delicacies:.35,furniture:.1,culture:.35,dye:.03},18:{delicacies:.45,fine_clothes:.14,culture:.45,papyrus:.08}},buffs:{satisfied:{desc:"商贸兴隆",taxIncome:.15,gatherBonus:.05},dissatisfied:{desc:"贸易停滞",taxIncome:-.2,stability:-.1}},tradeConfig:{minProfitMargin:.1,maxPurchaseAmount:10,exportProbability:.5,maxInventoryRatio:.1,minWealthForTrade:10,tradeDuration:3,tradeCooldown:0,enableDebugLog:!0}},navigator:{name:"水手",icon:"Compass",weight:4,tax:3,headTaxBase:.06,desc:"探索时代的海员与测绘师，推动航海扩张。",wealthWeight:3,influenceBase:2.5,startingWealth:300,defaultResource:"spice",wealthElasticity:.7,maxConsumptionMultiplier:6,needs:{food:.6,cloth:.1},luxuryNeeds:{1:{spice:.12,ale:.12,culture:.05},1.8:{tools:.05},2.5:{coffee:.07,furniture:.07,culture:.09},3.5:{fine_clothes:.08,delicacies:.12,plank:.07},5:{copper:.05,steel:.03,culture:.15},7:{papyrus:.05},10:{brick:.08},14:{spice:.1,coffee:.06,fine_clothes:.06,culture:.2}},buffs:{satisfied:{desc:"海权扩张",gatherBonus:.1},dissatisfied:{desc:"航员哗变",gatherBonus:-.1,stability:-.1}}},scribe:{name:"学者",icon:"Feather",weight:2.5,tax:2,headTaxBase:.04,desc:"记录知识的学者，为图书馆与学院服务。",wealthWeight:2.5,influenceBase:1.5,startingWealth:250,defaultResource:"papyrus",wealthElasticity:1,maxConsumptionMultiplier:6,needs:{food:.62,cloth:.11},luxuryNeeds:{1:{papyrus:.1,furniture:.05,culture:.08},1.5:{coffee:.07},2:{fine_clothes:.05,plank:.025,culture:.15,science:.01},3:{delicacies:.09,spice:.05},5:{copper:.035,brick:.025,culture:.2,science:.03},7:{papyrus:.08,coffee:.05,culture:.12},10:{stone:.04},14:{cloth:.07},18:{steel:.015}},buffs:{satisfied:{desc:"文献井然",scienceBonus:.15},dissatisfied:{desc:"文献损失",scienceBonus:-.2}}},soldier:{name:"军人",icon:"Swords",weight:3,tax:1,headTaxBase:.04,desc:"维护国家安全，但也可能造成动荡。",wealthWeight:2,influenceBase:2,startingWealth:180,defaultResource:"tools",wealthElasticity:.6,maxConsumptionMultiplier:6,needs:{food:.6,cloth:.1},luxuryNeeds:{1:{ale:.08},1.5:{culture:.04},2:{tools:.07,copper:.025,iron:.02},2.5:{furniture:.05,spice:.05},3:{culture:.07},3.5:{fine_clothes:.07,delicacies:.07,steel:.025},5:{brick:.05,culture:.12},7:{coffee:.09,stone:.05},10:{steel:.03,tools:.04,culture:.1,delicacies:.06},14:{copper:.04,brick:.04,culture:.14}},buffs:{satisfied:{desc:"军心稳固",militaryPower:.2},dissatisfied:{desc:"军队哗变风险",militaryPower:-.3,stability:-.2}}},cleric:{name:"神职人员",icon:"Cross",weight:4,tax:.5,headTaxBase:.05,desc:"提供信仰和文化，安抚民心。",wealthWeight:3,influenceBase:3,startingWealth:220,defaultResource:"culture",wealthElasticity:.9,maxConsumptionMultiplier:6,needs:{food:.65,cloth:.11},luxuryNeeds:{1:{papyrus:.08,ale:.06,culture:.1},1.5:{plank:.02},2:{fine_clothes:.06,furniture:.06,stone:.04,culture:.18},3:{delicacies:.08,spice:.04},4.5:{copper:.04,brick:.04,culture:.25},6:{coffee:.05,steel:.01},8:{papyrus:.09},10:{culture:.15,fine_clothes:.05,delicacies:.06}},buffs:{satisfied:{desc:"宗教和谐",cultureBonus:.2,stability:.1},dissatisfied:{desc:"信仰危机",cultureBonus:-.15,stability:-.1}}},official:{name:"官员",icon:"ScrollText",weight:5,tax:2,headTaxBase:.08,desc:"政府管理者。",wealthWeight:5,influenceBase:4,startingWealth:400,defaultResource:"science",wealthElasticity:2.5,maxConsumptionMultiplier:50,greedy:!0,needs:{food:.85,cloth:.14},luxuryNeeds:{1:{delicacies:.5,papyrus:.12,coffee:.08,furniture:.1,stone:.04,fine_clothes:.1,culture:.15},1.3:{coffee:.06,culture:.08},1.8:{delicacies:.3,spice:.12,plank:.08,brick:.06},2:{culture:.25},2.5:{steel:.04,iron:.03,coal:.03},4:{papyrus:.08,copper:.04,stone:.04,culture:.35,science:.02},6:{fine_clothes:.15},9:{delicacies:.35,coffee:.1,culture:.4,science:.04},14:{delicacies:.45,fine_clothes:.12,papyrus:.08,culture:.55},20:{delicacies:.6,spice:.18,furniture:.1,culture:.7}},buffs:{satisfied:{desc:"吏治清明",taxIncome:.1},dissatisfied:{desc:"官员腐败",taxIncome:-.2}}},landowner:{name:"地主",icon:"Castle",weight:10,tax:5,headTaxBase:.07,desc:"传统精英，掌控土地和农业。",wealthWeight:10,influenceBase:5,startingWealth:800,defaultResource:"food",wealthElasticity:1.4,maxConsumptionMultiplier:10,needs:{food:.95,cloth:.15},luxuryNeeds:{1:{delicacies:.8,spice:.2,furniture:.18,brick:.1,plank:.1,fine_clothes:.15,culture:.2},1.3:{delicacies:.4,fine_clothes:.12},1.5:{culture:.28},1.8:{spice:.2,coffee:.1,stone:.08},2.5:{plank:.12,steel:.04,brick:.08,culture:.35},4:{copper:.06,papyrus:.04},6:{delicacies:.5,fine_clothes:.12,culture:.35},9:{delicacies:.65,coffee:.14,furniture:.12,culture:.45},14:{delicacies:.85,spice:.22,fine_clothes:.18,culture:.6},20:{delicacies:1.1,fine_clothes:.22,furniture:.16,culture:.8}},buffs:{satisfied:{desc:"贵族支持",taxIncome:.15,stability:.15},dissatisfied:{desc:"贵族叛乱",taxIncome:-.3,stability:-.25}}},capitalist:{name:"资本家",icon:"Briefcase",weight:15,tax:8,headTaxBase:.08,desc:"工业精英，提供投资和工业加成。",wealthWeight:20,influenceBase:6,startingWealth:1200,defaultResource:"steel",wealthElasticity:1.8,maxConsumptionMultiplier:10,needs:{food:1,cloth:.16},luxuryNeeds:{1:{delicacies:.7,coffee:.15,furniture:.15,steel:.05,culture:.25},1.3:{fine_clothes:.12},1.5:{culture:.3},1.8:{delicacies:.3,spice:.15,brick:.08},2.5:{stone:.06,plank:.1,coal:.04,iron:.03,culture:.45},4:{copper:.08,papyrus:.06,science:.03},6:{steel:.1,coal:.06,tools:.06,culture:.4},10:{delicacies:.55,coffee:.18,fine_clothes:.16,culture:.6,science:.06},15:{steel:.14,coal:.1,copper:.1,culture:.75},22:{delicacies:.85,spice:.25,furniture:.18,culture:1}},buffs:{satisfied:{desc:"资本繁荣",industryBonus:.25,scienceBonus:.15},dissatisfied:{desc:"资本外逃",industryBonus:-.3,taxIncome:-.25}}},knight:{name:"骑士",icon:"Shield",weight:8,tax:2,headTaxBase:.09,desc:"军事贵族，强大的战斗力。",wealthWeight:8,influenceBase:4,startingWealth:600,defaultResource:"tools",wealthElasticity:1,maxConsumptionMultiplier:10,needs:{food:.9,cloth:.14},luxuryNeeds:{1:{delicacies:.9,coffee:.1,furniture:.15,ale:.15,culture:.15},1.3:{delicacies:.4,fine_clothes:.1},1.5:{culture:.2},1.8:{spice:.12,steel:.04},2.5:{coffee:.08,brick:.06,stone:.04,culture:.3},4:{tools:.06,copper:.04,plank:.06},6:{steel:.06,tools:.04,culture:.25,delicacies:.25},10:{delicacies:.55,fine_clothes:.14,culture:.45},15:{steel:.1,copper:.06,culture:.6},22:{delicacies:.85,spice:.22,fine_clothes:.18,culture:.8}},buffs:{satisfied:{desc:"骑士忠诚",militaryPower:.25,stability:.1},dissatisfied:{desc:"骑士不满",militaryPower:-.2,stability:-.15}}},engineer:{name:"工程师",icon:"Cog",weight:7,tax:6,headTaxBase:.1,desc:"掌控蒸汽与机器的技术阶层。",wealthWeight:6,influenceBase:3.5,startingWealth:700,defaultResource:"steel",wealthElasticity:1.1,maxConsumptionMultiplier:10,needs:{food:.75,cloth:.12},luxuryNeeds:{1:{coffee:.12,ale:.08,furniture:.1,culture:.12},1.3:{fine_clothes:.08},1.8:{delicacies:.15,spice:.08,tools:.06},2:{culture:.2,science:.02},2.5:{plank:.08,copper:.04,stone:.04},4:{papyrus:.06,brick:.06,steel:.04,coal:.05,iron:.03,culture:.25},6:{steel:.08,tools:.08,coal:.08,culture:.25,science:.05},10:{coffee:.12,fine_clothes:.1,culture:.45,delicacies:.25},15:{steel:.12,copper:.08,coal:.12,culture:.6},22:{delicacies:.6,spice:.2,furniture:.14,culture:.75}},buffs:{satisfied:{desc:"工艺革新",industryBonus:.2,scienceBonus:.1},dissatisfied:{desc:"技术流失",industryBonus:-.25}}},unemployed:{name:"失业者",icon:"AlertTriangle",weight:.2,tax:1,headTaxBase:.01,desc:"暂时没有工作的平民，如果得不到安排会渐渐不满。",wealthWeight:.2,influenceBase:.3,startingWealth:30,wealthElasticity:.3,maxConsumptionMultiplier:3,needs:{food:.3,cloth:.04},luxuryNeeds:{2.5:{ale:.04,food:.1},3.5:{furniture:.01},4.5:{plank:.01,culture:.002},5.5:{tools:.004},7:{spice:.008},9:{brick:.006}},buffs:{satisfied:{desc:"等待机会",stability:.02},dissatisfied:{desc:"失业动荡",stability:-.1}}}},Yt=[{id:"farm",name:"农田",desc:"提供自耕农岗位。",baseCost:{wood:12},output:{food:4.8},jobs:{peasant:3},owner:"peasant",epoch:0,cat:"gather",visual:{icon:"Wheat",color:"bg-yellow-700",text:"text-yellow-200"},marketConfig:{price:{livingCostWeight:.08,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.05}}},{id:"trading_post",name:"贸易站",desc:"原始的物资交换场所，提供商人岗位。",baseCost:{wood:50,stone:10},output:{food:4,silver:1.6},jobs:{merchant:2},owner:"merchant",epoch:0,cat:"civic",requiresTech:"barter",visual:{icon:"Handshake",color:"bg-amber-800",text:"text-amber-200"}},{id:"large_estate",name:"庄园",desc:"地主控制的土地，雇佣佃农。",baseCost:{wood:100,plank:25},output:{food:24},jobs:{serf:8,landowner:1},owner:"landowner",epoch:3,cat:"gather",requiresTech:"feudalism",visual:{icon:"Castle",color:"bg-amber-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05,wageMode:"subsistence",subsistenceMultiplier:1.5}}},{id:"lumber_camp",name:"伐木场",desc:"砍伐木材，基础采集建筑。",baseCost:{food:18},input:{},output:{wood:3.84},jobs:{lumberjack:3},owner:"lumberjack",epoch:0,cat:"gather",visual:{icon:"Trees",color:"bg-emerald-800",text:"text-emerald-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"quarry",name:"采石场",desc:"开采石料，基础采集建筑。",baseCost:{wood:55},input:{},output:{stone:3},jobs:{miner:3},owner:"miner",epoch:0,cat:"gather",visual:{icon:"Pickaxe",color:"bg-stone-600",text:"text-stone-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"copper_mine",name:"铜矿井",desc:"开采铜矿石，需要少量工具维护。",baseCost:{food:120,wood:120},input:{tools:.0267},output:{copper:.6667},jobs:{miner:4},owner:"miner",epoch:1,cat:"gather",requiresTech:"copper_mining",visual:{icon:"Gem",color:"bg-orange-700",text:"text-orange-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"reed_works",name:"造纸工坊",desc:"生产纸张的手工作坊。",baseCost:{food:140,wood:80},input:{wood:.75},output:{papyrus:.9},jobs:{worker:3},owner:"worker",epoch:2,cat:"industry",requiresTech:"papyrus_cultivation",visual:{icon:"ScrollText",color:"bg-lime-800",text:"text-lime-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"culinary_kitchen",name:"烹饪坊",desc:"将粮食烹饪为珍馐，供上层阶级享用。",baseCost:{wood:100,stone:60,brick:30},input:{tools:.1333,food:2},output:{delicacies:2},jobs:{artisan:3,peasant:1},owner:"artisan",epoch:2,cat:"industry",requiresTech:"culinary_arts",visual:{icon:"UtensilsCrossed",color:"bg-rose-800",text:"text-rose-200"}},{id:"brewery",name:"酿造坊",desc:"将粮食发酵酿造成美酒，供贸易与享用。",baseCost:{wood:90,stone:50,brick:25},input:{food:1.8,wood:.3},output:{ale:1.8},jobs:{worker:3},owner:"worker",epoch:2,cat:"industry",requiresTech:"brewing",visual:{icon:"Wine",color:"bg-purple-800",text:"text-purple-200"},marketConfig:{price:{livingCostWeight:.4,taxCostWeight:.5},wage:{livingCostWeight:.25,taxCostWeight:.25}}},{id:"furniture_workshop",name:"家具工坊",desc:"将木板与布料雕刻成精美家具，提升上层阶级的生活品质。",baseCost:{plank:120,stone:80},input:{tools:.1333,plank:1.3333,cloth:.4},output:{furniture:1.6},jobs:{artisan:4},owner:"artisan",epoch:2,cat:"industry",requiresTech:"carpentry",visual:{icon:"Armchair",color:"bg-amber-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.4},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"loom_house",name:"织布坊",desc:"家庭式纺纱织布，保障民众衣物供应。",baseCost:{wood:35,food:20},output:{cloth:2.88},jobs:{worker:3},owner:"worker",epoch:0,cat:"industry",visual:{icon:"Shirt",color:"bg-indigo-800",text:"text-indigo-200"},marketConfig:{price:{livingCostWeight:.12,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"dye_works",name:"染坊",desc:"从植物中提取染料，用于制作高级织物。",baseCost:{wood:60,stone:20},input:{food:.75},output:{dye:.9},jobs:{worker:3},owner:"worker",epoch:1,cat:"industry",visual:{icon:"Paintbrush",color:"bg-pink-800",text:"text-pink-200"}},{id:"tailor_workshop",name:"成衣作坊",desc:"使用布料和染料制作精美的华服，供上层阶级享用。",baseCost:{wood:100,stone:40},input:{tools:.06,cloth:1.5,dye:.3},output:{fine_clothes:1.2,culture:.5},jobs:{artisan:3},owner:"artisan",epoch:1,cat:"industry",requiresTech:"tools",visual:{icon:"Package",color:"bg-indigo-900",text:"text-indigo-100"}},{id:"mine",name:"铁矿井",desc:"深入岩层采集铁矿，需要工具维护。",baseCost:{plank:120,food:220},input:{tools:.072},output:{iron:.9},jobs:{miner:9,landowner:1},owner:"landowner",epoch:2,cat:"gather",requiresTech:"ironworking",visual:{icon:"Mountain",color:"bg-zinc-700",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"coffee_plantation",name:"咖啡种植园",desc:"开垦远方殖民地的咖啡种植地。",baseCost:{wood:200,spice:30},output:{coffee:.6},jobs:{serf:6,merchant:1},owner:"merchant",epoch:5,cat:"gather",requiresTech:"coffee_agronomy",visual:{icon:"Coffee",color:"bg-amber-900",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.05,taxCostWeight:.05,wageMode:"subsistence",subsistenceMultiplier:1.3}}},{id:"coal_mine",name:"煤矿",desc:"开采地下煤炭，工业能源基石。",baseCost:{plank:200,tools:60},input:{tools:.2},output:{coal:3},jobs:{miner:12,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"coal_gasification",visual:{icon:"Flame",color:"bg-slate-700",text:"text-slate-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"hut",name:"简陋小屋",desc:"增加人口上限。",baseCost:{wood:20,food:20},output:{maxPop:3},epoch:0,cat:"civic",visual:{icon:"Tent",color:"bg-orange-800",text:"text-orange-200"}},{id:"house",name:"木屋",desc:"以木板与砖块搭建的整洁居所。",baseCost:{plank:60,brick:40},output:{maxPop:8},epoch:2,cat:"civic",requiresTech:"urban_planning",visual:{icon:"Home",color:"bg-amber-700",text:"text-amber-100"}},{id:"manor_house",name:"石砌宅邸",desc:"贵族风格的石砌住宅，坚固耐久，彰显领主权威。",baseCost:{brick:120,plank:80,iron:15},output:{maxPop:9},epoch:3,cat:"civic",requiresTech:"manor_architecture",visual:{icon:"Castle",color:"bg-blue-800",text:"text-blue-200"}},{id:"townhouse",name:"联排住宅",desc:"港口城市流行的多层联排建筑，高效利用城市空间。",baseCost:{brick:180,plank:120,tools:25},output:{maxPop:10},epoch:4,cat:"civic",requiresTech:"colonial_architecture",visual:{icon:"Building",color:"bg-cyan-800",text:"text-cyan-200"}},{id:"civic_apartment",name:"阁楼公馆",desc:"启蒙时代流行的多层砖石建筑，优雅的阁楼设计为新兴中产阶级提供舒适居所。",baseCost:{brick:250,plank:150,iron:40,furniture:20},output:{maxPop:11},epoch:5,cat:"civic",requiresTech:"enlightened_urbanism",visual:{icon:"Building2",color:"bg-purple-800",text:"text-purple-200"}},{id:"granary",name:"粮仓",desc:"加固的干燥粮仓，提升人口承载。",baseCost:{wood:120,brick:40,stone:30},output:{maxPop:6},epoch:1,cat:"civic",requiresTech:"granary_architecture",visual:{icon:"Boxes",color:"bg-yellow-900",text:"text-yellow-200"}},{id:"town_hall",name:"市政厅",desc:"官员办公地，提供官员岗位，需要少量维护。",baseCost:{brick:200,plank:200,cloth:20},input:{brick:.2,papyrus:.02,delicacies:.1,fine_clothes:.05,culture:.03,science:.05},output:{},jobs:{official:7},epoch:3,cat:"civic",requiresTech:"bureaucracy",visual:{icon:"Scale",color:"bg-slate-800",text:"text-slate-200"}},{id:"church",name:"教堂",desc:"安抚民心，产出文化。",baseCost:{stone:150,plank:50,brick:60},input:{furniture:.1333,fine_clothes:.1333,brick:.0533},output:{culture:3.2,silver:.6667},jobs:{cleric:4},owner:"cleric",epoch:3,cat:"civic",requiresTech:"theology",visual:{icon:"Cross",color:"bg-purple-900",text:"text-purple-200"}},{id:"monastery_cellar",name:"修道院酒窖",desc:"修道士传承的酿酒技艺，出产上等美酒，彰显宗教文化。",baseCost:{stone:120,brick:60,tools:15},input:{food:2.7,wood:.45},output:{ale:3,culture:1.2},jobs:{cleric:1,worker:3},owner:"cleric",epoch:3,cat:"industry",requiresTech:"monastic_brewing",visual:{icon:"Wine",color:"bg-purple-800",text:"text-purple-200"}},{id:"wool_workshop",name:"纺织工场",desc:"规模化的羊毛加工作坊，封建领地的重要经济支柱。",baseCost:{plank:100,brick:50,tools:15},input:{food:.9,tools:.045},output:{cloth:4.8,fine_clothes:.3},jobs:{serf:4,worker:3},owner:"worker",epoch:3,cat:"industry",requiresTech:"wool_trade",visual:{icon:"Shirt",color:"bg-indigo-700",text:"text-indigo-200"},marketConfig:{price:{livingCostWeight:.12,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.08,wageMode:"subsistence",subsistenceMultiplier:1.8}}},{id:"stone_workshop",name:"采石工场",desc:"使用铁器工具的专业采石场，为城堡和教堂建设提供大量优质石料。",baseCost:{plank:80,iron:30,tools:20},input:{tools:.075},output:{stone:4.375},jobs:{miner:4,worker:1},owner:"miner",epoch:3,cat:"gather",requiresTech:"masonry_guild",visual:{icon:"Pickaxe",color:"bg-stone-700",text:"text-stone-200"}},{id:"hardwood_camp",name:"硬木林场",desc:"有计划的森林采伐，提供大量木材与优质硬木。",baseCost:{plank:100,iron:25,tools:25},input:{tools:.096},output:{wood:5.76},jobs:{lumberjack:5,worker:1},owner:"lumberjack",epoch:3,cat:"gather",requiresTech:"forestry_management",visual:{icon:"Trees",color:"bg-emerald-900",text:"text-emerald-200"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"amphitheater",name:"剧场",desc:"古典时代的文化舞台，激发灵感。",baseCost:{stone:200,brick:80,dye:10},input:{fine_clothes:.225,brick:.045},output:{culture:5.4},jobs:{cleric:3},owner:"cleric",epoch:1,cat:"civic",requiresTech:"amphitheater_design",visual:{icon:"Music2",color:"bg-rose-900",text:"text-rose-200"}},{id:"navigator_school",name:"航海学院",desc:"培养探索时代的开路者，产出科研文化。",baseCost:{wood:160,papyrus:80,brick:70},output:{science:.75,culture:1},jobs:{navigator:3,scribe:1,official:1},owner:"official",epoch:4,cat:"civic",requiresTech:"navigator_schooling",visual:{icon:"Navigation",color:"bg-cyan-900",text:"text-cyan-200"}},{id:"shaft_mine",name:"竖井矿场",desc:"利用绞盘与更好的通风设施深入地下，同时开采铜铁矿脉。",baseCost:{brick:150,plank:100,tools:50},input:{tools:.144,wood:.3,science:.05},output:{iron:1.44,copper:.96},jobs:{miner:6,engineer:1},owner:"miner",epoch:4,cat:"gather",requiresTech:"advanced_metallurgy",visual:{icon:"Mountain",color:"bg-zinc-600",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"dye_workshop",name:"印染工坊",desc:"使用新世界染料的专业印染作坊，如珍贵的胭脂虫红。",baseCost:{brick:100,plank:80,tools:20},input:{food:1.2,cloth:.6,spice:.075,science:.02},output:{dye:1.8,fine_clothes:.45},jobs:{artisan:3,worker:2},owner:"artisan",epoch:4,cat:"industry",requiresTech:"new_world_dyes",visual:{icon:"Paintbrush",color:"bg-rose-800",text:"text-rose-200"}},{id:"coffee_house",name:"咖啡馆",desc:"啜饮咖啡、交流思想的启蒙沙龙。",baseCost:{plank:140,coffee:40,cloth:20,delicacies:15,science:100},input:{coffee:.5333,delicacies:.2667},output:{culture:4,science:1.3333},jobs:{merchant:1,scribe:3},owner:"merchant",epoch:5,cat:"civic",requiresTech:"coffeehouse_philosophy",visual:{icon:"Coffee",color:"bg-brown-900",text:"text-amber-200"}},{id:"rail_depot",name:"铁路枢纽",desc:"蒸汽时代的交通心脏，连接全国贸易，提供岗位和人口上限。",baseCost:{steel:180,coal:120,science:300},input:{coal:.72,ale:.36,delicacies:.18,science:.15},output:{silver:2.7,maxPop:14},jobs:{engineer:4,merchant:3,capitalist:1},owner:"capitalist",epoch:6,cat:"civic",requiresTech:"rail_network",visual:{icon:"Train",color:"bg-gray-900",text:"text-gray-100"}},{id:"sawmill",name:"锯木厂",desc:"在铜制工具辅助下高效加工木板。",baseCost:{wood:75,stone:35},input:{wood:1.6},output:{plank:3.47},jobs:{worker:4},owner:"worker",epoch:1,requiresTech:"tools",cat:"industry",visual:{icon:"Hammer",color:"bg-amber-900",text:"text-amber-300"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"brickworks",name:"砖窯",desc:"烧制砖块，供城墙与民宅所用。",baseCost:{wood:140,stone:90},input:{stone:1.5,wood:.45},output:{brick:3.6},jobs:{worker:3},owner:"worker",epoch:0,cat:"industry",requiresTech:"pottery",visual:{icon:"Factory",color:"bg-red-900",text:"text-red-300"}},{id:"stone_tool_workshop",name:"石器作坊",desc:"用燧石和木料打制粗糙的工具。",baseCost:{wood:40,stone:25},input:{wood:1.5,stone:1.2},output:{tools:.75},jobs:{artisan:3},owner:"artisan",epoch:0,cat:"industry",requiresTech:"tool_making",visual:{icon:"Hammer",color:"bg-stone-700",text:"text-stone-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"bronze_foundry",name:"青铜铸坊",desc:"熔炼铜与木炭，制造精良工具。",baseCost:{wood:140,stone:75,copper:35},input:{copper:.8,wood:.5333},output:{tools:1.3333},jobs:{worker:3,artisan:1},owner:"artisan",epoch:1,cat:"industry",requiresTech:"bronze_working",visual:{icon:"Anvil",color:"bg-orange-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"iron_tool_workshop",name:"铁器铺",desc:"以铁为原料，锻造坚固耐用的工具。",baseCost:{plank:150,brick:80},input:{wood:.6667,iron:1.0667},output:{tools:2},jobs:{worker:3,artisan:1},owner:"artisan",epoch:2,cat:"industry",requiresTech:"ironworking",visual:{icon:"Cog",color:"bg-zinc-800",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"factory",name:"工厂",desc:"蒸汽驱动的流水线生产工具与机械。",baseCost:{brick:400,steel:200,science:350},input:{steel:2,coal:2,science:.5},output:{tools:15},jobs:{worker:20,engineer:4,capitalist:1},owner:"capitalist",epoch:6,requiresTech:"industrialization",cat:"industry",visual:{icon:"Factory",color:"bg-blue-900",text:"text-blue-200"}},{id:"printing_house",name:"印刷所",desc:"启蒙时代的出版重镇，大量复制知识。",baseCost:{brick:200,papyrus:80,wood:60,science:150},input:{papyrus:.8,coffee:.2,brick:.08,science:.3},output:{science:2.4,culture:2},jobs:{artisan:5,scribe:3,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"printing_press",visual:{icon:"BookOpen",color:"bg-indigo-900",text:"text-indigo-200"}},{id:"steel_foundry",name:"炼钢厂",desc:"以煤炭为燃料的炼钢炉，供应工业时代钢材。",baseCost:{brick:300,iron:200,science:280},input:{iron:.7,coal:.7,science:.2},output:{steel:.7},jobs:{engineer:5,worker:7,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"steel_alloys",visual:{icon:"Cog",color:"bg-gray-900",text:"text-gray-200"}},{id:"library",name:"图书馆",desc:"编目典籍，持续产出科研。",baseCost:{wood:200,stone:100},output:{science:1.0667},jobs:{scribe:4},owner:"scribe",epoch:0,cat:"civic",visual:{icon:"Landmark",color:"bg-cyan-800",text:"text-cyan-200"}},{id:"market",name:"市场",desc:"自动平衡市场供需：将盈余的滞销资源出口，换取急需的短缺资源。产出少量商业税收。",baseCost:{plank:100},input:{brick:.075},output:{food:3},jobs:{merchant:3},owner:"merchant",epoch:1,requiresTech:"caravan_trade",cat:"civic",visual:{icon:"Handshake",color:"bg-yellow-800",text:"text-yellow-200"}},{id:"magistrate_office",name:"官署",desc:"早期行政机构，管理青铜时代的税收与民政。提供少量官员岗位。",baseCost:{plank:80,stone:60,brick:40},input:{papyrus:.015,brick:.03},output:{},jobs:{official:3,scribe:1},epoch:1,cat:"civic",requiresTech:"early_administration",visual:{icon:"Scroll",color:"bg-slate-700",text:"text-slate-200"}},{id:"dockyard",name:"船坞",desc:"建造远洋船队，换取异域香料。",baseCost:{plank:200,tools:40},input:{wood:.6},output:{spice:.84},jobs:{navigator:3,worker:2,merchant:1},owner:"merchant",epoch:4,cat:"industry",requiresTech:"cartography",visual:{icon:"Anchor",color:"bg-sky-900",text:"text-sky-200"}},{id:"trade_port",name:"贸易港",desc:"汇聚香料、银币与海外特许的繁忙港口。",baseCost:{plank:220,spice:60},input:{spice:.4},output:{food:2.6667},jobs:{merchant:4},owner:"merchant",epoch:4,cat:"civic",requiresTech:"charter_companies",visual:{icon:"Ship",color:"bg-indigo-900",text:"text-indigo-200"}},{id:"barracks",name:"兵营",desc:"训练和驻扎军队的基地，提供军事容量。",baseCost:{wood:80,stone:40},output:{militaryCapacity:10},epoch:0,cat:"military",visual:{icon:"Shield",color:"bg-red-900",text:"text-red-200"}},{id:"training_ground",name:"训练场",desc:"专业的军事训练设施，大幅提升军事容量。",baseCost:{plank:150,brick:80,iron:30},output:{militaryCapacity:20},epoch:2,cat:"military",requiresTech:"military_training",visual:{icon:"Swords",color:"bg-red-800",text:"text-red-100"}},{id:"fortress",name:"要塞",desc:"坚固的军事堡垒，可容纳大量军队。",baseCost:{brick:300,iron:150,steel:50},output:{militaryCapacity:40},epoch:4,cat:"military",requiresTech:"fortification",visual:{icon:"Castle",color:"bg-red-950",text:"text-red-100"}},{id:"textile_mill",name:"纺织厂",desc:"水力驱动的纺织机，大幅提升布料和成衣产量。",baseCost:{brick:180,plank:120,tools:60,science:150},input:{food:2,dye:.75},output:{cloth:12.5,fine_clothes:1.5},jobs:{worker:15,artisan:4,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"mechanized_weaving",visual:{icon:"Shirt",color:"bg-indigo-700",text:"text-indigo-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"garment_factory",name:"服装工厂",desc:"蒸汽动力缝纫机的大规模成衣生产线。",baseCost:{brick:350,steel:150,tools:100,science:300},input:{cloth:3.75,dye:.75,coal:.45},output:{fine_clothes:4.2,culture:.45},jobs:{worker:18,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"assembly_line",visual:{icon:"Factory",color:"bg-indigo-900",text:"text-indigo-100"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"lumber_mill",name:"木材加工厂",desc:"水力锯木机与烘干设备，高效生产优质木板。",baseCost:{brick:160,plank:100,tools:50},input:{wood:6.4286},output:{plank:17.1429},jobs:{worker:10,artisan:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"hydraulic_sawing",visual:{icon:"Axe",color:"bg-amber-700",text:"text-amber-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.12,taxCostWeight:.12}}},{id:"furniture_factory",name:"家具工厂",desc:"流水线生产标准化家具，满足城市中产阶级需求。",baseCost:{brick:280,steel:120,tools:80,science:280},input:{plank:5.625,cloth:1.8,coal:.5625},output:{furniture:7.875,culture:.45},jobs:{worker:17,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"mass_production",visual:{icon:"Armchair",color:"bg-amber-900",text:"text-amber-100"},marketConfig:{price:{livingCostWeight:.28,taxCostWeight:.32},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"metallurgy_workshop",name:"冶金工坊",desc:"改良的熔炉与锻造技术，高效生产精良工具。",baseCost:{brick:200,iron:100,tools:60},input:{iron:1.7143,copper:.3429,wood:.9143},output:{tools:3.4286},jobs:{worker:5,artisan:2,engineer:1},owner:"artisan",epoch:4,cat:"industry",requiresTech:"advanced_metallurgy",visual:{icon:"Anvil",color:"bg-zinc-700",text:"text-zinc-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"steel_works",name:"钢铁联合体",desc:"垂直整合的大型钢铁企业，从矿石到成品一条龙生产。",baseCost:{brick:500,steel:250,tools:150,science:400},input:{iron:1.44,coal:1.2,science:.4},output:{steel:1.44,tools:.96},jobs:{worker:18,engineer:5,capitalist:2},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"bessemer_process",visual:{icon:"Factory",color:"bg-gray-800",text:"text-gray-100"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"building_materials_plant",name:"建材厂",desc:"规模化生产砖块和预制建材，加速城市建设。",baseCost:{brick:200,plank:100,tools:50},input:{stone:4.5,wood:1.35,coal:.45},output:{brick:12.375},jobs:{worker:14,engineer:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"industrial_ceramics",visual:{icon:"Building2",color:"bg-red-800",text:"text-red-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.12,taxCostWeight:.12}}},{id:"prefab_factory",name:"预制构件厂",desc:"生产标准化建筑构件，革命性地改变建筑行业。",baseCost:{brick:400,steel:200,tools:100,science:350},input:{brick:3,steel:.4,stone:2,coal:.8},output:{brick:22},jobs:{worker:20,engineer:4,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"standardized_construction",visual:{icon:"Building",color:"bg-slate-700",text:"text-slate-100"},marketConfig:{price:{livingCostWeight:.28,taxCostWeight:.32},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"cannery",name:"罐头厂",desc:"革命性的食品保存技术，将珍馐装罐长期保存。",baseCost:{brick:250,steel:100,tools:60,science:280},input:{food:5.625,iron:.675,coal:.5625},output:{delicacies:7.875},jobs:{worker:17,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"food_preservation",visual:{icon:"Package",color:"bg-orange-800",text:"text-orange-100"},marketConfig:{price:{livingCostWeight:.22,taxCostWeight:.28},wage:{livingCostWeight:.14,taxCostWeight:.14}}},{id:"distillery",name:"蒸馏酒厂",desc:"工业化的酿酒设施，生产高度烈酒供出口贸易。",baseCost:{brick:220,copper:80,tools:50,science:140},input:{food:4.5,coal:.45},output:{ale:7.875,silver:1.8},jobs:{worker:12,artisan:2,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"distillation",visual:{icon:"Wine",color:"bg-purple-700",text:"text-purple-100"},marketConfig:{price:{livingCostWeight:.35,taxCostWeight:.4},wage:{livingCostWeight:.22,taxCostWeight:.22}}},{id:"paper_mill",name:"造纸厂",desc:"工业化造纸设备，用木浆大规模生产纸张。",baseCost:{brick:180,plank:100,tools:50,science:130},input:{wood:3,coal:.3},output:{papyrus:5},jobs:{worker:10,engineer:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"wood_pulp_process",visual:{icon:"ScrollText",color:"bg-lime-700",text:"text-lime-100"},marketConfig:{price:{livingCostWeight:.18,taxCostWeight:.22},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"publishing_house",name:"出版社",desc:"现代印刷与发行一体化，传播知识启迪民智。",baseCost:{brick:300,steel:80,papyrus:100,science:320},input:{papyrus:2,coffee:.4,coal:.3},output:{science:5,culture:2},jobs:{scribe:8,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"mass_media",visual:{icon:"Newspaper",color:"bg-cyan-800",text:"text-cyan-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"industrial_mine",name:"工业矿场",desc:"蒸汽动力的深井采矿设备，大幅提升矿石产量。",baseCost:{brick:350,steel:200,tools:100},input:{tools:.2615,coal:.5231},output:{iron:2.9616,copper:.9577},jobs:{miner:17,engineer:2,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"deep_shaft_mining",visual:{icon:"Mountain",color:"bg-zinc-800",text:"text-zinc-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"mechanized_farm",name:"机械化农场",desc:"蒸汽拖拉机与收割机，农业产量飞跃式提升。",baseCost:{brick:200,steel:150,tools:80},input:{tools:.175,coal:.35},output:{food:38.5},jobs:{peasant:8,worker:8,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"agricultural_machinery",visual:{icon:"Tractor",color:"bg-green-800",text:"text-green-100"},marketConfig:{price:{livingCostWeight:.18,taxCostWeight:.22},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"logging_company",name:"伐木公司",desc:"配备蒸汽锯和运输铁路的大型伐木企业。",baseCost:{brick:180,steel:100,tools:60},input:{tools:.1333,coal:.25},output:{wood:20},jobs:{lumberjack:11,worker:7,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"steam_logging",visual:{icon:"TreeDeciduous",color:"bg-emerald-700",text:"text-emerald-100"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"apartment_block",name:"公寓楼",desc:"多层住宅建筑，容纳大量城市人口。",baseCost:{brick:400,steel:100,plank:150},output:{maxPop:11},epoch:6,cat:"civic",requiresTech:"urban_architecture",visual:{icon:"Building2",color:"bg-slate-600",text:"text-slate-100"}},{id:"university",name:"大学",desc:"高等学府，培养工程师和学者，产出大量科研。",baseCost:{brick:400,plank:200,papyrus:100,science:200},input:{papyrus:.36,coffee:.24,delicacies:.18,brick:.072,science:.5},output:{science:3.6,culture:.96},jobs:{scribe:5,engineer:2,official:2},owner:"official",epoch:5,cat:"civic",requiresTech:"higher_education",visual:{icon:"GraduationCap",color:"bg-blue-900",text:"text-blue-100"}},{id:"opera_house",name:"歌剧院",desc:"华丽的艺术殿堂，展示文明的文化成就。",baseCost:{brick:350,plank:150,furniture:80,culture:40,dye:20,science:160},input:{fine_clothes:.2857,delicacies:.2286,brick:.0571},output:{culture:4,silver:1.1429},jobs:{cleric:5,artisan:2,merchant:1},owner:"cleric",epoch:5,cat:"civic",requiresTech:"grand_arts",visual:{icon:"Music",color:"bg-rose-800",text:"text-rose-100"}},{id:"stock_exchange",name:"证券交易所",desc:"金融资本的神经中枢，调配全国资金流向。",baseCost:{brick:500,steel:150,papyrus:100,science:400},input:{papyrus:.32,coffee:.24},output:{silver:8,culture:.8},jobs:{merchant:10,scribe:3,capitalist:2},owner:"capitalist",epoch:6,cat:"civic",requiresTech:"financial_capitalism",visual:{icon:"TrendingUp",color:"bg-emerald-900",text:"text-emerald-100"}}],tr=[{id:"barter",name:"物物交换",desc:"允许建造贸易站，让商人阶层登上历史舞台。财政收入 +2%。",cost:{science:150},epoch:0,effects:{incomePercent:.02}},{id:"stone_axes",name:"磨制石斧",desc:"伐木场产出提升 25%。",cost:{science:150},epoch:0,effects:{buildings:{lumber_camp:.12}}},{id:"flint_knapping",name:"打制燧石",desc:"采石场效率增加 25%。",cost:{science:210},epoch:0,effects:{buildings:{quarry:.12}}},{id:"animal_husbandry",name:"畜牧业",desc:"驯养牲畜，每人每日额外获得 0.1 粮食。",cost:{science:240},epoch:0,effects:{perPopPassive:{food:.1}}},{id:"pottery",name:"陶器",desc:"农田储粮效率 +10%。",cost:{science:300},epoch:0,effects:{buildings:{farm:.05}}},{id:"tool_making",name:"工具制作",desc:"解锁石器作坊，提供早期稳定的工具来源。采集建筑效率 +10%。",cost:{science:270},epoch:0,effects:{categories:{gather:.05}}},{id:"basic_irrigation",name:"基础灌溉",desc:"开凿浅渠把河水引入农田，产量提升 15%。",cost:{science:360},epoch:0,effects:{buildings:{farm:.08}}},{id:"oral_tradition",name:"口述传统",desc:"长者口述史诗，图书馆的整理效率提升 15%。",cost:{science:330},epoch:0,effects:{buildings:{library:.08}}},{id:"communal_granary",name:"公共粮仓",desc:"人口上限 +10%。",cost:{science:390},epoch:0,effects:{maxPop:.1}},{id:"river_fishing",name:"河湾捕鱼",desc:"每人每日额外获得 0.05 粮食，财政收入 +1%。",cost:{science:450},epoch:0,effects:{perPopPassive:{food:.05},incomePercent:.01}},{id:"wheel",name:"车轮",desc:"采集建筑整体效率 +20%。",cost:{science:480},epoch:0,effects:{categories:{gather:.1}}},{id:"sailing",name:"航海术",desc:"解锁船坞建设，开启海上贸易与军事行动。财政收入 +3%，每人每日获得 0.02 粮食。",cost:{science:1050},epoch:1,effects:{incomePercent:.03,perPopPassive:{food:.02}}},{id:"tools",name:"铜制工具",desc:"允许建造锯木厂，工业效率 +5%。",cost:{science:750},epoch:1,effects:{categories:{industry:.03}}},{id:"copper_mining",name:"铜脉勘探",desc:"解锁铜矿开采。",cost:{science:840},epoch:1,effects:{}},{id:"bronze_working",name:"青铜冶炼",desc:"青铜铸坊产出 +30%，铁矿井同步获得 +15%。",cost:{science:960},epoch:1,effects:{buildings:{bronze_foundry:.15,mine:.08}}},{id:"horse_collar",name:"牛项圈",desc:"农田与庄园增产 10%。",cost:{science:780},epoch:1,effects:{buildings:{farm:.05,large_estate:.05}}},{id:"caravan_trade",name:"驼队贸易",desc:"市场银币收入 +35%。",cost:{science:900},epoch:1,effects:{buildings:{market:.18}}},{id:"granary_architecture",name:"粮仓结构",desc:"粮仓产出 +25%，并额外提供 +5% 人口上限。",cost:{science:960},epoch:1,effects:{buildings:{granary:.12},maxPop:.05}},{id:"primitive_weaving",name:"原始纺织",desc:"使用简易织机将羊毛加工为布料。织布坊效率 +10%。",cost:{science:820},epoch:1,effects:{buildings:{loom_house:.05}}},{id:"early_administration",name:"早期行政",desc:"解锁官署，建立初步的税收与民政管理体系。启用官员系统，官员容量 +2。",cost:{science:880},epoch:1,effects:{categories:{civic:.05}}},{id:"papyrus_cultivation",name:"改进造纸术",desc:"造纸工坊效率 +20%。",cost:{science:1575},epoch:2,effects:{buildings:{reed_works:.12}}},{id:"culinary_arts",name:"烹饪艺术",desc:"解锁烹饪坊，将粮食加工为珍馐，满足上层阶级的饮食需求。",cost:{science:1680},epoch:2,effects:{}},{id:"brewing",name:"酿造工艺",desc:"解锁酿造坊，将粮食发酵为美酒，供贸易与享用。",cost:{science:1610},epoch:2,effects:{}},{id:"carpentry",name:"精细木工",desc:"解锁家具工坊，将木材与石料加工为精美家具，提升上层阶级的生活品质。",cost:{science:1750},epoch:2,effects:{}},{id:"library_catalogs",name:"图书编目",desc:"图书馆科研 +25%。",cost:{science:1645},epoch:2,effects:{buildings:{library:.15}}},{id:"amphitheater_design",name:"剧场设计",desc:"解锁剧场建筑。",cost:{science:1470},epoch:1,effects:{}},{id:"urban_planning",name:"城市规划",desc:"木屋效率 +20%，人口上限 +5%。",cost:{science:1820},epoch:2,effects:{buildings:{house:.12},maxPop:.05}},{id:"republican_code",name:"共和法典",desc:"完善的法律体系提升社会运转效率。民生建筑效率 +15%，人口上限 +5%。",cost:{science:1960},epoch:2,effects:{categories:{civic:.09},maxPop:.05}},{id:"road_system",name:"道路网络",desc:"采集作业效率 +10%。",cost:{science:2100},epoch:2,effects:{categories:{gather:.06}}},{id:"advanced_weaving",name:"高级纺织",desc:"改进织布工具和织机设计，提升纺织效率。织布坊效率 +20%。",cost:{science:1950},epoch:2,effects:{buildings:{loom_house:.12}}},{id:"feudalism",name:"封建制度",desc:"庄园耕作效率 +15%。",cost:{science:3500},epoch:3,effects:{buildings:{large_estate:.09}}},{id:"basic_weaving",name:"织布机",desc:"新型的纺织工具。织布坊效率 +25%。",cost:{science:3150},epoch:3,effects:{buildings:{loom_house:.15}}},{id:"theology",name:"神学",desc:"教堂文化产出 +30%。",cost:{science:3850},epoch:3,effects:{buildings:{church:.18}}},{id:"bureaucracy",name:"官僚制度",desc:"解锁市政厅，建立高效的行政管理体系。采集、工业、市政建筑效率 +5%，每人每日获得 0.002 文化。官员容量 +3。",cost:{science:4200},epoch:3,effects:{categories:{gather:.03,industry:.03,civic:.03},perPopPassive:{culture:.002}}},{id:"civil_service",name:"文官制度",desc:"建立系统化的文官选拔与考核体系，提升行政效率。税收收入 +5%，官员容量 +3。",cost:{science:8750},epoch:4,effects:{incomePercent:.05}},{id:"administrative_reform",name:"行政改革",desc:"改革行政体系，提升官僚机构运转效率。民生建筑效率 +10%，官员容量 +4。",cost:{science:18900},epoch:5,effects:{categories:{civic:.07}}},{id:"centralization",name:"中央集权",desc:"加强中央政府权威，统一政令。税收收入 +8%，稳定度 +5%，官员容量 +2。",cost:{science:27900},epoch:6,effects:{incomePercent:.08}},{id:"three_field_system",name:"三圃制",desc:"农田与庄园额外 +15% 产量。",cost:{science:3850},epoch:3,effects:{buildings:{farm:.09,large_estate:.09}}},{id:"stone_keep_engineering",name:"石垒堡舍",desc:"居住建筑人口上限加成 10%。",cost:{science:4025},epoch:3,effects:{buildings:{hut:.06,house:.06}}},{id:"manor_architecture",name:"庄园建筑学",desc:"解锁石砌宅邸，贵族风格的坚固住宅，提供更多人口容量。宅邸效率 +15%，人口上限 +5%。",cost:{science:4550},epoch:3,effects:{buildings:{manor_house:.15},maxPop:.05}},{id:"monastic_brewing",name:"修道院酿造",desc:"解锁修道院酒窖，修士传承的高级酿酒工艺。酒窖效率 +15%，教堂文化 +10%。",cost:{science:4200},epoch:3,effects:{buildings:{monastery_cellar:.15,church:.1}}},{id:"wool_trade",name:"羊毛贸易",desc:"解锁纺织工场，封建时代最重要的纺织产业。纺织工场效率 +15%，织布坊效率 +10%。",cost:{science:3850},epoch:3,effects:{buildings:{wool_workshop:.15,loom_house:.1}}},{id:"masonry_guild",name:"石匠行会",desc:"解锁采石工场，行会组织的专业采石作业。采石工场效率 +15%，采石场效率 +10%。",cost:{science:4025},epoch:3,effects:{buildings:{stone_workshop:.15,quarry:.1}}},{id:"forestry_management",name:"林业管理",desc:"解锁硬木林场，有计划的森林采伐与维护。硬木林场效率 +15%，伐木场效率 +10%。",cost:{science:3675},epoch:3,effects:{buildings:{hardwood_camp:.15,lumber_camp:.1}}},{id:"ritual_priesthood",name:"仪式司祭",desc:"礼拜设施文化产出提升 15%。",cost:{science:1190},epoch:3,effects:{buildings:{church:.09}}},{id:"ironworking",name:"锻铁术",desc:"解锁铁器铺，并且铁矿井效率 +30%。",cost:{science:1500},epoch:2,effects:{buildings:{mine:.18}}},{id:"cartography",name:"海图绘制",desc:"船坞香料获取 +25%。",cost:{science:6300},epoch:4,effects:{buildings:{dockyard:.18}}},{id:"charter_companies",name:"特许公司",desc:"贸易港银币产出 +30%，财政收入 +5%。",cost:{science:6650},epoch:4,effects:{buildings:{trade_port:.21},incomePercent:.05}},{id:"navigator_schooling",name:"领航学",desc:"航海学院科研提升 30%。",cost:{science:7e3},epoch:4,effects:{buildings:{navigator_school:.21}}},{id:"naval_artillery",name:"舰炮试验",desc:"船坞额外获得 15% 产量。",cost:{science:7350},epoch:4,effects:{buildings:{dockyard:.1}}},{id:"colonial_ledgers",name:"殖民档案",desc:"系统化的殖民地档案管理，提升海外贸易效率。船坞和贸易港效率 +20%，财政收入 +5%。",cost:{science:7700},epoch:4,effects:{buildings:{dockyard:.14,trade_port:.14},incomePercent:.05}},{id:"spice_monopolies",name:"香料垄断",desc:"贸易港再获 15% 产量。",cost:{science:8050},epoch:4,effects:{buildings:{trade_port:.1}}},{id:"colonial_architecture",name:"殖民建筑",desc:"解锁联排住宅，港口城市流行的高效多层建筑。联排住宅效率 +15%，人口上限 +5%。",cost:{science:8400},epoch:4,effects:{buildings:{townhouse:.15},maxPop:.05}},{id:"new_world_dyes",name:"新世界染料",desc:"解锁印染工坊，使用胭脂虫红等新世界珍贵染料。印染工坊效率 +15%，染坊效率 +10%。",cost:{science:7875},epoch:4,effects:{buildings:{dye_workshop:.15,dye_works:.1}}},{id:"coffee_agronomy",name:"咖啡栽培学",desc:"解锁咖啡种植园。",cost:{science:14400},epoch:5,effects:{}},{id:"coffeehouse_philosophy",name:"咖啡馆哲学",desc:"解锁咖啡馆，每人每日获得 0.002 文化。",cost:{science:15300},epoch:5,effects:{perPopPassive:{culture:.002}}},{id:"printing_press",name:"印刷机",desc:"解锁印刷所。",cost:{science:16200},epoch:5,effects:{}},{id:"public_schooling",name:"公共教育",desc:"图书馆 +25% 科研，每人每日获得 0.001 文化。",cost:{science:17100},epoch:5,effects:{buildings:{library:.18},perPopPassive:{culture:.001}}},{id:"social_contract",name:"社会契约",desc:"启蒙思想推动社会进步。民生建筑效率 +20%，人口上限 +5%，每人每日获得 0.003 文化。",cost:{science:18e3},epoch:5,effects:{categories:{civic:.14},maxPop:.05,perPopPassive:{culture:.003}}},{id:"salon_debates",name:"沙龙辩论",desc:"剧场文化再增 15%。",cost:{science:18900},epoch:5,effects:{buildings:{amphitheater:.1}}},{id:"enlightened_urbanism",name:"启蒙城市主义",desc:"解锁阁楼公馆，兼具优雅与实用的新式住宅区。阁楼公馆效率 +15%，人口上限 +6%。",cost:{science:19800},epoch:5,effects:{buildings:{civic_apartment:.15},maxPop:.06}},{id:"coal_gasification",name:"煤气化",desc:"解锁煤矿开采。",cost:{science:23400},epoch:6,effects:{}},{id:"steel_alloys",name:"钢合金",desc:"解锁炼钢厂。",cost:{science:24300},epoch:6,effects:{}},{id:"industrialization",name:"工业化",desc:"解锁工厂，工业建筑效率 +10%。",cost:{science:27e3},epoch:6,effects:{categories:{industry:.07}}},{id:"steam_power",name:"蒸汽动力",desc:"工业建筑再获 +20% 产量。",cost:{science:28800},epoch:6,effects:{categories:{industry:.14}}},{id:"chemical_fertilizer",name:"化学施肥",desc:"农田与庄园 +20% 产出。",cost:{science:27e3},epoch:6,effects:{buildings:{farm:.14,large_estate:.14}}},{id:"rail_network",name:"铁路网",desc:"铁路枢纽效率 +30%，采集 +10%。",cost:{science:27900},epoch:6,effects:{buildings:{rail_depot:.21},categories:{gather:.07}}},{id:"precision_tools",name:"精密机具",desc:"工厂产出 +25%。",cost:{science:28800},epoch:6,effects:{buildings:{factory:.18}}},{id:"military_training",name:"军事训练",desc:"解锁训练场，提供更多军事容量。军事建筑效率 +15%。",cost:{science:2800},epoch:2,effects:{categories:{military:.1}}},{id:"fortification",name:"要塞工程",desc:"解锁要塞，大幅提升军事容量。军事建筑效率 +25%，人口上限 +5%。",cost:{science:8400},epoch:4,effects:{categories:{military:.18},maxPop:.05}},{id:"mechanized_weaving",name:"机械织布",desc:"解锁织布坊和成衣作坊，水力驱动的飞梭织机大幅提升布料产量。织布坊效率 +20%，成衣作坊效率 +15%。",cost:{science:13500},epoch:5,effects:{buildings:{loom_house:.14,tailor_workshop:.1}}},{id:"assembly_line",name:"流水线生产",desc:"解锁纺织厂和服装工厂，标准化分工使产量大幅提升。纺织厂效率 +25%，服装工厂效率 +20%。",cost:{science:26100},epoch:6,effects:{buildings:{textile_mill:.18,garment_factory:.14}}},{id:"hydraulic_sawing",name:"水力锯切",desc:"解锁锯木厂和伐木场升级，水轮驱动的圆锯效率远超手工。锯木厂效率 +25%，伐木场效率 +15%。",cost:{science:12600},epoch:5,effects:{buildings:{sawmill:.18,lumber_camp:.1}}},{id:"mass_production",name:"大规模生产",desc:"解锁木材加工厂和家具工坊，标准化零件实现批量生产。木材加工厂效率 +20%，家具工坊效率 +25%。",cost:{science:25200},epoch:6,effects:{buildings:{lumber_mill:.14,furniture_workshop:.18}}},{id:"advanced_metallurgy",name:"先进冶金",desc:"解锁竖井矿场，改良熔炉与合金配方提升工具质量。铁器铺效率 +20%，青铜铸坊效率 +15%。",cost:{science:7700},epoch:4,effects:{buildings:{iron_tool_workshop:.14,bronze_foundry:.1}}},{id:"bessemer_process",name:"贝塞麦炼钢法",desc:"解锁炼钢厂和冶金工坊，吹入空气快速去碳，钢铁产量剧增。炼钢厂效率 +30%，冶金工坊效率 +25%。",cost:{science:27900},epoch:6,effects:{buildings:{steel_foundry:.21,metallurgy_workshop:.18}}},{id:"industrial_ceramics",name:"工业陶瓷",desc:"解锁砖窯升级，环形窑与传送带实现连续烧制。砖窯效率 +25%。",cost:{science:11700},epoch:5,effects:{buildings:{brickworks:.18}}},{id:"standardized_construction",name:"标准化建筑",desc:"解锁建材厂，预制构件加速建设、降低成本。建材厂效率 +25%，人口上限 +5%。",cost:{science:24300},epoch:6,effects:{buildings:{building_materials_plant:.18},maxPop:.05}},{id:"food_preservation",name:"食品保鲜",desc:"解锁罐头厂，密封罐装技术延长食品保质期。",cost:{science:22500},epoch:6,effects:{buildings:{culinary_kitchen:.18}}},{id:"distillation",name:"蒸馏技术",desc:"解锁蒸馏酒厂，分离提纯出高度烈酒。",cost:{science:14400},epoch:5,effects:{buildings:{brewery:.21}}},{id:"wood_pulp_process",name:"木浆造纸",desc:"解锁造纸厂，木材纤维取代手工纸浆，产量倍增。",cost:{science:13050},epoch:5,effects:{buildings:{reed_works:.21}}},{id:"mass_media",name:"大众传媒",desc:"解锁印刷所和出版社，报纸杂志覆盖全民，舆论力量崛起。印刷所效率 +30%，出版社效率 +20%。",cost:{science:24750},epoch:6,effects:{buildings:{printing_house:.21,publishing_house:.14}}},{id:"deep_shaft_mining",name:"深井采矿",desc:"解锁工业矿场，蒸汽泵排水、铁轨运矿，开采深层矿脉。",cost:{science:23400},epoch:6,effects:{buildings:{mine:.18,coal_mine:.14}}},{id:"agricultural_machinery",name:"农业机械",desc:"解锁机械化农场，蒸汽拖拉机与收割机解放大量人力。",cost:{science:25200},epoch:6,effects:{buildings:{farm:.18,large_estate:.21}}},{id:"steam_logging",name:"蒸汽伐木",desc:"解锁伐木公司，蒸汽锯与窄轨铁路运输原木。",cost:{science:22500},epoch:6,effects:{buildings:{lumber_camp:.21}}},{id:"higher_education",name:"高等教育",desc:"解锁大学，系统化培养专业人才。",cost:{science:15750},epoch:5,effects:{buildings:{library:.14,navigator_school:.14}}},{id:"grand_arts",name:"高雅艺术",desc:"解锁歌剧院，戏剧与音乐的殿堂。",cost:{science:17100},epoch:5,effects:{buildings:{amphitheater:.18,church:.1}}},{id:"urban_architecture",name:"城市建筑学",desc:"解锁公寓楼，多层建筑容纳更多城市人口。人口上限 +6%。",cost:{science:26100},epoch:6,effects:{buildings:{house:.14},maxPop:.06}},{id:"financial_capitalism",name:"金融资本主义",desc:"解锁证券交易所，股票与债券调配社会资本。贸易港效率 +20%，铁路枢纽效率 +15%，财政收入 +8%。",cost:{science:29250},epoch:6,effects:{buildings:{trade_port:.14,rail_depot:.1},incomePercent:.08}}],or=(e,t)=>{const o={0:{light:["militia","slinger"],medium:["militia","slinger"],heavy:["militia","slinger"]},1:{light:["militia","slinger","spearman"],medium:["spearman","archer","chariot"],heavy:["spearman","archer","chariot"]},2:{light:["spearman","archer","light_cavalry"],medium:["hoplite","composite_archer","light_cavalry"],heavy:["hoplite","composite_archer","light_cavalry","battering_ram"]},3:{light:["heavy_infantry","crossbowman","knight"],medium:["heavy_infantry","crossbowman","knight","trebuchet"],heavy:["heavy_infantry","crossbowman","knight","trebuchet"]},4:{light:["pikeman","arquebus","cuirassier"],medium:["pikeman","arquebus","cuirassier","bombard"],heavy:["pikeman","arquebus","cuirassier","bombard"]},5:{light:["musketeer","dragoon"],medium:["musketeer","rifleman","dragoon","cannon"],heavy:["musketeer","rifleman","dragoon","cannon"]},6:{light:["line_infantry","lancer"],medium:["line_infantry","gatling","lancer","artillery"],heavy:["line_infantry","gatling","lancer","artillery"]}},i=o[Math.min(e,6)]||o[0];return i[t]||i.medium},ir={treaties:{peace_treaty:{minEra:1,name:"和平条约"},non_aggression:{minEra:2,name:"互不侵犯条约"},trade_agreement:{minEra:2,name:"贸易协定"},free_trade:{minEra:4,name:"自由贸易协定"},investment_pact:{minEra:4,name:"投资协议"},open_market:{minEra:2,name:"开放市场"},academic_exchange:{minEra:3,name:"学术交流"},defensive_pact:{minEra:3,name:"共同防御"}},sovereignty:{vassal:{minEra:2,name:"附庸国"}},organizations:{military_alliance:{minEra:3,name:"军事联盟"},economic_bloc:{minEra:5,name:"经济共同体"}},economy:{merchant_stationing:{minEra:3,name:"商人驻留"},overseas_building:{minEra:4,name:"海外建筑"},price_convergence:{minEra:6,name:"市场价格联动"},multi_round_negotiation:{minEra:2,name:"多轮谈判"}},migration:{economic_migration:{minEra:3,name:"经济移民"},war_refugees:{minEra:2,name:"战争难民"},political_exile:{minEra:4,name:"政治流亡"}}},ac={peace_treaty:"和平条约",non_aggression:"互不侵犯",trade_agreement:"贸易协定",free_trade:"自由贸易",investment_pact:"投资协议",open_market:"开放市场",academic_exchange:"学术交流",defensive_pact:"共同防御",military_alliance:"军事同盟",economic_bloc:"经济共同体"},rc=["peace_treaty","non_aggression"],wa={military_alliance:{mutualDefense:!0,relationBonus:5,militaryBonus:.1},economic_bloc:{tariffDiscount:.3,relationBonus:5,tradeEfficiency:.2}},sc={standard:{id:"standard",name:"正常雇佣",description:"按当地生活成本支付正常工资",wageMultiplier:1,unrestPerDay:0,relationPerDay:0,independenceGrowthMod:1},exploitation:{id:"exploitation",name:"压榨剥削",description:"低于市场价的工资，劳动条件恶劣",wageMultiplier:.6,unrestPerDay:.05,relationPerDay:-.5,independenceGrowthMod:1.2},slavery:{id:"slavery",name:"强制劳动",description:"几乎无偿的强制劳动，极高独立风险",wageMultiplier:.3,unrestPerDay:.15,relationPerDay:-2,independenceGrowthMod:1.8,minEra:2}},nr={free:{id:"free",name:"自由贸易",description:"附庸可与任何国家贸易",playerPriceMod:0,tariffDiscount:0,tributeMod:.8,independenceGrowthMod:.8},preferential:{id:"preferential",name:"优惠准入",description:"玩家商人享有优先贸易权",playerPriceMod:-.1,tariffDiscount:.5,tributeMod:1,independenceGrowthMod:1},exclusive:{id:"exclusive",name:"排他贸易",description:"附庸只能与玩家贸易",playerPriceMod:-.25,tariffDiscount:1,tributeMod:1.2,independenceGrowthMod:1.3},dumping:{id:"dumping",name:"倾销市场",description:"强制附庸购买玩家过剩商品",playerPriceMod:.2,tariffDiscount:1,tributeMod:1,independenceGrowthMod:1.4,forcedExports:!0},looting:{id:"looting",name:"资源掠夺",description:"以极低价格获取附庸资源",playerPriceMod:-.4,tariffDiscount:1,tributeMod:1.5,independenceGrowthMod:1.6,forcedImports:!0,minEra:3}},cc=e=>{var t,o;return(o=(t=sc[e])==null?void 0:t.wageMultiplier)!=null?o:1},lc=e=>e>=6?{relationPenalty:50,cooldownDays:365}:e>=4?{relationPenalty:35,cooldownDays:180}:{relationPenalty:20,cooldownDays:90},Ao=(e,t,o)=>{var r;const i=(r=ir[e])==null?void 0:r[t];return i?o>=i.minEra:!1},ar={vassal:{name:"附庸国",minEra:2,minRelation:50,autonomy:80,tributeRate:.1,exploitationFactor:1,tariffDiscount:.5,description:"接受宗主国保护与指导的国家。具体权利义务由政策决定。",canFormAlliance:!0,canSignTreaties:!0,canTrade:!0,militaryObligation:"pay_to_call",economicPrivileges:{investmentCostDiscount:.1,profitTaxExemption:.1,tradePolicyLocked:!1}},protectorate:{name:"附庸国",minEra:2,autonomy:80,minRelation:50},tributary:{name:"附庸国",minEra:2,autonomy:60,minRelation:50},puppet:{name:"附庸国",minEra:2,autonomy:40,minRelation:50},colony:{name:"附庸国",minEra:2,autonomy:20,minRelation:50}},kn={farm:[{name:"灌溉田",cost:{wood:50,stone:20,tools:5,silver:300},input:{tools:.04,wood:.06},output:{food:6.24},jobs:{peasant:3}},{name:"精耕田",cost:{plank:80,brick:40,tools:15,silver:800},input:{tools:.08,wood:.1},output:{food:10.8},jobs:{peasant:4}}],lumber_camp:[{name:"大伐木场",cost:{wood:80,stone:30,tools:10,silver:250},input:{tools:.05,food:.15},output:{wood:4.992},jobs:{lumberjack:3}},{name:"林场",cost:{plank:60,brick:30,tools:20,silver:600},input:{tools:.1},output:{wood:8.64,food:.15},jobs:{lumberjack:4}}],quarry:[{name:"深坑采石场",cost:{wood:80,stone:50,tools:15,silver:300},input:{tools:.06,wood:.15,food:.15},output:{stone:3.9},jobs:{miner:3}},{name:"大采石场",cost:{plank:80,stone:100,tools:30,silver:700},input:{tools:.12,wood:.25,food:.25},output:{stone:6.75,copper:.02},jobs:{miner:4}}],loom_house:[{name:"织布坊",cost:{wood:80,stone:40,tools:10,silver:250},input:{tools:.02},output:{cloth:2.5},jobs:{worker:3}},{name:"大织布坊",cost:{plank:60,brick:40,tools:20,silver:600},input:{tools:.04,dye:.03},output:{cloth:4.32,culture:.05},jobs:{worker:4}}],brickworks:[{name:"改良砖窑",cost:{stone:80,wood:40,tools:15,silver:300},input:{stone:1,wood:.35,tools:.02},output:{brick:3.12},jobs:{worker:3}},{name:"大砖窑",cost:{stone:120,brick:80,tools:30,silver:700},input:{stone:1.5,wood:.5,tools:.04},output:{brick:5.4,tools:.02},jobs:{worker:4}}],stone_tool_workshop:[{name:"工匠铺",cost:{stone:50,wood:50,silver:200},input:{wood:1.65,stone:1.35},output:{tools:.975},jobs:{artisan:3}},{name:"大工匠铺",cost:{brick:40,plank:40,silver:500},input:{wood:2.25,stone:1.8},output:{tools:1.35},jobs:{artisan:3}}],trading_post:[{name:"商铺",cost:{wood:100,stone:40,silver:400},input:{tools:.01},output:{food:5.2,silver:2.08},jobs:{merchant:2}},{name:"商会",cost:{plank:80,brick:60,silver:900},input:{tools:.02,papyrus:.01},output:{food:9,silver:3.6,spice:.02},jobs:{merchant:3}}],library:[{name:"学堂",cost:{stone:150,plank:40,papyrus:30,brick:40,silver:600,science:80},input:{papyrus:.08},output:{science:1.3867},jobs:{scribe:4}},{name:"书院",cost:{brick:120,plank:60,papyrus:80,silver:1400,science:200},input:{papyrus:.15,science:.15},output:{science:2.4,culture:.12},jobs:{scribe:5}}],copper_mine:[{name:"深铜矿",cost:{wood:120,tools:20,silver:350},input:{tools:.05,wood:.2,food:.2},output:{copper:.8667},jobs:{miner:4}},{name:"大铜矿",cost:{plank:80,tools:40,silver:800},input:{tools:.1,wood:.35,food:.35},output:{copper:1.5,stone:.15},jobs:{miner:5}}],dye_works:[{name:"大染坊",cost:{wood:60,stone:25,tools:10,silver:250},input:{food:.6,tools:.02},output:{dye:1.17},jobs:{worker:3}},{name:"染色工坊",cost:{plank:50,brick:30,tools:20,silver:600},input:{food:.9,tools:.04,cloth:.05},output:{dye:2.025,culture:.05},jobs:{worker:4}}],sawmill:[{name:"水力锯木坊",cost:{wood:120,stone:40,tools:15,silver:350},input:{wood:1.4,tools:.03},output:{plank:4.511},jobs:{worker:4}},{name:"大锯木坊",cost:{plank:80,brick:50,tools:30,silver:800},input:{wood:2,tools:.06,cloth:.05},output:{plank:7.8075,furniture:.05},jobs:{worker:5}}],bronze_foundry:[{name:"改良铸坊",cost:{stone:60,copper:25,silver:300},input:{copper:.75,wood:.45,tools:.015},output:{tools:1.95},jobs:{worker:3,artisan:1}},{name:"大铸坊",cost:{brick:50,copper:40,silver:700},input:{copper:1.05,wood:.675,tools:.03},output:{tools:2.7},jobs:{worker:3,artisan:1}}],amphitheater:[{name:"大剧场",cost:{stone:120,brick:40,silver:400},input:{fine_clothes:.06},output:{culture:6.5,silver:.8},jobs:{cleric:2}},{name:"宏伟剧场",cost:{brick:80,furniture:20,silver:900},input:{fine_clothes:.08,ale:.03},output:{culture:9,silver:1.5},jobs:{cleric:2}}],reed_works:[{name:"改良造纸坊",cost:{wood:60,tools:10,silver:220},input:{tools:.01},output:{papyrus:1.17},jobs:{worker:3}},{name:"大造纸坊",cost:{plank:50,tools:20,silver:500},input:{tools:.02},output:{papyrus:2.025,science:.05},jobs:{worker:4}}],culinary_kitchen:[{name:"精致厨房",cost:{brick:40,tools:15,cloth:8,silver:350},input:{tools:.08,food:1.2},output:{delicacies:2.6},jobs:{artisan:3,peasant:1}},{name:"御膳房",cost:{brick:60,furniture:15,delicacies:20,silver:800},input:{tools:.12,food:1.8,spice:.06},output:{delicacies:4.5,culture:.08},jobs:{artisan:3,peasant:2}}],brewery:[{name:"大酒坊",cost:{brick:30,tools:12,cloth:6,silver:280},input:{food:1,wood:.15,tools:.01},output:{ale:2.34},jobs:{worker:3}},{name:"酿酒工坊",cost:{brick:50,tools:25,dye:10,ale:15,silver:650},input:{food:1.5,wood:.25,tools:.02,spice:.03},output:{ale:4.05,culture:.05},jobs:{worker:4}}],furniture_workshop:[{name:"精工家具坊",cost:{plank:80,tools:20,silver:400},input:{tools:.08,plank:1,cloth:.25},output:{furniture:2.08},jobs:{artisan:4}},{name:"大家具坊",cost:{plank:120,furniture:15,silver:900},input:{tools:.12,plank:1.5,cloth:.35},output:{furniture:3.6},jobs:{artisan:5}}],tailor_workshop:[{name:"高级成衣坊",cost:{plank:50,tools:15,silver:350},input:{tools:.035,cloth:.85,dye:.17},output:{fine_clothes:1.04,culture:.6},jobs:{artisan:3}},{name:"御用成衣坊",cost:{brick:40,fine_clothes:10,silver:800},input:{tools:.05,cloth:1.3,dye:.25},output:{fine_clothes:1.8,culture:.8},jobs:{artisan:4}}],mine:[{name:"深井铁矿",cost:{plank:80,tools:25,silver:400},input:{tools:.08,wood:.2,food:.3},output:{iron:1.65},jobs:{miner:7,landowner:1}},{name:"大铁矿",cost:{brick:60,tools:40,silver:900},input:{tools:.15,wood:.35,food:.45},output:{iron:2.86,coal:.05},jobs:{miner:9,landowner:1}}],iron_tool_workshop:[{name:"精铁工坊",cost:{brick:60,iron:30,silver:400},input:{wood:.6,iron:.975,tools:.015},output:{tools:2.925},jobs:{worker:3,artisan:1}},{name:"大铁匠铺",cost:{brick:100,iron:50,silver:900},input:{wood:.9,iron:1.5,tools:.03},output:{tools:4.05},jobs:{worker:3,artisan:1}}],large_estate:[{name:"繁荣庄园",cost:{plank:60,tools:20,silver:400},input:{tools:.1,wood:.15},output:{food:23.4},jobs:{serf:8,landowner:1}},{name:"领主庄园",cost:{brick:50,furniture:15,silver:900},input:{tools:.18,wood:.25,cloth:.05},output:{food:40.5,cloth:.1,ale:.03},jobs:{serf:9,landowner:1}}],church:[{name:"大教堂",cost:{brick:80,furniture:25,silver:500},input:{furniture:.05,fine_clothes:.04},output:{culture:3.8,silver:1.2},jobs:{cleric:3}},{name:"主教座堂",cost:{brick:150,furniture:40,silver:1200},input:{furniture:.06,fine_clothes:.05,papyrus:.02},output:{culture:5.5,silver:2,science:.15},jobs:{cleric:4}}],monastery_cellar:[{name:"修道院大酒窖",cost:{stone:80,tools:20,silver:400},input:{food:2,wood:.35},output:{ale:2.6,culture:1.4},jobs:{cleric:1,worker:3}},{name:"酿酒修道院",cost:{brick:100,furniture:20,silver:900},input:{food:2.7,wood:.5},output:{ale:4.5,culture:2,science:.08},jobs:{cleric:2,worker:2}}],wool_workshop:[{name:"大纺织工场",cost:{plank:80,tools:20,silver:380},input:{food:.7,tools:.04},output:{cloth:4.16,fine_clothes:.26},jobs:{serf:4,worker:3}},{name:"领主纺织工场",cost:{brick:60,tools:35,silver:850},input:{food:1,tools:.06,dye:.05},output:{cloth:7.2,fine_clothes:.45,culture:.05},jobs:{serf:5,worker:3}}],stone_workshop:[{name:"大采石工场",cost:{plank:60,iron:25,silver:350},input:{tools:.08,food:.15},output:{stone:4.55},jobs:{miner:4,worker:1}},{name:"皇家采石场",cost:{brick:80,iron:40,silver:800},input:{tools:.12,food:.25},output:{stone:7.875,brick:.15},jobs:{miner:5,worker:1}}],hardwood_camp:[{name:"特用林场",cost:{plank:80,tools:30,silver:450},input:{tools:.1,food:.2},output:{wood:6.24},jobs:{lumberjack:5,worker:1}},{name:"皇家御林",cost:{brick:80,tools:50,silver:900},input:{tools:.15,food:.35},output:{wood:10.8,food:.2},jobs:{lumberjack:6,worker:1}}],dockyard:[{name:"大船坞",cost:{plank:120,tools:30,silver:500},input:{wood:.4,tools:.02},output:{spice:.9},jobs:{navigator:2,worker:2,merchant:1}},{name:"皇家船厂",cost:{plank:200,iron:40,silver:1100},input:{wood:.6,tools:.03,cloth:.06},output:{spice:1.55,silver:.25,science:.05},jobs:{navigator:3,worker:2,merchant:1}}],navigator_school:[{name:"航海学府",cost:{plank:80,papyrus:40,silver:400},input:{papyrus:.05},output:{science:.78,culture:1.2},jobs:{navigator:3,scribe:1,official:1}},{name:"皇家航海学院",cost:{brick:60,papyrus:80,silver:900},input:{papyrus:.08,coffee:.03},output:{science:1.35,culture:1.8},jobs:{navigator:4,scribe:1,official:1}}],trade_port:[{name:"繁荣港口",cost:{plank:150,spice:30,silver:600},input:{spice:.25},output:{food:2.6,silver:.15},jobs:{merchant:4}},{name:"贸易枢纽",cost:{brick:120,spice:60,silver:1300},input:{spice:.35,cloth:.06},output:{food:4.5,silver:.4},jobs:{merchant:5}}],shaft_mine:[{name:"通风矿井",cost:{brick:120,tools:45,silver:650},input:{tools:.14,wood:.3,science:.065},output:{iron:1.872,copper:1.248},jobs:{miner:6,engineer:1}},{name:"蒸汽矿井",cost:{brick:200,steel:50,tools:80,silver:1200},input:{tools:.2,coal:.15,wood:.4,science:.11},output:{iron:3.24,copper:2.16,coal:.1},jobs:{miner:7,engineer:1}}],dye_workshop:[{name:"大印染工坊",cost:{brick:80,tools:25,silver:480},input:{food:.9,cloth:.5,spice:.06,science:.026},output:{dye:2.34,fine_clothes:.585},jobs:{artisan:3,worker:2}},{name:"皇家印染工坊",cost:{brick:140,tools:45,silver:1050},input:{food:1.2,cloth:.7,spice:.08,iron:.02,science:.045},output:{dye:4.05,fine_clothes:1.0125,culture:.08},jobs:{artisan:4,worker:2}}],coffee_plantation:[{name:"大种植园",cost:{wood:300,spice:40,silver:800},input:{tools:.03},output:{coffee:.52},jobs:{serf:6,merchant:1}},{name:"种植园庄园",cost:{plank:200,tools:60,silver:1800},input:{tools:.06},output:{coffee:.9,spice:.02,food:.5},jobs:{serf:8,merchant:1}}],coffee_house:[{name:"文人咖啡馆",cost:{plank:80,coffee:25,silver:400},input:{coffee:.2,delicacies:.08},output:{culture:4.8,science:1.733,silver:.6},jobs:{merchant:1,scribe:2}},{name:"沙龙",cost:{brick:60,furniture:25,silver:900},input:{coffee:.3,delicacies:.1},output:{culture:7,science:3,silver:1.2},jobs:{merchant:1,scribe:3}}],printing_house:[{name:"大印刷所",cost:{brick:120,papyrus:40,silver:500,science:100},input:{papyrus:.48,coffee:.09,science:.2},output:{science:3.12,culture:2.4},jobs:{artisan:5,scribe:3,capitalist:1}},{name:"出版社",cost:{brick:200,papyrus:80,silver:1100,science:250},input:{papyrus:.75,coffee:.15,science:.35},output:{science:5.4,culture:3.6},jobs:{artisan:5,scribe:3,capitalist:1}}],textile_mill:[{name:"大纺织厂",cost:{brick:120,tools:40,silver:600},input:{food:2.6,dye:.975,tools:.04},output:{cloth:16.25,fine_clothes:1.95},jobs:{worker:15,artisan:4,capitalist:1}},{name:"纺织工场",cost:{brick:200,tools:60,silver:1300},input:{food:4.5,dye:1.6875,tools:.0692,coffee:.0533},output:{cloth:28.125,fine_clothes:3.375},jobs:{worker:16,artisan:4,capitalist:1}}],lumber_mill:[{name:"大木材厂",cost:{brick:100,tools:35,silver:500},input:{wood:8.3572,tools:.024},output:{plank:22.2858},jobs:{worker:10,artisan:1,capitalist:1}},{name:"木业公司",cost:{brick:180,tools:50,silver:1100},input:{wood:14.4644,tools:.048},output:{plank:38.5715,furniture:.144},jobs:{worker:11,artisan:1,capitalist:1}}],building_materials_plant:[{name:"大建材厂",cost:{brick:120,tools:35,silver:550},input:{stone:5.85,wood:1.755,coal:.585},output:{brick:16.0875},jobs:{worker:14,engineer:1,capitalist:1}},{name:"建材公司",cost:{brick:200,tools:50,silver:1200},input:{stone:10.125,wood:3.0375,coal:1.0125},output:{brick:27.84375},jobs:{worker:15,engineer:1,capitalist:1}}],distillery:[{name:"大蒸馏厂",cost:{brick:150,copper:50,silver:600},input:{food:5.85,coal:.585},output:{ale:10.2375,silver:2.34},jobs:{worker:12,artisan:2,capitalist:1}},{name:"酒业公司",cost:{brick:250,copper:80,silver:1300},input:{food:10.125,coal:1.0125},output:{ale:17.71875,silver:4.05,culture:.12},jobs:{worker:13,artisan:2,capitalist:1}}],paper_mill:[{name:"大造纸厂",cost:{brick:120,tools:35,silver:500},input:{wood:3.9,coal:.39},output:{papyrus:6.5},jobs:{worker:10,engineer:1,capitalist:1}},{name:"造纸公司",cost:{brick:200,tools:50,silver:1100},input:{wood:6.75,coal:.675},output:{papyrus:11.25,tools:.06},jobs:{worker:11,engineer:1,capitalist:1}}],university:[{name:"著名学府",cost:{brick:250,papyrus:60,silver:750,science:150},input:{papyrus:.3125,coffee:.1875,delicacies:.125,science:.4},output:{science:4.875,culture:1.3},jobs:{scribe:5,engineer:2,official:2}},{name:"皇家学院",cost:{brick:400,papyrus:120,silver:1700,science:400},input:{papyrus:.4375,coffee:.25,delicacies:.15,science:.7},output:{science:8.4375,culture:2.25},jobs:{scribe:6,engineer:2,official:2}}],opera_house:[{name:"大歌剧院",cost:{brick:250,furniture:50,silver:700},input:{fine_clothes:.25,delicacies:.15},output:{culture:5.6875,silver:1.625},jobs:{cleric:5,artisan:2,merchant:1}},{name:"皇家歌剧院",cost:{brick:400,furniture:80,silver:1500},input:{fine_clothes:.375,delicacies:.225,coffee:.1},output:{culture:9.8438,silver:2.8125,science:.1875},jobs:{cleric:6,artisan:2,merchant:1}}],coal_mine:[{name:"深煤矿",cost:{plank:150,tools:40,silver:500},input:{tools:.35,wood:.5,food:.8},output:{coal:5},jobs:{miner:13,capitalist:1}},{name:"大煤矿",cost:{brick:100,tools:60,silver:1100},input:{tools:.55,wood:.8,food:1.2},output:{coal:8,iron:.2},jobs:{miner:9,capitalist:1}}],steel_foundry:[{name:"大炼钢厂",cost:{brick:200,iron:120,silver:750,science:150},input:{iron:1.2,coal:1.2,science:.3},output:{steel:1.2},jobs:{engineer:5,worker:7,capitalist:1}},{name:"钢铁联合厂",cost:{steel:100,iron:200,silver:1700,science:350},input:{iron:2.4,coal:2.4,science:.6},output:{steel:2.4,tools:.2},jobs:{engineer:5,worker:8,capitalist:1}}],factory:[{name:"大工厂",cost:{brick:300,steel:120,silver:850,science:200},input:{steel:3,coal:3,science:.75},output:{tools:22},jobs:{worker:20,engineer:4,capitalist:1}},{name:"制造中心",cost:{steel:200,tools:80,silver:1900,science:450},input:{steel:4.2,coal:4.2,science:1},output:{tools:32,steel:.1,science:.2},jobs:{worker:21,engineer:4,capitalist:1}}],industrial_mine:[{name:"大工业矿场",cost:{steel:150,tools:60,silver:850},input:{tools:.33995,coal:.68,wood:.4,food:.8},output:{iron:3.85,copper:1.245},jobs:{miner:17,engineer:2,capitalist:1}},{name:"矿业公司",cost:{steel:250,tools:100,silver:1900},input:{tools:.588375,coal:1.125,wood:.6,food:1},output:{iron:6.663075,copper:2.153925},jobs:{miner:18,engineer:2,capitalist:1}}],mechanized_farm:[{name:"大机械农场",cost:{steel:100,tools:50,silver:750},input:{tools:.2275,coal:.455,iron:.06},output:{food:50.05},jobs:{peasant:8,worker:8,engineer:1,capitalist:1}},{name:"工业农场",cost:{steel:170,tools:80,silver:1700},input:{tools:.39375,coal:.7875,iron:.1,dye:.03},output:{food:86.625,cloth:.2},jobs:{peasant:9,worker:8,engineer:1,capitalist:1}}],logging_company:[{name:"大伐木公司",cost:{steel:60,tools:40,silver:650},input:{tools:.1563,coal:.325,food:.4},output:{wood:26},jobs:{lumberjack:11,worker:7,engineer:1,capitalist:1}},{name:"林业公司",cost:{steel:120,tools:60,silver:1500},input:{tools:.270825,coal:.5625,food:.55},output:{wood:45},jobs:{lumberjack:12,worker:7,engineer:1,capitalist:1}}],prefab_factory:[{name:"大预制厂",cost:{steel:150,tools:60,silver:850},input:{brick:3.9,steel:.52,stone:2.6,coal:1.04},output:{brick:28.6},jobs:{worker:20,engineer:4,capitalist:1}},{name:"建筑材料公司",cost:{steel:250,tools:100,silver:1900},input:{brick:6.75,steel:.9,stone:4.5,coal:1.8},output:{brick:49.5},jobs:{worker:21,engineer:4,capitalist:1}}],cannery:[{name:"大罐头厂",cost:{steel:60,tools:40,silver:650},input:{food:7.3125,iron:.8775,coal:.73125},output:{delicacies:10.2375},jobs:{worker:17,artisan:4,engineer:1,capitalist:1}},{name:"食品公司",cost:{steel:120,tools:60,silver:1500},input:{food:12.65625,iron:1.51875,coal:1.265625},output:{delicacies:17.71875,ale:.3},jobs:{worker:18,artisan:5,engineer:1,capitalist:1}}],garment_factory:[{name:"大服装厂",cost:{steel:100,tools:60,silver:850},input:{cloth:4.875,dye:.975,coal:.585},output:{fine_clothes:5.46,culture:.585},jobs:{worker:18,artisan:4,engineer:1,capitalist:1}},{name:"服装公司",cost:{steel:170,tools:100,silver:1900},input:{cloth:8.4375,dye:1.6875,coal:1.0125},output:{fine_clothes:9.45,culture:1.0125,cloth:.5},jobs:{worker:20,artisan:4,engineer:1,capitalist:1}}],furniture_factory:[{name:"大家具厂",cost:{steel:80,tools:50,silver:750},input:{plank:7.3125,cloth:2.34,coal:.73125},output:{furniture:10.2375,culture:.585},jobs:{worker:17,artisan:4,engineer:1,capitalist:1}},{name:"家具公司",cost:{steel:150,tools:80,silver:1700},input:{plank:12.65625,cloth:4.05,coal:1.265625},output:{furniture:17.71875,culture:1.0125,plank:.4},jobs:{worker:18,artisan:4,engineer:1,capitalist:1}}],market:[{name:"大市场",cost:{brick:300,papyrus:60,cloth:15,silver:1e3},input:{papyrus:.12,coffee:.075},output:{food:3.9,silver:.45},jobs:{merchant:4,scribe:1}},{name:"交易所",cost:{steel:200,papyrus:120,delicacies:30,silver:2200},input:{papyrus:.18,coffee:.12},output:{food:6.75,silver:.75,culture:.225},jobs:{merchant:5,scribe:1}}],rail_depot:[{name:"大铁路站",cost:{steel:120,coal:80,silver:850},input:{coal:.375,ale:.1,delicacies:.05,science:.195},output:{silver:3.51,maxPop:15},jobs:{engineer:4,merchant:3,capitalist:1}},{name:"铁路枢纽",cost:{steel:220,coal:150,silver:1900},input:{coal:.5625,ale:.15,delicacies:.075,science:.3375},output:{silver:6.075,maxPop:16,food:.625,culture:.125},jobs:{engineer:5,merchant:4,capitalist:1}}],metallurgy_workshop:[{name:"精密冶金坊",cost:{brick:120,iron:60,silver:600},input:{iron:1.2,copper:.25,wood:.6},output:{tools:3.9},jobs:{worker:4,artisan:2,engineer:1}},{name:"大冶金坊",cost:{brick:200,iron:100,silver:1300},input:{iron:1.8,copper:.4,wood:.9,coal:.08},output:{tools:6.75},jobs:{worker:5,artisan:2,engineer:1}}]},Nt=(e,t=0)=>{if(!t||t===0)return{name:e.name,input:e.input||{},output:e.output||{},jobs:e.jobs||{},owner:e.owner||null};const o=kn[e.id];if(!o||!o[t-1])return{name:e.name,input:e.input||{},output:e.output||{},jobs:e.jobs||{},owner:e.owner||null};const i=o[t-1];return{name:i.name||e.name,input:i.input||e.input||{},output:i.output||e.output||{},jobs:i.jobs||e.jobs||{},owner:i.owner||e.owner||null}},Dn=e=>{const t=kn[e];return t?t.length:0},Wn=(e,t,o=0,i=1.15)=>{const r=kn[e];if(!r||!r[t-1])return null;const a=r[t-1].cost||{};if(o<=0)return a;const c=1+Math.max(0,i-1)*Math.pow(o,.9),f={};for(const[p,d]of Object.entries(a))f[p]=Math.ceil(d*c);return f},rr={demanding:{high:120,standard:80,low:50},offering:{high:60,standard:40,low:25}},xa=2e6;function sr(e,t=null){const o=t?Math.min(e||0,t||0):e||0,i=Math.floor(o*.02);return Math.max(30,Math.min(1e4,i))}function cr(e,t,o,i,r="demanding",a=0){const s=Math.abs(e||0),u=t||0,c=o||0,f=i||0,p=a||0,d=rr[r]||rr.demanding,M=s*d.high,h=u*80,y=c*25,w=p*.3,m=Math.ceil(M+h+y+w),E=Math.ceil(s*d.standard+u*50+c*18+p*.2),v=Math.ceil(s*d.low+u*35+c*12+p*.1),g=Math.floor(f*.18),C=Math.floor(f*.12),R=Math.floor(f*.06),k=f*1,D=Math.max(5e4,k);let P=xa;if(p>0&&r==="demanding"){const S=1+s/100;P=p*S,P=Math.max(p*.5,P)}const T=Math.min(xa,D,P);return{high:Math.max(600,g,Math.min(T,m)),standard:Math.max(400,C,Math.min(T,E)),low:Math.max(200,R,Math.min(T,v)),breakdown:{scoreComponent:M,lossComponent:h,durationComponent:y,expenseComponent:w,rawHigh:m,rawStandard:E,rawLow:v},caps:{hardCap:xa,wealthCap:D,armyExpenseCap:P,effectiveCap:T}}}function uc(e,t,o,i){return cr(e,t,o,i,"offering").standard}function fc(e,t,o=1e4){return cr(e,0,t,o,"offering").standard}const Ro={militia:{id:"militia",name:"民兵",desc:"由农民临时组成的武装力量，战斗力较弱但成本低廉。",epoch:0,icon:"Users",category:"infantry",attack:6,defense:4,speed:3,range:1,recruitCost:{food:125,wood:60},maintenanceCost:{food:1.75,silver:.6},trainingTime:2,populationCost:1,abilities:["快速征召"],counters:{cavalry:1.2,siege:1.3},weakAgainst:["archer"],obsoleteAfterEpochs:2},slinger:{id:"slinger",name:"投石兵",desc:"使用投石索的远程单位，对轻甲单位有效。",epoch:0,icon:"Circle",category:"archer",attack:6,defense:2,speed:3,range:3,recruitCost:{food:150,wood:75,stone:25},maintenanceCost:{food:2,silver:.75,stone:.5},trainingTime:3,populationCost:1,abilities:["远程攻击"],counters:{infantry:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},spearman:{id:"spearman",name:"长矛兵",desc:"装备青铜长矛的步兵，对骑兵有显著克制效果。",epoch:1,icon:"Sword",category:"infantry",attack:12,defense:9,speed:3,range:1,recruitCost:{food:275,wood:175,copper:60},maintenanceCost:{food:2.75,silver:1.75,copper:.25},trainingTime:4,populationCost:1,abilities:["反骑兵"],counters:{cavalry:1.8,siege:1.2},weakAgainst:["archer"],obsoleteAfterEpochs:2},archer:{id:"archer",name:"弓箭手",desc:"装备复合弓的远程单位，克制步兵。",epoch:1,icon:"Target",category:"archer",attack:14,defense:6,speed:4,range:4,recruitCost:{food:325,wood:225,silver:125},maintenanceCost:{food:3.25,silver:2.25,wood:1},trainingTime:5,populationCost:1,abilities:["远程攻击","高机动"],counters:{infantry:1.5,siege:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},chariot:{id:"chariot",name:"战车",desc:"青铜时代的机动战力，由马匹牵引的战车。",epoch:1,icon:"Truck",category:"cavalry",attack:15,defense:8,speed:6,range:1,recruitCost:{food:500,wood:300,copper:150,silver:200},maintenanceCost:{food:6,silver:3.5,wood:1.5},trainingTime:6,populationCost:1,abilities:["冲锋","机动"],counters:{archer:1.6},weakAgainst:["infantry"],obsoleteAfterEpochs:2},hoplite:{id:"hoplite",name:"重装步兵",desc:"装备圆盾和长矛的古典精锐步兵，方阵作战威力强大。",epoch:2,icon:"Shield",category:"infantry",attack:16,defense:14,speed:2,range:1,recruitCost:{food:500,copper:200,iron:100,silver:250},maintenanceCost:{food:3.75,silver:2.75,iron:.4},trainingTime:6,populationCost:1,abilities:["方阵","坚守"],counters:{cavalry:1.7,siege:1.3},weakAgainst:["archer"],obsoleteAfterEpochs:2},composite_archer:{id:"composite_archer",name:"复合弓手",desc:"使用复合弓的精锐射手，穿透力更强。",epoch:2,icon:"Target",category:"archer",attack:18,defense:7,speed:4,range:5,recruitCost:{food:425,wood:250,copper:125,silver:225},maintenanceCost:{food:3.5,silver:2.5,wood:1.25,copper:.25},trainingTime:6,populationCost:1,abilities:["远程攻击","穿甲"],counters:{infantry:1.6,siege:1.3},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},light_cavalry:{id:"light_cavalry",name:"轻骑兵",desc:"快速机动的骑兵单位，克制弓箭手。",epoch:2,icon:"Navigation",category:"cavalry",attack:18,defense:8,speed:8,range:1,recruitCost:{food:600,silver:300,iron:125},maintenanceCost:{food:6,silver:4,iron:.3},trainingTime:7,populationCost:1,abilities:["快速移动","冲锋"],counters:{archer:1.8},weakAgainst:["infantry"],obsoleteAfterEpochs:2},battering_ram:{id:"battering_ram",name:"攻城槌",desc:"古典时代的攻城器械，对建筑极为有效。",epoch:2,icon:"Hammer",category:"siege",attack:30,defense:15,speed:1,range:1,recruitCost:{food:750,wood:1e3,iron:250,silver:400},maintenanceCost:{food:6,silver:4,wood:2.5,iron:.5},trainingTime:10,populationCost:2,abilities:["攻城"],counters:{},weakAgainst:["cavalry","archer","infantry"],obsoleteAfterEpochs:2},heavy_infantry:{id:"heavy_infantry",name:"重甲步兵",desc:"装备锁子甲的精锐步兵，防御力强。",epoch:3,icon:"ShieldAlert",category:"infantry",attack:20,defense:18,speed:2,range:1,recruitCost:{food:700,iron:300,silver:400},maintenanceCost:{food:4.5,silver:3.5,iron:.6,cloth:.2},trainingTime:8,populationCost:1,abilities:["重甲","坚守"],counters:{cavalry:1.6,siege:1.4},weakAgainst:["archer"],obsoleteAfterEpochs:2},crossbowman:{id:"crossbowman",name:"弩兵",desc:"装备十字弩的远程单位，穿透力强。",epoch:3,icon:"Crosshair",category:"archer",attack:22,defense:9,speed:3,range:5,recruitCost:{food:550,wood:350,iron:225,silver:275},maintenanceCost:{food:4,silver:3,wood:.75,iron:.5},trainingTime:7,populationCost:1,abilities:["远程攻击","穿甲"],counters:{infantry:1.7,siege:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},knight:{id:"knight",name:"骑士",desc:"装备板甲的精锐骑兵，封建时代的主力。",epoch:3,icon:"Crown",category:"cavalry",attack:28,defense:22,speed:6,range:1,recruitCost:{food:1250,iron:500,copper:150,silver:800},maintenanceCost:{food:9,silver:6.5,iron:.8,copper:.3},trainingTime:10,populationCost:1,abilities:["重甲","冲锋","贵族"],counters:{archer:1.9},weakAgainst:["infantry"],obsoleteAfterEpochs:2},trebuchet:{id:"trebuchet",name:"投石机",desc:"中世纪的重型攻城器械，可投掷巨石。",epoch:3,icon:"Mountain",category:"siege",attack:45,defense:8,speed:1,range:6,recruitCost:{food:1e3,wood:1e3,plank:400,iron:400,silver:750},maintenanceCost:{food:7.5,silver:6,plank:1.5,iron:.6,stone:1.2},trainingTime:12,populationCost:3,abilities:["攻城","范围伤害"],counters:{infantry:1.3},weakAgainst:["cavalry","archer"],obsoleteAfterEpochs:2},pikeman:{id:"pikeman",name:"长枪兵",desc:"装备长枪的步兵，方阵抵御骑兵冲锋。",epoch:4,icon:"Swords",category:"infantry",attack:22,defense:20,speed:2,range:2,recruitCost:{food:800,wood:300,iron:350,silver:450},maintenanceCost:{food:5,silver:4,iron:.5},trainingTime:8,populationCost:1,abilities:["反骑兵","方阵"],counters:{cavalry:2,siege:1.3},weakAgainst:["archer","gunpowder"],obsoleteAfterEpochs:2},arquebus:{id:"arquebus",name:"火绳枪手",desc:"早期火器部队，虽然装填慢但威力巨大，克制传统步兵和骑兵。",epoch:4,icon:"Flame",category:"gunpowder",attack:28,defense:8,speed:2,range:4,recruitCost:{food:700,iron:300,tools:200,copper:80,silver:500},maintenanceCost:{food:4.5,silver:4,iron:.35,tools:.9,copper:.15},trainingTime:9,populationCost:1,abilities:["火器","穿甲","装填缓慢"],counters:{infantry:1.5,cavalry:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},cuirassier:{id:"cuirassier",name:"胸甲骑兵",desc:"装备胸甲的重装骑兵，可抵抗早期火器。",epoch:4,icon:"Shield",category:"cavalry",attack:32,defense:24,speed:6,range:1,recruitCost:{food:1500,iron:600,silver:1e3},maintenanceCost:{food:10,silver:7.5,iron:1.25},trainingTime:11,populationCost:1,abilities:["重甲","冲锋","抗火器"],counters:{archer:1.9,gunpowder:1.5},weakAgainst:["infantry"],obsoleteAfterEpochs:2},bombard:{id:"bombard",name:"射石炮",desc:"早期火炮，可攻破城墙。",epoch:4,icon:"Bomb",category:"siege",attack:55,defense:10,speed:1,range:6,recruitCost:{food:1250,iron:600,copper:250,tools:350,silver:1e3},maintenanceCost:{food:9,silver:7.5,iron:1.2,copper:.4,tools:1.5},trainingTime:14,populationCost:3,abilities:["攻城","范围伤害","火器"],counters:{infantry:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},musketeer:{id:"musketeer",name:"刺刀火枪兵",desc:"装备滑膛枪和刺刀的步兵，可远程射击也可近战。",epoch:5,icon:"Zap",category:"infantry",attack:30,defense:14,speed:3,range:3,recruitCost:{food:900,iron:350,tools:250,silver:550},maintenanceCost:{food:5.5,silver:5,iron:.45,tools:1,cloth:.15},trainingTime:9,populationCost:1,abilities:["火器","刺刀冲锋","齐射"],counters:{cavalry:1.6,siege:1.4},weakAgainst:["gunpowder"],obsoleteAfterEpochs:2},rifleman:{id:"rifleman",name:"线膛枪手",desc:"装备线膛枪的精确射手，射程远、精度高。",epoch:5,icon:"Target",category:"gunpowder",attack:35,defense:10,speed:3,range:5,recruitCost:{food:1e3,iron:400,tools:300,silver:650},maintenanceCost:{food:6,silver:5.5,iron:.5,tools:1.3},trainingTime:10,populationCost:1,abilities:["火器","精确射击","穿甲"],counters:{infantry:1.7,cavalry:1.5,siege:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},dragoon:{id:"dragoon",name:"龙骑兵",desc:"骑马机动的火枪兵，可下马作战，机动性和火力兼备。",epoch:5,icon:"Navigation",category:"cavalry",attack:35,defense:18,speed:7,range:2,recruitCost:{food:1400,iron:450,tools:225,silver:900},maintenanceCost:{food:10,silver:7.5,iron:.75,tools:1},trainingTime:12,populationCost:1,abilities:["火器","快速移动","下马作战"],counters:{archer:1.8,gunpowder:1.6},weakAgainst:["infantry"],obsoleteAfterEpochs:2},cannon:{id:"cannon",name:"野战炮",desc:"启蒙时代的标准火炮，可用于攻城和野战。",epoch:5,icon:"Bomb",category:"siege",attack:60,defense:12,speed:2,range:7,recruitCost:{food:1500,iron:700,copper:300,tools:450,silver:1250},maintenanceCost:{food:10,silver:9,iron:1.4,copper:.5,tools:2},trainingTime:15,populationCost:3,abilities:["攻城","范围伤害","火器"],counters:{infantry:1.7,gunpowder:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},line_infantry:{id:"line_infantry",name:"线列步兵",desc:"工业化训练的步兵，装备后装步枪和刺刀。",epoch:6,icon:"Users",category:"infantry",attack:40,defense:20,speed:3,range:4,recruitCost:{food:1250,steel:150,tools:200,silver:800},maintenanceCost:{food:7,silver:6.5,steel:.3,coal:.15},trainingTime:10,populationCost:1,abilities:["火器","齐射","刺刀冲锋"],counters:{cavalry:1.7,siege:1.5},weakAgainst:["gunpowder"],obsoleteAfterEpochs:3},gatling:{id:"gatling",name:"加特林机枪组",desc:"早期机枪，火力密集，克制密集阵型的步兵和骑兵。",epoch:6,icon:"Zap",category:"gunpowder",attack:50,defense:12,speed:2,range:5,recruitCost:{food:1500,steel:300,tools:350,coal:200,silver:1250},maintenanceCost:{food:8,silver:9,steel:.6,coal:.8},trainingTime:12,populationCost:2,abilities:["火器","压制火力","范围伤害"],counters:{infantry:2,cavalry:1.8},weakAgainst:["siege"],obsoleteAfterEpochs:3},lancer:{id:"lancer",name:"枪骑兵",desc:"工业时代的精锐骑兵，适合侦察、追击和近身突袭火器阵地。",epoch:6,icon:"Compass",category:"cavalry",attack:38,defense:20,speed:8,range:1,recruitCost:{food:1600,steel:120,tools:180,silver:1e3},maintenanceCost:{food:11,silver:8,steel:.25,iron:.4},trainingTime:11,populationCost:1,abilities:["冲锋","快速移动","侦察"],counters:{archer:1.9,gunpowder:1.7},weakAgainst:["infantry"],obsoleteAfterEpochs:3},artillery:{id:"artillery",name:"重型火炮",desc:"工业化生产的重型火炮，威力巨大。",epoch:6,icon:"Bomb",category:"siege",attack:80,defense:15,speed:1,range:8,recruitCost:{food:2e3,steel:500,coal:400,tools:300,silver:1750},maintenanceCost:{food:10,silver:11,steel:1.2,coal:1.5},trainingTime:18,populationCost:4,abilities:["攻城","范围伤害","精确打击"],counters:{infantry:2,gunpowder:1.8,siege:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:3}},dc=(e={})=>{let t=0;return Object.entries(e).forEach(([o,i])=>{var s;if(i<=0)return;const r=Ro[o];if(!r)return;const a=((s=r.maintenanceCost)==null?void 0:s.food)||0;t+=a*i}),t},lr=(e,t)=>{let o=1,i=0;return Object.entries(e).forEach(([r,a])=>{if(a<=0)return;const s=Ro[r];s&&Object.entries(t).forEach(([u,c])=>{if(c<=0)return;const f=Ro[u];if(f&&s.counters[f.category]){const p=s.counters[f.category],d=a*c/100;o+=(p-1)*d,i++}})}),{multiplier:o,counterCount:i}},pc={范围伤害:.12,压制火力:.1,火器:.06,齐射:.05,远程攻击:.05,穿甲:.06,冲锋:.06,机动:.04,快速移动:.04,侦察:.03,攻城:.08,精确打击:.08},hc={坚守:.08,方阵:.08,盾墙:.08},ur=(e,t)=>Array.isArray(e)?e.reduce((o,i)=>o+(t[i]||0),0):0,mc=(e={})=>{const t=Object.values(e).reduce((o,i)=>o+(i||0),0);return t<=0?{infantry:0,cavalry:0,archer:0,gunpowder:0,siege:0}:{infantry:(e.infantry||0)/t,cavalry:(e.cavalry||0)/t,archer:(e.archer||0)/t,gunpowder:(e.gunpowder||0)/t,siege:(e.siege||0)/t}},fr=(e={})=>{const t={};return Object.entries(e).forEach(([o,i])=>{if(i<=0)return;const r=Ro[o];r&&(t[r.category]=(t[r.category]||0)+i)}),t},gc=(e,t,o)=>{if(!e||o<=0)return 1;let i=1;return Object.entries(e.counters||{}).forEach(([r,a])=>{const s=(t[r]||0)/o;s>0&&(i+=(a-1)*s)}),i},dr=(e={})=>{const t={infantry:1,cavalry:1,archer:1,gunpowder:1,siege:1},o=Object.values(e).reduce((i,r)=>i+(r||0),0);return o<=0||Object.entries(e).forEach(([i,r])=>{if(r<=0)return;const a=Ro[i];if(!a||!a.counters)return;const s=r/o;Object.entries(a.counters).forEach(([u,c])=>{t[u]+=(c-1)*s})}),t},pr=({army:e,enemyCategoryCounts:t,enemyCounterPressure:o,militaryBuffs:i=0,defenseMultiplier:r=1})=>{let a=0,s=0,u=0;const c={},f=Object.values(t||{}).reduce((d,M)=>d+(M||0),0),p=mc(t);return Object.entries(e||{}).forEach(([d,M])=>{if(M<=0)return;const h=Ro[d];if(!h)return;const y=gc(h,t||{},f),w=ur(h.abilities,pc),m=ur(h.abilities,hc),E=Math.min(.3,(h.range||1)*.03),v=Math.min(.2,(h.speed||1)*.02);let g=0,C=0,R=0;const k=Array.isArray(h.abilities)?h.abilities:[];k.includes("范围伤害")&&(g+=.18*(p.infantry+p.archer)),k.includes("压制火力")&&(g+=.12*(p.infantry+p.archer)),k.includes("火器")&&(g+=.1*(p.infantry+p.cavalry),C-=.08*p.cavalry),k.includes("穿甲")&&(g+=.08*(p.infantry+p.gunpowder+p.siege)),k.includes("冲锋")&&(h.speed||0)>=6&&(g+=.1*(p.gunpowder+p.archer)),k.includes("刺刀冲锋")&&(g+=.06*p.cavalry),k.includes("装填缓慢")&&(g-=.12*p.cavalry),k.includes("重甲")&&(C+=.12,g-=.05),k.includes("抗火器")&&(R-=.15*p.gunpowder,C+=.05*p.gunpowder),(k.includes("精确射击")||k.includes("精确打击"))&&(g+=.08*(p.siege+p.infantry)),k.includes("下马作战")&&(C+=.08*p.cavalry);const D=h.attack*(1+E+v+w+g)*(1+i)*y,P=h.defense*(1+v*.5+m+C)*r*(1+i),T=Math.max(.6,((o==null?void 0:o[h.category])||1)*(1+R)),S=P/T;a+=D*M,s+=P*M,u+=M,c[d]={count:M,attackPerUnit:D,defensePerUnit:P,adjustedDefensePerUnit:S,category:h.category}}),{totalAttack:a,totalDefense:s,totalUnits:u,unitProfiles:c}},yc=(e={})=>{const t={};Object.values(e).forEach(r=>{r&&(t[r.category]=(t[r.category]||0)+r.count)});let o=null,i=0;return Object.entries(t).forEach(([r,a])=>{a>i&&(i=a,o=r)}),o},hr=e=>{const t=Math.floor(e),o=e-t;return t+(Math.random()<o?1:0)},bc=(e,t)=>{if(t<=0)return{};const o={...e};let i=Object.values(o).reduce((u,c)=>u+(c||0),0);if(i<=t)return o;const r=t/i;if(Object.keys(o).forEach(u=>{o[u]=hr(o[u]*r)}),i=Object.values(o).reduce((u,c)=>u+(c||0),0),i<=t)return o;const a=Object.keys(o).sort((u,c)=>(o[c]||0)-(o[u]||0));let s=0;for(;i>t&&a.length>0;){const u=a[s%a.length];(o[u]||0)>0&&(o[u]-=1,i-=1),s+=1}return o},mr=({sideProfile:e,enemyProfile:t,enemyCounterPressure:o,isWinner:i,powerRatio:r,decisive:a,dominanceRatio:s,ownPowerScore:u,enemyPowerScore:c})=>{if(!e||e.totalUnits<=0||t.totalAttack<=0)return{};const f=c/(c+u);let p=.12*Math.pow(f,.9);if(i&&(p*=.75),a&&(p*=i?.6:1.1),p*=.9+Math.random()*.2,!i){const y=Math.max(1,s||1);p*=1+Math.min(.8,(y-1)*.18)}const d=t.totalAttack*p;if(d<=0)return{};let M=0;if(Object.values(e.unitProfiles).forEach(y=>{M+=y.count/y.adjustedDefensePerUnit}),M<=0)return{};const h={};if(Object.entries(e.unitProfiles).forEach(([y,w])=>{const m=w.count/w.adjustedDefensePerUnit,v=d*(m/M)/w.adjustedDefensePerUnit;h[y]=Math.min(w.count,hr(v))}),!i){const y=Math.max(1,s||1);if(y>=3&&(a||y>=6)){const w=Math.min(.75,.2+(y-3)*.12+(a?.15:0));if(Math.random()<w){const m={};return Object.entries(e.unitProfiles).forEach(([E,v])=>{m[E]=v.count}),m}}}if(i&&r>=3&&t.totalUnits>0){let y;r>=10?y=Math.floor(Math.sqrt(t.totalUnits)*.2):r>=6?y=Math.floor(Math.sqrt(t.totalUnits)*.3):y=Math.floor(Math.sqrt(t.totalUnits)*.4);const w=yc(e.unitProfiles);return((o==null?void 0:o[w])||1)>=1.4&&y===0&&t.totalUnits>=5&&(y=1),bc(h,y)}return h},gr=(e,t)=>{const{army:o,militaryBuffs:i=0}=e,{army:r,militaryBuffs:a=0,wealth:s=1e3}=t,u=fr(o),c=fr(r),f=dr(o),p=dr(r),d=pr({army:o,enemyCategoryCounts:c,enemyCounterPressure:p,militaryBuffs:i,defenseMultiplier:1}),M=pr({army:r,enemyCategoryCounts:u,enemyCounterPressure:f,militaryBuffs:a,defenseMultiplier:1.2});let h=d.totalAttack*.65+d.totalDefense*.35,y=M.totalAttack*.65+M.totalDefense*.35;h*=.9+Math.random()*.2,y*=.9+Math.random()*.2;const w=h+y,m=w>0?h/w:0,E=w>0?y/w:0,v=m>.5,g=Math.abs(m-.5)>.28,C=y>0?h/y:100,R=mr({sideProfile:d,enemyProfile:M,enemyCounterPressure:p,isWinner:v,powerRatio:C,decisive:g,dominanceRatio:v?C:1/C,ownPowerScore:h,enemyPowerScore:y}),k=mr({sideProfile:M,enemyProfile:d,enemyCounterPressure:f,isWinner:!v,powerRatio:C>0?1/C:100,decisive:g,dominanceRatio:v?C:1/C,ownPowerScore:y,enemyPowerScore:h}),D=lr(o,r),P=lr(r,o);let T={};if(v){const V=s*(g?.08:.04),N={food:500,wood:300,stone:200,silver:1500,iron:150,copper:100,cloth:100,tools:80};T={food:Math.min(N.food,Math.floor(V*.25)),wood:Math.min(N.wood,Math.floor(V*.12)),stone:Math.min(N.stone,Math.floor(V*.08)),silver:Math.min(N.silver,Math.floor(V*.3)),iron:Math.min(N.iron,Math.floor(V*.1)),copper:Math.min(N.copper,Math.floor(V*.05)),cloth:Math.min(N.cloth,Math.floor(V*.05)),tools:Math.min(N.tools,Math.floor(V*.05))},Object.keys(T).forEach(L=>{T[L]<=0&&delete T[L]})}return{victory:v,decisive:g,attackerPower:Math.floor(h),defenderPower:Math.floor(y),attackerAdvantage:(m*100).toFixed(1),defenderAdvantage:(E*100).toFixed(1),attackerLosses:R,defenderLosses:k,attackerCounter:D.counterCount,defenderCounter:P.counterCount,loot:T,battleReport:Mc({victory:v,decisive:g,attackerPower:h,defenderPower:y,attackerCounter:D.counterCount,defenderCounter:P.counterCount,attackerLosses:R,defenderLosses:k,loot:T})}},Mc=e=>{const{victory:t,decisive:o,attackerPower:i,defenderPower:r,attackerCounter:a,defenderCounter:s,attackerLosses:u,defenderLosses:c,loot:f}=e;let p=[];t?o?p.push("🎉 压倒性胜利！敌军溃不成军！"):p.push("✓ 艰难的胜利，我军成功击退敌人。"):o?p.push("💀 惨败！我军遭受重创！"):p.push("✗ 战败，我军被迫撤退。"),p.push(`战斗力对比：我方 ${Math.floor(i)} vs 敌方 ${Math.floor(r)}`),a>0&&p.push(`✓ 我方兵种克制生效 ${a} 次`),s>0&&p.push(`✗ 敌方兵种克制生效 ${s} 次`);const d=Object.values(u).reduce((h,y)=>h+y,0),M=Object.values(c).reduce((h,y)=>h+y,0);if(p.push(`我方损失：${d} 人`),p.push(`敌方损失：${M} 人`),t&&f){const h=Object.entries(f).filter(([,y])=>y>0).map(([y,w])=>`${y} ${w}`).join(", ");h&&p.push(`掠夺资源：${h}`)}return p},vc=e=>{const t={};return Object.entries(e).forEach(([o,i])=>{if(i<=0)return;const r=Ro[o];r&&Object.entries(r.maintenanceCost).forEach(([a,s])=>{t[a]=(t[a]||0)+s*i})}),t},yr=e=>{let t=0;return Object.entries(e).forEach(([o,i])=>{if(i<=0)return;const r=Ro[o];r&&(t+=r.populationCost*i)}),t},wc=(e,t)=>{if(t<=0||e<=0)return 1;const o=e/t;return o<=.1?1:o<=.2?1+(o-.1)*2.5:o<=.3?1.25+(o-.2)*2.5:o<=.4?1.5+(o-.3)*2.5:1.75+(o-.4)*2.5},go=["peasant","worker","artisan","merchant","landowner","cleric","scribe","soldier","official","capitalist","miner","engineer","serf"],xc={stratum_approval_above:{generate:()=>{const e=go[Math.floor(Math.random()*go.length)],t=40+Math.floor(Math.random()*40);return{stratum:e,threshold:t}},check:(e,t)=>{var o;return(((o=t.classApproval)==null?void 0:o[e.stratum])||50)>=e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}满意度 ≥ ${e.threshold}`}},stratum_approval_below:{generate:()=>{const e=go[Math.floor(Math.random()*go.length)],t=20+Math.floor(Math.random()*30);return{stratum:e,threshold:t}},check:(e,t)=>{var o;return(((o=t.classApproval)==null?void 0:o[e.stratum])||50)<e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}满意度 < ${e.threshold}`}},stratum_influence_above:{generate:()=>{const e=go[Math.floor(Math.random()*go.length)],t=10+Math.floor(Math.random()*25);return{stratum:e,threshold:t}},check:(e,t)=>{var r;const o=t.totalInfluence||1;return(((r=t.classInfluence)==null?void 0:r[e.stratum])||0)/o*100>=e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}影响力 ≥ ${e.threshold}%`}},stratum_influence_below:{generate:()=>{const e=go[Math.floor(Math.random()*go.length)],t=5+Math.floor(Math.random()*15);return{stratum:e,threshold:t}},check:(e,t)=>{var r;const o=t.totalInfluence||1;return(((r=t.classInfluence)==null?void 0:r[e.stratum])||0)/o*100<e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}影响力 < ${e.threshold}%`}},stratum_living_standard:{generate:()=>{const e=go[Math.floor(Math.random()*go.length)],t=["赤贫","贫困","温饱","小康","富裕","奢华"],o=Math.floor(Math.random()*4);return{stratum:e,minLevel:o,levelName:t[o]}},check:(e,t)=>{var a,s;const o=["赤贫","贫困","温饱","小康","富裕","奢华"],i=((s=(a=t.classLivingStandard)==null?void 0:a[e.stratum])==null?void 0:s.level)||"温饱",r=o.indexOf(i);return r===-1?!1:r>=e.minLevel},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}生活水平 ≥ ${e.levelName}`}},stratum_income_above:{generate:()=>{const e=go[Math.floor(Math.random()*go.length)],t=50+Math.floor(Math.random()*200);return{stratum:e,threshold:t}},check:(e,t)=>{var o;return(((o=t.classIncome)==null?void 0:o[e.stratum])||0)>=e.threshold},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}日均收入 ≥ ${e.threshold}`}},stability_above:{generate:()=>({threshold:50+Math.floor(Math.random()*40)}),check:(e,t)=>(t.stability||.5)*100>=e.threshold,text:e=>`稳定度 ≥ ${e.threshold}%`},stability_below:{generate:()=>({threshold:20+Math.floor(Math.random()*40)}),check:(e,t)=>(t.stability||.5)*100<e.threshold,text:e=>`稳定度 < ${e.threshold}%`},avg_tax_above:{generate:()=>({threshold:8+Math.floor(Math.random()*15)}),check:(e,t)=>{var r;const o=Object.values(((r=t.taxPolicies)==null?void 0:r.headTaxRates)||{});return(o.length>0?o.reduce((a,s)=>a+s,0)/o.length:.1)*100>=e.threshold},text:e=>`平均税率 ≥ ${e.threshold}%`},avg_tax_below:{generate:()=>({threshold:5+Math.floor(Math.random()*10)}),check:(e,t)=>{var r;const o=Object.values(((r=t.taxPolicies)==null?void 0:r.headTaxRates)||{});return(o.length>0?o.reduce((a,s)=>a+s,0)/o.length:.1)*100<e.threshold},text:e=>`平均税率 < ${e.threshold}%`},coalition_size_above:{generate:()=>({threshold:2+Math.floor(Math.random()*3)}),check:(e,t)=>{var o;return(((o=t.rulingCoalition)==null?void 0:o.length)||0)>=e.threshold},text:e=>`执政联盟 ≥ ${e.threshold}个阶层`},coalition_size_below:{generate:()=>({threshold:2+Math.floor(Math.random()*2)}),check:(e,t)=>{var o;return(((o=t.rulingCoalition)==null?void 0:o.length)||0)<=e.threshold},text:e=>`执政联盟 ≤ ${e.threshold}个阶层`},coalition_includes:{generate:()=>({stratum:go[Math.floor(Math.random()*go.length)]}),check:(e,t)=>{var o;return(o=t.rulingCoalition)==null?void 0:o.includes(e.stratum)},text:e=>{var t;return`${((t=ae[e.stratum])==null?void 0:t.name)||e.stratum}参与执政`}},legitimacy_above:{generate:()=>({threshold:40+Math.floor(Math.random()*40)}),check:(e,t)=>(t.legitimacy||50)>=e.threshold,text:e=>`合法性 ≥ ${e.threshold}`},at_war:{generate:()=>({}),check:(e,t)=>{var o;return t.atWar===!0||((o=t.nations)==null?void 0:o.some(i=>i.isAtWar))},text:()=>"处于战争状态"},at_peace:{generate:()=>({}),check:(e,t)=>{var o;return t.atWar!==!0&&!((o=t.nations)!=null&&o.some(i=>i.isAtWar))},text:()=>"处于和平状态"},population_above:{generate:()=>({threshold:500+Math.floor(Math.random()*2e3)}),check:(e,t)=>(t.population||0)>=e.threshold,text:e=>`人口 ≥ ${e.threshold}`},population_below:{generate:()=>({threshold:200+Math.floor(Math.random()*500)}),check:(e,t)=>(t.population||0)<e.threshold,text:e=>`人口 < ${e.threshold}`},epoch_at_least:{generate:()=>({epoch:Math.floor(Math.random()*5)}),check:(e,t)=>(t.epoch||0)>=e.epoch,text:e=>`达到${["石器时代","青铜时代","古典时代","封建时代","探索时代","启蒙时代","工业时代","信息时代"][e.epoch]||`时代${e.epoch}`}`},resource_price_above:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","ale","coal","delicacies","furniture","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",ale:"美酒",coal:"煤炭",delicacies:"珍馐",furniture:"家具",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=1.1+Math.random()*.4,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)>=e.threshold},text:e=>`${e.resourceName}物价 ≥ ${e.threshold}`},resource_price_below:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","ale","coal","delicacies","furniture","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",ale:"美酒",coal:"煤炭",delicacies:"珍馐",furniture:"家具",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=.7+Math.random()*.25,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)<e.threshold},text:e=>`${e.resourceName}物价 < ${e.threshold}`},price_stability:{generate:()=>{const e=.3+Math.random()*.4;return{threshold:Math.round(e*100)/100}},check:(e,t)=>{if(!t.prices||Object.keys(t.prices).length===0)return!0;const o=Object.values(t.prices),i=o.reduce((a,s)=>a+s,0)/o.length,r=o.reduce((a,s)=>a+Math.pow(s-i,2),0)/o.length;return Math.sqrt(r)<=e.threshold},text:e=>`物价波动 ≤ ${(e.threshold*100).toFixed(0)}%`},food_affordable:{generate:e=>{var r;const t=((r=e==null?void 0:e.prices)==null?void 0:r.food)||1,o=.75+Math.random()*.2;return{threshold:Math.round(t*o*10)/10}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i.food)||1)<=e.threshold},text:e=>`粮价 ≤ ${e.threshold}`},food_scarce:{generate:e=>{var r;const t=((r=e==null?void 0:e.prices)==null?void 0:r.food)||1,o=1.1+Math.random()*.3;return{threshold:Math.round(t*o*10)/10}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i.food)||1)>=e.threshold},text:e=>`粮价 ≥ ${e.threshold}`},inflation_above:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","coal","delicacies","furniture","ale","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",coal:"煤炭",delicacies:"珍馐",furniture:"家具",ale:"美酒",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=1.15+Math.random()*.35,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)>=e.threshold},text:e=>`${e.resourceName}物价 ≥ ${e.threshold}`},deflation_below:{generate:e=>{var u;const t=["food","wood","stone","iron","cloth","tools","copper","coal","delicacies","furniture","ale","fine_clothes","spice"],o={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",coal:"煤炭",delicacies:"珍馐",furniture:"家具",ale:"美酒",fine_clothes:"华服",spice:"香料"},i=t[Math.floor(Math.random()*t.length)],r=((u=e==null?void 0:e.prices)==null?void 0:u[i])||1,a=.65+Math.random()*.25,s=Math.round(r*a*10)/10;return{resource:i,threshold:s,resourceName:o[i]||i}},check:(e,t)=>{var i;return(((i=t.prices)==null?void 0:i[e.resource])||1)<e.threshold},text:e=>`${e.resourceName}物价 < ${e.threshold}`}},Ec={primitive_communism:{name:"原始公社",spectrum:"left",icon:"Users",color:"text-red-400",unlockEpoch:0,maxEpoch:3,historicalRef:"氏族共有制",description:"一切资源归部落共有",issues:["equality","collectivism"],conditionTypes:["stratum_approval_above","stability_above","coalition_size_above"],preferredStrata:["peasant","worker","artisan","serf"],stratumWeights:{peasant:2,worker:2,serf:1.5,landowner:.2,merchant:.3,capitalist:.1},activeEffects:{stability:.05,approval:{peasant:4,worker:4}},unsatisfiedPenalty:{approval:{peasant:-2,worker:-2}}},tribal_elder:{name:"部落长老制",spectrum:"right",icon:"Crown",color:"text-amber-400",unlockEpoch:0,maxEpoch:2,historicalRef:"早期酋长",description:"尊崇长老权威",issues:["tradition","hierarchy"],conditionTypes:["legitimacy_above","stratum_influence_above","population_below"],preferredStrata:["landowner","cleric","official"],stratumWeights:{landowner:2,cleric:1.5,peasant:1},activeEffects:{stability:.04,legitimacyBonus:.04},unsatisfiedPenalty:{stability:-.02}},animism:{name:"万物有灵论",spectrum:"center",icon:"Leaf",color:"text-green-400",unlockEpoch:0,maxEpoch:3,historicalRef:"原始宗教",description:"敬畏自然神灵",issues:["spiritual","nature"],conditionTypes:["stratum_approval_above","stability_above"],preferredStrata:["cleric","peasant"],stratumWeights:{cleric:3,peasant:1.5},activeEffects:{approval:{cleric:6},needsReduction:.02},unsatisfiedPenalty:{}},warrior_cult:{name:"尚武精神",spectrum:"right",icon:"Sword",color:"text-red-500",unlockEpoch:0,maxEpoch:5,historicalRef:"原始部落战争",description:"崇尚武力与征服",issues:["military","expansion"],conditionTypes:["at_war","stratum_approval_above"],preferredStrata:["soldier","landowner"],stratumWeights:{soldier:3},activeEffects:{militaryBonus:.15},unsatisfiedPenalty:{approval:{soldier:-4}}},aristocratic_oligarchy:{name:"贵族寡头制",spectrum:"right",icon:"Castle",color:"text-purple-400",unlockEpoch:1,historicalRef:"斯巴达双王制",description:"政权归于少数贵族",issues:["hierarchy","tradition"],conditionTypes:["stratum_influence_above","coalition_includes","legitimacy_above"],preferredStrata:["landowner","official","merchant"],stratumWeights:{landowner:3,official:1.5},activeEffects:{militaryBonus:.12,taxEfficiency:.08},unsatisfiedPenalty:{approval:{landowner:-6}}},theocracy:{name:"神权政治",spectrum:"right",icon:"Church",color:"text-yellow-300",unlockEpoch:1,historicalRef:"古埃及法老",description:"神的代言人统治",issues:["spiritual","hierarchy"],conditionTypes:["coalition_includes","stratum_approval_above"],preferredStrata:["cleric"],stratumWeights:{cleric:4},activeEffects:{legitimacyBonus:.15,approval:{cleric:15}},unsatisfiedPenalty:{approval:{cleric:-8}}},republicanism:{name:"共和主义",spectrum:"center",icon:"Scale",color:"text-blue-400",unlockEpoch:2,historicalRef:"罗马共和国",description:"公民参与公共事务",issues:["liberty","law"],conditionTypes:["coalition_size_above","legitimacy_above","stability_above"],preferredStrata:["scribe","merchant","artisan","official"],stratumWeights:{scribe:2,merchant:1.5,artisan:1.5},activeEffects:{legitimacyBonus:.12,stability:.08},unsatisfiedPenalty:{stability:-.02}},populares:{name:"平民派",spectrum:"left",icon:"Users",color:"text-orange-400",unlockEpoch:2,historicalRef:"格拉古兄弟",description:"为平民争取权益",issues:["equality","reform"],conditionTypes:["stratum_approval_above","stratum_living_standard","food_affordable"],preferredStrata:["peasant","worker","artisan","serf"],stratumWeights:{peasant:2.5,worker:2.5,artisan:1.5},activeEffects:{populationGrowth:.08,approval:{peasant:8,worker:8}},unsatisfiedPenalty:{approval:{peasant:-4,worker:-4}}},legalism:{name:"法家",spectrum:"right",icon:"Gavel",color:"text-gray-300",unlockEpoch:2,historicalRef:"商鞅变法",description:"严刑峻法治国",issues:["law","efficiency"],conditionTypes:["avg_tax_above","stability_above"],preferredStrata:["official","soldier","scribe"],stratumWeights:{official:2.5,soldier:1.5},activeEffects:{taxEfficiency:.15,stability:-.06},unsatisfiedPenalty:{}},confucianism:{name:"儒家",spectrum:"center",icon:"Book",color:"text-amber-300",unlockEpoch:2,historicalRef:"孔孟之道",description:"礼教治国",issues:["tradition","education"],conditionTypes:["stratum_approval_above","stability_above","legitimacy_above"],preferredStrata:["scribe","cleric","official"],stratumWeights:{scribe:3,cleric:1.5,official:2},activeEffects:{stability:.15,researchSpeed:.08},unsatisfiedPenalty:{stability:-.02}},mohism:{name:"墨家",spectrum:"left",icon:"Wrench",color:"text-gray-400",unlockEpoch:2,historicalRef:"墨子兼爱非攻",description:"兼爱非攻，尚同尚贤",issues:["equality","efficiency"],conditionTypes:["at_peace","stratum_approval_above"],preferredStrata:["artisan","worker","engineer"],stratumWeights:{artisan:2.5,worker:2,engineer:1.5},activeEffects:{industryBonus:.12,buildingCostMod:-.08,productionInputCost:{sawmill:-.15,brickworks:-.15,metallurgy_workshop:-.18}},unsatisfiedPenalty:{approval:{artisan:-2}}},taoism:{name:"道家",spectrum:"center",icon:"Circle",color:"text-slate-300",unlockEpoch:2,historicalRef:"老庄无为",description:"无为而治",issues:["liberty","nature"],conditionTypes:["avg_tax_below","stability_above"],preferredStrata:["cleric","peasant","scribe"],stratumWeights:{cleric:2,peasant:1.5,scribe:1.5},activeEffects:{needsReduction:.12,stability:.08},unsatisfiedPenalty:{}},feudalism:{name:"封建主义",spectrum:"right",icon:"Castle",color:"text-blue-500",unlockEpoch:3,historicalRef:"中世纪欧洲分封",description:"领主-附庸关系",issues:["hierarchy","land"],conditionTypes:["stratum_influence_above","legitimacy_above"],preferredStrata:["landowner","official"],stratumWeights:{landowner:3,peasant:.5},activeEffects:{gatherBonus:.08,approval:{landowner:12}},unsatisfiedPenalty:{approval:{landowner:-6}}},peasant_revolt:{name:"农民起义派",spectrum:"left",icon:"Flame",color:"text-red-600",unlockEpoch:3,historicalRef:"黄巾起义、扎克雷起义",description:"推翻压迫者",issues:["equality","revolution"],conditionTypes:["stratum_approval_below","avg_tax_above","food_scarce","inflation_above"],preferredStrata:["peasant","serf","worker"],stratumWeights:{peasant:3,serf:3,worker:2},activeEffects:{organizationDecay:-.22},unsatisfiedPenalty:{}},guild_corporatism:{name:"行会主义",spectrum:"center",icon:"Hammer",color:"text-orange-300",unlockEpoch:3,historicalRef:"中世纪行会",description:"同业互助，质量至上",issues:["trade","tradition"],conditionTypes:["stratum_approval_above","stratum_income_above","resource_price_below","price_stability"],preferredStrata:["artisan","merchant"],stratumWeights:{artisan:3,merchant:2},activeEffects:{tradeBonus:.12,approval:{artisan:8,merchant:8},productionInputCost:{furniture_workshop:-.18,tailor_workshop:-.18,loom_house:-.15}},unsatisfiedPenalty:{approval:{artisan:-4},productionInputCost:{furniture_workshop:.05,tailor_workshop:.05}}},mercantilism:{name:"重商主义",spectrum:"center",icon:"Ship",color:"text-cyan-400",unlockEpoch:4,historicalRef:"东印度公司",description:"贸易国富之本",issues:["trade","wealth"],conditionTypes:["stratum_income_above","stratum_influence_above","resource_price_above","inflation_above"],preferredStrata:["merchant","capitalist"],stratumWeights:{merchant:3,capitalist:2},activeEffects:{tradeBonus:.18,incomePercentBonus:.08},unsatisfiedPenalty:{approval:{merchant:-4}}},absolutism:{name:"绝对君主制",spectrum:"right",icon:"Crown",color:"text-purple-500",unlockEpoch:4,historicalRef:"路易十四、彼得大帝",description:"朕即国家",issues:["hierarchy","centralization"],conditionTypes:["coalition_size_below","legitimacy_above"],preferredStrata:["official","landowner"],stratumWeights:{official:2},activeEffects:{taxEfficiency:.15,buildingCostMod:-.12},unsatisfiedPenalty:{}},humanism:{name:"人文主义",spectrum:"center",icon:"Book",color:"text-rose-300",unlockEpoch:4,historicalRef:"文艺复兴",description:"以人为本",issues:["education","progress"],conditionTypes:["stratum_approval_above","epoch_at_least"],preferredStrata:["scribe","artisan","engineer"],stratumWeights:{scribe:3,artisan:2},activeEffects:{researchSpeed:.15,cultureBonus:.12},unsatisfiedPenalty:{}},colonialism:{name:"殖民主义",spectrum:"right",icon:"Globe",color:"text-emerald-500",unlockEpoch:4,historicalRef:"大航海时代",description:"开拓新世界",issues:["expansion","trade"],conditionTypes:["stratum_income_above","at_war"],preferredStrata:["merchant","soldier","navigator"],stratumWeights:{merchant:2,soldier:1.5},activeEffects:{tradeBonus:.15,diplomaticBonus:.8},unsatisfiedPenalty:{}},classical_liberalism:{name:"古典自由主义",spectrum:"center",icon:"Lightbulb",color:"text-yellow-400",unlockEpoch:5,historicalRef:"洛克、亚当斯密",description:"自由放任经济",issues:["liberty","free_market"],conditionTypes:["avg_tax_below","stratum_approval_above","price_stability","deflation_below"],preferredStrata:["merchant","capitalist","artisan"],stratumWeights:{merchant:2,capitalist:2.5,artisan:1.5},activeEffects:{incomePercentBonus:.12,populationGrowth:.08},unsatisfiedPenalty:{approval:{merchant:-4,capitalist:-4}}},enlightened_despotism:{name:"开明专制",spectrum:"center",icon:"GraduationCap",color:"text-indigo-400",unlockEpoch:5,historicalRef:"腎特烈大帝、叶卡捷琳娜",description:"国王为国家第一仆人",issues:["reform","centralization"],conditionTypes:["coalition_size_below","legitimacy_above","stability_above"],preferredStrata:["official","scribe","engineer"],stratumWeights:{official:2,scribe:2,engineer:1.5},activeEffects:{researchSpeed:.18,buildingCostMod:-.08},unsatisfiedPenalty:{}},conservatism:{name:"保守主义",spectrum:"right",icon:"Shield",color:"text-gray-400",unlockEpoch:5,historicalRef:"伯克、梅特涅",description:"维护传统秩序",issues:["tradition","stability"],conditionTypes:["stability_above","legitimacy_above"],preferredStrata:["landowner","cleric","official"],stratumWeights:{landowner:2,cleric:2},activeEffects:{stability:.12,legitimacyBonus:.08},unsatisfiedPenalty:{stability:-.04}},utopian_socialism:{name:"空想社会主义",spectrum:"left",icon:"Sparkles",color:"text-pink-400",unlockEpoch:5,historicalRef:"莫尔乌托邦、欧文",description:"构建理想社会",issues:["equality","progress"],conditionTypes:["stratum_approval_above","stratum_living_standard"],preferredStrata:["worker","artisan","peasant","scribe"],stratumWeights:{scribe:2,worker:1.5,artisan:1.5},activeEffects:{researchSpeed:.12,approval:{worker:8}},unsatisfiedPenalty:{}},physiocracy:{name:"重农主义",spectrum:"center",icon:"Wheat",color:"text-lime-400",unlockEpoch:5,historicalRef:"魁奈学派",description:"土地是财富之源",issues:["land","free_market"],conditionTypes:["stratum_influence_above","stratum_approval_above","food_affordable","resource_price_below"],preferredStrata:["landowner","peasant"],stratumWeights:{landowner:2.5,peasant:2},activeEffects:{gatherBonus:.15,approval:{peasant:8,landowner:8}},unsatisfiedPenalty:{approval:{landowner:-4}}},marxism:{name:"马克思主义",spectrum:"left",icon:"Factory",color:"text-red-500",unlockEpoch:6,historicalRef:"共产党宣言",description:"工人阶级专政",issues:["equality","revolution","collectivism"],conditionTypes:["coalition_includes","stratum_influence_above"],preferredStrata:["worker","miner","artisan"],stratumWeights:{worker:4,miner:2},activeEffects:{industryBonus:.18,approval:{worker:15,miner:12},productionInputCost:{steel_foundry:-.22,textile_mill:-.18,building_materials_plant:-.18}},unsatisfiedPenalty:{approval:{worker:-6},organizationDecay:-.08,productionInputCost:{steel_foundry:.08,textile_mill:.06}}},social_democracy:{name:"社会民主主义",spectrum:"left",icon:"HeartHandshake",color:"text-rose-400",unlockEpoch:6,historicalRef:"伯恩斯坦修正主义",description:"渐进改良",issues:["equality","welfare"],conditionTypes:["stratum_approval_above","stratum_living_standard","stability_above","food_affordable","price_stability"],preferredStrata:["worker","scribe","artisan","peasant"],stratumWeights:{worker:2,scribe:1.5,artisan:1.5},activeEffects:{approval:{worker:12,peasant:8},stability:.08},unsatisfiedPenalty:{approval:{worker:-4}}},anarchism:{name:"无政府主义",spectrum:"left",icon:"CircleSlash",color:"text-gray-500",unlockEpoch:6,historicalRef:"巴枯宁、克鲁泡特金",description:"废除一切权威",issues:["liberty","revolution"],conditionTypes:["stability_below","stratum_approval_below"],preferredStrata:["worker","artisan","peasant"],stratumWeights:{worker:2,artisan:2},activeEffects:{needsReduction:.15},unsatisfiedPenalty:{stability:-.06}},nationalism:{name:"民族主义",spectrum:"right",icon:"Flag",color:"text-orange-500",unlockEpoch:6,historicalRef:"俨斯麦统一德国",description:"民族国家至上",issues:["nation","military"],conditionTypes:["at_war","stratum_approval_above"],preferredStrata:["soldier","official","landowner"],stratumWeights:{soldier:2.5,official:1.5},activeEffects:{militaryBonus:.22,approval:{soldier:12}},unsatisfiedPenalty:{}},neoliberalism:{name:"新自由主义",spectrum:"right",icon:"TrendingUp",color:"text-emerald-400",unlockEpoch:6,historicalRef:"哈耶克、弗里德曼",description:"市场万能",issues:["free_market","privatization"],conditionTypes:["stratum_income_above","avg_tax_below","resource_price_above","inflation_above"],preferredStrata:["capitalist","merchant"],stratumWeights:{capitalist:4,merchant:2},activeEffects:{incomePercentBonus:.18,tradeBonus:.12},unsatisfiedPenalty:{approval:{capitalist:-6}}},technocracy:{name:"技术官僚主义",spectrum:"center",icon:"Cpu",color:"text-sky-400",unlockEpoch:6,historicalRef:"圣西门、专家治国",description:"让专家决策",issues:["efficiency","progress"],conditionTypes:["epoch_at_least","stratum_influence_above"],preferredStrata:["engineer","scribe","official"],stratumWeights:{engineer:3,scribe:2},activeEffects:{researchSpeed:.22,industryBonus:.12,productionInputCost:{printing_house:-.28,factory:-.22,steel_foundry:-.15}},unsatisfiedPenalty:{}},digital_democracy:{name:"数字民主",spectrum:"center",icon:"Monitor",color:"text-cyan-300",unlockEpoch:7,historicalRef:"电子政务、区块链投票",description:"网络参与决策",issues:["liberty","progress"],conditionTypes:["coalition_size_above","stability_above","legitimacy_above"],preferredStrata:["engineer","scribe","worker"],stratumWeights:{engineer:2,scribe:2,worker:1.5},activeEffects:{legitimacyBonus:.18,stability:.12},unsatisfiedPenalty:{}},eco_socialism:{name:"生态社会主义",spectrum:"left",icon:"Leaf",color:"text-green-500",unlockEpoch:7,historicalRef:"绿色新政",description:"环境公正",issues:["equality","nature"],conditionTypes:["stratum_approval_above","stability_above"],preferredStrata:["worker","peasant","engineer"],stratumWeights:{worker:2,peasant:2,engineer:1.5},activeEffects:{needsReduction:.15,stability:.08},unsatisfiedPenalty:{}},transhumanism:{name:"超人类主义",spectrum:"right",icon:"Zap",color:"text-violet-400",unlockEpoch:7,historicalRef:"技术奇点",description:"超越人类极限",issues:["progress","efficiency"],conditionTypes:["epoch_at_least","stratum_income_above"],preferredStrata:["engineer","capitalist"],stratumWeights:{engineer:4,capitalist:2},activeEffects:{researchSpeed:.28,populationGrowth:.08},unsatisfiedPenalty:{}}},br={};Object.entries(Ec).forEach(([e,t])=>{br[e]={id:e,...t,triggerCondition:()=>!1,conditionText:"条件待生成"}});function Mr(e,t,o){return!o||o.length===0?!1:o.every(i=>{const r=xc[i.typeId];return r?r.check(i.params,t):!1})}const On={INITIAL_MIN:50,MAX:100,MIN:0,COUP_THRESHOLD:25,DAILY_CHANGES:{stanceSatisfied:.4,stanceUnsatisfied:-.3,financialSatisfied:.3,financialUncomfortable:-.1,financialStruggling:-.2,financialDesperate:-.25,stabilityHigh:.2,stabilityLow:-.1,salaryPaid:.15,salaryUnpaid:-.3}},Bn={STRATUM:"stratum",OFFICIAL:"official",FOREIGN:"foreign"};function Cc(e){return e===Bn.STRATUM}function _c(e,t,o,i,r){const a=[];let s=0;const u={};(o||[]).forEach(d=>{(d.ownedProperties||[]).forEach(M=>{if(M.buildingId===e){s+=1;const h=d.id||d.name||"unknown";u[h]=(u[h]||0)+1}})}),s>0&&a.push({ownerType:Bn.OFFICIAL,count:s,details:u});let c=0;const f={};(i||[]).forEach(d=>{if(d.buildingId===e&&d.status==="operating"){c+=1;const M=d.ownerNationId||"unknown";f[M]=(f[M]||0)+1}}),c>0&&a.push({ownerType:Bn.FOREIGN,count:c,details:f});const p=Math.max(0,t-s-c);return p>0&&a.push({ownerType:Bn.STRATUM,count:p,ownerStratum:(r==null?void 0:r.owner)||null}),a}const Di=(e,t,o=[])=>{const i=Be[e];return!(!i||i.unlockTech&&!o.includes(i.unlockTech)||typeof i.unlockEpoch=="number"&&i.unlockEpoch>t)},vr=e=>{var t;return((t=Be[e])==null?void 0:t.basePrice)||1},wr=(e,t,o=0)=>{var D,P,T,S;if(!t)return vr(e);const i=vr(e),r=(T=(P=(D=t==null?void 0:t.economyTraits)==null?void 0:D.resourceBias)==null?void 0:P[e])!=null?T:1,a=((S=t.inventory)==null?void 0:S[e])||0,s=Math.round(500*Math.pow(r,1.2)),u=Math.max(.8,Math.min(1.5,(t.wealth||1e3)/1e3)),c=t.epoch||0,f=1+c*.5+Math.pow(c,1.3)*.1,p=s*u*f,d=p>0?a/p:1,M=Math.max(0,1-d),h=Math.max(0,d-1),y=1+Math.min(2.5,M*.9),w=1-Math.min(.95,h*.6),m=y*w,v=1+(Math.max(.6,Math.min(1.6,r))-1)*.25,g=t.foreignWars?Object.values(t.foreignWars).filter(V=>V==null?void 0:V.isAtWar).length:0,C=(t.isAtWar?1:0)+g,R=C>0?1+Math.min(.75,C*.15):1;let k=i*v*m*R;return k=Math.max(i*.25,Math.min(i*4,k)),Math.max(.5,parseFloat(k.toFixed(2)))},Tc=(e="")=>e?e.split("").reduce((t,o)=>t+o.charCodeAt(0),0):0,Wi=(e,t={},o=0)=>{var C,R,k,D;const i=(k=(R=(C=t==null?void 0:t.economyTraits)==null?void 0:C.resourceBias)==null?void 0:R[e])!=null?k:1,r=Math.round(500*Math.pow(i,1.2)),a=Math.max(.8,Math.min(1.5,(t.wealth||1e3)/1e3)),s=t.epoch||0,u=1+s*.5+Math.pow(s,1.3)*.1,c=r*a*u,f=typeof t.marketVolatility=="number"?t.marketVolatility:.3,p=((D=t==null?void 0:t.inventory)==null?void 0:D[e])||0,d=Tc(e),M=Math.sin(o*.015+d),h=c*(1+M*f),y=i>1?.3:i<1?1.5:.8,w=i>1?.4:i<1?2:1.2,m=h*y,E=h*w,v=Math.max(0,m-p),g=Math.max(0,p-E);return{isShortage:v>0,isSurplus:g>0,shortageAmount:v,surplusAmount:g,target:h}},Oi={DESTITUTE:{level:"赤贫",icon:"Skull",color:"text-gray-400",bgColor:"bg-gray-900/30",borderColor:"border-gray-500/30",approvalCap:30},POOR:{level:"贫困",icon:"AlertTriangle",color:"text-red-400",bgColor:"bg-red-900/20",borderColor:"border-red-500/30",approvalCap:50},SUBSISTENCE:{level:"温饱",icon:"UtensilsCrossed",color:"text-yellow-400",bgColor:"bg-yellow-900/20",borderColor:"border-yellow-500/30",approvalCap:70},COMFORTABLE:{level:"小康",icon:"Home",color:"text-green-400",bgColor:"bg-green-900/20",borderColor:"border-green-500/30",approvalCap:85},PROSPEROUS:{level:"富裕",icon:"Gem",color:"text-blue-400",bgColor:"bg-blue-900/20",borderColor:"border-blue-500/30",approvalCap:95},LUXURIOUS:{level:"奢华",icon:"Crown",color:"text-purple-400",bgColor:"bg-purple-900/20",borderColor:"border-purple-500/30",approvalCap:100}};function Pc(e,t,o=0,i=100){if(t<=0){const a=i>0?o/i:0;return a<.5?a*20:a<1?10+(a-.5)*30:a<2?25+(a-1)*10:Math.min(50,35+(a-2)*5)}const r=(e-t)/t;return r>=1?50:r>=0?25+r*25:r>=-1?Math.max(0,25+r*25):0}function Ac(e,t,o=30,i=100){if(t<=0){const a=i>0?e/i:0;return a<.5?a*10:a<1?5+(a-.5)*10:Math.min(20,10+(a-1)*5)}const r=e/t;return Math.min(20,r/o*20)}function Rc(e){return e<20?Oi.DESTITUTE:e<40?Oi.POOR:e<55?Oi.SUBSISTENCE:e<70?Oi.COMFORTABLE:e<85?Oi.PROSPEROUS:Oi.LUXURIOUS}function Zi(e,t=1,o=1,i=6,r=!1){const a=Math.max(e,t*.3);let s;a<=0?s=.3:a<1?s=.3+a*.7:r?s=1+(a-1)*.8:s=1+Math.log(a)*.5;let u;s<=1?u=s*(.7+.3*Math.min(1.2,o)):u=1+(s-1)*o;let c;t<.3?c=.5:t<1?c=.5+(t-.3)*(.5/.7):t<2?c=1:r?c=1+(t-2)*.05*o:c=1+Math.min(.15,(t-2)*.025*o);let f=u*c;return t<.5?f=Math.min(f,.8):t<1?f=Math.min(f,1):t<2&&(f=Math.min(f,1.2)),Math.max(.3,Math.min(i,f))}function Sc({consumptionMultiplier:e=1,incomeRatio:t=null,wealthRatio:o=null,livingStandardLevel:i=null}={}){var M;const r=(h,y,w)=>Math.min(w,Math.max(y,h)),a=Number.isFinite(e)?Math.max(.3,e):1,s=Number.isFinite(t)?r(.4+.6*Math.min(1.5,t),.3,1.2):1,u=Number.isFinite(o)?r(.4+.6*Math.min(2,o)/2,.3,1.2):1,c=.6+.4*((s+u)/2),p=i&&(M={赤贫:.05,贫困:.15,温饱:.4,小康:.9,富裕:1.1,奢华:1.25}[i])!=null?M:1,d=a*p*c;return r(d,.05,1.6)}function Ic(e,t=1,o=1,i=null){if(e<1&&t<2)return 0;const r=Math.max(e,t*.5);let a;r<=0?a=.3:r<1?a=.3+r*.7:a=1+Math.log(r)*.7;const s=(o+1)/2;let u;a<=1?u=a*(.8+.2*Math.min(1.2,s)):u=1+(a-1)*s;let c;t<.3?c=.5:t<1?c=.5+(t-.3)*(.5/.7):t<2?c=1:c=1+Math.min(.25,(t-2)*.03);const f=u*c;let p=Math.max(.3,Math.min(10,f));if(!i)return p;const M={赤贫:0,贫困:0,温饱:1.49,小康:3,富裕:6,奢华:10}[i];return t<1&&(p=Math.min(p,.99)),M===void 0?p:Math.min(M,p)}function kc(e,t,o,i=1,r=100){const a=t*30;let s=e+a+o,u=0;r>0&&(u=Math.min(60,.7*Math.sqrt(r)));let c=0;i>0&&(c=Math.min(40,40*(1-Math.exp(-i*.5))));const f=u+c;return s*.5+f*.5}function Dc({count:e,income:t=0,expense:o=0,wealthValue:i=0,startingWealth:r=100,essentialCost:a=0,shortagesCount:s=0,effectiveNeedsCount:u=0,unlockedLuxuryTiers:c=0,totalLuxuryTiers:f=0,previousScore:p=null,isNewStratum:d=!1,maxConsumptionMultiplier:M=6,wealthElasticity:h=1,greedy:y=!1}){if(e<=0)return null;const w=t/e,m=o/e,E=i/e,v=a/e,g=Pc(w,v,E,r);let C;if(u>0)C=Math.max(0,(u-s)/u);else{const j=r>0?E/r:0;C=Math.min(1,j)}const R=Ac(E,m,30,r),k=r>0?E/r:0,D=kc(g,C,R,k,E),P=d?1:.15,T=p!==null?p*(1-P)+D*P:D,S=Rc(T),V=v>0?w/v:w>0?10:0,N=Zi(V,k,h,M,y),L=f>0?c/f:0;return{score:T,targetScore:D,incomeAdequacyScore:g,satisfactionRate:C,financialSecurityScore:R,incomePerCapita:w,expensePerCapita:m,wealthPerCapita:E,wealthMultiplier:N,wealthRatio:k,luxuryUnlockRatio:L,unlockedLuxuryTiers:c,totalLuxuryTiers:f,level:S.level,icon:S.icon,color:S.color,bgColor:S.bgColor,borderColor:S.borderColor,approvalCap:S.approvalCap}}function Wc(e){return e<.5?{icon:"Skull",color:"text-gray-400",level:"赤贫",approvalCap:30}:e<1?{icon:"AlertTriangle",color:"text-red-400",level:"贫困",approvalCap:50}:e<1.5?{icon:"UtensilsCrossed",color:"text-yellow-400",level:"温饱",approvalCap:70}:e<2.5?{icon:"Home",color:"text-green-400",level:"小康",approvalCap:85}:e<4?{icon:"Gem",color:"text-blue-400",level:"富裕",approvalCap:95}:{icon:"Crown",color:"text-purple-400",level:"奢华",approvalCap:100}}tr.reduce((e,t)=>(e[t.id]=t,e),{});const Xt=["official","cleric","capitalist","landowner","knight","engineer","navigator","merchant","soldier","scribe","worker","artisan","miner","lumberjack","serf","peasant"],Oc=.0025,Bc=.2,jc=.25,Nc=1e-4,Lc=1.5,Fc=2,Uc=1.5,$c=.8,xr=5,Gc=.5,Er=["food","cloth"],Bi=1e-4,jn=1,qc=new Set(["science","culture"]),Vc=45,Hc=30,Yc=.003,Xc=.001,Nn=20,zc=.4,Cr=200,Jc=.05,Ea=3,Zc=30,So={unemployed:0,serf:0,peasant:1,lumberjack:1,miner:1,worker:1,artisan:2,soldier:2,navigator:2,scribe:2,merchant:2,cleric:2,official:3,landowner:3,capitalist:3,knight:3,engineer:3},Qc={0:0,1:0,2:.5,3:.4},Kc={landowner:.35,capitalist:.35,soldier:0},e0=2,t0=.2,$t=(e,t,o)=>!Number.isFinite(e)||e<t?t:e>o?o:e,o0=1e12,Qi=(e,t=0)=>Number.isFinite(e)?Math.max(0,Math.min(e,o0)):t,Qt=e=>{if(e==="silver")return!1;const t=Be[e];return t?qc.has(e)?!0:!t.type||t.type!=="virtual":!1},Io=e=>{if(e==="silver")return 1;const t=Be[e];return(t==null?void 0:t.basePrice)||1},Ca=(e={},t=1)=>{if(!e||typeof e!="object")return{};const o={};return Object.entries(e).forEach(([i,r])=>{typeof r=="number"?o[i]=r*t:r&&typeof r=="object"&&!Array.isArray(r)?o[i]=Ca(r,t):o[i]=r}),o},i0=(e,t)=>{if(!e||!t)return{adjustments:{},approvalPenalties:{},adminCost:0};const o=Object.values(e).reduce((s,u)=>s+u,0),i={},r={};let a=0;return Object.entries(t).forEach(([s,u])=>{const c=e[s]||0,f=o>0?c/o*100:0,p=u-f;Math.abs(p)>1&&(i[s]=p*.1,p<-5&&(r[s]=Math.floor(p/2)),a+=Math.abs(p)*.5)}),{adjustments:i,approvalPenalties:r,adminCost:Math.round(a)}},n0=1,Ki=(e,t={},o={})=>{var y,w,m,E;if(!e)return{profit:0,outputValue:0,inputValue:0,wageCost:0,businessTax:0};const i=(t==null?void 0:t.prices)||{},r=(t==null?void 0:t.wages)||{},a=v=>{var g;return!v||v==="silver"?1:(g=i[v])!=null?g:1},s=Object.entries(e.output||{}).reduce((v,[g,C])=>v+a(g)*C,0),u=Object.entries(e.input||{}).reduce((v,[g,C])=>v+a(g)*C,0),c=(w=(y=o==null?void 0:o.businessTaxRates)==null?void 0:y[e.id])!=null?w:1,p=((m=e.businessTaxBase)!=null?m:.1)*c,d=e.owner;let M=0;for(const[v,g]of Object.entries(e.jobs||{})){if(v===d)continue;const C=(E=r[v])!=null?E:.1;M+=C*g}return{profit:s-u-p-M,outputValue:s,inputValue:u,wageCost:M,businessTax:p}},a0=(e,t,o,i,r,a={},s={},u={})=>{var E;if(!e||!t)return{canExpand:!1,reason:"无效建筑",cost:0,profit:0,roi:0};const c=i==null?void 0:i[e.id];if(!(c!=null&&c.allowed))return{canExpand:!1,reason:"未允许扩张",cost:0,profit:0,roi:0};const f=(a==null?void 0:a.prices)||{},p=e.baseCost||{};let d=0;for(const[v,g]of Object.entries(p)){const C=(E=f[v])!=null?E:1;d+=g*C}d=d>0?Math.round(d):100;const h=Ki(e,a,s).profit,y=d>0?h/d:0,w=u==null?void 0:u[e.id];return(Number.isFinite(w)?w:1)<n0?{canExpand:!1,reason:"岗位未满",cost:d,profit:h,roi:y}:h<=0?{canExpand:!1,reason:"建筑不盈利",cost:d,profit:h,roi:y}:o<d?{canExpand:!1,reason:"业主财富不足",cost:d,profit:h,roi:y}:{canExpand:!0,reason:null,cost:d,profit:h,roi:y}},r0=(e,t,o,i,r={},a={},s={})=>{const u=[],c={};if(!e||!t||!o)return console.log("[FREE MARKET] processOwnerExpansions early return:",{hasBuildings:!!e,hasClassWealth:!!t,hasExpansionSettings:!!o}),{expansions:u,wealthDeductions:c};const f=[],p={},d=[];for(const M of e){if(!M.owner)continue;const h=M.owner,y=t[h]||0,w=i[M.id]||0,{canExpand:m,reason:E,cost:v,profit:g,roi:C}=a0(M,h,y,o,w,r,a,s);if(m){const R=v>0?Math.max(.01,g*g/v):.01,k={buildingId:M.id,owner:h,cost:v,profit:g,roi:C,weight:R};f.push(k),p[h]||(p[h]=[]),p[h].push(k)}else d.push({buildingId:M.id,owner:h,ownerWealth:y,reason:E,cost:v,profit:g,roi:C,staffingRatio:s==null?void 0:s[M.id],settingsForBuilding:o[M.id]})}if(console.log("[FREE MARKET] processOwnerExpansions:",{totalBuildingsChecked:e.filter(M=>M.owner).length,candidatesFound:f.length,candidates:f.map(M=>({id:M.buildingId,profit:M.profit.toFixed(2),roi:(M.roi*100).toFixed(1)+"%",weight:M.weight.toFixed(2)})),firstFewRejections:d.slice(0,5)}),f.length>0){const M=[];Object.entries(p).forEach(([h,y])=>{if(!y.length)return;const w=e.filter(T=>T.owner===h).reduce((T,S)=>T+(i[S.id]||0),0),m=w%2===0?"roi":"profit",E=[...y].sort((T,S)=>S[m]-T[m]),v=Math.ceil(E.length/3),g=[E.slice(0,v),E.slice(v,v*2),E.slice(v*2)],C=w%3;let R=null;for(let T=0;T<g.length;T+=1){const S=(C+T)%g.length;if(g[S].length>0){R=g[S];break}}if(!R||R.length===0)return;const k=R.reduce((T,S)=>T+S.weight,0);let D=Math.random()*k,P=R[0];for(const T of R)if(D-=T.weight,D<=0){P=T;break}M.push({...P,_debug:{ownerBuildingTotal:w,metric:m,tierIndex:g.indexOf(R),probability:k>0?P.weight/k*100:0}})}),M.length>0&&(console.log("[FREE MARKET] Selected for expansion:",M.map(h=>({buildingId:h.buildingId,owner:h.owner,profit:h.profit.toFixed(2),roi:(h.roi*100).toFixed(1)+"%",weight:h.weight.toFixed(2),metric:h._debug.metric,tierIndex:h._debug.tierIndex,probability:h._debug.probability.toFixed(1)+"%"}))),M.forEach(h=>{u.push(h),c[h.owner]=(c[h.owner]||0)+h.cost}))}return{expansions:u,wealthDeductions:c}},s0=(e,t,o,i)=>{var u;if(!(i!=null&&i.enabled))return{adjustment:0,isIncome:!1,effectivePrice:o};const r=(u=i.governmentSellPrices)==null?void 0:u[e];if(r==null)return{adjustment:0,isIncome:!1,effectivePrice:o};const a=r,s=(r-o)*t;return s>0?{adjustment:s,isIncome:!0,effectivePrice:a}:s<0?{adjustment:Math.abs(s),isIncome:!1,effectivePrice:a}:{adjustment:0,isIncome:!1,effectivePrice:o}},c0=(e,t,o,i)=>{var u;if(!(i!=null&&i.enabled))return{adjustment:0,isIncome:!1,effectivePrice:o};const r=(u=i.governmentBuyPrices)==null?void 0:u[e];if(r==null)return{adjustment:0,isIncome:!1,effectivePrice:o};const a=r;return{adjustment:r*t,isIncome:!1,effectivePrice:a}},_r=({resourceKey:e,amount:t,marketPrice:o,priceControls:i,taxBreakdown:r,resources:a,onTreasuryChange:s,applyTreasuryChange:u})=>{const c=s0(e,t,o,i);if(c.adjustment>0)if(c.isIncome)r.priceControlIncome=(r.priceControlIncome||0)+c.adjustment;else{const f=a.silver||0;if(f>=c.adjustment)typeof u=="function"?u(-c.adjustment,"price_control_buy"):(a.silver=f-c.adjustment,typeof s=="function"&&s(-c.adjustment,"price_control_buy")),r.priceControlExpense=(r.priceControlExpense||0)+c.adjustment;else return{effectivePrice:o,success:!1}}return{effectivePrice:c.effectivePrice,success:!0}},l0=({resourceKey:e,amount:t,marketPrice:o,priceControls:i,taxBreakdown:r,resources:a,onTreasuryChange:s,applyTreasuryChange:u})=>{const c=c0(e,t,o,i);if(c.adjustment>0)if(c.isIncome)r.priceControlIncome=(r.priceControlIncome||0)+c.adjustment;else{const f=a.silver||0;if(f>=c.adjustment)typeof u=="function"?u(-c.adjustment,"price_control_sell"):(a.silver=f-c.adjustment,typeof s=="function"&&s(-c.adjustment,"price_control_sell")),r.priceControlExpense=(r.priceControlExpense||0)+c.adjustment;else return{effectivePrice:o,success:!1}}return{effectivePrice:c.effectivePrice,success:!0}},xo={VERY_EASY:"very_easy",EASY:"easy",NORMAL:"normal",HARD:"hard",VERY_HARD:"very_hard",EXTREME:"extreme"},_a=xo.EASY,Tr={[xo.VERY_EASY]:{id:xo.VERY_EASY,name:"和平",description:"极其轻松，专注于建设，几乎没有战争威胁",icon:"🕊️",organizationGrowthMultiplier:.2,organizationDecayMultiplier:2,satisfactionThreshold:25,buildingCostGrowthFactor:1.05,aiWarDeclarationChance:.1,aiMilitaryActionChance:.2,aiMilitaryCooldownBonus:30,aiMinWarEpoch:4,raidDamageMultiplier:.3,raidPopulationLossMultiplier:.2,stabilityDampeningBonus:.25,newGameGracePeriod:150,inventoryTargetDaysMultiplier:.5,taxToleranceMultiplier:2,resourceConsumptionMultiplier:.9,buildingCostBaseMultiplier:1,techCostMultiplier:1,populationGrowthMultiplier:1.5,buildingUpgradeCostMultiplier:1,armyMaintenanceMultiplier:.5,maxConsumptionMultiplierBonus:-1,goodRelationChangeMultiplier:1.25,badRelationChangeMultiplier:.75,relationDailyDriftRate:.015,relationMonthlyDriftRateAlly:.04,relationMonthlyDriftRateNonAlly:.12,allyColdEventCooldown:120,allyColdEventChance:.002,initialBuildings:{farm:3,lumber_camp:3,quarry:2,loom_house:2,market:1}},[xo.EASY]:{id:xo.EASY,name:"简单",description:"适合新手，叛乱增长减半，敌人攻击概率降低",icon:"🌱",organizationGrowthMultiplier:.5,organizationDecayMultiplier:1.5,satisfactionThreshold:35,buildingCostGrowthFactor:1.1,aiWarDeclarationChance:.5,aiMilitaryActionChance:.5,aiMilitaryCooldownBonus:15,aiMinWarEpoch:3,raidDamageMultiplier:.6,raidPopulationLossMultiplier:.5,stabilityDampeningBonus:.15,newGameGracePeriod:100,inventoryTargetDaysMultiplier:.7,taxToleranceMultiplier:1.5,resourceConsumptionMultiplier:1,buildingCostBaseMultiplier:1.2,techCostMultiplier:1.2,populationGrowthMultiplier:1.2,buildingUpgradeCostMultiplier:1.2,armyMaintenanceMultiplier:.75,maxConsumptionMultiplierBonus:0,goodRelationChangeMultiplier:1.1,badRelationChangeMultiplier:.9,relationDailyDriftRate:.018,relationMonthlyDriftRateAlly:.045,relationMonthlyDriftRateNonAlly:.16,allyColdEventCooldown:90,allyColdEventChance:.003,initialBuildings:{farm:2,lumber_camp:2,quarry:1,loom_house:1}},[xo.NORMAL]:{id:xo.NORMAL,name:"普通",description:"标准游戏体验",icon:"⚖️",organizationGrowthMultiplier:1,organizationDecayMultiplier:1,satisfactionThreshold:45,buildingCostGrowthFactor:1.15,aiWarDeclarationChance:1,aiMilitaryActionChance:1,aiMilitaryCooldownBonus:0,aiMinWarEpoch:2,raidDamageMultiplier:1,raidPopulationLossMultiplier:1,stabilityDampeningBonus:0,newGameGracePeriod:0,inventoryTargetDaysMultiplier:1,taxToleranceMultiplier:1,resourceConsumptionMultiplier:1,buildingCostBaseMultiplier:1.5,techCostMultiplier:1.5,populationGrowthMultiplier:1,buildingUpgradeCostMultiplier:1.5,armyMaintenanceMultiplier:1,maxConsumptionMultiplierBonus:0,goodRelationChangeMultiplier:1,badRelationChangeMultiplier:1,relationDailyDriftRate:.02,relationMonthlyDriftRateAlly:.05,relationMonthlyDriftRateNonAlly:.2,allyColdEventCooldown:60,allyColdEventChance:.004,initialBuildings:{farm:1,lumber_camp:1,loom_house:1}},[xo.HARD]:{id:xo.HARD,name:"困难",description:"高难度挑战，叛乱更频繁，敌人更具侵略性",icon:"🔥",organizationGrowthMultiplier:1.5,organizationDecayMultiplier:.5,satisfactionThreshold:60,buildingCostGrowthFactor:1.25,aiWarDeclarationChance:2,aiMilitaryActionChance:1.5,aiMilitaryCooldownBonus:-5,aiMinWarEpoch:1,raidDamageMultiplier:1.5,raidPopulationLossMultiplier:1.5,stabilityDampeningBonus:-.1,newGameGracePeriod:0,inventoryTargetDaysMultiplier:3,taxToleranceMultiplier:.7,resourceConsumptionMultiplier:3,buildingCostBaseMultiplier:3,techCostMultiplier:3,startingSilverMultiplier:4,populationGrowthMultiplier:.8,buildingUpgradeCostMultiplier:3,armyMaintenanceMultiplier:1.5,maxConsumptionMultiplierBonus:2,goodRelationChangeMultiplier:.75,badRelationChangeMultiplier:1.25,relationDailyDriftRate:.03,relationMonthlyDriftRateAlly:.08,relationMonthlyDriftRateNonAlly:.35,allyColdEventCooldown:45,allyColdEventChance:.005,initialBuildings:{farm:1,lumber_camp:1}},[xo.VERY_HARD]:{id:xo.VERY_HARD,name:"灾厄",description:"极高难度，内忧外患接踵而至，生存即是胜利",icon:"☠️",organizationGrowthMultiplier:2,organizationDecayMultiplier:.2,satisfactionThreshold:75,buildingCostGrowthFactor:1.3,aiWarDeclarationChance:3.5,aiMilitaryActionChance:2.5,aiMilitaryCooldownBonus:-10,aiMinWarEpoch:0,raidDamageMultiplier:2.5,raidPopulationLossMultiplier:2.5,stabilityDampeningBonus:-.2,newGameGracePeriod:0,inventoryTargetDaysMultiplier:8,taxToleranceMultiplier:.4,resourceConsumptionMultiplier:5,buildingCostBaseMultiplier:5,techCostMultiplier:6,startingSilverMultiplier:6,populationGrowthMultiplier:.5,buildingUpgradeCostMultiplier:5,armyMaintenanceMultiplier:2,maxConsumptionMultiplierBonus:4,goodRelationChangeMultiplier:.6,badRelationChangeMultiplier:1.6,relationDailyDriftRate:.04,relationMonthlyDriftRateAlly:.1,relationMonthlyDriftRateNonAlly:.5,allyColdEventCooldown:60,allyColdEventChance:.004,initialBuildings:{farm:1}},[xo.EXTREME]:{id:xo.EXTREME,name:"地狱",description:"绝望的深渊，只有最完美的策略才能存活",icon:"👿",organizationGrowthMultiplier:3,organizationDecayMultiplier:.05,satisfactionThreshold:80,buildingCostGrowthFactor:1.4,aiWarDeclarationChance:5,aiMilitaryActionChance:5,aiMilitaryCooldownBonus:-20,aiMinWarEpoch:0,raidDamageMultiplier:5,raidPopulationLossMultiplier:5,stabilityDampeningBonus:-.5,newGameGracePeriod:0,inventoryTargetDaysMultiplier:20,taxToleranceMultiplier:.2,resourceConsumptionMultiplier:8,buildingCostBaseMultiplier:10,techCostMultiplier:10,startingSilverMultiplier:10,populationGrowthMultiplier:.2,buildingUpgradeCostMultiplier:10,armyMaintenanceMultiplier:3,maxConsumptionMultiplierBonus:8,goodRelationChangeMultiplier:.45,badRelationChangeMultiplier:2,relationDailyDriftRate:.05,relationMonthlyDriftRateAlly:.12,relationMonthlyDriftRateNonAlly:.7,allyColdEventCooldown:90,allyColdEventChance:.003,initialBuildings:{loom_house:1}}};function no(e){return Tr[e]||Tr[_a]}function Pr(e,t){const o=no(t);return e*o.aiWarDeclarationChance}function u0(e,t){const o=no(t);return e*o.aiMilitaryActionChance}function f0(e){return no(e).aiMinWarEpoch}function d0(e){return no(e).aiMilitaryCooldownBonus}function ji(e,t){const o=no(t);return Math.floor(e*o.raidDamageMultiplier)}function Ar(e,t){const o=no(t);return Math.floor(e*o.raidPopulationLossMultiplier)}function Rr(e,t){const o=no(t);return e<o.newGameGracePeriod}function Sr(e){return no(e).buildingCostGrowthFactor||1.15}function p0(e){return no(e).inventoryTargetDaysMultiplier||1}function Ir(e){var o,i;const t=no(e);return{good:(o=t.goodRelationChangeMultiplier)!=null?o:1,bad:(i=t.badRelationChangeMultiplier)!=null?i:1}}function h0(e){var o;return(o=no(e).relationDailyDriftRate)!=null?o:.02}function m0(e){var o;return(o=no(e).allyColdEventCooldown)!=null?o:60}function g0(e){var o;return(o=no(e).allyColdEventChance)!=null?o:.004}function y0(e){return no(e).populationGrowthMultiplier||1}function b0(e){return no(e).armyMaintenanceMultiplier||1}function kr(e){return no(e).maxConsumptionMultiplierBonus||0}const M0=({popStructure:e,wealth:t,classIncome:o,classExpense:i,classShortages:r,epoch:a,techsUnlocked:s,priceMap:u={},livingStandardStreaks:c={}})=>{const f={},p={};return Object.keys(ae).forEach(d=>{var de,Y,Re,Ke;const M=e[d]||0;if(M===0){f[d]=null,p[d]={streak:0,level:null,score:null};return}const h=ae[d],y=t[d]||0,w=(o==null?void 0:o[d])||0,m=(i==null?void 0:i[d])||0,E=h.startingWealth||100,v=(r[d]||[]).length,g=h.needs||{};let C=0;const R=["food","cloth"],k=Le=>typeof u=="function"?u(Le)||Io(Le):u[Le]||Io(Le);R.forEach(Le=>{if(g[Le]&&Di(Le,a,s)){const _t=g[Le]*M,K=k(Le),Ce=Io(Le),fe=Math.max(K,Ce);C+=_t*fe}});const D=h.luxuryNeeds||{},P=Object.keys(D).map(Number).sort((Le,_t)=>Le-_t),T=h.wealthElasticity||1,S=M>0?w/M:0,V=M>0?C/M:0,N=V>0?S/V:S>0?10:0,L=M>0?y/M:0,W=E>0?L/E:0,j=h.maxConsumptionMultiplier||6;Zi(N,W,T,j);const H=Zi(N,W,T,10),ce=h.needs?Object.keys(h.needs).filter(Le=>Di(Le,a,s)).length:0;let me=0,U=ce;for(const Le of P)if(H>=Le){me++;const _t=D[Le],Ce=Object.keys(_t).filter(fe=>Di(fe,a,s)).filter(fe=>{var He;return!((He=h.needs)!=null&&He[fe])});U+=Ce.length}const J=(c==null?void 0:c[d])||{},ye=(de=J.score)!=null?de:null,te=ye===null;f[d]=Dc({count:M,income:w,expense:m,wealthValue:y,startingWealth:E,essentialCost:C,shortagesCount:v,effectiveNeedsCount:U,unlockedLuxuryTiers:me,totalLuxuryTiers:P.length,previousScore:ye,isNewStratum:te,maxConsumptionMultiplier:j,wealthElasticity:T,greedy:h.greedy});const le=J.streak||0,we=((Y=f[d])==null?void 0:Y.level)||null,ue=(Ke=(Re=f[d])==null?void 0:Re.score)!=null?Ke:null;let Ie=le;we==="赤贫"||we==="贫困"?Ie=le+1:Ie=Math.max(0,le-1),p[d]={streak:Ie,level:we,score:ue}}),{classLivingStandard:f,livingStandardStreaks:p}},v0={event:!1,gameLoop:!1,mainThread:!1,simulation:!1,trade:!1,demands:!1},Dr=(e=[])=>{const t={};return e.forEach(o=>{const i=String(o||"").trim();i&&(t[i]=!0)}),t},Ta=e=>{if(e==null)return null;if(e===!0)return!0;if(e===!1)return null;if(typeof e=="string"){const t=e.trim();if(!t)return null;if(t==="true"||t==="all")return!0;try{const o=JSON.parse(t);return Ta(o)}catch(o){const i=t.split(",").map(r=>r.trim()).filter(Boolean);return i.length>0?Dr(i):null}}return Array.isArray(e)?Dr(e):typeof e=="object"?e:null};let en=null,Wr;const w0=()=>{const t=(typeof globalThis!="undefined"?globalThis:{}).__CIV_DEBUG__;if(t!==Wr&&(Wr=t,en=null),en)return en;let o=Ta(t);if(!o&&typeof localStorage!="undefined")try{o=Ta(localStorage.getItem("civ_debug_flags"))}catch(i){o=null}return en=o||v0,en},x0=e=>{const t=w0();return t===!0?!0:!!(t!=null&&t[e])},tn=(e,...t)=>{x0(e)&&console.log(...t)},E0={trade_agreement:{name:"贸易协定",tariffMultiplier:.85,extraMerchantSlotsPercent:.2,tradeEfficiencyBonus:.08,relationDecayReduction:.1},open_market:{name:"开放市场",tariffMultiplier:.9,extraMerchantSlots:1/0,tradeEfficiencyBonus:0,allowForceTrade:!0,bypassRelationCap:!0},free_trade:{name:"自由贸易协定",tariffMultiplier:0,extraMerchantSlotsPercent:.5,relationDecayReduction:.3},investment_pact:{name:"投资协议",tariffMultiplier:.9,extraMerchantSlots:1,overseasBuildingAccess:!0,profitRepatriationRate:1},non_aggression:{name:"互不侵犯条约",tariffMultiplier:1,extraMerchantSlots:0,relationDecayReduction:.5},peace_treaty:{name:"和平条约",tariffMultiplier:1,extraMerchantSlots:0},academic_exchange:{name:"学术交流",tariffMultiplier:1,extraMerchantSlots:0,techBonus:.05},defensive_pact:{name:"共同防御",tariffMultiplier:.9,extraMerchantSlots:1,mutualDefense:!0},military_alliance:{name:"军事同盟",tariffMultiplier:.85,extraMerchantSlots:2,mutualDefense:!0,relationDecayReduction:.8},economic_bloc:{name:"经济共同体",tariffMultiplier:.6,extraMerchantSlots:5,tradeEfficiencyBonus:.4,overseasBuildingAccess:!0}},C0=(e,t)=>!(e!=null&&e.treaties)||!Array.isArray(e.treaties)?[]:e.treaties.filter(o=>o&&(!Number.isFinite(o.endDay)||t<o.endDay)),Pa=(e,t)=>{const o=C0(e,t),i={tariffMultiplier:1,extraMerchantSlots:0,extraMerchantSlotsPercent:0,tradeEfficiencyBonus:0,hasOverseasAccess:!1,hasMutualDefense:!1,relationDecayReduction:0,techBonus:0,hasPriceConvergence:!1,allowForceTrade:!1,bypassRelationCap:!1,activeTreatyTypes:[]};if(o.length===0)return i;i.activeTreatyTypes=o.map(r=>r.type);for(const r of o){const a=E0[r.type];a&&(a.tariffMultiplier!==void 0&&(i.tariffMultiplier=Math.min(i.tariffMultiplier,a.tariffMultiplier)),a.extraMerchantSlots!==void 0&&(a.extraMerchantSlots===1/0?i.extraMerchantSlots=1/0:i.extraMerchantSlots!==1/0&&(i.extraMerchantSlots+=a.extraMerchantSlots)),a.extraMerchantSlotsPercent!==void 0&&(i.extraMerchantSlotsPercent+=a.extraMerchantSlotsPercent),a.tradeEfficiencyBonus!==void 0&&(i.tradeEfficiencyBonus=Math.max(i.tradeEfficiencyBonus,a.tradeEfficiencyBonus)),a.overseasBuildingAccess&&(i.hasOverseasAccess=!0),a.mutualDefense&&(i.hasMutualDefense=!0),a.priceConvergence&&(i.hasPriceConvergence=!0),a.allowForceTrade&&(i.allowForceTrade=!0),a.bypassRelationCap&&(i.bypassRelationCap=!0),a.relationDecayReduction!==void 0&&(i.relationDecayReduction=Math.max(i.relationDecayReduction,a.relationDecayReduction)),a.techBonus!==void 0&&(i.techBonus+=a.techBonus))}return i},Or={DAILY_CONVERGENCE_RATE:.05,MIN_PRICE_DIFF_RATIO:.1};function _0(e,t,o=Or.DAILY_CONVERGENCE_RATE){if(!e||!t)return{playerPrice:e,nationPrice:t,changed:!1};const i=(e+t)/2,r=i*Or.MIN_PRICE_DIFF_RATIO;if(Math.abs(e-t)<=r)return{playerPrice:e,nationPrice:t,changed:!1};const s=e+(i-e)*o,u=t+(i-t)*o;return{playerPrice:Math.round(s*100)/100,nationPrice:Math.round(u*100)/100,changed:!0,convergenceAmount:Math.abs(s-e)}}function T0(e,t,o){const i={...e},r=[],a=[],s=t.filter(c=>!c||c.isPlayer?!1:Pa(c,o).hasPriceConvergence);if(s.length===0)return{marketPrices:i,nationPriceUpdates:r,logs:a};const u=Object.keys(e);for(const c of s){const f=c.nationPrices||{},p={...f};let d=!1;for(const M of u){const h=i[M],y=f[M];if(!h||!y)continue;const w=_0(h,y);w.changed&&(i[M]=w.playerPrice,p[M]=w.nationPrice,d=!0)}d&&r.push({nationId:c.id,nationPrices:p})}if(r.length>0&&o%10===0){const c=s.slice(0,3).map(p=>p.name).join("、"),f=s.length>3?`等${s.length}国`:"";a.push(`📊 自由贸易效应：与${c}${f}的市场价格正在趋同。`)}return{marketPrices:i,nationPriceUpdates:r,logs:a}}const Aa=[{name:"封建地主专制",priority:1e3,description:"由大地主阶级独揽政权",icon:"Castle",color:"text-amber-500",conditions:{exactCoalition:["landowner"]},effects:{categories:{gather:.15},buildingProductionMod:{farm:.2,large_estate:.2},resourceDemandMod:{food:-.1}}},{name:"垄断资本独裁",priority:1e3,description:"资本家独占国家权力",icon:"Briefcase",color:"text-blue-400",conditions:{exactCoalition:["capitalist"]},effects:{industry:.2,buildingProductionMod:{factory:.25,steel_works:.2},taxIncome:.15}},{name:"军事贵族专政",priority:1e3,description:"骑士阶层掌控一切",icon:"Shield",color:"text-red-500",conditions:{exactCoalition:["knight"]},effects:{militaryBonus:.25,buildingProductionMod:{barracks:.2,training_ground:.2},stability:.05}},{name:"官僚集权",priority:1e3,description:"官僚阶层垄断政权",icon:"ScrollText",color:"text-purple-400",conditions:{exactCoalition:["official"]},effects:{production:.1,taxIncome:.12,cultureBonus:.08,officialCapacity:5}},{name:"商业寡头政治",priority:1e3,description:"商人阶层掌控国家",icon:"Coins",color:"text-yellow-400",conditions:{exactCoalition:["merchant"]},effects:{buildingProductionMod:{market:.25,trade_port:.2,trading_post:.15},taxIncome:.15}},{name:"神权政治",priority:1e3,description:"神职人员统治国家",icon:"Cross",color:"text-indigo-400",conditions:{exactCoalition:["cleric"]},effects:{cultureBonus:.25,stability:.1,scienceBonus:-.15}},{name:"军人专政",priority:1e3,description:"军队独揽大权",icon:"Swords",color:"text-red-400",conditions:{exactCoalition:["soldier"]},effects:{militaryBonus:.3,buildingProductionMod:{barracks:.25,fortress:.2},stability:-.05}},{name:"工人无产阶级专政",priority:1e3,description:"工人阶级独揽政权",icon:"Hammer",color:"text-red-600",conditions:{exactCoalition:["worker"]},effects:{industry:.18,stratumDemandMod:{worker:-.12},taxIncome:-.1}},{name:"农民专政",priority:1e3,description:"农民阶级掌控政权",icon:"Wheat",color:"text-green-500",conditions:{exactCoalition:["peasant"]},effects:{categories:{gather:.2},buildingProductionMod:{farm:.18},resourceDemandMod:{food:-.1}}},{name:"技术官僚政治",priority:1e3,description:"工程师主导国家",icon:"Cog",color:"text-cyan-400",conditions:{exactCoalition:["engineer"]},effects:{scienceBonus:.25,industry:.12,buildingProductionMod:{library:.2,university:.25},officialCapacity:4}},{name:"学者治国",priority:1e3,description:"知识分子掌权",icon:"Feather",color:"text-blue-300",conditions:{exactCoalition:["scribe"]},effects:{scienceBonus:.2,cultureBonus:.15,militaryBonus:-.1}},{name:"行会共和",priority:1e3,description:"工匠行会主政",icon:"Anvil",color:"text-orange-400",conditions:{exactCoalition:["artisan"]},effects:{buildingProductionMod:{loom_house:.25,furniture_workshop:.2,tailor_workshop:.15},industry:.15}},{name:"海上共和国",priority:1e3,description:"航海家主导政权",icon:"Compass",color:"text-teal-400",conditions:{exactCoalition:["navigator"]},effects:{buildingProductionMod:{dockyard:.3,trade_port:.25},taxIncome:.1}},{name:"矿业工人政权",priority:1e3,description:"矿工阶级执政",icon:"Pickaxe",color:"text-gray-400",conditions:{exactCoalition:["miner"]},effects:{buildingProductionMod:{mine:.3,quarry:.25},categories:{gather:.15}}},{name:"农奴起义政权",priority:1e3,description:"佃农阶级执政",icon:"Users",color:"text-brown-400",conditions:{exactCoalition:["serf"]},effects:{categories:{gather:.12},stratumDemandMod:{serf:-.1},stability:-.1}},{name:"林业工人政权",priority:1e3,description:"樵夫阶级执政",icon:"Trees",color:"text-green-600",conditions:{exactCoalition:["lumberjack"]},effects:{buildingProductionMod:{lumber_camp:.3},categories:{gather:.12}}},{name:"独裁政体",priority:999,description:"单一阶层执政",icon:"Crown",color:"text-amber-400",conditions:{maxSize:1},effects:{stability:-.05,taxIncome:.05,officialCapacity:2}},{name:"工农联合政府",priority:910,description:"工人和农民阶级联合执政",icon:"Handshake",color:"text-red-500",conditions:{includes:["worker","peasant"],minCategoryShare:{proletariat:.7},maxSize:2},effects:{categories:{gather:.12},industry:.1,stratumDemandMod:{peasant:-.08,worker:-.08}}},{name:"人民民主专政",priority:900,description:"以工农联盟为基础的人民政权",icon:"Users",color:"text-red-600",conditions:{includes:["worker","peasant"],minCategoryShare:{proletariat:.7}},effects:{categories:{gather:.1},industry:.12,stratumDemandMod:{peasant:-.15,worker:-.15},taxIncome:-.15}},{name:"资产阶级共和国",priority:900,description:"资产阶级主导的民主政体",icon:"Building2",color:"text-blue-400",conditions:{minCategoryShare:{bourgeoisie:.6},excludes:["landowner","knight"],includesAny:["worker","artisan"]},effects:{industry:.15,taxIncome:.12,buildingProductionMod:{market:.1},officialCapacity:3}},{name:"资本主义寡头政治",priority:890,description:"资产阶级独占政权",icon:"Briefcase",color:"text-blue-500",conditions:{minCategoryShare:{bourgeoisie:.6},excludes:["landowner","knight"]},effects:{industry:.18,taxIncome:.18,buildingProductionMod:{factory:.2}}},{name:"封建神权联盟",priority:900,description:"传统贵族与教会联合执政",icon:"Crown",color:"text-purple-500",conditions:{minCategoryShare:{aristocracy:.6},includes:["cleric"]},effects:{categories:{gather:.12},cultureBonus:.15,stability:.08,scienceBonus:-.1}},{name:"贵族寡头政治",priority:890,description:"传统贵族阶层联合执政",icon:"Castle",color:"text-amber-500",conditions:{minCategoryShare:{aristocracy:.6}},effects:{categories:{gather:.1},taxIncome:.12,stratumDemandMod:{landowner:.1}}},{name:"军事-精英联盟",priority:900,description:"军队与精英阶层联合执政",icon:"Shield",color:"text-red-500",conditions:{minCategoryShare:{military:.5},includesAny:["capitalist","landowner"]},effects:{militaryBonus:.2,buildingProductionMod:{barracks:.15},taxIncome:.08}},{name:"军人政府",priority:890,description:"军事力量主导的政权",icon:"Swords",color:"text-red-600",conditions:{minCategoryShare:{military:.5}},effects:{militaryBonus:.22,buildingProductionMod:{barracks:.2},stability:-.03}},{name:"全民联合政府",priority:850,description:"跨越阶级的广泛联盟",icon:"Globe",color:"text-green-400",conditions:{minSize:8,includesGroup:["upper","middle","lower"]},effects:{production:.08,stratumDemandMod:{peasant:-.05,worker:-.05},stability:.12,officialCapacity:4}},{name:"民族团结政府",priority:840,description:"各阶层联合执政",icon:"Users",color:"text-teal-400",conditions:{minSize:5,includesGroup:["upper","middle","lower"]},effects:{production:.05,stability:.1,maxPop:15}},{name:"人民阵线",priority:830,description:"以劳动阶层为主体的广泛联盟",icon:"Flag",color:"text-red-500",conditions:{minSize:5,minCategoryShare:{proletariat:.5}},effects:{categories:{gather:.1},industry:.1,stratumDemandMod:{peasant:-.1,worker:-.1}}},{name:"大联盟政府",priority:800,description:"多阶层联合执政",icon:"Users",color:"text-blue-400",conditions:{minSize:5},effects:{production:.05,stability:.05}},{name:"工业资本主义政府",priority:700,description:"工业资产阶级主导",icon:"Factory",color:"text-blue-500",conditions:{minCategoryShare:{industrial:.6},includes:["capitalist"]},effects:{industry:.2,buildingProductionMod:{factory:.18},taxIncome:.12,resourceDemandMod:{food:.1}}},{name:"劳工联合政府",priority:700,description:"工业劳动者联合执政",icon:"Hammer",color:"text-orange-500",conditions:{minCategoryShare:{industrial:.6},includes:["worker","artisan"]},effects:{industry:.15,buildingProductionMod:{loom_house:.12},stratumDemandMod:{worker:-.08,artisan:-.08}}},{name:"地主-农民联盟",priority:700,description:"农村阶层联合执政",icon:"Wheat",color:"text-green-500",conditions:{minCategoryShare:{agrarian:.6},includes:["landowner"],minCategoryShare2:{proletariat:.001}},conditions:{minCategoryShare:{agrarian:.6,proletariat:1e-4},includes:["landowner"]},effects:{categories:{gather:.18},buildingProductionMod:{farm:.15},resourceDemandMod:{food:-.08}}},{name:"农民政府",priority:690,description:"农民阶级主导政权",icon:"Wheat",color:"text-green-600",conditions:{minCategoryShare:{agrarian:.6,proletariat:.5}},effects:{categories:{gather:.18},buildingProductionMod:{farm:.18},resourceDemandMod:{food:-.1}}},{name:"商业共和国",priority:700,description:"商业阶层主导政权",icon:"Ship",color:"text-teal-400",conditions:{minCategoryShare:{commercial:.5}},effects:{buildingProductionMod:{market:.2,trade_port:.18},taxIncome:.12}},{name:"技术精英政府",priority:700,description:"知识分子联合执政",icon:"GraduationCap",color:"text-cyan-400",conditions:{includes:["scribe","engineer"]},effects:{scienceBonus:.18,industry:.1,buildingProductionMod:{library:.15,university:.15},officialCapacity:3}},{name:"无产阶级政府",priority:600,description:"劳动人民掌握政权",icon:"Hammer",color:"text-red-500",conditions:{minCategoryShare:{proletariat:.7}},effects:{categories:{gather:.12},industry:.12,stratumDemandMod:{peasant:-.1,worker:-.1},taxIncome:-.1}},{name:"精英联盟政府",priority:600,description:"上层阶级联合执政",icon:"Crown",color:"text-amber-400",conditions:{minTotalShare:[{categories:["bourgeoisie","aristocracy"],threshold:.7}]},effects:{taxIncome:.15,stratumDemandMod:{landowner:.08,capitalist:.08}}},{name:"双头政治",priority:100,description:"两个阶层联合执政",icon:"Scale",color:"text-gray-400",conditions:{exactSize:2},effects:{stability:.03}},{name:"三方联盟",priority:100,description:"三个阶层共同执政",icon:"Triangle",color:"text-gray-400",conditions:{exactSize:3},effects:{stability:.05}},{name:"联合政府",priority:0,description:"多阶层联合执政",icon:"Users",color:"text-gray-400",conditions:{},effects:{stability:.03}},{name:"无执政联盟",priority:-1,description:"尚未建立执政联盟，政府缺乏社会基础",icon:"HelpCircle",color:"text-gray-400",conditions:{maxSize:0},effects:{production:-.1,taxIncome:-.2,stability:-.15}}],P0=e=>Aa.find(t=>t.name===e),A0=e=>{const t=P0(e);return t?t.effects:null},on={HIGH:"high",MEDIUM:"medium",LOW:"low",ILLEGITIMATE:"illegitimate"},R0={赤贫:10,贫困:10,温饱:15,小康:15,富裕:10,奢华:0};function S0(e,t,o){if(!Array.isArray(e)||e.length===0||o<=0)return 0;let i=0;return e.forEach(r=>{i+=t[r]||0}),i/o}function I0(e,t={}){const{classApproval:o={},coalitionMembers:i=[],classInfluence:r={}}=t;let a=e*100;if(i.length>0&&Object.keys(o).length>0){let s=0,u=0;i.forEach(f=>{var M;const p=(M=o[f])!=null?M:50,d=r[f]||1;u+=p*d,s+=d});const c=s>0?u/s:50;if(c<50){const f=.5+c/100;a*=f}}return Math.min(100,Math.max(0,a))}function k0(e){return e>=80?on.HIGH:e>=60?on.MEDIUM:e>=40?on.LOW:on.ILLEGITIMATE}function Br(e){return .3+Math.min(100,Math.max(0,e))/100*.7}function D0(e){return k0(e)===on.ILLEGITIMATE?-15:0}function W0(e,t){return Array.isArray(t)&&t.includes(e)}function O0(e,t){return R0[e]||0}const B0={aristocracy:["landowner","knight","official"],bourgeoisie:["capitalist","merchant","engineer"],proletariat:["worker","miner","peasant","serf","lumberjack"],military:["soldier","knight"],clerical:["cleric"],intellectual:["scribe","engineer"],commercial:["merchant","navigator"],agrarian:["peasant","serf","landowner","lumberjack"],industrial:["worker","artisan","capitalist","engineer","miner"]},j0={upper:{name:"上流阶级",keys:["merchant","official","landowner","capitalist","knight","engineer"]},middle:{name:"中产阶级",keys:["artisan","soldier","cleric","scribe","navigator"]},lower:{name:"下层阶级",keys:["peasant","serf","lumberjack","worker","miner"]}};function N0(e,t,o){if(!Array.isArray(e)||e.length===0)return L0("无执政联盟")||{name:"无执政联盟",description:"尚未建立执政联盟，政府缺乏社会基础",icon:"HelpCircle",color:"text-gray-400"};let i=0;e.forEach(c=>{i+=t[c]||0});const r={},a=c=>{let f=0;return(B0[c]||[]).forEach(d=>{e.includes(d)&&(f+=t[d]||0)}),f},s=c=>{if(r[c]!==void 0)return r[c];if(i<=0)return 0;const f=a(c)/i;return r[c]=f,f},u=Aa.filter(c=>{const f=c.conditions;if(!f)return!0;const p=e.length;if(f.minSize!==void 0&&p<f.minSize||f.maxSize!==void 0&&p>f.maxSize||f.exactSize!==void 0&&p!==f.exactSize||f.exactCoalition&&(p!==f.exactCoalition.length||!f.exactCoalition.every(d=>e.includes(d)))||f.includes&&!f.includes.every(d=>e.includes(d))||f.excludes&&f.excludes.some(d=>e.includes(d))||f.includesAny&&!f.includesAny.some(d=>e.includes(d)))return!1;if(f.includesGroup)for(const d of f.includesGroup){const M=j0[d];if(M&&!M.keys.some(h=>e.includes(h)))return!1}if(f.minCategoryShare){for(const[d,M]of Object.entries(f.minCategoryShare))if(s(d)<M)return!1}if(f.minTotalShare)for(const d of f.minTotalShare){let M=0;if(d.categories.forEach(h=>M+=s(h)),M<d.threshold)return!1}return!0});return u.sort((c,f)=>(f.priority||0)-(c.priority||0)),u.length>0?u[0]:{name:"联合政府",description:"多阶层联合执政",icon:"Users",color:"text-gray-400"}}function L0(e){return Aa.find(t=>t.name===e)}const jr={priceUpdateFrequency:3,aiDecisionFrequency:5,tradeUpdateFrequency:3,diplomacyUpdateFrequency:5,buildingCacheValidation:10};function Ln(e,t,o=!1){if(o)return!0;const i=jr[`${t}Frequency`]||jr[t]||1;return e%i===0}class F0{constructor(){this.cache=new Map,this.lastTick=-1}getOrCompute(t,o,i){if(t!==this.lastTick&&(this.cache.clear(),this.lastTick=t),this.cache.has(o))return this.cache.get(o);const r=i();return this.cache.set(o,r),r}get(t,o){if(t!==this.lastTick){this.cache.clear(),this.lastTick=t;return}return this.cache.get(o)}set(t,o,i){t!==this.lastTick&&(this.cache.clear(),this.lastTick=t),this.cache.set(o,i)}clear(){this.cache.clear(),this.lastTick=-1}}const U0=new F0,$0=()=>({headTax:0,industryTax:0,businessTax:0,tariff:0,tariffSubsidy:0,subsidy:0,policyIncome:0,policyExpense:0,priceControlIncome:0,priceControlExpense:0}),Nr=(e,t={})=>{let o=t[e];typeof o!="number"&&(o=1);const i=va==null?void 0:va.MAX_HEAD_TAX;return Math.max(-i,Math.min(i,o))},G0=(e={},t={},o={})=>{const a={};return Object.entries(ae).forEach(([s,u])=>{var y;let c=0,f=0;const p=u.needs||{};Object.entries(p).forEach(([w,m])=>{var g,C,R;if(!m||m<=0)return;const E=(R=(C=e==null?void 0:e[w])!=null?C:(g=Be[w])==null?void 0:g.basePrice)!=null?R:Io(w);if(!Number.isFinite(E)||E<=0)return;const v=Math.max(0,(o==null?void 0:o[w])||0);c+=m*E,f+=m*E*v});const d=Math.max(0,(y=u.headTaxBase)!=null?y:0),M=Math.max(0,Nr(s,t)),h=4*(M/(M+4));f+=d*h,a[s]={needsCost:Number.isFinite(c)?c:0,taxCost:Number.isFinite(f)?f:0}}),a},Fn=(e={},t={})=>{const o=Number.isFinite(t.livingCostWeight)?t.livingCostWeight:1,i=Number.isFinite(t.taxCostWeight)?t.taxCostWeight:1,r={};return Object.entries(e).forEach(([a,s])=>{const u=(s==null?void 0:s.needsCost)||0,c=(s==null?void 0:s.taxCost)||0;r[a]=Math.max(0,u*o+c*i)}),r},q0=(e={},t={})=>{let o=0,i=0;return Object.keys(e).forEach(r=>{const a=e[r]||0,s=t[r]||0;a>0&&s>0&&(o+=s*a,i+=a)}),i>0?o/i:jn},z={INCOME:{WAGE:"wage",MILITARY_PAY:"militaryPay",OWNER_REVENUE:"ownerRevenue",SUBSIDY:"subsidy",CORRUPTION:"corruption",TRADE_IMPORT_REVENUE:"tradeImportRevenue"},EXPENSE:{HEAD_TAX:"headTax",BUSINESS_TAX:"businessTax",RESOURCE_TAX:"transactionTax",TARIFF:"tariffs",PRODUCTION_COST:"productionCosts",WAGES_PAID:"wages",ESSENTIAL_CONSUMPTION:"essentialNeeds",LUXURY_CONSUMPTION:"luxuryNeeds",DECAY:"decay",MAINTENANCE:"maintenance",TRADE_EXPORT:"tradeExport",TRADE_EXPORT_PURCHASE:"tradeExportPurchase",CAPITAL_FLIGHT:"capitalFlight",BUILDING_COST:"buildingCost",LAYOFF_TRANSFER:"layoffTransfer"}};class V0{constructor(t,o){this.resources=t.resources,this.wealth=t.wealth,this.officials=t.officials,this.classFinancialData=t.classFinancialData,this.taxBreakdown=t.taxBreakdown,this.silverChangeLog=t.silverChangeLog,this.buildingFinancialData=t.buildingFinancialData,this.classWealthChangeLog=t.classWealthChangeLog||{},this.safeWealth=o.safeWealth}transfer(t,o,i,r,a,s={}){i<=0||(t!=="void"&&(this._deduct(t,i,a,s),this._recordExpense(t,i,a,s)),o!=="void"&&(this._add(o,i,a,s),this._recordIncome(o,i,a,s)),this._updateSystemStats(t,o,i,a,s))}_trackClassWealthChange(t,o,i){t==="state"||t==="void"||(this.classWealthChangeLog[t]||(this.classWealthChangeLog[t]=[]),this.classWealthChangeLog[t].push({amount:o,reason:i,balance:this.wealth[t]||0}))}_deduct(t,o,i,r={}){t==="state"?this.resources.silver=Math.max(0,(this.resources.silver||0)-o):t==="official_pool"||(this.wealth[t]=Math.max(0,(this.wealth[t]||0)-o),this._trackClassWealthChange(t,-o,i))}_add(t,o,i,r={}){t==="state"?this.resources.silver=(this.resources.silver||0)+o:(this.wealth[t]=this.safeWealth((this.wealth[t]||0)+o),this._trackClassWealthChange(t,o,i))}_recordExpense(t,o,i,r){if(t==="state"){this.silverChangeLog.push({amount:-o,reason:i,balance:this.resources.silver});return}if(this.classFinancialData[t]){const a=this.classFinancialData[t].expense;if(i===z.EXPENSE.ESSENTIAL_CONSUMPTION||i===z.EXPENSE.LUXURY_CONSUMPTION){a[i]||(a[i]={}),typeof a[i]!="object"&&(a[i]={});const s=r.resource||"unknown";a[i][s]||(a[i][s]={cost:0,quantity:0,price:0}),a[i][s].cost+=o,a[i][s].quantity+=r.quantity||0,a[i][s].price=r.price||0}else a[i]!==void 0&&(a[i]+=o)}}_recordIncome(t,o,i,r){if(t==="state"){this.silverChangeLog.push({amount:o,reason:i,balance:this.resources.silver});return}if(this.classFinancialData[t]){const a=this.classFinancialData[t].income;a[i]!==void 0&&(a[i]+=o)}}_updateSystemStats(t,o,i,r,a={}){if(o==="state"&&(r===z.EXPENSE.HEAD_TAX&&(this.taxBreakdown.headTax+=i),r===z.EXPENSE.BUSINESS_TAX&&(this.taxBreakdown.businessTax+=i),r===z.EXPENSE.RESOURCE_TAX&&(this.taxBreakdown.industryTax+=i),r===z.EXPENSE.TARIFF&&(this.taxBreakdown.tariff=(this.taxBreakdown.tariff||0)+i)),t==="state"&&r===z.INCOME.SUBSIDY&&(this.taxBreakdown.subsidy+=i),a.buildingId&&this.buildingFinancialData&&this.buildingFinancialData[a.buildingId]){const s=this.buildingFinancialData[a.buildingId];r===z.EXPENSE.BUSINESS_TAX&&(s.businessTaxPaid+=i),r===z.INCOME.OWNER_REVENUE&&(s.ownerRevenue+=i)}}}const Lr={minProfitMargin:.1,maxPurchaseAmount:20,exportProbability:.5,maxInventoryRatio:.3,minWealthForTrade:10,tradeDuration:3,tradeCooldown:0,enableDebugLog:!1,enableMerchantAssignments:!0,idleTradeEfficiency:.15,maxPartnersPerTick:4,maxResourcesScoredPerPartner:10,shortageWeight:2.2,surplusWeight:1.3},Fr=e=>Math.max(0,Math.min(1,e)),ri=(e,t=0)=>Number.isFinite(e)?e:t,nn=(e=[],t=10)=>!Array.isArray(e)||e.length===0?[]:[...e].sort((i,r)=>((r==null?void 0:r.score)||0)-((i==null?void 0:i.score)||0)).slice(0,Math.max(0,t)),H0=e=>ri(e==null?void 0:e.relation,50),Y0=({partner:e})=>(e==null?void 0:e.isAtWar)===!0,X0=({merchantAssignments:e,nations:t})=>{if(!e||typeof e!="object")return null;const o={};return Object.entries(e).forEach(([i,r])=>{const a=Math.max(0,Math.floor(Number(r)||0));a<=0||!(!Array.isArray(t)||t.some(u=>(u==null?void 0:u.id)===i))||(o[i]=a)}),Object.keys(o).length>0?o:null},z0=({nations:e,maxPartners:t})=>{const i=(Array.isArray(e)?e.filter(a=>a&&!a.isRebelNation):[]).map(a=>({nationId:a.id,relation:H0(a)})).sort((a,s)=>s.relation-a.relation).slice(0,Math.max(1,t)),r={};return i.forEach(a=>{r[a.nationId]=1}),r},Ur=({resourceKey:e,res:t,demand:o={},marketPrice:i=1})=>{const r=ri(t==null?void 0:t[e],0),a=Math.max(0,ri(o==null?void 0:o[e],0));if(a<=0)return 0;const c=(r<=0?0:r/a)/8,f=Fr(1-c),p=Math.min(1.5,Math.max(.7,ri(i,1)/3));return f*p},$r=({resourceKey:e,res:t,supply:o={},marketPrice:i=1})=>{const r=ri(t==null?void 0:t[e],0),a=Math.max(0,ri(o==null?void 0:o[e],0));if(a<=0)return 0;const c=(r<=0?0:r/a)/12,f=Fr((c-1)/2),p=Math.min(1.6,Math.max(.6,2.2/Math.max(.5,ri(i,1))));return f*p},Un=({resourceKey:e,partner:t,tick:o})=>{const i=wr(e,t,o);return Number.isFinite(i)&&i>0?i:null},Gr=e=>{const t=Number(e);return Number.isFinite(t)?Math.max(.1,Math.min(5,t)):1},qr=({resourceKey:e,partner:t,tick:o,getLocalPrice:i,res:r,demand:a,tradeConfig:s,merchantTradePreferences:u,getImportTaxRate:c,tradeEfficiencyMultiplier:f=1})=>{var R,k;const p=i(e),d=Un({resourceKey:e,partner:t,tick:o});if(p==null||d==null)return null;const M=c?c(e):0,h=d*(1+M),y=(p-h)/Math.max(.1,h)*f;if(y<=-.1)return null;const w=Ur({resourceKey:e,res:r,demand:a,marketPrice:p}),m=Wi(e,t,o),E=m!=null&&m.surplusAmount?Math.min(1,m.surplusAmount/Math.max(50,m.target||1)):0,v=s.shortageWeight*w+2*Math.max(0,y)+.6*E,g=Gr((k=(R=u==null?void 0:u.import)==null?void 0:R[e])!=null?k:1),C=v*g;return{type:"import",resourceKey:e,localPrice:p,foreignPrice:d,score:C,partnerSurplus:E,shortage:w,prefMultiplier:g}},Vr=({resourceKey:e,partner:t,tick:o,getLocalPrice:i,res:r,supply:a,tradeConfig:s,merchantTradePreferences:u,tradeEfficiencyMultiplier:c=1})=>{var g,C;const f=i(e),p=Un({resourceKey:e,partner:t,tick:o});if(f==null||p==null)return null;const d=(p-f)/Math.max(1e-4,f)*c;if(d<=0||ri(r==null?void 0:r[e],0)<=0)return null;const h=$r({resourceKey:e,res:r,supply:a,marketPrice:f}),y=Wi(e,t,o),w=y!=null&&y.shortageAmount?Math.min(1,y.shortageAmount/Math.max(50,y.target||1)):0,m=s.surplusWeight*h+1*d+.6*w,E=Gr((C=(g=u==null?void 0:u.export)==null?void 0:g[e])!=null?C:1),v=m*E;return{type:"export",resourceKey:e,localPrice:f,foreignPrice:p,score:v,partnerShortage:w,surplus:h,prefMultiplier:E}},J0=({nations:e,res:t,supply:o,demand:i,market:r,tick:a,taxPolicies:s,tradeConfig:u=Lr,merchantTradePreferences:c=null})=>{const f={exports:[],imports:[]},p=E=>{var v;return(v=r==null?void 0:r.prices)==null?void 0:v[E]},d=(s==null?void 0:s.resourceTaxRates)||{},M=(s==null?void 0:s.importTariffMultipliers)||(s==null?void 0:s.resourceTariffMultipliers)||{},h=E=>{var C;const v=d[E]||0,g=(C=M[E])!=null?C:0;return v+g},y=Object.keys(Be).filter(E=>Qt(E)),w=[],m=[];return(e||[]).forEach(E=>{!E||E.isAtWar||y.forEach(v=>{const g=Vr({resourceKey:v,partner:E,tick:a,getLocalPrice:p,res:t,supply:o,tradeConfig:u,merchantTradePreferences:c});g&&g.score>0&&w.push(g);const C=qr({resourceKey:v,partner:E,tick:a,getLocalPrice:p,res:t,demand:i,tradeConfig:u,merchantTradePreferences:c,getImportTaxRate:h});C&&C.score>0&&m.push(C)})}),f.exports=nn(w,10),f.imports=nn(m,10),f},Z0=({ledger:e,res:t,wealth:o,popStructure:i,supply:r,demand:a,nations:s,tick:u,taxPolicies:c,taxBreakdown:f,getLocalPrice:p,roleExpense:d,roleWagePayout:M,pendingTrades:h=[],lastTradeTime:y=0,gameSpeed:w=1,classFinancialData:m,logs:E,potentialResources:v,merchantAssignments:g=null,merchantTradePreferences:C=null,shouldLogMerchantTrades:R=!0,onTreasuryChange:k=null})=>{var Ke,Le,_t;const D=(i==null?void 0:i.merchant)||0;if(D<=0)return{pendingTrades:h,lastTradeTime:y,lockedCapital:0,capitalInvestedThisTick:0,completedTrades:[]};let P=0;const T=[],S=(c==null?void 0:c.resourceTaxRates)||{},V=(c==null?void 0:c.importTariffMultipliers)||(c==null?void 0:c.resourceTariffMultipliers)||{},N=(c==null?void 0:c.exportTariffMultipliers)||(c==null?void 0:c.resourceTariffMultipliers)||{},L=K=>{var He;const Ce=S[K]||0,fe=(He=V[K])!=null?He:0;return Ce+fe},W=K=>{var He;const Ce=S[K]||0,fe=(He=N[K])!=null?He:0;return Ce+fe},j={...Lr,...((Ke=ae.merchant)==null?void 0:Ke.tradeConfig)||{}},H=[];if(h.forEach(K=>{if(K.daysRemaining-=1,K.daysRemaining<=0){if(e&&e.transfer("void","merchant",K.revenue,z.INCOME.OWNER_REVENUE,z.INCOME.OWNER_REVENUE),M.merchant=(M.merchant||0)+K.revenue,K.type==="import"){if(t[K.resource]=(t[K.resource]||0)+K.amount,r[K.resource]=(r[K.resource]||0)+K.amount,K.partnerId&&Array.isArray(s)){const Ce=s.find(fe=>(fe==null?void 0:fe.id)===K.partnerId);if(Ce){Ce.inventory||(Ce.inventory={});const fe=Ce.inventory[K.resource]||0;Ce.inventory[K.resource]=Math.max(0,fe-K.amount)}}}else if(K.type==="export"&&K.partnerId&&Array.isArray(s)){const Ce=s.find(fe=>(fe==null?void 0:fe.id)===K.partnerId);if(Ce){Ce.inventory||(Ce.inventory={});const fe=Ce.inventory[K.resource]||0;Ce.inventory[K.resource]=Math.max(0,fe+K.amount)}}T.push({type:K.type,resource:K.resource,amount:K.amount,revenue:K.revenue,profit:K.profit,partnerId:K.partnerId}),j.enableDebugLog&&tn("trade","[Merchant Debug] ✅ Trade complete:",{type:K.type==="export"?"Export":"Import",partnerId:K.partnerId,resource:K.resource,amount:K.amount,revenue:K.revenue,profit:K.profit})}else H.push(K)}),!(u-y>=j.tradeCooldown))return{pendingTrades:H,lastTradeTime:y,lockedCapital:0,capitalInvestedThisTick:0,completedTrades:T};const U=Object.keys(Be).filter(K=>Qt(K)).filter(K=>!v||v.has(K)),J=X0({merchantAssignments:g,nations:s}),ye=j.enableMerchantAssignments&&!!J,te=ye?J:z0({nations:s,maxPartners:j.maxPartnersPerTick}),le=Object.entries(te).map(([K,Ce])=>({nationId:K,count:Ce})).filter(K=>K.count>0).slice(0,Math.max(1,j.maxPartnersPerTick)),we=ye?1:j.idleTradeEfficiency,ue=D>100?100:D,Ie=D>100?D/100:1,de=le.reduce((K,Ce)=>K+Ce.count,0)||1,Y=le.map(K=>{const Ce=K.count/de,fe=Math.max(1,Math.round(ue*Ce));return{...K,batches:fe}});for(let K=0;K<Y.length;K++){const Ce=Y[K],fe=Array.isArray(s)?s.find(_e=>(_e==null?void 0:_e.id)===Ce.nationId):null;if(!fe||Y0({partner:fe}))continue;const He=Pa(fe,u),ie=He.tariffMultiplier,ze=1+Math.max(0,He.tradeEfficiencyBonus||0),Zt=_e=>{var kt;L(_e);const ht=((kt=V[_e])!=null?kt:0)*ie;return(S[_e]||0)+ht},Ye=_e=>{var kt;W(_e);const ht=((kt=N[_e])!=null?kt:0)*ie;return(S[_e]||0)+ht},et=[],It=[],Vt=[];U.forEach(_e=>{const lt=p(_e);if(lt==null)return;const ht=Ur({resourceKey:_e,res:t,demand:a,marketPrice:lt}),kt=$r({resourceKey:_e,res:t,supply:r,marketPrice:lt}),yt=Un({resourceKey:_e,partner:fe,tick:u});let Kt=0,ao=0;if(yt!=null){const Jo=Zt(_e),ro=yt*(1+Jo);lt>ro&&(Kt=(lt-ro)/Math.max(.1,ro));const bt=Ye(_e),eo=lt*(1+bt);yt>eo&&(ao=(yt-eo)/Math.max(.1,eo))}(ht>.01||Kt>.05)&&It.push({resourceKey:_e,score:Math.max(ht,Kt)}),(kt>.01||ao>.05)&&Vt.push({resourceKey:_e,score:Math.max(kt,ao)})});let Fo=nn(It,j.maxResourcesScoredPerPartner),zo=nn(Vt,j.maxResourcesScoredPerPartner);if(Fo.length===0&&zo.length===0){const _e=Math.max(6,j.maxResourcesScoredPerPartner),lt=[];U.forEach(kt=>{const yt=p(kt);if(yt==null)return;const Kt=Un({resourceKey:kt,partner:fe,tick:u});if(Kt==null)return;const ao=(yt-Kt)/Math.max(1e-4,yt),Jo=(Kt-yt)/Math.max(1e-4,yt),ro=Math.max(ao,Jo);ro<=0||lt.push({resourceKey:kt,score:ro})});const ht=nn(lt,_e);Fo=ht,zo=ht,j.enableDebugLog&&tn("trade","[Merchant Debug] ⚠️ Trade 2.0 fallback prefilter active (no shortage/surplus signals).",{partnerId:fe==null?void 0:fe.id,fallbackCandidates:ht.length})}if(Fo.forEach(({resourceKey:_e})=>{const lt=qr({tradeEfficiencyMultiplier:ze,resourceKey:_e,partner:fe,tick:u,getLocalPrice:p,res:t,demand:a,tradeConfig:j,merchantTradePreferences:C,getImportTaxRate:L});lt&&et.push(lt)}),zo.forEach(({resourceKey:_e})=>{const lt=Vr({tradeEfficiencyMultiplier:ze,resourceKey:_e,partner:fe,tick:u,getLocalPrice:p,res:t,supply:r,tradeConfig:j,merchantTradePreferences:C});lt&&et.push(lt)}),et.length===0)continue;et.sort((_e,lt)=>lt.score-_e.score);const Dt=Math.min(12,Ce.batches);for(let _e=0;_e<Dt;_e++){const lt=o.merchant||0;if(lt<=j.minWealthForTrade)break;const ht=et[_e%et.length];if(!ht)break;const kt=lt/(ue+1)*we;if(ht.type==="export"){const yt=Q0({tradeEfficiencyMultiplier:ze,ledger:e,partner:fe,partnerId:fe.id,resourceKey:ht.resourceKey,wealthForThisBatch:kt,batchMultiplier:Ie,wealth:o,res:t,supply:r,taxBreakdown:f,tradeConfig:j,getLocalPrice:p,foreignUnitPrice:ht.foreignPrice,getResourceTaxRate:W,roleExpense:d,classFinancialData:m,taxPolicies:c,logs:E});if(yt.success){P+=yt.outlay,H.push(yt.trade),y=u;const Kt=((Le=Be[ht.resourceKey])==null?void 0:Le.name)||ht.resourceKey,ao=(fe==null?void 0:fe.name)||(fe==null?void 0:fe.id)||"未知国家";E&&R&&yt.trade.amount>=.5&&E.push(`📦 商人发起贸易: 向${ao}出口 ${Kt} x${yt.trade.amount.toFixed(1)}`)}}else{const yt=K0({tradeEfficiencyMultiplier:ze,ledger:e,partner:fe,partnerId:fe.id,resourceKey:ht.resourceKey,wealthForThisBatch:kt,batchMultiplier:Ie,wealth:o,res:t,taxBreakdown:f,tradeConfig:j,getLocalPrice:p,foreignUnitPrice:ht.foreignPrice,getResourceTaxRate:L,roleExpense:d,classFinancialData:m,taxPolicies:c,logs:E});if(yt.success){P+=yt.cost,H.push(yt.trade),y=u;const Kt=((_t=Be[ht.resourceKey])==null?void 0:_t.name)||ht.resourceKey,ao=(fe==null?void 0:fe.name)||(fe==null?void 0:fe.id)||"未知国家";E&&R&&yt.trade.amount>=.5&&E.push(`📦 商人发起贸易: 从${ao}进口 ${Kt} x${yt.trade.amount.toFixed(1)}`)}}}}const Re=H.reduce((K,Ce)=>K+Math.max(0,(Ce==null?void 0:Ce.capitalLocked)||0),0);return{pendingTrades:H,lastTradeTime:y,lockedCapital:Re,capitalInvestedThisTick:P,completedTrades:T}},Q0=({ledger:e,partner:t,partnerId:o,resourceKey:i,wealthForThisBatch:r,batchMultiplier:a,wealth:s,res:u,supply:c,taxBreakdown:f,tradeConfig:p,tradeEfficiencyMultiplier:d=1,getLocalPrice:M,foreignUnitPrice:h,getResourceTaxRate:y,classFinancialData:w,taxPolicies:m,roleExpense:E,logs:v})=>{var Re,Ke,Le,_t,K,Ce,fe;const g=M(i),C=h;if(C===null||g===null||C<=g)return{success:!1};const R=y(i),k=g*(1+R),D=k>0?r/k:0,T=(u[i]||0)/a*p.maxInventoryRatio,S=Wi(i,t,0),V=Math.max(20,((S==null?void 0:S.shortageAmount)||0)+((S==null?void 0:S.target)||0)*.08),N=Math.min(p.maxPurchaseAmount,D,T,V);if(N<=.1)return{success:!1};const L=g*N,W=L*R,j=C*N;let H=L;if(W<0){const He=Math.abs(W);(u.silver||0)>=He*a?H-=He:v.push(`Treasury empty, cannot pay export subsidy for ${((Re=Be[i])==null?void 0:Re.name)||i}!`)}else H+=W;const ce=((Ke=m==null?void 0:m.resourceTaxRates)==null?void 0:Ke[i])||0,me=(Ce=(K=(Le=m==null?void 0:m.exportTariffMultipliers)==null?void 0:Le[i])!=null?K:(_t=m==null?void 0:m.resourceTariffMultipliers)==null?void 0:_t[i])!=null?Ce:0,U=L*me;let J=0;if(U>0)H+=U,J=U;else if(U<0){const He=Math.abs(U)*a;(u.silver||0)>=He?(H-=Math.abs(U),J=U):v.push(`Treasury empty, cannot pay export tariff subsidy for ${((fe=Be[i])==null?void 0:fe.name)||i}!`)}const te=(j-H)*d;if((H>0?te/H:te>0?1/0:-1/0)<p.minProfitMargin)return{success:!1};const we=N*a,ue=H*a;if((s.merchant||0)<ue)return{success:!1};if((u[i]||0)<we)return{success:!1};const Ie=L*a;e&&e.transfer("merchant","void",Ie,z.EXPENSE.TRADE_EXPORT,z.EXPENSE.TRADE_EXPORT),E.merchant=(E.merchant||0)+Ie;const de=L*ce*a;if(de>0)e&&e.transfer("merchant","state",de,z.EXPENSE.RESOURCE_TAX,z.EXPENSE.RESOURCE_TAX),E.merchant=(E.merchant||0)+de;else if(de<0){const He=Math.abs(de);(u.silver||0)>=He&&e&&e.transfer("state","merchant",He,z.INCOME.SUBSIDY,z.INCOME.SUBSIDY)}const Y=J*a;if(Y>0)e&&e.transfer("merchant","state",Y,z.EXPENSE.TARIFF,z.EXPENSE.TARIFF),E.merchant=(E.merchant||0)+Y;else if(Y<0){const He=Math.abs(Y);(u.silver||0)>=He&&(e&&e.transfer("state","merchant",He,z.INCOME.SUBSIDY,z.INCOME.SUBSIDY),f.tariffSubsidy=(f.tariffSubsidy||0)+He)}return u[i]=Math.max(0,(u[i]||0)-we),c[i]=Math.max(0,(c[i]||0)-we),{success:!0,outlay:ue,trade:{type:"export",partnerId:o,resource:i,amount:we,revenue:j*a,profit:te*a,daysRemaining:p.tradeDuration,capitalLocked:ue}}},K0=({ledger:e,partner:t,partnerId:o,resourceKey:i,wealthForThisBatch:r,batchMultiplier:a,wealth:s,res:u,taxBreakdown:c,tradeConfig:f,tradeEfficiencyMultiplier:p=1,getLocalPrice:d,foreignUnitPrice:M,getResourceTaxRate:h,roleExpense:y,classFinancialData:w,taxPolicies:m,logs:E})=>{var le,we,ue,Ie,de,Y;const v=d(i),g=M;if(g===null||v===null||g>=v)return{success:!1};const C=Wi(i,t,0),R=Math.max(10,((C==null?void 0:C.surplusAmount)||0)+((C==null?void 0:C.target)||0)*.05);(le=m==null?void 0:m.resourceTaxRates)!=null&&le[i];const k=(de=(Ie=(we=m==null?void 0:m.importTariffMultipliers)==null?void 0:we[i])!=null?Ie:(ue=m==null?void 0:m.resourceTariffMultipliers)==null?void 0:ue[i])!=null?de:0,D=g,P=D>0?r/(D*(1+Math.max(0,k))):0,T=Math.min(f.maxPurchaseAmount,P,R);if(T<=.1)return{success:!1};const S=g*T,V=S*k,N=S+V,L=v*T,j=(L-N)*p;if((N>0?j/N:j>0?1/0:-1/0)<f.minProfitMargin)return{success:!1};const ce=T*a,me=S*a,U=V*a,J=N*a;if((s.merchant||0)<J)return{success:!1};const ye=me;e&&e.transfer("merchant","void",ye,z.EXPENSE.TRADE_IMPORT,z.EXPENSE.TRADE_IMPORT),y.merchant=(y.merchant||0)+ye;const te=U;if(te>0)e&&e.transfer("merchant","state",te,z.EXPENSE.TARIFF,z.EXPENSE.TARIFF),y.merchant=(y.merchant||0)+te;else if(te<0){const Re=Math.abs(te);(u.silver||0)>=Re?(e&&e.transfer("state","merchant",Re,z.INCOME.SUBSIDY,z.INCOME.SUBSIDY),c.tariffSubsidy=(c.tariffSubsidy||0)+Re,y.merchant=(y.merchant||0)-Re):E.push(`Treasury empty, cannot pay import subsidy for ${((Y=Be[i])==null?void 0:Y.name)||i}!`)}return{success:!0,cost:J,trade:{type:"import",partnerId:o,resource:i,amount:ce,revenue:L*a,profit:j*a,daysRemaining:f.tradeDuration,capitalLocked:J}}},Ra=(e,t,o,i,r)=>{i<=0||e&&(e[t]||(e[t]=[]),e[o]||(e[o]=[]),e[t].push({amount:-i,reason:`${r}_out`}),e[o].push({amount:i,reason:`${r}_in`}))},el=(e,t,o,i,r)=>{i!==0&&(e[o]=Math.max(0,(e[o]||0)+i),t&&(t[o]||(t[o]=[]),t[o].push({amount:i,reason:r})))},tl=({popStructure:e,jobsAvailable:t,wealth:o,getExpectedWage:i,getHeadTaxRate:r,effectiveTaxModifier:a,wealthChangeLog:s=null})=>{const u=d=>{var w,m;const M=i(d),y=((m=(w=ae[d])==null?void 0:w.headTaxBase)!=null?m:.01)*r(d)*a;return M-Math.max(0,y)},c=d=>{var m,E,v,g;const M=(m=So[d])!=null?m:0,h=Kc[d],y=Number.isFinite(h)?h:(E=Qc[M])!=null?E:0;return((g=(v=ae[d])==null?void 0:v.startingWealth)!=null?g:100)*y},f=(d,M)=>{var w,m;const h=(w=So[d])!=null?w:0,y=(m=So[M])!=null?m:0;return y<=2||h<=y};return Xt.map((d,M)=>{var m;const h=Math.max(0,t[d]||0),y=e[d]||0,w=Math.max(0,h-y);return w<=0||d==="official"?null:{role:d,vacancy:w,netIncome:u(d),priorityIndex:M,tier:(m=So[d])!=null?m:0,wealthRequired:c(d)}}).filter(Boolean).sort((d,M)=>M.netIncome!==d.netIncome?M.netIncome-d.netIncome:d.priorityIndex-M.priorityIndex).forEach(d=>{var y;const M=Math.max(1,Math.floor(d.vacancy*jc));let h=Math.min(d.vacancy,M);if(d.tier<=1){const w=e.unemployed||0;if(w<=0||h<=0)return;const m=Math.min(h,w);if(m<=0)return;const E=o.unemployed||0,v=w>0?E/w:0;if(e[d.role]=(e[d.role]||0)+m,e.unemployed=Math.max(0,w-m),v>0){const g=v*m;o.unemployed=Math.max(0,E-g),o[d.role]=Qi((o[d.role]||0)+g),Ra(s,"unemployed",d.role,g,"job_hire_tier01")}}else{const w=Object.keys(So).filter(m=>{var C;if(!f(m,d.role)||m===d.role||m==="soldier"||m==="official")return!1;const E=e[m]||0;if(E<=0)return!1;const v=(C=So[m])!=null?C:0,g=d.tier;if(v===g&&m!=="unemployed"){const R=t[m]||0;if(E<=R)return!1}return!0}).sort((m,E)=>{var C,R;const v=(C=So[m])!=null?C:0,g=(R=So[E])!=null?R:0;return m==="unemployed"?-1:E==="unemployed"?1:g-v});for(const m of w){if(h<=0)break;const E=e[m]||0;if(E<=0)continue;const v=o[m]||0,g=E>0?v/E:0,C=(y=So[m])!=null?y:0;let R=!1,k=0,D=0;if(C<d.tier&&g<d.wealthRequired){const T=E*Nc,S=Math.floor(T)+(Math.random()<T%1?1:0);if(S>0)D=S,R=!0,k=d.wealthRequired-g;else continue}else C===d.tier||d.wealthRequired<=0?D=E:D=g>=d.wealthRequired?E:0;const P=Math.min(h,D);if(!(P<=0)){if(e[d.role]=(e[d.role]||0)+P,e[m]=Math.max(0,E-P),g>0||R){const T=g*P;o[m]=Math.max(0,v-T);const S=R?k*P:0;o[d.role]=Qi((o[d.role]||0)+T+S);const V=R?"job_hire_lucky_promotion":"job_hire_tier23";Ra(s,m,d.role,T,V),S>0&&el(o,s,d.role,S,"job_hire_lucky_bonus")}h-=P}}}}),{popStructure:e,wealth:o}},ol=({popStructure:e,wealth:t,roleMetrics:o,hasBuildingVacancyForRole:i,reserveBuildingVacancyForRole:r,logs:a,migrationCooldowns:s={},supplyDemandRatio:u={},roleProducesResource:c={},wealthChangeLog:f=null})=>{var H,ce,me;const p={};Object.entries(s).forEach(([U,J])=>{J>1&&(p[U]=J-1)});const d=o.filter(U=>U.role!=="soldier"&&U.role!=="official");if(d.length===0)return{popStructure:e,wealth:t,migrationCooldowns:p};const M=d.reduce((U,J)=>U+J.potentialIncome*J.pop,0),h=d.reduce((U,J)=>U+J.pop,0),y=h>0?M/h:0,w=Er.filter(U=>{const J=u[U];return J!==void 0&&J<Gc}),m=new Set;w.length>0&&Object.entries(c).forEach(([U,J])=>{J&&Array.isArray(J)&&J.some(te=>w.includes(te))&&m.add(U)}),w.length>0&&m.size>0;const E=.8,v=Er.filter(U=>{const J=u[U];return J!==void 0&&J<E}),g=new Set;v.length>0&&Object.entries(c).forEach(([U,J])=>{J&&Array.isArray(J)&&J.some(te=>v.includes(te))&&g.add(U)});const C=d.filter(U=>i(U.role)).reduce((U,J)=>Math.max(U,J.potentialIncome),0),R=d.filter(U=>{if(U.pop<=0||U.role==="soldier"||p[U.role]&&p[U.role]>0)return!1;const J=U.perCap*.05,ye=-Math.max(.5,Math.min(50,J));return U.potentialIncome<y*.7||U.perCapDelta<ye||C>0&&U.potentialIncome<C*.6}).reduce((U,J)=>!U||J.potentialIncome<U.potentialIncome||J.potentialIncome===U.potentialIncome&&J.perCapDelta<U.perCapDelta?J:U,null);if(!R)return{popStructure:e,wealth:t,migrationCooldowns:p};const k=(H=So[R.role])!=null?H:0,D=(me=(ce=ae[R.role])==null?void 0:ce.startingWealth)!=null?me:100,P=t[R.role]||0,T=R.pop>0?P/R.pop:0,S=T>=D*e0,V=U=>{var te;const ye=((te=So[U])!=null?te:0)-k;if(ye>0)return $c;if(ye===0)return Lc;{const le=Math.abs(ye);return Fc*Math.pow(Uc,le-1)}},N=(U,J)=>{var we;const te=((we=So[U])!=null?we:0)-k;let le=J;if(S&&te>0){const ue=le*t0*te;le+=ue}return le},L=d.filter(U=>{if(U.role===R.role||U.vacancy<=0)return!1;const ye=1.3*V(U.role);if(U.role==="soldier")return U.potentialIncome>R.potentialIncome*ye;const te=N(U.role,U.potentialIncome);return i(U.role)&&te>R.potentialIncome*ye}).reduce((U,J)=>{if(!U)return J;const ye=N(J.role,J.potentialIncome),te=N(U.role,U.potentialIncome);return ye>te?J:U},null);if(!L)return{popStructure:e,wealth:t,migrationCooldowns:p};const W=R.pop<Nn?Bc:Oc;let j=Math.floor(R.pop*W);if(j<=0&&R.pop>0&&(j=1),j=Math.min(j,L.vacancy),j>0){if(L.role!=="soldier"){const U=r(L.role,j);!U||U.count<=0?j=0:j=U.count}if(j>0){const U=T*j;U>0&&(t[R.role]=Math.max(0,P-U),t[L.role]=Qi((t[L.role]||0)+U),Ra(f,R.role,L.role,U,"job_migration")),e[R.role]=Math.max(0,R.pop-j),e[L.role]=(e[L.role]||0)+j,p[R.role]=xr,p[L.role]=xr}}return{popStructure:e,wealth:t,migrationCooldowns:p}},il=(e={})=>{const t={...e};return Object.keys(ae).forEach(o=>{var i;t[o]===void 0&&(t[o]=((i=ae[o])==null?void 0:i.startingWealth)||0)}),t},nl=(e=[])=>{const t={};return Array.isArray(e)&&e.forEach(o=>{var i;o.active&&((i=o.modifiers)!=null&&i.approval)&&Object.entries(o.modifiers.approval).forEach(([r,a])=>{t[r]=(t[r]||0)+a})}),t},al=({popStructure:e,classApproval:t,classInfluence:o,totalInfluence:i,newActiveBuffs:r,newActiveDebuffs:a,eventStabilityModifier:s=0,extraStabilityPenalty:u=0,currentStability:c=50,stabilityBonus:f=0})=>{let p=0,d=0;Object.keys(ae).forEach(v=>{if((e[v]||0)===0)return;const C=t[v]||50,R=o[v]||0,k=i>0?R/i:0;p+=C*k,d+=k});let M=d>0?p:50;s&&(M+=s);let h=0;r.forEach(v=>{v.stability&&(h+=v.stability)}),a.forEach(v=>{v.stability&&(h+=v.stability)}),f&&(h+=M*f),h-=u;const y=Math.max(0,Math.min(100,M+h)),w=Math.max(0,Math.min(100,c+(y-c)*Jc)),m=Math.min(1.5,Math.max(.5,1+(w-50)/100));return{stabilityValue:w,targetStability:y,efficiency:m,stabilityFactor:m}},rl=({popStructure:e,classWealthResult:t})=>{const o={},i=Object.values(t).reduce((a,s)=>a+s,0);Object.keys(ae).forEach(a=>{const s=e[a]||0;if(s===0)return;const u=ae[a],c=t[a]||0,f=i>0?c/i:0;o[a]=u.influenceBase*s+f*10});const r=Object.values(o).reduce((a,s)=>a+s,0);return{classInfluence:o,totalInfluence:r,totalWealth:i}},sl=tr.reduce((e,t)=>(e[t.id]=t,e),{}),cl=()=>({buildingBonuses:{},categoryBonuses:{gather:0,industry:0,civic:0,military:0},passiveGains:{},passivePercentGains:{},perPopPassiveGains:{},incomePercentBonus:0,decreeResourceDemandMod:{},decreeStratumDemandMod:{},decreeResourceSupplyMod:{},decreeSilverIncome:0,decreeSilverExpense:0,extraMaxPop:0,maxPopPercent:0,productionBonus:0,industryBonus:0,taxBonus:0,needsReduction:0,stabilityBonus:0,scienceBonus:0,cultureBonus:0,militaryBonus:0}),Xo=(e,t)=>{if(!e)return;const{buildingBonuses:o,categoryBonuses:i,passiveGains:r,decreeResourceDemandMod:a,decreeStratumDemandMod:s,decreeResourceSupplyMod:u}=t;if(e.buildings&&Object.entries(e.buildings).forEach(([c,f])=>{!c||typeof f!="number"||Number.isFinite(f)&&(o[c]=(o[c]||0)+f)}),e.buildingProductionMod&&Object.entries(e.buildingProductionMod).forEach(([c,f])=>{if(!c||typeof f!="number"||!Number.isFinite(f))return;["gather","industry","civic","military","all"].includes(c)?i[c]=(i[c]||0)+f:o[c]=(o[c]||0)+f}),e.categories&&Object.entries(e.categories).forEach(([c,f])=>{!c||typeof f!="number"||Number.isFinite(f)&&(i[c]=(i[c]||0)+f)}),e.passive&&Object.entries(e.passive).forEach(([c,f])=>{!c||typeof f!="number"||(r[c]=(r[c]||0)+f)}),e.passivePercent&&Object.entries(e.passivePercent).forEach(([c,f])=>{!c||typeof f!="number"||(t.passivePercentGains[c]=(t.passivePercentGains[c]||0)+f)}),e.maxPop){const c=e.maxPop;c>-1&&c<1&&c!==0?t.maxPopPercent+=c:t.extraMaxPop+=c}e.production&&(t.productionBonus+=e.production),e.industry&&(t.industryBonus+=e.industry),e.taxIncome&&(t.taxBonus+=e.taxIncome),e.needsReduction&&(t.needsReduction+=e.needsReduction),e.stability&&(t.stabilityBonus+=e.stability),e.scienceBonus&&(t.scienceBonus+=e.scienceBonus),e.cultureBonus&&(t.cultureBonus+=e.cultureBonus),e.militaryBonus&&(t.militaryBonus+=e.militaryBonus),e.gatherBonus&&(i.gather=(i.gather||0)+e.gatherBonus),e.industryBonus&&(t.industryBonus+=e.industryBonus),e.knowledgeBonus&&(t.scienceBonus+=e.knowledgeBonus),e.resourceDemandMod&&Object.entries(e.resourceDemandMod).forEach(([c,f])=>{typeof f=="number"&&(a[c]=(a[c]||0)+f)}),e.stratumDemandMod&&Object.entries(e.stratumDemandMod).forEach(([c,f])=>{typeof f=="number"&&(s[c]=(s[c]||0)+f)}),e.resourceSupplyMod&&Object.entries(e.resourceSupplyMod).forEach(([c,f])=>{typeof f=="number"&&(u[c]=(u[c]||0)+f)}),e.perPopPassive&&Object.entries(e.perPopPassive).forEach(([c,f])=>{!c||typeof f!="number"||(t.perPopPassiveGains[c]=(t.perPopPassiveGains[c]||0)+f)}),typeof e.incomePercent=="number"&&(t.incomePercentBonus+=e.incomePercent)},ll=(e,t)=>{Array.isArray(e)&&e.forEach(o=>{const i=sl[o];!i||!i.effects||Xo(i.effects,t)})},ul=(e,t)=>{Array.isArray(e)&&e.forEach(o=>{var r,a;if(!o||!o.active||!o.modifiers)return;const i=((a=(r=o.modifiers)==null?void 0:r.passive)==null?void 0:a.silver)||0;i>0?t.decreeSilverIncome+=i:i<0&&(t.decreeSilverExpense+=Math.abs(i)),Xo(o.modifiers,t)})},fl=(e,t)=>{Array.isArray(e)&&e.forEach(o=>{!o||!o.effects||Xo(o.effects,t)})},dl=(e,t)=>{e&&Xo(e,t)},pl=(e,t,o=1.15,i=1)=>{const r={},u=1+Math.max(0,o-1)*Math.pow(t,.9);for(const[c,f]of Object.entries(e||{}))r[c]=Math.ceil(f*i*u);return r},hl=(e,t,o={})=>{let i=0;for(const[r,a]of Object.entries(o)){const s=parseInt(r);Number.isFinite(s)&&s>=e&&a>0&&(i+=a)}return i},Hr=90,Yr=60,ml=500,gl=.4,Sa={satisfied:{effectMult:1,corruption:0,description:null},uncomfortable:{effectMult:.9,corruption:.01,description:"生活拮据"},struggling:{effectMult:.7,corruption:.03,description:"入不敷出"},desperate:{effectMult:.3,corruption:.1,description:"濒临破产"}},yl={landowner:{cats:["gather"],risk:.4},merchant:{cats:["civic","industry"],risk:.7},capitalist:{cats:["industry","gather"],risk:.8},scribe:{cats:["civic"],risk:.3},cleric:{cats:["civic"],risk:.3},peasant:{cats:["gather"],risk:.4},worker:{cats:["industry"],risk:.5},artisan:{cats:["industry"],risk:.5},engineer:{cats:["industry"],risk:.6},navigator:{cats:["civic","gather"],risk:.6}},bl=(e,t)=>{var o,i;return!t||t==="silver"?1:(i=(o=e==null?void 0:e.prices)==null?void 0:o[t])!=null?i:1},Ml=(e,t,o)=>{var s;const i=yl[e]||{cats:["gather"],risk:.5},r=(s=br[t])==null?void 0:s.spectrum;let a=[...i.cats];return r==="left"?(a=a.filter(u=>u!=="industry"),a.includes("gather")||a.push("gather")):r==="right"&&(a.includes("industry")||a.push("industry")),{preferredCategories:a,riskTolerance:i.risk*(.8+Math.random()*.4),investmentThreshold:.2+Math.random()*.3,lastInvestmentDay:o-Math.floor(Hr/2),lastUpgradeDay:o-Math.floor(Yr/2)}},vl=(e,t,o=null)=>{const i=Math.max(1,t||0),r=e.wealth||0,a={desperate:i*10,struggling:i*30,uncomfortable:i*60,wealthy:i*120},u=(Number.isFinite(o)?o:e.salary||0)/i;return r<a.desperate?"desperate":r>=a.wealthy?"satisfied":u<.8&&r<a.struggling?"struggling":r<a.uncomfortable?"uncomfortable":"satisfied"},Xr=(e,t)=>Object.entries(e||{}).reduce((o,[i,r])=>i==="silver"?o+r:o+bl(t,i)*r,0),wl=(e,t={},o={})=>{const i=Yt.find(c=>c.id===e);if(!(i!=null&&i.jobs))return 1;let r=0,a=0;const s=(o==null?void 0:o[e])||0,u=Math.max(1,s);return Object.entries(i.jobs).forEach(([c,f])=>{const p=u*f,d=t[c]||0;r+=p,a+=p*Math.min(1,d)}),r>0?a/r:1},xl=(e,t,o,i,r,a)=>{const s=Yt.find(h=>h.id===e.buildingId);if(!s)return 0;const u=e.level||0,c=Nt(s,u),f={...s,...c,id:s.id,owner:c.owner||s.owner},p=Ki(f,t,o).profit,d=i==null?void 0:i[e.buildingId],M=Number.isFinite(d)?d:wl(e.buildingId,a,r);return p*M},El=(e,t,o,i,r)=>{const a=Nt(e,t),s=Nt(e,o),u=Ki({...e,...a},i,r).profit;return Ki({...e,...s},i,r).profit-u},zr={marxism:0,primitive_communism:.05,peasant_revolt:.1,utopian_socialism:.2,social_democracy:.4,legalism:.6,conservatism:.7,absolutism:.7,aristocratic_oligarchy:.8,feudalism:.8,mercantilism:.9,classical_liberalism:1},Cl=(e,t,o,i,r,a,s,u=0,c=[])=>{var R;if(!(e!=null&&e.investmentProfile))return null;const f=e.politicalStance,p=zr[f]!==void 0?zr[f]:.5;if(p<=0||Math.random()>p)return null;const d=e.investmentProfile;if(t-d.lastInvestmentDay<Hr||e.wealth<ml)return null;const M=((R=r==null?void 0:r.dominance)==null?void 0:R.faction)==="left"?.5:1,h=Math.max(1,(e.wealth||0)/400),y=Math.min(2.2,1+Math.log10(h)*.6),w=d.riskTolerance*M*y;if(Math.random()>w)return null;const m=e.wealth*gl*d.riskTolerance*y;if(m<=0)return null;const E=Sr(s),v=Yt.filter(k=>{var S;return!(!k.owner||!k.baseCost||!(((S=k.epoch)!=null?S:0)<=u)||!(!k.requiresTech||c.includes(k.requiresTech))||((a==null?void 0:a[k.id])||0)<=0)}).map(k=>{const D=(a==null?void 0:a[k.id])||0,P=pl(k.baseCost,D,E),T=Xr(P,o),S=Ki(k,o,i).profit,V=d.preferredCategories.includes(k.cat)?2:1;return{building:k,cost:T,profit:S,weight:Math.max(.01,S*V)}}).filter(k=>k.cost<=m&&k.profit>0).sort((k,D)=>D.weight-k.weight);if(v.length===0)return null;const g=v.reduce((k,D)=>k+D.weight,0);let C=Math.random()*g;for(const k of v)if(C-=k.weight,C<=0)return{buildingId:k.building.id,cost:k.cost,profit:k.profit};return null},_l=(e,t,o,i,r,a,s,u)=>{var M,h,y,w;if(!((M=e.ownedProperties)!=null&&M.length))return null;const c=((h=e.investmentProfile)==null?void 0:h.lastUpgradeDay)||0;if(t-c<Yr||e.wealth<200)return null;const f=((y=r==null?void 0:r.dominance)==null?void 0:y.faction)==="left"?.7:1;if(Math.random()>(((w=e.investmentProfile)==null?void 0:w.riskTolerance)||.5)*f)return null;const p=Sr(u),d=[];return e.ownedProperties.forEach((m,E)=>{const v=Yt.find(N=>N.id===m.buildingId);if(!v)return;const g=Dn(v.id),C=m.level||0,R=C+1;if(R>g)return;const k=(a==null?void 0:a[v.id])||0,D=(s==null?void 0:s[v.id])||{},P=hl(R,k,D),T=Wn(v.id,R,P,p);if(!T)return;const S=Xr(T,o);if(S>e.wealth*.5)return;const V=El(v,C,R,o,i);V<=0||d.push({propertyIndex:E,buildingId:v.id,fromLevel:C,toLevel:R,cost:S,profitGain:V,roi:V/S})}),d.length?(d.sort((m,E)=>E.roi-m.roi),d[0]):null},Tl={0:0,1:3,2:6,3:9,4:12,5:15,6:18,7:21},Jr={early_administration:2,bureaucracy:3,civil_service:3,administrative_reform:4,centralization:2},Pl=(e=0,t={},o=[])=>{const r=Tl[e]||0,a=t.officialCapacity||0;let s=0;return o.forEach(u=>{Jr[u]&&(s+=Jr[u])}),Math.max(1,2+r+a+s)},Al=(e,t)=>{const o={buildings:{},buildingProductionMod:{},wartimeProduction:0,tradeBonus:0,taxEfficiency:0,buildingCostMod:0,incomePercentBonus:0,passiveGains:{},passivePercentGains:{},corruption:0,decreeStratumDemandMod:{},decreeResourceDemandMod:{},resourceSupplyMod:{},resourceWaste:{},needsReduction:0,productionInputCost:{},extraMaxPop:0,populationGrowth:0,researchSpeed:0,approval:{},coalitionApproval:0,legitimacyBonus:0,organizationDecay:0,factionConflict:0,stability:0,militaryBonus:0,militaryUpkeep:0,diplomaticBonus:0,diplomaticCooldown:0,diplomaticIncident:0};if(!e||!Array.isArray(e))return o;const i=t?1:.5,r=(a,s=i)=>{if(!a||!a.type||typeof a.value!="number")return;const u=a.value*s;switch(a.type){case"buildings":a.target&&(o.buildings[a.target]=(o.buildings[a.target]||0)+u);break;case"buildingProductionMod":case"categories":a.target&&(o.buildingProductionMod[a.target]=(o.buildingProductionMod[a.target]||0)+u);break;case"wartimeProduction":o.wartimeProduction+=u;break;case"tradeBonus":o.tradeBonus+=u;break;case"taxEfficiency":o.taxEfficiency+=u;break;case"buildingCostMod":o.buildingCostMod+=u;break;case"incomePercent":o.incomePercentBonus+=u;break;case"passive":a.target&&(o.passiveGains[a.target]=(o.passiveGains[a.target]||0)+u);break;case"passivePercent":a.target&&(o.passivePercentGains[a.target]=(o.passivePercentGains[a.target]||0)+u);break;case"corruption":o.corruption+=u;break;case"stratumDemandMod":a.target&&(o.decreeStratumDemandMod[a.target]=(o.decreeStratumDemandMod[a.target]||0)+u);break;case"resourceDemandMod":a.target&&(o.decreeResourceDemandMod[a.target]=(o.decreeResourceDemandMod[a.target]||0)+u);break;case"resourceSupplyMod":a.target&&(o.resourceSupplyMod[a.target]=(o.resourceSupplyMod[a.target]||0)+u);break;case"resourceWaste":a.target&&(o.resourceWaste[a.target]=(o.resourceWaste[a.target]||0)+u);break;case"needsReduction":o.needsReduction+=u;break;case"maxPop":o.extraMaxPop+=u;break;case"populationGrowth":o.populationGrowth+=u;break;case"researchSpeed":o.researchSpeed+=u;break;case"approval":a.target&&(o.approval[a.target]=(o.approval[a.target]||0)+u);break;case"coalitionApproval":o.coalitionApproval+=u;break;case"legitimacyBonus":o.legitimacyBonus+=u;break;case"organizationDecay":o.organizationDecay+=u;break;case"factionConflict":o.factionConflict+=u;break;case"stability":o.stability+=u;break;case"militaryBonus":o.militaryBonus+=u;break;case"militaryUpkeep":o.militaryUpkeep+=u;break;case"diplomaticBonus":o.diplomaticBonus+=u;break;case"diplomaticCooldown":o.diplomaticCooldown+=u;break;case"diplomaticIncident":o.diplomaticIncident+=u;break;case"productionInputCost":a.target&&(o.productionInputCost[a.target]=(o.productionInputCost[a.target]||0)+u);break}};return e.forEach(a=>{if(!a||typeof a!="object")return;const s=Sa[a.financialSatisfaction]||Sa.satisfied,u=i*(s.effectMult||1);s.corruption&&(o.corruption+=s.corruption*i),a.effects&&typeof a.effects=="object"&&Object.entries(a.effects).forEach(([c,f])=>{typeof f=="object"&&f!==null?Object.entries(f).forEach(([p,d])=>{r({type:c,target:p,value:d},u)}):r({type:c,value:f},u)}),a.drawbacks&&typeof a.drawbacks=="object"&&Object.entries(a.drawbacks).forEach(([c,f])=>{typeof f=="object"&&f!==null?Object.entries(f).forEach(([p,d])=>{r({type:c,target:p,value:d},u)}):r({type:c,value:f},u)})}),o},Rl=(e,t={})=>{var N,L;if(!e)return 0;const o=(N=t.currentDay)!=null?N:0,i=t.polityEffects||{},r=e.sourceStratum,a=Math.max(0,e.wealth||0),s=Array.isArray(e.ownedProperties)?e.ownedProperties:[],u=s.length,c=s.reduce((W,j)=>W+Math.max(0,(j==null?void 0:j.level)||0),0),f=s.reduce((W,j)=>W+Math.max(0,(j==null?void 0:j.purchaseCost)||0),0),d=(e.hireDate!=null?Math.max(0,o-e.hireDate):0)/365,M=1+Math.min(2.5,Math.log2(d+1)*.9),y=(L={capitalist:260,landowner:240,knight:220,official:200,engineer:180,merchant:170,scribe:140,cleric:140,artisan:120,navigator:120,soldier:110,worker:90,miner:85,lumberjack:80,peasant:75,serf:65,unemployed:60}[r])!=null?L:100,w=t.classInfluence||{},m=Math.max(0,w[r]||0),E=Math.log10(m+1)*70,v=y+E,g=Math.log10(a+1)*60,C=Math.sqrt(u)*55,R=Math.sqrt(c)*45,k=Math.log10(f+1)*40,D=Math.max(0,i.officialCapacity||0),P=1+Math.min(1.2,D*.05),S=Math.max(0,e.stratumInfluenceBonus||0)*120,V=(v+g+C+R+k+S)*M*P;return Math.max(0,V)},Sl=(e,t=!0,o={})=>{const i={},r=o.classInfluence||{},a=o.totalInfluence||0;if(!e||!Array.isArray(e))return i;const s=t?1:.5,u=2e4;return e.forEach(c=>{if(!c||!c.sourceStratum)return;const f=c.sourceStratum,p=Rl(c,o),d=Math.max(0,r[f]||0),M=a>0?d/a:0,h=1+Math.min(.35,M*.7);let w=p*10*h;w=Math.min(u,w)*s,!(w<=0)&&(i[f]=(i[f]||0)+w,f!=="official"&&(i.official=(i.official||0)+w*.25))}),i},Il=(e,t)=>{const o={stability:0,legitimacyBonus:0,gatherBonus:0,industryBonus:0,tradeBonus:0,researchSpeed:0,cultureBonus:0,taxEfficiency:0,incomePercentBonus:0,buildingCostMod:0,needsReduction:0,productionInputCost:{},populationGrowth:0,militaryBonus:0,organizationDecay:0,approval:{},diplomaticBonus:0};let i=0,r=0;if(!e||!Array.isArray(e))return{aggregatedEffects:o,satisfiedCount:i,unsatisfiedCount:r};const a=s=>{!s||typeof s!="object"||Object.entries(s).forEach(([u,c])=>{typeof c=="object"&&c!==null?u==="approval"?Object.entries(c).forEach(([f,p])=>{typeof p=="number"&&(o.approval[f]=(o.approval[f]||0)+p)}):u==="productionInputCost"&&Object.entries(c).forEach(([f,p])=>{typeof p=="number"&&(o.productionInputCost[f]=(o.productionInputCost[f]||0)+p)}):typeof c=="number"&&o.hasOwnProperty(u)&&(o[u]+=c)})};return e.forEach(s=>{if(!s)return;const u=s.stanceConditionParams;Mr(s.politicalStance,t,u)?(i++,a(s.stanceActiveEffects)):(r++,a(s.stanceUnsatisfiedPenalty))}),{aggregatedEffects:o,satisfiedCount:i,unsatisfiedCount:r}},kl=(e,t=0)=>{var p,d;if(!e||typeof e!="object")return e;const o=!!e.investmentProfile,i=Array.isArray(e.ownedProperties),r=e.loyalty===void 0||e.loyalty===null||e.loyalty===0&&((p=e.lowLoyaltyDays)!=null?p:0)>100,a=Number.isFinite(e.salary);if(o&&i&&!r&&a)return e;const s=e.sourceStratum||e.stratum||"peasant",u=e.politicalStance,c=On==null?void 0:On.INITIAL_MIN,f=r?c:e.loyalty;return{...e,financialSatisfaction:e.financialSatisfaction||"satisfied",salary:Number.isFinite(e.salary)?e.salary:Number.isFinite(e.baseSalary)?e.baseSalary:0,baseSalary:Number.isFinite(e.baseSalary)?e.baseSalary:e.salary||0,investmentProfile:o?e.investmentProfile:Ml(s,u,t),ownedProperties:i?e.ownedProperties:[],lastDayPropertyIncome:typeof e.lastDayPropertyIncome=="number"?e.lastDayPropertyIncome:0,loyalty:f,lowLoyaltyDays:r?0:(d=e.lowLoyaltyDays)!=null?d:0}},yi=(e,t)=>{var r,a;if(e.vassalOf!=="player")return{allowed:!0,reason:null};const o=((r=e.vassalPolicy)==null?void 0:r.diplomaticControl)||"guided",i=((a=e.vassalPolicy)==null?void 0:a.tradePolicy)||"preferential";switch(t){case"alliance":if(o!=="autonomous")return{allowed:!1,reason:"当前外交政策禁止独立结盟"};break;case"treaty":if(o==="puppet")return{allowed:!1,reason:"傀儡外交政策禁止独立签署条约"};break;case"trade":if(["monopoly","exclusive","looting"].includes(i))return{allowed:!1,reason:"当前贸易政策禁止独立贸易"};break}return{allowed:!0,reason:null}},Ia=(e,t,o,i)=>{if(!e||!Number.isFinite(t)||t===0)return 0;const r=Number(e.silver||0),a=Math.max(0,r+t),s=a-r;return e.silver=a,typeof i=="function"&&s!==0&&i(s,o),s},an=(e,t,o,i,r)=>{if(!e||!Number.isFinite(o)||o===0)return 0;const a=Number(e[t]||0),s=Math.max(0,a+o),u=s-a;return e[t]=s,typeof r=="function"&&u!==0&&r(u,i,t),u},rn=(e,t,o)=>o?o.some(i=>i.type==="military_alliance"&&i.members.includes(e)&&i.members.includes(t)):!1,Zr=(e,t)=>{if(!Array.isArray(t))return[];const o=new Set;return t.forEach(i=>{!i||i.type!=="military_alliance"||!Array.isArray(i.members)||!i.members.includes(e)||i.members.forEach(r=>{r&&r!==e&&o.add(r)})}),Array.from(o)},Dl=({nation:e,tick:t,epoch:o,resources:i,population:r,army:a,logs:s,onTreasuryChange:u,onResourceChange:c})=>{var w,m;let f=0;const p=i,d=e;if(!d.isAtWar)return{raidPopulationLoss:f};d.warDuration=(d.warDuration||0)+1;const M=(w=d.aggression)!=null?w:.7,h=Math.min(.35,.25+M*.1);if(Math.random()<h){const E=(m=d.militaryStrength)!=null?m:1,v=.08+M*.05,g={},C=or(o,"light"),R=3+Math.random()*5,k=Math.floor(R*E);C.forEach(W=>{if(Ro[W]){const j=Math.floor(k/C.length*(.5+Math.random()*.8));j>0&&(g[W]=j)}});const D={...a},P=Object.values(D).reduce((W,j)=>W+j,0);let T=0,S=0,V=0,N={victory:!0,attackerLosses:{},defenderLosses:{}};if(P===0)T=Math.floor((p.food||0)*v),S=Math.floor((p.silver||0)*(v/2)),V=Math.min(5,Math.max(1,Math.floor(v*25)));else{N=gr({army:g,militaryBuffs:.1},{army:D,militaryBuffs:0}),N.victory&&(T=Math.floor((p.food||0)*v),S=Math.floor((p.silver||0)*(v/2)),V=Math.min(5,Math.max(1,Math.floor(v*25))));const W=N.defenderLosses||{},j={};Object.entries(W).forEach(([H,ce])=>{if(a[H]){const me=Math.min(a[H],ce);a[H]=Math.max(0,a[H]-me),me>0&&(j[H]=me)}}),Object.keys(j).length>0&&s.push(`AUTO_REPLENISH_LOSSES:${JSON.stringify(j)}`)}T>0&&an(p,"food",-T,"rebel_raid_loss",c),S>0&&Ia(p,-S,"rebel_raid_loss",u),V>0&&(f+=V),d.warScore=(d.warScore||0)+(N.victory?-8:6);const L={nationName:d.name,victory:!N.victory,attackerArmy:g,defenderArmy:D,attackerLosses:N.attackerLosses||{},defenderLosses:N.defenderLosses||{},foodLoss:T,silverLoss:S,popLoss:V,ourPower:N.defenderPower||0,enemyPower:N.attackerPower||0,battleReport:N.battleReport||[],actionType:"raid",actionName:"叛军突袭"};s.push(`❗RAID_EVENT❗${JSON.stringify(L)}`)}const y=-(d.warScore||0);if(y>50&&(d.warDuration||0)>20){const E=d.lastSurrenderDemandDay||0;if(t-E>=30&&Math.random()<.05){d.lastSurrenderDemandDay=t;const v=p.silver||0,g=Math.floor((r||0)*.05),C=Math.floor(y/4),R=Math.max(0,(r||100)-10),k=Math.min(Math.max(g,C,10),R),D=Math.max(100,Math.floor(v*.1)),P=D*3,T=Math.ceil(P/365);let S="reform";y>200?S="massacre":y>100&&(S="concession"),s.push(`REBEL_DEMAND_SURRENDER:${JSON.stringify({nationId:d.id,nationName:d.name,rebellionStratum:d.rebellionStratum,coalitionStrata:d.coalitionStrata||[d.rebellionStratum],warScore:d.warScore,warAdvantage:y,primaryDemandType:S,massacreAmount:k,reformAmount:D,subsidyTotalAmount:P,subsidyDailyAmount:T})}`)}}return{raidPopulationLoss:f}},Wl=({nation:e,tick:t,logs:o})=>{const i=e,r=i.warScore||0,a=i.warDuration||0,s=Number.isFinite(i.lastPeaceRequestDay)?i.lastPeaceRequestDay:-1/0;if(t-s>=30&&!i.isPeaceRequesting){const c=Math.max(0,r-20)/100+Math.max(0,a-60)/500,f=Math.min(.4,c*.5);r>30&&Math.random()<f?(i.isPeaceRequesting=!0,i.peaceTribute=0,i.lastPeaceRequestDay=t,o.push(`🏳️ ${i.name} 已陷入绝境，请求投降！`)):r>60&&a>90&&(i.isPeaceRequesting=!0,i.peaceTribute=0,i.lastPeaceRequestDay=t,o.push(`🏳️ ${i.name} 已经崩溃，恳求投降！`))}},Ol=({nation:e,tick:t,epoch:o,resources:i,army:r,logs:a,difficultyLevel:s=_a,onTreasuryChange:u,onResourceChange:c})=>{var ue,Ie;let f=0;const p=e,d=i;if(o<1)return{raidPopulationLoss:f};if(Rr(t,s))return{raidPopulationLoss:f};const M=p.lastMilitaryActionDay||0,h=d0(s);p.militaryCooldownDays||(p.militaryCooldownDays=Math.max(5,7+Math.floor(Math.random()*24)+h));const y=t-M>=p.militaryCooldownDays,w=Math.max(0,-(p.warScore||0));let m=Math.min(.18,.02+(p.aggression||.2)*.04+w/400);if(m=u0(m,s),!y||Math.random()>=m)return{raidPopulationLoss:f};p.lastMilitaryActionDay=t,p.militaryCooldownDays=Math.max(5,7+Math.floor(Math.random()*24)+h);const E=Math.max(p.appearEpoch||0,Math.min(o,(ue=p.expireEpoch)!=null?ue:o)),v=(Ie=p.militaryStrength)!=null?Ie:1,g=Math.max(.3,Math.min(1.5,(p.wealth||500)/800)),C=1+(p.aggression||.2),R=1+Math.max(-.5,(p.warScore||0)/120),k=p.aggression||.2;Object.values(r).reduce((de,Y)=>de+Y,0);const D=-(p.warScore||0),P=(p.traits||[]).includes("maritime")||(p.name||"").includes("海")||(p.name||"").includes("威尼斯");let T="raid",S="light",V={min:2,max:6},N="边境掠夺",L=1;const W=Math.random();v>.7&&k>.5&&D>30&&E>=2?W<.25?(T="siege",S="heavy",V={min:15,max:25},N="围城压制",L=1.5):W<.6?(T="assault",S="medium",V={min:12,max:18},N="正面攻势",L=1.3):W<.75&&k>.6&&(T="scorched_earth",S="heavy",V={min:12,max:20},N="焦土战术",L=1.4):v>.5&&D>10&&E>=1?W<.35?(T="assault",S="medium",V={min:10,max:15},N="正面攻势",L=1.2):W<.5&&P&&E>=2&&(T="naval_raid",S="medium",V={min:8,max:14},N="海上劫掠",L=1.1):D<-20&&k>.6&&W<.3&&(T="scorched_earth",S="medium",V={min:8,max:15},N="焦土战术",L=1.1);const j=(.05+k*.05+w/1200)*L,H=v*g*C*R,ce={},me=or(E,S),U=V.min+Math.random()*(V.max-V.min),J=Math.floor(U*H);me.forEach(de=>{if(Ro[de]){const Y=.5+Math.random()*.8,Re=Math.floor(J/me.length*Y);Re>0&&(ce[de]=Re)}});const ye={...r},te=Object.values(ye).reduce((de,Y)=>de+Y,0),le={raid:1,assault:1.5,siege:2,naval_raid:1.2,scorched_earth:1.8}[T]||1,we={raid:{win:-8,lose:6},assault:{win:-15,lose:12},siege:{win:-25,lose:20},naval_raid:{win:-12,lose:10},scorched_earth:{win:-18,lose:15}}[T]||{win:-8,lose:6};if(te===0){let de=Math.floor((d.food||0)*j*le),Y=Math.floor((d.silver||0)*(j/2)*le),Re=0;de=ji(de,s),Y=ji(Y,s),T==="scorched_earth"&&(Re=Math.floor((d.wood||0)*j*.8),Re=ji(Re,s),Re>0&&an(d,"wood",-Re,"ai_scorched_earth",c)),de>0&&an(d,"food",-de,"ai_war_action_loss",c),Y>0&&Ia(d,-Y,"ai_war_action_loss",u);let Ke=Math.min(Math.floor(3*le),Math.max(1,Math.floor(j*20*le)));Ke=Ar(Ke,s),f+=Ke;const Le={nationName:p.name,victory:!1,attackerArmy:ce,defenderArmy:{},attackerLosses:{},defenderLosses:{},foodLoss:de,silverLoss:Y,woodLoss:Re,popLoss:Ke,ourPower:0,enemyPower:0,actionType:T,actionName:N};a.push(`❗RAID_EVENT❗${JSON.stringify(Le)}`),p.warScore=(p.warScore||0)+we.win;const _t=de+Y+Re;p.wealth=(p.wealth||0)+Math.floor(_t*.08)}else{const de={raid:.1,assault:0,siege:-.1,naval_raid:.15,scorched_earth:.05}[T]||.1,Y={army:ce,militaryBuffs:de},Re={army:ye,militaryBuffs:0,wealth:(d.food||0)+(d.silver||0)+(d.wood||0)},Ke=gr(Y,Re);let Le=0,_t=0,K=0,Ce=0;if(Ke.victory){let Ye=Math.floor((d.food||0)*j*le),et=Math.floor((d.silver||0)*(j/2)*le);Ye=ji(Ye,s),et=ji(et,s),T==="scorched_earth"&&(K=Math.floor((d.wood||0)*j*.8),K=ji(K,s),K>0&&an(d,"wood",-K,"ai_scorched_earth",c)),Ye>0&&an(d,"food",-Ye,"ai_war_action_loss",c),et>0&&Ia(d,-et,"ai_war_action_loss",u);let It=Math.min(Math.floor(3*le),Math.max(1,Math.floor(j*20*le)));It=Ar(It,s),f+=It;const Vt=Ye+et+K;p.wealth=(p.wealth||0)+Math.floor(Vt*.08)}const fe=Ke.defenderLosses||{},He={};Object.entries(fe).forEach(([Ye,et])=>{if(r[Ye]){const It=Math.min(r[Ye],et);r[Ye]=Math.max(0,r[Ye]-It),It>0&&(He[Ye]=It)}}),Object.keys(He).length>0&&a.push(`AUTO_REPLENISH_LOSSES:${JSON.stringify(He)}`);const ie=Object.values(Ke.attackerLosses||{}).reduce((Ye,et)=>Ye+(et||0),0);ie>0&&(p.enemyLosses=(p.enemyLosses||0)+ie);const ze=Ke.victory?we.win:we.lose;p.warScore=(p.warScore||0)+ze;const Zt={nationName:p.name,victory:!Ke.victory,attackerArmy:ce,defenderArmy:ye,attackerLosses:Ke.attackerLosses||{},defenderLosses:Ke.defenderLosses||{},foodLoss:Le,silverLoss:_t,woodLoss:K,popLoss:Ce,ourPower:Ke.defenderPower,enemyPower:Ke.attackerPower,battleReport:Ke.battleReport||[],actionType:T,actionName:N};a.push(`❗RAID_EVENT❗${JSON.stringify(Zt)}`)}return{raidPopulationLoss:f}},Bl=({nation:e,tick:t,lastGlobalPeaceRequest:o=-1/0,logs:i})=>{const r=e,a=Number.isFinite(r.lastPeaceRequestDay)?r.lastPeaceRequestDay:-1/0,s=t-a>=Vc,u=Hc,c=t-o>=u;if((r.warScore||0)>12&&s&&c){const f=Math.min(.5,.03+(r.warScore||0)/120+(r.warDuration||0)/400)+Math.min(.15,(r.enemyLosses||0)/500);if(Math.random()<f){const p=r.warScore||0,d=r.enemyLosses||0,M=r.warDuration||0,h=Math.max(0,r.wealth||0),y=uc(p,d,M,h);return i.push(`🤝 ${r.name} 请求和平，愿意支付 ${y} 银币作为赔款。`),r.isPeaceRequesting=!0,r.peaceTribute=y,r.lastPeaceRequestDay=t,!0}}return!1},jl=({nation:e,tick:t,population:o,playerWealth:i,logs:r})=>{const a=e,s=-(a.warScore||0);if(s>25&&(a.warDuration||0)>30){const u=a.lastSurrenderDemandDay||0;if(t-u>=60&&Math.random()<.03){a.lastSurrenderDemandDay=t;let c="tribute";const f=a.warDuration||0;let p=fc(s,f,i);s>100?(c="territory",p=Math.min(50,Math.max(3,Math.floor(o*.05)))):s>50&&Math.random()<.5&&(c="open_market",p=365*2),r.push(`AI_DEMAND_SURRENDER:${JSON.stringify({nationId:a.id,nationName:a.name,warScore:a.warScore,demandType:c,demandAmount:p})}`)}}},Nl=({nation:e,tick:t,population:o,playerWealth:i,resources:r,logs:a})=>{const s=e;if(!s.isAtWar||s.isPeaceRequesting)return;const u=s.lastMercyPeaceOfferDay||0;if(t-u<30)return;const f=(r==null?void 0:r.silver)||0,p=(r==null?void 0:r.food)||0,d=f+p+((r==null?void 0:r.wood)||0),M=o<20,h=i<50&&f<30,y=d<100&&o<50,w=s.warDuration||0;if(!(w>=30&&(M||h&&o<50||y&&h)))return;const v=s.aggression||.3,g=Math.min(1,(M?.4:0)+(h?.3:0)+(y?.2:0)+(o<10?.3:0)),C=.05+w/500+g*.3,R=v*.15,k=Math.min(.5,Math.max(.1,C-R));Math.random()<k&&(s.lastMercyPeaceOfferDay=t,s.isMercyPeaceOffering=!0,s.mercyPeaceOfferDay=t,a.push(`🕊️ ${s.name} 见你已无力继续战斗，愿意无条件议和。`),a.push(`AI_MERCY_PEACE_OFFER:${JSON.stringify({nationId:s.id,nationName:s.name,warScore:s.warScore,warDuration:w,playerPopulation:o,playerWealth:i})}`))},Ll=({nation:e,nations:t,tick:o,epoch:i,resources:r,stabilityValue:a,logs:s,difficultyLevel:u=_a,diplomacyOrganizations:c})=>{var V,N,L;const f=e,p=r,d=(V=f.relation)!=null?V:50,M=(N=f.aggression)!=null?N:.2,h=f0(u);if(Rr(o,u))return;const y=(t||[]).filter(W=>W.isAtWar===!0&&W.id!==f.id&&!W.isRebelNation).length,w=(t||[]).some(W=>W.isAtWar&&W.warStartDay&&o-W.warStartDay<Zc&&W.id!==f.id),m=y>0?Math.pow(.3,y):1,E=Math.max(0,(50-d)/70),v=a<35?.02:0,g=M>.5?M*.03:0;let C=i>=h?Math.min(.08,M*.04+E*.025+v+g):0;C=Pr(C,u),C*=m;const R=f.peaceTreatyUntil&&o<f.peaceTreatyUntil,k=rn(f.id,"player",c==null?void 0:c.organizations);!f.isAtWar&&!R&&!k&&d<25&&y<Ea&&!w&&Math.random()<C&&(f.isAtWar=!0,f.warStartDay=o,f.warDuration=0,f.warDeclarationPending=!0,s.push(`⚠️ ${f.name} 对你发动了战争！`),s.push(`WAR_DECLARATION_EVENT:${JSON.stringify({nationId:f.id,nationName:f.name})}`),t&&t.forEach(W=>{var j,H;W.vassalOf==="player"&&(((j=W.vassalPolicy)==null?void 0:j.military)||"autonomous")==="auto_join"&&(f.foreignWars||(f.foreignWars={}),W.foreignWars||(W.foreignWars={}),(H=f.foreignWars[W.id])!=null&&H.isAtWar||(f.foreignWars[W.id]={isAtWar:!0,warStartDay:o,warScore:0},W.foreignWars[f.id]={isAtWar:!0,warStartDay:o,warScore:0,followingSuzerain:!0,suzerainTarget:"player"},s.push(`⚔️ ${W.name} 根据军事政策自动对 ${f.name} 宣战！`)))}));const P=(p.food||0)+(p.silver||0)+(p.wood||0),T=f.wealth||500,S=(L=f.militaryStrength)!=null?L:1;if(!f.isAtWar&&!R&&!k&&i>=h&&P>T*2&&S>.8&&d<50&&M>.4&&y<Ea&&!w){let W=.001*M*(P/T-1);W=Pr(W,u),Math.random()<W&&(f.isAtWar=!0,f.warStartDay=o,f.warDuration=0,f.warDeclarationPending=!0,s.push(`⚠️ ${f.name} 觊觎你的财富，发动了战争！`),s.push(`WAR_DECLARATION_EVENT:${JSON.stringify({nationId:f.id,nationName:f.name,reason:"wealth"})}`),t&&t.forEach(j=>{var H,ce;j.vassalOf==="player"&&(((H=j.vassalPolicy)==null?void 0:H.military)||"autonomous")==="auto_join"&&(f.foreignWars||(f.foreignWars={}),j.foreignWars||(j.foreignWars={}),(ce=f.foreignWars[j.id])!=null&&ce.isAtWar||(f.foreignWars[j.id]={isAtWar:!0,warStartDay:o,warScore:0},j.foreignWars[f.id]={isAtWar:!0,warStartDay:o,warScore:0,followingSuzerain:!0,suzerainTarget:"player"},s.push(`⚔️ ${j.name} 根据军事政策自动对 ${f.name} 宣战！`)))}))}},Fl=(e,t,o,i)=>{e.forEach(r=>{if(Object.values(r.foreignWars||{}).filter(c=>c==null?void 0:c.isAtWar).length<3||e.filter(c=>{var f,p;return((p=(f=c.foreignWars)==null?void 0:f[r.id])==null?void 0:p.isAtWar)&&c.id!==r.id}).length>=2)return;const u=e.filter(c=>{var p,d,M,h;return c.id===r.id||(d=(p=c.foreignWars)==null?void 0:p[r.id])!=null&&d.isAtWar||rn(c.id,r.id,i==null?void 0:i.organizations)?!1:((h=(M=c.foreignRelations)==null?void 0:M[r.id])!=null?h:50)<40});if(u.length>=2&&Math.random()<.005){const c=u[Math.floor(Math.random()*u.length)];c.foreignWars||(c.foreignWars={}),r.foreignWars||(r.foreignWars={}),c.foreignWars[r.id]={isAtWar:!0,warStartDay:t,warScore:0},r.foreignWars[c.id]={isAtWar:!0,warStartDay:t,warScore:0},o.push(`⚔️ 国际新闻：${c.name} 认为 ${r.name} 的好战行为威胁地区稳定，对其宣战！`)}})},Ul=(e,t,o,i,r)=>{e.forEach(a=>{a.foreignWars||(a.foreignWars={}),e.forEach(s=>{var T,S,V,N,L;if(s.id===a.id||(T=a.foreignWars[s.id])!=null&&T.isAtWar)return;const u=((S=a.foreignWars[s.id])==null?void 0:S.peaceTreatyUntil)||0;if(o<u||rn(a.id,s.id,r==null?void 0:r.organizations))return;const f=Object.values(a.foreignWars||{}).filter(W=>W==null?void 0:W.isAtWar).length,p=a.aggression>.7?2:1;if(f>=p)return;const d=a.population||100,M=a.wealth||500;if(d<30||M<300)return;const h=W=>{var j;return((j=W.militaryStrength)!=null?j:1)*(W.population||100)*(1+(W.aggression||.3))};let y=h(a),w=h(s);e.forEach(W=>{if(W.id===a.id||W.id===s.id)return;rn(a.id,W.id,r==null?void 0:r.organizations)&&(y+=h(W)),rn(s.id,W.id,r==null?void 0:r.organizations)&&(w+=h(W))});const m=y/Math.max(1,w),E=a.aggression>.7?.5:.7;if(m<E)return;const g=Object.values(s.foreignWars||{}).filter(W=>W==null?void 0:W.isAtWar).length>0?.002:0,C=(N=(V=a.foreignRelations)==null?void 0:V[s.id])!=null?N:50,R=(L=a.aggression)!=null?L:.3,k=C<50,D=R>.25,P=C<15;if(s.vassalOf==="player"&&a.isAtWar,k&&D||P){let W=R*.003+(50-C)/5e3;C<10?W+=.01:C<20&&(W+=.003),m>2?W*=2:m>1.5?W*=1.5:m>1.2?W*=1.2:m<.8&&(W*=.1),W+=g*.5;const j=s.wealth||500;if(j>M*1.5&&m>.8){const H=.003*R*(j/M-1);W+=H}if(W=Math.min(.003,W),Math.random()<W){a.foreignWars[s.id]={isAtWar:!0,warStartDay:o,warScore:0},s.foreignWars||(s.foreignWars={}),s.foreignWars[a.id]={isAtWar:!0,warStartDay:o,warScore:0};const H=[`📢 国际新闻：${a.name} 向 ${s.name} 宣战了！`,`📢 国际新闻：${a.name} 正式对 ${s.name} 宣战！`,`📢 国际新闻：战争爆发！${a.name} 对 ${s.name} 发起了战争！`];i.push(H[Math.floor(Math.random()*H.length)]),s.vassalOf==="player"&&(a.isAtWar||(a.isAtWar=!0,a.warStartDay=o,a.warDuration=0,a.warDeclarationPending=!0,i.push(`⚠️ ${a.name} 攻击了您的附庸 ${s.name}，自动对您宣战！`)));const ce=s.alliedWithPlayer===!0,me=a.alliedWithPlayer===!0,U=ce&&me,J=e.filter(ue=>ue.isAtWar===!0&&!ue.isRebelNation).length;U?i.push(`⚖️ 你的盟友 ${a.name} 与 ${s.name} 发生冲突，你选择保持中立。`):(ce&&!a.isAtWar&&i.push(`ALLY_ATTACKED_EVENT:${JSON.stringify({allyId:s.id,allyName:s.name,attackerId:a.id,attackerName:a.name,currentPlayerWars:J})}`),me&&!s.isAtWar&&(J>=Ea?i.push(`⚖️ 你的盟友 ${a.name} 向 ${s.name} 宣战！但你已陷入多场战争，选择不介入。`):(s.isAtWar=!0,s.warStartDay=o,s.warDuration=0,s.relation=Math.max(0,(s.relation||50)-40),i.push(`⚔️ 你的盟友 ${a.name} 向 ${s.name} 宣战！作为同盟，你被迫与 ${s.name} 进入战争状态！`))));const ye=(r==null?void 0:r.organizations)||[],te=Zr(a.id,ye),le=Zr(s.id,ye),we=new Set(te.filter(ue=>le.includes(ue)));le.forEach(ue=>{if(we.has(ue)||ue===a.id||ue===s.id)return;const Ie=e.find(de=>de.id===ue);Ie&&(Ie.foreignWars||(Ie.foreignWars={}),Ie.foreignWars[a.id]={isAtWar:!0,warStartDay:o,warScore:0},a.foreignWars||(a.foreignWars={}),a.foreignWars[Ie.id]={isAtWar:!0,warStartDay:o,warScore:0},i.push(`?? ${Ie.name} ?? ${s.name} ????????? ${a.name} ????`))}),we.size>0&&we.forEach(ue=>{const Ie=e.find(de=>de.id===ue);Ie&&i.push(`?? ${Ie.name} ???????????????`)})}}})})},$l=(e,t,o,i)=>{const r=new Set(e.map(a=>a.id));e.forEach(a=>{Object.keys(a.foreignWars||{}).forEach(s=>{var E,v;const u=a.foreignWars[s];if(!(u!=null&&u.isAtWar))return;const c=t.find(g=>g.id===s);if(!c||!r.has(s)){a.foreignWars[s]={isAtWar:!1},c&&i.push(`⚔️ ${a.name} 与 ${c.name} 的战争因对方势力消亡而结束。`);return}c.foreignWars||(c.foreignWars={}),c.foreignWars[a.id]||(c.foreignWars[a.id]={isAtWar:!0,warStartDay:u.warStartDay||o,warScore:-(u.warScore||0)});const f=o-(u.warStartDay||o),p=Math.min(2,1+f/500),d=.995-p*.003,M=.998-p*.002,h=Object.values(a.foreignWars||{}).filter(g=>g==null?void 0:g.isAtWar).length,y=Object.values(c.foreignWars||{}).filter(g=>g==null?void 0:g.isAtWar).length,w=Math.pow(.998,h-1),m=Math.pow(.998,y-1);if(a.wealth=Math.max(100,(a.wealth||500)*d*w),a.population=Math.max(10,(a.population||100)*M*w),c.wealth=Math.max(100,(c.wealth||500)*d*m),c.population=Math.max(10,(c.population||100)*M*m),(o-u.warStartDay)%10===0&&o>u.warStartDay){const g=((E=a.militaryStrength)!=null?E:1)*(a.population||100)*(1+(a.aggression||.3)),C=((v=c.militaryStrength)!=null?v:1)*(c.population||100)*(1+(c.aggression||.3)),R=g+C,k=g/R,D=.02+Math.random()*.03;if(a.population=Math.max(10,(a.population||100)*(1-D*(1-k))),c.population=Math.max(10,(c.population||100)*(1-D*k)),Math.random()<k){u.warScore=(u.warScore||0)+5,c.foreignWars[a.id].warScore=(c.foreignWars[a.id].warScore||0)-5;const N=Math.floor((c.wealth||500)*.08);a.wealth=(a.wealth||500)+N,c.wealth=Math.max(100,(c.wealth||500)-N)}else{u.warScore=(u.warScore||0)-5,c.foreignWars[a.id].warScore=(c.foreignWars[a.id].warScore||0)+5;const N=Math.floor((a.wealth||500)*.08);c.wealth=(c.wealth||500)+N,a.wealth=Math.max(100,(a.wealth||500)-N)}u.endScoreThreshold||(u.endScoreThreshold=25+Math.floor(Math.random()*56));const P=Math.abs(u.warScore||0),T=(a.population||100)<30||(a.wealth||500)<200,S=(c.population||100)<30||(c.wealth||500)<200,V=T||S?.03:.005;if(P>=u.endScoreThreshold||Math.random()<V){const N=(u.warScore||0)>0?a:c,L=N.id===a.id?c:a,W=Math.abs(u.warScore||0);let j="draw",H=0,ce=0,me=365,U="僵持";W>=200?(j="overwhelming",H=.25,ce=.35,me=365*3,U="压倒性胜利"):W>=100?(j="major",H=.15,ce=.25,me=Math.floor(365*2.5),U="大胜"):W>=50?(j="minor",H=.08,ce=.12,me=365*2,U="小胜"):W>=25&&(j="pyrrhic",H=.03,ce=.05,me=Math.floor(365*1.5),U="惨胜");const J=Math.floor((L.population||100)*H),ye=Math.floor((L.wealth||500)*ce);N.population=(N.population||100)+J,N.wealth=(N.wealth||500)+ye,L.population=Math.max(10,(L.population||100)-J),L.wealth=Math.max(100,(L.wealth||500)-ye);let te=!1;j==="overwhelming"&&(L.population||100)<30&&(L.wealth||500)<300&&(N.population=(N.population||100)+(L.population||0),N.wealth=(N.wealth||500)+(L.wealth||0),L.isAnnexed=!0,L.annexedBy=N.id,L.annexedAt=o,L.population=0,L.wealth=0,te=!0),a.foreignWars[s]={isAtWar:!1,peaceTreatyUntil:o+me},c.foreignWars[a.id]={isAtWar:!1,peaceTreatyUntil:o+me};const le=10+Math.floor(W/10);a.foreignRelations||(a.foreignRelations={}),c.foreignRelations||(c.foreignRelations={}),a.foreignRelations[s]=$t((a.foreignRelations[s]||50)-le,0,100),c.foreignRelations[a.id]=$t((c.foreignRelations[a.id]||50)-le,0,100);const we=o-(u.warStartDay||o);te?i.push(`📢 国际新闻：${N.name} 在历时${we}天的战争中彻底击败 ${L.name}，将其吞并！`):j==="draw"?i.push(`📢 国际新闻：${a.name} 与 ${c.name} 经过${we}天的战争后握手言和。`):i.push(`📢 国际新闻：${N.name} 在与 ${L.name} 历时${we}天的战争中取得${U}！`)}}})})},Ni={military_alliance:{id:"military_alliance",name:"军事联盟",minEra:3,minMembers:2,maxMembers:6,createCost:.05,memberFee:.001,minRelation:60,leaveCost:.03,founderLeaveCost:.08,leaveRelationPenalty:-15,founderLeaveRelationPenalty:-25,founderLeaveDisbands:!0,kickRelationPenalty:-20,effects:{mutualDefense:!0,relationBonus:5,militaryBonus:.1},description:"成员国互相保护，共同对抗外敌"},economic_bloc:{id:"economic_bloc",name:"经济共同体",minEra:5,minMembers:2,maxMembers:10,createCost:.08,memberFee:.002,minRelation:45,leaveCost:.05,founderLeaveCost:.12,leaveRelationPenalty:-10,founderLeaveRelationPenalty:-20,founderLeaveDisbands:!0,kickRelationPenalty:-15,effects:{tariffDiscount:.3,relationBonus:5,tradeEfficiency:.2},description:"成员国共享经济利益，减免关税，促进贸易自由化"}};function Qr({type:e,founderId:t,founderName:o,name:i=null,epoch:r=0,daysElapsed:a=0}){var f;const s=Ni[e];if(!s)throw new Error(`无效的组织类型: ${e}`);if(!Ao("organizations",e,r))return{success:!1,reason:`需要 ${(f=ir.organizations[e])==null?void 0:f.name} 时代解锁`};const u=`org_${e}_${Date.now()}`,c=i||`${o}主导的${s.name}`;return{success:!0,organization:{id:u,type:e,name:c,founderId:t,members:[t],createdDay:a,isActive:!0}}}function Gl({organizations:e=[],nations:t=[],playerWealth:o=0,daysElapsed:i=0}){const r=[],a={player:0,ai:{}},s=[];for(const u of e){if(!u.isActive){s.push(u);continue}const c=Ni[u.type];if(!c){s.push(u);continue}for(const f of u.members)if(f==="player"){const p=Math.floor(o*c.memberFee);a.player+=p,p>0&&r.push(`🏛️ ${u.name}成员费: -${p.toLocaleString()}银`)}else{const p=t.find(d=>d.id===f);if(p){const d=Math.floor((p.wealth||1e3)*c.memberFee);a.ai[f]=(a.ai[f]||0)+d}}s.push(u)}return{updatedOrganizations:s,fees:a,logs:r}}function ql(e){const t=Ni[e.type];return!t||e.members.length<t.minMembers}const Kr=(e,t,o,i)=>{if(!e||!Number.isFinite(t)||t===0)return 0;const r=Number(e.silver||0),a=Math.max(0,r+t),s=a-r;return e.silver=a,typeof i=="function"&&s!==0&&i(s,o),s},Vl=e=>Array.isArray(e)?e.map(t=>(t.foreignRelations||(t.foreignRelations={}),e.forEach(o=>{if(o.id!==t.id){if(t.foreignRelations[o.id]===void 0){const i=((t.aggression||.3)+(o.aggression||.3))/2;t.foreignRelations[o.id]=Math.floor(50-i*30+(Math.random()-.5)*20)}if(Math.random()<.05){const i=(Math.random()-.5)*6;t.foreignRelations[o.id]=$t((t.foreignRelations[o.id]||50)+i,0,100)}}}),t)):[],Hl=(e,t)=>!(t%30===0)||!Array.isArray(e)?e||[]:e.map(i=>{var c;if(i.isRebelNation)return i;const r=(c=i.relation)!=null?c:50,s=i.alliedWithPlayer===!0?.1:.5;let u=r;return r>50?u=Math.max(50,r-s):r<50&&(u=Math.min(50,r+s)),{...i,relation:u}}),Yl=(e,t,o,i="normal")=>{if(!Array.isArray(e))return;const r=m0(i),a=g0(i);e.forEach(s=>{var c,f;if(s.isRebelNation||s.alliedWithPlayer!==!0||((c=s.relation)!=null?c:50)>=70)return;const u=s.lastAllyColdEventDay||0;t-u<r||Math.random()<a&&(s.lastAllyColdEventDay=t,o.push(`ALLY_COLD_EVENT:${JSON.stringify({nationId:s.id,nationName:s.name,relation:Math.round((f=s.relation)!=null?f:50)})}`))})},Xl=(e,t)=>{e.forEach(o=>{var c;if(Math.random()>.02)return;const i=(c=o.aggression)!=null?c:.3,r=o.wealth||500;if(i>.6||r<300)return;const a=e.filter(f=>{var d,M,h,y;if(f.id===o.id||(M=(d=o.foreignWars)==null?void 0:d[f.id])!=null&&M.isAtWar)return!1;const p=(y=(h=o.foreignRelations)==null?void 0:h[f.id])!=null?y:50;return p>=40&&p<80});if(a.length===0)return;const s=a[Math.floor(Math.random()*a.length)],u=sr(r,s.wealth);if(r>u*3){o.wealth=Math.max(0,(o.wealth||0)-u),s.wealth=(s.wealth||0)+u;const f=Math.floor(5+Math.random()*8);o.foreignRelations||(o.foreignRelations={}),s.foreignRelations||(s.foreignRelations={}),o.foreignRelations[s.id]=$t((o.foreignRelations[s.id]||50)+f,0,100),s.foreignRelations[o.id]=$t((s.foreignRelations[o.id]||50)+f,0,100),o.foreignRelations[s.id]>=80&&s.foreignRelations[o.id]>=80?t.push(`🤝 国际新闻：${o.name} 与 ${s.name} 达成同盟协议！`):Math.random()<.3&&t.push(`💝 国际新闻：${o.name} 向 ${s.name} 赠送了外交礼物，两国关系升温。`)}})},zl=(e,t,o)=>{const i=e==null?void 0:e.organizations;return Array.isArray(i)?i.reduce((r,a)=>{if(!a||!Array.isArray(a.members)||!a.members.includes(t)||!a.members.includes(o))return r;const s=wa[a.type]||{};return{tariffDiscount:Math.max(r.tariffDiscount,s.tariffDiscount||0),relationBonus:Math.max(r.relationBonus,s.relationBonus||0)}},{tariffDiscount:0,relationBonus:0}):{tariffDiscount:0,relationBonus:0}},Jl=(e,t,o=null)=>{e.forEach(i=>{if(Math.random()>.02||i.isAtWar||!yi(i,"trade").allowed||(i.wealth||500)<300)return;const s=e.filter(y=>{var E,v,g,C;return y.id===i.id||y.isAtWar||(v=(E=i.foreignWars)==null?void 0:E[y.id])!=null&&v.isAtWar||!yi(y,"trade").allowed?!1:((C=(g=i.foreignRelations)==null?void 0:g[y.id])!=null?C:50)>=30});if(s.length===0)return;const u=s[Math.floor(Math.random()*s.length)],c=Math.floor(20+Math.random()*60),f=.08,p=zl(o,i.id,u.id),d=f*(1-p.tariffDiscount);if(c*(1-d)-c*.5<=0)return;i.wealth=(i.wealth||0)+c*.05,u.wealth=(u.wealth||0)+c*.05,i.foreignRelations||(i.foreignRelations={}),u.foreignRelations||(u.foreignRelations={});const h=1+(p.relationBonus||0);i.foreignRelations[u.id]=Math.min(100,(i.foreignRelations[u.id]||50)+h),u.foreignRelations[i.id]=Math.min(100,(u.foreignRelations[i.id]||50)+h)})},Zl=(e,t,o,i,r,a={},s=null,u=null)=>{const c=o,f=(s==null?void 0:s.organizations)||[],p=d=>{var h;const M=f.find(y=>Array.isArray(y==null?void 0:y.members)&&y.members.includes("player")&&y.members.includes(d));return M&&((h=wa[M.type])==null?void 0:h.tariffDiscount)||0};e.forEach(d=>{var S,V,N,L,W,j,H,ce,me,U,J,ye;if(Math.random()>.005||d.isAtWar||((S=d.relation)!=null?S:50)<40)return;const M=d.wealth||500;if(M<400)return;const h=d.openMarketUntil&&t<d.openMarketUntil,y=Math.random()>.5,w=["food","wood","stone","iron"],m=w[Math.floor(Math.random()*w.length)],E=((V=i==null?void 0:i.prices)==null?void 0:V[m])||((N=Be[m])==null?void 0:N.basePrice)||1,v=((L=a==null?void 0:a.resourceTaxRates)==null?void 0:L[m])||0,g=y?(ce=(H=(W=a==null?void 0:a.exportTariffMultipliers)==null?void 0:W[m])!=null?H:(j=a==null?void 0:a.resourceTariffMultipliers)==null?void 0:j[m])!=null?ce:0:(ye=(J=(me=a==null?void 0:a.importTariffMultipliers)==null?void 0:me[m])!=null?J:(U=a==null?void 0:a.resourceTariffMultipliers)==null?void 0:U[m])!=null?ye:0,C=p(d.id),R=g*(1-C),k=h?0:v+R,D=Math.floor(10+Math.random()*40),P=D*E,T=Math.floor(P*k);if(y){const te=E*1.5,le=D*te,we=P+T;if(le<=we)return;(c[m]||0)>=D&&(c[m]=(c[m]||0)-D,Kr(c,T,"ai_trade_tariff",u),d.wealth=Math.max(0,(d.wealth||0)-P-T),d.inventory||(d.inventory={}),d.inventory[m]=(d.inventory[m]||0)+D,r.push(`AI_TRADE_EVENT:${JSON.stringify({nationId:d.id,nationName:d.name,tradeType:"export",resourceKey:m,quantity:D,baseValue:P,tariff:T,isOpenMarket:h})}`),d.relation=Math.min(100,(d.relation||50)+2))}else{const te=D*E*.6;if(P-T<=te)return;M>=P*.6&&(c[m]=(c[m]||0)+D,Kr(c,T,"ai_trade_tariff",u),d.wealth=(d.wealth||0)+P-T,d.inventory||(d.inventory={}),d.inventory[m]=Math.max(0,(d.inventory[m]||0)-D),r.push(`AI_TRADE_EVENT:${JSON.stringify({nationId:d.id,nationName:d.name,tradeType:"import",resourceKey:m,quantity:D,baseValue:P,tariff:T,isOpenMarket:h})}`),d.relation=Math.min(100,(d.relation||50)+2))}})},Ql=(e,t,o,i)=>{e.forEach(r=>{var g;const a=r.wealth||500,s=(g=r.aggression)!=null?g:.3,u=r.relation||0;if(r.isAtWar===!0)return;if(yi(r,"treaty"),r.peaceTreatyUntil&&t<r.peaceTreatyUntil){const C=lc(o),R=Number.isFinite(r.lastTreatyBreachDay)?r.lastTreatyBreachDay:-1/0,k=t-R>=C.cooldownDays,D=u<15&&s>.55;if(k&&D){const P=Math.min(.05,.005+.02*(s-.55)+Math.max(0,(15-u)/500));Math.random()<P&&(r.relation=Math.max(0,u-C.relationPenalty),r.peaceTreatyUntil=void 0,Array.isArray(r.treaties)&&(r.treaties=r.treaties.filter(T=>!rc.includes(T.type))),r.lastTreatyBreachDay=t,i.push(`AI_TREATY_BREACH:${JSON.stringify({nationId:r.id,nationName:r.name,relationPenalty:C.relationPenalty})}`),i.push(`⚠️ ${r.name} 撕毁了与你的和平条约，关系恶化（-${C.relationPenalty}）。`))}}const f=r.lastGiftToPlayerDay||0,d=t-f>=1825,M=2e-5+u/1e6+a/1e8;if(d&&a>1e3&&u>=70&&s<.4&&Math.random()<M){const C=sr(a);r.wealth=Math.max(0,r.wealth-C),r.lastGiftToPlayerDay=t,i.push(`AI_GIFT_EVENT:${JSON.stringify({nationId:r.id,nationName:r.name,amount:Math.floor(C)})}`)}const h=5e-5+Math.max(0,(400-a)/1e6);if(o>=1&&a<400&&Math.random()<h){const C=Math.floor(80+Math.random()*120);i.push(`AI_REQUEST_EVENT:${JSON.stringify({nationId:r.id,nationName:r.name,resourceKey:"silver",resourceName:"银币",amount:C})}`)}const y=r.alliedWithPlayer===!0,w=r.lastAllianceRequestDay||0,E=t-w>=1095,v=5e-5+(u-70)/1e5;E&&!y&&u>=70&&s<.5&&Math.random()<v&&(r.lastAllianceRequestDay=t,i.push(`AI_ALLIANCE_REQUEST:${JSON.stringify({nationId:r.id,nationName:r.name})}`))})},Kl=(e,t,o,i,r)=>{if(!Ao("organizations","economic_bloc",r))return{createdOrganizations:[],memberJoinRequests:[]};const a=(i==null?void 0:i.organizations)||[],s={createdOrganizations:[],memberJoinRequests:[]};return[...e].sort(()=>Math.random()-.5).forEach(c=>{if(Math.random()>.015||(c.wealth||0)<1500||a.find(h=>h.type==="economic_bloc"&&h.members.includes(c.id)))return;const p=e.filter(h=>{var E,v,g,C;if(h.id===c.id||(h.wealth||0)<2e3||!yi(h,"alliance").allowed)return!1;const w=(v=(E=c.foreignRelations)==null?void 0:E[h.id])!=null?v:50,m=(C=(g=h.foreignRelations)==null?void 0:g[c.id])!=null?C:50;return w>=55&&m>=55});if(p.length===0)return;const d=p[Math.floor(Math.random()*p.length)],M=a.find(h=>h.type==="economic_bloc"&&h.members.includes(d.id));if(M)M.members.map(w=>e.find(m=>m.id===w)).filter(w=>w).every(w=>{var m,E;return((E=(m=w.foreignRelations)==null?void 0:m[c.id])!=null?E:50)>=50})&&(s.memberJoinRequests.push({orgId:M.id,nationId:c.id,orgName:M.name}),o.push(`💰 ${c.name} 此刻申请加入 "${M.name}" 以寻求经济合作。`));else{const h=["贸易同盟","经济共同体","自由市场协定","关税同盟","繁荣互助会","商业联合会"],y=h[Math.floor(Math.random()*h.length)]+(Math.random()>.5?"":` (${c.name})`),w=Qr({type:"economic_bloc",founderId:c.id,founderName:c.name,name:y,epoch:r,daysElapsed:t});if(w.success){const m=w.organization;m.members.push(d.id),s.createdOrganizations.push(m),o.push(`💰 国际新闻：${c.name} 与 ${d.name} 宣布共同建立 "${y}"！`)}}}),s},eu=(e,t,o,i,r)=>{if(!Ao("organizations","military_alliance",r))return{createdOrganizations:[],memberJoinRequests:[]};const a=(i==null?void 0:i.organizations)||[],s={createdOrganizations:[],memberJoinRequests:[]};if([...e].sort(()=>Math.random()-.5).forEach(c=>{var y;if(Math.random()>.02||!yi(c,"alliance").allowed||((y=c.aggression)!=null,a.find(w=>w.type==="military_alliance"&&w.members.includes(c.id))))return;const d=e.filter(w=>{var g,C,R,k,D,P,T,S;if(w.id===c.id||!yi(w,"alliance").allowed||(C=(g=c.foreignWars)==null?void 0:g[w.id])!=null&&C.isAtWar||(k=(R=w.foreignWars)==null?void 0:R[c.id])!=null&&k.isAtWar)return!1;const E=(P=(D=c.foreignRelations)==null?void 0:D[w.id])!=null?P:50,v=(S=(T=w.foreignRelations)==null?void 0:T[c.id])!=null?S:50;return E>=65&&v>=65});if(d.length===0)return;const M=d[Math.floor(Math.random()*d.length)],h=a.find(w=>w.type==="military_alliance"&&w.members.includes(M.id));if(h)h.members.map(E=>e.find(v=>v.id===E)).filter(E=>E).every(E=>{var g,C;return((C=(g=E.foreignRelations)==null?void 0:g[c.id])!=null?C:50)>=60})&&(s.memberJoinRequests.push({orgId:h.id,nationId:c.id,orgName:h.name}),o.push(`🛡️ ${c.name} 加入了由 ${M.name} 所在的 "${h.name}"！`));else{const w=["北方","南方","东方","西方","神圣","大","自由","联合"],m=["协约","同盟","公约组织","防卫阵线","联盟"],E=w[Math.floor(Math.random()*w.length)],v=m[Math.floor(Math.random()*m.length)],g=`${E}${v}`,C=Qr({type:"military_alliance",founderId:c.id,founderName:c.name,name:g,epoch:r,daysElapsed:t});if(C.success){const R=C.organization;R.members.push(M.id),s.createdOrganizations.push(R),o.push(`🤝 国际新闻：${c.name} 与 ${M.name} 共同建立了新的军事同盟——"${g}"！`)}}}),r>=5){const c=Kl(e,t,o,i,r);s.createdOrganizations.push(...c.createdOrganizations),s.memberJoinRequests.push(...c.memberJoinRequests)}return s},tu=(e,t,o,i,r)=>{const a=(i==null?void 0:i.organizations)||[],s={memberJoinRequests:[]},u=new Map(e.map(c=>[c.id,c]));return a.forEach(c=>{var E;if(!c||c.isActive===!1||!["military_alliance","economic_bloc"].includes(c.type)||!Ao("organizations",c.type,r))return;const f=Ni[c.type],p=(f==null?void 0:f.maxMembers)||10;if(((E=c.members)==null?void 0:E.length)>=p)return;const d=e.filter(v=>!(!v||v.isRebelNation||c.members.includes(v.id)||!yi(v,"alliance").allowed));if(d.length===0)return;const M=c.type==="military_alliance"?65:55,h=d.map(v=>{var D,P,T,S,V,N;let g=0,C=0,R=100;for(const L of c.members||[]){if(L==="player")continue;const W=u.get(L);if(!W)continue;if((P=(D=v.foreignWars)==null?void 0:D[L])!=null&&P.isAtWar)return null;const j=(S=(T=v.foreignRelations)==null?void 0:T[L])!=null?S:50,H=(N=(V=W.foreignRelations)==null?void 0:V[v.id])!=null?N:50;R=Math.min(R,j,H),g+=j+H,C+=2}if(C===0)return null;const k=g/C;return R<M-5?null:{candidate:v,avgRel:k}}).filter(Boolean);if(h.length===0)return;h.sort((v,g)=>g.avgRel-v.avgRel);const y=h[0],w=c.type==="military_alliance"?.04:.05,m=Math.max(0,(y.avgRel-60)/800);Math.random()>w+m||(s.memberJoinRequests.push({orgId:c.id,nationId:y.candidate.id,orgName:c.name}),o.push(`🏛️ ${y.candidate.name} 受邀加入 "${c.name}"。`))}),s},ou=(e,t,o,i,r)=>{const a=(i==null?void 0:i.organizations)||[],s={memberLeaveRequests:[]},u=new Map(e.map(c=>[c.id,c]));return a.forEach(c=>{var p,d,M,h,y;if(!c||c.isActive===!1||!["military_alliance","economic_bloc"].includes(c.type)||!Ao("organizations",c.type,r))return;const f=c.type==="military_alliance"?40:35;for(const w of c.members||[]){if(w==="player")continue;const m=u.get(w);if(!m)continue;let E=0,v=0,g=!1;for(const D of c.members||[]){if(D===w)continue;if(D==="player"){E+=(p=m.relation)!=null?p:50,v+=1;continue}const P=(M=(d=m.foreignRelations)==null?void 0:d[D])!=null?M:50;E+=P,v+=1,(y=(h=m.foreignWars)==null?void 0:h[D])!=null&&y.isAtWar&&(g=!0)}const C=v>0?E/v:50,k=.01+Math.max(0,f-C)/200+(g?.08:0);C<f&&Math.random()<k&&(s.memberLeaveRequests.push({orgId:c.id,nationId:w,orgName:c.name}),o.push(`💔 ${m.name} 退出了 "${c.name}"。`))}}),s},iu=(e,t,o,i,r)=>{const a=(i==null?void 0:i.organizations)||[];a.length!==0&&e.forEach(s=>{var w,m;if(!s||s.isRebelNation||s.isAtWar)return;const u=(w=s.relation)!=null?w:50;if(u<60)return;const c=s.lastOrgInviteDay||0;if(t-c<360)return;const p=a.filter(E=>{var v,g;return(E==null?void 0:E.isActive)!==!1&&["military_alliance","economic_bloc"].includes(E.type)&&((v=E.members)==null?void 0:v.includes(s.id))&&!((g=E.members)!=null&&g.includes("player"))});if(p.length===0)return;const d=p.find(E=>Ao("organizations",E.type,r));if(!d)return;const M=Ni[d.type],h=(M==null?void 0:M.maxMembers)||10;if(((m=d.members)==null?void 0:m.length)>=h)return;const y=.001+Math.max(0,(u-60)/5e4);Math.random()>y||(s.lastOrgInviteDay=t,o.push(`AI_ORG_INVITE:${JSON.stringify({nationId:s.id,nationName:s.name,orgId:d.id,orgName:d.name,orgType:d.type})}`))})},nu=(e,t,o)=>{var s;if(!o)return null;const i=(o.organizations||[]).filter(u=>u.type==="military_alliance"&&u.members.includes(e.id)&&u.members.includes("player"));if(i.length===0)return null;if(((s=e.relation)!=null?s:50)<30||(e.allianceStrain||0)>=3){const u=i.map(c=>({orgId:c.id,nationId:e.id,orgName:c.name}));return e.allianceStrain=0,u.forEach(c=>{t.push(`💔 ${e.name} 由于与你的关系恶化，退出了 "${c.orgName}"。`)}),{memberLeaveRequests:u}}return null},au=(e,t="normal")=>{var s;const o=(s=e.relation)!=null?s:50;let i=0;const r=Ir(t),a=h0(t);o>50?i=-a*r.bad:o<50&&(i=a*r.good),e.relation=Math.max(0,Math.min(100,o+i)),e.foreignRelations&&Object.keys(e.foreignRelations).forEach(u=>{var f;let c=(f=e.foreignRelations[u])!=null?f:50;c>50?c-=a*r.bad:c<50&&(c+=a*r.good),e.foreignRelations[u]=Math.max(0,Math.min(100,c))})},ru=(e,t,o,i)=>{if(!e||!Number.isFinite(t)||t===0)return 0;const r=Number(e.silver||0),a=Math.max(0,r+t),s=a-r;return e.silver=a,typeof i=="function"&&s!==0&&i(s,o),s},su=({nation:e,tick:t,gameSpeed:o})=>{var f;const i=e;i.inventory?i.inventory={...i.inventory}:i.inventory={},typeof i.budget!="number"&&(i.budget=(i.wealth||800)*.5);const r=((f=i.economyTraits)==null?void 0:f.resourceBias)||{},a=Object.keys(Be).filter(Qt);if(a.length>0){const d=i.isAtWar||i.foreignWars&&Object.values(i.foreignWars).some(w=>w==null?void 0:w.isAtWar)?1.3+(i.aggression||.2)*.5:1,M=i.epoch||0,h=1+M*.5+Math.pow(M,1.3)*.1,y=Math.max(.8,Math.min(2,(i.wealth||1e3)/1e3));a.forEach(w=>{var ue;const m=(ue=r[w])!=null?ue:1,E=i.inventory[w]||0,v=Math.round(500*Math.pow(m,1.2)),g=Math.round(v*h*y),C=5*o*h*y,R=5*o*h*y*d,k=w.split("").reduce((Ie,de)=>Ie+de.charCodeAt(0),0),D=600+k%200,P=Math.sin(t*2*Math.PI/D+k*.1),T=.35+Math.abs(m-1)*.45,S=m>1?1+Math.max(0,P)*T+.2:1-Math.max(0,P)*T*.4,V=m<1?1+Math.max(0,P)*T+.15:1-Math.max(0,P)*T*.25,N=C*Math.pow(m,1.2)*S,L=R*Math.pow(1/m,.8)*V,W=E/g;let j=1,H=1;W>1.5?(j*=.5,H*=1.15):W>1.1?(j*=.8,H*=1.05):W<.5?(j*=1.5,H*=.85):W<.9&&(j*=1.2,H*=.95);const ce=(g-E)*.01*o,me=(Math.random()-.5)*g*.1*o,U=N*j,J=L*H,ye=U-J+ce+me,te=g*.2,le=g*3,we=E+ye;i.inventory[w]=Math.max(te,Math.min(le,we))})}const s=(i.wealth||800)*.5,u=.02,c=s-i.budget;i.budget=i.budget+c*u*o,i.budget=Math.max(0,i.budget)},cu=({nation:e,tick:t})=>{var i;const o=e;if(!((i=o.economyTraits)!=null&&i.ownBasePopulation)){const a=(o.wealthTemplate||800)/800;o.economyTraits={...o.economyTraits||{},ownBasePopulation:Math.max(5,Math.round(16*a*(.8+Math.random()*.4))),ownBaseWealth:Math.max(500,Math.round(1e3*a*(.8+Math.random()*.4))),developmentRate:.8+(o.aggression||.3)*.3+Math.random()*.4,lastGrowthTick:t}}},lu=({nation:e,tick:t})=>{const o=e;if(!o.economyTraits)return;const i=o.economyTraits.ownBasePopulation,r=o.economyTraits.ownBaseWealth,a=o.economyTraits.developmentRate||1;if(t-(o.economyTraits.lastGrowthTick||0)>=100){const u=Math.max(1,(i||10)/200),c=$t(1/(1+u*.6),.2,1),f=.3*a*c;if(Math.random()<f&&!o.isAtWar){const p=(1.03+Math.random()*.05)*c,d=(1.04+Math.random()*.08)*Math.max(.4,c);o.economyTraits.ownBasePopulation=Math.round(i*p),o.economyTraits.ownBaseWealth=Math.round(r*d)}o.economyTraits.lastGrowthTick=t}},uu=({nation:e,epoch:t,playerPopulationBaseline:o,playerWealthBaseline:i,tick:r})=>{var Ie,de,Y,Re,Ke,Le,_t,K,Ce,fe,He,ie;const a=e,s=a.foreignPower||{},u=$t((de=(Ie=s.volatility)!=null?Ie:a.marketVolatility)!=null?de:.3,.1,.9),c=$t((Re=(Y=s.populationFactor)!=null?Y:s.baseRating)!=null?Re:1,.6,2.5),f=$t((Ke=s.wealthFactor)!=null?Ke:s.baseRating?s.baseRating*1.1:1.1,.5,3.5),p=1+Math.max(0,t-((Le=s.appearEpoch)!=null?Le:0))*.03,d=1+Math.max(0,t)*.15,M=(((_t=a.economyTraits)==null?void 0:_t.ownBasePopulation)||16)*d*c,h=(((K=a.economyTraits)==null?void 0:K.ownBaseWealth)||1e3)*d*f,y=.05,w=o*c*p,m=i*f*p,E=M*(1-y)+w*y,v=h*(1-y)+m*y,g=Math.max(1,(a.wealthTemplate||800)/Math.max(800,i)*.8),C=Math.max(1,(a.wealthTemplate||800)/Math.max(800,i)*1.1),R=Wi("food",a,r),k=R.isShortage?$t(1-R.shortageAmount/Math.max(1,R.target),.5,1):1,D=R.isSurplus?$t(1+R.surplusAmount/Math.max(1,R.target)*.08,1,1.15):1,P=$t(k*D,.5,1.15),T=Math.max(3,E*g*P),S=Math.max(200,o*1.5,(((Ce=a.economyTraits)==null?void 0:Ce.ownBasePopulation)||16)*25),V=Math.max(0,T-S),N=V>0?S+V/(1+V/S):T,L=Math.max(100,v*C);a.economyTraits={...a.economyTraits||{},basePopulation:N,baseWealth:L};const W=(fe=a.population)!=null?fe:N,j=$t(1+u*.6+p*.08,1,1.8),H=$t(1/(1+Math.pow(W/Math.max(1,S),1.3)),.25,1),ce=(a.isAtWar?.032:.12)*j*H,me=(Math.random()-.5)*u*N*.04*H;let U=W+(N-W)*ce+me;if(a.isAtWar&&(U-=W*.012),a.population=Math.max(3,Math.round(U)),R.isShortage){const ze=$t(R.shortageAmount/Math.max(1,R.target),0,1),Zt=(He=a.militaryStrength)!=null?He:1;a.militaryStrength=Math.max(.6,Zt-ze*.01)}const J=(ie=a.wealth)!=null?ie:L,ye=(a.isAtWar?.03:.11)*j,te=(Math.random()-.5)*u*L*.05;let le=J+(L-J)*ye+te;a.isAtWar&&(le-=J*.015),a.wealth=Math.max(100,Math.round(le));const we=a.wealth*.45,ue=Number.isFinite(a.budget)?a.budget:we;a.budget=Math.max(0,ue+(we-ue)*.35)},fu=e=>{var s;const t=e;t.economyTraits||(t.economyTraits={});const o=Math.max(5,t.economyTraits.basePopulation||t.population||10),i=Math.max(100,t.economyTraits.baseWealth||t.wealth||200);t.economyTraits.basePopulation=o,t.economyTraits.baseWealth=i;const r=Math.max(o,Math.floor(o*1.1)),a=Math.max(i,Math.floor(i*1.15));t.population=$t(Math.round(t.population||o),5,r),t.wealth=$t(Math.round(t.wealth||i),i*.5,a),t.budget=Math.min(t.wealth,Math.max(0,(s=t.budget)!=null?s:Math.floor(t.wealth*.3)))},du=e=>{var t;if(!e.isAtWar){const o=(t=e.militaryStrength)!=null?t:1;o<1&&(e.militaryStrength=Math.min(1,o+.005))}},pu=({nation:e,resources:t,logs:o,onTreasuryChange:i})=>{let r=0;const a=e,s=t;if(a.installmentPayment&&a.installmentPayment.remainingDays>0){const u=a.installmentPayment.amount;ru(s,u,"installment_payment_income",i),r+=u,a.installmentPayment.paidAmount+=u,a.installmentPayment.remainingDays-=1,a.installmentPayment.remainingDays===0&&(o.push(`💰 ${a.name} 完成了所有分期赔款支付（共${a.installmentPayment.totalAmount}银币）。`),delete a.installmentPayment)}return r},hu=(e,t)=>{var u,c,f;if(!e||e.isRebelNation)return;const o=e.epoch||0;if(o>=gi.length-1)return;const i=o+1,r=gi.find(p=>p.id===i);if(!r)return;const a=((u=r.req)==null?void 0:u.population)||0,s=(((c=r.cost)==null?void 0:c.silver)||1e3)*2.5;if((e.population||0)>=a&&(e.wealth||0)>=s){e.epoch=i;const p=((f=r.cost)==null?void 0:f.silver)||0;e.wealth=Math.max(0,(e.wealth||0)-p),t.push(`🚀 ${e.name} 迈入了新的时代：${r.name}！`)}},es={economic_migration:{name:"经济移民",description:"人口从低收入国家流向高收入国家",minEra:3,trigger:"income_gap",baseMonthlyRate:.002,stratumWeights:{worker:.35,peasant:.25,artisan:.2,merchant:.1,engineer:.05,official:.05}},war_refugees:{name:"战争难民",description:"战争期间人口逃往和平国家",minEra:2,trigger:"war",baseMonthlyRate:.01,stratumWeights:{peasant:.4,worker:.3,artisan:.15,merchant:.1,capitalist:.05}},political_exile:{name:"政治流亡",description:"政治迫害导致精英阶层出逃",minEra:4,trigger:"low_approval",baseMonthlyRate:.003,stratumWeights:{official:.25,merchant:.2,capitalist:.2,engineer:.15,artisan:.1,scribe:.1},approvalThreshold:25}},mu=(e,t,o)=>{const i=(e==null?void 0:e.wealth)||1e3,r=(o==null?void 0:o.silver)||1e3,a=i/Math.max(1,(e==null?void 0:e.population)||1e3);return(r/Math.max(1,(t==null?void 0:t.population)||1e3)-a)/Math.max(a,1)},gu=(e,t,o)=>!Ao("migration","economic_migration",o)||e.isAtWar||e.vassalOf==="player"?!1:t>.5,ts=(e,t,o)=>{var a,s;if(!Ao("migration","political_exile",o))return{canExile:!1};const i=es.political_exile.approvalThreshold;if((((s=(a=e.socialStructure)==null?void 0:a.elites)==null?void 0:s.satisfaction)||50)<40&&!e.isAtWar)return{canExile:!0,exileFrom:"foreign"};for(const[u,c]of Object.entries(t||{}))if(c<i)return{canExile:!0,exileFrom:"domestic",stratum:u};return{canExile:!1}},ka=(e,t,o=1)=>{const i=es[e];if(!i)return{totalMigrants:0,byStratum:{}};const r=(t==null?void 0:t.population)||1e3,a=Math.floor(r*i.baseMonthlyRate*o),s={};let u=a;for(const[c,f]of Object.entries(i.stratumWeights)){const p=Math.floor(a*f);p>0&&(s[c]=p,u-=p)}if(u>0){const c=Object.keys(i.stratumWeights)[0];s[c]=(s[c]||0)+u}return{totalMigrants:a,byStratum:s}},yu=({nations:e,epoch:t,playerPopulation:o,playerResources:i,classApproval:r,daysElapsed:a,maxPop:s=1/0})=>{if(!Ao("migration","economic_migration",t)&&!Ao("migration","war_refugees",t)&&!Ao("migration","political_exile",t))return{immigrantsIn:0,emigrantsOut:0,byStratum:{},events:[]};let u=0,c=0;const f={},p=[],d={};let M=0;if(Array.isArray(e))for(const m of e){if(!m||m.id==="player")continue;const E=mu(m,{population:o},i);if(gu(m,E,t)){const g=Math.min(2,Math.max(.5,E)),C=ka("economic_migration",m,g);C.totalMigrants>0&&(M+=C.totalMigrants,Object.entries(C.byStratum).forEach(([R,k])=>{d[R]=(d[R]||0)+k}),p.push({type:"economic_migration",sourceNation:m.name,amount:C.totalMigrants,day:a,isPotential:!0}))}if(m.foreignWars&&m.foreignWars.length>0&&Ao("migration","war_refugees",t)){const g=ka("war_refugees",m,.5);g.totalMigrants>0&&(M+=g.totalMigrants,Object.entries(g.byStratum).forEach(([C,R])=>{d[C]=(d[C]||0)+R}),p.push({type:"war_refugees",sourceNation:m.name,amount:g.totalMigrants,day:a,isPotential:!0}))}const v=ts(m,r,t);if(v.canExile&&v.exileFrom==="foreign"){const g=ka("political_exile",m,.3);g.totalMigrants>0&&(M+=g.totalMigrants,Object.entries(g.byStratum).forEach(([C,R])=>{d[C]=(d[C]||0)+R}),p.push({type:"political_exile",sourceNation:m.name,amount:g.totalMigrants,day:a,isPotential:!0}))}}const h=Math.max(0,s-o);let y=1;M>h&&(h<=0?(y=0,p.push({type:"info",message:"Border closed due to overpopulation."})):y=h/M),M>0&&(Object.entries(d).forEach(([m,E])=>{const v=Math.floor(E*y);v>0&&(f[m]=(f[m]||0)+v,u+=v)}),p.forEach(m=>{m.isPotential&&(m.amount=Math.floor(m.amount*y),delete m.isPotential)}));const w=ts({},r,t);if(w.canExile&&w.exileFrom==="domestic"){const m=w.stratum,v=(25-((r==null?void 0:r[m])||50))/25,g=Math.floor(o*.001*v);g>0&&(c+=g,f[m]=(f[m]||0)-g,p.push({type:"political_exile",direction:"out",stratum:m,amount:g,day:a}))}return{immigrantsIn:u,emigrantsOut:c,byStratum:f,events:p.filter(m=>m.amount>0||m.type==="info")}},bu=(e,t,o)=>{if(!e||!t)return e;const i={...e};return Object.entries(t).forEach(([r,a])=>{if(typeof a=="number"&&a!==0){const s=i[r]||0,u=Math.floor(s+a);i[r]=Math.max(0,u)}}),i},Mu=e=>{if(!Array.isArray(e)||e.length===0)return[];const t=[],o={economic_migration:"经济移民",war_refugees:"战争难民",political_exile:"政治流亡"};for(const i of e){const r=o[i.type]||i.type;i.direction==="out"?t.push(`📤 ${r}：${i.amount}名${i.stratum||""}人口移居海外`):t.push(`📥 ${r}：${i.amount}人从${i.sourceNation}移入`)}return t},wt={BASE_STABILITY:50,MAX_STABILITY:100,MIN_STABILITY:0,THRESHOLDS:{VERY_STABLE:80,STABLE:60,UNSTABLE:40,VERY_UNSTABLE:20},FACTORS:{war:-15,warLosing:-10,economicDecline:-8,lowEliteSatisfaction:-5,lowCommonersSatisfaction:-8,lowUnderclassSatisfaction:-3,recentDefeat:-20,strongEconomy:5,peacetime:3,vassalStatus:-10}},si={BASE_DAILY_GROWTH:.2,STABILITY_COEFFICIENT:.02,REBELLION_THRESHOLD:100,RESET_VALUE:20,PLAYER_SUPPORT_BONUS:2},ko={MIN_DURATION:60,MAX_DURATION:365,REBEL_INITIAL_STRENGTH:.4,DAILY_CASUALTY_RATE:.02,FOREIGN_AID_MULTIPLIER:1.3,VICTORY_THRESHOLD:.2,ECONOMIC_DAMAGE_RATE:.01},$n={monarchy:{name:"君主制",baseStability:55,rebellionRisk:.8,possibleSuccessors:["republic","constitutional_monarchy","military_junta"]},republic:{name:"共和制",baseStability:50,rebellionRisk:.7,possibleSuccessors:["monarchy","military_junta","theocracy"]},constitutional_monarchy:{name:"君主立宪制",baseStability:60,rebellionRisk:.6,possibleSuccessors:["republic","monarchy"]},military_junta:{name:"军政府",baseStability:45,rebellionRisk:1,possibleSuccessors:["republic","monarchy","dictatorship"]},theocracy:{name:"神权政治",baseStability:55,rebellionRisk:.9,possibleSuccessors:["republic","monarchy"]},dictatorship:{name:"独裁政权",baseStability:40,rebellionRisk:1.2,possibleSuccessors:["republic","military_junta"]}};function vu(e,t={}){const o=[];let i=e.baseStability||wt.BASE_STABILITY;if(e.isAtWar?(o.push({name:"战争中",value:wt.FACTORS.war}),i+=wt.FACTORS.war,(e.warScore||0)<-30&&(o.push({name:"战争失利",value:wt.FACTORS.warLosing}),i+=wt.FACTORS.warLosing)):(o.push({name:"和平时期",value:wt.FACTORS.peacetime}),i+=wt.FACTORS.peacetime),e.recentDefeatDay&&t.daysElapsed){const s=t.daysElapsed-e.recentDefeatDay;if(s<180){const u=wt.FACTORS.recentDefeat*(1-s/180);o.push({name:"近期战败",value:Math.round(u)}),i+=u}}const r=e.socialStructure||{};if(r.elites&&r.elites.satisfaction<40&&(o.push({name:"精英不满",value:wt.FACTORS.lowEliteSatisfaction}),i+=wt.FACTORS.lowEliteSatisfaction),r.commoners&&r.commoners.satisfaction<30&&(o.push({name:"平民不满",value:wt.FACTORS.lowCommonersSatisfaction}),i+=wt.FACTORS.lowCommonersSatisfaction),r.underclass&&r.underclass.satisfaction<20&&(o.push({name:"下层不满",value:wt.FACTORS.lowUnderclassSatisfaction}),i+=wt.FACTORS.lowUnderclassSatisfaction),e.economicGrowth!==void 0&&(e.economicGrowth<-5?(o.push({name:"经济衰退",value:wt.FACTORS.economicDecline}),i+=wt.FACTORS.economicDecline):e.economicGrowth>5&&(o.push({name:"经济繁荣",value:wt.FACTORS.strongEconomy}),i+=wt.FACTORS.strongEconomy)),(e.isVassal||e.overlordId)&&(o.push({name:"附庸状态",value:wt.FACTORS.vassalStatus}),i+=wt.FACTORS.vassalStatus),e.foreignDestabilization>0){const s=Math.min(e.foreignDestabilization,30);o.push({name:"外国颠覆",value:-s}),i-=s}if(e.foreignSupport>0){const s=Math.min(e.foreignSupport,20);o.push({name:"外国支持",value:s}),i+=s}i=Math.max(wt.MIN_STABILITY,Math.min(wt.MAX_STABILITY,i));let a="stable";return i>=wt.THRESHOLDS.VERY_STABLE?a="very_stable":i>=wt.THRESHOLDS.STABLE?a="stable":i>=wt.THRESHOLDS.UNSTABLE?a="unstable":i>=wt.THRESHOLDS.VERY_UNSTABLE?a="very_unstable":a="crisis",{value:Math.round(i),level:a,factors:o}}function wu(e,t){let o=e.dissidentOrganization||0,i=0;if(t<50){const r=50-t;i=si.BASE_DAILY_GROWTH*(1+r*si.STABILITY_COEFFICIENT),e.playerSupportingRebels&&(i*=si.PLAYER_SUPPORT_BONUS),o+=i}else t>60&&(i=-.3,o=Math.max(0,o+i));return{value:Math.min(o,si.REBELLION_THRESHOLD*1.5),dailyChange:i,rebellionProgress:Math.min(100,o/si.REBELLION_THRESHOLD*100)}}function xu(e){const t=e.dissidentOrganization||0;if(t>=si.REBELLION_THRESHOLD){let o=.1;const i=t-si.REBELLION_THRESHOLD;return o+=i*.02,e.playerSupportingRebels&&(o*=1.5),Math.random()<o}return!1}function Eu(e,t){const o=os(e),i=o*ko.REBEL_INITIAL_STRENGTH,r=ko.MIN_DURATION+Math.random()*(ko.MAX_DURATION-ko.MIN_DURATION);return{isInCivilWar:!0,civilWarStartDay:t,civilWarData:{governmentStrength:o,rebelStrength:i,governmentSupport:[],rebelSupport:[],casualties:{government:0,rebels:0,civilian:0},economicDamage:0,estimatedDuration:Math.round(r)},dissidentOrganization:si.RESET_VALUE}}function os(e){const t=e.wealth||1e3,o=e.militaryTradition||50;return Math.round(t*.5+o*10)}function Cu(e,t){if(!e.isInCivilWar||!e.civilWarData)return null;const o={...e.civilWarData},i=t-e.civilWarStartDay;let r=1,a=1;o.governmentSupport.length>0&&(r*=ko.FOREIGN_AID_MULTIPLIER),o.rebelSupport.length>0&&(a*=ko.FOREIGN_AID_MULTIPLIER);const s=o.governmentStrength*r,u=o.rebelStrength*a,c=s+u,f=o.governmentStrength*ko.DAILY_CASUALTY_RATE*(u/c),p=o.rebelStrength*ko.DAILY_CASUALTY_RATE*(s/c);o.governmentStrength=Math.max(0,o.governmentStrength-f),o.rebelStrength=Math.max(0,o.rebelStrength-p),o.casualties.government+=f,o.casualties.rebels+=p,o.casualties.civilian+=(f+p)*.5;const d=(e.wealth||1e3)*ko.ECONOMIC_DAMAGE_RATE;o.economicDamage+=d;const M=os(e),h=M*ko.REBEL_INITIAL_STRENGTH;let y=null;return o.governmentStrength<M*ko.VICTORY_THRESHOLD?y={winner:"rebels",warDuration:i,casualties:o.casualties,economicDamage:o.economicDamage}:o.rebelStrength<h*ko.VICTORY_THRESHOLD&&(y={winner:"government",warDuration:i,casualties:o.casualties,economicDamage:o.economicDamage}),{civilWarData:o,result:y,wealthLoss:d}}function _u(e,t,o){const i={isInCivilWar:!1,civilWarData:null,civilWarEndDay:o};if(t==="rebels"){const r=e.governmentType||"monarchy",s=($n[r]||$n.monarchy).possibleSuccessors||["republic"],u=s[Math.floor(Math.random()*s.length)];i.governmentType=u,i.previousGovernmentType=r,i.regimeChangeDay=o;const c=$n[u]||$n.republic;i.baseStability=c.baseStability,i.stability=c.baseStability-10,i.relationResetPending=!0,i.treaties=[],(e.isVassal||e.overlordId)&&(i.isVassal=!1,i.overlordId=null,i.vassalType=null,i.independenceWar=!1,i.becameIndependentDay=o),i.wealth=Math.max(100,(e.wealth||1e3)*.5),i.socialStructure=Tu(u)}else i.stability=Math.min(60,(e.stability||40)+10),i.dissidentOrganization=10,i.wealth=Math.max(100,(e.wealth||1e3)*.7);return i}function Tu(e){const t={elites:{ratio:.1,satisfaction:40,influence:.4},commoners:{ratio:.8,satisfaction:35,influence:.4},underclass:{ratio:.1,satisfaction:30,influence:.2}};return e==="republic"?(t.commoners.satisfaction+=10,t.elites.satisfaction-=5):e==="military_junta"&&(t.elites.satisfaction+=5,t.commoners.satisfaction-=10),t}function Pu(e,t){const{daysElapsed:o=0}=t,i=[],r=[];for(const a of e){if(!a||a.isPlayer)continue;const s={id:a.id},u=vu(a,t);if(s.stability=u.value,s.stabilityLevel=u.level,s.stabilityFactors=u.factors,a.isInCivilWar){const c=Cu(a,o);if(c&&(s.civilWarData=c.civilWarData,s.wealth=Math.max(0,(a.wealth||0)-c.wealthLoss),c.result)){const f=_u(a,c.result.winner,o);Object.assign(s,f),r.push({type:"civil_war_ended",nationId:a.id,nationName:a.name,winner:c.result.winner,newGovernment:f.governmentType,day:o})}}else{const c=wu(a,u.value);if(s.dissidentOrganization=c.value,s.dissidentDailyChange=c.dailyChange,s.rebellionProgress=c.rebellionProgress,xu({...a,...s})){const f=Eu(a,o);Object.assign(s,f),r.push({type:"civil_war_started",nationId:a.id,nationName:a.name,day:o})}}a.foreignSupport>0&&(s.foreignSupport=Math.max(0,a.foreignSupport-.5)),a.foreignDestabilization>0&&(s.foreignDestabilization=Math.max(0,a.foreignDestabilization-.3)),i.push(s)}return{updates:i,events:r}}const Au={config:{transportCostRate:.15}};function is(e,t,o=0){const i=e==null?void 0:e.treaties;if(!i)return!1;if(Array.isArray(i))return i.some(a=>!a||a.type!==t||a.withPlayer===!1?!1:a.status==="active"||!a.status&&(a.endDay==null||a.endDay>o));const r=i[t];return!r||r.withPlayer===!1?!1:r.status==="active"||!r.status&&(r.endDay==null||r.endDay>o)}function ns(e,t=[]){return!t||!e?!1:t.some(o=>o.type==="economic_bloc"&&o.isActive&&o.members&&o.members.includes(e.id)&&o.members.includes("player"))}function as(e,t,o,i={}){var D;const r=Yt.find(P=>P.id===e.buildingId);if(!r)return{outputValue:0,inputCost:0,wageCost:0,businessTaxCost:0,profit:0,transportCost:0};const a=e.strategy||"PROFIT_MAX",s=Au.config.transportCostRate,u=P=>{var T,S,V,N;return(N=(V=(S=(((T=t.market)==null?void 0:T.prices)||{})[P])!=null?S:(t.nationPrices||{})[P])!=null?V:(t.prices||{})[P])!=null?N:rs(P)},c=P=>{var T;return(T=i[P])!=null?T:rs(P)},f=(P,T)=>{const S=(t.inventories||{})[P]||0;if(S>0)return S;const V=Math.max(.5,(t.wealth||1e3)/2e3);return Math.floor(T*2*V)};let p=0,d=0,M=!0;const h={},y={},w={inputs:{},outputs:{}};if(Object.entries(r.input||{}).forEach(([P,T])=>{const S=u(P),V=c(P),N=V*(1+s);let L=!0;if(a==="PROFIT_MAX"?N<S&&(L=!1):(a==="MARKET_DUMPING"||a==="RESOURCE_EXTRACTION"&&N<S*.8)&&(L=!1),w.inputs[P]=L?"local":"home",L)f(P,T)<T&&(M=!1),p+=T*S,M&&(h[P]=(h[P]||0)-T);else{const W=T*V;p+=W,d+=W*s,y[P]=(y[P]||0)-T}}),!M)return{outputValue:0,inputCost:0,wageCost:0,businessTaxCost:0,profit:0,transportCost:0,inputAvailable:!1,decisions:w};let m=0;Object.entries(r.output||{}).forEach(([P,T])=>{if(P==="maxPop"||P==="militaryCapacity")return;const S=u(P),V=c(P),N=V*(1-s);let L=!0;if(a==="PROFIT_MAX"?N>S&&(L=!1):a==="RESOURCE_EXTRACTION"?L=!1:a==="MARKET_DUMPING"&&(L=!0),w.outputs[P]=L?"local":"home",L)m+=T*S,h[P]=(h[P]||0)+T;else{const W=T*V,j=W*s;m+=W-j,d+=j,y[P]=(y[P]||0)+T}});const{total:E,breakdown:v}=Su(r,t),R=((D=r.businessTaxBase)!=null?D:.1)*1,k=m-p-E-R;return{outputValue:m,inputCost:p,wageCost:E,wageBreakdown:v,businessTaxCost:R,transportCost:d,profit:k,inputAvailable:!0,localResourceChanges:h,playerResourceChanges:y,decisions:w}}const Ru={elites:15,commoners:3,underclass:1};function Su(e,t){var u,c;if(!e.jobs)return{total:0,breakdown:[]};const o=((u=t==null?void 0:t.vassalPolicy)==null?void 0:u.labor)||"standard",i=cc(o);let r=0;const a=[],s=((c=t.market)==null?void 0:c.prices)||t.prices||{};return Object.entries(e.jobs).forEach(([f,p])=>{const d=ae[f];if(!d){console.log(`[Overseas] Missing stratum config for ${f}. STRATA keys: ${Object.keys(ae||{})}`);return}let M=0;d.needs&&Object.entries(d.needs).forEach(([v,g])=>{var R;const C=s[v]||((R=Be[v])==null?void 0:R.basePrice)||1;M+=g*C});const h=Ru[f]||1,y=M*h;let w=1;if(t.socialStructure&&t.socialStructure[f]){const v=t.socialStructure[f].population||1e3;v<500?w=1.5:v>1e4&&(w=.8),(t.socialStructure[f].sol||1)>h&&(w*=1.1)}const m=y*w*i,E=p*m;r+=E,a.push({stratumId:f,count:p,wagePerWorker:m,total:E,laborPolicy:o,laborMultiplier:i,baseWage:y,supplyFactor:w})}),{total:r,breakdown:a}}function rs(e){const t=Be[e];return(t==null?void 0:t.basePrice)||1}function Iu({overseasInvestments:e=[],nations:t=[],organizations:o=[],resources:i={},marketPrices:r={},classWealth:a={},daysElapsed:s=0}){const u=[];let c=0;const f={},p=[],d={},M={};return e.forEach(h=>{var V,N,L,W,j;if(h.status!=="operating"){p.push(h);return}const y=t.find(H=>H.id===h.targetNationId);if(!y){p.push({...h,status:"suspended"});return}if(y.isAtWar&&y.warTarget==="player"){const H={...h};H.operatingData={...H.operatingData},u.push(`⚠️ 与 ${y.name} 处于战争状态，海外投资利润被冻结`),p.push(H);return}const w=as(h,y,i,r);w.localResourceChanges&&(d[h.targetNationId]||(d[h.targetNationId]={}),Object.entries(w.localResourceChanges).forEach(([H,ce])=>{d[h.targetNationId][H]=(d[h.targetNationId][H]||0)+ce})),w.playerResourceChanges&&Object.entries(w.playerResourceChanges).forEach(([H,ce])=>{M[H]=(M[H]||0)+ce});let m=.6;const E=y.vassalOf==="player",v=is(y,"investment_pact",s),g=ns(y,o);if(E){const H=ar[y.vassalType];m=.25*(1-(((V=H==null?void 0:H.economicPrivileges)==null?void 0:V.profitTaxExemption)||0))}else g?m=.1:v?m=.25:m=.6;const C=w.profit>0?w.profit*m:0,R=w.profit-C,k=C,D={...h},P=[...((N=h.operatingData)==null?void 0:N.profitHistory)||[]];P.push({day:s,profit:w.profit,repatriated:R}),P.length>30&&P.shift();const S=R<=0?(((L=D.operatingData)==null?void 0:L.consecutiveLossDays)||0)+1:0;if(S>=30){let H=.01;const ce=(S-30)*.005;if(H+=ce,w.profit<0){const me=Math.abs(w.profit)/(D.investmentAmount||1e3);H+=me}if(H=Math.min(.5,H),Math.random()<H){u.push(`📉 由于长期入不敷出（${S}天），${((W=ae[D.ownerStratum])==null?void 0:W.name)||"业主"}决定关闭在 ${y.name} 的 ${(j=Yt.find(U=>U.id===D.buildingId))==null?void 0:j.name}。`);const me=(D.investmentAmount||0)*.1;f[D.ownerStratum]=(f[D.ownerStratum]||0)+me;return}}D.operatingData={...D.operatingData,...w,repatriatedProfit:R,retainedProfit:k,profitHistory:P,consecutiveLossDays:S},c+=R,f[h.ownerStratum]=(f[h.ownerStratum]||0)+R,p.push(D)}),s%30===0&&c>0&&(u.push(`💰 海外投资本月利润汇回: ${c.toFixed(1)} 银币`),Object.entries(f).forEach(([h,y])=>{y>0&&u.push(`  • ${h}阶层: +${y.toFixed(1)}`)})),{updatedInvestments:p,totalProfit:c,profitByStratum:f,logs:u,marketChanges:d,playerInventoryChanges:M}}function ku(e,t){const o={totalValue:0,estimatedMonthlyProfit:0,estimatedDailyProfit:0,byNation:{},byStratum:{},count:0};return!e||!Array.isArray(e)||e.forEach(i=>{var s;if(i.status!=="operating")return;o.count++,o.totalValue+=i.investmentAmount||0;const r=((s=i.operatingData)==null?void 0:s.profit)||0,a=r*30;o.estimatedDailyProfit+=r,o.estimatedMonthlyProfit+=a,o.byNation[i.targetNationId]||(o.byNation[i.targetNationId]={count:0,value:0,profit:0,dailyProfit:0}),o.byNation[i.targetNationId].count++,o.byNation[i.targetNationId].value+=i.investmentAmount||0,o.byNation[i.targetNationId].profit+=a,o.byNation[i.targetNationId].dailyProfit+=r,o.byStratum[i.ownerStratum]||(o.byStratum[i.ownerStratum]={count:0,value:0,profit:0,dailyProfit:0}),o.byStratum[i.ownerStratum].count++,o.byStratum[i.ownerStratum].value+=i.investmentAmount||0,o.byStratum[i.ownerStratum].profit+=a,o.byStratum[i.ownerStratum].dailyProfit+=r}),o}function Du({foreignInvestments:e=[],nations:t=[],organizations:o=[],playerMarket:i={},playerResources:r={},foreignInvestmentPolicy:a="normal",daysElapsed:s=0,jobFill:u={},buildings:c={}}){const f=[];let p=0,d=0;const M=[],h={};return e.forEach(y=>{var le,we;if(y.status!=="operating"){M.push(y);return}const w=Yt.find(ue=>ue.id===y.buildingId);if(!w){M.push(y);return}const m=t.find(ue=>ue.id===y.ownerNationId),E=((le=m==null?void 0:m.market)==null?void 0:le.prices)||(m==null?void 0:m.nationPrices)||(m==null?void 0:m.prices)||{},v=(m==null?void 0:m.inventories)||{},g={market:i,inventories:r,wealth:1e4,vassalPolicy:{labor:"standard"}},C={...y,strategy:y.strategy||"PROFIT_MAX"},R=as(C,g,v,E),k=w.jobs||{},D=c[w.id]||0,P=u[w.id]||{};let T=0,S=0;Object.entries(k).forEach(([ue,Ie])=>{const de=Ie*D;T+=de,S+=Math.min(P[ue]||0,de)});let V=1;T>0&&D>0&&(V=S/T);const N=R.profit||0,L=N*V;let W=.6;const j=m&&m.vassalOf==="player",H=m?is(m,"investment_pact",s):!1,ce=ns(m,o);j?(W=.25,ce&&(W=.1)):ce?W=.1:H?W=.25:W=.6;const me=L>0?L*W:0,U=L>0?L*(1-W):0;p+=me,d+=U,R.localResourceChanges&&Object.entries(R.localResourceChanges).forEach(([ue,Ie])=>{h[ue]=(h[ue]||0)+Ie});const ye=U<=0?(((we=y.operatingData)==null?void 0:we.consecutiveLossDays)||0)+1:0;if(ye>=30){let ue=.01;const Ie=(ye-30)*.005;if(ue+=Ie,L<0&&(ue+=Math.abs(L)/1e3),ue=Math.min(.5,ue),Math.random()<ue){f.push(`📉 ${(m==null?void 0:m.name)||"外资"} 因长期亏损（${ye}天），撤出了在我国的 ${w.name} 投资。`);return}}const te=w.jobs?Object.values(w.jobs).reduce((ue,Ie)=>ue+Ie,0):0;M.push({...C,dailyProfit:L,jobsProvided:te,operatingData:{...R,taxPaid:me,profitRepatriated:U,consecutiveLossDays:ye,staffingRatio:V,theoreticalProfit:N,profit:L}})}),s%30===0&&e.length>0&&f.push(`🏭 外资月报: 税收+${(p*30).toFixed(0)}, 利润外流-${(d*30).toFixed(0)}`),{updatedInvestments:M,taxRevenue:p,profitOutflow:d,logs:f,marketChanges:h}}function Wu({foreignInvestments:e=[],nations:t=[],playerMarket:o={},playerResources:i={},buildingUpgrades:r={},buildingCounts:a={},daysElapsed:s=0}){const u=[],c=[],f=[...e],p=60,d=.03,M=.05,h=1e4;return e.forEach((y,w)=>{var U,J,ye;if(y.status!=="operating")return;const m=y.lastUpgradeDay||0;if(s-m<p||Math.random()>d)return;const E=Yt.find(te=>te.id===y.buildingId);if(!E)return;const v=Dn(E.id);if(v<=0)return;const g=t.find(te=>te.id===y.ownerNationId),C=(g==null?void 0:g.wealth)||0;if(C<h)return;const R=y.upgradeLevel||0;if(R>=v)return;const k=R+1,D=((U=g==null?void 0:g.market)==null?void 0:U.prices)||(g==null?void 0:g.prices)||{},P=Wn(E.id,k,0);if(!P)return;let T=0;for(const[te,le]of Object.entries(P))if(te==="silver")T+=le;else{const we=D[te]||((J=o==null?void 0:o.prices)==null?void 0:J[te])||((ye=Be[te])==null?void 0:ye.basePrice)||1;T+=le*we}const S=C*.3;if(T>S)return;const V=Nt(E,R),N=Nt(E,k),L=Gn(E,V,o),W=Gn(E,N,o),j=W-L;if(j<=0)return;const ce=j*365/T;if(ce<M)return;tn("overseas",`🏭 [外资升级] ${(g==null?void 0:g.name)||"外国"} 升级 ${E.name} Lv${R} → Lv${k}，花费 ${T.toFixed(0)}，预计ROI ${(ce*100).toFixed(1)}%`),c.push({investmentId:y.id,investmentIndex:w,buildingId:E.id,fromLevel:R,toLevel:k,cost:T,ownerNationId:y.ownerNationId,profitGain:j,roi:ce}),f[w]={...y,upgradeLevel:k,lastUpgradeDay:s,dailyProfit:W};const me=(g==null?void 0:g.name)||"外国";u.push(`🏭 ${me}升级了在本国的 ${E.name}（Lv${R} → Lv${k}，花费 ${Math.ceil(T)} 银）`)}),{updatedInvestments:f,upgrades:c,logs:u}}function Gn(e,t,o){const i=(o==null?void 0:o.prices)||{};let r=0;const a=(t==null?void 0:t.output)||e.output||{};Object.entries(a).forEach(([p,d])=>{var h;if(p==="maxPop"||p==="militaryCapacity")return;const M=i[p]||((h=Be[p])==null?void 0:h.basePrice)||1;r+=d*M});let s=0;const u=(t==null?void 0:t.input)||e.input||{};Object.entries(u).forEach(([p,d])=>{var h;const M=i[p]||((h=Be[p])==null?void 0:h.basePrice)||1;s+=d*M});let c=0;const f=(t==null?void 0:t.jobs)||e.jobs||{};return Object.entries(f).forEach(([p,d])=>{e.owner&&p===e.owner||(c+=d*10)}),r-s-c}function Ou({overseasInvestments:e=[],nations:t=[],classWealth:o={},marketPrices:i={},daysElapsed:r=0}){const a=[],s=[],u=[...e],c={},f=60,p=.03,d=.05,M=1e4;return e.forEach((h,y)=>{var J,ye;if(h.status!=="operating")return;const w=h.lastUpgradeDay||0;if(r-w<f||Math.random()>p)return;const m=Yt.find(te=>te.id===h.buildingId);if(!m)return;const E=Dn(m.id);if(E<=0)return;const v=h.ownerStratum||"capitalist",g=o[v]||0;if(g<M)return;const C=h.upgradeLevel||0;if(C>=E)return;const R=C+1,k=t.find(te=>te.id===h.targetNationId),D=((J=k==null?void 0:k.market)==null?void 0:J.prices)||(k==null?void 0:k.prices)||{},P=Wn(m.id,R,0);if(!P)return;let T=0;for(const[te,le]of Object.entries(P))if(te==="silver")T+=le;else{const we=i[te]||1;T+=le*we}const S=g*.2;if(T>S)return;const V=Nt(m,C),N=Nt(m,R),L=Gn(m,V,{prices:D}),W=Gn(m,N,{prices:D}),j=W-L;if(j<=0)return;const ce=j*365/T;if(ce<d)return;const me=(k==null?void 0:k.name)||"海外";tn("overseas",`🏭 [海外升级] ${v} 升级 ${me} 的 ${m.name} Lv${C} → Lv${R}，花费 ${T.toFixed(0)}，预计ROI ${(ce*100).toFixed(1)}%`),s.push({investmentId:h.id,investmentIndex:y,buildingId:m.id,fromLevel:C,toLevel:R,cost:T,ownerStratum:v,targetNationId:h.targetNationId,profitGain:j,roi:ce}),u[y]={...h,upgradeLevel:R,lastUpgradeDay:r,dailyProfit:W},c[v]=(c[v]||0)-T;const U=((ye=ae[v])==null?void 0:ye.name)||v;a.push(`🏭 ${U}升级了在 ${me} 的 ${m.name}（Lv${C} → Lv${R}，花费 ${Math.ceil(T)} 银）`)}),{updatedInvestments:u,upgrades:s,wealthChanges:c,logs:a}}const Bu=({tradeRoutes:e,nations:t,resources:o,daysElapsed:i,market:r,popStructure:a,taxPolicies:s,diplomacyOrganizations:u})=>{const c=(e==null?void 0:e.routes)||[];if(!c.length)return null;const f=(u==null?void 0:u.organizations)||[],p=D=>f.find(P=>Array.isArray(P==null?void 0:P.members)&&P.members.includes("player")&&P.members.includes(D)),d=(D,P)=>{var V,N,L,W;let T=0;const S=p(D);if(S&&(T=Math.max(T,((V=wa[S.type])==null?void 0:V.tariffDiscount)||0)),P&&P.vassalOf==="player"){const j=(N=P.vassalPolicy)==null?void 0:N.tradePolicy,H=((L=nr[j])==null?void 0:L.tariffDiscount)||0,ce=((W=ar[P.vassalType])==null?void 0:W.tariffDiscount)||0;T=Math.max(T,H,ce)}return T},M=(D,P)=>{var V,N;if(!D||D.vassalOf!=="player")return 1;const T=(V=D.vassalPolicy)==null?void 0:V.tradePolicy,S=((N=nr[T])==null?void 0:N.playerPriceMod)||0;return P==="import"?1+Math.min(0,S):1+Math.max(0,S)},h=.05,y=.1,w=(a==null?void 0:a.merchant)||0,m=[],E=[];let v=0;const g={},C={},R=(D,P)=>{!Number.isFinite(P)||P===0||(g[D]=(g[D]||0)+P)},k=(D,P)=>{!D||!P||(C[D]||(C[D]={budget:0,relation:0,inventory:{}}),Number.isFinite(P.budget)&&(C[D].budget+=P.budget),Number.isFinite(P.relation)&&(C[D].relation+=P.relation),P.inventory&&Object.entries(P.inventory).forEach(([T,S])=>{!Number.isFinite(S)||S===0||(C[D].inventory[T]=(C[D].inventory[T]||0)+S)}))};return c.forEach((D,P)=>{var te,le,we,ue,Ie,de,Y,Re,Ke,Le,_t,K,Ce,fe;const{nationId:T,resource:S,type:V}=D,N=t.find(He=>He.id===T);if(!N){m.push(D);return}if(P>=w||N.isAtWar)return;const L=Wi(S,N,i),W=(we=(te=r==null?void 0:r.prices)==null?void 0:te[S])!=null?we:((le=Be[S])==null?void 0:le.basePrice)||1,j=wr(S,N,i),H=(D==null?void 0:D.mode)||"normal",ce=H==="force_sell",me=H==="force_buy",U=!!(N!=null&&N.openMarketUntil&&i<N.openMarketUntil),J=Pa(N,i),ye=U||J.allowForceTrade||J.bypassRelationCap;if(V==="export"){if(!ce&&(!L.isShortage||L.shortageAmount<=0))return;const He=(o[S]||0)+(g[S]||0),ze=Math.max(0,He-500);if(ze<=y)return;const Zt=Math.max(0,L.shortageAmount||0),et=(ce?ze:Math.min(ze,Zt))*h;if(et<y)return;const It=W*et,Vt=((ue=s==null?void 0:s.resourceTaxRates)==null?void 0:ue[S])||0,Fo=(Re=(Y=(Ie=s==null?void 0:s.exportTariffMultipliers)==null?void 0:Ie[S])!=null?Y:(de=s==null?void 0:s.resourceTariffMultipliers)==null?void 0:de[S])!=null?Re:0,zo=d(T,N),Dt=Fo*(1-zo),_e=Vt+Dt,lt=It*_e;let kt=ce?j*.6:j;kt*=M(N,"export");const yt=kt*et;if(yt-It-lt<=0)return;R(S,-et),v+=lt,k(T,{budget:-yt,relation:ce?ye?.2:-.6:.2,inventory:{[S]:et}})}else if(V==="import"){if(!me&&(!L.isSurplus||L.surplusAmount<=0))return;const He=Math.max(0,L.surplusAmount||0),ie=Math.max(10,L.target||0),Zt=(me?ie:He)*h;if(Zt<y)return;let et=me?j*1.3:j;et*=M(N,"import");const It=et*Zt,Vt=W*Zt,Fo=((Ke=s==null?void 0:s.resourceTaxRates)==null?void 0:Ke[S])||0,zo=(Ce=(K=(Le=s==null?void 0:s.importTariffMultipliers)==null?void 0:Le[S])!=null?K:(_t=s==null?void 0:s.resourceTariffMultipliers)==null?void 0:_t[S])!=null?Ce:0,Dt=d(T,N),_e=zo*(1-Dt),lt=Fo+_e,ht=Vt*lt,kt=Vt-It-ht;if(kt<=0)return;R(S,Zt),v+=ht,k(T,{budget:It,relation:me?ye?.2:-.6:.2,inventory:{[S]:-Zt}}),Zt>=1&&!me&&E.push(`🚢 进口 ${Zt.toFixed(1)} ${((fe=Be[S])==null?void 0:fe.name)||S} 从 ${N.name}：商人国外购 ${It.toFixed(1)} 银币，国内售 ${Vt.toFixed(1)} 银币（税 ${ht.toFixed(1)}），商人赚 ${kt.toFixed(1)} 银币。`)}}),{tradeTax:v,resourceDelta:g,nationDelta:C,routesToRemove:m,tradeLog:E}},ju=e=>ac[e]||e,Nu=(e,t)=>!Number.isFinite(e==null?void 0:e.endDay)||t<e.endDay,Lu=({nation:e,tick:t,resources:o,logs:i,onTreasuryChange:r})=>{const a=Array.isArray(e.treaties)?e.treaties:[],s=[],u=[];let c=0;if(a.forEach(f=>{Nu(f,t)?(s.push(f),f.direction==="player_to_ai"&&Number.isFinite(f.maintenancePerDay)&&(c+=Math.max(0,f.maintenancePerDay))):u.push(f)}),u.length>0&&u.forEach(f=>{i.push(`Treaty with ${e.name} expired (${ju(f.type)}).`)}),c>0&&o){const f=o.silver||0,p=Math.max(0,Math.min(f,c));o.silver=f-p,typeof r=="function"&&p>0&&r(-p,"treaty_maintenance"),e.budget=(e.budget||0)+p,e.wealth=(e.wealth||0)+p}e.treaties=s},Fu=({resources:e,buildings:t,population:o,popStructure:i={},birthAccumulator:r=0,decrees:a,gameSpeed:s,epoch:u,market:c,classWealth:f,classApproval:p={},activeBuffs:d=[],activeDebuffs:M=[],taxPolicies:h,army:y={},militaryWageRatio:w=1,militaryQueue:m=[],nations:E=[],diplomacyOrganizations:v=null,tick:g=0,techsUnlocked:C=[],activeFestivalEffects:R=[],classWealthHistory:k,classNeedsHistory:D,merchantState:P={pendingTrades:[],lastTradeTime:0},tradeRouteTax:T=0,maxPopBonus:S=0,eventApprovalModifiers:V={},eventStabilityModifier:N=0,currentStability:L=50,eventResourceDemandModifiers:W={},eventStratumDemandModifiers:j={},eventBuildingProductionModifiers:H={},livingStandardStreaks:ce={},buildingUpgrades:me={},rulingCoalition:U=[],previousLegitimacy:J=0,migrationCooldowns:ye={},difficulty:te,officials:le=[],activeDecrees:we,officialsPaid:ue=!0,quotaTargets:Ie={},expansionSettings:de={},cabinetStatus:Y={},priceControls:Re=null,previousTaxShock:Ke={},eventEffectSettings:Le={},foreignInvestments:_t=[],overseasInvestments:K=[],tradeRoutes:Ce={},foreignInvestmentPolicy:fe="normal",tradeOpportunities:He=null})=>{var Ns,Ls,Fs,Us,$s,Gs,qs,Vs,Hs,Ys,Xs,zs,Js,Zs,Qs,Ks,ec,tc,oc,ic,nc;const ie={...e},ze={...(c==null?void 0:c.prices)||{}};let Zt=0,Ye=null;Ce&&Ce.routes&&Ce.routes.length>0&&(Ye=Bu({tradeRoutes:Ce,nations:E,resources:ie,daysElapsed:g,market:{prices:ze},popStructure:i,taxPolicies:h,diplomacyOrganizations:v}),Ye&&(Zt=Ye.tradeTax||0));const et=new Map,It={record:(n,l)=>{if(!Number.isFinite(n)||n===0)return;const b=l||"unknown";et.set(b,(et.get(b)||0)+n)},push:n=>{if(!n||!Number.isFinite(n.amount)||n.amount===0)return;const l=n.reason||"unknown";et.set(l,(et.get(l)||0)+n.amount)},toArray:()=>Array.from(et.entries()).map(([n,l])=>({amount:l,reason:n})),get length(){return et.size}},Vt=(n,l)=>{It.record(n,l)},Fo={},zo=(n,l,b)=>{Fo[n]||(Fo[n]=[]),Fo[n].push({amount:l,reason:b,balance:ie[n]||0})},Dt=(n,l,b)=>{l!==0&&(ie[n]=(ie[n]||0)+l,zo(n,l,b),n==="silver"&&Vt(l,b))},_e=(n,l)=>{Dt("silver",n,l)},lt=Zt;Ye&&Ye.resourceDelta&&Object.entries(Ye.resourceDelta).forEach(([n,l])=>{Dt(n,l,"trade_route_transaction")});const ht=(n,l,b)=>{Dt(b,n,l)},kt={},yt=ie.silver||0;let Kt=[...K],ao=[..._t],Jo=[];const ro={},bt={},eo={},ss={};Object.keys(ae).length>0&&Object.keys(ae).forEach(n=>{bt[n]={income:{wage:0,ownerRevenue:0,subsidy:0,salary:0,militaryPay:0,tradeImportRevenue:0,layoffTransfer:0},expense:{headTax:0,transactionTax:0,businessTax:0,tariffs:0,essentialNeeds:{},luxuryNeeds:{},decay:0,productionCosts:0,wages:0,tradeExportPurchase:0,capitalFlight:0,buildingCost:0,layoffTransfer:0}}});const qn=(E||[]).some(n=>n.isAtWar===!0),cs=3,Ht=h||{},ls=Ht.headTaxRates||{},us=Ht.resourceTaxRates||{},Uu=Ht.businessTaxRates||{},Vn=G0(ze,ls,us);Fn(Vn,(Ut==null?void 0:Ut.price)||{});const Zo=Fn(Vn,(Ut==null?void 0:Ut.wage)||{}),bi=(c==null?void 0:c.wages)||{},sn=n=>{const l=Zo==null?void 0:Zo[n];return!Number.isFinite(l)||l<=0?jn*.8:Math.max(jn*.8,l*1.1)},yo=n=>{var x;const l=bi==null?void 0:bi[n];if(Number.isFinite(l)&&l>0)return Math.max(Bi,l);const b=(x=ae[n])==null?void 0:x.startingWealth;return Number.isFinite(b)&&b>0?Math.max(jn*.5,b/40,sn(n)):Math.max(of,sn(n))},bo={},cn={},Do={},je=il(f),ci=n=>Nr(n,ls),Li=n=>{const l=us[n];return typeof l=="number"?l:0},$u=n=>{const l=Uu[n];return typeof l=="number"?l:1},Gt=$0(),Je=new V0({resources:ie,wealth:je,officials:le,classFinancialData:bt,taxBreakdown:Gt,silverChangeLog:It,buildingFinancialData:eo,classWealthChangeLog:kt},{safeWealth:Qi}),O=cl();if(K.length>0){const n=Iu({overseasInvestments:K,nations:E,organizations:(v==null?void 0:v.organizations)||[],resources:ie,marketPrices:ze,classWealth:je,daysElapsed:g});Kt=n.updatedInvestments,Jo.push(...n.logs),n.profitByStratum&&Object.entries(n.profitByStratum).forEach(([b,x])=>{x>0&&(je[b]=(je[b]||0)+x,bt[b]&&(bt[b].income.ownerRevenue=(bt[b].income.ownerRevenue||0)+x))}),n.playerInventoryChanges&&Object.entries(n.playerInventoryChanges).forEach(([b,x])=>{Dt(b,x,"overseas_investment_return")}),n.marketChanges&&Object.entries(n.marketChanges).forEach(([b,x])=>{const _=E.find(I=>I.id===b);_&&_.inventory&&Object.entries(x).forEach(([I,$])=>{_.inventory[I]=Math.max(0,(_.inventory[I]||0)+$)})});const l=Ou({overseasInvestments:Kt,nations:E,classWealth:je,marketPrices:ze,daysElapsed:g});l.upgrades&&l.upgrades.length>0&&(Kt=l.updatedInvestments,Jo.push(...l.logs),l.wealthChanges&&Object.entries(l.wealthChanges).forEach(([b,x])=>{je[b]=Math.max(0,(je[b]||0)+x)}))}Y.effects&&(Y.effects.adminEfficiency&&(O.taxEfficiencyBonus=(O.taxEfficiencyBonus||0)+Y.effects.adminEfficiency),Y.effects.stabilityMod&&(O.stabilityBonus=(O.stabilityBonus||0)+Y.effects.stabilityMod),Y.effects.tradeBonusMod&&(O.tradeBonusMod=(O.tradeBonusMod||0)+Y.effects.tradeBonusMod),Y.effects.diplomaticRelationsMod&&(O.diplomaticBonus=(O.diplomaticBonus||0)+Y.effects.diplomaticRelationsMod),Y.effects.approvalBonus&&Object.entries(Y.effects.approvalBonus).forEach(([n,l])=>{O.stanceApprovalEffects=O.stanceApprovalEffects||{},O.stanceApprovalEffects[n]=(O.stanceApprovalEffects[n]||0)+l}),Y.effects.organizationGrowthMod&&(O.organizationGrowthMod=(O.organizationGrowthMod||0)+Y.effects.organizationGrowthMod),Y.effects.researchSpeed&&(O.scienceBonus=(O.scienceBonus||0)+Y.effects.researchSpeed)),Y.decreeEffects&&Xo(Y.decreeEffects,O);const ut=Al(le,ue),Gu={...ut,passive:ut.passiveGains,passivePercent:ut.passivePercentGains,resourceDemandMod:ut.decreeResourceDemandMod,stratumDemandMod:ut.decreeStratumDemandMod,maxPop:ut.extraMaxPop,incomePercent:ut.incomePercentBonus};Xo(Gu,O),ut.researchSpeed&&(O.scienceBonus=(O.scienceBonus||0)+ut.researchSpeed),O.taxEfficiencyBonus=ut.taxEfficiency||0,O.corruption=ut.corruption||0,ut.incomePercentBonus&&(O.incomePercentBonus=(O.incomePercentBonus||0)+ut.incomePercentBonus),O.populationGrowthBonus=ut.populationGrowth||0,O.militaryUpkeepMod=ut.militaryUpkeep||0,O.tradeBonusMod=ut.tradeBonus||0,O.buildingCostMod=ut.buildingCostMod||0,O.wartimeProduction=ut.wartimeProduction||0,O.resourceWaste=ut.resourceWaste||{},O.coalitionApproval=ut.coalitionApproval||0,O.legitimacyBonus=ut.legitimacyBonus||0,O.organizationGrowthMod=(O.organizationGrowthMod||0)+(ut.organizationDecay||0),O.factionConflict=(O.factionConflict||0)+(ut.factionConflict||0),O.diplomaticCooldown=ut.diplomaticCooldown||0,O.diplomaticIncident=ut.diplomaticIncident||0,O.diplomaticBonus=ut.diplomaticBonus||0,O.officialProductionInputCost=ut.productionInputCost||{};const qu={classApproval:p,classInfluence:(c==null?void 0:c.classInfluence)||{},totalInfluence:(c==null?void 0:c.totalInfluence)||1,classLivingStandard:(c==null?void 0:c.classLivingStandard)||{},classIncome:(c==null?void 0:c.classIncome)||{},stability:L/100,legitimacy:J,taxPolicies:Ht,rulingCoalition:U,atWar:qn,population:o,epoch:u,buildings:t},tt=Il(le,qu).aggregatedEffects;tt.stability&&(O.stabilityBonus=(O.stabilityBonus||0)+tt.stability),tt.legitimacyBonus&&(O.legitimacyBonus=(O.legitimacyBonus||0)+tt.legitimacyBonus),tt.gatherBonus&&(O.categoryBonuses.gather=(O.categoryBonuses.gather||0)+tt.gatherBonus),tt.industryBonus&&(O.categoryBonuses.industry=(O.categoryBonuses.industry||0)+tt.industryBonus),tt.tradeBonus&&(O.tradeBonusMod=(O.tradeBonusMod||0)+tt.tradeBonus),tt.researchSpeed&&(O.scienceBonus=(O.scienceBonus||0)+tt.researchSpeed),tt.taxEfficiency&&(O.taxEfficiencyBonus=(O.taxEfficiencyBonus||0)+tt.taxEfficiency),tt.incomePercentBonus&&(O.incomePercentBonus=(O.incomePercentBonus||0)+tt.incomePercentBonus),tt.buildingCostMod&&(O.buildingCostMod=(O.buildingCostMod||0)+tt.buildingCostMod),tt.needsReduction&&(O.needsReduction=(O.needsReduction||0)+tt.needsReduction),tt.populationGrowth&&(O.populationGrowthBonus=(O.populationGrowthBonus||0)+tt.populationGrowth),tt.militaryBonus&&(O.militaryBonus=(O.militaryBonus||0)+tt.militaryBonus),tt.organizationDecay&&(O.organizationGrowthMod=(O.organizationGrowthMod||0)+tt.organizationDecay),tt.cultureBonus&&(O.cultureBonus=(O.cultureBonus||0)+tt.cultureBonus),tt.diplomaticBonus&&(O.diplomaticBonus=(O.diplomaticBonus||0)+tt.diplomaticBonus),O.stanceApprovalEffects=tt.approval||{},O.stanceProductionInputCost=tt.productionInputCost||{};const{buildingBonuses:Hn,categoryBonuses:Yn,passiveGains:Vu,passivePercentGains:Hu,perPopPassiveGains:Yu,decreeResourceDemandMod:ln,decreeStratumDemandMod:un,decreeResourceSupplyMod:Da}=O;let{decreeSilverIncome:Mi,decreeSilverExpense:Fi,extraMaxPop:fs,maxPopPercent:Wa,productionBonus:Oa,industryBonus:Ba,taxBonus:Xu,needsReduction:ds}=O;ll(C,O);const zu=we?Object.entries(we).map(([n,l])=>({id:n,active:!0,modifiers:(l==null?void 0:l.effects)||(l==null?void 0:l.modifiers)})):[],Ju=Array.isArray(a)?a.filter(n=>n&&n.active):[];ul([...zu,...Ju],O),fl(R,O),Array.isArray(d)&&d.forEach(n=>{Xo(n,O)}),Array.isArray(M)&&M.forEach(n=>{Xo(n,O)});let Xn=null;if(U&&U.length>0){const n=rl({popStructure:i,classWealthResult:f}),l=N0(U,n.classInfluence);Xn=A0(l.name),dl(Xn,O)}gi&&gi[u]&&gi[u].bonuses&&Xo(gi[u].bonuses,O),Mi=O.decreeSilverIncome,Fi=O.decreeSilverExpense,fs=O.extraMaxPop,Wa=O.maxPopPercent,Oa=O.productionBonus,Ba=O.industryBonus,Xu=O.taxBonus,ds=O.needsReduction;const Zu=O.incomePercentBonus||0,so=n=>(ze[n]||(ze[n]=Io(n)),ze[n]=Math.max(Bi,ze[n]),ze[n]);let zn=null;const Qu=(n,l,b)=>{var x,_;if(n==="silver"&&l>0){ft[b]=(ft[b]||0)+l,Je.transfer("void",b,l,z.INCOME.OWNER_REVENUE,z.INCOME.OWNER_REVENUE,{buildingId:zn});return}if(!(l<=0)&&(ie[n]=(ie[n]||0)+l,Qt(n))){Do[n]=(Do[n]||0)+l;const I=so(n),A=((x=Y==null?void 0:Y.dominance)==null?void 0:x.panelType)==="plannedEconomy"&&(Re==null?void 0:Re.enabled)&&((_=Re.governmentBuyPrices)==null?void 0:_[n])!==void 0;let G=I;if(A){const oe=l0({resourceKey:n,amount:l,marketPrice:I,priceControls:Re,taxBreakdown:Gt,resources:ie,onTreasuryChange:Vt});oe.success&&(G=oe.effectivePrice)}const X=G*l;ft[b]=(ft[b]||0)+X,Je.transfer("void",b,X,z.INCOME.OWNER_REVENUE,z.INCOME.OWNER_REVENUE,{buildingId:zn})}},Te={},co=t,Ku=new Set,Mo={},Qo={},ft={},Jn={};let Uo=5,ps=0;Uo+=fs,Uo+=S,yr(y),dc(y),Object.values(y).reduce((n,l)=>n+l,0),Xt.forEach(n=>Mo[n]=0),Xt.forEach(n=>{Qo[n]={totalSlots:0,weightedWage:0},ft[n]=0});const $o={},vi={};Xt.forEach(n=>{$o[n]=0,vi[n]=0});const xt={};Object.keys(ae).forEach(n=>{xt[n]=0});const wi={};Object.keys(ae).forEach(n=>{wi[n]=0}),Object.keys(ae).forEach(n=>{}),Yt.forEach(n=>{const l=co[n.id]||0;if(l>0){const b=me[n.id]||{};let x=0;Object.entries(b).forEach(([$,A])=>{const G=parseInt($);Number.isFinite(G)&&G>0&&A>0&&(x+=A)});const I={0:Math.max(0,l-x)};Object.entries(b).forEach(([$,A])=>{const G=parseInt($);Number.isFinite(G)&&G>0&&A>0&&(I[G]=A)}),Object.entries(I).forEach(([$,A])=>{var be,he;if(A<=0)return;const G=parseInt($),q=Nt(n,G);let X=1+(Hn[n.id]||0);const oe=1+(Yn[n.cat]||0);if(X*=oe,(be=q.output)!=null&&be.maxPop&&(Uo+=q.output.maxPop*X*A),(he=q.output)!=null&&he.militaryCapacity&&(ps+=q.output.militaryCapacity*X*A),q.jobs)for(let Me in q.jobs)Mo[Me]=(Mo[Me]||0)+q.jobs[Me]*A;q.output&&Object.entries(q.output).forEach(([Me,at])=>{Be[Me]&&(at||0)>0&&Ku.add(Me)})})}});const fn={};Yt.forEach(n=>{if(!n.owner||!n.jobs)return;const l=t[n.id]||0;if(l<=0)return;const b=n.owner,x=n.jobs[b]||0;if(fn[n.id]={},Object.entries(n.jobs).forEach(([$,A])=>{fn[n.id][$]=A*l}),x<=0)return;const _=_c(n.id,l,le,_t,n);let I=0;if(_.forEach($=>{Cc($.ownerType)||(I+=$.count||0)}),I>0){const $=x*I;Mo[b]&&(Mo[b]=Math.max(0,Mo[b]-$)),fn[n.id][b]=Math.max(0,fn[n.id][b]-$)}});const dn=new Set;if(Yt.forEach(n=>{var x;const l=((x=n.epoch)!=null?x:0)<=u,b=!n.requiresTech||C.includes(n.requiresTech);l&&b&&n.output&&Object.entries(n.output).forEach(([_,I])=>{Be[_]&&(I||0)>0&&dn.add(_)})}),Wa!==0){const n=Math.max(0,1+Wa);Uo=Math.max(0,Uo*n)}Uo=Math.floor(Uo);let hs=0;Object.entries(y).forEach(([n,l])=>{if(!l||l<=0)return;const b=Ro[n],x=(b==null?void 0:b.populationCost)||1;hs+=l*x});const ef=(m||[]).reduce((n,l)=>{if(l.status==="waiting"||l.status==="training"){const b=Ro[l.unitId],x=(b==null?void 0:b.populationCost)||1;return n+x}return n},0),ms=hs+ef;ms>0&&(Mo.soldier=(Mo.soldier||0)+ms);const tf=i&&Object.keys(i).length>0;let Z={},pn=0;if(tf){Xt.forEach(l=>{const b=i[l]||0;Z[l]=Math.max(0,b)}),Z.unemployed=Math.max(0,i.unemployed||0);const n=Xt.reduce((l,b)=>l+(Z[b]||0),0)+(Z.unemployed||0);if(pn=o-n,pn>0)Z.unemployed=(Z.unemployed||0)+pn;else if(pn<0){let l=-pn;const b=Math.min(Z.unemployed||0,l);if(b>0&&(Z.unemployed-=b,l-=b),l>0){const x=Xt.reduce((_,I)=>_+(Z[I]||0),0);if(x>0){const _=l;Xt.forEach((I,$)=>{if(l<=0)return;const A=Z[I]||0;if(A<=0)return;const G=A/x;let q=Math.floor(G*_);q<=0&&l>0&&(q=1),$===Xt.length-1?q=Math.min(A,l):q=Math.min(A,Math.min(q,l)),!(q<=0)&&(Z[I]=A-q,l-=q)}),l>0&&Xt.forEach(I=>{if(l<=0)return;const $=Z[I]||0;if($<=0)return;const A=Math.min($,l);Z[I]=$-A,l-=A})}}}}else{let n=o;Xt.forEach(l=>{const b=Math.max(0,Mo[l]||0),x=Math.min(n,b);Z[l]=x,n-=x}),Z.unemployed=Math.max(0,n)}Z.unemployed=Math.max(0,Z.unemployed||0);const of=q0(Z,bi);Xt.forEach(n=>{if(n==="official")return;const l=Z[n]||0,b=Math.max(0,Mo[n]||0);if(l>b){const x=l-b,_=je[n]||0,I=l>0?_/l:0;if(Z[n]=b,Z.unemployed=(Z.unemployed||0)+x,I>0){const $=I*x;Je.transfer(n,"unemployed",$,z.EXPENSE.LAYOFF_TRANSFER,z.EXPENSE.LAYOFF_TRANSFER)}}});const nf=Array.isArray(le)?le.length:0;Z.official=nf,je.official=0;let af=1,hn=0,ja=Br(J);const li=Math.max(0,af*ja*(1+(O.taxBonus||0))),rf=n=>{let b=0,x=0,_=0,I=0;Yt.forEach(q=>{var at,dt,Xe,ot,ge,Fe,qe;const X=co[q.id]||0;if(X<=0)return;const oe=Nt(q,0),be=oe.jobs||{},he=be[n]||0;if(he<=0)return;if(q.owner===n){let Pe=0;oe.output&&Object.entries(oe.output).forEach(([De,Se])=>{if(!Be[De])return;const Ee=ze[De]||Io(De);Pe+=Se*Ee});let Ze=0;oe.input&&Object.entries(oe.input).forEach(([De,Se])=>{const Ee=ze[De]||Io(De);Ze+=Se*Ee});let pe=0;Object.entries(be).forEach(([De,Se])=>{var Tt,Ct;if(De===n||!Se||Se<=0)return;const Ee=(Ct=(Tt=c==null?void 0:c.wages)==null?void 0:Tt[De])!=null?Ct:yo(De);pe+=Ee*Se});const Ge=((dt=(at=ae[n])==null?void 0:at.headTaxBase)!=null?dt:.01)*ci(n)*li,ke=(Xe=q.businessTaxBase)!=null?Xe:.1,pt=(ge=(ot=Ht==null?void 0:Ht.businessTaxRates)==null?void 0:ot[q.id])!=null?ge:1,it=ke*pt,Bt=Pe-Ze-pe-Ge-it,Ue=he>0?Bt/he:0;b+=Ue*he*X,x+=he*X}else{const Pe=(qe=(Fe=c==null?void 0:c.wages)==null?void 0:Fe[n])!=null?qe:yo(n);_+=Pe*he*X,I+=he*X}});const $=x+I;if($<=0)return yo(n);const G=(b+_)/$;return Math.max(yo(n),G*1.2)};tl({popStructure:Z,jobsAvailable:Mo,wealth:je,getExpectedWage:n=>{if((Z[n]||0)<=5){const b=rf(n),x=yo(n);return Math.max(b,x)}return yo(n)},getHeadTaxRate:ci,effectiveTaxModifier:li});const Eo={},po={},ho={},Et={},We=[],Zn=new Map,mn={},Na={},xi=n=>{if(!n)return;const l=Zn.get(n)||0;Zn.set(n,l+1)};Object.entries(Vu).forEach(([n,l])=>{if(!l)return;const b=l,x=ie[n]||0;if(b>=0)Dt(n,b,"passive_gain"),Te[n]=(Te[n]||0)+b;else{const _=Math.abs(b),I=Math.min(x,_);I>0&&(Dt(n,-I,"passive_cost"),Te[n]=(Te[n]||0)-I)}});const La=o||0;Object.entries(Yu||{}).forEach(([n,l])=>{if(!l||La<=0)return;const b=l*La,x=ie[n]||0;if(b>=0)Dt(n,b,"passive_pop_gain"),Te[n]=(Te[n]||0)+b;else{const _=Math.abs(b),I=Math.min(x,_);I>0&&(Dt(n,-I,"passive_pop_cost"),Te[n]=(Te[n]||0)-I)}}),Object.entries(Hu||{}).forEach(([n,l])=>{if(!l)return;const b=Te[n]||0;if(b!==0){const x=Math.abs(b)*l;b>=0?(Dt(n,x,"passive_percent_gain"),Te[n]=b+x):(Dt(n,-x,"passive_percent_cost"),Te[n]=b-x)}else{const _=La*.01*l;Dt(n,_,"passive_percent_base_gain"),Te[n]=(Te[n]||0)+_}});const Fa={},Ua=1-Math.max(-2,Math.min(.95,ds||0)),gs={};Object.keys(ae).forEach(n=>{gs[n]=je[n]||0}),Object.keys(ae).forEach(n=>{var X,oe,be;if(n==="official")return;const l=Z[n]||0;if(l===0)return;const b=ae[n];je[n]===void 0&&(je[n]=b.startingWealth||0);const x=ci(n),I=((oe=(X=ae[n])==null?void 0:X.headTaxBase)!=null?oe:.01)*x*li,$=Math.max(0,je[n]||0),A=$/Math.max(1,l),G=I>=0?Math.min(I,A):I,q=l*G;if(q!==0)if(q>0){const he=Math.min($,q);Je.transfer(n,"state",he,z.EXPENSE.HEAD_TAX,z.EXPENSE.HEAD_TAX),wi[n]=(wi[n]||0)+he,xt[n]=(xt[n]||0)+he,vi[n]=(vi[n]||0)+he}else{const he=-q;(ie.silver||0)>=he&&(Je.transfer("state",n,he,z.INCOME.SUBSIDY,z.INCOME.SUBSIDY),ft[n]=(ft[n]||0)+he,$o[n]=($o[n]||0)+he)}Eo[n]=(be=p[n])!=null?be:50,(Eo[n]||0)<=0&&(Fa[n]=!0)});const sf=!!(we&&we.forced_labor);Yt.forEach(n=>{var Tn,Yo,Pn,An,Ma,qo,Rn,ai,Po;const l=co[n.id]||0;if(l===0)return;const b=me[n.id]||{},x={input:{},output:{},jobs:{}};let _=0,I=!1;Object.entries(b).forEach(([B,F])=>{const Q=parseInt(B);Number.isFinite(Q)&&Q>0&&F>0&&(_+=F,I=!0)});const $=Math.max(0,l-_),A={0:$};Object.entries(b).forEach(([B,F])=>{const Q=parseInt(B);Number.isFinite(Q)&&Q>0&&F>0&&(A[Q]=F)});const G={};Object.entries(A).forEach(([B,F])=>{if(F<=0)return;const Q=parseInt(B),ne=Nt(n,Q).owner||"state";G[ne]||(G[ne]={levels:{},totalCount:0}),G[ne].levels[Q]=F,G[ne].totalCount+=F}),Object.keys(G).forEach(B=>{var F;je[B]===void 0&&(je[B]=((F=ae[B])==null?void 0:F.startingWealth)||0)}),n.owner;let q=1;if(!I&&$===l){if(n.input)for(const[B,F]of Object.entries(n.input))x.input[B]=F*l;if(n.output)for(const[B,F]of Object.entries(n.output))x.output[B]=F*l;if(n.jobs)for(const[B,F]of Object.entries(n.jobs))x.jobs[B]=F*l}else for(const[B,F]of Object.entries(A)){if(F<=0)continue;const Q=parseInt(B),ee=Nt(n,Q);if(ee.input)for(const[ne,se]of Object.entries(ee.input))x.input[ne]=(x.input[ne]||0)+se*F;if(ee.output)for(const[ne,se]of Object.entries(ee.output))x.output[ne]=(x.output[ne]||0)+se*F;if(ee.jobs)for(const[ne,se]of Object.entries(ee.jobs))x.jobs[ne]=(x.jobs[ne]||0)+se*F}const X=gi[u];let oe=0;X&&X.bonuses&&(n.cat==="gather"&&X.bonuses.gatherBonus&&(oe+=X.bonuses.gatherBonus),n.cat==="industry"&&X.bonuses.industryBonus&&(oe+=X.bonuses.industryBonus));let be=0,he=0;d.forEach(B=>{B.production&&(be+=B.production),B.industryBonus&&(he+=B.industryBonus)}),M.forEach(B=>{B.production&&(be+=B.production),B.industryBonus&&(he+=B.industryBonus)}),be+=Oa,he+=Ba,(n.cat==="gather"||n.cat==="civic")&&(oe+=be),n.cat==="industry"&&(oe+=he),qn&&O.wartimeProduction&&(oe+=O.wartimeProduction);const Me=Yn[n.cat];Me&&Me!==0&&(oe+=Me);const at=H[n.id]||0,dt=H[n.cat]||0,Xe=H.all||0;oe+=at+dt+Xe;const ot=Hn[n.id];ot&&ot!==0&&(oe+=ot),q*=1+oe,eo[n.id]||(eo[n.id]={wagesByRole:{},paidWagePerWorkerByRole:{},filledByRole:{},wagePaidRatioByOwner:{},ownerRevenue:0,productionCosts:0,businessTaxPaid:0});let ge=1,Fe=0,qe=0;const Pe={};let Ze=0;const pe=[];if(Object.keys(x.jobs).length>0){mn[n.id]=mn[n.id]||{};let B=1/0,F=!1;for(let Q in x.jobs){const ee=x.jobs[Q];Qo[Q]||(Qo[Q]={totalSlots:0,weightedWage:0}),Fe+=ee;const ne=Mo[Q],se=Z[Q],xe=ne>0?Math.min(1,se/ne):0,Ne=ee*xe;qe+=Ne,mn[n.id][Q]=Ne,eo[n.id].filledByRole[Q]=(eo[n.id].filledByRole[Q]||0)+Ne;const Ae=Object.keys(G).includes(Q);if(!Ae&&ee>0){F=!0;const vt=ee>0?Ne/ee:0;B=Math.min(B,vt)}const Ve=Math.max(0,ee-Ne);if(Ve>.001){const vt=Ve>=1?Math.floor(Ve):1;(Jn[Q]||(Jn[Q]=[])).push({buildingId:n.id,buildingName:n.name||n.id,availableSlots:vt})}if(!Ae&&Ne>0){const vt=(Tn=Pe[Q])!=null?Tn:yo(Q),nt=sn(Q),Ft=Math.max(vt,nt);Pe[Q]=Ft,Ze+=Ne*Ft,pe.push({role:Q,ownerKey:n.owner||"state",roleSlots:ee,filled:Ne,baseWage:Ft})}}F?ge=B===1/0?0:B:Fe>0&&(ge=qe/Fe),Fe>0&&(Na[n.id]=ge)}const rt=q;q*=ge,sf&&((Yo=n.jobs)!=null&&Yo.serf||(Pn=n.jobs)!=null&&Pn.miner)&&(q*=1.2);const Ge=q,ke=Ge>0?Ge:rt;let pt=1,it=0,Bt=!1;const Ue=Object.keys(x.input).length>0,De=Object.keys(x.output).some(B=>B!=="maxPop"&&B!=="militaryCapacity");if(Ue&&De){const B=((An=O.officialProductionInputCost)==null?void 0:An[n.id])||0,F=((Ma=O.stanceProductionInputCost)==null?void 0:Ma[n.id])||0,Q=B+F;if(Q!==0){const ee=1+Q,ne=Math.max(.2,ee);for(const[se,xe]of Object.entries(x.input))x.input[se]=xe*ne}if(O.resourceWaste)for(const[ee,ne]of Object.entries(x.input)){const se=((qo=O.resourceWaste)==null?void 0:qo[ee])||0;if(!se)continue;const xe=Math.max(0,1+se);x.input[ee]=ne*xe}}if(Object.keys(x.input).length>0)for(const[B,F]of Object.entries(x.input)){if(!Di(B,u,C))continue;const Q=F,ee=Q*ke;if(ee<=0)continue;const ne=ie[B]||0;if(ne<=0?pt=0:pt=Math.min(pt,ne/ee),Qt(B)){const se=so(B),xe=Li(B);it+=Q*se*(1+xe)}}let Se=Ge*Math.max(0,Math.min(1,pt)),Ee=ke*Math.max(0,Math.min(1,pt));if(n.cat==="gather"&&pt===0&&Object.keys(x.input).length>0){Se=Ge*.2,Ee=ke*.2,Bt=!0,it=0;const B=Object.keys(x.input).map(F=>{var Q;return((Q=Be[F])==null?void 0:Q.name)||F}).join("、");g%30===0&&xi(`?? ${n.name} 缺少 ${B}，工人正在徒手作业（效率20%）`)}let Tt=0,Ct=!1;if(Object.keys(x.output).length>0)for(const[B,F]of Object.entries(x.output)){if(B==="maxPop"||!Qt(B))continue;Ct=!0;const ne=F*so(B);Tt+=ne}const Lt=ke>0?Ze/ke:Ze,Oe=Tt*Ee,$e=it*Ee,Qe=Lt*Ee,Pt=Math.max(0,Oe-$e),At=Qe>0?Pt/Qe:1,uo=Number.isFinite(At)?At>=1?Math.min(3,1+(At-1)*.5):Math.max(.65,1-(1-At)*.5):1,st=Lt*uo,_o=st*Ee,ct=n.cat==="civic"&&!n.owner&&((Rn=n.output)==null?void 0:Rn.maxPop)>0,zt=n.cat==="military",to=(ai=n.businessTaxBase)!=null?ai:.1,Rt=ct||zt?0:$u(n.id),St=to*Rt,Lo=St*l*Ee,To=it+st;let ve=Se,gt=Ee,Jt=null,jt=null;const ti=Math.min(_o,Pt),hi=Se>0?ti/Se:0,oi=it+hi;if(Ct){const B=$e+ti+Math.max(0,Lo);if(B>0&&Oe<=0)ve=0,Jt=0;else if(B>0&&Oe<B*.98){const F=Math.max(0,Math.min(1,Oe/B));Jt=F,ve=Se*F,gt=Ee*F}else Jt=B>0?Oe/B:null;jt={baseMultiplier:Ge,resourceLimit:pt,targetMultiplier:Se,estimatedRevenue:Oe,estimatedInputCost:$e,estimatedWageCost:_o,actualPayableWageCost:ti,actualWageCostPerMultiplier:hi,actualOperatingCostPerMultiplier:oi,estimatedBusinessTax:Lo,estimatedCost:B,marginRatio:Jt,actualMultiplierAfterMargin:ve,outputValuePerMultiplier:Tt,inputCostPerMultiplier:it,wageCostPerMultiplier:st,count:l,expectedWageBillBase:Ze,baseWageCostPerMultiplier:Lt,wagePressure:uo,baseWageCost:Qe,wageCoverage:At,valueAvailableForLabor:Pt,wagePlans:pe}}if(oi>0){let B=1/0;const F=[];Object.entries(G).forEach(([ne,se])=>{const xe=se.totalCount/l,Ne=oi*xe,Ae=je[ne]||0,Ve=Ne>0?Ae/Ne:1/0;B=Math.min(B,Ve),F.push({owner:ne,proportion:xe,operatingCost:Ne,cash:Ae,affordable:Ve})});const Q=B===1/0?Se:B,ee=B===1/0?Ee:B;ve=Math.min(ve,Math.max(0,Q)),gt=Math.min(gt,Math.max(0,ee)),jt&&(jt.totalOperatingCostPerMultiplier=To,jt.minAffordableMultiplier=B,jt.affordableMultiplier=Q,jt.actualMultiplierAfterAffordable=ve,jt.ownerDetails=F)}jt&&(ss[n.id]=jt),(!Number.isFinite(ve)||ve<0)&&(ve=0);const re=.3;let Mt=1;Object.keys(G).forEach(B=>{Fa[B]&&(Mt=Math.min(Mt,re))}),Object.keys(x.jobs).length>0&&Object.keys(x.jobs).forEach(B=>{Fa[B]&&(Mt=Math.min(Mt,re))}),ve*=Mt,gt*=Mt;const fo=Ge>0?Math.min(1,ve/Ge):0,oo=ke>0?Math.min(1,gt/ke):0;let wo=0;if(Object.keys(x.input).length>0&&!Bt){const B={};Object.entries(A).forEach(([F,Q])=>{if(Q<=0)return;const ee=parseInt(F),ne=Nt(n,ee);!ne.input||Object.keys(ne.input).length===0||(B[ee]={},Object.entries(ne.input).forEach(([se,xe])=>{B[ee][se]=xe*Q*ve}))});for(const[F,Q]of Object.entries(x.input)){if(!Di(F,u,C))continue;const ee=Q*ve;if(!ee||ee<=0)continue;const ne=ie[F]||0,se=Math.min(ee,ne),xe=ee>0?se/ee:0;if(Qt(F)){const Ne=so(F),Ae=Li(F);Object.entries(B).forEach(([Ve,vt])=>{const nt=parseInt(Ve),Ft=vt[F]||0;if(Ft<=0)return;const qt=Ft*xe;if(qt<=0)return;const mo=Nt(n,nt).owner||"state",Xi=qt*Ne,Ii=Xi*Ae;let zi=Xi;if(Ii<0){const Ji=Math.abs(Ii);(ie.silver||0)>=Ji&&(Je.transfer("state",mo,Ji,z.INCOME.SUBSIDY,z.INCOME.SUBSIDY),zi-=Ji,ft[mo]=(ft[mo]||0)+Ji)}else Ii>0&&(Je.transfer(mo,"state",Ii,z.EXPENSE.RESOURCE_TAX,z.EXPENSE.RESOURCE_TAX),zi+=Ii);Je.transfer(mo,"void",Xi,z.EXPENSE.PRODUCTION_COST,z.EXPENSE.PRODUCTION_COST,{buildingId:n.id}),xt[mo]=(xt[mo]||0)+zi,eo[n.id].productionCosts+=zi}),bo[F]=(bo[F]||0)+se,cn[F]||(cn[F]={buildings:{},pop:0}),cn[F].buildings[n.id]=(cn[F].buildings[n.id]||0)+se}se<=0||(ie[F]=ne-se,Te[F]=(Te[F]||0)-se)}}Object.keys(x.jobs).length>0&&Object.entries(x.jobs).forEach(([B,F])=>{const Q=F;Q<=0||(Qo[B]||(Qo[B]={totalSlots:0,weightedWage:0}),Qo[B].totalSlots+=Q)});const ii={};Object.entries(A).forEach(([B,F])=>{const Q=parseInt(B),ee=Nt(n,Q);let ne=0;ee.output&&Object.entries(ee.output).forEach(([nt,Ft])=>{if(nt==="maxPop"||!Qt(nt))return;const io=Ft*so(nt);ne+=io});let se=0;ee.input&&Object.entries(ee.input).forEach(([nt,Ft])=>{Di(nt,u,C)&&Qt(nt)&&(se+=Ft*so(nt))});let xe=0;const Ne=ee.owner||"state";ee.jobs&&Object.entries(ee.jobs).forEach(([nt,Ft])=>{var io;if(nt===Ne)return;const qt=(io=Pe[nt])!=null?io:yo(nt);xe+=Ft*qt});const Ae=Math.max(0,ne-se),Ve=xe>0?Ae/xe:1;let vt=1;Number.isFinite(Ve)?Ve>=1?vt=Math.min(3,1+(Ve-1)*.5):vt=Math.max(.65,1-(1-Ve)*.5):vt=1,ii[Q]=vt});let _n=0,Go=0;Object.entries(A).forEach(([B,F])=>{const Q=parseInt(B),ee=ii[Q]||1;_n+=ee*F,Go+=F});const ni=Go>0?_n/Go:uo,Vi=((Po=n.marketConfig)==null?void 0:Po.wage)||{},mi=Vi.wageMode,Hi=Vi.subsistenceMultiplier||1.5,Yi=pe.map(B=>{const F=B.ownerKey||n.owner||"state";let Q=ni;if(Object.keys(A).length>1){let se=0,xe=0;Object.entries(A).forEach(([Ne,Ae])=>{var Ft;const Ve=parseInt(Ne),nt=((Ft=Nt(n,Ve).jobs)==null?void 0:Ft[B.role])||0;if(nt>0){const qt=ii[Ve]||1;se+=qt*nt*Ae,xe+=nt*Ae}}),xe>0&&(Q=se/xe)}let ee=B.baseWage*fo*Q;mi==="subsistence"&&(ee=((Zo==null?void 0:Zo[B.role])||sn(B.role))*Hi);const ne=ee*B.filled;return wo+=ne,{...B,ownerKey:F,expectedSlotWage:ee,wagePressure:Q,wageMode:mi,subsistenceMultiplier:mi==="subsistence"?Hi:void 0}}),Si={};if(eo[n.id].wagePaidRatioByOwner=Si,wo>0){const B={};Object.entries(A).forEach(([F,Q])=>{if(Q<=0)return;const ee=parseInt(F),ne=Nt(n,ee),se=ne.owner||"state";B[se]||(B[se]=0),ne.jobs&&Object.entries(ne.jobs).forEach(([xe,Ne])=>{if(xe===se)return;let Ae;mi==="subsistence"?Ae=((Zo==null?void 0:Zo[xe])||sn(xe))*Hi:Ae=yo(xe);const Ve=Ne*Q*Ae*fo*(ii[ee]||1);B[se]+=Ve})}),Object.entries(B).forEach(([F,Q])=>{if(Q<=0){Si[F]=0;return}const ee=je[F]||0;let ne=0;const se=ae[F];se&&se.needs&&(Object.entries(se.needs).forEach(([Ae,Ve])=>{const vt=so(Ae);ne+=Ve*vt}),ne*=1.2);const xe=Math.max(0,ee-ne),Ne=Math.min(xe,Q);Je.transfer(F,"void",Ne,z.EXPENSE.WAGES_PAID,z.EXPENSE.WAGES_PAID,{buildingId:n.id}),xt[F]=(xt[F]||0)+Ne,Si[F]=Q>0?Ne/Q:0})}if(Yi.forEach(B=>{var ne;const F=(ne=Si[B.ownerKey])!=null?ne:0,Q=B.expectedSlotWage*F,ee=B.baseWage*oo*B.wagePressure;if(Qo[B.role].weightedWage+=ee*B.roleSlots,B.filled>0&&Q>0){const se=Q*B.filled;eo[n.id].wagesByRole[B.role]=(eo[n.id].wagesByRole[B.role]||0)+se,Je.transfer("void",B.role,se,z.INCOME.WAGE,z.INCOME.WAGE,{buildingId:n.id}),ft[B.role]=(ft[B.role]||0)+se,$o[B.role]=($o[B.role]||0)+se}}),Object.entries(eo[n.id].wagesByRole).forEach(([B,F])=>{const Q=eo[n.id].filledByRole[B]||0;Q>0&&(eo[n.id].paidWagePerWorkerByRole[B]=F/Q)}),Object.keys(x.output).length>0){const B={};Object.entries(A).forEach(([F,Q])=>{if(Q<=0)return;const ee=parseInt(F),ne=Nt(n,ee);!ne.output||Object.keys(ne.output).length===0||(B[ee]={},Object.entries(ne.output).forEach(([se,xe])=>{B[ee][se]=xe*Q*ve}))});for(const[F,Q]of Object.entries(x.output)){let ee=Q*ve;if(!ee||ee<=0)continue;let ne=1;if(Qt(F)&&F!=="silver"){const se=Be[F],xe=(se==null?void 0:se.marketConfig)||{},Ne=(Ut==null?void 0:Ut.market)||{},Ae=xe.outputVariation!==void 0?xe.outputVariation:Ne.outputVariation||.2;ne=1+(Math.random()*2-1)*Ae,ee*=ne;const Ve=Da[F]||0;Ve!==0&&(ee*=1+Ve),F==="science"&&O.scienceBonus&&(ee*=1+O.scienceBonus),F==="culture"&&O.cultureBonus&&(ee*=1+O.cultureBonus)}F!=="maxPop"&&(Qt(F)?(Object.entries(B).forEach(([se,xe])=>{const Ne=parseInt(se),Ae=xe[F]||0;if(Ae<=0)return;const Ve=Q*ve,vt=Ve>0?Ae/Ve:0,nt=ee*vt;if(nt<=0)return;const qt=Nt(n,Ne).owner||"state";zn=n.id,Qu(F,nt,qt),zn=null}),Te[F]=(Te[F]||0)+ee,ro[F]||(ro[F]={buildings:{},imports:0}),ro[F].buildings[n.id]=(ro[F].buildings[n.id]||0)+ee):F==="silver"?Object.entries(B).forEach(([se,xe])=>{const Ne=parseInt(se),Ae=xe[F]||0;if(Ae<=0)return;const Ve=Q*ve,vt=Ve>0?Ae/Ve:0,nt=ee*vt;if(nt<=0)return;const qt=Nt(n,Ne).owner||"state";qt==="state"?Dt(F,nt,"building_production_direct"):Je.transfer("void",qt,nt,"building_production_direct","building_production_direct",{buildingId:n.id})}):Dt(F,ee,"building_production_direct"))}}if(St!==0&&l>0){const B=St*l*ve;if(B>0)Object.entries(G).forEach(([F,Q])=>{var xe;const ee=Q.totalCount/l,ne=B*ee,se=je[F]||0;se>=ne?(Je.transfer(F,"state",ne,z.EXPENSE.BUSINESS_TAX,z.EXPENSE.BUSINESS_TAX,{buildingId:n.id}),xt[F]=(xt[F]||0)+ne):g%30===0&&se<ne*.5&&xi(`?? ${((xe=ae[F])==null?void 0:xe.name)||F} 无力支付 ${n.name} 的营业税，政府放弃征收。`)});else if(B<0){const F=Math.abs(B);(ie.silver||0)>=F?Object.entries(G).forEach(([ee,ne])=>{const se=ne.totalCount/l,xe=F*se;Je.transfer("state",ee,xe,z.INCOME.SUBSIDY,z.INCOME.SUBSIDY),ft[ee]=(ft[ee]||0)+xe}):g%30===0&&xi(`?? 国库空虚，无法为 ${n.name} 支付营业补贴！`)}}if(n.id==="market"){const B=n.owner||"merchant",F=(Z[B]||0)>0,Q=g%5===0;if(F&&Q){let ne=je[B]||0;if(!(ne<=0)){const se=[];if(Object.entries(ie).forEach(([xe,Ne])=>{if(!Qt(xe)||xe==="silver"||(Ne||0)<=300||(Te[xe]||0)<0)return;const Ae=so(xe);se.push({resource:xe,stock:Ne,localPrice:Ae})}),se.length>0){const xe=[];if(Object.keys(Be).forEach(Ne=>{if(!Qt(Ne)||Ne==="silver")return;const Ae=ie[Ne]||0,Ve=Te[Ne]||0,vt=Math.max(0,(bo[Ne]||0)-(Do[Ne]||0)),nt=Math.max(0,200-Ae),Ft=Ve<0?Math.abs(Ve):0,qt=Math.max(vt,nt,Ft);if(qt<=0)return;const io=Math.max(Bi,so(Ne)*1.15),mo=qt*io;mo<=0||xe.push({resource:Ne,shortageAmount:qt,importPrice:io,requiredValue:mo})}),xe.length>0){xe.sort((Ae,Ve)=>Ve.requiredValue-Ae.requiredValue);const Ne=10;xe.forEach(Ae=>{var nt,Ft;if(ne<=0)return;let Ve=Ae.shortageAmount,vt=Ae.requiredValue;for(const qt of se){if(ne<=0||Ve<=0||vt<=0)break;const io=qt.resource,mo=qt.localPrice;if(mo<=0)continue;const Xi=ie[io]||0;if(Xi<=0)continue;const Ii=vt/mo,zi=Xi*.05,Ji=ne/mo,ki=Math.min(Ii,zi,Ji);if(!Number.isFinite(ki)||ki<=0)continue;const Sn=ki*mo;if(ne-=Sn,Je.transfer(B,"void",Sn,z.EXPENSE.TRADE_EXPORT_PURCHASE,z.EXPENSE.TRADE_EXPORT_PURCHASE),xt[B]=(xt[B]||0)+Sn,Dt(io,-ki,"trade_export_deduction"),Do[io]=(Do[io]||0)+ki,Te[io]=(Te[io]||0)-ki,qt.stock=Math.max(0,qt.stock-ki),vt=Math.max(0,vt-Sn),Ae.importPrice<=0)continue;let Vo=Sn/Ae.importPrice;if(!Number.isFinite(Vo)||Vo<=0||(Vo=Math.min(Vo,Ve),Vo<=0))continue;const In=Vo*Ae.importPrice;Je.transfer("void",B,In,z.INCOME.TRADE_IMPORT_REVENUE,z.INCOME.TRADE_IMPORT_REVENUE),ne+=In,Dt(Ae.resource,Vo,"trade_import_gain"),Do[Ae.resource]=(Do[Ae.resource]||0)+Vo,Te[Ae.resource]=(Te[Ae.resource]||0)+Vo,ro[Ae.resource]||(ro[Ae.resource]={buildings:{},imports:0}),ro[Ae.resource].imports=(ro[Ae.resource].imports||0)+Vo,Ve=Math.max(0,Ve-Vo),In>0&&(ft[B]=(ft[B]||0)+In),In>Ne&&((nt=Be[io])!=null&&nt.name,(Ft=Be[Ae.resource])!=null&&Ft.name||Ae.resource)}})}}}}}n.jobs&&Object.entries(n.jobs).forEach(([B,F])=>{F*l<=0})});const cf=b0(te),Qn=vc(y);Object.keys(Qn).forEach(n=>{Qn[n]=Math.ceil((Qn[n]||0)*cf)});const ys={};Object.entries(Qn).forEach(([n,l])=>{ys[n]=qn?l*cs:l});let Kn=0;const bs={};Object.entries(ys).forEach(([n,l])=>{var $;if(l<=0)return;if(n==="silver"){Kn+=l;return}const b=ie[n]||0,x=Math.min(b,l);x>0&&(ie[n]=b-x,Te[n]=(Te[n]||0)-x,bs[n]=x,bo[n]=(bo[n]||0)+l);const _=so(n);let I=_;if(Re!=null&&Re.enabled&&(I=_r({resourceKey:n,amount:l,marketPrice:_,priceControls:Re,taxBreakdown:Gt,resources:ie,onTreasuryChange:Vt}).effectivePrice),Kn+=l*I,x<l&&g%30===0){const A=l-x;xi(`?? 军队维护资源不足：缺少 ${(($=Be[n])==null?void 0:$.name)||n} ${A.toFixed(1)}/日`)}});const Ms=1+u*.1,lf=yr(y),vs=wc(lf,o),ws=Math.max(.5,w!=null?w:1),Wo=Kn*Ms*vs*ws,ea={dailyExpense:Wo,resourceCost:Kn,epochMultiplier:Ms,scalePenalty:vs,wageMultiplier:ws,resourceConsumption:bs};let gn={totalArmyCost:Wo,availableSilver:ie.silver,applied:!1,reason:null,logSizeBefore:It.length};if(Wo>0){console.log("[Simulation] Applying military cost:",Wo,"Reason:","expense_army_maintenance");const n=ie.silver||0;if(n>=Wo){Je.transfer("state","soldier",Wo,z.EXPENSE.MAINTENANCE,z.INCOME.MILITARY_PAY),gn.applied=!0,gn.reason="expense_army_maintenance",Te.silver=(Te.silver||0)-Wo,ft.soldier=(ft.soldier||0)+Wo,$o.soldier=($o.soldier||0)+Wo,bt.soldier&&(bt.soldier.income.militaryPay=(bt.soldier.income.militaryPay||0)+Wo);const l=It.toArray().pop();gn.logEntryFound=l&&l.reason===z.EXPENSE.MAINTENANCE,gn.logSizeAfter=It.length}else if(Wo>0){const l=n*.9;l>0&&(Je.transfer("state","soldier",l,z.EXPENSE.MAINTENANCE,z.INCOME.MILITARY_PAY),Te.silver=(Te.silver||0)-l,ft.soldier=(ft.soldier||0)+l,bt.soldier&&(bt.soldier.income.militaryPay=(bt.soldier.income.militaryPay||0)+l)),We.push(`?? 军饷不足！应付${Wo.toFixed(0)}银币，仅能支付${l.toFixed(0)}银币，军心不稳。`)}}const Ei={},Co={},ta={},Ko={};Object.keys(ae).forEach(n=>{var ge,Fe,qe,Pe,Ze;if(n==="official"){Ei[n]={satisfactionRatio:1,totalTrackedNeeds:0},Co[n]=[];return}const l=ae[n],b=Z[n]||0;if(b===0||!l.needs){Ei[n]={satisfactionRatio:1,totalTrackedNeeds:0},Co[n]=[];return}let x=0,_=0;const I=[],$=l.startingWealth||1,G=(je[n]||0)/Math.max(1,b)/$,q=l.needs||{};let X=0;["food","cloth"].forEach(pe=>{var rt;if(q[pe]){const Ge=so(pe),ke=((rt=Be[pe])==null?void 0:rt.basePrice)||1,pt=Math.max(Ge,ke);X+=q[pe]*pt}});const oe=(ft[n]||0)/Math.max(1,b),be=X>0?oe/X:oe>0?10:0,he=Math.max(1,(l.maxConsumptionMultiplier||6)+kr(te)),Me=Zi(be,G,l.wealthElasticity||1,he),at=Wc(be).level,dt=Sc({consumptionMultiplier:Me,incomeRatio:be,wealthRatio:G,livingStandardLevel:at}),Xe=Ic(be,G,l.wealthElasticity||1,at),ot={...l.needs};if(l.luxuryNeeds){const pe=Object.keys(l.luxuryNeeds).map(Number).sort((rt,Ge)=>rt-Ge);for(const rt of pe)if(Xe>=rt){const Ge=l.luxuryNeeds[rt];for(const[ke,pt]of Object.entries(Ge))ot[ke]=(ot[ke]||0)+pt*dt}}for(const[pe,rt]of Object.entries(ot)){const Ge=Be[pe];if(Ge&&Ge.unlockTech){if(!C.includes(Ge.unlockTech))continue}else if(Ge&&typeof Ge.unlockEpoch=="number"&&Ge.unlockEpoch>u)continue;if(!dn.has(pe))continue;let ke=rt*b*Ua;if(ke<=0)continue;const pt=((ge=O.resourceWaste)==null?void 0:ge[pe])||0;pt!==0&&(ke*=1+pt);const it=W[pe]||0,Bt=ln[pe]||0,Ue=it+Bt;Ue!==0&&(ke*=1+Ue);const De=j[n]||0,Se=un[n]||0,Ee=De+Se;Ee!==0&&(ke*=1+Ee),qn&&(n==="soldier"||n==="knight")&&(ke*=cs);let Tt=1;if(n==="official"&&le&&le.length>0&&(Tt=le.reduce(($e,Qe)=>$e+(Qe.greed||1),0)/le.length),Qt(pe)){const Oe=(Ge==null?void 0:Ge.marketConfig)||{},$e=(Ut==null?void 0:Ut.market)||{},Qe=Oe.demandElasticity!==void 0?Oe.demandElasticity:$e.demandElasticity||.5,Pt=l.startingWealth||1,At=(je[n]||0)/Math.max(1,b),uo=(ft[n]||0)/Math.max(1,b),st=Math.max(0,uo)*30,ct=Math.max(At,st)/Pt;let zt=l.wealthElasticity||1;n==="official"&&(zt*=Tt);const to=Math.max(1,(l.maxConsumptionMultiplier||6)+kr(te)),Rt=Zi(ct,ct,zt,to);(!ta[n]||Math.abs(Rt-1)>Math.abs(ta[n]-1))&&(ta[n]=Rt);const St=so(pe),Lo=Ge.basePrice||1,To=St/Lo,ve=Math.pow(To,-Qe),gt=.8+Math.random()*.4;ke*=Rt*ve*gt,ke=Math.max(0,ke),ke=Math.min(ke,rt*b*Ua*8)}const Ct=ie[pe]||0;let Lt=0;if(Qt(pe)){const Oe=so(pe),Qe=((Fe=Y==null?void 0:Y.dominance)==null?void 0:Fe.panelType)==="plannedEconomy"&&(Re==null?void 0:Re.enabled)&&((qe=Re.governmentSellPrices)==null?void 0:qe[pe])!==void 0&&Re.governmentSellPrices[pe]!==null;let Pt=Oe;Qe&&(Pt=Re.governmentSellPrices[pe]);const At=Pt*(1+Li(pe)),uo=At>0?Math.min(ke,(je[n]||0)/At):ke,st=Math.min(ke,Ct,uo);if(st>0){ie[pe]=Ct-st,Te[pe]=(Te[pe]||0)-st;let ct=Oe;Qe&&(ct=_r({resourceKey:pe,amount:st,marketPrice:Oe,priceControls:Re,taxBreakdown:Gt,resources:ie,onTreasuryChange:Vt}).effectivePrice);const zt=Li(pe),to=st*ct,Rt=to*zt;let St=to;if(Rt<0){const ve=Math.abs(Rt);(ie.silver||0)>=ve?(Je.transfer("state",n,ve,z.INCOME.SUBSIDY,z.INCOME.SUBSIDY),St-=ve,ft[n]=(ft[n]||0)+ve,$o[n]=($o[n]||0)+ve):g%20===0&&xi(`国库空虚，无法为 ${((Pe=ae[n])==null?void 0:Pe.name)||n} 支付 ${((Ze=Be[pe])==null?void 0:Ze.name)||pe} 消费补贴！`)}else Rt>0&&(Je.transfer(n,"state",Rt,z.EXPENSE.RESOURCE_TAX,z.EXPENSE.RESOURCE_TAX),St+=Rt);const To=l.needs&&l.needs.hasOwnProperty(pe)?z.EXPENSE.ESSENTIAL_CONSUMPTION:z.EXPENSE.LUXURY_CONSUMPTION;Je.transfer(n,"void",St,To,To,{resource:pe,quantity:st,price:ct}),xt[n]=(xt[n]||0)+St,vi[n]=(vi[n]||0)+St,Lt=st,bo[pe]=(bo[pe]||0)+st,Ko[n]||(Ko[n]={}),Ko[n][pe]=(Ko[n][pe]||0)+st}const _o=ke>0?Lt/ke:1;if(x+=_o,_+=1,_o<.99){const ct=uo>=ke*.99,zt=Ct>=ke*.99;let to="both";ct&&!zt?to="outOfStock":!ct&&zt&&(to="unaffordable"),I.push({resource:pe,reason:to})}}else{const Oe=Math.min(ke,Ct);Oe>0&&(ie[pe]=Ct-Oe,Lt=Oe);const $e=ke>0?Lt/ke:1;x+=$e,_+=1,$e<.99&&I.push({resource:pe,reason:"outOfStock"})}}Ei[n]={satisfactionRatio:_>0?x/_:1,totalTrackedNeeds:_},Co[n]=I});let xs=0,yn=0,$a=0;Object.keys(ae).forEach(n=>{var _,I;const l=Z[n]||0;if(l<=0)return;yn+=l;const b=(I=(_=Ei[n])==null?void 0:_.satisfactionRatio)!=null?I:1;xs+=b*l;const x=ae[n];x&&x.needs&&(Co[n]||[]).some(G=>G.resource==="food"||G.resource==="cloth")&&($a+=l)});let oa=.3+.7*(yn>0?xs/yn:1);if($a>0&&yn>0){const n=$a/yn,l=n*.4;oa=Math.max(.1,oa-l),n>.1&&We.push("基础需求（食物/布料）严重短缺，劳动效率大幅下降！")}oa<.999&&Object.entries(Te).forEach(([n,l])=>{const b=Be[n];if(!(!b||n==="silver"||b.type&&b.type==="virtual")&&l>0){const x=l*(1-oa);Te[n]=l-x,ie[n]=Math.max(0,(ie[n]||0)-x)}});const uf=we?Object.entries(we).map(([n,l])=>({id:n,active:!0,modifiers:(l==null?void 0:l.effects)||(l==null?void 0:l.modifiers)})):[];let ff=nl(uf);if(we!=null&&we.tithe){const n=(Z.cleric||0)*2*li;if(n>0){const l=je.cleric||0,b=Math.min(l,n);Je.transfer("cleric","state",b,z.EXPENSE.HEAD_TAX,z.EXPENSE.HEAD_TAX),xt.cleric=(xt.cleric||0)+b}}const Ui=Ie&&typeof Ie=="object"&&Object.prototype.hasOwnProperty.call(Ie,"targets")?Ie:{enabled:!0,targets:Ie||{}};if(((Ns=Y.dominance)==null?void 0:Ns.faction)==="left"&&(Ui!=null&&Ui.enabled)&&Ui.targets&&Object.keys(Ui.targets).length>0){const{adjustments:n,approvalPenalties:l,adminCost:b}=i0(Z,Ui.targets),x=Object.values(Z).reduce((G,q)=>G+q,0);let _=0,I=null,$=-1;Object.entries(n).forEach(([G,q])=>{Z[G]!==void 0&&(Z[G]=Math.max(0,Math.round(Z[G]+q)))}),Object.keys(Z).forEach(G=>{const q=Z[G];_+=q,q>$&&($=q,I=G)});const A=x-_;A!==0&&I&&(Z[I]+=A,Z[I]<0&&(Z[I]=0)),Object.entries(l).forEach(([G,q])=>{Eo[G]&&(Eo[G]-=q*.05)})}let ia={...t};const df={cabinetStatusReceived:{hasCabinetStatus:!!Y,hasDominance:!!(Y!=null&&Y.dominance),dominanceFaction:(Ls=Y==null?void 0:Y.dominance)==null?void 0:Ls.faction,synergy:Y==null?void 0:Y.synergy,level:Y==null?void 0:Y.level},expansionSettings:{hasSettings:!!de,settingsKeys:de?Object.keys(de):[],allowedCount:de?Object.values(de).filter(n=>n==null?void 0:n.allowed).length:0},conditionCheck:{isDominanceRight:((Fs=Y==null?void 0:Y.dominance)==null?void 0:Fs.faction)==="right",hasExpansionSettings:!!de,willProcess:((Us=Y==null?void 0:Y.dominance)==null?void 0:Us.faction)==="right"&&!!de},epochParam:u};if(console.log("[FREE MARKET SIMULATION DEBUG]",{dominanceCheck:{hasDominance:!!(Y!=null&&Y.dominance),faction:($s=Y==null?void 0:Y.dominance)==null?void 0:$s.faction,isRightWing:((Gs=Y==null?void 0:Y.dominance)==null?void 0:Gs.faction)==="right"},expansionCheck:{hasSettings:!!de,settingsCount:de?Object.keys(de).length:0,allowedBuildings:de?Object.entries(de).filter(([n,l])=>l==null?void 0:l.allowed).map(([n])=>n):[]},willCallProcessExpansions:!!(Y!=null&&Y.dominance)&&Y.dominance.faction==="right"&&!!de}),((qs=Y.dominance)==null?void 0:qs.faction)==="right"&&de){const n={prices:ze,wages:(c==null?void 0:c.wages)||{}},{expansions:l,wealthDeductions:b}=r0(Yt,je,de,ia,n,h,Na);l.length>0&&(l.forEach(x=>{const _=x.buildingId;ia[_]=(ia[_]||0)+1}),Object.entries(b).forEach(([x,_])=>{je[x]&&Je.transfer(x,"void",_,z.EXPENSE.BUILDING_COST,z.EXPENSE.BUILDING_COST)}),Object.assign(co,ia))}let bn=0,Es=0,$i=0,na=0;const Ga=[],qa={prices:ze,wages:(c==null?void 0:c.wages)||{}},Ci=(le||[]).map(n=>{var Lo,To,ve,gt,Jt,jt,ti,hi,oi;if(!n)return n;const l=kl(n,g),b=1e12;let x=typeof l.wealth=="number"?l.wealth:400;(!Number.isFinite(x)||x<0)&&(x=400);let _=Math.min(x,b);const I=_;ue&&typeof l.salary=="number"?(_+=l.salary,$i+=l.salary,na+=l.salary,console.log(`[OFFICIAL DEBUG] ${l.name}: Salary paid! +${l.salary}, wealth: ${I} -> ${_}`),bt.official&&(bt.official.income.salary=(bt.official.income.salary||0)+l.salary)):console.log(`[OFFICIAL DEBUG] ${l.name}: NO SALARY! officialsPaid=${ue}, salary=${l.salary}, wealth=${_}`);const $=((Lo=ae.official)==null?void 0:Lo.needs)||{food:1.2,cloth:.2},A=((To=ae.official)==null?void 0:To.luxuryNeeds)||{};let G=0,q=0,X=0;const oe={},be=(re,Mt,fo=!1)=>{var Si,Tn;if(!re||Mt<=0)return;const oo=Be[re];if(oo!=null&&oo.unlockTech&&!C.includes(oo.unlockTech)||oo&&typeof oo.unlockEpoch=="number"&&oo.unlockEpoch>u||dn&&!dn.has(re))return;let wo=Mt*Ua;if(wo<=0)return;const ii=((Si=O.resourceWaste)==null?void 0:Si[re])||0;ii!==0&&(wo*=1+ii);const _n=W[re]||0,Go=ln[re]||0,ni=_n+Go;ni!==0&&(wo*=1+ni);const Vi=j.official||0,mi=un.official||0,Hi=Vi+mi;Hi!==0&&(wo*=1+Hi);const Yi=ie[re]||0;if(Qt(re)){const Yo=so(re),Pn=Li(re),An=Yo*(1+Pn),Ma=An>0?Math.min(wo,_/An):wo,qo=Math.min(wo,Yi,Ma);if(qo<=0)return;ie[re]=Yi-qo,Te[re]=(Te[re]||0)-qo,bo[re]=(bo[re]||0)+qo;const Rn=qo*Yo,ai=Rn*Pn;let Po=Rn;if(ai<0){const F=Math.abs(ai);(ie.silver||0)>=F?(Je.transfer("state","official",F,z.INCOME.SUBSIDY,z.INCOME.SUBSIDY),Po-=F,$i+=F,na+=F):g%20===0&&xi(`国库空虚，无法为 官员 支付 ${((Tn=Be[re])==null?void 0:Tn.name)||re} 消费补贴！`)}else ai>0&&(Je.transfer("official","state",ai,z.EXPENSE.RESOURCE_TAX,z.EXPENSE.RESOURCE_TAX),Po+=ai);_=Math.max(0,_-Po),G+=Po,fo?q+=Po:X+=Po,oe[re]||(oe[re]={amount:0,cost:0,tax:0,luxuryCost:0,essentialCost:0}),oe[re].amount+=qo,oe[re].cost+=Po,oe[re].tax+=ai,fo?oe[re].luxuryCost+=Po:oe[re].essentialCost+=Po,Ko.official||(Ko.official={}),Ko.official[re]=(Ko.official[re]||0)+qo;const B=fo?z.EXPENSE.LUXURY_CONSUMPTION:z.EXPENSE.ESSENTIAL_CONSUMPTION;Je.transfer("official","void",Po,B,B,{resource:re,quantity:qo,price:Yo})}else{const Yo=Math.min(wo,Yi);Yo>0&&(ie[re]=Yi-Yo,oe[re]||(oe[re]={amount:0,cost:0,tax:0,luxuryCost:0,essentialCost:0}),oe[re].amount+=Yo)}};Object.entries($).forEach(([re,Mt])=>{be(re,Mt,!1)});const he=_/400,Me=Math.min(he,1e9);if(Me>=1&&A){const re=Math.max(1,Math.min(_/400,1e9)),Mt=1+Math.log10(re)*1.6,fo=Math.min(100,Number.isFinite(Mt)?Mt:1),oo=Math.max(1,Math.min((l.salary||0)/400,1e9)),wo=1+Math.log10(oo)*1.2,ii=Math.min(8,Number.isFinite(wo)?wo:1);Object.keys(A).map(Number).filter(Go=>Go<=Me).sort((Go,ni)=>ni-Go).forEach(Go=>{const ni=A[Go];ni&&Object.entries(ni).forEach(([Vi,mi])=>{be(Vi,mi*fo*ii,!0)})})}const at=_,dt=ci("official"),ot=((ve=ae.official)==null?void 0:ve.headTaxBase)*dt*li;let ge=0;if(ot!==0)if(ot>0){const re=Math.min(_,ot);ge=re,_=Math.max(0,_-re),Je.transfer("official","state",re,z.EXPENSE.HEAD_TAX,z.EXPENSE.HEAD_TAX),wi.official=(wi.official||0)+re,xt.official=(xt.official||0)+re}else{const re=Math.abs(ot);(ie.silver||0)>=re&&(Je.transfer("state","official",re,z.INCOME.SUBSIDY,z.INCOME.SUBSIDY),_+=re,$i+=re,na+=re)}const Fe=_,qe=ot;let Pe=0;(gt=l.ownedProperties)!=null&&gt.length&&l.ownedProperties.forEach(re=>{const Mt=xl(re,qa,h,Na,co);Mt>0?Pe+=Mt:Mt<0&&(_=Math.max(0,_+Mt))}),Pe>0&&(_+=Pe,$i+=Pe,Je.transfer("void","official",Pe,z.INCOME.OWNER_REVENUE,z.INCOME.OWNER_REVENUE));const Ze=_,pe=(l.salary||0)+Pe,rt=vl({...l,wealth:_},G,pe),Ge=Number.isFinite(l.baseSalary)?l.baseSalary:l.salary||0,ke=Ge>0?(l.salary||0)/Ge:1;let pt="satisfied";ke<.4?pt="desperate":ke<.7?pt="struggling":ke<.95&&(pt="uncomfortable");const it=["satisfied","uncomfortable","struggling","desperate"];let Bt;if(rt==="satisfied")Bt="satisfied";else{const re=Math.max(it.indexOf(rt),it.indexOf(pt));Bt=it[re]||rt}const Ue=Cl({...l,wealth:_},g,qa,h,Y,co,te,u,C),De=Array.isArray(l.ownedProperties)?[...l.ownedProperties]:[],Se={...l.investmentProfile};if(Ue&&_>=Ue.cost){_=Math.max(0,_-Ue.cost);const re=`${Ue.buildingId}_off_${l.id}_${g}_${Math.floor(Math.random()*1e3)}`;De.push({buildingId:Ue.buildingId,instanceId:re,purchaseDay:g,purchaseCost:Ue.cost,level:0}),Se.lastInvestmentDay=g,co[Ue.buildingId]=(co[Ue.buildingId]||0)+1,Ue.buildingId&&((jt=(Jt=Le==null?void 0:Le.logVisibility)==null?void 0:Jt.showOfficialLogs)==null||jt)&&We.push(`🏗️ 官员${l.name}投资了 ${Ue.buildingId}（花费 ${Math.ceil(Ue.cost)} 银）`)}const Ee=_l({...l,wealth:_,ownedProperties:De,investmentProfile:Se},g,qa,h,Y,co,me,te);if(Ee&&_>=Ee.cost){_=Math.max(0,_-Ee.cost);const re=De[Ee.propertyIndex];re&&(re.level=Ee.toLevel,Se.lastUpgradeDay=g,Ga.push({buildingId:Ee.buildingId,fromLevel:Ee.fromLevel,toLevel:Ee.toLevel,officialName:l.name,cost:Ee.cost}))}const Tt=_,Ct=(Ue==null?void 0:Ue.cost)||0,Lt=(Ee==null?void 0:Ee.cost)||0;bn+=_,Es+=G;let Oe=(ti=l.loyalty)!=null?ti:75,$e=(hi=l.lowLoyaltyDays)!=null?hi:0;const Qe=typeof l.politicalStance=="string"?l.politicalStance:(oi=l.politicalStance)==null?void 0:oi.stanceId,Pt=l.stanceConditionParams||[],At=Object.values(po||{}).reduce((re,Mt)=>re+(Mt||0),0),uo={...ft,official:ue?(l.salary||0)+(l.lastDayPropertyIncome||0):0},st={classApproval:Eo,classInfluence:po,classIncome:uo,totalInfluence:At,stability:(L!=null?L:50)/100,rulingCoalition:U,legitimacy:J!=null?J:0,taxPolicies:h,prices:ze,epoch:u,population:i?Object.values(i).reduce((re,Mt)=>re+(Mt||0),0):0,atWar:(E||[]).some(re=>re.isAtWar)},_o=Mr(Qe,st,Pt),{DAILY_CHANGES:ct,COUP_THRESHOLD:zt,MAX:to,MIN:Rt}=On;Oe+=_o?ct.stanceSatisfied:ct.stanceUnsatisfied,Bt==="satisfied"?Oe+=ct.financialSatisfied:Bt==="uncomfortable"?Oe+=ct.financialUncomfortable:Bt==="struggling"?Oe+=ct.financialStruggling:Bt==="desperate"&&(Oe+=ct.financialDesperate);const St=(L!=null?L:50)/100;return St>.7?Oe+=ct.stabilityHigh:St<.3&&(Oe+=ct.stabilityLow),Oe+=ue?ct.salaryPaid:ct.salaryUnpaid,Oe=Math.max(Rt,Math.min(to,Oe)),Oe<zt?$e+=1:$e=0,{...l,wealth:Math.min(b,Number.isFinite(_)?Math.max(0,_):400),lastDayExpense:G,financialSatisfaction:Bt,ownedProperties:De,investmentProfile:Se,lastDayPropertyIncome:Pe,lastDayExpenseBreakdown:oe,lastDayLuxuryExpense:q,lastDayEssentialExpense:X,loyalty:Oe,lowLoyaltyDays:$e,isStanceSatisfied:_o,_debug:{initialWealth:I,salaryPaid:ue,salaryAmount:l.salary||0,wealthAfterSalary:I+(ue&&l.salary||0),dailyExpense:G,wealthAfterGoods:at,headTaxPlanned:qe,headTaxPaid:ge,wealthAfterTax:Fe,propertyIncome:Pe,wealthAfterProperty:Ze,investmentCost:Ct,upgradeCost:Lt,wealthAfterInvestment:Tt,wealthFinal:_}}});je.official=bn,xt.official=(xt.official||0)+Es,vi.official=xt.official,$o.official=na;const aa=M0({popStructure:{...Z,official:0},wealth:je,classIncome:ft,classExpense:xt,classShortages:Co,epoch:u,techsUnlocked:C,priceMap:so,livingStandardStreaks:ce}),Cs=Ci.length;if(Cs>0){const n=bn/Cs;let l="赤贫",b=30;n>300?(l="奢华",b=95):n>100?(l="富裕",b=85):n>50?(l="小康",b=75):n>20?(l="温饱",b=60):(l="贫困",b=45);const x=n/400,_={奢华:{icon:"Crown",color:"text-purple-400"},富裕:{icon:"Gem",color:"text-blue-400"},小康:{icon:"Home",color:"text-green-400"},温饱:{icon:"UtensilsCrossed",color:"text-yellow-400"},贫困:{icon:"AlertTriangle",color:"text-orange-400"},赤贫:{icon:"Skull",color:"text-red-500"}},I=_[l]||_.赤贫;aa.classLivingStandard.official={level:l,satisfaction:1,satisfactionRate:1,approvalCap:b,needsMet:1,wealthRatio:x,wealthPerCapita:n,wealthMultiplier:Math.min(6,1+Math.log(Math.max(1,n/100))*.5),icon:I.icon,color:I.color,bgColor:I.color.replace("text-","bg-").replace("-400","-900/20"),borderColor:I.color.replace("text-","border-").replace("-400","-500/30"),score:n>300?90:n>100?75:n>50?60:n>20?45:25};const $=ce.official||{},A=$.level===l;aa.livingStandardStreaks.official={level:l,streak:A?($.streak||0)+1:1}}const Gi=aa.classLivingStandard,_s=aa.livingStandardStreaks,Ts={};Object.keys(ae).forEach(n=>{var ct,zt,to,Rt,St,Lo,To;const l=Z[n]||0;if(l===0)return;const b=Ei[n],x=(ct=b==null?void 0:b.satisfactionRatio)!=null?ct:1,_=Gi[n];let I=(zt=_==null?void 0:_.approvalCap)!=null?zt:100;const $=W0(n,U);if($){const ve=(_==null?void 0:_.level)||"温饱",gt=O0(ve);I=Math.max(0,I-gt)}let A=70;const G=_==null?void 0:_.level;G==="奢华"?A=95:G==="富裕"?A=85:G==="小康"&&(A=75),$&&O.coalitionApproval&&(A+=O.coalitionApproval);const q=ci(n);(Rt=(to=ae[n])==null?void 0:to.headTaxBase)!=null;const X=Math.max(0,(wi[n]||0)/Math.max(1,l)),oe=(ft[n]||0)/Math.max(1,l),be=(je[n]||0)/Math.max(1,l),he=oe>.001&&X>oe*.5,Me=be>X*100;he&&!Me?A=Math.min(A,40):q<.6&&(A+=5);const at=(wi[n]||0)/Math.max(1,l),dt=(gs[n]||0)/Math.max(1,l),Xe=dt>.01?at/dt:0,ot=.05,ge=.2,Fe=1;let qe=0;Xe>ot&&at>0&&(Xe<=ge?qe=(Xe-ot)/(ge-ot)*25:qe=25+Math.min(25,(Xe-ge)/(Fe-ge)*25));const Pe=Ke[n]||0,rt=Math.max(0,Pe*(1-.03)+qe*.5);Ts[n]=rt;const Ge=Math.max(qe,rt),ke=Co[n]||[],pt=ke.filter(ve=>ve.isBasic),it=ke.filter(ve=>!ve.isBasic),Bt=(St=b==null?void 0:b.totalTrackedNeeds)!=null?St:0;if(pt.length>0&&Bt>0&&(pt.length>=Object.keys(((Lo=ae[n])==null?void 0:Lo.needs)||{}).length?A=Math.min(A,0):A=Math.min(A,30)),it.length>0){const ve=Math.min(15,it.length*3);A-=ve}const Ue=_s[n]||{};if(Ue.level==="赤贫"||Ue.level==="贫困"){const ve=Ue.level==="赤贫"?2.5:1.5,gt=Math.min(30,Math.ceil((Ue.streak||0)*ve));gt>0&&(A-=gt)}let De=0;const Se=(D||{})[n];if(Se&&Se.length>0){let Jt=0;for(let jt=Se.length-1;jt>=0&&Jt<20&&Se[jt]>=.95;jt--)Jt+=1;Jt>=3&&(De=Math.min(15,Jt*.6),A=Math.min(100,A+De))}let Ee=0,Tt=0;const Ct=(k||{})[n];if(Ct&&Ct.length>=20){const ve=Ct.slice(-10).reduce((Jt,jt)=>Jt+jt,0)/10,gt=Ct.slice(-20,-10).reduce((Jt,jt)=>Jt+jt,0)/10;gt>1&&(Ee=(ve-gt)/gt,Tt=Math.min(15,Math.abs(Ee)*50),Ee>.05?A+=Tt:Ee<-.05&&(A-=Tt))}if(x>=.98&&(A=Math.min(100,A+10)),n==="unemployed"){const gt=2+l/Math.max(1,o)*30;A-=gt}if(Et[n]={baseTarget:0,livingStandardBase:0,taxReliefBonus:0,luxuryShortagePenalty:0,povertyPenalty:0,sustainedNeedsBonus:0,wealthTrendBonus:0,positiveSatisfactionBonus:0,unemployedPenalty:0,eventBonus:0,decreeBonus:0,officialTargetBonus:0,legitimacyPenalty:0,taxShockPenalty:0,shockCapApplied:null,currentApprovalStart:0,targetApprovalPreShockCap:0,targetApprovalFinal:0,adjustmentSpeed:.02,inertiaDelta:0,effectiveApprovalCap:I,capApplied:null,approvalAfterCap:0,approvalFinal:0},Et[n].baseTarget=70,Et[n].livingStandardBase=A-70,q<.6&&(Et[n].taxReliefBonus=5),((it==null?void 0:it.length)||0)>0&&(Et[n].luxuryShortagePenalty=-Math.min(15,it.length*3)),(Ue==null?void 0:Ue.level)==="赤贫"||(Ue==null?void 0:Ue.level)==="贫困"){const ve=Ue.level==="赤贫"?2.5:1.5,gt=Math.min(30,Math.ceil((Ue.streak||0)*ve));Et[n].povertyPenalty=-gt}if(De&&(Et[n].sustainedNeedsBonus=De),Tt&&Ee&&Math.abs(Ee)>.05&&(Et[n].wealthTrendBonus=Ee>0?Tt:-Tt),x>=.98&&(Et[n].positiveSatisfactionBonus=10),n==="unemployed"){const gt=2+l/Math.max(1,o)*30;Et[n].unemployedPenalty=-gt}const Lt=(V==null?void 0:V[n])||0;Lt&&(A+=Lt,Et[n].eventBonus=Lt);const Oe=ff[n]||0;Oe&&(A+=Oe,Et[n].decreeBonus=Oe);const $e=((To=ut==null?void 0:ut.approval)==null?void 0:To[n])||0;$e>0&&(A+=$e,Et[n].officialTargetBonus=$e);const Qe=D0(J);Qe<0&&(A+=Qe,Et[n].legitimacyPenalty=Qe);let Pt=I;$e<0&&(Pt=Math.max(0,I+$e)),Et[n].effectiveApprovalCap=Pt;let At=Eo[n]||50;if(Et[n].currentApprovalStart=At,Et[n].adjustmentSpeed=.02,Ge>1&&(At=Math.max(0,At-Ge),Et[n].taxShockPenalty=-Ge,Ge>5)){const ve=Math.max(0,70-Ge*2);Et[n].shockCapApplied=ve,A=Math.min(A,ve)}Et[n].targetApprovalPreShockCap=A,Et[n].targetApprovalFinal=A;let st=At+(A-At)*.02;Et[n].inertiaDelta=st-At;const _o=st;st=Math.min(st,Pt),st!==_o&&(Et[n].capApplied=Pt),Et[n].approvalAfterCap=st,Et[n].approvalFinal=Math.max(0,Math.min(100,st)),Eo[n]=Math.max(0,Math.min(100,st))}),(Z.unemployed||0)===0&&p.unemployed!==void 0&&(Eo.unemployed=Math.min(100,p.unemployed+5));let lo=o,ra=0;Object.keys(ae).forEach(n=>{const l=je[n]||0,b=Z[n]||0;if(l>0&&b>0){const x=Gi[n],_=x==null?void 0:x.level;if(_==="赤贫"||_==="贫困"||_==="温饱")return;const I=l/b;if(I/Cr<1.2&&_!=="奢华")return;let A=.005;_==="小康"?A=.001:_==="富裕"&&(A=.003);const q=I*A*b;let X=parseFloat(q.toFixed(2)),oe=0;bt[n]&&bt[n].expense&&bt[n].expense.luxuryNeeds&&Object.values(bt[n].expense.luxuryNeeds).forEach(he=>{oe+=he.cost||0});const be=parseFloat((oe*.5).toFixed(2));X=Math.min(X,be),X>0&&(Je.transfer(n,"void",X,z.EXPENSE.DECAY,z.EXPENSE.DECAY),xt[n]=(xt[n]||0)+X)}}),Object.keys(ae).forEach(n=>{ho[n]=Qi(je[n]||0)});let ui=Object.values(ho).reduce((n,l)=>n+l,0);Object.keys(ae).forEach(n=>{const l=Z[n]||0;if(l===0)return;const b=ae[n],x=ho[n]||0,_=ui>0?x/ui:0;po[n]=b.influenceBase*l+_*10});const pf=Object.values(po).reduce((n,l)=>n+l,0),hf=Sl(le||[],ue,{classInfluence:po,totalInfluence:pf,polityEffects:Xn,currentDay:g});Object.entries(hf).forEach(([n,l])=>{po[n]!==void 0&&l>0&&(po[n]+=l)});let fi=Object.values(po).reduce((n,l)=>n+l,0);const mf=S0(U,po,fi);hn=I0(mf),O.legitimacyBonus&&(hn=Math.max(0,Math.min(100,hn*(1+O.legitimacyBonus)))),ja=Br(hn);let Va=0;O.factionConflict&&(Va+=O.factionConflict),Object.keys(ae).forEach(n=>{var I;const l=Z[n]||0;if(l===0)return;const b=Eo[n]||50;if(b>=25)return;const x=fi>0?(po[n]||0)/fi:0,_=((I=ae[n])==null?void 0:I.name)||n;if(b<20&&x<.07){const $=Math.max(.03,(20-b)/200),A=Math.min(l,Math.max(1,Math.floor(l*$)));if(A>0){const X=je[n]||0,be=(l>0?X/l:0)*A;be>0&&Je.transfer(n,"void",be,z.EXPENSE.CAPITAL_FLIGHT,z.EXPENSE.CAPITAL_FLIGHT),Z[n]=Math.max(0,l-A)}const G=(Co[n]||[]).map(X=>{var Me;const oe=typeof X=="string"?X:X.resource,be=typeof X=="string"?"outOfStock":X.reason,he=((Me=Be[oe])==null?void 0:Me.name)||oe;return be==="unaffordable"?`${he}(买不起)`:be==="outOfStock"?`${he}(缺货)`:be==="both"?`${he}(缺货且买不起)`:he}).join("、"),q=G?`，短缺资源：${G}`:"";We.push(`${_} 阶层对政局失望，${A} 人离开了国家，带走了 ${(A*(je[n]||0)/Math.max(1,l)).toFixed(1)} 银币${q}。`)}else if(x>=.12){const $=Math.min(.2,.05+x*.15);Va+=$;const A=(Co[n]||[]).map(q=>{var he;const X=typeof q=="string"?q:q.resource,oe=typeof q=="string"?"outOfStock":q.reason,be=((he=Be[X])==null?void 0:he.name)||X;return oe==="unaffordable"?`${be}(买不起)`:oe==="outOfStock"?`${be}(缺货)`:oe==="both"?`${be}(缺货且买不起)`:be}).join("、"),G=A?`（短缺：${A}）`:"";We.push(`${_} 阶层的愤怒正在削弱社会稳定${G}。`)}});const Ha=[],Ya=[];Object.keys(ae).forEach(n=>{var G,q;const l=ae[n];if(!l.buffs||(Z[n]||0)===0)return;const b=Eo[n]||50,x=((q=(G=Ei[n])==null?void 0:G.satisfactionRatio)!=null?q:1)>=.9,_=fi>0?(po[n]||0)/fi:0,I=_>.8?2:_>.5?1.5:1,$=b>=85&&_>=.3,A=b>=85&&x;if(($||A)&&l.buffs.satisfied){const X=Ca(l.buffs.satisfied,I);Ha.push({class:n,...X})}else if(b<40&&l.buffs.dissatisfied&&_>=.3){const X=Ca(l.buffs.dissatisfied,I);Ya.push({class:n,...X})}});const{stabilityValue:Ps,efficiency:sa}=al({popStructure:Z,classApproval:Eo,classInfluence:po,totalInfluence:fi,newActiveBuffs:Ha,newActiveDebuffs:Ya,eventStabilityModifier:N,extraStabilityPenalty:Va,currentStability:L,stabilityBonus:O.stabilityBonus||0}),Ho=u;let di=0;const Xa=Math.max(5,o||5),Mn=Math.max(100,(Hs=(Vs=ie.silver)!=null?Vs:e==null?void 0:e.silver)!=null?Hs:0);let ca=-1/0;const gf=Ln(g,"priceUpdate"),la=Ln(g,"tradeUpdate"),Oo=Ln(g,"diplomacyUpdate"),ua=Ln(g,"aiDecision");(E||[]).forEach(n=>{n.lastPeaceRequestDay&&n.lastPeaceRequestDay>ca&&(ca=n.lastPeaceRequestDay)});let Wt=v!=null&&v.organizations?[...v.organizations]:[],_i=!1,mt=(E||[]).map(n=>{var A,G,q,X,oe,be,he,Me,at,dt,Xe,ot;const l={...n};if(l.alliedWithPlayer=Wt.some(ge=>ge.type==="military_alliance"&&ge.members.includes(n.id)&&ge.members.includes("player")),Ye!=null&&Ye.nationDelta&&Ye.nationDelta[n.id]){const ge=Ye.nationDelta[n.id];l.budget=Math.max(0,(l.budget||0)+(ge.budget||0)),l.relation=Math.min(100,Math.max(-100,(l.relation||0)+(ge.relation||0))),ge.inventory&&(l.inventory=l.inventory||{},Object.entries(ge.inventory).forEach(([Fe,qe])=>{l.inventory[Fe]=Math.max(0,(l.inventory[Fe]||0)+qe)}))}if(!(Ho>=((A=n.appearEpoch)!=null?A:0)&&(n.expireEpoch==null||Ho<=n.expireEpoch)))return l.isAtWar&&(l.isAtWar=!1,l.warScore=0,l.warDuration=0,l.warStartDay=null,l.enemyLosses=0,l.warTarget=null,l.isPeaceRequesting=!1,l.peaceTribute=null),l;if(l.epoch===void 0&&((G=l.foreignPower)!=null&&G.initializedAtTick?l.epoch=Ho:l.epoch=(q=l.appearEpoch)!=null?q:0),Lu({nation:l,tick:g,resources:ie,logs:We,onTreasuryChange:Vt}),l.isRebelNation){if(fu(l),l.isAtWar){const ge=Dl({nation:l,tick:g,epoch:u,resources:ie,population:o,army:y,logs:We,onTreasuryChange:Vt,onResourceChange:ht});ra+=ge.raidPopulationLoss}return Wl({nation:l,tick:g,logs:We}),l}l.foreignPower={...l.foreignPower||{}};const x=l.foreignPower,_=l.wealthTemplate||l.wealth||800;x.baseRating==null&&(x.baseRating=Math.max(.4,_/800));const I=Math.min(.9,Math.max(.1,(oe=(X=x.volatility)!=null?X:l.marketVolatility)!=null?oe:.3));if(x.volatility=I,x.appearEpoch==null&&(x.appearEpoch=(be=l.appearEpoch)!=null?be:0),x.populationFactor==null){const ge=(he=l.culturalTraits)!=null&&he.agriculturalFocus?1.15:1;x.populationFactor=$t(x.baseRating*ge,.6,2.5)}if(x.wealthFactor==null){const ge=1+Math.max(0,x.appearEpoch)*.05;x.wealthFactor=$t(x.baseRating*ge,.5,3.5)}if(!x.initializedAtTick){const Fe=1+Math.max(0,Ho-((Me=x.appearEpoch)!=null?Me:0))*.08,qe=.9+Math.random()*.25,Pe=$t(x.populationFactor*Fe*qe,.6,2.5),Ze=$t(x.wealthFactor*Fe*qe,.5,3.5),pe=Math.max(3,Math.round(Xa*Pe)),rt=Math.max(100,Math.round(Mn*Ze));l.population=pe,l.wealth=rt,l.budget=Math.max(50,rt*.5),l.economyTraits={...l.economyTraits||{},basePopulation:pe,baseWealth:rt},x.populationFactor=Pe,x.wealthFactor=Ze,x.initializedAtTick=g,x.playerSnapshot={population:Xa,wealth:Mn},l.wealthTemplate||(l.wealthTemplate=rt)}if(la&&su({nation:l,tick:g,gameSpeed:s}),l.isAtWar){l.warDuration=(l.warDuration||0)+1;const ge=(E||[]).filter(qe=>qe.isAtWar).length||1,Fe=((ea==null?void 0:ea.dailyExpense)||0)/ge;if(l.warTotalExpense=(l.warTotalExpense||0)+Fe,Ho>=1&&ua){const qe=Ol({nation:l,tick:g,epoch:u,resources:ie,army:y,logs:We,difficultyLevel:te,onTreasuryChange:Vt,onResourceChange:ht});ra+=qe.raidPopulationLoss}ua&&(Bl({nation:l,tick:g,lastGlobalPeaceRequest:ca,logs:We})&&(ca=g),jl({nation:l,tick:g,population:o,playerWealth:Mn,logs:We}),Nl({nation:l,tick:g,population:o,playerWealth:Mn,resources:ie,logs:We}))}else l.warDuration&&(l.warDuration=0,l.warTotalExpense=0);(at=l.relation)!=null,Oo&&au(l,te);const $=Ir(te);if(O.diplomaticIncident&&!l.isRebelNation&&!l.isAtWar){const ge=O.diplomaticIncident/30*$.bad;l.relation=Math.min(100,Math.max(0,((dt=l.relation)!=null?dt:50)-ge))}if(O.diplomaticBonus&&!l.isRebelNation&&!l.isAtWar){const ge=O.diplomaticBonus/30*$.good;l.relation=Math.min(100,Math.max(0,((Xe=l.relation)!=null?Xe:50)+ge))}if(Oo){const ge=nu(l,We,{organizations:Wt});ge&&ge.memberLeaveRequests&&ge.memberLeaveRequests.forEach(Fe=>{const qe=Wt.findIndex(Pe=>Pe.id===Fe.orgId);if(qe>=0){const Pe=Wt[qe];Wt[qe]={...Pe,members:Pe.members.filter(Ze=>Ze!==Fe.nationId)},_i=!0}})}return(ot=l.aggression)!=null,ua&&Ll({nation:l,nations:E,tick:g,epoch:Ho,resources:ie,stabilityValue:Ps,logs:We,difficultyLevel:te,diplomacyOrganizations:{organizations:Wt}}),di+=pu({nation:l,resources:ie,logs:We,onTreasuryChange:Vt}),du(l),la&&(cu({nation:l,tick:g}),lu({nation:l,tick:g}),hu(l,We),uu({nation:l,epoch:l.epoch,playerPopulationBaseline:Xa,playerWealthBaseline:Mn,tick:g})),l});mt=Vl(mt);const za=g%30===0;za&&Oo&&(mt=Hl(mt,te));let qi=null;if(za&&Oo&&((Ys=v==null?void 0:v.organizations)==null?void 0:Ys.length)>0){if(qi=Gl({organizations:v.organizations,nations:mt,playerWealth:ie.silver||0,daysElapsed:g}),qi.fees.player>0){const n=Math.min(ie.silver||0,qi.fees.player);n>0&&_e(-n,"organization_membership_fee")}if(qi.fees.ai)for(const[n,l]of Object.entries(qi.fees.ai)){const b=mt.find(x=>x.id===n);b&&(b.wealth=Math.max(0,(b.wealth||0)-l))}qi.logs.forEach(n=>We.push(n))}let pi=null;if(za&&Oo&&(pi=yu({nations:mt,epoch:u,playerPopulation:lo,playerResources:ie,classApproval:p,daysElapsed:g,maxPop:Uo}),pi.immigrantsIn>0||pi.emigrantsOut>0)){const n=pi.immigrantsIn-pi.emigrantsOut;lo=Math.max(10,lo+n),Object.keys(pi.byStratum).length>0&&(Z=bu(Z,pi.byStratum)),Mu(pi.events).forEach(b=>We.push(b))}let Ti=null;if(Oo){if(Ti=Pu(mt,{daysElapsed:g}),Ti&&Ti.updates)for(const n of Ti.updates){const l=mt.findIndex(b=>b.id===n.id);l>=0&&(mt[l]={...mt[l],...n})}if(Ti&&Ti.events)for(const n of Ti.events)n.type==="civil_war_started"?We.push(`⚔️ ${n.nationName} 爆发内战！反对派势力与政府军交战中...`):n.type==="civil_war_ended"&&(n.winner==="rebels"?We.push(`🏴 ${n.nationName} 的叛军取得胜利，政权更迭为${n.newGovernment||"新政府"}！`):We.push(`🏛️ ${n.nationName} 的政府军平定叛乱，恢复秩序。`))}const Bo=mt.filter(n=>{var l;return u>=((l=n.appearEpoch)!=null?l:0)&&(n.expireEpoch==null||u<=n.expireEpoch)&&!n.isRebelNation&&!n.isAnnexed});let Pi=null;if(Oo&&(c!=null&&c.prices)){if(Pi=T0(c.prices,mt,g),Pi.marketPrices&&(c={...c,prices:Pi.marketPrices}),Pi.nationPriceUpdates)for(const n of Pi.nationPriceUpdates){const l=mt.findIndex(b=>b.id===n.nationId);l>=0&&(mt[l]={...mt[l],nationPrices:n.nationPrices})}Pi.logs&&Pi.logs.forEach(n=>We.push(n))}if(Oo&&Yl(Bo,g,We,te),Oo&&Xl(Bo,We),la&&Jl(Bo,We,v),la&&Zl(Bo,g,ie,c,We,Ht,v,Vt),Oo&&Ql(Bo,g,u,We),Oo&&iu(Bo,g,We,{organizations:Wt},Ho),Oo){const n=eu(Bo,g,We,{organizations:Wt},Ho),l=tu(Bo,g,We,{organizations:Wt},Ho);n&&n.createdOrganizations.length>0&&(Wt.push(...n.createdOrganizations),_i=!0);const b=[...(n==null?void 0:n.memberJoinRequests)||[],...(l==null?void 0:l.memberJoinRequests)||[]];b.length>0&&b.forEach(I=>{const $=Wt.findIndex(A=>A.id===I.orgId);if($>=0){const A=Wt[$],G=Ni[A.type],q=(G==null?void 0:G.maxMembers)||1/0;!A.members.includes(I.nationId)&&A.members.length<q&&(Wt[$]={...A,members:[...A.members,I.nationId]},_i=!0)}});const x=ou(Bo,g,We,{organizations:Wt},Ho);(Xs=x==null?void 0:x.memberLeaveRequests)!=null&&Xs.length&&x.memberLeaveRequests.forEach(I=>{const $=Wt.findIndex(A=>A.id===I.orgId);if($>=0){const A=Wt[$];A.members.includes(I.nationId)&&(Wt[$]={...A,members:A.members.filter(G=>G!==I.nationId)},_i=!0)}});const _=[];Wt.forEach(I=>{var A;const $=((A=I==null?void 0:I.members)==null?void 0:A.includes("player"))&&I.members.length===1;if(ql(I)&&!$){We.push(`🏛️ "${I.name}" 因成员不足而解散。`),_i=!0;return}_.push(I)}),Wt=_}ua&&(Fl(Bo,g,We,{organizations:Wt}),Ul(Bo,mt,g,We,{organizations:Wt}),$l(Bo,mt,g,We));let vn=0,wn=Math.max(0,r||0),Ai=Math.max(0,Uo-lo);if(Ai>0){const n=y0(te);Math.random()<.01&&console.log(`[DEBUG] PopGrowth: diff=${te}, mult=${n}`);const l=Math.max(0,o||0)*Xc*n;if(wn+=l,o<Nn){const x=Math.max(0,(Nn-o)/Nn);wn+=zc*x*n}const b=Math.min(Ai,Math.floor(wn));b>0&&(vn+=b,wn-=b,Ai-=b)}if(Ai>0&&Object.keys(ae).forEach(n=>{var be;if(Ai<=0)return;const l=Z[n]||0;if(l<=0)return;const b=(be=Eo[n])!=null?be:50,x=Math.max(0,(b-25)/75);if(x<=0)return;const _=ho[n]||0,I=l>0?_/l:0,$=Math.max(.3,Math.min(2,I/Cr)),A=Yc*x*$*(1+(O.populationGrowthBonus||0));if(A<=0)return;let G=l*A;if(G<=0)return;const q=Math.floor(G);let X=q;const oe=G-q;Math.random()<oe&&(X+=1),!(X<=0)&&(X=Math.min(X,Ai),!(X<=0)&&(vn+=X,Ai-=X))}),vn>0&&(Z.unemployed=(Z.unemployed||0)+vn,lo=Math.min(Uo,lo+vn)),(ie.food||0)<=0&&(ie.food=0,Math.random()>.9&&lo>2)){if(lo=lo-1,(Z.unemployed||0)>0)Z.unemployed=Z.unemployed-1;else{const n=Xt.filter(l=>(Z[l]||0)>0);if(n.length>0){const l=n[Math.floor(Math.random()*n.length)];Z[l]=Math.max(0,(Z[l]||0)-1)}}We.push("饥荒导致人口减少！")}if(Object.keys(ae).forEach(n=>{if(n==="official")return;const l=Z[n]||0;if(l===0)return;const b=ae[n];if(!b||!b.needs)return;const x=Co[n]||[],_=x.some(A=>(typeof A=="string"?A:A.resource)==="food"),I=x.some(A=>(typeof A=="string"?A:A.resource)==="cloth"),$=(D||{})[n];if($&&$.length>=5){const A=$.slice(-5),G=A.reduce((q,X)=>q+X,0)/A.length;if((_||I)&&G<.85){const q=b.name||n;let X=0;G<.5?X=.02+(.5-G)/.5*.08:X=.005+(.85-G)/.35*.015;const oe=Math.max(1,Math.floor(l*X));oe>0&&(Z[n]=Math.max(0,l-oe),xi(`${q} 阶层因长期缺乏${_&&I?"食物和布料":_?"食物":"布料"}，${oe} 人死亡！`))}}}),Xt.reduce((n,l)=>n+(Z[l]||0),0)+(Z.unemployed||0),ra>0){let n=ra;if((Z.unemployed||0)>=n)Z.unemployed=Z.unemployed-n;else{const l=Z.unemployed||0;Z.unemployed=0,n-=l;const b=Xt.reduce((x,_)=>x+(Z[_]||0),0);b>0&&n>0&&Xt.forEach(x=>{if(n<=0)return;const _=Z[x]||0;if(_<=0)return;const I=_/b,$=Math.min(_,Math.max(1,Math.floor(I*n)));Z[x]=_-$,n-=$})}}lo=Xt.reduce((n,l)=>n+(Z[l]||0),0)+(Z.unemployed||0),lo=Math.max(0,Math.floor(lo)),Object.keys(ie).forEach(n=>{ie[n]<0&&(ie[n]=0)});let xn={...ze},vo={...(c==null?void 0:c.wages)||{}};const yf=.35;if(gf){vo={},Object.entries(Qo).forEach(([A,G])=>{let q=0;const X=Z[A]||0;if(X>0){const he=$o[A]||0,Me=vi[A]||0;let at=he,dt=Me;he===0&&Qo[A].totalSlots===0?q=bi[A]||0:q=(at-dt)/X}else G.weightedWage>0&&G.totalSlots>0?q=G.weightedWage/G.totalSlots:q=bi[A]||0;q=Math.max(0,q);const oe=bi[A]||0,be=oe+(q-oe)*yf;vo[A]=parseFloat(be.toFixed(2))});const n=Math.max(0,(zs=lo!=null?lo:o)!=null?zs:0),l=(Ut==null?void 0:Ut.market)||{},b=Math.max(0,(Js=l.supplyDemandWeight)!=null?Js:1),x=Math.max(0,l.virtualDemandPerPop||0),_=p0(te),I=Math.max(.1,((Zs=l.inventoryTargetDays)!=null?Zs:1.5)*_),$=Math.max(0,(Qs=l.inventoryPriceImpact)!=null?Qs:.25);Object.keys(Be).forEach(A=>{var Bt,Ue;if(!Qt(A))return;const G=Be[A],q=(G==null?void 0:G.marketConfig)||{};q.supplyDemandWeight!==void 0&&Math.max(0,q.supplyDemandWeight);const X=q.virtualDemandPerPop!==void 0?Math.max(0,q.virtualDemandPerPop):x,oe=q.inventoryTargetDays!==void 0?Math.max(.1,q.inventoryTargetDays*_):I;q.inventoryPriceImpact!==void 0&&Math.max(0,q.inventoryPriceImpact),Do[A];const be=bo[A]||0,he=X*n,at=be+he,dt=ie[A]||0,Xe=dt<=0?.01:at>0?dt/at:oe,ot=[];let ge=0;Yt.forEach(De=>{const Se=co[De.id]||0;if(Se<=0)return;const Ee=me[De.id]||{};let Tt=0;Object.entries(Ee).forEach(([Lt,Oe])=>{const $e=parseInt(Lt);Number.isFinite($e)&&$e>0&&Oe>0&&(Tt+=Oe)});const Ct={0:Math.max(0,Se-Tt)};Object.entries(Ee).forEach(([Lt,Oe])=>{const $e=parseInt(Lt);Number.isFinite($e)&&$e>0&&Oe>0&&(Ct[$e]=Oe)}),Object.entries(Ct).forEach(([Lt,Oe])=>{var ti,hi,oi,re,Mt;const $e=parseInt(Lt),Qe=Nt(De,$e),Pt=(ti=Qe.output)==null?void 0:ti[A];if(!Pt||Pt<=0)return;const At=De.marketConfig||{},uo=At.price||(Ut==null?void 0:Ut.price)||{},st=At.wage||(Ut==null?void 0:Ut.wage)||{};Fn(Vn,uo);const _o=Fn(Vn,st);Qe.input&&Object.entries(Qe.input).forEach(([fo,oo])=>{!oo||oo<=0||(ze[fo]||Io(fo),Li(fo))});const ct=De.owner,zt=Qe.jobs||{},to=ct&&zt[ct];Object.keys(zt).length>0&&!to&&Object.entries(zt).forEach(([fo,oo])=>{!oo||oo<=0||vo[fo]||yo(fo)}),(oi=(hi=Ht==null?void 0:Ht.businessTaxRates)==null?void 0:hi[De.id])!=null,(re=De.businessTaxBase)!=null,ct&&(_o[ct]||0)*(zt[ct]||0);const Rt=Xe/oe;let St=1;Rt<.5?St=1+(1-Rt*2)*5:Rt<1?St=1+(1-Rt)*1:Rt>2?(St=.7-(Rt-2)*.3,St=Math.max(.1,St)):Rt>1&&(St=1-(Rt-1)*.3);let ve=Io(A)*St;const gt=(Mt=G.minPrice)!=null?Mt:Bi,Jt=G.maxPrice;ve=Math.max(ve,gt),Jt!==void 0&&(ve=Math.min(ve,Jt));const jt=Pt*Oe;ge+=jt,ot.push({price:ve,output:jt})})});let Fe=0;if(ge>0&&ot.length>0){let De=0;ot.forEach(Se=>{De+=Se.price*Se.output}),Fe=De/ge}else{const De=Io(A),Se=Xe/oe;let Ee=1;Se<.5?Ee=1+(1-Se*2)*5:Se<1?Ee=1+(1-Se)*1:Se>2?(Ee=.7-(Se-2)*.3,Ee=Math.max(.1,Ee)):Se>1&&(Ee=1-(Se-1)*.3),Fe=De*Ee;const Tt=(Bt=G.minPrice)!=null?Bt:Bi,Ct=G.maxPrice;Fe=Math.max(Fe,Tt),Ct!==void 0&&(Fe=Math.min(Fe,Ct))}let qe=0;mt.forEach(De=>{De.isAtWar===!0&&qe++});let Pe=0;mt.forEach(De=>{!De.isPlayer&&De.foreignWars&&Object.values(De.foreignWars).forEach(Se=>{Se!=null&&Se.isAtWar&&Pe++})}),Pe=Math.floor(Pe/2);const Ze=1+qe*.025+Pe*.01,pe=Fe*Ze,rt=ze[A]||pe,Ge=rt+(pe-rt)*.1,ke=(Ue=G.minPrice)!=null?Ue:Bi,pt=G.maxPrice;let it=Ge;it=Math.max(it,ke),pt!==void 0&&(it=Math.min(it,pt)),xn[A]=parseFloat(it.toFixed(2))})}const bf=n=>{const l=(k||{})[n];if(!l||l.length<2)return null;const b=l[l.length-1],x=l[l.length-2],_=Math.max(1,(i==null?void 0:i[n])||0);return(b-x)/_},Mf=n=>{const l=Jn[n];return!l||l.length===0?!1:l.some(b=>b&&b.availableSlots>0)},vf=(n,l)=>{const b=Jn[n];if(!b||b.length===0||l<=0)return null;let x=-1,_=0;for(let G=0;G<b.length;G++){const q=b[G];if(!q)continue;const X=q.availableSlots>=1?Math.floor(q.availableSlots):q.availableSlots>0?1:0;X>_&&(_=X,x=G)}if(x===-1||_<=0)return null;const I=b[x],$=Math.min(l,_),A={buildingId:I.buildingId,buildingName:I.buildingName,count:$};return I.availableSlots-=$,I.availableSlots<=0&&b.splice(x,1),A},As=(n=[])=>Array.isArray(n)?n.reduce((l,b)=>l+Math.max(0,(b==null?void 0:b.capitalLocked)||0),0):0,wf=Math.max(0,(Ks=P==null?void 0:P.lockedCapital)!=null?Ks:As((P==null?void 0:P.pendingTrades)||[])),xf=ho.merchant||0;tn("simulation","[SIMULATION DEBUG] Calling simulateMerchantTrade, policies:",{hasExportTariff:!!Ht.exportTariffMultipliers,hasImportTariff:!!Ht.importTariffMultipliers,merchantPop:(Z==null?void 0:Z.merchant)||0});const jo=Z0({ledger:Je,res:ie,wealth:je,popStructure:Z,supply:Do,demand:bo,nations:mt,tick:g,taxPolicies:Ht,taxBreakdown:Gt,getLocalPrice:so,roleExpense:xt,roleWagePayout:ft,pendingTrades:P.pendingTrades||[],lastTradeTime:P.lastTradeTime||0,gameSpeed:s,classFinancialData:bt,logs:We,potentialResources:dn,merchantAssignments:P.merchantAssignments||P.assignments||null,merchantTradePreferences:P.merchantTradePreferences||null,shouldLogMerchantTrades:(tc=(ec=Le==null?void 0:Le.logVisibility)==null?void 0:ec.showMerchantTradeLogs)!=null?tc:!0,shouldLogOfficialEvents:(ic=(oc=Le==null?void 0:Le.logVisibility)==null?void 0:oc.showOfficialLogs)!=null?ic:!0,onTreasuryChange:_e}),Rs=Math.max(0,(nc=jo.lockedCapital)!=null?nc:As(jo.pendingTrades));jo.lockedCapital=Rs;const Ef=jo.capitalInvestedThisTick||0;"capitalInvestedThisTick"in jo&&delete jo.capitalInvestedThisTick;const Ss=jo.completedTrades||[];if(Ss.length>0){const n={export:{},import:{}},l={};let b=0;Ss.forEach(_=>{var G;const I=_.resource;n[_.type][I]||(n[_.type][I]={amount:0,profit:0}),n[_.type][I].amount+=_.amount,n[_.type][I].profit+=_.profit,b+=_.profit;const $=_.partnerId||"unknown";if(!l[$]){const q=mt.find(X=>(X==null?void 0:X.id)===$);l[$]={name:(q==null?void 0:q.name)||$,exports:[],imports:[]}}const A=((G=Be[I])==null?void 0:G.name)||I;_.type==="export"?l[$].exports.push(`${A}x${_.amount.toFixed(1)}`):l[$].imports.push(`${A}x${_.amount.toFixed(1)}`)});const x=[];if(Object.values(l).forEach(_=>{const I=[];_.exports.length>0&&I.push(`出口${_.exports.join(",")}`),_.imports.length>0&&I.push(`进口${_.imports.join(",")}`),I.length>0&&x.push(`${_.name}(${I.join(", ")})`)}),x.length>0&&jo.shouldLogMerchantTrades){const _=b>=0?`盈利${b.toFixed(1)}`:`亏损${Math.abs(b).toFixed(1)}`;We.push(`📦 商人贸易完成: ${x.join("; ")}，${_}银币`)}if(O.tradeBonusMod&&b>0){const _=b*O.tradeBonusMod;je.merchant=(je.merchant||0)+_,bt!=null&&bt.merchant&&(bt.merchant.income.ownerRevenue=(bt.merchant.income.ownerRevenue||0)+_)}}"completedTrades"in jo&&delete jo.completedTrades;const Is={};Xt.forEach(n=>{Is[n]=Math.max(0,(Mo[n]||0)-(Z[n]||0))});const Cf=n=>n==="merchant"?(ho.merchant||0)+Rs:ho[n]||0,_f=n=>n==="merchant"?((f==null?void 0:f.merchant)||0)+wf:(f==null?void 0:f[n])||0,fa=U0.getOrCompute(g,"vacantRoleIncomeCache",()=>new Map),Tf=n=>{var X,oe,be;if(fa.has(n))return fa.get(n);const l=1.2;let b=0,x=0,_=0,I=0;Yt.forEach(he=>{var ge,Fe,qe,Pe,Ze,pe,rt,Ge,ke,pt;const Me=co[he.id]||0;if(Me<=0)return;const at=Nt(he,0),dt=at.jobs||{},Xe=dt[n]||0;if(Xe<=0)return;if(he.owner===n){let it=0;at.output&&Object.entries(at.output).forEach(([$e,Qe])=>{if(!Qe||Qe<=0||!Be[$e])return;const Pt=ze[$e]||Io($e);it+=Qe*Pt});let Bt=0;at.input&&Object.entries(at.input).forEach(([$e,Qe])=>{if(!Qe||Qe<=0)return;const Pt=ze[$e]||Io($e);Bt+=Qe*Pt});let Ue=0;Object.entries(dt).forEach(([$e,Qe])=>{var At,uo,st;if($e===n||!Qe||Qe<=0)return;const Pt=(st=(uo=vo==null?void 0:vo[$e])!=null?uo:(At=c==null?void 0:c.wages)==null?void 0:At[$e])!=null?st:yo($e);Ue+=Pt*Qe});const Se=((Fe=(ge=ae[n])==null?void 0:ge.headTaxBase)!=null?Fe:.01)*ci(n)*li,Ee=(qe=he.businessTaxBase)!=null?qe:.1,Tt=(Ze=(Pe=Ht==null?void 0:Ht.businessTaxRates)==null?void 0:Pe[he.id])!=null?Ze:1,Ct=Ee*Tt,Lt=it-Bt-Ue-Se-Ct,Oe=Xe>0?Lt/Xe:0;b+=Oe*Xe*Me,x+=Xe*Me}else{const it=(Ge=(rt=vo==null?void 0:vo[n])!=null?rt:(pe=c==null?void 0:c.wages)==null?void 0:pe[n])!=null?Ge:yo(n),Ue=((pt=(ke=ae[n])==null?void 0:ke.headTaxBase)!=null?pt:.01)*ci(n)*li,De=it-Ue;_+=De*Xe*Me,I+=Xe*Me}});const $=x+I;if($<=0){const Me=((be=(oe=vo==null?void 0:vo[n])!=null?oe:(X=c==null?void 0:c.wages)==null?void 0:X[n])!=null?be:yo(n))*l;return fa.set(n,Me),Me}const G=(b+_)/$,q=Math.max(0,G*l);return fa.set(n,q),q},da=Xt.map(n=>{var Ze,pe;const l=Z[n]||0,b=Cf(n),x=_f(n),_=b-x,I=l>0?b/l:0,$=l>0?_/l:0,A=ft[n]||0,G=xt[n]||0,q=n==="merchant"?Ef:0,oe=(A-G+q)/Math.max(1,l),be=vo[n]||yo(n),Me=((pe=(Ze=ae[n])==null?void 0:Ze.headTaxBase)!=null?pe:.01)*ci(n)*li,at=be-Me,dt=bf(n),Xe=n==="merchant"?oe:$,ot=dt!==null?dt:Xe,ge=oe!==0?oe:at;let Fe;l===0?Fe=Tf(n):n==="merchant"||ot!==0?Fe=n==="merchant"?ge:ot:Fe=ge;const qe=I>0?I*.002:0,Pe=Fe+qe;return{role:n,pop:l,perCap:I,perCapDelta:Xe,potentialIncome:Pe,vacancy:Is[n]||0}}).filter(n=>n.role!=="official"),pa=da.reduce((n,l)=>l.pop>0?n+l.pop:n,0);pa>0&&da.reduce((n,l)=>n+l.potentialIncome*l.pop,0)/pa,pa>0&&da.reduce((n,l)=>n+l.perCap*l.pop,0)/pa;const ks={};Object.keys(Be).forEach(n=>{const l=Do[n]||0,b=bo[n]||0;ks[n]=b>0?l/b:l>0?999:1});const ei={};Yt.forEach(n=>{if((co[n.id]||0)<=0)return;const b=Nt(n,0),x=b.output||{},_=b.jobs||{},I=Object.keys(x).filter($=>Be[$]);I.length!==0&&(Object.keys(_).forEach($=>{ei[$]||(ei[$]=[]),I.forEach(A=>{ei[$].includes(A)||ei[$].push(A)})}),n.owner&&!ei[n.owner]&&(ei[n.owner]=[]),n.owner&&I.forEach($=>{ei[n.owner].includes($)||ei[n.owner].push($)}))});const Ja=ol({popStructure:Z,wealth:je,roleMetrics:da,hasBuildingVacancyForRole:Mf,reserveBuildingVacancyForRole:vf,logs:We,migrationCooldowns:ye,supplyDemandRatio:ks,roleProducesResource:ei});Object.assign(Z,Ja.popStructure),Object.assign(je,Ja.wealth);const Ds=Ja.migrationCooldowns;Object.keys(ae).forEach(n=>{ho[n]=Math.max(0,je[n]||0)}),ui=Object.values(ho).reduce((n,l)=>n+l,0),Object.keys(ae).forEach(n=>{var l;if(n!=="official"&&Gi[n]){const b=Z[n]||0,x=ho[n]||0,_=((l=ae[n])==null?void 0:l.startingWealth)||100,I=b>0?x/b:0;Gi[n].wealthPerCapita=I,Gi[n].wealthRatio=_>0?I/_:0}});const Ws=Math.max(0,je.merchant||0);if(Ws-xf!==0){const n=ae.merchant;if(n){const l=Z.merchant||0,b=n.influenceBase*l+(ui>0?Ws/ui*10:0),x=b-(po.merchant||0);po.merchant=b,fi+=x}}const Ot={...me},Pf=1.5,Af=.02;Yt.forEach(n=>{var oe,be,he;const l=n.id,b=co[l]||0;if(b<=0)return;const x=Dn(l);if(x<=0)return;const _=n.owner;if(!_||_==="state")return;const I=Z[_]||0;if(I<=0)return;const $=je[_]||0,A=$/I,G=Ot[l]||{};let q=0;for(const[,Me]of Object.entries(G))typeof Me=="number"&&Me>0&&(q+=Me);const X=b-q;for(let Me=0;Me<x;Me++){if((Me===0?X:G[Me]||0)<=0)continue;const dt=Wn(l,Me+1,0);if(!dt)continue;let Xe=0;for(const[Pe,Ze]of Object.entries(dt))if(Pe==="silver")Xe+=Ze;else{const pe=ze[Pe]||1;Xe+=Ze*pe}if(A<Pf*Xe||Math.random()>Af||!Object.entries(dt).every(([Pe,Ze])=>Pe==="silver"?!0:(ie[Pe]||0)>=Ze)||$<Xe)continue;Object.entries(dt).forEach(([Pe,Ze])=>{Pe!=="silver"&&Dt(Pe,-Ze,"building_construction_cost")}),Je.transfer(_,"void",Xe,z.EXPENSE.BUILDING_COST,z.EXPENSE.BUILDING_COST),Ot[l]||(Ot[l]={}),Me>0&&(Ot[l][Me]=Math.max(0,(Ot[l][Me]||0)-1),Ot[l][Me]<=0&&delete Ot[l][Me]);const ge=Me+1;Ot[l][ge]=(Ot[l][ge]||0)+1,Object.keys(Ot[l]).length===0&&delete Ot[l];const Fe=((oe=ae[_])==null?void 0:oe.name)||_,qe=((he=(be=kn[l])==null?void 0:be[Me])==null?void 0:he.name)||`等级${ge}`;We.push(`??? ${Fe}自发投资了自己的产业 ${n.name} → ${qe}（花费 ${Math.ceil(Xe)} 银币）`);break}}),Ga.length>0&&Ga.forEach(n=>{const{buildingId:l,fromLevel:b,toLevel:x,officialName:_,cost:I}=n;Ot[l]||(Ot[l]={}),b>0&&(Ot[l][b]=Math.max(0,(Ot[l][b]||0)-1),Ot[l][b]<=0&&delete Ot[l][b]),Ot[l][x]=(Ot[l][x]||0)+1,Object.keys(Ot[l]).length===0&&delete Ot[l],We.push(`??? 官员${_}升级了 ${l}（花费 ${Math.ceil(I)} 银）`)}),Object.keys(ae).forEach(n=>{ho[n]=Math.max(0,je[n]||0)}),ui=Object.values(ho).reduce((n,l)=>n+l,0);const Os=sa*(1+(O.taxEfficiencyBonus||0)-(O.corruption||0)),Ri=Math.max(0,Math.min(1,Os)),ha=Gt.headTax*Ri,ma=Gt.industryTax*Ri,ga=Gt.businessTax*Ri,ya=(Gt.tariff||0)*Ri,Za=Gt.headTax+Gt.industryTax+Gt.businessTax+(Gt.tariff||0),Rf=Math.max(0,Math.min(1,sa*(1+(O.taxEfficiencyBonus||0)))),ba=Za*(1-Ri);console.log("[TAX DEBUG] Efficiency Calc:",{efficiency:sa,bonuses:O.taxEfficiencyBonus,rawTaxEfficiency:Os,effectiveTaxEfficiency:Ri,taxBase:Za,efficiencyLoss:ba,officialsCount:Ci.length}),ba>0&&(_e(-ba,"tax_efficiency_loss"),console.log("[TAX DEBUG] Applied efficiency loss:",-ba));const Qa=Math.max(0,Za*(Rf-Ri));if(Qa>0&&Ci.length>0){const n=ue?1:.5,l=Ci.map(I=>{var G,q,X;const $=(((G=I.effects)==null?void 0:G.corruption)||0)+(((q=I.drawbacks)==null?void 0:q.corruption)||0),A=((X=Sa[I.financialSatisfaction])==null?void 0:X.corruption)||0;return Math.max(0,($+A)*n)}),b=l.reduce((I,$)=>I+$,0),x=Qa/Ci.length;let _=0;Ci.forEach((I,$)=>{const A=b>0?Qa*(l[$]/b):x;A<=0||(I.wealth=Math.max(0,(I.wealth||0)+A),_+=A)}),_>0&&(bn+=_,je.official=bn,ho.official=Math.max(0,je.official),ui=Object.values(ho).reduce((I,$)=>I+$,0),$i+=_,Je.transfer("void","official",_,z.INCOME.CORRUPTION,z.INCOME.CORRUPTION))}const Bs=Gt.tariffSubsidy||0,Ka=ha+ma+ga+ya,Sf=Ka+di,No=Math.max(0,1+Zu),If=ha*No,kf=ma*No,Df=ga*No,Wf=ya*No;if(No>1){const n=ha*(No-1),l=ma*(No-1),b=ga*(No-1),x=ya*(No-1);n>0&&_e(n,"headTax"),l>0&&_e(l,"transactionTax"),b>0&&_e(b,"businessTax"),x>0&&_e(x,"tariffs")}Te.silver=(Te.silver||0)+If+kf+Df+Wf;const er=di*(No-1);if(er>0&&(_e(er,"income_war_indemnity_bonus"),Te.silver=(Te.silver||0)+er),di>0&&(Te.silver=(Te.silver||0)+di),Mi>0&&(_e(Mi,"income_policy"),Te.silver=(Te.silver||0)+Mi),Fi>0){const n=Math.min(ie.silver||0,Fi);n>0&&(_e(-n,"expense_policy"),Te.silver=(Te.silver||0)-n)}Gt.policyIncome=Mi,Gt.policyExpense=Fi;const Of=(Ka+di)*No,En=Gt.priceControlIncome||0,js=Gt.priceControlExpense||0,Cn=Number.isFinite(lt)?lt:0;En!==0&&(_e(En,"income_price_control"),Te.silver=(Te.silver||0)+En),Cn!==0&&(_e(Cn,"income_trade_route"),Te.silver=(Te.silver||0)+Cn);const Bf={total:Ka-Gt.subsidy-Bs+di+Mi-Fi+Cn+En-js,efficiency:sa,breakdown:{headTax:ha,industryTax:ma,businessTax:ga,tariff:ya,tariffSubsidy:Bs,subsidy:Gt.subsidy,warIndemnity:di,policyIncome:Mi,policyExpense:Fi,priceControlIncome:En,priceControlExpense:js,tradeRouteTax:Cn,baseFiscalIncome:Sf,totalFiscalIncome:Of,incomePercentMultiplier:No,_debug_tariffPolicies:{hasExport:!!Ht.exportTariffMultipliers,hasImport:!!Ht.importTariffMultipliers,rawTariff:Gt.tariff||0}}};if(ft.official=$i||0,Co&&(Co.official=[]),Zn.size>0&&Zn.forEach((n,l)=>{We.push(n>1?`${l}（共${n}处）`:l)}),_t.length>0){const n=Du({foreignInvestments:ao,nations:mt,organizations:(v==null?void 0:v.organizations)||[],playerMarket:{prices:xn},playerResources:ie,foreignInvestmentPolicy:fe,daysElapsed:g,jobFill:mn,buildings:co});ao=n.updatedInvestments,Jo.push(...n.logs),n.taxRevenue>0&&_e(n.taxRevenue,"foreign_investment_tax"),n.marketChanges&&Object.entries(n.marketChanges).forEach(([b,x])=>{b!=="silver"&&Dt(b,x,"autonomous_investment_return")});const l=Wu({foreignInvestments:ao,nations:mt,playerMarket:{prices:xn},playerResources:ie,buildingUpgrades:Ot,buildingCounts:co,daysElapsed:g});l.upgrades&&l.upgrades.length>0&&(ao=l.updatedInvestments,Jo.push(...l.logs),l.upgrades.forEach(b=>{const x=mt.find(_=>_.id===b.ownerNationId);x&&(x.wealth=Math.max(0,(x.wealth||0)-b.cost))}))}We.push(...Jo),Ye!=null&&Ye.tradeLog&&We.push(...Ye.tradeLog);const jf=g%10===0?J0({nations:mt,res:ie,supply:Do,demand:bo,market:{prices:xn},tick:g,taxPolicies:Ht,merchantTradePreferences:jo.merchantTradePreferences}):He,Nf=ku(ao);return _i&&(mt=mt.map(n=>{const l=Wt.filter(b=>{var x;return(x=b.members)==null?void 0:x.includes(n.id)}).map(b=>b.id);return{...n,organizationMemberships:l}})),{tradeOpportunities:jf,tradeRoutes:Ce?{...Ce,routes:Ce.routes.filter(n=>{var l;return!((l=Ye==null?void 0:Ye.routesToRemove)!=null&&l.includes(n))})}:void 0,overseasInvestments:Kt,foreignInvestments:ao,resources:ie,rates:Te,popStructure:Z,maxPop:Uo,militaryCapacity:ps,population:lo,birthAccumulator:wn,classApproval:Eo,approvalBreakdown:Et,classInfluence:po,classWealth:ho,classLivingStandard:Gi,totalInfluence:fi,totalWealth:ui,activeBuffs:Ha,activeDebuffs:Ya,stability:Ps,legitimacy:hn,legitimacyTaxModifier:ja,logs:We,market:{prices:xn,demand:bo,supply:Do,wages:vo,needsShortages:Co,stratumConsumption:Ko,supplyBreakdown:ro,demandBreakdown:cn},classIncome:ft,classExpense:xt,jobFill:mn,jobsAvailable:Mo,buildingJobsRequired:fn,taxes:Bf,classFinancialData:bt,buildingFinancialData:eo,buildingDebugData:ss,dailyMilitaryExpense:ea,needsShortages:Co,needsReport:Ei,livingStandardStreaks:_s,nations:mt,merchantState:jo,buildingUpgrades:Ot,migrationCooldowns:Ds,migrationCooldowns:Ds,diplomacyOrganizations:_i?{organizations:Wt}:null,taxShock:Ts,modifiers:{resourceDemand:{...ln,...Object.fromEntries(Object.entries(W).map(([n,l])=>[n,(ln[n]||0)+l]))},stratumDemand:{...un,...Object.fromEntries(Object.entries(j).map(([n,l])=>[n,(un[n]||0)+l]))},resourceSupply:Da,buildingProduction:{...Hn,...H},categoryProduction:Yn,sources:{decreeResourceDemand:ln,decreeStratumDemand:un,decreeResourceSupply:Da,eventResourceDemand:W,eventStratumDemand:j,eventBuildingProduction:H,techBuildingBonus:Hn,techCategoryBonus:Yn,productionBonus:Oa,industryBonus:Ba,militaryBonus:O.militaryBonus,stratumWealthMultiplier:ta,productionInputCost:(()=>{const n={},l=O.officialProductionInputCost||{},b=O.stanceProductionInputCost||{};return new Set([...Object.keys(l),...Object.keys(b)]).forEach(_=>{n[_]=(l[_]||0)+(b[_]||0)}),n})()},officialEffects:{buildingCostMod:O.buildingCostMod||0,militaryUpkeepMod:O.militaryUpkeepMod||0,taxEfficiencyBonus:O.taxEfficiencyBonus||0,corruption:O.corruption||0,populationGrowthBonus:O.populationGrowthBonus||0,tradeBonusMod:O.tradeBonusMod||0,organizationGrowthMod:O.organizationGrowthMod||0,wartimeProduction:O.wartimeProduction||0,resourceWaste:O.resourceWaste||{},coalitionApproval:O.coalitionApproval||0,legitimacyBonus:O.legitimacyBonus||0,factionConflict:O.factionConflict||0,diplomaticCooldown:O.diplomaticCooldown||0,diplomaticIncident:O.diplomaticIncident||0}},foreignInvestmentStats:Nf,army:y,officials:Ci,effectiveOfficialCapacity:Pl(u,Xn||{},C),buildings:co,_debug:{freeMarket:df,silverChangeLog:(()=>{const n=It.toArray(),l=n.some(b=>b.reason==="expense_army_maintenance");return console.log("[Simulation End] silverChangeLog has military?",l,"Entries:",n.length),n})(),classWealthChangeLog:kt,startingSilver:yt,endingSilver:ie.silver||0,militaryDebugInfo:gn}}};self.onmessage=function(e){const{type:t,payload:o}=e.data;if(t==="SIMULATE")try{const i=Fu(o);self.postMessage({type:"RESULT",payload:i})}catch(i){self.postMessage({type:"ERROR",error:i.message||"Unknown simulation error"})}else t==="PING"&&self.postMessage({type:"PONG"})},self.postMessage({type:"READY"})})();
