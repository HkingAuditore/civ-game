import{c as A,B as V,R as F,h as j,g as X,a as J}from"./index-CZqJWy4N.js";import"./motion-CXax0Jcm.js";import"./vendor-7s51MWtJ.js";const L=.95,_=5,H=5,x=(e,n,l)=>Math.max(n,Math.min(l,e)),S=(e,n)=>{if(e.length<=n)return e;const l=[...e];for(let r=l.length-1;r>0;r-=1){const i=Math.floor(Math.random()*(r+1));[l[r],l[i]]=[l[i],l[r]]}return l.slice(0,n)},M=(e=0)=>x((e+100)/200,.05,1),p=e=>{const n=(e==null?void 0:e.gdp)||(e==null?void 0:e.wealth)||0;return x(Math.log10(n+1)/6,.05,1)},W=(e,n,l)=>{var I;if(!e||e.id==="player")return!1;const r=e.suzerainId==="player"||e.vassalOf==="player",i=j(e,"investment_pact",l),O=j(e,"economic_pact",l),B=String(e.id),D=((I=n==null?void 0:n.organizations)==null?void 0:I.some(u=>{var s,f;return u.type==="economic_bloc"&&u.isActive!==!1&&((s=u.members)==null?void 0:s.some(a=>String(a)==="player"||String(a)==="0"))&&((f=u.members)==null?void 0:f.some(a=>String(a)===B))}))||!1;return r||i||O||D},q=(e,n,l,r)=>{var u;if(!e||!n)return!1;const i=n.id||"player",O=e.vassalOf===i&&e.vassalType!=="colony",B=n.vassalOf===e.id,D=(u=l==null?void 0:l.organizations)==null?void 0:u.some(s=>{var f,a;return s.type==="economic_bloc"&&((f=s.members)==null?void 0:f.includes(e.id))&&((a=s.members)==null?void 0:a.includes(i))}),N=j(e,"investment_pact",r),I=j(e,"economic_pact",r);return O||B||D||N||I},K=(e="autonomous")=>e==="guided"?.05:e==="forced"?-.1:.1,Q=(e,n,l)=>{const r={};return l.forEach(i=>{r[i]=X(n,i,e)}),r},T=e=>{const n=(e==null?void 0:e.cost)||(e==null?void 0:e.baseCost)||{};return Object.values(n).reduce((r,i)=>r+i,0)*1.5},Y=(e,n,l,r={},i=[],O=0)=>{const B=T(e);if(B<=0)return{roi:-1/0,dailyProfit:0};const D={buildingId:e.id,strategy:"PROFIT_MAX"},I=J(D,n,{},(l==null?void 0:l.prices)||{},{taxPolicies:r,organizations:i,daysElapsed:O,playerIsHome:!0,partnerNation:n}).profit||0;return{roi:I*360/B,dailyProfit:I}};function se({nations:e,playerNation:n,diplomacyOrganizations:l,overseasInvestments:r,classWealth:i,market:O,epoch:B,daysElapsed:D,taxPolicies:N={},maxInvestments:I=_,batchSize:u=2,batchOffset:s=0}){if(!n)return{investments:[],hasMore:!1,nextOffset:0};const f=(e||[]).filter(o=>W(o,l,D));if(f.length===0)return{investments:[],hasMore:!1,nextOffset:0};const a=f.sort((o,c)=>{const v=M(o.relation||0)*p(o);return M(c.relation||0)*p(c)-v}),h=a.slice(s,s+u),U=s+u<a.length,E=U?s+u:0,G=Object.keys(i||{}).filter(o=>(i[o]||0)>=1e3);if(G.length===0)return{investments:[],hasMore:U,nextOffset:E};const t=[];return h.forEach(o=>{const c=o.vassalOf==="player"?"vassal":"treaty",v=Q(B,c,G);let m=null;G.forEach(g=>{const b=i[g]||0,C=v[g]||[];S(C,H).forEach(R=>{const $=T(R);if($<=0||$>b)return;const{roi:P,dailyProfit:y}=Y(R,o,O,N,(l==null?void 0:l.organizations)||[],D);!Number.isFinite(P)||P<=0||(!m||P>m.roi)&&(m={stratum:g,targetNation:o,building:R,cost:$,roi:P,dailyProfit:y})})}),m&&t.push(m)}),t.length===0?{investments:[],hasMore:U,nextOffset:E}:(t.sort((o,c)=>c.roi-o.roi),{investments:t.slice(0,Math.min(I,t.length)).map(o=>({...o,investment:A({buildingId:o.building.id,targetNationId:o.targetNation.id,ownerStratum:o.stratum,strategy:"PROFIT_MAX",investmentAmount:o.cost})})),hasMore:U,nextOffset:E})}function te({investorNations:e,playerState:n,diplomacyOrganizations:l,market:r,epoch:i,daysElapsed:O,foreignInvestments:B=[],taxPolicies:D={},maxInvestments:N=_,batchSize:I=2,batchOffset:u=0}){console.log("ğŸ” [INBOUND-DEBUG] å¼€å§‹ç­›é€‰æŠ•èµ„å›½..."),console.log("ğŸ” [INBOUND-DEBUG] investorNations æ•°é‡:",(e==null?void 0:e.length)||0),console.log("ğŸ” [INBOUND-DEBUG] playerState:",n==null?void 0:n.id),console.log("ğŸ” [INBOUND-DEBUG] daysElapsed:",O);const s=(e||[]).filter(t=>{var c;if(!t||t.id==="player")return console.log("ğŸ” [INBOUND-DEBUG] è·³è¿‡:",(t==null?void 0:t.name)||"null","- åŸå› : ç©å®¶æˆ–null"),!1;if((t.wealth||0)<5e3)return console.log("ğŸ” [INBOUND-DEBUG] è·³è¿‡:",t.name,"- åŸå› : è´¢å¯Œä¸è¶³",t.wealth),!1;if(!q(t,n,l,O))return console.log("ğŸ” [INBOUND-DEBUG] è·³è¿‡:",t.name,"- åŸå› : æ— æŠ•èµ„æƒé™"),!1;const d=(c=t.lastForeignInvestmentDay)!=null?c:-1/0,o=O-d;return o<60?(console.log("ğŸ” [INBOUND-DEBUG] è·³è¿‡:",t.name,"- åŸå› : å†·å´ä¸­",o,"å¤©"),!1):(console.log("âœ… [INBOUND-DEBUG] ç¬¦åˆæ¡ä»¶:",t.name,"- è´¢å¯Œ:",t.wealth,"å…³ç³»:",t.relation),!0)});if(console.log("ğŸ” [INBOUND-DEBUG] eligibleInvestors æ•°é‡:",s.length),s.length===0)return console.log("âŒ [INBOUND-DEBUG] æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æŠ•èµ„å›½"),{investments:[],hasMore:!1,nextOffset:0};const f=s.sort((t,d)=>{const o=M(t.relation||0)*p(t);return M(d.relation||0)*p(d)-o});console.log("ğŸ” [INBOUND-DEBUG] æ’åºåçš„æŠ•èµ„å›½:",f.map(t=>t.name));const a=f.slice(u,u+I),h=u+I<f.length,U=h?u+I:0;console.log("ğŸ” [INBOUND-DEBUG] æœ¬æ‰¹æ¬¡å¤„ç†:",a.map(t=>t.name)),console.log("ğŸ” [INBOUND-DEBUG] batchOffset:",u,"hasMore:",h,"nextOffset:",U);const E=[];if(a.forEach(t=>{var v,m;const d=((v=t.vassalPolicy)==null?void 0:v.investmentPolicy)||"autonomous",o=K(d);console.log("ğŸ” [INBOUND-DEBUG] è¯„ä¼°",t.name,"- policy:",d,"threshold:",o);const c=Z({targetBuildings:(n==null?void 0:n.buildings)||{},targetJobFill:(n==null?void 0:n.jobFill)||{},epoch:i,market:r,investorWealth:t.wealth||0,foreignInvestments:B});if(console.log("ğŸ” [INBOUND-DEBUG]",t.name,"æœ€ä½³å»ºç­‘:",(m=c==null?void 0:c.building)==null?void 0:m.name,"ROI:",c==null?void 0:c.roi),!c||c.roi<=o){console.log("âŒ [INBOUND-DEBUG]",t.name,"è·³è¿‡ - ROIä¸è¶³æˆ–æ— å»ºç­‘");return}console.log("âœ… [INBOUND-DEBUG]",t.name,"å†³å®šæŠ•èµ„:",c.building.name),E.push({investorNation:t,building:c.building,cost:c.cost,roi:c.roi,investmentPolicy:d})}),console.log("ğŸ” [INBOUND-DEBUG] æœ¬æ‰¹æ¬¡æŠ•èµ„å†³ç­–æ•°é‡:",E.length),E.length===0)return console.log("âŒ [INBOUND-DEBUG] æœ¬æ‰¹æ¬¡æ²¡æœ‰æŠ•èµ„å†³ç­–"),{investments:[],hasMore:h,nextOffset:U};E.sort((t,d)=>d.roi-t.roi);const G=E.slice(0,Math.min(N,E.length));return console.log("âœ… [INBOUND-DEBUG] è¿”å›æŠ•èµ„å†³ç­–:",G.map(t=>`${t.investorNation.name} -> ${t.building.name}`)),{investments:G,hasMore:h,nextOffset:U}}function Z({targetBuildings:e={},targetJobFill:n={},epoch:l=0,market:r=null,investorWealth:i=1/0,foreignInvestments:O=[]}){const B=V.filter(s=>{if(s.cat!=="gather"&&s.cat!=="industry"||(s.epoch||0)>l||!s.baseCost&&!s.cost)return!1;const f=s.jobs||{};if(!Object.keys(f).some(o=>o!==s.owner))return console.log(`[æŠ•èµ„ç­›é€‰] æ’é™¤ ${s.name}: æ²¡æœ‰é›‡ä½£å…³ç³» (owner=${s.owner}, jobs=${Object.keys(f).join(",")})`),!1;const h=e[s.id]||0;if(h<=0)return!1;const U=(O||[]).filter(o=>o.buildingId===s.id&&o.status==="operating").reduce((o,c)=>o+(c.count||1),0);if(U>=h)return console.log(`[æŠ•èµ„ç­›é€‰] æ’é™¤ ${s.name}: å¤–èµ„æ•°é‡å·²è¾¾ä¸Šé™ (${U}/${h})`),!1;if(n&&Object.keys(n).length>0){const o=n[s.id]||{},c=s.jobs||{};let v=0,m=0;Object.entries(c).forEach(([b,C])=>{const w=C*h;v+=w,m+=Math.min(o[b]||0,w)});const g=v>0?m/v:1;if(g<L)return console.log(`[æŠ•èµ„ç­›é€‰] æ’é™¤ ${s.name}: åˆ°å²—ç‡ä¸è¶³ (${(g*100).toFixed(1)}% < 95%)`),!1}const G=s.baseCost||s.cost||{};return!((Object.values(G).reduce((o,c)=>o+(typeof c=="number"?c:0),0)||1e3)*1.5>i)});if(B.length===0)return console.log("[æŠ•èµ„ç­›é€‰] æ²¡æœ‰æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„å»ºç­‘"),null;console.log(`[æŠ•èµ„ç­›é€‰] æ‰¾åˆ° ${B.length} ä¸ªå€™é€‰å»ºç­‘: ${B.map(s=>s.name).join(", ")}`);let D=null,N=-1/0,I=0;const u={};Object.keys(F).forEach(s=>{var f,a;u[s]=((f=r==null?void 0:r.prices)==null?void 0:f[s])||((a=F[s])==null?void 0:a.basePrice)||1});for(const s of B){const f=s.baseCost||s.cost||{},h=(Object.values(f).reduce((g,b)=>g+(typeof b=="number"?b:0),0)||1e3)*1.5;let U=0;const E=s.output||{};Object.entries(E).forEach(([g,b])=>{if(g==="maxPop"||g==="militaryCapacity")return;const C=u[g]||1;U+=b*C});let G=0;const t=s.input||{};Object.entries(t).forEach(([g,b])=>{const C=u[g]||1;G+=b*C});let d=0;const o=s.jobs||{},c=(r==null?void 0:r.wages)||{};Object.entries(o).forEach(([g,b])=>{var w;if(s.owner&&g===s.owner)return;const C=(w=c[g])!=null?w:.1;d+=b*C});const v=U-G-d,m=h>0?v*360/h:0;console.log(`[æŠ•èµ„ç­›é€‰] ${s.name}: profit=${v.toFixed(1)}/day, cost=${h}, ROI=${(m*100).toFixed(1)}%`),m>N&&(N=m,D=s,I=h)}return D?(console.log(`[æŠ•èµ„ç­›é€‰] é€‰æ‹©æœ€ä½³å»ºç­‘: ${D.name} (ROI=${(N*100).toFixed(1)}%)`),{building:D,cost:I,roi:N}):(console.log("[æŠ•èµ„ç­›é€‰] æ²¡æœ‰æ‰¾åˆ°æ­£ROIçš„å»ºç­‘"),null)}export{Z as selectBestInvestmentBuilding,te as selectInboundInvestmentsBatch,se as selectOutboundInvestmentsBatch};
