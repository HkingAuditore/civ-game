import{c as D,B as V,R as _,h as F,g as X,a as G}from"./index-FGjEJRHG.js";import"./motion-CXax0Jcm.js";import"./vendor-7s51MWtJ.js";const L=.95,B=5,$=5,J=5,R=(t,s,n)=>Math.max(s,Math.min(n,t)),T=(t,s,n)=>{if(t.length<=n)return t;const o=t.map(i=>{const h=Math.max(1e-4,s(i)),a=Math.pow(Math.random(),1/h);return{item:i,key:a}});return o.sort((i,h)=>h.key-i.key),o.slice(0,n).map(i=>i.item)},U=(t,s)=>{if(t.length<=s)return t;const n=[...t];for(let o=n.length-1;o>0;o-=1){const i=Math.floor(Math.random()*(o+1));[n[o],n[i]]=[n[i],n[o]]}return n.slice(0,s)},A=(t=0)=>R((t+100)/200,.05,1),W=t=>{const s=(t==null?void 0:t.gdp)||(t==null?void 0:t.wealth)||0;return R(Math.log10(s+1)/6,.05,1)},S=(t,s,n=30)=>{if(!Number.isFinite(s))return 1;const o=t-s;return o>=n?1:R(o/n,.2,.8)},N=(t,s,n)=>{var d;if(!t||t.id==="player")return!1;const o=t.suzerainId==="player"||t.vassalOf==="player",i=F(t,"investment_pact",n),h=F(t,"economic_pact",n),a=((d=s==null?void 0:s.organizations)==null?void 0:d.some(m=>{var p,I;return m.type==="economic_bloc"&&((p=m.members)==null?void 0:p.includes("player"))&&((I=m.members)==null?void 0:I.includes(t.id))}))||!1;return o||i||h||a},q=(t,s,n,o)=>{var I;if(!t||!s)return!1;const i=s.id||"player",h=t.vassalOf===i&&t.vassalType!=="colony",a=s.vassalOf===t.id,d=(I=n==null?void 0:n.organizations)==null?void 0:I.some(e=>{var u,r;return e.type==="economic_bloc"&&((u=e.members)==null?void 0:u.includes(t.id))&&((r=e.members)==null?void 0:r.includes(i))}),m=F(t,"investment_pact",o),p=F(t,"economic_pact",o);return h||a||d||m||p},H=(t="autonomous")=>t==="guided"?.05:t==="forced"?-.1:.1,K=(t,s,n)=>{const o={};return n.forEach(i=>{o[i]=X(s,i,t)}),o},x=t=>{const s=(t==null?void 0:t.baseCost)||(t==null?void 0:t.cost)||{};return Object.values(s).reduce((n,o)=>n+(typeof o=="number"?o:0),0)},Q=(t,s,n)=>{const o=x(t);if(o<=0)return{roi:-1/0,dailyProfit:0};const i={buildingId:t.id,strategy:"PROFIT_MAX"},a=G(i,s,{},(n==null?void 0:n.prices)||{}).profit||0;return{roi:a*360/o,dailyProfit:a}};function tt({nations:t,playerNation:s,diplomacyOrganizations:n,overseasInvestments:o,classWealth:i,market:h,epoch:a,daysElapsed:d,maxNations:m=B,maxInvestments:p=$}){if(!s)return[];const I=(t||[]).filter(c=>N(c,n,d));if(I.length===0)return[];const u=T(I,c=>{const g=A(c.relation||0),O=W(c),M=S(d,c.lastOutboundSampleDay,30);return g*O*M},Math.min(m,I.length)),r=Object.keys(i||{}).filter(c=>(i[c]||0)>=1e3);if(r.length===0)return[];const l=[];return u.forEach(c=>{const g=c.vassalOf==="player"?"vassal":"treaty",O=K(a,g,r);let M=null;r.forEach(C=>{const b=i[C]||0,P=O[C]||[];U(P,J).forEach(j=>{const f=x(j);if(f<=0||f>b)return;const{roi:v,dailyProfit:y}=Q(j,c,h);Number.isFinite(v)&&(!M||v>M.roi)&&(M={stratum:C,targetNation:c,building:j,cost:f,roi:v,dailyProfit:y})})}),M&&l.push(M)}),l.length===0?[]:(l.sort((c,g)=>g.roi-c.roi),l.slice(0,Math.min(p,l.length)).map(c=>({...c,investment:D({buildingId:c.building.id,targetNationId:c.targetNation.id,ownerStratum:c.stratum,strategy:"PROFIT_MAX",investmentAmount:c.cost})})))}function et({investorNations:t,playerState:s,diplomacyOrganizations:n,market:o,epoch:i,daysElapsed:h,foreignInvestments:a=[],maxNations:d=B,maxInvestments:m=$}){const p=(t||[]).filter(r=>{var c;if(!r||r.id==="player"||(r.wealth||0)<5e3||!q(r,s,n,h))return!1;const l=(c=r.lastForeignInvestmentDay)!=null?c:-1/0;return h-l>=60});if(p.length===0)return[];const e=T(p,r=>{const l=A(r.relation||0),c=W(r),g=S(h,r.lastForeignSampleDay,30);return l*c*g},Math.min(d,p.length)),u=[];return e.forEach(r=>{var O;const l=((O=r.vassalPolicy)==null?void 0:O.investmentPolicy)||"autonomous",c=H(l),g=Y({targetBuildings:(s==null?void 0:s.buildings)||{},targetJobFill:(s==null?void 0:s.jobFill)||{},epoch:i,market:o,investorWealth:r.wealth||0,foreignInvestments:a});!g||g.roi<=c||u.push({investorNation:r,building:g.building,cost:g.cost,roi:g.roi,investmentPolicy:l})}),u.length===0?[]:(u.sort((r,l)=>l.roi-r.roi),u.slice(0,Math.min(m,u.length)))}function Y({targetBuildings:t={},targetJobFill:s={},epoch:n=0,market:o=null,investorWealth:i=1/0,foreignInvestments:h=[]}){const a=V.filter(e=>{if(e.cat!=="gather"&&e.cat!=="industry"||(e.epoch||0)>n||!e.baseCost&&!e.cost)return!1;const u=e.jobs||{};if(!Object.keys(u).some(b=>b!==e.owner))return console.log(`[投资筛选] 排除 ${e.name}: 没有雇佣关系 (owner=${e.owner}, jobs=${Object.keys(u).join(",")})`),!1;const l=t[e.id]||0;if(l<=0)return!1;const c=(h||[]).filter(b=>b.buildingId===e.id&&b.status==="operating").reduce((b,P)=>b+(P.count||1),0);if(c>=l)return console.log(`[投资筛选] 排除 ${e.name}: 外资数量已达上限 (${c}/${l})`),!1;if(s&&Object.keys(s).length>0){const b=s[e.id]||{},P=e.jobs||{};let w=0,j=0;Object.entries(P).forEach(([v,y])=>{const E=y*l;w+=E,j+=Math.min(b[v]||0,E)});const f=w>0?j/w:1;if(f<L)return console.log(`[投资筛选] 排除 ${e.name}: 到岗率不足 (${(f*100).toFixed(1)}% < 95%)`),!1}const O=e.baseCost||e.cost||{};return!((Object.values(O).reduce((b,P)=>b+(typeof P=="number"?P:0),0)||1e3)*1.5>i)});if(a.length===0)return console.log("[投资筛选] 没有找到满足条件的建筑"),null;console.log(`[投资筛选] 找到 ${a.length} 个候选建筑: ${a.map(e=>e.name).join(", ")}`);let d=null,m=-1/0,p=0;const I={};Object.keys(_).forEach(e=>{var u,r;I[e]=((u=o==null?void 0:o.prices)==null?void 0:u[e])||((r=_[e])==null?void 0:r.basePrice)||1});for(const e of a){const u=e.baseCost||e.cost||{},l=(Object.values(u).reduce((f,v)=>f+(typeof v=="number"?v:0),0)||1e3)*1.5;let c=0;const g=e.output||{};Object.entries(g).forEach(([f,v])=>{if(f==="maxPop"||f==="militaryCapacity")return;const y=I[f]||1;c+=v*y});let O=0;const M=e.input||{};Object.entries(M).forEach(([f,v])=>{const y=I[f]||1;O+=v*y});let C=0;const b=e.jobs||{},P=(o==null?void 0:o.wages)||{};Object.entries(b).forEach(([f,v])=>{var E;if(e.owner&&f===e.owner)return;const y=(E=P[f])!=null?E:.1;C+=v*y});const w=c-O-C,j=l>0?w*360/l:0;console.log(`[投资筛选] ${e.name}: profit=${w.toFixed(1)}/day, cost=${l}, ROI=${(j*100).toFixed(1)}%`),j>m&&(m=j,d=e,p=l)}return d?(console.log(`[投资筛选] 选择最佳建筑: ${d.name} (ROI=${(m*100).toFixed(1)}%)`),{building:d,cost:p,roi:m}):(console.log("[投资筛选] 没有找到正ROI的建筑"),null)}export{Y as selectBestInvestmentBuilding,et as selectInboundInvestmentsBatch,tt as selectOutboundInvestmentsBatch};
