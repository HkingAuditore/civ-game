(function(){"use strict";const xt={price:{livingCostWeight:.15,taxCostWeight:.1},wage:{livingCostWeight:.1,taxCostWeight:.1},market:{virtualDemandPerPop:.01,supplyDemandWeight:1,inventoryTargetDays:365,inventoryPriceImpact:.25,demandElasticity:.5,outputVariation:.2}},qe={food:{name:"粮食",icon:"Wheat",color:"text-yellow-400",basePrice:1,minPrice:.1,maxPrice:10,defaultOwner:"peasant",unlockEpoch:0,tags:["essential","raw_material"],marketConfig:{supplyDemandWeight:.4,inventoryTargetDays:730,inventoryPriceImpact:.15,demandElasticity:.2,outputVariation:.2}},wood:{name:"木材",icon:"Trees",color:"text-emerald-400",basePrice:2,minPrice:.02,maxPrice:20,defaultOwner:"lumberjack",unlockEpoch:0,tags:["raw_material"],marketConfig:{supplyDemandWeight:.7,inventoryTargetDays:550,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},stone:{name:"石料",icon:"Pickaxe",color:"text-stone-400",basePrice:3,minPrice:.03,maxPrice:30,defaultOwner:"miner",unlockEpoch:0,tags:["raw_material"],marketConfig:{supplyDemandWeight:.7,inventoryTargetDays:550,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},cloth:{name:"布料",icon:"Shirt",color:"text-indigo-300",basePrice:1.5,minPrice:.015,maxPrice:15,defaultOwner:"worker",unlockEpoch:0,tags:["essential","raw_material","manufactured"],marketConfig:{supplyDemandWeight:.8,inventoryTargetDays:600,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},brick:{name:"砖块",icon:"Home",color:"text-red-400",basePrice:6,minPrice:.06,maxPrice:60,defaultOwner:"artisan",unlockEpoch:0,unlockTech:"pottery",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:270,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},tools:{name:"工具",icon:"Anvil",color:"text-blue-300",basePrice:16,minPrice:.16,maxPrice:160,defaultOwner:"artisan",unlockEpoch:0,unlockTech:"tool_making",tags:["industrial"],marketConfig:{supplyDemandWeight:1.2,inventoryTargetDays:300,inventoryPriceImpact:.35,demandElasticity:.6,outputVariation:.2}},plank:{name:"木板",icon:"TreeDeciduous",color:"text-amber-600",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"worker",unlockEpoch:1,unlockTech:"tools",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:240,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},copper:{name:"铜矿",icon:"Pickaxe",color:"text-orange-400",basePrice:5.5,minPrice:.055,maxPrice:55,defaultOwner:"miner",unlockEpoch:1,unlockTech:"copper_mining",tags:["raw_material"],marketConfig:{supplyDemandWeight:.9,inventoryTargetDays:300,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},dye:{name:"染料",icon:"Droplets",color:"text-pink-500",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"artisan",unlockEpoch:1,tags:["industrial","raw_material"],marketConfig:{supplyDemandWeight:1.1,inventoryTargetDays:200,inventoryPriceImpact:.35,demandElasticity:.6,outputVariation:.2}},papyrus:{name:"纸张",icon:"ScrollText",color:"text-lime-300",basePrice:6.5,minPrice:.065,maxPrice:65,defaultOwner:"scribe",unlockEpoch:2,unlockTech:"papyrus_cultivation",tags:["raw_material","manufactured"],marketConfig:{supplyDemandWeight:1.1,inventoryTargetDays:240,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},delicacies:{name:"珍馐",icon:"UtensilsCrossed",color:"text-rose-400",basePrice:24,minPrice:.24,maxPrice:240,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"culinary_arts",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.5,inventoryTargetDays:90,inventoryPriceImpact:.45,demandElasticity:1.3,outputVariation:.2}},furniture:{name:"家具",icon:"Armchair",color:"text-amber-500",basePrice:28,minPrice:.28,maxPrice:280,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"carpentry",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.5,inventoryTargetDays:120,inventoryPriceImpact:.4,demandElasticity:1.2,outputVariation:.2}},ale:{name:"美酒",icon:"Wine",color:"text-purple-400",basePrice:18,minPrice:.18,maxPrice:180,defaultOwner:"artisan",unlockEpoch:2,unlockTech:"brewing",tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.6,inventoryTargetDays:150,inventoryPriceImpact:.5,demandElasticity:1.5,outputVariation:.2}},fine_clothes:{name:"华服",icon:"Shirt",color:"text-purple-400",basePrice:32,minPrice:.32,maxPrice:320,defaultOwner:"artisan",unlockEpoch:2,tags:["luxury","manufactured"],marketConfig:{supplyDemandWeight:1.6,inventoryTargetDays:100,inventoryPriceImpact:.5,demandElasticity:1.5,outputVariation:.2}},iron:{name:"铁矿",icon:"Pickaxe",color:"text-zinc-400",basePrice:8,minPrice:.08,maxPrice:80,defaultOwner:"miner",unlockEpoch:2,unlockTech:"ironworking",tags:["raw_material"],marketConfig:{supplyDemandWeight:.8,inventoryTargetDays:500,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.2}},spice:{name:"香料",icon:"Leaf",color:"text-amber-400",basePrice:26,minPrice:.26,maxPrice:260,defaultOwner:"merchant",unlockEpoch:4,unlockTech:"cartography",tags:["essential","manufactured"],marketConfig:{supplyDemandWeight:1.4,inventoryTargetDays:180,inventoryPriceImpact:.4,demandElasticity:.9,outputVariation:.2}},coffee:{name:"咖啡",icon:"Coffee",color:"text-amber-700",basePrice:24,minPrice:.24,maxPrice:240,defaultOwner:"merchant",unlockEpoch:5,unlockTech:"coffee_agronomy",tags:["essential","manufactured"],marketConfig:{supplyDemandWeight:1.2,inventoryTargetDays:240,inventoryPriceImpact:.35,demandElasticity:.8,outputVariation:.2}},coal:{name:"煤炭",icon:"Flame",color:"text-slate-300",basePrice:7.5,minPrice:.075,maxPrice:75,defaultOwner:"miner",unlockEpoch:6,unlockTech:"coal_gasification",tags:["raw_material"],marketConfig:{supplyDemandWeight:.9,inventoryTargetDays:365,inventoryPriceImpact:.25,demandElasticity:.4,outputVariation:.2}},steel:{name:"钢材",icon:"Cog",color:"text-gray-300",basePrice:40,minPrice:.4,maxPrice:400,defaultOwner:"engineer",unlockEpoch:6,unlockTech:"steel_alloys",tags:["industrial"],marketConfig:{supplyDemandWeight:1,inventoryTargetDays:300,inventoryPriceImpact:.3,demandElasticity:.5,outputVariation:.2}},silver:{name:"银币",icon:"Coins",color:"text-slate-200",type:"currency",basePrice:1,minPrice:1,maxPrice:1,unlockEpoch:0,tags:["currency"]},science:{name:"科研",icon:"Cpu",color:"text-cyan-400",basePrice:5,minPrice:.05,maxPrice:50,defaultOwner:"official",unlockEpoch:0,tags:["special","manufactured"],marketConfig:{supplyDemandWeight:.5,inventoryTargetDays:730,inventoryPriceImpact:.15,demandElasticity:.2,outputVariation:.1}},culture:{name:"文化",icon:"ScrollText",color:"text-pink-400",basePrice:2,minPrice:.025,maxPrice:10,defaultOwner:"cleric",unlockEpoch:1,unlockTech:"amphitheater_design",tags:["special","manufactured"],marketConfig:{supplyDemandWeight:.6,inventoryTargetDays:600,inventoryPriceImpact:.2,demandElasticity:.3,outputVariation:.15}},maxPop:{name:"人口上限",icon:"Users",color:"text-blue-400",type:"virtual",tags:["special"]},militaryCapacity:{name:"军事容量",icon:"Shield",color:"text-red-400",type:"virtual",tags:["special"]}},ui=[{id:0,name:"石器时代",color:"text-stone-400",bg:"bg-stone-900",tileColor:"bg-stone-700",req:{science:0},cost:{},bonuses:{desc:"文明的起源，一切从这里开始。",gatherBonus:.2}},{id:1,name:"青铜时代",color:"text-orange-400",bg:"bg-orange-950",tileColor:"bg-orange-800",req:{science:600,population:25},cost:{food:6e3,wood:3500,stone:1200,silver:600,science:600},bonuses:{desc:"掌握青铜冶炼与畜力生产，资源获取加速。",gatherBonus:.4,militaryBonus:.2,industryBonus:.2}},{id:2,name:"古典时代",color:"text-amber-300",bg:"bg-amber-900",tileColor:"bg-amber-700",req:{science:1800,population:90,culture:250},cost:{food:2e4,wood:1e4,brick:3600,silver:5e3,tools:1200,science:1800},bonuses:{desc:"哲学与艺术的萌芽，文明全方位提升。",gatherBonus:.6,militaryBonus:.3,cultureBonus:.2,scienceBonus:.2,industryBonus:.3,maxPop:.1}},{id:3,name:"封建时代",color:"text-blue-400",bg:"bg-blue-950",tileColor:"bg-blue-800",req:{science:4500,population:170,culture:600},cost:{food:1e5,wood:5e4,brick:25e3,iron:12500,papyrus:5e3,silver:15e3,science:4500},bonuses:{desc:"封建制度确立，人口与经济快速增长。",gatherBonus:.8,militaryBonus:.4,cultureBonus:.3,scienceBonus:.3,industryBonus:.4,taxIncome:.2}},{id:4,name:"探索时代",color:"text-cyan-300",bg:"bg-cyan-900",tileColor:"bg-cyan-700",req:{science:8e3,population:320,culture:1400},cost:{food:26e4,plank:7e4,brick:6e4,iron:35e3,silver:4e4,science:8e3},bonuses:{desc:"大航海开启，贸易与工业蓬勃发展。",gatherBonus:1.2,militaryBonus:.45,cultureBonus:.4,scienceBonus:.5,industryBonus:.6,incomePercent:.5}},{id:5,name:"启蒙时代",color:"text-purple-400",bg:"bg-purple-950",tileColor:"bg-purple-800",req:{science:12e3,population:450,culture:2500},cost:{food:35e4,plank:8e4,papyrus:3e4,spice:2e4,silver:5e4,science:12e3},bonuses:{desc:"理性的光辉照耀，科学与文化大幅提升。",gatherBonus:1.5,militaryBonus:.5,cultureBonus:.6,scienceBonus:.8,industryBonus:1,stability:10}},{id:6,name:"工业时代",color:"text-gray-200",bg:"bg-gray-800",tileColor:"bg-gray-600",req:{science:2e4,population:650,culture:4e3},cost:{food:75e4,brick:18e4,iron:12e4,tools:75e3,spice:3e4,silver:12e4,science:2e4},bonuses:{desc:"机械化大生产，工业产能爆炸式增长。",gatherBonus:2,militaryBonus:.6,cultureBonus:.8,scienceBonus:1.2,industryBonus:2,maxPop:.2}},{id:7,name:"信息时代",color:"text-green-400",bg:"bg-green-950",tileColor:"bg-green-800",req:{science:35e3,population:1e3,culture:8e3},cost:{food:2e6,tools:3e5,silver:25e4,spice:8e4,papyrus:1e5,science:35e3},bonuses:{desc:"数字革命改变世界，知识和信息成为核心生产力。",gatherBonus:3,militaryBonus:.8,cultureBonus:1.5,scienceBonus:3,industryBonus:3,incomePercent:1}}],ce={peasant:{name:"自耕农",icon:"Wheat",weight:1,tax:1,headTaxBase:.01,desc:"社会的基础，提供稳定的粮食和兵源。",wealthWeight:1,influenceBase:.5,startingWealth:80,defaultResource:"food",wealthElasticity:.5,maxConsumptionMultiplier:3,needs:{food:.55,cloth:.08},luxuryNeeds:{1:{ale:.04},1.5:{wood:.02,culture:.02},2:{plank:.03,stone:.01},2.5:{furniture:.02,tools:.02},3:{spice:.04,brick:.02,culture:.05},4.5:{copper:.004},5.5:{delicacies:.02,fine_clothes:.01,culture:.08},7:{coffee:.02},8:{}},buffs:{satisfied:{desc:"民心稳定",taxIncome:.1,production:.05},dissatisfied:{desc:"民怨沸腾",taxIncome:-.2,production:-.1}}},lumberjack:{name:"樵夫",icon:"Trees",weight:.8,tax:1.2,headTaxBase:.02,desc:"专职砍伐木材，维系城市建设。",wealthWeight:1,influenceBase:.4,startingWealth:90,defaultResource:"wood",wealthElasticity:.6,maxConsumptionMultiplier:3,needs:{food:.65,cloth:.1},luxuryNeeds:{1:{ale:.04},1.5:{stone:.01,culture:.02},2:{plank:.04,wood:.03},2.5:{furniture:.025},3:{spice:.03,brick:.025,culture:.05},4.5:{copper:.006,tools:.03},5.5:{delicacies:.025,fine_clothes:.015,culture:.08},7:{coffee:.03},8:{}},buffs:{satisfied:{desc:"林场顺畅",production:.06},dissatisfied:{desc:"供应迟滞",production:-.1}}},serf:{name:"佃农",icon:"Users",weight:.5,tax:2,headTaxBase:.015,desc:"依附于地主的农民，产出归地主所有。",wealthWeight:.5,influenceBase:.3,startingWealth:50,defaultResource:"food",wealthElasticity:.4,maxConsumptionMultiplier:3,needs:{food:.5,cloth:.06},luxuryNeeds:{1:{ale:.03},2:{culture:.015},2.5:{food:.06},3:{furniture:.01,plank:.02,tools:.006},4:{spice:.02,stone:.006,culture:.03},5:{},6:{delicacies:.01,brick:.015,culture:.05},7.5:{fine_clothes:.008,copper:.004},9:{coffee:.01},10:{}},buffs:{satisfied:{desc:"佃农勤恳",production:.08},dissatisfied:{desc:"佃农怠工",production:-.15}}},worker:{name:"工人",icon:"Hammer",weight:2,tax:3,headTaxBase:.03,desc:"工业时代的基石，推动生产力发展。",wealthWeight:2,influenceBase:1,startingWealth:80,defaultResource:"plank",wealthElasticity:.7,maxConsumptionMultiplier:3,needs:{food:.7,cloth:.12},luxuryNeeds:{1:{tools:.05,ale:.07},1.5:{plank:.02,culture:.03},2.5:{furniture:.03,spice:.02},3:{coffee:.025,brick:.03,culture:.08},4:{fine_clothes:.03,delicacies:.04,stone:.015},5:{steel:.01,copper:.008,culture:.12},6.5:{},8:{papyrus:.02},10:{},12:{}},buffs:{satisfied:{desc:"工人积极",industryBonus:.15},dissatisfied:{desc:"工人罢工",industryBonus:-.25}}},artisan:{name:"工匠",icon:"Anvil",weight:1.5,tax:3.5,headTaxBase:.035,desc:"技艺精湛的手工业者，负责加工铜器与印刷制品。",wealthWeight:2.5,influenceBase:1.2,startingWealth:200,defaultResource:"tools",wealthElasticity:.8,maxConsumptionMultiplier:6,needs:{food:.8,cloth:.14},luxuryNeeds:{1:{tools:.06,ale:.08,furniture:.04,culture:.04},1.8:{copper:.015,spice:.04},2.5:{coffee:.03,fine_clothes:.025,brick:.03,culture:.1},3.5:{delicacies:.06,stone:.025,dye:.015},4.5:{steel:.008,iron:.01,culture:.15},6:{},8:{papyrus:.03},10:{},12:{}},buffs:{satisfied:{desc:"坊市繁盛",production:.1},dissatisfied:{desc:"工坊停工",production:-.15}}},miner:{name:"矿工",icon:"Pickaxe",weight:1.2,tax:2.5,headTaxBase:.025,desc:"深入地下采集矿石，承担艰苦劳动。",wealthWeight:1.5,influenceBase:.8,startingWealth:120,defaultResource:"stone",wealthElasticity:.6,maxConsumptionMultiplier:4,needs:{food:.7,cloth:.12},luxuryNeeds:{1:{ale:.05},1.8:{wood:.03},2:{culture:.02},2.5:{furniture:.02,spice:.015,food:.15},3:{plank:.03,brick:.02,coffee:.015},4:{delicacies:.03,culture:.05},5.5:{copper:.01},7:{fine_clothes:.02,culture:.08},9:{},11:{}},buffs:{satisfied:{desc:"矿脉稳定",gatherBonus:.1},dissatisfied:{desc:"矿难隐患",stability:-.1}}},merchant:{name:"商人",icon:"Coins",weight:6,tax:5,headTaxBase:.09,desc:"控制贸易网络的阶层，主宽港口与市场。",wealthWeight:8,influenceBase:3.5,startingWealth:500,defaultResource:"spice",wealthElasticity:1.5,maxConsumptionMultiplier:10,needs:{food:1.8,cloth:.25},luxuryNeeds:{1:{delicacies:.6,spice:.2,furniture:.12,plank:.08,ale:.15,fine_clothes:.1,culture:.2,dye:.02},1.5:{coffee:.14},2:{delicacies:.35,plank:.12,brick:.05,culture:.35},3:{steel:.05,coal:.03},5:{papyrus:.08,copper:.06,stone:.05,culture:.5},8:{},12:{},18:{}},buffs:{satisfied:{desc:"商贸兴隆",taxIncome:.15,gatherBonus:.05},dissatisfied:{desc:"贸易停滞",taxIncome:-.2,stability:-.1}},tradeConfig:{minProfitMargin:.1,maxPurchaseAmount:10,exportProbability:.5,maxInventoryRatio:.1,minWealthForTrade:10,tradeDuration:3,tradeCooldown:0,enableDebugLog:!0}},navigator:{name:"水手",icon:"Compass",weight:4,tax:3,headTaxBase:.06,desc:"探索时代的海员与测绘师，推动航海扩张。",wealthWeight:3,influenceBase:2.5,startingWealth:300,defaultResource:"spice",wealthElasticity:.7,maxConsumptionMultiplier:6,needs:{food:.75,cloth:.12},luxuryNeeds:{1:{spice:.12,ale:.12,culture:.08},1.8:{tools:.05},2.5:{coffee:.07,furniture:.07,culture:.15},3.5:{fine_clothes:.08,delicacies:.12,plank:.07},5:{copper:.05,steel:.03,culture:.25},7:{papyrus:.05},10:{brick:.08},14:{}},buffs:{satisfied:{desc:"海权扩张",gatherBonus:.1},dissatisfied:{desc:"航员哗变",gatherBonus:-.1,stability:-.1}}},scribe:{name:"学者",icon:"Feather",weight:2.5,tax:2,headTaxBase:.04,desc:"记录知识的学者，为图书馆与学院服务。",wealthWeight:2.5,influenceBase:1.5,startingWealth:250,defaultResource:"papyrus",wealthElasticity:1,maxConsumptionMultiplier:6,needs:{food:.85,cloth:.15},luxuryNeeds:{1:{papyrus:.1,furniture:.05,culture:.12},1.5:{coffee:.07},2:{fine_clothes:.05,plank:.025,culture:.25},3:{delicacies:.09,spice:.05},5:{copper:.035,brick:.025,culture:.35},7:{},10:{stone:.04},14:{cloth:.07},18:{steel:.015}},buffs:{satisfied:{desc:"文献井然",scienceBonus:.15},dissatisfied:{desc:"文献损失",scienceBonus:-.2}}},soldier:{name:"军人",icon:"Swords",weight:3,tax:1,headTaxBase:.04,desc:"维护国家安全，但也可能造成动荡。",wealthWeight:2,influenceBase:2,startingWealth:180,defaultResource:"tools",wealthElasticity:.6,maxConsumptionMultiplier:6,needs:{food:.85,cloth:.12},luxuryNeeds:{1:{ale:.08},1.5:{culture:.06},2:{tools:.07,copper:.025,iron:.02},2.5:{furniture:.05,spice:.05},3:{culture:.12},3.5:{fine_clothes:.07,delicacies:.07,steel:.025},5:{brick:.05,culture:.18},7:{coffee:.09,stone:.05},10:{},14:{}},buffs:{satisfied:{desc:"军心稳固",militaryPower:.2},dissatisfied:{desc:"军队哗变风险",militaryPower:-.3,stability:-.2}}},cleric:{name:"神职人员",icon:"Cross",weight:4,tax:.5,headTaxBase:.05,desc:"提供信仰和文化，安抚民心。",wealthWeight:3,influenceBase:3,startingWealth:220,defaultResource:"culture",wealthElasticity:.9,maxConsumptionMultiplier:6,needs:{food:.9,cloth:.15},luxuryNeeds:{1:{papyrus:.08,ale:.06,culture:.18},1.5:{plank:.02},2:{fine_clothes:.06,furniture:.06,stone:.04,culture:.3},3:{delicacies:.08,spice:.04},4.5:{copper:.04,brick:.04,culture:.4},6:{coffee:.05,steel:.01},8:{papyrus:.09},10:{}},buffs:{satisfied:{desc:"宗教和谐",cultureBonus:.2,stability:.1},dissatisfied:{desc:"信仰危机",cultureBonus:-.15,stability:-.1}}},official:{name:"官员",icon:"ScrollText",weight:5,tax:2,headTaxBase:.08,desc:"政府管理者。",wealthWeight:5,influenceBase:4,startingWealth:400,defaultResource:"science",wealthElasticity:2.5,maxConsumptionMultiplier:50,greedy:!0,needs:{food:1.2,cloth:.2},luxuryNeeds:{1:{delicacies:.5,papyrus:.12,coffee:.08,furniture:.1,stone:.04,fine_clothes:.1,culture:.25},1.3:{},1.8:{delicacies:.3,spice:.12,plank:.08,brick:.06},2:{culture:.4},2.5:{steel:.04,iron:.03,coal:.03},4:{papyrus:.08,copper:.04,stone:.04,culture:.55},6:{fine_clothes:.15},9:{},14:{},20:{}},buffs:{satisfied:{desc:"吏治清明",taxIncome:.1},dissatisfied:{desc:"官员腐败",taxIncome:-.2}}},landowner:{name:"地主",icon:"Castle",weight:10,tax:5,headTaxBase:.07,desc:"传统精英，掌控土地和农业。",wealthWeight:10,influenceBase:5,startingWealth:800,defaultResource:"food",wealthElasticity:1.4,maxConsumptionMultiplier:10,needs:{food:2,cloth:.3},luxuryNeeds:{1:{delicacies:.8,spice:.2,furniture:.18,brick:.1,plank:.1,fine_clothes:.15,culture:.3},1.3:{delicacies:.4,fine_clothes:.12},1.5:{culture:.45},1.8:{spice:.2,coffee:.1,stone:.08},2.5:{plank:.12,steel:.04,brick:.08,culture:.6},4:{copper:.06,papyrus:.04},6:{},9:{},14:{},20:{}},buffs:{satisfied:{desc:"贵族支持",taxIncome:.15,stability:.15},dissatisfied:{desc:"贵族叛乱",taxIncome:-.3,stability:-.25}}},capitalist:{name:"资本家",icon:"Briefcase",weight:15,tax:8,headTaxBase:.08,desc:"工业精英，提供投资和工业加成。",wealthWeight:20,influenceBase:6,startingWealth:1200,defaultResource:"steel",wealthElasticity:1.8,maxConsumptionMultiplier:10,needs:{food:2.5,cloth:.35},luxuryNeeds:{1:{delicacies:.7,coffee:.15,furniture:.15,steel:.05,culture:.35},1.3:{fine_clothes:.12},1.5:{culture:.5},1.8:{delicacies:.3,spice:.15,brick:.08},2.5:{stone:.06,plank:.1,coal:.04,iron:.03,culture:.7},4:{copper:.08,papyrus:.06},6:{},10:{},15:{},22:{}},buffs:{satisfied:{desc:"资本繁荣",industryBonus:.25,scienceBonus:.15},dissatisfied:{desc:"资本外逃",industryBonus:-.3,taxIncome:-.25}}},knight:{name:"骑士",icon:"Shield",weight:8,tax:2,headTaxBase:.09,desc:"军事贵族，强大的战斗力。",wealthWeight:8,influenceBase:4,startingWealth:600,defaultResource:"tools",wealthElasticity:1,maxConsumptionMultiplier:10,needs:{food:1.5,cloth:.25},luxuryNeeds:{1:{delicacies:.9,coffee:.1,furniture:.15,ale:.15,culture:.2},1.3:{delicacies:.4,fine_clothes:.1},1.5:{culture:.35},1.8:{spice:.12,steel:.04},2.5:{coffee:.08,brick:.06,stone:.04,culture:.5},4:{tools:.06,copper:.04,plank:.06},6:{},10:{},15:{},22:{}},buffs:{satisfied:{desc:"骑士忠诚",militaryPower:.25,stability:.1},dissatisfied:{desc:"骑士不满",militaryPower:-.2,stability:-.15}}},engineer:{name:"工程师",icon:"Cog",weight:7,tax:6,headTaxBase:.1,desc:"掌控蒸汽与机器的技术阶层。",wealthWeight:6,influenceBase:3.5,startingWealth:700,defaultResource:"steel",wealthElasticity:1.1,maxConsumptionMultiplier:10,needs:{food:1,cloth:.18},luxuryNeeds:{1:{coffee:.12,ale:.08,furniture:.1,culture:.18},1.3:{fine_clothes:.08},1.8:{delicacies:.15,spice:.08,tools:.06},2:{culture:.3},2.5:{plank:.08,copper:.04,stone:.04},4:{papyrus:.06,brick:.06,steel:.04,coal:.05,iron:.03,culture:.45},6:{},10:{},15:{},22:{}},buffs:{satisfied:{desc:"工艺革新",industryBonus:.2,scienceBonus:.1},dissatisfied:{desc:"技术流失",industryBonus:-.25}}},unemployed:{name:"失业者",icon:"AlertTriangle",weight:.2,tax:1,headTaxBase:.01,desc:"暂时没有工作的平民，如果得不到安排会渐渐不满。",wealthWeight:.2,influenceBase:.3,startingWealth:30,wealthElasticity:.3,maxConsumptionMultiplier:3,needs:{food:.4,cloth:.05},luxuryNeeds:{2.5:{ale:.04,food:.1},3.5:{furniture:.01},4.5:{plank:.01,culture:.004},5.5:{tools:.004},7:{spice:.008},9:{brick:.006}},buffs:{satisfied:{desc:"等待机会",stability:.02},dissatisfied:{desc:"失业动荡",stability:-.1}}}},io=[{id:"farm",name:"农田",desc:"提供自耕农岗位。",baseCost:{wood:12},output:{food:4.8},jobs:{peasant:3},owner:"peasant",epoch:0,cat:"gather",visual:{icon:"Wheat",color:"bg-yellow-700",text:"text-yellow-200"},marketConfig:{price:{livingCostWeight:.08,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.05}}},{id:"trading_post",name:"贸易站",desc:"原始的物资交换场所，提供商人岗位。",baseCost:{wood:50,stone:10},output:{food:4,silver:1.6},jobs:{merchant:2},owner:"merchant",epoch:0,cat:"civic",requiresTech:"barter",visual:{icon:"Handshake",color:"bg-amber-800",text:"text-amber-200"}},{id:"large_estate",name:"庄园",desc:"地主控制的土地，雇佣佃农。",baseCost:{wood:100,plank:25},output:{food:24},jobs:{serf:8,landowner:1},owner:"landowner",epoch:3,cat:"gather",requiresTech:"feudalism",visual:{icon:"Castle",color:"bg-amber-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05,wageMode:"subsistence",subsistenceMultiplier:1.5}}},{id:"lumber_camp",name:"伐木场",desc:"砍伐木材，基础采集建筑。",baseCost:{food:18},input:{},output:{wood:3.84},jobs:{lumberjack:3},owner:"lumberjack",epoch:0,cat:"gather",visual:{icon:"Trees",color:"bg-emerald-800",text:"text-emerald-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"quarry",name:"采石场",desc:"开采石料，基础采集建筑。",baseCost:{wood:55},input:{},output:{stone:3},jobs:{miner:3},owner:"miner",epoch:0,cat:"gather",visual:{icon:"Pickaxe",color:"bg-stone-600",text:"text-stone-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"copper_mine",name:"铜矿井",desc:"开采铜矿石，需要少量工具维护。",baseCost:{food:120,wood:120},input:{tools:.0267},output:{copper:.6667},jobs:{miner:4},owner:"miner",epoch:1,cat:"gather",requiresTech:"copper_mining",visual:{icon:"Gem",color:"bg-orange-700",text:"text-orange-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"reed_works",name:"造纸工坊",desc:"生产纸张的手工作坊。",baseCost:{food:140,wood:80},input:{wood:.75},output:{papyrus:.9},jobs:{worker:3},owner:"worker",epoch:2,cat:"industry",requiresTech:"papyrus_cultivation",visual:{icon:"ScrollText",color:"bg-lime-800",text:"text-lime-200"},marketConfig:{price:{livingCostWeight:.1,taxCostWeight:.15},wage:{livingCostWeight:.05,taxCostWeight:.05}}},{id:"culinary_kitchen",name:"烹饪坊",desc:"将粮食烹饪为珍馐，供上层阶级享用。",baseCost:{wood:100,stone:60,brick:30},input:{tools:.1333,food:2},output:{delicacies:2},jobs:{artisan:3,peasant:1},owner:"artisan",epoch:2,cat:"industry",requiresTech:"culinary_arts",visual:{icon:"UtensilsCrossed",color:"bg-rose-800",text:"text-rose-200"}},{id:"brewery",name:"酿造坊",desc:"将粮食发酵酿造成美酒，供贸易与享用。",baseCost:{wood:90,stone:50,brick:25},input:{food:1.8,wood:.3},output:{ale:1.8},jobs:{worker:3},owner:"worker",epoch:2,cat:"industry",requiresTech:"brewing",visual:{icon:"Wine",color:"bg-purple-800",text:"text-purple-200"},marketConfig:{price:{livingCostWeight:.4,taxCostWeight:.5},wage:{livingCostWeight:.25,taxCostWeight:.25}}},{id:"furniture_workshop",name:"家具工坊",desc:"将木板与布料雕刻成精美家具，提升上层阶级的生活品质。",baseCost:{plank:120,stone:80},input:{tools:.1333,plank:1.3333,cloth:.4},output:{furniture:1.6},jobs:{artisan:4},owner:"artisan",epoch:2,cat:"industry",requiresTech:"carpentry",visual:{icon:"Armchair",color:"bg-amber-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.4},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"loom_house",name:"织布坊",desc:"家庭式纺纱织布，保障民众衣物供应。",baseCost:{wood:35,food:20},output:{cloth:2.88},jobs:{worker:3},owner:"worker",epoch:0,cat:"industry",visual:{icon:"Shirt",color:"bg-indigo-800",text:"text-indigo-200"},marketConfig:{price:{livingCostWeight:.12,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"dye_works",name:"染坊",desc:"从植物中提取染料，用于制作高级织物。",baseCost:{wood:60,stone:20},input:{food:.75},output:{dye:.9},jobs:{worker:3},owner:"worker",epoch:1,cat:"industry",visual:{icon:"Paintbrush",color:"bg-pink-800",text:"text-pink-200"}},{id:"tailor_workshop",name:"成衣作坊",desc:"使用布料和染料制作精美的华服，供上层阶级享用。",baseCost:{wood:100,stone:40},input:{tools:.06,cloth:1.5,dye:.3},output:{fine_clothes:1.2,culture:.15},jobs:{artisan:3},owner:"artisan",epoch:1,cat:"industry",requiresTech:"tools",visual:{icon:"Package",color:"bg-indigo-900",text:"text-indigo-100"}},{id:"mine",name:"铁矿井",desc:"深入岩层采集铁矿，需要工具维护。",baseCost:{plank:120,food:220},input:{tools:.072},output:{iron:.9},jobs:{miner:9,capitalist:1},owner:"capitalist",epoch:2,cat:"gather",requiresTech:"ironworking",visual:{icon:"Mountain",color:"bg-zinc-700",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"coffee_plantation",name:"咖啡种植园",desc:"开垦远方殖民地的咖啡种植地。",baseCost:{wood:200,spice:30},output:{coffee:.6},jobs:{serf:6,merchant:1},owner:"merchant",epoch:5,cat:"gather",requiresTech:"coffee_agronomy",visual:{icon:"Coffee",color:"bg-amber-900",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.05,taxCostWeight:.05,wageMode:"subsistence",subsistenceMultiplier:1.3}}},{id:"coal_mine",name:"煤矿",desc:"开采地下煤炭，工业能源基石。",baseCost:{plank:200,tools:60},input:{tools:.2},output:{coal:1.3},jobs:{miner:12,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"coal_gasification",visual:{icon:"Flame",color:"bg-slate-700",text:"text-slate-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"hut",name:"简陋小屋",desc:"增加人口上限。",baseCost:{wood:20,food:20},output:{maxPop:3},epoch:0,cat:"civic",visual:{icon:"Tent",color:"bg-orange-800",text:"text-orange-200"}},{id:"house",name:"木屋",desc:"以木板与砖块搭建的整洁居所。",baseCost:{plank:60,brick:40},output:{maxPop:8},epoch:2,cat:"civic",requiresTech:"urban_planning",visual:{icon:"Home",color:"bg-amber-700",text:"text-amber-100"}},{id:"manor_house",name:"石砌宅邸",desc:"贵族风格的石砌住宅，坚固耐久，彰显领主权威。",baseCost:{brick:120,plank:80,iron:15},output:{maxPop:9},epoch:3,cat:"civic",requiresTech:"manor_architecture",visual:{icon:"Castle",color:"bg-blue-800",text:"text-blue-200"}},{id:"townhouse",name:"联排住宅",desc:"港口城市流行的多层联排建筑，高效利用城市空间。",baseCost:{brick:180,plank:120,tools:25},output:{maxPop:10},epoch:4,cat:"civic",requiresTech:"colonial_architecture",visual:{icon:"Building",color:"bg-cyan-800",text:"text-cyan-200"}},{id:"civic_apartment",name:"阁楼公馆",desc:"启蒙时代流行的多层砖石建筑，优雅的阁楼设计为新兴中产阶级提供舒适居所。",baseCost:{brick:250,plank:150,iron:40,furniture:20},output:{maxPop:11},epoch:5,cat:"civic",requiresTech:"enlightened_urbanism",visual:{icon:"Building2",color:"bg-purple-800",text:"text-purple-200"}},{id:"granary",name:"粮仓",desc:"加固的干燥粮仓，提升人口承载。",baseCost:{wood:120,brick:40,stone:30},output:{maxPop:6},epoch:1,cat:"civic",requiresTech:"granary_architecture",visual:{icon:"Boxes",color:"bg-yellow-900",text:"text-yellow-200"}},{id:"town_hall",name:"市政厅",desc:"官员办公地，提供官员岗位，需要少量维护。",baseCost:{brick:200,plank:200,cloth:20},input:{brick:.2,papyrus:.02,delicacies:.1,fine_clothes:.05,culture:.03},output:{},jobs:{official:7},epoch:3,cat:"civic",requiresTech:"bureaucracy",visual:{icon:"Scale",color:"bg-slate-800",text:"text-slate-200"}},{id:"church",name:"教堂",desc:"安抚民心，产出文化。",baseCost:{stone:150,plank:50,brick:60},input:{furniture:.1333,fine_clothes:.1333,brick:.0533},output:{culture:1.0667,silver:.6667},jobs:{cleric:4},owner:"cleric",epoch:3,cat:"civic",requiresTech:"theology",visual:{icon:"Cross",color:"bg-purple-900",text:"text-purple-200"}},{id:"monastery_cellar",name:"修道院酒窖",desc:"修道士传承的酿酒技艺，出产上等美酒，彰显宗教文化。",baseCost:{stone:120,brick:60,tools:15},input:{food:2.7,wood:.45},output:{ale:3,culture:.375},jobs:{cleric:1,worker:3},owner:"cleric",epoch:3,cat:"industry",requiresTech:"monastic_brewing",visual:{icon:"Wine",color:"bg-purple-800",text:"text-purple-200"}},{id:"wool_workshop",name:"纺织工场",desc:"规模化的羊毛加工作坊，封建领地的重要经济支柱。",baseCost:{plank:100,brick:50,tools:15},input:{food:.9,tools:.045},output:{cloth:4.8,fine_clothes:.3},jobs:{serf:4,worker:3},owner:"worker",epoch:3,cat:"industry",requiresTech:"wool_trade",visual:{icon:"Shirt",color:"bg-indigo-700",text:"text-indigo-200"},marketConfig:{price:{livingCostWeight:.12,taxCostWeight:.15},wage:{livingCostWeight:.08,taxCostWeight:.08,wageMode:"subsistence",subsistenceMultiplier:1.8}}},{id:"stone_workshop",name:"采石工场",desc:"使用铁器工具的专业采石场，为城堡和教堂建设提供大量优质石料。",baseCost:{plank:80,iron:30,tools:20},input:{tools:.075},output:{stone:4.375},jobs:{miner:4,worker:1},owner:"miner",epoch:3,cat:"gather",requiresTech:"masonry_guild",visual:{icon:"Pickaxe",color:"bg-stone-700",text:"text-stone-200"}},{id:"hardwood_camp",name:"硬木林场",desc:"有计划的森林采伐，提供大量木材与优质硬木。",baseCost:{plank:100,iron:25,tools:25},input:{tools:.096},output:{wood:5.76},jobs:{lumberjack:5,worker:1},owner:"lumberjack",epoch:3,cat:"gather",requiresTech:"forestry_management",visual:{icon:"Trees",color:"bg-emerald-900",text:"text-emerald-200"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"amphitheater",name:"剧场",desc:"古典时代的文化舞台，激发灵感。",baseCost:{stone:200,brick:80,dye:10},input:{fine_clothes:.225,brick:.045},output:{culture:1.8},jobs:{cleric:3},owner:"cleric",epoch:1,cat:"civic",requiresTech:"amphitheater_design",visual:{icon:"Music2",color:"bg-rose-900",text:"text-rose-200"}},{id:"navigator_school",name:"航海学院",desc:"培养探索时代的开路者，产出科研文化。",baseCost:{wood:160,papyrus:80,brick:70},output:{science:.75,culture:.25},jobs:{navigator:3,scribe:1,official:1},owner:"official",epoch:4,cat:"civic",requiresTech:"navigator_schooling",visual:{icon:"Navigation",color:"bg-cyan-900",text:"text-cyan-200"}},{id:"shaft_mine",name:"竖井矿场",desc:"利用绞盘与更好的通风设施深入地下，同时开采铜铁矿脉。",baseCost:{brick:150,plank:100,tools:50},input:{tools:.144,wood:.3},output:{iron:1.44,copper:.96},jobs:{miner:6,engineer:1},owner:"miner",epoch:4,cat:"gather",requiresTech:"advanced_metallurgy",visual:{icon:"Mountain",color:"bg-zinc-600",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"dye_workshop",name:"印染工坊",desc:"使用新世界染料的专业印染作坊，如珍贵的胭脂虫红。",baseCost:{brick:100,plank:80,tools:20},input:{food:1.2,cloth:.6,spice:.075},output:{dye:1.8,fine_clothes:.45},jobs:{artisan:3,worker:2},owner:"artisan",epoch:4,cat:"industry",requiresTech:"new_world_dyes",visual:{icon:"Paintbrush",color:"bg-rose-800",text:"text-rose-200"}},{id:"coffee_house",name:"咖啡馆",desc:"啜饮咖啡、交流思想的启蒙沙龙。",baseCost:{plank:140,coffee:40,cloth:20,delicacies:15,science:100},input:{coffee:.5333,delicacies:.2667},output:{culture:1.3333,science:1.3333},jobs:{merchant:1,scribe:3},owner:"merchant",epoch:5,cat:"civic",requiresTech:"coffeehouse_philosophy",visual:{icon:"Coffee",color:"bg-brown-900",text:"text-amber-200"}},{id:"rail_depot",name:"铁路枢纽",desc:"蒸汽时代的交通心脏，连接全国贸易，提供岗位和人口上限。",baseCost:{steel:180,coal:120,science:300},input:{coal:.72,ale:.36,delicacies:.18},output:{silver:2.7,maxPop:14},jobs:{engineer:4,merchant:3,capitalist:1},owner:"capitalist",epoch:6,cat:"civic",requiresTech:"rail_network",visual:{icon:"Train",color:"bg-gray-900",text:"text-gray-100"}},{id:"sawmill",name:"锯木厂",desc:"在铜制工具辅助下高效加工木板。",baseCost:{wood:75,stone:35},input:{wood:1.6},output:{plank:3.47},jobs:{worker:4},owner:"worker",epoch:1,requiresTech:"tools",cat:"industry",visual:{icon:"Hammer",color:"bg-amber-900",text:"text-amber-300"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"brickworks",name:"砖窯",desc:"烧制砖块，供城墙与民宅所用。",baseCost:{wood:140,stone:90},input:{stone:1.5,wood:.45},output:{brick:3.6},jobs:{worker:3},owner:"worker",epoch:0,cat:"industry",requiresTech:"pottery",visual:{icon:"Factory",color:"bg-red-900",text:"text-red-300"}},{id:"stone_tool_workshop",name:"石器作坊",desc:"用燧石和木料打制粗糙的工具。",baseCost:{wood:40,stone:25},input:{wood:1.5,stone:1.2},output:{tools:.75},jobs:{artisan:3},owner:"artisan",epoch:0,cat:"industry",requiresTech:"tool_making",visual:{icon:"Hammer",color:"bg-stone-700",text:"text-stone-200"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"bronze_foundry",name:"青铜铸坊",desc:"熔炼铜与木炭，制造精良工具。",baseCost:{wood:140,stone:75,copper:35},input:{copper:.8,wood:.5333},output:{tools:1.3333},jobs:{worker:3,artisan:1},owner:"artisan",epoch:1,cat:"industry",requiresTech:"bronze_working",visual:{icon:"Anvil",color:"bg-orange-800",text:"text-amber-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"iron_tool_workshop",name:"铁器铺",desc:"以铁为原料，锻造坚固耐用的工具。",baseCost:{plank:150,brick:80},input:{wood:.6667,iron:1.0667},output:{tools:2},jobs:{worker:3,artisan:1},owner:"artisan",epoch:2,cat:"industry",requiresTech:"ironworking",visual:{icon:"Cog",color:"bg-zinc-800",text:"text-zinc-200"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"factory",name:"工厂",desc:"蒸汽驱动的流水线生产工具与机械。",baseCost:{brick:400,steel:200,science:350},input:{steel:.4,coal:.4,science:.25},output:{tools:2.4},jobs:{worker:20,engineer:4,capitalist:1},owner:"capitalist",epoch:6,requiresTech:"industrialization",cat:"industry",visual:{icon:"Factory",color:"bg-blue-900",text:"text-blue-200"}},{id:"printing_house",name:"印刷所",desc:"启蒙时代的出版重镇，大量复制知识。",baseCost:{brick:200,papyrus:80,wood:60,science:150},input:{papyrus:.8,coffee:.2,brick:.08,science:.3},output:{science:2.4},jobs:{artisan:5,scribe:3,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"printing_press",visual:{icon:"BookOpen",color:"bg-indigo-900",text:"text-indigo-200"}},{id:"steel_foundry",name:"炼钢厂",desc:"以煤炭为燃料的炼钢炉，供应工业时代钢材。",baseCost:{brick:300,iron:200,science:280},input:{iron:.7,coal:.7,science:.2},output:{steel:.7},jobs:{engineer:5,worker:7,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"steel_alloys",visual:{icon:"Cog",color:"bg-gray-900",text:"text-gray-200"}},{id:"library",name:"图书馆",desc:"编目典籍，持续产出科研。",baseCost:{wood:200,stone:100},output:{science:1.0667},jobs:{scribe:4},owner:"scribe",epoch:0,cat:"civic",visual:{icon:"Landmark",color:"bg-cyan-800",text:"text-cyan-200"}},{id:"market",name:"市场",desc:"自动平衡市场供需：将盈余的滞销资源出口，换取急需的短缺资源。产出少量商业税收。",baseCost:{plank:100},input:{brick:.075},output:{food:3},jobs:{merchant:3},owner:"merchant",epoch:1,requiresTech:"caravan_trade",cat:"civic",visual:{icon:"Handshake",color:"bg-yellow-800",text:"text-yellow-200"}},{id:"magistrate_office",name:"官署",desc:"早期行政机构，管理青铜时代的税收与民政。提供少量官员岗位。",baseCost:{plank:80,stone:60,brick:40},input:{papyrus:.015,brick:.03},output:{},jobs:{official:3,scribe:1},epoch:1,cat:"civic",requiresTech:"early_administration",visual:{icon:"Scroll",color:"bg-slate-700",text:"text-slate-200"}},{id:"dockyard",name:"船坞",desc:"建造远洋船队，换取异域香料。",baseCost:{plank:200,tools:40},input:{wood:.6},output:{spice:.84},jobs:{navigator:3,worker:2,merchant:1},owner:"merchant",epoch:4,cat:"industry",requiresTech:"cartography",visual:{icon:"Anchor",color:"bg-sky-900",text:"text-sky-200"}},{id:"trade_port",name:"贸易港",desc:"汇聚香料、银币与海外特许的繁忙港口。",baseCost:{plank:220,spice:60},input:{spice:.4},output:{food:2.6667},jobs:{merchant:4},owner:"merchant",epoch:4,cat:"civic",requiresTech:"charter_companies",visual:{icon:"Ship",color:"bg-indigo-900",text:"text-indigo-200"}},{id:"barracks",name:"兵营",desc:"训练和驻扎军队的基地，提供军事容量。",baseCost:{wood:80,stone:40},output:{militaryCapacity:10},epoch:0,cat:"military",visual:{icon:"Shield",color:"bg-red-900",text:"text-red-200"}},{id:"training_ground",name:"训练场",desc:"专业的军事训练设施，大幅提升军事容量。",baseCost:{plank:150,brick:80,iron:30},output:{militaryCapacity:20},epoch:2,cat:"military",requiresTech:"military_training",visual:{icon:"Swords",color:"bg-red-800",text:"text-red-100"}},{id:"fortress",name:"要塞",desc:"坚固的军事堡垒，可容纳大量军队。",baseCost:{brick:300,iron:150,steel:50},output:{militaryCapacity:40},epoch:4,cat:"military",requiresTech:"fortification",visual:{icon:"Castle",color:"bg-red-950",text:"text-red-100"}},{id:"textile_mill",name:"纺织厂",desc:"水力驱动的纺织机，大幅提升布料和成衣产量。",baseCost:{brick:180,plank:120,tools:60,science:150},input:{food:2,dye:.75},output:{cloth:12.5,fine_clothes:1.5},jobs:{worker:15,artisan:4,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"mechanized_weaving",visual:{icon:"Shirt",color:"bg-indigo-700",text:"text-indigo-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"garment_factory",name:"服装工厂",desc:"蒸汽动力缝纫机的大规模成衣生产线。",baseCost:{brick:350,steel:150,tools:100,science:300},input:{cloth:3.75,dye:.75,coal:.45},output:{fine_clothes:4.2,culture:.45},jobs:{worker:18,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"assembly_line",visual:{icon:"Factory",color:"bg-indigo-900",text:"text-indigo-100"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"lumber_mill",name:"木材加工厂",desc:"水力锯木机与烘干设备，高效生产优质木板。",baseCost:{brick:160,plank:100,tools:50},input:{wood:6.4286},output:{plank:17.1429},jobs:{worker:10,artisan:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"hydraulic_sawing",visual:{icon:"Axe",color:"bg-amber-700",text:"text-amber-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.12,taxCostWeight:.12}}},{id:"furniture_factory",name:"家具工厂",desc:"流水线生产标准化家具，满足城市中产阶级需求。",baseCost:{brick:280,steel:120,tools:80,science:280},input:{plank:5.625,cloth:1.8,coal:.5625},output:{furniture:7.875,culture:.45},jobs:{worker:17,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"mass_production",visual:{icon:"Armchair",color:"bg-amber-900",text:"text-amber-100"},marketConfig:{price:{livingCostWeight:.28,taxCostWeight:.32},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"metallurgy_workshop",name:"冶金工坊",desc:"改良的熔炉与锻造技术，高效生产精良工具。",baseCost:{brick:200,iron:100,tools:60},input:{iron:1.7143,copper:.3429,wood:.9143},output:{tools:3.4286},jobs:{worker:5,artisan:2,engineer:1},owner:"artisan",epoch:4,cat:"industry",requiresTech:"advanced_metallurgy",visual:{icon:"Anvil",color:"bg-zinc-700",text:"text-zinc-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"steel_works",name:"钢铁联合体",desc:"垂直整合的大型钢铁企业，从矿石到成品一条龙生产。",baseCost:{brick:500,steel:250,tools:150,science:400},input:{iron:1.44,coal:1.2,science:.4},output:{steel:1.44,tools:.96},jobs:{worker:18,engineer:5,capitalist:2},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"bessemer_process",visual:{icon:"Factory",color:"bg-gray-800",text:"text-gray-100"},marketConfig:{price:{livingCostWeight:.3,taxCostWeight:.35},wage:{livingCostWeight:.2,taxCostWeight:.2}}},{id:"building_materials_plant",name:"建材厂",desc:"规模化生产砖块和预制建材，加速城市建设。",baseCost:{brick:200,plank:100,tools:50},input:{stone:4.5,wood:1.35,coal:.45},output:{brick:12.375},jobs:{worker:14,engineer:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"industrial_ceramics",visual:{icon:"Building2",color:"bg-red-800",text:"text-red-100"},marketConfig:{price:{livingCostWeight:.2,taxCostWeight:.25},wage:{livingCostWeight:.12,taxCostWeight:.12}}},{id:"prefab_factory",name:"预制构件厂",desc:"生产标准化建筑构件，革命性地改变建筑行业。",baseCost:{brick:400,steel:200,tools:100,science:350},input:{brick:3,steel:.4,stone:2,coal:.8},output:{brick:22},jobs:{worker:20,engineer:4,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"standardized_construction",visual:{icon:"Building",color:"bg-slate-700",text:"text-slate-100"},marketConfig:{price:{livingCostWeight:.28,taxCostWeight:.32},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"cannery",name:"罐头厂",desc:"革命性的食品保存技术，将珍馐装罐长期保存。",baseCost:{brick:250,steel:100,tools:60,science:280},input:{food:5.625,iron:.675,coal:.5625},output:{delicacies:7.875},jobs:{worker:17,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"food_preservation",visual:{icon:"Package",color:"bg-orange-800",text:"text-orange-100"},marketConfig:{price:{livingCostWeight:.22,taxCostWeight:.28},wage:{livingCostWeight:.14,taxCostWeight:.14}}},{id:"distillery",name:"蒸馏酒厂",desc:"工业化的酿酒设施，生产高度烈酒供出口贸易。",baseCost:{brick:220,copper:80,tools:50,science:140},input:{food:4.5,coal:.45},output:{ale:7.875,silver:1.8},jobs:{worker:12,artisan:2,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"distillation",visual:{icon:"Wine",color:"bg-purple-700",text:"text-purple-100"},marketConfig:{price:{livingCostWeight:.35,taxCostWeight:.4},wage:{livingCostWeight:.22,taxCostWeight:.22}}},{id:"paper_mill",name:"造纸厂",desc:"工业化造纸设备，用木浆大规模生产纸张。",baseCost:{brick:180,plank:100,tools:50,science:130},input:{wood:3,coal:.3},output:{papyrus:5},jobs:{worker:10,engineer:1,capitalist:1},owner:"capitalist",epoch:5,cat:"industry",requiresTech:"wood_pulp_process",visual:{icon:"ScrollText",color:"bg-lime-700",text:"text-lime-100"},marketConfig:{price:{livingCostWeight:.18,taxCostWeight:.22},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"publishing_house",name:"出版社",desc:"现代印刷与发行一体化，传播知识启迪民智。",baseCost:{brick:300,steel:80,papyrus:100,science:320},input:{papyrus:2,coffee:.4,coal:.3},output:{science:5,culture:2},jobs:{scribe:8,artisan:4,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"industry",requiresTech:"mass_media",visual:{icon:"Newspaper",color:"bg-cyan-800",text:"text-cyan-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.18,taxCostWeight:.18}}},{id:"industrial_mine",name:"工业矿场",desc:"蒸汽动力的深井采矿设备，大幅提升矿石产量。",baseCost:{brick:350,steel:200,tools:100},input:{tools:.2615,coal:.5231},output:{iron:2.9616,copper:.9577},jobs:{miner:17,engineer:2,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"deep_shaft_mining",visual:{icon:"Mountain",color:"bg-zinc-800",text:"text-zinc-100"},marketConfig:{price:{livingCostWeight:.25,taxCostWeight:.3},wage:{livingCostWeight:.15,taxCostWeight:.15}}},{id:"mechanized_farm",name:"机械化农场",desc:"蒸汽拖拉机与收割机，农业产量飞跃式提升。",baseCost:{brick:200,steel:150,tools:80},input:{tools:.175,coal:.35},output:{food:38.5},jobs:{peasant:8,worker:8,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"agricultural_machinery",visual:{icon:"Tractor",color:"bg-green-800",text:"text-green-100"},marketConfig:{price:{livingCostWeight:.18,taxCostWeight:.22},wage:{livingCostWeight:.1,taxCostWeight:.1}}},{id:"logging_company",name:"伐木公司",desc:"配备蒸汽锯和运输铁路的大型伐木企业。",baseCost:{brick:180,steel:100,tools:60},input:{tools:.1333,coal:.25},output:{wood:20},jobs:{lumberjack:11,worker:7,engineer:1,capitalist:1},owner:"capitalist",epoch:6,cat:"gather",requiresTech:"steam_logging",visual:{icon:"TreeDeciduous",color:"bg-emerald-700",text:"text-emerald-100"},marketConfig:{price:{livingCostWeight:.15,taxCostWeight:.2},wage:{livingCostWeight:.08,taxCostWeight:.08}}},{id:"apartment_block",name:"公寓楼",desc:"多层住宅建筑，容纳大量城市人口。",baseCost:{brick:400,steel:100,plank:150},output:{maxPop:11},epoch:6,cat:"civic",requiresTech:"urban_architecture",visual:{icon:"Building2",color:"bg-slate-600",text:"text-slate-100"}},{id:"university",name:"大学",desc:"高等学府，培养工程师和学者，产出大量科研。",baseCost:{brick:400,plank:200,papyrus:100,science:200},input:{papyrus:.36,coffee:.24,delicacies:.18,brick:.072,science:.5},output:{science:3.6,culture:.96},jobs:{scribe:5,engineer:2,official:2},owner:"official",epoch:5,cat:"civic",requiresTech:"higher_education",visual:{icon:"GraduationCap",color:"bg-blue-900",text:"text-blue-100"}},{id:"opera_house",name:"歌剧院",desc:"华丽的艺术殿堂，展示文明的文化成就。",baseCost:{brick:350,plank:150,furniture:80,culture:40,dye:20,science:160},input:{fine_clothes:.2857,delicacies:.2286,brick:.0571},output:{culture:4,silver:1.1429},jobs:{cleric:5,artisan:2,merchant:1},owner:"cleric",epoch:5,cat:"civic",requiresTech:"grand_arts",visual:{icon:"Music",color:"bg-rose-800",text:"text-rose-100"}},{id:"stock_exchange",name:"证券交易所",desc:"金融资本的神经中枢，调配全国资金流向。",baseCost:{brick:500,steel:150,papyrus:100,science:400},input:{papyrus:.32,coffee:.24},output:{silver:8,culture:.8},jobs:{merchant:10,scribe:3,capitalist:2},owner:"capitalist",epoch:6,cat:"civic",requiresTech:"financial_capitalism",visual:{icon:"TrendingUp",color:"bg-emerald-900",text:"text-emerald-100"}}],$n=[{id:"barter",name:"物物交换",desc:"允许建造贸易站，让商人阶层登上历史舞台。财政收入 +2%。",cost:{science:150},epoch:0,effects:{incomePercent:.02}},{id:"stone_axes",name:"磨制石斧",desc:"伐木场产出提升 25%。",cost:{science:150},epoch:0,effects:{buildings:{lumber_camp:.12}}},{id:"flint_knapping",name:"打制燧石",desc:"采石场效率增加 25%。",cost:{science:210},epoch:0,effects:{buildings:{quarry:.12}}},{id:"animal_husbandry",name:"畜牧业",desc:"驯养牲畜，每人每日额外获得 0.1 粮食。",cost:{science:240},epoch:0,effects:{perPopPassive:{food:.1}}},{id:"pottery",name:"陶器",desc:"农田储粮效率 +10%。",cost:{science:300},epoch:0,effects:{buildings:{farm:.05}}},{id:"tool_making",name:"工具制作",desc:"解锁石器作坊，提供早期稳定的工具来源。采集建筑效率 +10%。",cost:{science:270},epoch:0,effects:{categories:{gather:.05}}},{id:"basic_irrigation",name:"基础灌溉",desc:"开凿浅渠把河水引入农田，产量提升 15%。",cost:{science:360},epoch:0,effects:{buildings:{farm:.08}}},{id:"oral_tradition",name:"口述传统",desc:"长者口述史诗，图书馆的整理效率提升 15%。",cost:{science:330},epoch:0,effects:{buildings:{library:.08}}},{id:"communal_granary",name:"公共粮仓",desc:"人口上限 +10%。",cost:{science:390},epoch:0,effects:{maxPop:.1}},{id:"river_fishing",name:"河湾捕鱼",desc:"每人每日额外获得 0.05 粮食，财政收入 +1%。",cost:{science:450},epoch:0,effects:{perPopPassive:{food:.05},incomePercent:.01}},{id:"wheel",name:"车轮",desc:"采集建筑整体效率 +20%。",cost:{science:480},epoch:0,effects:{categories:{gather:.1}}},{id:"sailing",name:"航海术",desc:"解锁船坞建设，开启海上贸易与军事行动。财政收入 +3%，每人每日获得 0.02 粮食。",cost:{science:1050},epoch:1,effects:{incomePercent:.03,perPopPassive:{food:.02}}},{id:"tools",name:"铜制工具",desc:"允许建造锯木厂，工业效率 +5%。",cost:{science:750},epoch:1,effects:{categories:{industry:.03}}},{id:"copper_mining",name:"铜脉勘探",desc:"解锁铜矿开采。",cost:{science:840},epoch:1,effects:{}},{id:"bronze_working",name:"青铜冶炼",desc:"青铜铸坊产出 +30%，铁矿井同步获得 +15%。",cost:{science:960},epoch:1,effects:{buildings:{bronze_foundry:.15,mine:.08}}},{id:"horse_collar",name:"牛项圈",desc:"农田与庄园增产 10%。",cost:{science:780},epoch:1,effects:{buildings:{farm:.05,large_estate:.05}}},{id:"caravan_trade",name:"驼队贸易",desc:"市场银币收入 +35%。",cost:{science:900},epoch:1,effects:{buildings:{market:.18}}},{id:"granary_architecture",name:"粮仓结构",desc:"粮仓产出 +25%，并额外提供 +5% 人口上限。",cost:{science:960},epoch:1,effects:{buildings:{granary:.12},maxPop:.05}},{id:"primitive_weaving",name:"原始纺织",desc:"使用简易织机将羊毛加工为布料。织布坊效率 +10%。",cost:{science:820},epoch:1,effects:{buildings:{loom_house:.05}}},{id:"early_administration",name:"早期行政",desc:"解锁官署，建立初步的税收与民政管理体系。启用官员系统，官员容量 +2。",cost:{science:880},epoch:1,effects:{categories:{civic:.05}}},{id:"papyrus_cultivation",name:"改进造纸术",desc:"造纸工坊效率 +20%。",cost:{science:1575},epoch:2,effects:{buildings:{reed_works:.12}}},{id:"culinary_arts",name:"烹饪艺术",desc:"解锁烹饪坊，将粮食加工为珍馐，满足上层阶级的饮食需求。",cost:{science:1680},epoch:2,effects:{}},{id:"brewing",name:"酿造工艺",desc:"解锁酿造坊，将粮食发酵为美酒，供贸易与享用。",cost:{science:1610},epoch:2,effects:{}},{id:"carpentry",name:"精细木工",desc:"解锁家具工坊，将木材与石料加工为精美家具，提升上层阶级的生活品质。",cost:{science:1750},epoch:2,effects:{}},{id:"library_catalogs",name:"图书编目",desc:"图书馆科研 +25%。",cost:{science:1645},epoch:2,effects:{buildings:{library:.15}}},{id:"amphitheater_design",name:"剧场设计",desc:"解锁剧场建筑。",cost:{science:1470},epoch:1,effects:{}},{id:"urban_planning",name:"城市规划",desc:"木屋效率 +20%，人口上限 +5%。",cost:{science:1820},epoch:2,effects:{buildings:{house:.12},maxPop:.05}},{id:"republican_code",name:"共和法典",desc:"完善的法律体系提升社会运转效率。民生建筑效率 +15%，人口上限 +5%。",cost:{science:1960},epoch:2,effects:{categories:{civic:.09},maxPop:.05}},{id:"road_system",name:"道路网络",desc:"采集作业效率 +10%。",cost:{science:2100},epoch:2,effects:{categories:{gather:.06}}},{id:"advanced_weaving",name:"高级纺织",desc:"改进织布工具和织机设计，提升纺织效率。织布坊效率 +20%。",cost:{science:1950},epoch:2,effects:{buildings:{loom_house:.12}}},{id:"feudalism",name:"封建制度",desc:"庄园耕作效率 +15%。",cost:{science:3500},epoch:3,effects:{buildings:{large_estate:.09}}},{id:"basic_weaving",name:"织布机",desc:"新型的纺织工具。织布坊效率 +25%。",cost:{science:3150},epoch:3,effects:{buildings:{loom_house:.15}}},{id:"theology",name:"神学",desc:"教堂文化产出 +30%。",cost:{science:3850},epoch:3,effects:{buildings:{church:.18}}},{id:"bureaucracy",name:"官僚制度",desc:"解锁市政厅，建立高效的行政管理体系。采集、工业、市政建筑效率 +5%，每人每日获得 0.002 文化。官员容量 +3。",cost:{science:4200},epoch:3,effects:{categories:{gather:.03,industry:.03,civic:.03},perPopPassive:{culture:.002}}},{id:"civil_service",name:"文官制度",desc:"建立系统化的文官选拔与考核体系，提升行政效率。税收收入 +5%，官员容量 +3。",cost:{science:8750},epoch:4,effects:{incomePercent:.05}},{id:"administrative_reform",name:"行政改革",desc:"改革行政体系，提升官僚机构运转效率。民生建筑效率 +10%，官员容量 +4。",cost:{science:18900},epoch:5,effects:{categories:{civic:.07}}},{id:"centralization",name:"中央集权",desc:"加强中央政府权威，统一政令。税收收入 +8%，稳定度 +5%，官员容量 +2。",cost:{science:27900},epoch:6,effects:{incomePercent:.08}},{id:"three_field_system",name:"三圃制",desc:"农田与庄园额外 +15% 产量。",cost:{science:3850},epoch:3,effects:{buildings:{farm:.09,large_estate:.09}}},{id:"stone_keep_engineering",name:"石垒堡舍",desc:"居住建筑人口上限加成 10%。",cost:{science:4025},epoch:3,effects:{buildings:{hut:.06,house:.06}}},{id:"manor_architecture",name:"庄园建筑学",desc:"解锁石砌宅邸，贵族风格的坚固住宅，提供更多人口容量。宅邸效率 +15%，人口上限 +5%。",cost:{science:4550},epoch:3,effects:{buildings:{manor_house:.15},maxPop:.05}},{id:"monastic_brewing",name:"修道院酿造",desc:"解锁修道院酒窖，修士传承的高级酿酒工艺。酒窖效率 +15%，教堂文化 +10%。",cost:{science:4200},epoch:3,effects:{buildings:{monastery_cellar:.15,church:.1}}},{id:"wool_trade",name:"羊毛贸易",desc:"解锁纺织工场，封建时代最重要的纺织产业。纺织工场效率 +15%，织布坊效率 +10%。",cost:{science:3850},epoch:3,effects:{buildings:{wool_workshop:.15,loom_house:.1}}},{id:"masonry_guild",name:"石匠行会",desc:"解锁采石工场，行会组织的专业采石作业。采石工场效率 +15%，采石场效率 +10%。",cost:{science:4025},epoch:3,effects:{buildings:{stone_workshop:.15,quarry:.1}}},{id:"forestry_management",name:"林业管理",desc:"解锁硬木林场，有计划的森林采伐与维护。硬木林场效率 +15%，伐木场效率 +10%。",cost:{science:3675},epoch:3,effects:{buildings:{hardwood_camp:.15,lumber_camp:.1}}},{id:"ritual_priesthood",name:"仪式司祭",desc:"礼拜设施文化产出提升 15%。",cost:{science:1190},epoch:3,effects:{buildings:{church:.09}}},{id:"ironworking",name:"锻铁术",desc:"解锁铁器铺，并且铁矿井效率 +30%。",cost:{science:1500},epoch:2,effects:{buildings:{mine:.18}}},{id:"cartography",name:"海图绘制",desc:"船坞香料获取 +25%。",cost:{science:6300},epoch:4,effects:{buildings:{dockyard:.18}}},{id:"charter_companies",name:"特许公司",desc:"贸易港银币产出 +30%，财政收入 +5%。",cost:{science:6650},epoch:4,effects:{buildings:{trade_port:.21},incomePercent:.05}},{id:"navigator_schooling",name:"领航学",desc:"航海学院科研提升 30%。",cost:{science:7e3},epoch:4,effects:{buildings:{navigator_school:.21}}},{id:"naval_artillery",name:"舰炮试验",desc:"船坞额外获得 15% 产量。",cost:{science:7350},epoch:4,effects:{buildings:{dockyard:.1}}},{id:"colonial_ledgers",name:"殖民档案",desc:"系统化的殖民地档案管理，提升海外贸易效率。船坞和贸易港效率 +20%，财政收入 +5%。",cost:{science:7700},epoch:4,effects:{buildings:{dockyard:.14,trade_port:.14},incomePercent:.05}},{id:"spice_monopolies",name:"香料垄断",desc:"贸易港再获 15% 产量。",cost:{science:8050},epoch:4,effects:{buildings:{trade_port:.1}}},{id:"colonial_architecture",name:"殖民建筑",desc:"解锁联排住宅，港口城市流行的高效多层建筑。联排住宅效率 +15%，人口上限 +5%。",cost:{science:8400},epoch:4,effects:{buildings:{townhouse:.15},maxPop:.05}},{id:"new_world_dyes",name:"新世界染料",desc:"解锁印染工坊，使用胭脂虫红等新世界珍贵染料。印染工坊效率 +15%，染坊效率 +10%。",cost:{science:7875},epoch:4,effects:{buildings:{dye_workshop:.15,dye_works:.1}}},{id:"coffee_agronomy",name:"咖啡栽培学",desc:"解锁咖啡种植园。",cost:{science:14400},epoch:5,effects:{}},{id:"coffeehouse_philosophy",name:"咖啡馆哲学",desc:"解锁咖啡馆，每人每日获得 0.002 文化。",cost:{science:15300},epoch:5,effects:{perPopPassive:{culture:.002}}},{id:"printing_press",name:"印刷机",desc:"解锁印刷所。",cost:{science:16200},epoch:5,effects:{}},{id:"public_schooling",name:"公共教育",desc:"图书馆 +25% 科研，每人每日获得 0.001 文化。",cost:{science:17100},epoch:5,effects:{buildings:{library:.18},perPopPassive:{culture:.001}}},{id:"social_contract",name:"社会契约",desc:"启蒙思想推动社会进步。民生建筑效率 +20%，人口上限 +5%，每人每日获得 0.003 文化。",cost:{science:18e3},epoch:5,effects:{categories:{civic:.14},maxPop:.05,perPopPassive:{culture:.003}}},{id:"salon_debates",name:"沙龙辩论",desc:"剧场文化再增 15%。",cost:{science:18900},epoch:5,effects:{buildings:{amphitheater:.1}}},{id:"enlightened_urbanism",name:"启蒙城市主义",desc:"解锁阁楼公馆，兼具优雅与实用的新式住宅区。阁楼公馆效率 +15%，人口上限 +6%。",cost:{science:19800},epoch:5,effects:{buildings:{civic_apartment:.15},maxPop:.06}},{id:"coal_gasification",name:"煤气化",desc:"解锁煤矿开采。",cost:{science:23400},epoch:6,effects:{}},{id:"steel_alloys",name:"钢合金",desc:"解锁炼钢厂。",cost:{science:24300},epoch:6,effects:{}},{id:"industrialization",name:"工业化",desc:"解锁工厂，工业建筑效率 +10%。",cost:{science:27e3},epoch:6,effects:{categories:{industry:.07}}},{id:"steam_power",name:"蒸汽动力",desc:"工业建筑再获 +20% 产量。",cost:{science:28800},epoch:6,effects:{categories:{industry:.14}}},{id:"chemical_fertilizer",name:"化学施肥",desc:"农田与庄园 +20% 产出。",cost:{science:27e3},epoch:6,effects:{buildings:{farm:.14,large_estate:.14}}},{id:"rail_network",name:"铁路网",desc:"铁路枢纽效率 +30%，采集 +10%。",cost:{science:27900},epoch:6,effects:{buildings:{rail_depot:.21},categories:{gather:.07}}},{id:"precision_tools",name:"精密机具",desc:"工厂产出 +25%。",cost:{science:28800},epoch:6,effects:{buildings:{factory:.18}}},{id:"military_training",name:"军事训练",desc:"解锁训练场，提供更多军事容量。军事建筑效率 +15%。",cost:{science:2800},epoch:2,effects:{categories:{military:.1}}},{id:"fortification",name:"要塞工程",desc:"解锁要塞，大幅提升军事容量。军事建筑效率 +25%，人口上限 +5%。",cost:{science:8400},epoch:4,effects:{categories:{military:.18},maxPop:.05}},{id:"mechanized_weaving",name:"机械织布",desc:"解锁织布坊和成衣作坊，水力驱动的飞梭织机大幅提升布料产量。织布坊效率 +20%，成衣作坊效率 +15%。",cost:{science:13500},epoch:5,effects:{buildings:{loom_house:.14,tailor_workshop:.1}}},{id:"assembly_line",name:"流水线生产",desc:"解锁纺织厂和服装工厂，标准化分工使产量大幅提升。纺织厂效率 +25%，服装工厂效率 +20%。",cost:{science:26100},epoch:6,effects:{buildings:{textile_mill:.18,garment_factory:.14}}},{id:"hydraulic_sawing",name:"水力锯切",desc:"解锁锯木厂和伐木场升级，水轮驱动的圆锯效率远超手工。锯木厂效率 +25%，伐木场效率 +15%。",cost:{science:12600},epoch:5,effects:{buildings:{sawmill:.18,lumber_camp:.1}}},{id:"mass_production",name:"大规模生产",desc:"解锁木材加工厂和家具工坊，标准化零件实现批量生产。木材加工厂效率 +20%，家具工坊效率 +25%。",cost:{science:25200},epoch:6,effects:{buildings:{lumber_mill:.14,furniture_workshop:.18}}},{id:"advanced_metallurgy",name:"先进冶金",desc:"解锁竖井矿场，改良熔炉与合金配方提升工具质量。铁器铺效率 +20%，青铜铸坊效率 +15%。",cost:{science:7700},epoch:4,effects:{buildings:{iron_tool_workshop:.14,bronze_foundry:.1}}},{id:"bessemer_process",name:"贝塞麦炼钢法",desc:"解锁炼钢厂和冶金工坊，吹入空气快速去碳，钢铁产量剧增。炼钢厂效率 +30%，冶金工坊效率 +25%。",cost:{science:27900},epoch:6,effects:{buildings:{steel_foundry:.21,metallurgy_workshop:.18}}},{id:"industrial_ceramics",name:"工业陶瓷",desc:"解锁砖窯升级，环形窑与传送带实现连续烧制。砖窯效率 +25%。",cost:{science:11700},epoch:5,effects:{buildings:{brickworks:.18}}},{id:"standardized_construction",name:"标准化建筑",desc:"解锁建材厂，预制构件加速建设、降低成本。建材厂效率 +25%，人口上限 +5%。",cost:{science:24300},epoch:6,effects:{buildings:{building_materials_plant:.18},maxPop:.05}},{id:"food_preservation",name:"食品保鲜",desc:"解锁罐头厂，密封罐装技术延长食品保质期。",cost:{science:22500},epoch:6,effects:{buildings:{culinary_kitchen:.18}}},{id:"distillation",name:"蒸馏技术",desc:"解锁蒸馏酒厂，分离提纯出高度烈酒。",cost:{science:14400},epoch:5,effects:{buildings:{brewery:.21}}},{id:"wood_pulp_process",name:"木浆造纸",desc:"解锁造纸厂，木材纤维取代手工纸浆，产量倍增。",cost:{science:13050},epoch:5,effects:{buildings:{reed_works:.21}}},{id:"mass_media",name:"大众传媒",desc:"解锁印刷所和出版社，报纸杂志覆盖全民，舆论力量崛起。印刷所效率 +30%，出版社效率 +20%。",cost:{science:24750},epoch:6,effects:{buildings:{printing_house:.21,publishing_house:.14}}},{id:"deep_shaft_mining",name:"深井采矿",desc:"解锁工业矿场，蒸汽泵排水、铁轨运矿，开采深层矿脉。",cost:{science:23400},epoch:6,effects:{buildings:{mine:.18,coal_mine:.14}}},{id:"agricultural_machinery",name:"农业机械",desc:"解锁机械化农场，蒸汽拖拉机与收割机解放大量人力。",cost:{science:25200},epoch:6,effects:{buildings:{farm:.18,large_estate:.21}}},{id:"steam_logging",name:"蒸汽伐木",desc:"解锁伐木公司，蒸汽锯与窄轨铁路运输原木。",cost:{science:22500},epoch:6,effects:{buildings:{lumber_camp:.21}}},{id:"higher_education",name:"高等教育",desc:"解锁大学，系统化培养专业人才。",cost:{science:15750},epoch:5,effects:{buildings:{library:.14,navigator_school:.14}}},{id:"grand_arts",name:"高雅艺术",desc:"解锁歌剧院，戏剧与音乐的殿堂。",cost:{science:17100},epoch:5,effects:{buildings:{amphitheater:.18,church:.1}}},{id:"urban_architecture",name:"城市建筑学",desc:"解锁公寓楼，多层建筑容纳更多城市人口。人口上限 +6%。",cost:{science:26100},epoch:6,effects:{buildings:{house:.14},maxPop:.06}},{id:"financial_capitalism",name:"金融资本主义",desc:"解锁证券交易所，股票与债券调配社会资本。贸易港效率 +20%，铁路枢纽效率 +15%，财政收入 +8%。",cost:{science:29250},epoch:6,effects:{buildings:{trade_port:.14,rail_depot:.1},incomePercent:.08}}],Gn=(e,o)=>{const i={0:{light:["militia","slinger"],medium:["militia","slinger"],heavy:["militia","slinger"]},1:{light:["militia","slinger","spearman"],medium:["spearman","archer","chariot"],heavy:["spearman","archer","chariot"]},2:{light:["spearman","archer","light_cavalry"],medium:["hoplite","composite_archer","light_cavalry"],heavy:["hoplite","composite_archer","light_cavalry","battering_ram"]},3:{light:["heavy_infantry","crossbowman","knight"],medium:["heavy_infantry","crossbowman","knight","trebuchet"],heavy:["heavy_infantry","crossbowman","knight","trebuchet"]},4:{light:["pikeman","arquebus","cuirassier"],medium:["pikeman","arquebus","cuirassier","bombard"],heavy:["pikeman","arquebus","cuirassier","bombard"]},5:{light:["musketeer","dragoon"],medium:["musketeer","rifleman","dragoon","cannon"],heavy:["musketeer","rifleman","dragoon","cannon"]},6:{light:["line_infantry","lancer"],medium:["line_infantry","gatling","lancer","artillery"],heavy:["line_infantry","gatling","lancer","artillery"]}},n=i[Math.min(e,6)]||i[0];return n[o]||n.medium},Oi={farm:[{name:"灌溉田",cost:{wood:50,stone:20,tools:5,silver:300},input:{tools:.04,wood:.06},output:{food:6.24},jobs:{peasant:3}},{name:"精耕田",cost:{plank:80,brick:40,tools:15,silver:800},input:{tools:.08,wood:.1},output:{food:10.8},jobs:{peasant:4}}],lumber_camp:[{name:"大伐木场",cost:{wood:80,stone:30,tools:10,silver:250},input:{tools:.05,food:.15},output:{wood:4.992},jobs:{lumberjack:3}},{name:"林场",cost:{plank:60,brick:30,tools:20,silver:600},input:{tools:.1},output:{wood:8.64,food:.15},jobs:{lumberjack:4}}],quarry:[{name:"深坑采石场",cost:{wood:80,stone:50,tools:15,silver:300},input:{tools:.06,wood:.15,food:.15},output:{stone:3.9},jobs:{miner:3}},{name:"大采石场",cost:{plank:80,stone:100,tools:30,silver:700},input:{tools:.12,wood:.25,food:.25},output:{stone:6.75,copper:.02},jobs:{miner:4}}],loom_house:[{name:"织布坊",cost:{wood:80,stone:40,tools:10,silver:250},input:{tools:.02},output:{cloth:2.5},jobs:{worker:3}},{name:"大织布坊",cost:{plank:60,brick:40,tools:20,silver:600},input:{tools:.04,dye:.03},output:{cloth:4.32,culture:.05},jobs:{worker:4}}],brickworks:[{name:"改良砖窑",cost:{stone:80,wood:40,tools:15,silver:300},input:{stone:1,wood:.35,tools:.02},output:{brick:3.12},jobs:{worker:3}},{name:"大砖窑",cost:{stone:120,brick:80,tools:30,silver:700},input:{stone:1.5,wood:.5,tools:.04},output:{brick:5.4,tools:.02},jobs:{worker:4}}],stone_tool_workshop:[{name:"工匠铺",cost:{stone:50,wood:50,silver:200},input:{wood:1.65,stone:1.35},output:{tools:.975},jobs:{artisan:3}},{name:"大工匠铺",cost:{brick:40,plank:40,silver:500},input:{wood:2.25,stone:1.8},output:{tools:1.35},jobs:{artisan:3}}],trading_post:[{name:"商铺",cost:{wood:100,stone:40,silver:400},input:{tools:.01},output:{food:5.2,silver:2.08},jobs:{merchant:2}},{name:"商会",cost:{plank:80,brick:60,silver:900},input:{tools:.02,papyrus:.01},output:{food:9,silver:3.6,spice:.02},jobs:{merchant:3}}],library:[{name:"学堂",cost:{stone:150,plank:40,papyrus:30,brick:40,silver:600,science:80},input:{papyrus:.08},output:{science:1.3867},jobs:{scribe:4}},{name:"书院",cost:{brick:120,plank:60,papyrus:80,silver:1400,science:200},input:{papyrus:.15,science:.15},output:{science:2.4,culture:.12},jobs:{scribe:5}}],copper_mine:[{name:"深铜矿",cost:{wood:120,tools:20,silver:350},input:{tools:.05,wood:.2,food:.2},output:{copper:.8667},jobs:{miner:4}},{name:"大铜矿",cost:{plank:80,tools:40,silver:800},input:{tools:.1,wood:.35,food:.35},output:{copper:1.5,stone:.15},jobs:{miner:5}}],dye_works:[{name:"大染坊",cost:{wood:60,stone:25,tools:10,silver:250},input:{food:.6,tools:.02},output:{dye:1.17},jobs:{worker:3}},{name:"染色工坊",cost:{plank:50,brick:30,tools:20,silver:600},input:{food:.9,tools:.04,cloth:.05},output:{dye:2.025,culture:.05},jobs:{worker:4}}],sawmill:[{name:"水力锯木坊",cost:{wood:120,stone:40,tools:15,silver:350},input:{wood:1.4,tools:.03},output:{plank:4.511},jobs:{worker:4}},{name:"大锯木坊",cost:{plank:80,brick:50,tools:30,silver:800},input:{wood:2,tools:.06,cloth:.05},output:{plank:7.8075,furniture:.05},jobs:{worker:5}}],bronze_foundry:[{name:"改良铸坊",cost:{stone:60,copper:25,silver:300},input:{copper:.75,wood:.45,tools:.015},output:{tools:1.95},jobs:{worker:3,artisan:1}},{name:"大铸坊",cost:{brick:50,copper:40,silver:700},input:{copper:1.05,wood:.675,tools:.03},output:{tools:2.7},jobs:{worker:3,artisan:1}}],amphitheater:[{name:"大剧场",cost:{stone:120,brick:40,silver:400},input:{fine_clothes:.06},output:{culture:1.56,silver:.8},jobs:{cleric:2}},{name:"宏伟剧场",cost:{brick:80,furniture:20,silver:900},input:{fine_clothes:.08,ale:.03},output:{culture:2.16,silver:1.5},jobs:{cleric:2}}],reed_works:[{name:"改良造纸坊",cost:{wood:60,tools:10,silver:220},input:{tools:.01},output:{papyrus:1.17},jobs:{worker:3}},{name:"大造纸坊",cost:{plank:50,tools:20,silver:500},input:{tools:.02},output:{papyrus:2.025,science:.05},jobs:{worker:4}}],culinary_kitchen:[{name:"精致厨房",cost:{brick:40,tools:15,cloth:8,silver:350},input:{tools:.08,food:1.2},output:{delicacies:2.6},jobs:{artisan:3,peasant:1}},{name:"御膳房",cost:{brick:60,furniture:15,delicacies:20,silver:800},input:{tools:.12,food:1.8,spice:.06},output:{delicacies:4.5,culture:.08},jobs:{artisan:3,peasant:2}}],brewery:[{name:"大酒坊",cost:{brick:30,tools:12,cloth:6,silver:280},input:{food:1,wood:.15,tools:.01},output:{ale:2.34},jobs:{worker:3}},{name:"酿酒工坊",cost:{brick:50,tools:25,dye:10,ale:15,silver:650},input:{food:1.5,wood:.25,tools:.02,spice:.03},output:{ale:4.05,culture:.05},jobs:{worker:4}}],furniture_workshop:[{name:"精工家具坊",cost:{plank:80,tools:20,silver:400},input:{tools:.08,plank:1,cloth:.25},output:{furniture:2.08},jobs:{artisan:4}},{name:"大家具坊",cost:{plank:120,furniture:15,silver:900},input:{tools:.12,plank:1.5,cloth:.35},output:{furniture:3.6},jobs:{artisan:5}}],tailor_workshop:[{name:"高级成衣坊",cost:{plank:50,tools:15,silver:350},input:{tools:.035,cloth:.85,dye:.17},output:{fine_clothes:1.04,culture:.13},jobs:{artisan:3}},{name:"御用成衣坊",cost:{brick:40,fine_clothes:10,silver:800},input:{tools:.05,cloth:1.3,dye:.25},output:{fine_clothes:1.8,culture:.225},jobs:{artisan:4}}],mine:[{name:"深井铁矿",cost:{plank:80,tools:25,silver:400},input:{tools:.08,wood:.2,food:.3},output:{iron:1.65},jobs:{miner:7,capitalist:1}},{name:"大铁矿",cost:{brick:60,tools:40,silver:900},input:{tools:.15,wood:.35,food:.45},output:{iron:2.86,coal:.05},jobs:{miner:9,capitalist:1}}],iron_tool_workshop:[{name:"精铁工坊",cost:{brick:60,iron:30,silver:400},input:{wood:.6,iron:.975,tools:.015},output:{tools:2.925},jobs:{worker:3,artisan:1}},{name:"大铁匠铺",cost:{brick:100,iron:50,silver:900},input:{wood:.9,iron:1.5,tools:.03},output:{tools:4.05},jobs:{worker:3,artisan:1}}],large_estate:[{name:"繁荣庄园",cost:{plank:60,tools:20,silver:400},input:{tools:.1,wood:.15},output:{food:23.4},jobs:{serf:8,landowner:1}},{name:"领主庄园",cost:{brick:50,furniture:15,silver:900},input:{tools:.18,wood:.25,cloth:.05},output:{food:40.5,cloth:.1,ale:.03},jobs:{serf:9,landowner:1}}],church:[{name:"大教堂",cost:{brick:80,furniture:25,silver:500},input:{furniture:.05,fine_clothes:.04},output:{culture:1.04,silver:1.2},jobs:{cleric:3}},{name:"主教座堂",cost:{brick:150,furniture:40,silver:1200},input:{furniture:.06,fine_clothes:.05,papyrus:.02},output:{culture:1.44,silver:2,science:.15},jobs:{cleric:4}}],monastery_cellar:[{name:"修道院大酒窖",cost:{stone:80,tools:20,silver:400},input:{food:2,wood:.35},output:{ale:2.6,culture:.33},jobs:{cleric:1,worker:3}},{name:"酿酒修道院",cost:{brick:100,furniture:20,silver:900},input:{food:2.7,wood:.5},output:{ale:4.5,culture:.56,science:.08},jobs:{cleric:2,worker:2}}],wool_workshop:[{name:"大纺织工场",cost:{plank:80,tools:20,silver:380},input:{food:.7,tools:.04},output:{cloth:4.16,fine_clothes:.26},jobs:{serf:4,worker:3}},{name:"领主纺织工场",cost:{brick:60,tools:35,silver:850},input:{food:1,tools:.06,dye:.05},output:{cloth:7.2,fine_clothes:.45,culture:.05},jobs:{serf:5,worker:3}}],stone_workshop:[{name:"大采石工场",cost:{plank:60,iron:25,silver:350},input:{tools:.08,food:.15},output:{stone:4.55},jobs:{miner:4,worker:1}},{name:"皇家采石场",cost:{brick:80,iron:40,silver:800},input:{tools:.12,food:.25},output:{stone:7.875,brick:.15},jobs:{miner:5,worker:1}}],hardwood_camp:[{name:"特用林场",cost:{plank:80,tools:30,silver:450},input:{tools:.1,food:.2},output:{wood:6.24},jobs:{lumberjack:5,worker:1}},{name:"皇家御林",cost:{brick:80,tools:50,silver:900},input:{tools:.15,food:.35},output:{wood:10.8,food:.2},jobs:{lumberjack:6,worker:1}}],dockyard:[{name:"大船坞",cost:{plank:120,tools:30,silver:500},input:{wood:.4,tools:.02},output:{spice:.9},jobs:{navigator:2,worker:2,merchant:1}},{name:"皇家船厂",cost:{plank:200,iron:40,silver:1100},input:{wood:.6,tools:.03,cloth:.06},output:{spice:.79,silver:.25,science:.05},jobs:{navigator:3,worker:2,merchant:1}}],navigator_school:[{name:"航海学府",cost:{plank:80,papyrus:40,silver:400},input:{papyrus:.05},output:{science:.78,culture:.26},jobs:{navigator:3,scribe:1,official:1}},{name:"皇家航海学院",cost:{brick:60,papyrus:80,silver:900},input:{papyrus:.08,coffee:.03},output:{science:1.35,culture:.45},jobs:{navigator:4,scribe:1,official:1}}],trade_port:[{name:"繁荣港口",cost:{plank:150,spice:30,silver:600},input:{spice:.25},output:{food:2.6,silver:.15},jobs:{merchant:4}},{name:"贸易枢纽",cost:{brick:120,spice:60,silver:1300},input:{spice:.35,cloth:.06},output:{food:4.5,silver:.4},jobs:{merchant:5}}],shaft_mine:[{name:"通风矿井",cost:{brick:120,tools:45,silver:650},input:{tools:.14,wood:.3},output:{iron:1.56,copper:1.04},jobs:{miner:6,engineer:1}},{name:"蒸汽矿井",cost:{brick:200,steel:50,tools:80,silver:1200},input:{tools:.2,coal:.15,wood:.4},output:{iron:2.7,copper:1.8,coal:.1},jobs:{miner:7,engineer:1}}],dye_workshop:[{name:"大印染工坊",cost:{brick:80,tools:25,silver:480},input:{food:.9,cloth:.5,spice:.06},output:{dye:1.56,fine_clothes:.39},jobs:{artisan:3,worker:2}},{name:"皇家印染工坊",cost:{brick:140,tools:45,silver:1050},input:{food:1.2,cloth:.7,spice:.08,iron:.02},output:{dye:2.7,fine_clothes:.675,culture:.08},jobs:{artisan:4,worker:2}}],coffee_plantation:[{name:"大种植园",cost:{wood:300,spice:40,silver:800},input:{tools:.03},output:{coffee:.52},jobs:{serf:6,merchant:1}},{name:"种植园庄园",cost:{plank:200,tools:60,silver:1800},input:{tools:.06},output:{coffee:.9,spice:.02,food:.5},jobs:{serf:8,merchant:1}}],coffee_house:[{name:"文人咖啡馆",cost:{plank:80,coffee:25,silver:400},input:{coffee:.2,delicacies:.08},output:{culture:1.3,science:1.3,silver:.6},jobs:{merchant:1,scribe:1}},{name:"沙龙",cost:{brick:60,furniture:25,silver:900},input:{coffee:.3,delicacies:.1},output:{culture:1.8,science:1.8,silver:1.2},jobs:{merchant:1,scribe:3}}],printing_house:[{name:"大印刷所",cost:{brick:120,papyrus:40,silver:500,science:100},input:{papyrus:.48,coffee:.09,science:.2},output:{science:2.34},jobs:{artisan:3,scribe:2,capitalist:1}},{name:"出版社",cost:{brick:200,papyrus:80,silver:1100,science:250},input:{papyrus:.75,coffee:.15,science:.35},output:{science:3.24,culture:.45},jobs:{artisan:3,scribe:2,capitalist:1}}],textile_mill:[{name:"大纺织厂",cost:{brick:120,tools:40,silver:600},input:{food:2.6,dye:.975,tools:.04},output:{cloth:16.25,fine_clothes:1.95},jobs:{worker:15,artisan:4,capitalist:1}},{name:"纺织工场",cost:{brick:200,tools:60,silver:1300},input:{food:4.5,dye:1.6875,tools:.0692,coffee:.0533},output:{cloth:28.125,fine_clothes:3.375},jobs:{worker:16,artisan:4,capitalist:1}}],lumber_mill:[{name:"大木材厂",cost:{brick:100,tools:35,silver:500},input:{wood:8.3572,tools:.024},output:{plank:22.2858},jobs:{worker:10,artisan:1,capitalist:1}},{name:"木业公司",cost:{brick:180,tools:50,silver:1100},input:{wood:14.4644,tools:.048},output:{plank:38.5715,furniture:.144},jobs:{worker:11,artisan:1,capitalist:1}}],building_materials_plant:[{name:"大建材厂",cost:{brick:120,tools:35,silver:550},input:{stone:5.85,wood:1.755,coal:.585},output:{brick:16.0875},jobs:{worker:14,engineer:1,capitalist:1}},{name:"建材公司",cost:{brick:200,tools:50,silver:1200},input:{stone:10.125,wood:3.0375,coal:1.0125},output:{brick:27.84375},jobs:{worker:15,engineer:1,capitalist:1}}],distillery:[{name:"大蒸馏厂",cost:{brick:150,copper:50,silver:600},input:{food:5.85,coal:.585},output:{ale:10.2375,silver:2.34},jobs:{worker:12,artisan:2,capitalist:1}},{name:"酒业公司",cost:{brick:250,copper:80,silver:1300},input:{food:10.125,coal:1.0125},output:{ale:17.71875,silver:4.05,culture:.12},jobs:{worker:13,artisan:2,capitalist:1}}],paper_mill:[{name:"大造纸厂",cost:{brick:120,tools:35,silver:500},input:{wood:3.9,coal:.39},output:{papyrus:6.5},jobs:{worker:10,engineer:1,capitalist:1}},{name:"造纸公司",cost:{brick:200,tools:50,silver:1100},input:{wood:6.75,coal:.675},output:{papyrus:11.25,tools:.06},jobs:{worker:11,engineer:1,capitalist:1}}],university:[{name:"著名学府",cost:{brick:250,papyrus:60,silver:750,science:150},input:{papyrus:.3125,coffee:.1875,delicacies:.125,science:.4},output:{science:4.875,culture:1.3},jobs:{scribe:5,engineer:2,official:2}},{name:"皇家学院",cost:{brick:400,papyrus:120,silver:1700,science:400},input:{papyrus:.4375,coffee:.25,delicacies:.15,science:.7},output:{science:8.4375,culture:2.25},jobs:{scribe:6,engineer:2,official:2}}],opera_house:[{name:"大歌剧院",cost:{brick:250,furniture:50,silver:700},input:{fine_clothes:.25,delicacies:.15},output:{culture:5.6875,silver:1.625},jobs:{cleric:5,artisan:2,merchant:1}},{name:"皇家歌剧院",cost:{brick:400,furniture:80,silver:1500},input:{fine_clothes:.375,delicacies:.225,coffee:.1},output:{culture:9.8438,silver:2.8125,science:.1875},jobs:{cleric:6,artisan:2,merchant:1}}],coal_mine:[{name:"深煤矿",cost:{plank:150,tools:40,silver:500},input:{tools:.15,wood:.4,food:.6},output:{coal:2},jobs:{miner:10,capitalist:1}},{name:"大煤矿",cost:{brick:100,tools:60,silver:1100},input:{tools:.25,wood:.6,food:.9},output:{coal:4,iron:.1},jobs:{miner:9,capitalist:1}}],steel_foundry:[{name:"大炼钢厂",cost:{brick:200,iron:120,silver:750,science:150},input:{iron:.35,coal:.35,science:.15},output:{steel:.52},jobs:{engineer:3,worker:4,capitalist:1}},{name:"钢铁联合厂",cost:{steel:100,iron:200,silver:1700,science:350},input:{iron:.55,coal:.55,science:.3},output:{steel:.9,tools:.1},jobs:{engineer:3,worker:5,capitalist:1}}],factory:[{name:"大工厂",cost:{brick:300,steel:120,silver:850,science:200},input:{steel:.52,coal:.52,science:.3},output:{tools:3.12},jobs:{worker:20,engineer:4,capitalist:1}},{name:"制造中心",cost:{steel:200,tools:80,silver:1900,science:450},input:{steel:.9,coal:.9,science:.5},output:{tools:5.4,steel:.02,science:.05},jobs:{worker:21,engineer:4,capitalist:1}}],industrial_mine:[{name:"大工业矿场",cost:{steel:150,tools:60,silver:850},input:{tools:.33995,coal:.68,wood:.4,food:.8},output:{iron:3.85,copper:1.245},jobs:{miner:17,engineer:2,capitalist:1}},{name:"矿业公司",cost:{steel:250,tools:100,silver:1900},input:{tools:.588375,coal:1.125,wood:.6,food:1},output:{iron:6.663075,copper:2.153925},jobs:{miner:18,engineer:2,capitalist:1}}],mechanized_farm:[{name:"大机械农场",cost:{steel:100,tools:50,silver:750},input:{tools:.2275,coal:.455,iron:.06},output:{food:50.05},jobs:{peasant:8,worker:8,engineer:1,capitalist:1}},{name:"工业农场",cost:{steel:170,tools:80,silver:1700},input:{tools:.39375,coal:.7875,iron:.1,dye:.03},output:{food:86.625,cloth:.2},jobs:{peasant:9,worker:8,engineer:1,capitalist:1}}],logging_company:[{name:"大伐木公司",cost:{steel:60,tools:40,silver:650},input:{tools:.1563,coal:.325,food:.4},output:{wood:26},jobs:{lumberjack:11,worker:7,engineer:1,capitalist:1}},{name:"林业公司",cost:{steel:120,tools:60,silver:1500},input:{tools:.270825,coal:.5625,food:.55},output:{wood:45},jobs:{lumberjack:12,worker:7,engineer:1,capitalist:1}}],prefab_factory:[{name:"大预制厂",cost:{steel:150,tools:60,silver:850},input:{brick:3.9,steel:.52,stone:2.6,coal:1.04},output:{brick:28.6},jobs:{worker:20,engineer:4,capitalist:1}},{name:"建筑材料公司",cost:{steel:250,tools:100,silver:1900},input:{brick:6.75,steel:.9,stone:4.5,coal:1.8},output:{brick:49.5},jobs:{worker:21,engineer:4,capitalist:1}}],cannery:[{name:"大罐头厂",cost:{steel:60,tools:40,silver:650},input:{food:7.3125,iron:.8775,coal:.73125},output:{delicacies:10.2375},jobs:{worker:17,artisan:4,engineer:1,capitalist:1}},{name:"食品公司",cost:{steel:120,tools:60,silver:1500},input:{food:12.65625,iron:1.51875,coal:1.265625},output:{delicacies:17.71875,ale:.3},jobs:{worker:18,artisan:5,engineer:1,capitalist:1}}],garment_factory:[{name:"大服装厂",cost:{steel:100,tools:60,silver:850},input:{cloth:4.875,dye:.975,coal:.585},output:{fine_clothes:5.46,culture:.585},jobs:{worker:18,artisan:4,engineer:1,capitalist:1}},{name:"服装公司",cost:{steel:170,tools:100,silver:1900},input:{cloth:8.4375,dye:1.6875,coal:1.0125},output:{fine_clothes:9.45,culture:1.0125,cloth:.5},jobs:{worker:20,artisan:4,engineer:1,capitalist:1}}],furniture_factory:[{name:"大家具厂",cost:{steel:80,tools:50,silver:750},input:{plank:7.3125,cloth:2.34,coal:.73125},output:{furniture:10.2375,culture:.585},jobs:{worker:17,artisan:4,engineer:1,capitalist:1}},{name:"家具公司",cost:{steel:150,tools:80,silver:1700},input:{plank:12.65625,cloth:4.05,coal:1.265625},output:{furniture:17.71875,culture:1.0125,plank:.4},jobs:{worker:18,artisan:4,engineer:1,capitalist:1}}],market:[{name:"大市场",cost:{brick:300,papyrus:60,cloth:15,silver:1e3},input:{papyrus:.12,coffee:.075},output:{food:3.9,silver:.45},jobs:{merchant:4,scribe:1}},{name:"交易所",cost:{steel:200,papyrus:120,delicacies:30,silver:2200},input:{papyrus:.18,coffee:.12},output:{food:6.75,silver:.75,culture:.225},jobs:{merchant:5,scribe:1}}],rail_depot:[{name:"大铁路站",cost:{steel:120,coal:80,silver:850},input:{coal:.375,ale:.1,delicacies:.05},output:{silver:2.4375,maxPop:14},jobs:{engineer:4,merchant:2,capitalist:1}},{name:"铁路枢纽",cost:{steel:220,coal:150,silver:1900},input:{coal:.5625,ale:.15,delicacies:.075},output:{silver:3.375,maxPop:18,food:.625,culture:.125},jobs:{engineer:3,merchant:2,capitalist:1}}],metallurgy_workshop:[{name:"精密冶金坊",cost:{brick:120,iron:60,silver:600},input:{iron:1.2,copper:.25,wood:.6},output:{tools:3.9},jobs:{worker:4,artisan:2,engineer:1}},{name:"大冶金坊",cost:{brick:200,iron:100,silver:1300},input:{iron:1.8,copper:.4,wood:.9,coal:.08},output:{tools:6.75},jobs:{worker:5,artisan:2,engineer:1}}]},jt=(e,o=0)=>{if(!o||o===0)return{name:e.name,input:e.input||{},output:e.output||{},jobs:e.jobs||{},owner:e.owner||null};const i=Oi[e.id];if(!i||!i[o-1])return{name:e.name,input:e.input||{},output:e.output||{},jobs:e.jobs||{},owner:e.owner||null};const n=i[o-1];return{name:n.name||e.name,input:n.input||e.input||{},output:n.output||e.output||{},jobs:n.jobs||e.jobs||{},owner:n.owner||e.owner||null}},qn=e=>{const o=Oi[e];return o?o.length:0},Un=(e,o,i=0,n=1.15)=>{const r=Oi[e];if(!r||!r[o-1])return null;const a=r[o-1].cost||{};if(i<=0)return a;const c=1+Math.max(0,n-1)*Math.pow(i,.9),d={};for(const[f,b]of Object.entries(a))d[f]=Math.ceil(b*c);return d},Vn={demanding:{high:120,standard:80,low:50},offering:{high:60,standard:40,low:25}},fn=2e6;function zn(e,o=null){const i=o?Math.min(e||0,o||0):e||0,n=Math.floor(i*.02);return Math.max(30,Math.min(1e4,n))}function Hn(e,o,i,n,r="demanding",a=0){const u=Math.abs(e||0),l=o||0,c=i||0,d=n||0,f=a||0,b=Vn[r]||Vn.demanding,g=u*b.high,p=l*80,w=c*25,x=f*.3,T=Math.ceil(g+p+w+x),A=Math.ceil(u*b.standard+l*50+c*18+f*.2),M=Math.ceil(u*b.low+l*35+c*12+f*.1),C=Math.floor(d*.18),k=Math.floor(d*.12),q=Math.floor(d*.06),B=d*1,j=Math.max(5e4,B);let H=fn;if(f>0&&r==="demanding"){const U=1+u/100;H=f*U,H=Math.max(f*.5,H)}const O=Math.min(fn,j,H);return{high:Math.max(600,C,Math.min(O,T)),standard:Math.max(400,k,Math.min(O,A)),low:Math.max(200,q,Math.min(O,M)),breakdown:{scoreComponent:g,lossComponent:p,durationComponent:w,expenseComponent:x,rawHigh:T,rawStandard:A,rawLow:M},caps:{hardCap:fn,wealthCap:j,armyExpenseCap:H,effectiveCap:O}}}function vs(e,o,i,n){return Hn(e,o,i,n,"offering").standard}function Cs(e,o,i=1e4){return Hn(e,0,o,i,"offering").standard}const lo={militia:{id:"militia",name:"民兵",desc:"由农民临时组成的武装力量，战斗力较弱但成本低廉。",epoch:0,icon:"Users",category:"infantry",attack:6,defense:4,speed:3,range:1,recruitCost:{food:125,wood:60},maintenanceCost:{food:1.75,silver:.6},trainingTime:2,populationCost:1,abilities:["快速征召"],counters:{cavalry:1.2,siege:1.3},weakAgainst:["archer"],obsoleteAfterEpochs:2},slinger:{id:"slinger",name:"投石兵",desc:"使用投石索的远程单位，对轻甲单位有效。",epoch:0,icon:"Circle",category:"archer",attack:6,defense:2,speed:3,range:3,recruitCost:{food:150,wood:75,stone:25},maintenanceCost:{food:2,silver:.75,stone:.5},trainingTime:3,populationCost:1,abilities:["远程攻击"],counters:{infantry:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},spearman:{id:"spearman",name:"长矛兵",desc:"装备青铜长矛的步兵，对骑兵有显著克制效果。",epoch:1,icon:"Sword",category:"infantry",attack:12,defense:9,speed:3,range:1,recruitCost:{food:275,wood:175,copper:60},maintenanceCost:{food:2.75,silver:1.75,copper:.25},trainingTime:4,populationCost:1,abilities:["反骑兵"],counters:{cavalry:1.8,siege:1.2},weakAgainst:["archer"],obsoleteAfterEpochs:2},archer:{id:"archer",name:"弓箭手",desc:"装备复合弓的远程单位，克制步兵。",epoch:1,icon:"Target",category:"archer",attack:14,defense:6,speed:4,range:4,recruitCost:{food:325,wood:225,silver:125},maintenanceCost:{food:3.25,silver:2.25,wood:1},trainingTime:5,populationCost:1,abilities:["远程攻击","高机动"],counters:{infantry:1.5,siege:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},chariot:{id:"chariot",name:"战车",desc:"青铜时代的机动战力，由马匹牵引的战车。",epoch:1,icon:"Truck",category:"cavalry",attack:15,defense:8,speed:6,range:1,recruitCost:{food:500,wood:300,copper:150,silver:200},maintenanceCost:{food:6,silver:3.5,wood:1.5},trainingTime:6,populationCost:1,abilities:["冲锋","机动"],counters:{archer:1.6},weakAgainst:["infantry"],obsoleteAfterEpochs:2},hoplite:{id:"hoplite",name:"重装步兵",desc:"装备圆盾和长矛的古典精锐步兵，方阵作战威力强大。",epoch:2,icon:"Shield",category:"infantry",attack:16,defense:14,speed:2,range:1,recruitCost:{food:500,copper:200,iron:100,silver:250},maintenanceCost:{food:3.75,silver:2.75,iron:.4},trainingTime:6,populationCost:1,abilities:["方阵","坚守"],counters:{cavalry:1.7,siege:1.3},weakAgainst:["archer"],obsoleteAfterEpochs:2},composite_archer:{id:"composite_archer",name:"复合弓手",desc:"使用复合弓的精锐射手，穿透力更强。",epoch:2,icon:"Target",category:"archer",attack:18,defense:7,speed:4,range:5,recruitCost:{food:425,wood:250,copper:125,silver:225},maintenanceCost:{food:3.5,silver:2.5,wood:1.25,copper:.25},trainingTime:6,populationCost:1,abilities:["远程攻击","穿甲"],counters:{infantry:1.6,siege:1.3},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},light_cavalry:{id:"light_cavalry",name:"轻骑兵",desc:"快速机动的骑兵单位，克制弓箭手。",epoch:2,icon:"Navigation",category:"cavalry",attack:18,defense:8,speed:8,range:1,recruitCost:{food:600,silver:300,iron:125},maintenanceCost:{food:6,silver:4,iron:.3},trainingTime:7,populationCost:1,abilities:["快速移动","冲锋"],counters:{archer:1.8},weakAgainst:["infantry"],obsoleteAfterEpochs:2},battering_ram:{id:"battering_ram",name:"攻城槌",desc:"古典时代的攻城器械，对建筑极为有效。",epoch:2,icon:"Hammer",category:"siege",attack:30,defense:15,speed:1,range:1,recruitCost:{food:750,wood:1e3,iron:250,silver:400},maintenanceCost:{food:6,silver:4,wood:2.5,iron:.5},trainingTime:10,populationCost:2,abilities:["攻城"],counters:{},weakAgainst:["cavalry","archer","infantry"],obsoleteAfterEpochs:2},heavy_infantry:{id:"heavy_infantry",name:"重甲步兵",desc:"装备锁子甲的精锐步兵，防御力强。",epoch:3,icon:"ShieldAlert",category:"infantry",attack:20,defense:18,speed:2,range:1,recruitCost:{food:700,iron:300,silver:400},maintenanceCost:{food:4.5,silver:3.5,iron:.6,cloth:.2},trainingTime:8,populationCost:1,abilities:["重甲","坚守"],counters:{cavalry:1.6,siege:1.4},weakAgainst:["archer"],obsoleteAfterEpochs:2},crossbowman:{id:"crossbowman",name:"弩兵",desc:"装备十字弩的远程单位，穿透力强。",epoch:3,icon:"Crosshair",category:"archer",attack:22,defense:9,speed:3,range:5,recruitCost:{food:550,wood:350,iron:225,silver:275},maintenanceCost:{food:4,silver:3,wood:.75,iron:.5},trainingTime:7,populationCost:1,abilities:["远程攻击","穿甲"],counters:{infantry:1.7,siege:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},knight:{id:"knight",name:"骑士",desc:"装备板甲的精锐骑兵，封建时代的主力。",epoch:3,icon:"Crown",category:"cavalry",attack:28,defense:22,speed:6,range:1,recruitCost:{food:1250,iron:500,copper:150,silver:800},maintenanceCost:{food:9,silver:6.5,iron:.8,copper:.3},trainingTime:10,populationCost:1,abilities:["重甲","冲锋","贵族"],counters:{archer:1.9},weakAgainst:["infantry"],obsoleteAfterEpochs:2},trebuchet:{id:"trebuchet",name:"投石机",desc:"中世纪的重型攻城器械，可投掷巨石。",epoch:3,icon:"Mountain",category:"siege",attack:45,defense:8,speed:1,range:6,recruitCost:{food:1e3,wood:1e3,plank:400,iron:400,silver:750},maintenanceCost:{food:7.5,silver:6,plank:1.5,iron:.6,stone:1.2},trainingTime:12,populationCost:3,abilities:["攻城","范围伤害"],counters:{infantry:1.3},weakAgainst:["cavalry","archer"],obsoleteAfterEpochs:2},pikeman:{id:"pikeman",name:"长枪兵",desc:"装备长枪的步兵，方阵抵御骑兵冲锋。",epoch:4,icon:"Swords",category:"infantry",attack:22,defense:20,speed:2,range:2,recruitCost:{food:800,wood:300,iron:350,silver:450},maintenanceCost:{food:5,silver:4,iron:.5},trainingTime:8,populationCost:1,abilities:["反骑兵","方阵"],counters:{cavalry:2,siege:1.3},weakAgainst:["archer","gunpowder"],obsoleteAfterEpochs:2},arquebus:{id:"arquebus",name:"火绳枪手",desc:"早期火器部队，虽然装填慢但威力巨大，克制传统步兵和骑兵。",epoch:4,icon:"Flame",category:"gunpowder",attack:28,defense:8,speed:2,range:4,recruitCost:{food:700,iron:300,tools:200,copper:80,silver:500},maintenanceCost:{food:4.5,silver:4,iron:.35,tools:.9,copper:.15},trainingTime:9,populationCost:1,abilities:["火器","穿甲","装填缓慢"],counters:{infantry:1.5,cavalry:1.4},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},cuirassier:{id:"cuirassier",name:"胸甲骑兵",desc:"装备胸甲的重装骑兵，可抵抗早期火器。",epoch:4,icon:"Shield",category:"cavalry",attack:32,defense:24,speed:6,range:1,recruitCost:{food:1500,iron:600,silver:1e3},maintenanceCost:{food:10,silver:7.5,iron:1.25},trainingTime:11,populationCost:1,abilities:["重甲","冲锋","抗火器"],counters:{archer:1.9,gunpowder:1.5},weakAgainst:["infantry"],obsoleteAfterEpochs:2},bombard:{id:"bombard",name:"射石炮",desc:"早期火炮，可攻破城墙。",epoch:4,icon:"Bomb",category:"siege",attack:55,defense:10,speed:1,range:6,recruitCost:{food:1250,iron:600,copper:250,tools:350,silver:1e3},maintenanceCost:{food:9,silver:7.5,iron:1.2,copper:.4,tools:1.5},trainingTime:14,populationCost:3,abilities:["攻城","范围伤害","火器"],counters:{infantry:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},musketeer:{id:"musketeer",name:"刺刀火枪兵",desc:"装备滑膛枪和刺刀的步兵，可远程射击也可近战。",epoch:5,icon:"Zap",category:"infantry",attack:30,defense:14,speed:3,range:3,recruitCost:{food:900,iron:350,tools:250,silver:550},maintenanceCost:{food:5.5,silver:5,iron:.45,tools:1,cloth:.15},trainingTime:9,populationCost:1,abilities:["火器","刺刀冲锋","齐射"],counters:{cavalry:1.6,siege:1.4},weakAgainst:["gunpowder"],obsoleteAfterEpochs:2},rifleman:{id:"rifleman",name:"线膛枪手",desc:"装备线膛枪的精确射手，射程远、精度高。",epoch:5,icon:"Target",category:"gunpowder",attack:35,defense:10,speed:3,range:5,recruitCost:{food:1e3,iron:400,tools:300,silver:650},maintenanceCost:{food:6,silver:5.5,iron:.5,tools:1.3},trainingTime:10,populationCost:1,abilities:["火器","精确射击","穿甲"],counters:{infantry:1.7,cavalry:1.5,siege:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},dragoon:{id:"dragoon",name:"龙骑兵",desc:"骑马机动的火枪兵，可下马作战，机动性和火力兼备。",epoch:5,icon:"Navigation",category:"cavalry",attack:35,defense:18,speed:7,range:2,recruitCost:{food:1400,iron:450,tools:225,silver:900},maintenanceCost:{food:10,silver:7.5,iron:.75,tools:1},trainingTime:12,populationCost:1,abilities:["火器","快速移动","下马作战"],counters:{archer:1.8,gunpowder:1.6},weakAgainst:["infantry"],obsoleteAfterEpochs:2},cannon:{id:"cannon",name:"野战炮",desc:"启蒙时代的标准火炮，可用于攻城和野战。",epoch:5,icon:"Bomb",category:"siege",attack:60,defense:12,speed:2,range:7,recruitCost:{food:1500,iron:700,copper:300,tools:450,silver:1250},maintenanceCost:{food:10,silver:9,iron:1.4,copper:.5,tools:2},trainingTime:15,populationCost:3,abilities:["攻城","范围伤害","火器"],counters:{infantry:1.7,gunpowder:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:2},line_infantry:{id:"line_infantry",name:"线列步兵",desc:"工业化训练的步兵，装备后装步枪和刺刀。",epoch:6,icon:"Users",category:"infantry",attack:40,defense:20,speed:3,range:4,recruitCost:{food:1250,steel:150,tools:200,silver:800},maintenanceCost:{food:7,silver:6.5,steel:.3,coal:.15},trainingTime:10,populationCost:1,abilities:["火器","齐射","刺刀冲锋"],counters:{cavalry:1.7,siege:1.5},weakAgainst:["gunpowder"],obsoleteAfterEpochs:3},gatling:{id:"gatling",name:"加特林机枪组",desc:"早期机枪，火力密集，克制密集阵型的步兵和骑兵。",epoch:6,icon:"Zap",category:"gunpowder",attack:50,defense:12,speed:2,range:5,recruitCost:{food:1500,steel:300,tools:350,coal:200,silver:1250},maintenanceCost:{food:8,silver:9,steel:.6,coal:.8},trainingTime:12,populationCost:2,abilities:["火器","压制火力","范围伤害"],counters:{infantry:2,cavalry:1.8},weakAgainst:["siege"],obsoleteAfterEpochs:3},lancer:{id:"lancer",name:"枪骑兵",desc:"工业时代的精锐骑兵，适合侦察、追击和近身突袭火器阵地。",epoch:6,icon:"Compass",category:"cavalry",attack:38,defense:20,speed:8,range:1,recruitCost:{food:1600,steel:120,tools:180,silver:1e3},maintenanceCost:{food:11,silver:8,steel:.25,iron:.4},trainingTime:11,populationCost:1,abilities:["冲锋","快速移动","侦察"],counters:{archer:1.9,gunpowder:1.7},weakAgainst:["infantry"],obsoleteAfterEpochs:3},artillery:{id:"artillery",name:"重型火炮",desc:"工业化生产的重型火炮，威力巨大。",epoch:6,icon:"Bomb",category:"siege",attack:80,defense:15,speed:1,range:8,recruitCost:{food:2e3,steel:500,coal:400,tools:300,silver:1750},maintenanceCost:{food:10,silver:11,steel:1.2,coal:1.5},trainingTime:18,populationCost:4,abilities:["攻城","范围伤害","精确打击"],counters:{infantry:2,gunpowder:1.8,siege:1.5},weakAgainst:["cavalry"],obsoleteAfterEpochs:3}},_s=(e={})=>{let o=0;return Object.entries(e).forEach(([i,n])=>{var u;if(n<=0)return;const r=lo[i];if(!r)return;const a=((u=r.maintenanceCost)==null?void 0:u.food)||0;o+=a*n}),o},Yn=(e,o)=>{let i=1,n=0;return Object.entries(e).forEach(([r,a])=>{if(a<=0)return;const u=lo[r];u&&Object.entries(o).forEach(([l,c])=>{if(c<=0)return;const d=lo[l];if(d&&u.counters[d.category]){const f=u.counters[d.category],b=a*c/100;i+=(f-1)*b,n++}})}),{multiplier:i,counterCount:n}},Es={范围伤害:.12,压制火力:.1,火器:.06,齐射:.05,远程攻击:.05,穿甲:.06,冲锋:.06,机动:.04,快速移动:.04,侦察:.03,攻城:.08,精确打击:.08},Ps={坚守:.08,方阵:.08,盾墙:.08},Jn=(e,o)=>Array.isArray(e)?e.reduce((i,n)=>i+(o[n]||0),0):0,Ts=(e={})=>{const o=Object.values(e).reduce((i,n)=>i+(n||0),0);return o<=0?{infantry:0,cavalry:0,archer:0,gunpowder:0,siege:0}:{infantry:(e.infantry||0)/o,cavalry:(e.cavalry||0)/o,archer:(e.archer||0)/o,gunpowder:(e.gunpowder||0)/o,siege:(e.siege||0)/o}},Xn=(e={})=>{const o={};return Object.entries(e).forEach(([i,n])=>{if(n<=0)return;const r=lo[i];r&&(o[r.category]=(o[r.category]||0)+n)}),o},ks=(e,o,i)=>{if(!e||i<=0)return 1;let n=1;return Object.entries(e.counters||{}).forEach(([r,a])=>{const u=(o[r]||0)/i;u>0&&(n+=(a-1)*u)}),n},Qn=(e={})=>{const o={infantry:1,cavalry:1,archer:1,gunpowder:1,siege:1},i=Object.values(e).reduce((n,r)=>n+(r||0),0);return i<=0||Object.entries(e).forEach(([n,r])=>{if(r<=0)return;const a=lo[n];if(!a||!a.counters)return;const u=r/i;Object.entries(a.counters).forEach(([l,c])=>{o[l]+=(c-1)*u})}),o},Zn=({army:e,enemyCategoryCounts:o,enemyCounterPressure:i,militaryBuffs:n=0,defenseMultiplier:r=1})=>{let a=0,u=0,l=0;const c={},d=Object.values(o||{}).reduce((b,g)=>b+(g||0),0),f=Ts(o);return Object.entries(e||{}).forEach(([b,g])=>{if(g<=0)return;const p=lo[b];if(!p)return;const w=ks(p,o||{},d),x=Jn(p.abilities,Es),T=Jn(p.abilities,Ps),A=Math.min(.3,(p.range||1)*.03),M=Math.min(.2,(p.speed||1)*.02);let C=0,k=0,q=0;const B=Array.isArray(p.abilities)?p.abilities:[];B.includes("范围伤害")&&(C+=.18*(f.infantry+f.archer)),B.includes("压制火力")&&(C+=.12*(f.infantry+f.archer)),B.includes("火器")&&(C+=.1*(f.infantry+f.cavalry),k-=.08*f.cavalry),B.includes("穿甲")&&(C+=.08*(f.infantry+f.gunpowder+f.siege)),B.includes("冲锋")&&(p.speed||0)>=6&&(C+=.1*(f.gunpowder+f.archer)),B.includes("刺刀冲锋")&&(C+=.06*f.cavalry),B.includes("装填缓慢")&&(C-=.12*f.cavalry),B.includes("重甲")&&(k+=.12,C-=.05),B.includes("抗火器")&&(q-=.15*f.gunpowder,k+=.05*f.gunpowder),(B.includes("精确射击")||B.includes("精确打击"))&&(C+=.08*(f.siege+f.infantry)),B.includes("下马作战")&&(k+=.08*f.cavalry);const j=p.attack*(1+A+M+x+C)*(1+n)*w,H=p.defense*(1+M*.5+T+k)*r*(1+n),O=Math.max(.6,((i==null?void 0:i[p.category])||1)*(1+q)),U=H/O;a+=j*g,u+=H*g,l+=g,c[b]={count:g,attackPerUnit:j,defensePerUnit:H,adjustedDefensePerUnit:U,category:p.category}}),{totalAttack:a,totalDefense:u,totalUnits:l,unitProfiles:c}},As=(e={})=>{const o={};Object.values(e).forEach(r=>{r&&(o[r.category]=(o[r.category]||0)+r.count)});let i=null,n=0;return Object.entries(o).forEach(([r,a])=>{a>n&&(n=a,i=r)}),i},Kn=e=>{const o=Math.floor(e),i=e-o;return o+(Math.random()<i?1:0)},Ws=(e,o)=>{if(o<=0)return{};const i={...e};let n=Object.values(i).reduce((l,c)=>l+(c||0),0);if(n<=o)return i;const r=o/n;if(Object.keys(i).forEach(l=>{i[l]=Kn(i[l]*r)}),n=Object.values(i).reduce((l,c)=>l+(c||0),0),n<=o)return i;const a=Object.keys(i).sort((l,c)=>(i[c]||0)-(i[l]||0));let u=0;for(;n>o&&a.length>0;){const l=a[u%a.length];(i[l]||0)>0&&(i[l]-=1,n-=1),u+=1}return i},ea=({sideProfile:e,enemyProfile:o,enemyCounterPressure:i,isWinner:n,powerRatio:r,decisive:a,dominanceRatio:u,ownPowerScore:l,enemyPowerScore:c})=>{if(!e||e.totalUnits<=0||o.totalAttack<=0)return{};const d=c/(c+l);let f=.12*Math.pow(d,.9);if(n&&(f*=.75),a&&(f*=n?.6:1.1),f*=.9+Math.random()*.2,!n){const w=Math.max(1,u||1);f*=1+Math.min(.8,(w-1)*.18)}const b=o.totalAttack*f;if(b<=0)return{};let g=0;if(Object.values(e.unitProfiles).forEach(w=>{g+=w.count/w.adjustedDefensePerUnit}),g<=0)return{};const p={};if(Object.entries(e.unitProfiles).forEach(([w,x])=>{const T=x.count/x.adjustedDefensePerUnit,M=b*(T/g)/x.adjustedDefensePerUnit;p[w]=Math.min(x.count,Kn(M))}),!n){const w=Math.max(1,u||1);if(w>=3&&(a||w>=6)){const x=Math.min(.75,.2+(w-3)*.12+(a?.15:0));if(Math.random()<x){const T={};return Object.entries(e.unitProfiles).forEach(([A,M])=>{T[A]=M.count}),T}}}if(n&&r>=3&&o.totalUnits>0){let w;r>=10?w=Math.floor(Math.sqrt(o.totalUnits)*.2):r>=6?w=Math.floor(Math.sqrt(o.totalUnits)*.3):w=Math.floor(Math.sqrt(o.totalUnits)*.4);const x=As(e.unitProfiles);return((i==null?void 0:i[x])||1)>=1.4&&w===0&&o.totalUnits>=5&&(w=1),Ws(p,w)}return p},ta=(e,o)=>{const{army:i,militaryBuffs:n=0}=e,{army:r,militaryBuffs:a=0,wealth:u=1e3}=o,l=Xn(i),c=Xn(r),d=Qn(i),f=Qn(r),b=Zn({army:i,enemyCategoryCounts:c,enemyCounterPressure:f,militaryBuffs:n,defenseMultiplier:1}),g=Zn({army:r,enemyCategoryCounts:l,enemyCounterPressure:d,militaryBuffs:a,defenseMultiplier:1.2});let p=b.totalAttack*.65+b.totalDefense*.35,w=g.totalAttack*.65+g.totalDefense*.35;p*=.9+Math.random()*.2,w*=.9+Math.random()*.2;const x=p+w,T=x>0?p/x:0,A=x>0?w/x:0,M=T>.5,C=Math.abs(T-.5)>.28,k=w>0?p/w:100,q=ea({sideProfile:b,enemyProfile:g,enemyCounterPressure:f,isWinner:M,powerRatio:k,decisive:C,dominanceRatio:M?k:1/k,ownPowerScore:p,enemyPowerScore:w}),B=ea({sideProfile:g,enemyProfile:b,enemyCounterPressure:d,isWinner:!M,powerRatio:k>0?1/k:100,decisive:C,dominanceRatio:M?k:1/k,ownPowerScore:w,enemyPowerScore:p}),j=Yn(i,r),H=Yn(r,i);let O={};if(M){const Q=u*(C?.08:.04),I={food:500,wood:300,stone:200,silver:1500,iron:150,copper:100,cloth:100,tools:80};O={food:Math.min(I.food,Math.floor(Q*.25)),wood:Math.min(I.wood,Math.floor(Q*.12)),stone:Math.min(I.stone,Math.floor(Q*.08)),silver:Math.min(I.silver,Math.floor(Q*.3)),iron:Math.min(I.iron,Math.floor(Q*.1)),copper:Math.min(I.copper,Math.floor(Q*.05)),cloth:Math.min(I.cloth,Math.floor(Q*.05)),tools:Math.min(I.tools,Math.floor(Q*.05))},Object.keys(O).forEach(W=>{O[W]<=0&&delete O[W]})}return{victory:M,decisive:C,attackerPower:Math.floor(p),defenderPower:Math.floor(w),attackerAdvantage:(T*100).toFixed(1),defenderAdvantage:(A*100).toFixed(1),attackerLosses:q,defenderLosses:B,attackerCounter:j.counterCount,defenderCounter:H.counterCount,loot:O,battleReport:Rs({victory:M,decisive:C,attackerPower:p,defenderPower:w,attackerCounter:j.counterCount,defenderCounter:H.counterCount,attackerLosses:q,defenderLosses:B,loot:O})}},Rs=e=>{const{victory:o,decisive:i,attackerPower:n,defenderPower:r,attackerCounter:a,defenderCounter:u,attackerLosses:l,defenderLosses:c,loot:d}=e;let f=[];o?i?f.push("🎉 压倒性胜利！敌军溃不成军！"):f.push("✓ 艰难的胜利，我军成功击退敌人。"):i?f.push("💀 惨败！我军遭受重创！"):f.push("✗ 战败，我军被迫撤退。"),f.push(`战斗力对比：我方 ${Math.floor(n)} vs 敌方 ${Math.floor(r)}`),a>0&&f.push(`✓ 我方兵种克制生效 ${a} 次`),u>0&&f.push(`✗ 敌方兵种克制生效 ${u} 次`);const b=Object.values(l).reduce((p,w)=>p+w,0),g=Object.values(c).reduce((p,w)=>p+w,0);if(f.push(`我方损失：${b} 人`),f.push(`敌方损失：${g} 人`),o&&d){const p=Object.entries(d).filter(([,w])=>w>0).map(([w,x])=>`${w} ${x}`).join(", ");p&&f.push(`掠夺资源：${p}`)}return f},Bs=e=>{const o={};return Object.entries(e).forEach(([i,n])=>{if(n<=0)return;const r=lo[i];r&&Object.entries(r.maintenanceCost).forEach(([a,u])=>{o[a]=(o[a]||0)+u*n})}),o},oa=e=>{let o=0;return Object.entries(e).forEach(([i,n])=>{if(n<=0)return;const r=lo[i];r&&(o+=r.populationCost*n)}),o},Ss=(e,o)=>{if(o<=0||e<=0)return 1;const i=e/o;return i<=.1?1:i<=.2?1+(i-.1)*2.5:i<=.3?1.25+(i-.2)*2.5:i<=.4?1.5+(i-.3)*2.5:1.75+(i-.4)*2.5},Xt=["peasant","worker","artisan","merchant","landowner","cleric","scribe","soldier","official","capitalist","miner","engineer","serf"],js={stratum_approval_above:{generate:()=>{const e=Xt[Math.floor(Math.random()*Xt.length)],o=40+Math.floor(Math.random()*40);return{stratum:e,threshold:o}},check:(e,o)=>{var i;return(((i=o.classApproval)==null?void 0:i[e.stratum])||50)>=e.threshold},text:e=>{var o;return`${((o=ce[e.stratum])==null?void 0:o.name)||e.stratum}满意度 ≥ ${e.threshold}`}},stratum_approval_below:{generate:()=>{const e=Xt[Math.floor(Math.random()*Xt.length)],o=20+Math.floor(Math.random()*30);return{stratum:e,threshold:o}},check:(e,o)=>{var i;return(((i=o.classApproval)==null?void 0:i[e.stratum])||50)<e.threshold},text:e=>{var o;return`${((o=ce[e.stratum])==null?void 0:o.name)||e.stratum}满意度 < ${e.threshold}`}},stratum_influence_above:{generate:()=>{const e=Xt[Math.floor(Math.random()*Xt.length)],o=10+Math.floor(Math.random()*25);return{stratum:e,threshold:o}},check:(e,o)=>{var r;const i=o.totalInfluence||1;return(((r=o.classInfluence)==null?void 0:r[e.stratum])||0)/i*100>=e.threshold},text:e=>{var o;return`${((o=ce[e.stratum])==null?void 0:o.name)||e.stratum}影响力 ≥ ${e.threshold}%`}},stratum_influence_below:{generate:()=>{const e=Xt[Math.floor(Math.random()*Xt.length)],o=5+Math.floor(Math.random()*15);return{stratum:e,threshold:o}},check:(e,o)=>{var r;const i=o.totalInfluence||1;return(((r=o.classInfluence)==null?void 0:r[e.stratum])||0)/i*100<e.threshold},text:e=>{var o;return`${((o=ce[e.stratum])==null?void 0:o.name)||e.stratum}影响力 < ${e.threshold}%`}},stratum_living_standard:{generate:()=>{const e=Xt[Math.floor(Math.random()*Xt.length)],o=["赤贫","贫困","温饱","小康","富裕","奢华"],i=Math.floor(Math.random()*4);return{stratum:e,minLevel:i,levelName:o[i]}},check:(e,o)=>{var a,u;const i=["赤贫","贫困","温饱","小康","富裕","奢华"],n=((u=(a=o.classLivingStandard)==null?void 0:a[e.stratum])==null?void 0:u.level)||"温饱",r=i.indexOf(n);return r===-1?!1:r>=e.minLevel},text:e=>{var o;return`${((o=ce[e.stratum])==null?void 0:o.name)||e.stratum}生活水平 ≥ ${e.levelName}`}},stratum_income_above:{generate:()=>{const e=Xt[Math.floor(Math.random()*Xt.length)],o=50+Math.floor(Math.random()*200);return{stratum:e,threshold:o}},check:(e,o)=>{var i;return(((i=o.classIncome)==null?void 0:i[e.stratum])||0)>=e.threshold},text:e=>{var o;return`${((o=ce[e.stratum])==null?void 0:o.name)||e.stratum}日均收入 ≥ ${e.threshold}`}},stability_above:{generate:()=>({threshold:50+Math.floor(Math.random()*40)}),check:(e,o)=>(o.stability||.5)*100>=e.threshold,text:e=>`稳定度 ≥ ${e.threshold}%`},stability_below:{generate:()=>({threshold:20+Math.floor(Math.random()*40)}),check:(e,o)=>(o.stability||.5)*100<e.threshold,text:e=>`稳定度 < ${e.threshold}%`},avg_tax_above:{generate:()=>({threshold:8+Math.floor(Math.random()*15)}),check:(e,o)=>{var r;const i=Object.values(((r=o.taxPolicies)==null?void 0:r.headTaxRates)||{});return(i.length>0?i.reduce((a,u)=>a+u,0)/i.length:.1)*100>=e.threshold},text:e=>`平均税率 ≥ ${e.threshold}%`},avg_tax_below:{generate:()=>({threshold:5+Math.floor(Math.random()*10)}),check:(e,o)=>{var r;const i=Object.values(((r=o.taxPolicies)==null?void 0:r.headTaxRates)||{});return(i.length>0?i.reduce((a,u)=>a+u,0)/i.length:.1)*100<e.threshold},text:e=>`平均税率 < ${e.threshold}%`},coalition_size_above:{generate:()=>({threshold:2+Math.floor(Math.random()*3)}),check:(e,o)=>{var i;return(((i=o.rulingCoalition)==null?void 0:i.length)||0)>=e.threshold},text:e=>`执政联盟 ≥ ${e.threshold}个阶层`},coalition_size_below:{generate:()=>({threshold:2+Math.floor(Math.random()*2)}),check:(e,o)=>{var i;return(((i=o.rulingCoalition)==null?void 0:i.length)||0)<=e.threshold},text:e=>`执政联盟 ≤ ${e.threshold}个阶层`},coalition_includes:{generate:()=>({stratum:Xt[Math.floor(Math.random()*Xt.length)]}),check:(e,o)=>{var i;return(i=o.rulingCoalition)==null?void 0:i.includes(e.stratum)},text:e=>{var o;return`${((o=ce[e.stratum])==null?void 0:o.name)||e.stratum}参与执政`}},legitimacy_above:{generate:()=>({threshold:40+Math.floor(Math.random()*40)}),check:(e,o)=>(o.legitimacy||50)>=e.threshold,text:e=>`合法性 ≥ ${e.threshold}`},at_war:{generate:()=>({}),check:(e,o)=>{var i;return o.atWar===!0||((i=o.nations)==null?void 0:i.some(n=>n.isAtWar))},text:()=>"处于战争状态"},at_peace:{generate:()=>({}),check:(e,o)=>{var i;return o.atWar!==!0&&!((i=o.nations)!=null&&i.some(n=>n.isAtWar))},text:()=>"处于和平状态"},population_above:{generate:()=>({threshold:500+Math.floor(Math.random()*2e3)}),check:(e,o)=>(o.population||0)>=e.threshold,text:e=>`人口 ≥ ${e.threshold}`},population_below:{generate:()=>({threshold:200+Math.floor(Math.random()*500)}),check:(e,o)=>(o.population||0)<e.threshold,text:e=>`人口 < ${e.threshold}`},epoch_at_least:{generate:()=>({epoch:Math.floor(Math.random()*5)}),check:(e,o)=>(o.epoch||0)>=e.epoch,text:e=>`达到${["石器时代","青铜时代","古典时代","封建时代","探索时代","启蒙时代","工业时代","信息时代"][e.epoch]||`时代${e.epoch}`}`},resource_price_above:{generate:e=>{var l;const o=["food","wood","stone","iron","cloth","tools","copper","ale","coal","delicacies","furniture","fine_clothes","spice"],i={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",ale:"美酒",coal:"煤炭",delicacies:"珍馐",furniture:"家具",fine_clothes:"华服",spice:"香料"},n=o[Math.floor(Math.random()*o.length)],r=((l=e==null?void 0:e.prices)==null?void 0:l[n])||1,a=1.1+Math.random()*.4,u=Math.round(r*a*10)/10;return{resource:n,threshold:u,resourceName:i[n]||n}},check:(e,o)=>{var n;return(((n=o.prices)==null?void 0:n[e.resource])||1)>=e.threshold},text:e=>`${e.resourceName}物价 ≥ ${e.threshold}`},resource_price_below:{generate:e=>{var l;const o=["food","wood","stone","iron","cloth","tools","copper","ale","coal","delicacies","furniture","fine_clothes","spice"],i={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",ale:"美酒",coal:"煤炭",delicacies:"珍馐",furniture:"家具",fine_clothes:"华服",spice:"香料"},n=o[Math.floor(Math.random()*o.length)],r=((l=e==null?void 0:e.prices)==null?void 0:l[n])||1,a=.7+Math.random()*.25,u=Math.round(r*a*10)/10;return{resource:n,threshold:u,resourceName:i[n]||n}},check:(e,o)=>{var n;return(((n=o.prices)==null?void 0:n[e.resource])||1)<e.threshold},text:e=>`${e.resourceName}物价 < ${e.threshold}`},price_stability:{generate:()=>{const e=.3+Math.random()*.4;return{threshold:Math.round(e*100)/100}},check:(e,o)=>{if(!o.prices||Object.keys(o.prices).length===0)return!0;const i=Object.values(o.prices),n=i.reduce((a,u)=>a+u,0)/i.length,r=i.reduce((a,u)=>a+Math.pow(u-n,2),0)/i.length;return Math.sqrt(r)<=e.threshold},text:e=>`物价波动 ≤ ${(e.threshold*100).toFixed(0)}%`},food_affordable:{generate:e=>{var r;const o=((r=e==null?void 0:e.prices)==null?void 0:r.food)||1,i=.75+Math.random()*.2;return{threshold:Math.round(o*i*10)/10}},check:(e,o)=>{var n;return(((n=o.prices)==null?void 0:n.food)||1)<=e.threshold},text:e=>`粮价 ≤ ${e.threshold}`},food_scarce:{generate:e=>{var r;const o=((r=e==null?void 0:e.prices)==null?void 0:r.food)||1,i=1.1+Math.random()*.3;return{threshold:Math.round(o*i*10)/10}},check:(e,o)=>{var n;return(((n=o.prices)==null?void 0:n.food)||1)>=e.threshold},text:e=>`粮价 ≥ ${e.threshold}`},inflation_above:{generate:e=>{var l;const o=["food","wood","stone","iron","cloth","tools","copper","coal","delicacies","furniture","ale","fine_clothes","spice"],i={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",coal:"煤炭",delicacies:"珍馐",furniture:"家具",ale:"美酒",fine_clothes:"华服",spice:"香料"},n=o[Math.floor(Math.random()*o.length)],r=((l=e==null?void 0:e.prices)==null?void 0:l[n])||1,a=1.15+Math.random()*.35,u=Math.round(r*a*10)/10;return{resource:n,threshold:u,resourceName:i[n]||n}},check:(e,o)=>{var n;return(((n=o.prices)==null?void 0:n[e.resource])||1)>=e.threshold},text:e=>`${e.resourceName}物价 ≥ ${e.threshold}`},deflation_below:{generate:e=>{var l;const o=["food","wood","stone","iron","cloth","tools","copper","coal","delicacies","furniture","ale","fine_clothes","spice"],i={food:"粮食",wood:"木材",stone:"石材",iron:"铁",cloth:"布匹",tools:"工具",copper:"铜",coal:"煤炭",delicacies:"珍馐",furniture:"家具",ale:"美酒",fine_clothes:"华服",spice:"香料"},n=o[Math.floor(Math.random()*o.length)],r=((l=e==null?void 0:e.prices)==null?void 0:l[n])||1,a=.65+Math.random()*.25,u=Math.round(r*a*10)/10;return{resource:n,threshold:u,resourceName:i[n]||n}},check:(e,o)=>{var n;return(((n=o.prices)==null?void 0:n[e.resource])||1)<e.threshold},text:e=>`${e.resourceName}物价 < ${e.threshold}`}},Is={primitive_communism:{name:"原始公社",spectrum:"left",icon:"Users",color:"text-red-400",unlockEpoch:0,maxEpoch:3,historicalRef:"氏族共有制",description:"一切资源归部落共有",issues:["equality","collectivism"],conditionTypes:["stratum_approval_above","stability_above","coalition_size_above"],preferredStrata:["peasant","worker","artisan","serf"],stratumWeights:{peasant:2,worker:2,serf:1.5,landowner:.2,merchant:.3,capitalist:.1},activeEffects:{stability:.05,approval:{peasant:4,worker:4}},unsatisfiedPenalty:{approval:{peasant:-2,worker:-2}}},tribal_elder:{name:"部落长老制",spectrum:"right",icon:"Crown",color:"text-amber-400",unlockEpoch:0,maxEpoch:2,historicalRef:"早期酋长",description:"尊崇长老权威",issues:["tradition","hierarchy"],conditionTypes:["legitimacy_above","stratum_influence_above","population_below"],preferredStrata:["landowner","cleric","official"],stratumWeights:{landowner:2,cleric:1.5,peasant:1},activeEffects:{stability:.04,legitimacyBonus:.04},unsatisfiedPenalty:{stability:-.02}},animism:{name:"万物有灵论",spectrum:"center",icon:"Leaf",color:"text-green-400",unlockEpoch:0,maxEpoch:3,historicalRef:"原始宗教",description:"敬畏自然神灵",issues:["spiritual","nature"],conditionTypes:["stratum_approval_above","stability_above"],preferredStrata:["cleric","peasant"],stratumWeights:{cleric:3,peasant:1.5},activeEffects:{approval:{cleric:6},needsReduction:.02},unsatisfiedPenalty:{}},warrior_cult:{name:"尚武精神",spectrum:"right",icon:"Sword",color:"text-red-500",unlockEpoch:0,maxEpoch:5,historicalRef:"原始部落战争",description:"崇尚武力与征服",issues:["military","expansion"],conditionTypes:["at_war","stratum_approval_above"],preferredStrata:["soldier","landowner"],stratumWeights:{soldier:3},activeEffects:{militaryBonus:.15},unsatisfiedPenalty:{approval:{soldier:-4}}},aristocratic_oligarchy:{name:"贵族寡头制",spectrum:"right",icon:"Castle",color:"text-purple-400",unlockEpoch:1,historicalRef:"斯巴达双王制",description:"政权归于少数贵族",issues:["hierarchy","tradition"],conditionTypes:["stratum_influence_above","coalition_includes","legitimacy_above"],preferredStrata:["landowner","official","merchant"],stratumWeights:{landowner:3,official:1.5},activeEffects:{militaryBonus:.12,taxEfficiency:.08},unsatisfiedPenalty:{approval:{landowner:-6}}},theocracy:{name:"神权政治",spectrum:"right",icon:"Church",color:"text-yellow-300",unlockEpoch:1,historicalRef:"古埃及法老",description:"神的代言人统治",issues:["spiritual","hierarchy"],conditionTypes:["coalition_includes","stratum_approval_above"],preferredStrata:["cleric"],stratumWeights:{cleric:4},activeEffects:{legitimacyBonus:.15,approval:{cleric:15}},unsatisfiedPenalty:{approval:{cleric:-8}}},republicanism:{name:"共和主义",spectrum:"center",icon:"Scale",color:"text-blue-400",unlockEpoch:2,historicalRef:"罗马共和国",description:"公民参与公共事务",issues:["liberty","law"],conditionTypes:["coalition_size_above","legitimacy_above","stability_above"],preferredStrata:["scribe","merchant","artisan","official"],stratumWeights:{scribe:2,merchant:1.5,artisan:1.5},activeEffects:{legitimacyBonus:.12,stability:.08},unsatisfiedPenalty:{stability:-.02}},populares:{name:"平民派",spectrum:"left",icon:"Users",color:"text-orange-400",unlockEpoch:2,historicalRef:"格拉古兄弟",description:"为平民争取权益",issues:["equality","reform"],conditionTypes:["stratum_approval_above","stratum_living_standard","food_affordable"],preferredStrata:["peasant","worker","artisan","serf"],stratumWeights:{peasant:2.5,worker:2.5,artisan:1.5},activeEffects:{populationGrowth:.08,approval:{peasant:8,worker:8}},unsatisfiedPenalty:{approval:{peasant:-4,worker:-4}}},legalism:{name:"法家",spectrum:"right",icon:"Gavel",color:"text-gray-300",unlockEpoch:2,historicalRef:"商鞅变法",description:"严刑峻法治国",issues:["law","efficiency"],conditionTypes:["avg_tax_above","stability_above"],preferredStrata:["official","soldier","scribe"],stratumWeights:{official:2.5,soldier:1.5},activeEffects:{taxEfficiency:.15,stability:-.06},unsatisfiedPenalty:{}},confucianism:{name:"儒家",spectrum:"center",icon:"Book",color:"text-amber-300",unlockEpoch:2,historicalRef:"孔孟之道",description:"礼教治国",issues:["tradition","education"],conditionTypes:["stratum_approval_above","stability_above","legitimacy_above"],preferredStrata:["scribe","cleric","official"],stratumWeights:{scribe:3,cleric:1.5,official:2},activeEffects:{stability:.15,researchSpeed:.08},unsatisfiedPenalty:{stability:-.02}},mohism:{name:"墨家",spectrum:"left",icon:"Wrench",color:"text-gray-400",unlockEpoch:2,historicalRef:"墨子兼爱非攻",description:"兼爱非攻，尚同尚贤",issues:["equality","efficiency"],conditionTypes:["at_peace","stratum_approval_above"],preferredStrata:["artisan","worker","engineer"],stratumWeights:{artisan:2.5,worker:2,engineer:1.5},activeEffects:{industryBonus:.12,buildingCostMod:-.08,productionInputCost:{sawmill:-.15,brickworks:-.15,metallurgy_workshop:-.18}},unsatisfiedPenalty:{approval:{artisan:-2}}},taoism:{name:"道家",spectrum:"center",icon:"Circle",color:"text-slate-300",unlockEpoch:2,historicalRef:"老庄无为",description:"无为而治",issues:["liberty","nature"],conditionTypes:["avg_tax_below","stability_above"],preferredStrata:["cleric","peasant","scribe"],stratumWeights:{cleric:2,peasant:1.5,scribe:1.5},activeEffects:{needsReduction:.12,stability:.08},unsatisfiedPenalty:{}},feudalism:{name:"封建主义",spectrum:"right",icon:"Castle",color:"text-blue-500",unlockEpoch:3,historicalRef:"中世纪欧洲分封",description:"领主-附庸关系",issues:["hierarchy","land"],conditionTypes:["stratum_influence_above","legitimacy_above"],preferredStrata:["landowner","official"],stratumWeights:{landowner:3,peasant:.5},activeEffects:{gatherBonus:.08,approval:{landowner:12}},unsatisfiedPenalty:{approval:{landowner:-6}}},peasant_revolt:{name:"农民起义派",spectrum:"left",icon:"Flame",color:"text-red-600",unlockEpoch:3,historicalRef:"黄巾起义、扎克雷起义",description:"推翻压迫者",issues:["equality","revolution"],conditionTypes:["stratum_approval_below","avg_tax_above","food_scarce","inflation_above"],preferredStrata:["peasant","serf","worker"],stratumWeights:{peasant:3,serf:3,worker:2},activeEffects:{organizationDecay:-.22},unsatisfiedPenalty:{}},guild_corporatism:{name:"行会主义",spectrum:"center",icon:"Hammer",color:"text-orange-300",unlockEpoch:3,historicalRef:"中世纪行会",description:"同业互助，质量至上",issues:["trade","tradition"],conditionTypes:["stratum_approval_above","stratum_income_above","resource_price_below","price_stability"],preferredStrata:["artisan","merchant"],stratumWeights:{artisan:3,merchant:2},activeEffects:{tradeBonus:.12,approval:{artisan:8,merchant:8},productionInputCost:{furniture_workshop:-.18,tailor_workshop:-.18,loom_house:-.15}},unsatisfiedPenalty:{approval:{artisan:-4},productionInputCost:{furniture_workshop:.05,tailor_workshop:.05}}},mercantilism:{name:"重商主义",spectrum:"center",icon:"Ship",color:"text-cyan-400",unlockEpoch:4,historicalRef:"东印度公司",description:"贸易国富之本",issues:["trade","wealth"],conditionTypes:["stratum_income_above","stratum_influence_above","resource_price_above","inflation_above"],preferredStrata:["merchant","capitalist"],stratumWeights:{merchant:3,capitalist:2},activeEffects:{tradeBonus:.18,incomePercentBonus:.08},unsatisfiedPenalty:{approval:{merchant:-4}}},absolutism:{name:"绝对君主制",spectrum:"right",icon:"Crown",color:"text-purple-500",unlockEpoch:4,historicalRef:"路易十四、彼得大帝",description:"朕即国家",issues:["hierarchy","centralization"],conditionTypes:["coalition_size_below","legitimacy_above"],preferredStrata:["official","landowner"],stratumWeights:{official:2},activeEffects:{taxEfficiency:.15,buildingCostMod:-.12},unsatisfiedPenalty:{}},humanism:{name:"人文主义",spectrum:"center",icon:"Book",color:"text-rose-300",unlockEpoch:4,historicalRef:"文艺复兴",description:"以人为本",issues:["education","progress"],conditionTypes:["stratum_approval_above","epoch_at_least"],preferredStrata:["scribe","artisan","engineer"],stratumWeights:{scribe:3,artisan:2},activeEffects:{researchSpeed:.15,cultureBonus:.12},unsatisfiedPenalty:{}},colonialism:{name:"殖民主义",spectrum:"right",icon:"Globe",color:"text-emerald-500",unlockEpoch:4,historicalRef:"大航海时代",description:"开拓新世界",issues:["expansion","trade"],conditionTypes:["stratum_income_above","at_war"],preferredStrata:["merchant","soldier","navigator"],stratumWeights:{merchant:2,soldier:1.5},activeEffects:{tradeBonus:.15,diplomaticBonus:.8},unsatisfiedPenalty:{}},classical_liberalism:{name:"古典自由主义",spectrum:"center",icon:"Lightbulb",color:"text-yellow-400",unlockEpoch:5,historicalRef:"洛克、亚当斯密",description:"自由放任经济",issues:["liberty","free_market"],conditionTypes:["avg_tax_below","stratum_approval_above","price_stability","deflation_below"],preferredStrata:["merchant","capitalist","artisan"],stratumWeights:{merchant:2,capitalist:2.5,artisan:1.5},activeEffects:{incomePercentBonus:.12,populationGrowth:.08},unsatisfiedPenalty:{approval:{merchant:-4,capitalist:-4}}},enlightened_despotism:{name:"开明专制",spectrum:"center",icon:"GraduationCap",color:"text-indigo-400",unlockEpoch:5,historicalRef:"腎特烈大帝、叶卡捷琳娜",description:"国王为国家第一仆人",issues:["reform","centralization"],conditionTypes:["coalition_size_below","legitimacy_above","stability_above"],preferredStrata:["official","scribe","engineer"],stratumWeights:{official:2,scribe:2,engineer:1.5},activeEffects:{researchSpeed:.18,buildingCostMod:-.08},unsatisfiedPenalty:{}},conservatism:{name:"保守主义",spectrum:"right",icon:"Shield",color:"text-gray-400",unlockEpoch:5,historicalRef:"伯克、梅特涅",description:"维护传统秩序",issues:["tradition","stability"],conditionTypes:["stability_above","legitimacy_above"],preferredStrata:["landowner","cleric","official"],stratumWeights:{landowner:2,cleric:2},activeEffects:{stability:.12,legitimacyBonus:.08},unsatisfiedPenalty:{stability:-.04}},utopian_socialism:{name:"空想社会主义",spectrum:"left",icon:"Sparkles",color:"text-pink-400",unlockEpoch:5,historicalRef:"莫尔乌托邦、欧文",description:"构建理想社会",issues:["equality","progress"],conditionTypes:["stratum_approval_above","stratum_living_standard"],preferredStrata:["worker","artisan","peasant","scribe"],stratumWeights:{scribe:2,worker:1.5,artisan:1.5},activeEffects:{researchSpeed:.12,approval:{worker:8}},unsatisfiedPenalty:{}},physiocracy:{name:"重农主义",spectrum:"center",icon:"Wheat",color:"text-lime-400",unlockEpoch:5,historicalRef:"魁奈学派",description:"土地是财富之源",issues:["land","free_market"],conditionTypes:["stratum_influence_above","stratum_approval_above","food_affordable","resource_price_below"],preferredStrata:["landowner","peasant"],stratumWeights:{landowner:2.5,peasant:2},activeEffects:{gatherBonus:.15,approval:{peasant:8,landowner:8}},unsatisfiedPenalty:{approval:{landowner:-4}}},marxism:{name:"马克思主义",spectrum:"left",icon:"Factory",color:"text-red-500",unlockEpoch:6,historicalRef:"共产党宣言",description:"工人阶级专政",issues:["equality","revolution","collectivism"],conditionTypes:["coalition_includes","stratum_influence_above"],preferredStrata:["worker","miner","artisan"],stratumWeights:{worker:4,miner:2},activeEffects:{industryBonus:.18,approval:{worker:15,miner:12},productionInputCost:{steel_foundry:-.22,textile_mill:-.18,building_materials_plant:-.18}},unsatisfiedPenalty:{approval:{worker:-6},organizationDecay:-.08,productionInputCost:{steel_foundry:.08,textile_mill:.06}}},social_democracy:{name:"社会民主主义",spectrum:"left",icon:"HeartHandshake",color:"text-rose-400",unlockEpoch:6,historicalRef:"伯恩斯坦修正主义",description:"渐进改良",issues:["equality","welfare"],conditionTypes:["stratum_approval_above","stratum_living_standard","stability_above","food_affordable","price_stability"],preferredStrata:["worker","scribe","artisan","peasant"],stratumWeights:{worker:2,scribe:1.5,artisan:1.5},activeEffects:{approval:{worker:12,peasant:8},stability:.08},unsatisfiedPenalty:{approval:{worker:-4}}},anarchism:{name:"无政府主义",spectrum:"left",icon:"CircleSlash",color:"text-gray-500",unlockEpoch:6,historicalRef:"巴枯宁、克鲁泡特金",description:"废除一切权威",issues:["liberty","revolution"],conditionTypes:["stability_below","stratum_approval_below"],preferredStrata:["worker","artisan","peasant"],stratumWeights:{worker:2,artisan:2},activeEffects:{needsReduction:.15},unsatisfiedPenalty:{stability:-.06}},nationalism:{name:"民族主义",spectrum:"right",icon:"Flag",color:"text-orange-500",unlockEpoch:6,historicalRef:"俨斯麦统一德国",description:"民族国家至上",issues:["nation","military"],conditionTypes:["at_war","stratum_approval_above"],preferredStrata:["soldier","official","landowner"],stratumWeights:{soldier:2.5,official:1.5},activeEffects:{militaryBonus:.22,approval:{soldier:12}},unsatisfiedPenalty:{}},neoliberalism:{name:"新自由主义",spectrum:"right",icon:"TrendingUp",color:"text-emerald-400",unlockEpoch:6,historicalRef:"哈耶克、弗里德曼",description:"市场万能",issues:["free_market","privatization"],conditionTypes:["stratum_income_above","avg_tax_below","resource_price_above","inflation_above"],preferredStrata:["capitalist","merchant"],stratumWeights:{capitalist:4,merchant:2},activeEffects:{incomePercentBonus:.18,tradeBonus:.12},unsatisfiedPenalty:{approval:{capitalist:-6}}},technocracy:{name:"技术官僚主义",spectrum:"center",icon:"Cpu",color:"text-sky-400",unlockEpoch:6,historicalRef:"圣西门、专家治国",description:"让专家决策",issues:["efficiency","progress"],conditionTypes:["epoch_at_least","stratum_influence_above"],preferredStrata:["engineer","scribe","official"],stratumWeights:{engineer:3,scribe:2},activeEffects:{researchSpeed:.22,industryBonus:.12,productionInputCost:{printing_house:-.28,factory:-.22,steel_foundry:-.15}},unsatisfiedPenalty:{}},digital_democracy:{name:"数字民主",spectrum:"center",icon:"Monitor",color:"text-cyan-300",unlockEpoch:7,historicalRef:"电子政务、区块链投票",description:"网络参与决策",issues:["liberty","progress"],conditionTypes:["coalition_size_above","stability_above","legitimacy_above"],preferredStrata:["engineer","scribe","worker"],stratumWeights:{engineer:2,scribe:2,worker:1.5},activeEffects:{legitimacyBonus:.18,stability:.12},unsatisfiedPenalty:{}},eco_socialism:{name:"生态社会主义",spectrum:"left",icon:"Leaf",color:"text-green-500",unlockEpoch:7,historicalRef:"绿色新政",description:"环境公正",issues:["equality","nature"],conditionTypes:["stratum_approval_above","stability_above"],preferredStrata:["worker","peasant","engineer"],stratumWeights:{worker:2,peasant:2,engineer:1.5},activeEffects:{needsReduction:.15,stability:.08},unsatisfiedPenalty:{}},transhumanism:{name:"超人类主义",spectrum:"right",icon:"Zap",color:"text-violet-400",unlockEpoch:7,historicalRef:"技术奇点",description:"超越人类极限",issues:["progress","efficiency"],conditionTypes:["epoch_at_least","stratum_income_above"],preferredStrata:["engineer","capitalist"],stratumWeights:{engineer:4,capitalist:2},activeEffects:{researchSpeed:.28,populationGrowth:.08},unsatisfiedPenalty:{}}},ia={};Object.entries(Is).forEach(([e,o])=>{ia[e]={id:e,...o,triggerCondition:()=>!1,conditionText:"条件待生成"}});function na(e,o,i){return!i||i.length===0?!1:i.every(n=>{const r=js[n.typeId];return r?r.check(n.params,o):!1})}const Di={INITIAL_MIN:50,MAX:100,MIN:0,COUP_THRESHOLD:25,DAILY_CHANGES:{stanceSatisfied:.4,stanceUnsatisfied:-.3,financialSatisfied:.3,financialUncomfortable:-.1,financialStruggling:-.2,financialDesperate:-.25,stabilityHigh:.2,stabilityLow:-.1,salaryPaid:.15,salaryUnpaid:-.3}},Xo=(e,o,i=[])=>{const n=qe[e];return!(!n||n.unlockTech&&!i.includes(n.unlockTech)||typeof n.unlockEpoch=="number"&&n.unlockEpoch>o)},aa=e=>{var o;return((o=qe[e])==null?void 0:o.basePrice)||1},Os=(e,o,i=0)=>{var j,H,O,U;if(!o)return aa(e);const n=aa(e),r=(O=(H=(j=o==null?void 0:o.economyTraits)==null?void 0:j.resourceBias)==null?void 0:H[e])!=null?O:1,a=((U=o.inventory)==null?void 0:U[e])||0,u=Math.round(500*Math.pow(r,1.2)),l=Math.max(.8,Math.min(1.5,(o.wealth||1e3)/1e3)),c=o.epoch||0,d=1+c*.5+Math.pow(c,1.3)*.1,f=u*l*d,b=f>0?a/f:1,g=Math.max(0,1-b),p=Math.max(0,b-1),w=1+Math.min(2.5,g*.9),x=1-Math.min(.95,p*.6),T=w*x,M=1+(Math.max(.6,Math.min(1.6,r))-1)*.25,C=o.foreignWars?Object.values(o.foreignWars).filter(Q=>Q==null?void 0:Q.isAtWar).length:0,k=(o.isAtWar?1:0)+C,q=k>0?1+Math.min(.75,k*.15):1;let B=n*M*T*q;return B=Math.max(n*.25,Math.min(n*4,B)),Math.max(.5,parseFloat(B.toFixed(2)))},Ds=(e="")=>e?e.split("").reduce((o,i)=>o+i.charCodeAt(0),0):0,di=(e,o={},i=0)=>{var k,q,B,j;const n=(B=(q=(k=o==null?void 0:o.economyTraits)==null?void 0:k.resourceBias)==null?void 0:q[e])!=null?B:1,r=Math.round(500*Math.pow(n,1.2)),a=Math.max(.8,Math.min(1.5,(o.wealth||1e3)/1e3)),u=o.epoch||0,l=1+u*.5+Math.pow(u,1.3)*.1,c=r*a*l,d=typeof o.marketVolatility=="number"?o.marketVolatility:.3,f=((j=o==null?void 0:o.inventory)==null?void 0:j[e])||0,b=Ds(e),g=Math.sin(i*.015+b),p=c*(1+g*d),w=n>1?.3:n<1?1.5:.8,x=n>1?.4:n<1?2:1.2,T=p*w,A=p*x,M=Math.max(0,T-f),C=Math.max(0,f-A);return{isShortage:M>0,isSurplus:C>0,shortageAmount:M,surplusAmount:C,target:p}},Qo={DESTITUTE:{level:"赤贫",icon:"Skull",color:"text-gray-400",bgColor:"bg-gray-900/30",borderColor:"border-gray-500/30",approvalCap:30},POOR:{level:"贫困",icon:"AlertTriangle",color:"text-red-400",bgColor:"bg-red-900/20",borderColor:"border-red-500/30",approvalCap:50},SUBSISTENCE:{level:"温饱",icon:"UtensilsCrossed",color:"text-yellow-400",bgColor:"bg-yellow-900/20",borderColor:"border-yellow-500/30",approvalCap:70},COMFORTABLE:{level:"小康",icon:"Home",color:"text-green-400",bgColor:"bg-green-900/20",borderColor:"border-green-500/30",approvalCap:85},PROSPEROUS:{level:"富裕",icon:"Gem",color:"text-blue-400",bgColor:"bg-blue-900/20",borderColor:"border-blue-500/30",approvalCap:95},LUXURIOUS:{level:"奢华",icon:"Crown",color:"text-purple-400",bgColor:"bg-purple-900/20",borderColor:"border-purple-500/30",approvalCap:100}};function Ls(e,o,i=0,n=100){if(o<=0){const a=n>0?i/n:0;return a<.5?a*20:a<1?10+(a-.5)*30:a<2?25+(a-1)*10:Math.min(50,35+(a-2)*5)}const r=(e-o)/o;return r>=1?50:r>=0?25+r*25:r>=-1?Math.max(0,25+r*25):0}function Ns(e,o,i=30,n=100){if(o<=0){const a=n>0?e/n:0;return a<.5?a*10:a<1?5+(a-.5)*10:Math.min(20,10+(a-1)*5)}const r=e/o;return Math.min(20,r/i*20)}function Fs(e){return e<20?Qo.DESTITUTE:e<40?Qo.POOR:e<55?Qo.SUBSISTENCE:e<70?Qo.COMFORTABLE:e<85?Qo.PROSPEROUS:Qo.LUXURIOUS}function fi(e,o=1,i=1,n=6,r=!1){const a=Math.max(e,o*.3);let u;a<=0?u=.3:a<1?u=.3+a*.7:r?u=1+(a-1)*.8:u=1+Math.log(a)*.5;let l;u<=1?l=u*(.7+.3*Math.min(1.2,i)):l=1+(u-1)*i;let c;o<.3?c=.5:o<1?c=.5+(o-.3)*(.5/.7):o<2?c=1:r?c=1+(o-2)*.05*i:c=1+Math.min(.15,(o-2)*.025*i);let d=l*c;return o<.5?d=Math.min(d,.8):o<1?d=Math.min(d,1):o<2&&(d=Math.min(d,1.2)),Math.max(.3,Math.min(n,d))}function $s({consumptionMultiplier:e=1,incomeRatio:o=null,wealthRatio:i=null,livingStandardLevel:n=null}={}){var g;const r=(p,w,x)=>Math.min(x,Math.max(w,p)),a=Number.isFinite(e)?Math.max(.3,e):1,u=Number.isFinite(o)?r(.4+.6*Math.min(1.5,o),.3,1.2):1,l=Number.isFinite(i)?r(.4+.6*Math.min(2,i)/2,.3,1.2):1,c=.6+.4*((u+l)/2),f=n&&(g={赤贫:.05,贫困:.15,温饱:.4,小康:.9,富裕:1.1,奢华:1.25}[n])!=null?g:1,b=a*f*c;return r(b,.05,1.6)}function Gs(e,o=1,i=1,n=null){if(e<1&&o<2)return 0;const r=Math.max(e,o*.5);let a;r<=0?a=.3:r<1?a=.3+r*.7:a=1+Math.log(r)*.7;const u=(i+1)/2;let l;a<=1?l=a*(.8+.2*Math.min(1.2,u)):l=1+(a-1)*u;let c;o<.3?c=.5:o<1?c=.5+(o-.3)*(.5/.7):o<2?c=1:c=1+Math.min(.25,(o-2)*.03);const d=l*c;let f=Math.max(.3,Math.min(10,d));if(!n)return f;const g={赤贫:0,贫困:0,温饱:1.49,小康:3,富裕:6,奢华:10}[n];return o<1&&(f=Math.min(f,.99)),g===void 0?f:Math.min(g,f)}function qs(e,o,i,n=1,r=100){const a=o*30;let u=e+a+i,l=0;r>0&&(l=Math.min(60,.7*Math.sqrt(r)));let c=0;n>0&&(c=Math.min(40,40*(1-Math.exp(-n*.5))));const d=l+c;return u*.5+d*.5}function Us({count:e,income:o=0,expense:i=0,wealthValue:n=0,startingWealth:r=100,essentialCost:a=0,shortagesCount:u=0,effectiveNeedsCount:l=0,unlockedLuxuryTiers:c=0,totalLuxuryTiers:d=0,previousScore:f=null,isNewStratum:b=!1,maxConsumptionMultiplier:g=6,wealthElasticity:p=1,greedy:w=!1}){if(e<=0)return null;const x=o/e,T=i/e,A=n/e,M=a/e,C=Ls(x,M,A,r);let k;if(l>0)k=Math.max(0,(l-u)/l);else{const fe=r>0?A/r:0;k=Math.min(1,fe)}const q=Ns(A,T,30,r),B=r>0?A/r:0,j=qs(C,k,q,B,A),H=b?1:.15,O=f!==null?f*(1-H)+j*H:j,U=Fs(O),Q=M>0?x/M:x>0?10:0,I=fi(Q,B,p,g,w),W=d>0?c/d:0;return{score:O,targetScore:j,incomeAdequacyScore:C,satisfactionRate:k,financialSecurityScore:q,incomePerCapita:x,expensePerCapita:T,wealthPerCapita:A,wealthMultiplier:I,wealthRatio:B,luxuryUnlockRatio:W,unlockedLuxuryTiers:c,totalLuxuryTiers:d,level:U.level,icon:U.icon,color:U.color,bgColor:U.bgColor,borderColor:U.borderColor,approvalCap:U.approvalCap}}function Vs(e){return e<.5?{icon:"Skull",color:"text-gray-400",level:"赤贫",approvalCap:30}:e<1?{icon:"AlertTriangle",color:"text-red-400",level:"贫困",approvalCap:50}:e<1.5?{icon:"UtensilsCrossed",color:"text-yellow-400",level:"温饱",approvalCap:70}:e<2.5?{icon:"Home",color:"text-green-400",level:"小康",approvalCap:85}:e<4?{icon:"Gem",color:"text-blue-400",level:"富裕",approvalCap:95}:{icon:"Crown",color:"text-purple-400",level:"奢华",approvalCap:100}}$n.reduce((e,o)=>(e[o.id]=o,e),{});const Wt=["official","cleric","capitalist","landowner","knight","engineer","navigator","merchant","soldier","scribe","worker","artisan","miner","lumberjack","serf","peasant"],zs=.0025,Hs=.2,Ys=.25,Js=1e-4,Xs=1.5,Qs=2,Zs=1.5,Ks=.8,sa=5,er=.5,ra=["food","cloth"],Zo=1e-4,Li=1,tr=new Set(["science","culture"]),or=45,ir=30,nr=.003,ar=.001,Ni=20,sr=.4,ca=200,rr=.05,pn=3,cr=30,uo={unemployed:0,serf:0,peasant:1,lumberjack:1,miner:1,worker:1,artisan:2,soldier:2,navigator:2,scribe:2,merchant:2,cleric:2,official:3,landowner:3,capitalist:3,knight:3,engineer:3},lr={0:0,1:0,2:.5,3:.4},ur={landowner:.35,capitalist:.35,soldier:0},dr=2,fr=.2,vt=(e,o,i)=>!Number.isFinite(e)||e<o?o:e>i?i:e,pr=1e12,qo=(e,o=0)=>Number.isFinite(e)?Math.max(0,Math.min(e,pr)):o,Nt=e=>{if(e==="silver")return!1;const o=qe[e];return o?tr.has(e)?!0:!o.type||o.type!=="virtual":!1},fo=e=>{if(e==="silver")return 1;const o=qe[e];return(o==null?void 0:o.basePrice)||1},hn=(e={},o=1)=>{if(!e||typeof e!="object")return{};const i={};return Object.entries(e).forEach(([n,r])=>{typeof r=="number"?i[n]=r*o:r&&typeof r=="object"&&!Array.isArray(r)?i[n]=hn(r,o):i[n]=r}),i},hr=(e,o)=>{if(!e||!o)return{adjustments:{},approvalPenalties:{},adminCost:0};const i=Object.values(e).reduce((u,l)=>u+l,0),n={},r={};let a=0;return Object.entries(o).forEach(([u,l])=>{const c=e[u]||0,d=i>0?c/i*100:0,f=l-d;Math.abs(f)>1&&(n[u]=f*.1,f<-5&&(r[u]=Math.floor(f/2)),a+=Math.abs(f)*.5)}),{adjustments:n,approvalPenalties:r,adminCost:Math.round(a)}},mr=1,pi=(e,o={},i={})=>{var w,x,T,A;if(!e)return{profit:0,outputValue:0,inputValue:0,wageCost:0,businessTax:0};const n=(o==null?void 0:o.prices)||{},r=(o==null?void 0:o.wages)||{},a=M=>{var C;return!M||M==="silver"?1:(C=n[M])!=null?C:1},u=Object.entries(e.output||{}).reduce((M,[C,k])=>M+a(C)*k,0),l=Object.entries(e.input||{}).reduce((M,[C,k])=>M+a(C)*k,0),c=(x=(w=i==null?void 0:i.businessTaxRates)==null?void 0:w[e.id])!=null?x:1,f=((T=e.businessTaxBase)!=null?T:.1)*c,b=e.owner;let g=0;for(const[M,C]of Object.entries(e.jobs||{})){if(M===b)continue;const k=(A=r[M])!=null?A:.1;g+=k*C}return{profit:u-l-f-g,outputValue:u,inputValue:l,wageCost:g,businessTax:f}},gr=(e,o,i,n,r,a={},u={},l={})=>{var A;if(!e||!o)return{canExpand:!1,reason:"无效建筑",cost:0,profit:0,roi:0};const c=n==null?void 0:n[e.id];if(!(c!=null&&c.allowed))return{canExpand:!1,reason:"未允许扩张",cost:0,profit:0,roi:0};const d=(a==null?void 0:a.prices)||{},f=e.baseCost||{};let b=0;for(const[M,C]of Object.entries(f)){const k=(A=d[M])!=null?A:1;b+=C*k}b=b>0?Math.round(b):100;const p=pi(e,a,u).profit,w=b>0?p/b:0,x=l==null?void 0:l[e.id];return(Number.isFinite(x)?x:1)<mr?{canExpand:!1,reason:"岗位未满",cost:b,profit:p,roi:w}:p<=0?{canExpand:!1,reason:"建筑不盈利",cost:b,profit:p,roi:w}:i<b?{canExpand:!1,reason:"业主财富不足",cost:b,profit:p,roi:w}:{canExpand:!0,reason:null,cost:b,profit:p,roi:w}},yr=(e,o,i,n,r={},a={},u={})=>{const l=[],c={};if(!e||!o||!i)return console.log("[FREE MARKET] processOwnerExpansions early return:",{hasBuildings:!!e,hasClassWealth:!!o,hasExpansionSettings:!!i}),{expansions:l,wealthDeductions:c};const d=[],f={},b=[];for(const g of e){if(!g.owner)continue;const p=g.owner,w=o[p]||0,x=n[g.id]||0,{canExpand:T,reason:A,cost:M,profit:C,roi:k}=gr(g,p,w,i,x,r,a,u);if(T){const q=M>0?Math.max(.01,C*C/M):.01,B={buildingId:g.id,owner:p,cost:M,profit:C,roi:k,weight:q};d.push(B),f[p]||(f[p]=[]),f[p].push(B)}else b.push({buildingId:g.id,owner:p,ownerWealth:w,reason:A,cost:M,profit:C,roi:k,staffingRatio:u==null?void 0:u[g.id],settingsForBuilding:i[g.id]})}if(console.log("[FREE MARKET] processOwnerExpansions:",{totalBuildingsChecked:e.filter(g=>g.owner).length,candidatesFound:d.length,candidates:d.map(g=>({id:g.buildingId,profit:g.profit.toFixed(2),roi:(g.roi*100).toFixed(1)+"%",weight:g.weight.toFixed(2)})),firstFewRejections:b.slice(0,5)}),d.length>0){const g=[];Object.entries(f).forEach(([p,w])=>{if(!w.length)return;const x=e.filter(O=>O.owner===p).reduce((O,U)=>O+(n[U.id]||0),0),T=x%2===0?"roi":"profit",A=[...w].sort((O,U)=>U[T]-O[T]),M=Math.ceil(A.length/3),C=[A.slice(0,M),A.slice(M,M*2),A.slice(M*2)],k=x%3;let q=null;for(let O=0;O<C.length;O+=1){const U=(k+O)%C.length;if(C[U].length>0){q=C[U];break}}if(!q||q.length===0)return;const B=q.reduce((O,U)=>O+U.weight,0);let j=Math.random()*B,H=q[0];for(const O of q)if(j-=O.weight,j<=0){H=O;break}g.push({...H,_debug:{ownerBuildingTotal:x,metric:T,tierIndex:C.indexOf(q),probability:B>0?H.weight/B*100:0}})}),g.length>0&&(console.log("[FREE MARKET] Selected for expansion:",g.map(p=>({buildingId:p.buildingId,owner:p.owner,profit:p.profit.toFixed(2),roi:(p.roi*100).toFixed(1)+"%",weight:p.weight.toFixed(2),metric:p._debug.metric,tierIndex:p._debug.tierIndex,probability:p._debug.probability.toFixed(1)+"%"}))),g.forEach(p=>{l.push(p),c[p.owner]=(c[p.owner]||0)+p.cost}))}return{expansions:l,wealthDeductions:c}},br=(e,o,i,n)=>{var l;if(!(n!=null&&n.enabled))return{adjustment:0,isIncome:!1,effectivePrice:i};const r=(l=n.governmentSellPrices)==null?void 0:l[e];if(r==null)return{adjustment:0,isIncome:!1,effectivePrice:i};const a=r,u=(r-i)*o;return u>0?{adjustment:u,isIncome:!0,effectivePrice:a}:u<0?{adjustment:Math.abs(u),isIncome:!1,effectivePrice:a}:{adjustment:0,isIncome:!1,effectivePrice:i}},Mr=(e,o,i,n)=>{var l;if(!(n!=null&&n.enabled))return{adjustment:0,isIncome:!1,effectivePrice:i};const r=(l=n.governmentBuyPrices)==null?void 0:l[e];if(r==null)return{adjustment:0,isIncome:!1,effectivePrice:i};const a=r,u=(i-r)*o;return u>0?{adjustment:u,isIncome:!0,effectivePrice:a}:u<0?{adjustment:Math.abs(u),isIncome:!1,effectivePrice:a}:{adjustment:0,isIncome:!1,effectivePrice:i}},la=({resourceKey:e,amount:o,marketPrice:i,priceControls:n,taxBreakdown:r,resources:a})=>{const u=br(e,o,i,n);if(u.adjustment>0)if(u.isIncome)r.priceControlIncome=(r.priceControlIncome||0)+u.adjustment;else{const l=a.silver||0;if(l>=u.adjustment)a.silver=l-u.adjustment,r.priceControlExpense=(r.priceControlExpense||0)+u.adjustment;else return{effectivePrice:i,success:!1}}return{effectivePrice:u.effectivePrice,success:!0}},wr=({resourceKey:e,amount:o,marketPrice:i,priceControls:n,taxBreakdown:r,resources:a})=>{const u=Mr(e,o,i,n);if(u.adjustment>0)if(u.isIncome)r.priceControlIncome=(r.priceControlIncome||0)+u.adjustment;else{const l=a.silver||0;if(l>=u.adjustment)a.silver=l-u.adjustment,r.priceControlExpense=(r.priceControlExpense||0)+u.adjustment;else return{effectivePrice:i,success:!1}}return{effectivePrice:u.effectivePrice,success:!0}},no={VERY_EASY:"very_easy",EASY:"easy",NORMAL:"normal",HARD:"hard",VERY_HARD:"very_hard",EXTREME:"extreme"},mn=no.EASY,ua={[no.VERY_EASY]:{id:no.VERY_EASY,name:"和平",description:"极其轻松，专注于建设，几乎没有战争威胁",icon:"🕊️",organizationGrowthMultiplier:.2,organizationDecayMultiplier:2,satisfactionThreshold:25,buildingCostGrowthFactor:1.05,aiWarDeclarationChance:.1,aiMilitaryActionChance:.2,aiMilitaryCooldownBonus:30,aiMinWarEpoch:4,raidDamageMultiplier:.3,raidPopulationLossMultiplier:.2,stabilityDampeningBonus:.25,newGameGracePeriod:150,inventoryTargetDaysMultiplier:.5,taxToleranceMultiplier:2,resourceConsumptionMultiplier:.9,buildingCostBaseMultiplier:1,techCostMultiplier:1,populationGrowthMultiplier:1.5,buildingUpgradeCostMultiplier:1,armyMaintenanceMultiplier:.5,maxConsumptionMultiplierBonus:-1,goodRelationChangeMultiplier:1.25,badRelationChangeMultiplier:.75,relationDailyDriftRate:.015,relationMonthlyDriftRateAlly:.04,relationMonthlyDriftRateNonAlly:.12,initialBuildings:{farm:3,lumber_camp:3,quarry:2,loom_house:2,market:1}},[no.EASY]:{id:no.EASY,name:"简单",description:"适合新手，叛乱增长减半，敌人攻击概率降低",icon:"🌱",organizationGrowthMultiplier:.5,organizationDecayMultiplier:1.5,satisfactionThreshold:35,buildingCostGrowthFactor:1.1,aiWarDeclarationChance:.5,aiMilitaryActionChance:.5,aiMilitaryCooldownBonus:15,aiMinWarEpoch:3,raidDamageMultiplier:.6,raidPopulationLossMultiplier:.5,stabilityDampeningBonus:.15,newGameGracePeriod:100,inventoryTargetDaysMultiplier:.7,taxToleranceMultiplier:1.5,resourceConsumptionMultiplier:1,buildingCostBaseMultiplier:1.2,techCostMultiplier:1.2,populationGrowthMultiplier:1.2,buildingUpgradeCostMultiplier:1.2,armyMaintenanceMultiplier:.75,maxConsumptionMultiplierBonus:0,goodRelationChangeMultiplier:1.1,badRelationChangeMultiplier:.9,relationDailyDriftRate:.018,relationMonthlyDriftRateAlly:.045,relationMonthlyDriftRateNonAlly:.16,initialBuildings:{farm:2,lumber_camp:2,quarry:1,loom_house:1}},[no.NORMAL]:{id:no.NORMAL,name:"普通",description:"标准游戏体验",icon:"⚖️",organizationGrowthMultiplier:1,organizationDecayMultiplier:1,satisfactionThreshold:45,buildingCostGrowthFactor:1.15,aiWarDeclarationChance:1,aiMilitaryActionChance:1,aiMilitaryCooldownBonus:0,aiMinWarEpoch:2,raidDamageMultiplier:1,raidPopulationLossMultiplier:1,stabilityDampeningBonus:0,newGameGracePeriod:0,inventoryTargetDaysMultiplier:1,taxToleranceMultiplier:1,resourceConsumptionMultiplier:1,buildingCostBaseMultiplier:1.5,techCostMultiplier:1.5,populationGrowthMultiplier:1,buildingUpgradeCostMultiplier:1.5,armyMaintenanceMultiplier:1,maxConsumptionMultiplierBonus:0,goodRelationChangeMultiplier:1,badRelationChangeMultiplier:1,relationDailyDriftRate:.02,relationMonthlyDriftRateAlly:.05,relationMonthlyDriftRateNonAlly:.2,initialBuildings:{farm:1,lumber_camp:1,loom_house:1}},[no.HARD]:{id:no.HARD,name:"困难",description:"高难度挑战，叛乱更频繁，敌人更具侵略性",icon:"🔥",organizationGrowthMultiplier:1.5,organizationDecayMultiplier:.5,satisfactionThreshold:60,buildingCostGrowthFactor:1.25,aiWarDeclarationChance:2,aiMilitaryActionChance:1.5,aiMilitaryCooldownBonus:-5,aiMinWarEpoch:1,raidDamageMultiplier:1.5,raidPopulationLossMultiplier:1.5,stabilityDampeningBonus:-.1,newGameGracePeriod:0,inventoryTargetDaysMultiplier:3,taxToleranceMultiplier:.7,resourceConsumptionMultiplier:3,buildingCostBaseMultiplier:3,techCostMultiplier:3,startingSilverMultiplier:4,populationGrowthMultiplier:.8,buildingUpgradeCostMultiplier:3,armyMaintenanceMultiplier:1.5,maxConsumptionMultiplierBonus:2,goodRelationChangeMultiplier:.75,badRelationChangeMultiplier:1.25,relationDailyDriftRate:.03,relationMonthlyDriftRateAlly:.08,relationMonthlyDriftRateNonAlly:.35,initialBuildings:{farm:1,lumber_camp:1}},[no.VERY_HARD]:{id:no.VERY_HARD,name:"灾厄",description:"极高难度，内忧外患接踵而至，生存即是胜利",icon:"☠️",organizationGrowthMultiplier:2,organizationDecayMultiplier:.2,satisfactionThreshold:75,buildingCostGrowthFactor:1.3,aiWarDeclarationChance:3.5,aiMilitaryActionChance:2.5,aiMilitaryCooldownBonus:-10,aiMinWarEpoch:0,raidDamageMultiplier:2.5,raidPopulationLossMultiplier:2.5,stabilityDampeningBonus:-.2,newGameGracePeriod:0,inventoryTargetDaysMultiplier:8,taxToleranceMultiplier:.4,resourceConsumptionMultiplier:5,buildingCostBaseMultiplier:5,techCostMultiplier:6,startingSilverMultiplier:6,populationGrowthMultiplier:.5,buildingUpgradeCostMultiplier:5,armyMaintenanceMultiplier:2,maxConsumptionMultiplierBonus:4,goodRelationChangeMultiplier:.6,badRelationChangeMultiplier:1.6,relationDailyDriftRate:.04,relationMonthlyDriftRateAlly:.1,relationMonthlyDriftRateNonAlly:.5,initialBuildings:{farm:1}},[no.EXTREME]:{id:no.EXTREME,name:"地狱",description:"绝望的深渊，只有最完美的策略才能存活",icon:"👿",organizationGrowthMultiplier:3,organizationDecayMultiplier:.05,satisfactionThreshold:80,buildingCostGrowthFactor:1.4,aiWarDeclarationChance:5,aiMilitaryActionChance:5,aiMilitaryCooldownBonus:-20,aiMinWarEpoch:0,raidDamageMultiplier:5,raidPopulationLossMultiplier:5,stabilityDampeningBonus:-.5,newGameGracePeriod:0,inventoryTargetDaysMultiplier:20,taxToleranceMultiplier:.2,resourceConsumptionMultiplier:8,buildingCostBaseMultiplier:10,techCostMultiplier:10,startingSilverMultiplier:10,populationGrowthMultiplier:.2,buildingUpgradeCostMultiplier:10,armyMaintenanceMultiplier:3,maxConsumptionMultiplierBonus:8,goodRelationChangeMultiplier:.45,badRelationChangeMultiplier:2,relationDailyDriftRate:.05,relationMonthlyDriftRateAlly:.12,relationMonthlyDriftRateNonAlly:.7,initialBuildings:{loom_house:1}}};function Qt(e){return ua[e]||ua[mn]}function da(e,o){const i=Qt(o);return e*i.aiWarDeclarationChance}function xr(e,o){const i=Qt(o);return e*i.aiMilitaryActionChance}function vr(e){return Qt(e).aiMinWarEpoch}function Cr(e){return Qt(e).aiMilitaryCooldownBonus}function Ko(e,o){const i=Qt(o);return Math.floor(e*i.raidDamageMultiplier)}function fa(e,o){const i=Qt(o);return Math.floor(e*i.raidPopulationLossMultiplier)}function pa(e,o){const i=Qt(o);return e<i.newGameGracePeriod}function ha(e){return Qt(e).buildingCostGrowthFactor||1.15}function _r(e){return Qt(e).inventoryTargetDaysMultiplier||1}function ma(e){var i,n;const o=Qt(e);return{good:(i=o.goodRelationChangeMultiplier)!=null?i:1,bad:(n=o.badRelationChangeMultiplier)!=null?n:1}}function Er(e){var i;return(i=Qt(e).relationDailyDriftRate)!=null?i:.02}function Pr(e){return Qt(e).populationGrowthMultiplier||1}function Tr(e){return Qt(e).armyMaintenanceMultiplier||1}function ga(e){return Qt(e).maxConsumptionMultiplierBonus||0}const kr=({popStructure:e,wealth:o,classIncome:i,classExpense:n,classShortages:r,epoch:a,techsUnlocked:u,priceMap:l={},livingStandardStreaks:c={}})=>{const d={},f={};return Object.keys(ce).forEach(b=>{var ve,Xe,L,F;const g=e[b]||0;if(g===0){d[b]=null,f[b]={streak:0,level:null,score:null};return}const p=ce[b],w=o[b]||0,x=(i==null?void 0:i[b])||0,T=(n==null?void 0:n[b])||0,A=p.startingWealth||100,M=(r[b]||[]).length,C=p.needs||{};let k=0;const q=["food","cloth"],B=ee=>typeof l=="function"?l(ee)||fo(ee):l[ee]||fo(ee);q.forEach(ee=>{if(C[ee]&&Xo(ee,a,u)){const oe=C[ee]*g,S=B(ee),ot=fo(ee),It=Math.max(S,ot);k+=oe*It}});const j=p.luxuryNeeds||{},H=Object.keys(j).map(Number).sort((ee,oe)=>ee-oe),O=p.wealthElasticity||1,U=g>0?x/g:0,Q=g>0?k/g:0,I=Q>0?U/Q:U>0?10:0,W=g>0?w/g:0,ae=A>0?W/A:0,fe=p.maxConsumptionMultiplier||6;fi(I,ae,O,fe);const ye=fi(I,ae,O,10),Ee=p.needs?Object.keys(p.needs).filter(ee=>Xo(ee,a,u)).length:0;let N=0,K=Ee;for(const ee of H)if(ye>=ee){N++;const oe=j[ee],ot=Object.keys(oe).filter(It=>Xo(It,a,u)).filter(It=>{var Ft;return!((Ft=p.needs)!=null&&Ft[It])});K+=ot.length}const ue=(c==null?void 0:c[b])||{},be=(ve=ue.score)!=null?ve:null,Ce=be===null;d[b]=Us({count:g,income:x,expense:T,wealthValue:w,startingWealth:A,essentialCost:k,shortagesCount:M,effectiveNeedsCount:K,unlockedLuxuryTiers:N,totalLuxuryTiers:H.length,previousScore:be,isNewStratum:Ce,maxConsumptionMultiplier:fe,wealthElasticity:O,greedy:p.greedy});const ke=ue.streak||0,tt=((Xe=d[b])==null?void 0:Xe.level)||null,we=(F=(L=d[b])==null?void 0:L.score)!=null?F:null;let z=ke;tt==="赤贫"||tt==="贫困"?z=ke+1:z=Math.max(0,ke-1),f[b]={streak:z,level:tt,score:we}}),{classLivingStandard:d,livingStandardStreaks:f}},Ar={event:!1,gameLoop:!1,mainThread:!1,simulation:!1,trade:!1,demands:!1},ya=(e=[])=>{const o={};return e.forEach(i=>{const n=String(i||"").trim();n&&(o[n]=!0)}),o},gn=e=>{if(e==null)return null;if(e===!0)return!0;if(e===!1)return null;if(typeof e=="string"){const o=e.trim();if(!o)return null;if(o==="true"||o==="all")return!0;try{const i=JSON.parse(o);return gn(i)}catch(i){const n=o.split(",").map(r=>r.trim()).filter(Boolean);return n.length>0?ya(n):null}}return Array.isArray(e)?ya(e):typeof e=="object"?e:null};let hi=null,ba;const Wr=()=>{const o=(typeof globalThis!="undefined"?globalThis:{}).__CIV_DEBUG__;if(o!==ba&&(ba=o,hi=null),hi)return hi;let i=gn(o);if(!i&&typeof localStorage!="undefined")try{i=gn(localStorage.getItem("civ_debug_flags"))}catch(n){i=null}return hi=i||Ar,hi},Rr=e=>{const o=Wr();return o===!0?!0:!!(o!=null&&o[e])},yn=(e,...o)=>{Rr(e)&&console.log(...o)},bn=[{name:"封建地主专制",priority:1e3,description:"由大地主阶级独揽政权",icon:"Castle",color:"text-amber-500",conditions:{exactCoalition:["landowner"]},effects:{categories:{gather:.15},buildingProductionMod:{farm:.2,large_estate:.2},resourceDemandMod:{food:-.1}}},{name:"垄断资本独裁",priority:1e3,description:"资本家独占国家权力",icon:"Briefcase",color:"text-blue-400",conditions:{exactCoalition:["capitalist"]},effects:{industry:.2,buildingProductionMod:{factory:.25,steel_works:.2},taxIncome:.15}},{name:"军事贵族专政",priority:1e3,description:"骑士阶层掌控一切",icon:"Shield",color:"text-red-500",conditions:{exactCoalition:["knight"]},effects:{militaryBonus:.25,buildingProductionMod:{barracks:.2,training_ground:.2},stability:.05}},{name:"官僚集权",priority:1e3,description:"官僚阶层垄断政权",icon:"ScrollText",color:"text-purple-400",conditions:{exactCoalition:["official"]},effects:{production:.1,taxIncome:.12,cultureBonus:.08,officialCapacity:5}},{name:"商业寡头政治",priority:1e3,description:"商人阶层掌控国家",icon:"Coins",color:"text-yellow-400",conditions:{exactCoalition:["merchant"]},effects:{buildingProductionMod:{market:.25,trade_port:.2,trading_post:.15},taxIncome:.15}},{name:"神权政治",priority:1e3,description:"神职人员统治国家",icon:"Cross",color:"text-indigo-400",conditions:{exactCoalition:["cleric"]},effects:{cultureBonus:.25,stability:.1,scienceBonus:-.15}},{name:"军人专政",priority:1e3,description:"军队独揽大权",icon:"Swords",color:"text-red-400",conditions:{exactCoalition:["soldier"]},effects:{militaryBonus:.3,buildingProductionMod:{barracks:.25,fortress:.2},stability:-.05}},{name:"工人无产阶级专政",priority:1e3,description:"工人阶级独揽政权",icon:"Hammer",color:"text-red-600",conditions:{exactCoalition:["worker"]},effects:{industry:.18,stratumDemandMod:{worker:-.12},taxIncome:-.1}},{name:"农民专政",priority:1e3,description:"农民阶级掌控政权",icon:"Wheat",color:"text-green-500",conditions:{exactCoalition:["peasant"]},effects:{categories:{gather:.2},buildingProductionMod:{farm:.18},resourceDemandMod:{food:-.1}}},{name:"技术官僚政治",priority:1e3,description:"工程师主导国家",icon:"Cog",color:"text-cyan-400",conditions:{exactCoalition:["engineer"]},effects:{scienceBonus:.25,industry:.12,buildingProductionMod:{library:.2,university:.25},officialCapacity:4}},{name:"学者治国",priority:1e3,description:"知识分子掌权",icon:"Feather",color:"text-blue-300",conditions:{exactCoalition:["scribe"]},effects:{scienceBonus:.2,cultureBonus:.15,militaryBonus:-.1}},{name:"行会共和",priority:1e3,description:"工匠行会主政",icon:"Anvil",color:"text-orange-400",conditions:{exactCoalition:["artisan"]},effects:{buildingProductionMod:{loom_house:.25,furniture_workshop:.2,tailor_workshop:.15},industry:.15}},{name:"海上共和国",priority:1e3,description:"航海家主导政权",icon:"Compass",color:"text-teal-400",conditions:{exactCoalition:["navigator"]},effects:{buildingProductionMod:{dockyard:.3,trade_port:.25},taxIncome:.1}},{name:"矿业工人政权",priority:1e3,description:"矿工阶级执政",icon:"Pickaxe",color:"text-gray-400",conditions:{exactCoalition:["miner"]},effects:{buildingProductionMod:{mine:.3,quarry:.25},categories:{gather:.15}}},{name:"农奴起义政权",priority:1e3,description:"佃农阶级执政",icon:"Users",color:"text-brown-400",conditions:{exactCoalition:["serf"]},effects:{categories:{gather:.12},stratumDemandMod:{serf:-.1},stability:-.1}},{name:"林业工人政权",priority:1e3,description:"樵夫阶级执政",icon:"Trees",color:"text-green-600",conditions:{exactCoalition:["lumberjack"]},effects:{buildingProductionMod:{lumber_camp:.3},categories:{gather:.12}}},{name:"独裁政体",priority:999,description:"单一阶层执政",icon:"Crown",color:"text-amber-400",conditions:{maxSize:1},effects:{stability:-.05,taxIncome:.05,officialCapacity:2}},{name:"工农联合政府",priority:910,description:"工人和农民阶级联合执政",icon:"Handshake",color:"text-red-500",conditions:{includes:["worker","peasant"],minCategoryShare:{proletariat:.7},maxSize:2},effects:{categories:{gather:.12},industry:.1,stratumDemandMod:{peasant:-.08,worker:-.08}}},{name:"人民民主专政",priority:900,description:"以工农联盟为基础的人民政权",icon:"Users",color:"text-red-600",conditions:{includes:["worker","peasant"],minCategoryShare:{proletariat:.7}},effects:{categories:{gather:.1},industry:.12,stratumDemandMod:{peasant:-.15,worker:-.15},taxIncome:-.15}},{name:"资产阶级共和国",priority:900,description:"资产阶级主导的民主政体",icon:"Building2",color:"text-blue-400",conditions:{minCategoryShare:{bourgeoisie:.6},excludes:["landowner","knight"],includesAny:["worker","artisan"]},effects:{industry:.15,taxIncome:.12,buildingProductionMod:{market:.1},officialCapacity:3}},{name:"资本主义寡头政治",priority:890,description:"资产阶级独占政权",icon:"Briefcase",color:"text-blue-500",conditions:{minCategoryShare:{bourgeoisie:.6},excludes:["landowner","knight"]},effects:{industry:.18,taxIncome:.18,buildingProductionMod:{factory:.2}}},{name:"封建神权联盟",priority:900,description:"传统贵族与教会联合执政",icon:"Crown",color:"text-purple-500",conditions:{minCategoryShare:{aristocracy:.6},includes:["cleric"]},effects:{categories:{gather:.12},cultureBonus:.15,stability:.08,scienceBonus:-.1}},{name:"贵族寡头政治",priority:890,description:"传统贵族阶层联合执政",icon:"Castle",color:"text-amber-500",conditions:{minCategoryShare:{aristocracy:.6}},effects:{categories:{gather:.1},taxIncome:.12,stratumDemandMod:{landowner:.1}}},{name:"军事-精英联盟",priority:900,description:"军队与精英阶层联合执政",icon:"Shield",color:"text-red-500",conditions:{minCategoryShare:{military:.5},includesAny:["capitalist","landowner"]},effects:{militaryBonus:.2,buildingProductionMod:{barracks:.15},taxIncome:.08}},{name:"军人政府",priority:890,description:"军事力量主导的政权",icon:"Swords",color:"text-red-600",conditions:{minCategoryShare:{military:.5}},effects:{militaryBonus:.22,buildingProductionMod:{barracks:.2},stability:-.03}},{name:"全民联合政府",priority:850,description:"跨越阶级的广泛联盟",icon:"Globe",color:"text-green-400",conditions:{minSize:8,includesGroup:["upper","middle","lower"]},effects:{production:.08,stratumDemandMod:{peasant:-.05,worker:-.05},stability:.12,officialCapacity:4}},{name:"民族团结政府",priority:840,description:"各阶层联合执政",icon:"Users",color:"text-teal-400",conditions:{minSize:5,includesGroup:["upper","middle","lower"]},effects:{production:.05,stability:.1,maxPop:15}},{name:"人民阵线",priority:830,description:"以劳动阶层为主体的广泛联盟",icon:"Flag",color:"text-red-500",conditions:{minSize:5,minCategoryShare:{proletariat:.5}},effects:{categories:{gather:.1},industry:.1,stratumDemandMod:{peasant:-.1,worker:-.1}}},{name:"大联盟政府",priority:800,description:"多阶层联合执政",icon:"Users",color:"text-blue-400",conditions:{minSize:5},effects:{production:.05,stability:.05}},{name:"工业资本主义政府",priority:700,description:"工业资产阶级主导",icon:"Factory",color:"text-blue-500",conditions:{minCategoryShare:{industrial:.6},includes:["capitalist"]},effects:{industry:.2,buildingProductionMod:{factory:.18},taxIncome:.12,resourceDemandMod:{food:.1}}},{name:"劳工联合政府",priority:700,description:"工业劳动者联合执政",icon:"Hammer",color:"text-orange-500",conditions:{minCategoryShare:{industrial:.6},includes:["worker","artisan"]},effects:{industry:.15,buildingProductionMod:{loom_house:.12},stratumDemandMod:{worker:-.08,artisan:-.08}}},{name:"地主-农民联盟",priority:700,description:"农村阶层联合执政",icon:"Wheat",color:"text-green-500",conditions:{minCategoryShare:{agrarian:.6},includes:["landowner"],minCategoryShare2:{proletariat:.001}},conditions:{minCategoryShare:{agrarian:.6,proletariat:1e-4},includes:["landowner"]},effects:{categories:{gather:.18},buildingProductionMod:{farm:.15},resourceDemandMod:{food:-.08}}},{name:"农民政府",priority:690,description:"农民阶级主导政权",icon:"Wheat",color:"text-green-600",conditions:{minCategoryShare:{agrarian:.6,proletariat:.5}},effects:{categories:{gather:.18},buildingProductionMod:{farm:.18},resourceDemandMod:{food:-.1}}},{name:"商业共和国",priority:700,description:"商业阶层主导政权",icon:"Ship",color:"text-teal-400",conditions:{minCategoryShare:{commercial:.5}},effects:{buildingProductionMod:{market:.2,trade_port:.18},taxIncome:.12}},{name:"技术精英政府",priority:700,description:"知识分子联合执政",icon:"GraduationCap",color:"text-cyan-400",conditions:{includes:["scribe","engineer"]},effects:{scienceBonus:.18,industry:.1,buildingProductionMod:{library:.15,university:.15},officialCapacity:3}},{name:"无产阶级政府",priority:600,description:"劳动人民掌握政权",icon:"Hammer",color:"text-red-500",conditions:{minCategoryShare:{proletariat:.7}},effects:{categories:{gather:.12},industry:.12,stratumDemandMod:{peasant:-.1,worker:-.1},taxIncome:-.1}},{name:"精英联盟政府",priority:600,description:"上层阶级联合执政",icon:"Crown",color:"text-amber-400",conditions:{minTotalShare:[{categories:["bourgeoisie","aristocracy"],threshold:.7}]},effects:{taxIncome:.15,stratumDemandMod:{landowner:.08,capitalist:.08}}},{name:"双头政治",priority:100,description:"两个阶层联合执政",icon:"Scale",color:"text-gray-400",conditions:{exactSize:2},effects:{stability:.03}},{name:"三方联盟",priority:100,description:"三个阶层共同执政",icon:"Triangle",color:"text-gray-400",conditions:{exactSize:3},effects:{stability:.05}},{name:"联合政府",priority:0,description:"多阶层联合执政",icon:"Users",color:"text-gray-400",conditions:{},effects:{stability:.03}},{name:"无执政联盟",priority:-1,description:"尚未建立执政联盟，政府缺乏社会基础",icon:"HelpCircle",color:"text-gray-400",conditions:{maxSize:0},effects:{production:-.1,taxIncome:-.2,stability:-.15}}],Br=e=>bn.find(o=>o.name===e),Sr=e=>{const o=Br(e);return o?o.effects:null},mi={HIGH:"high",MEDIUM:"medium",LOW:"low",ILLEGITIMATE:"illegitimate"},jr={赤贫:10,贫困:10,温饱:15,小康:15,富裕:10,奢华:0};function Ir(e,o,i){if(!Array.isArray(e)||e.length===0||i<=0)return 0;let n=0;return e.forEach(r=>{n+=o[r]||0}),n/i}function Or(e,o={}){const{classApproval:i={},coalitionMembers:n=[],classInfluence:r={}}=o;let a=e*100;if(n.length>0&&Object.keys(i).length>0){let u=0,l=0;n.forEach(d=>{var g;const f=(g=i[d])!=null?g:50,b=r[d]||1;l+=f*b,u+=b});const c=u>0?l/u:50;if(c<50){const d=.5+c/100;a*=d}}return Math.min(100,Math.max(0,a))}function Dr(e){return e>=80?mi.HIGH:e>=60?mi.MEDIUM:e>=40?mi.LOW:mi.ILLEGITIMATE}function Ma(e){return .3+Math.min(100,Math.max(0,e))/100*.7}function Lr(e){return Dr(e)===mi.ILLEGITIMATE?-15:0}function Nr(e,o){return Array.isArray(o)&&o.includes(e)}function Fr(e,o){return jr[e]||0}const $r={aristocracy:["landowner","knight","official"],bourgeoisie:["capitalist","merchant","engineer"],proletariat:["worker","miner","peasant","serf","lumberjack"],military:["soldier","knight"],clerical:["cleric"],intellectual:["scribe","engineer"],commercial:["merchant","navigator"],agrarian:["peasant","serf","landowner","lumberjack"],industrial:["worker","artisan","capitalist","engineer","miner"]},Gr={upper:{name:"上流阶级",keys:["merchant","official","landowner","capitalist","knight","engineer"]},middle:{name:"中产阶级",keys:["artisan","soldier","cleric","scribe","navigator"]},lower:{name:"下层阶级",keys:["peasant","serf","lumberjack","worker","miner"]}};function qr(e,o,i){if(!Array.isArray(e)||e.length===0)return Ur("无执政联盟")||{name:"无执政联盟",description:"尚未建立执政联盟，政府缺乏社会基础",icon:"HelpCircle",color:"text-gray-400"};let n=0;e.forEach(c=>{n+=o[c]||0});const r={},a=c=>{let d=0;return($r[c]||[]).forEach(b=>{e.includes(b)&&(d+=o[b]||0)}),d},u=c=>{if(r[c]!==void 0)return r[c];if(n<=0)return 0;const d=a(c)/n;return r[c]=d,d},l=bn.filter(c=>{const d=c.conditions;if(!d)return!0;const f=e.length;if(d.minSize!==void 0&&f<d.minSize||d.maxSize!==void 0&&f>d.maxSize||d.exactSize!==void 0&&f!==d.exactSize||d.exactCoalition&&(f!==d.exactCoalition.length||!d.exactCoalition.every(b=>e.includes(b)))||d.includes&&!d.includes.every(b=>e.includes(b))||d.excludes&&d.excludes.some(b=>e.includes(b))||d.includesAny&&!d.includesAny.some(b=>e.includes(b)))return!1;if(d.includesGroup)for(const b of d.includesGroup){const g=Gr[b];if(g&&!g.keys.some(p=>e.includes(p)))return!1}if(d.minCategoryShare){for(const[b,g]of Object.entries(d.minCategoryShare))if(u(b)<g)return!1}if(d.minTotalShare)for(const b of d.minTotalShare){let g=0;if(b.categories.forEach(p=>g+=u(p)),g<b.threshold)return!1}return!0});return l.sort((c,d)=>(d.priority||0)-(c.priority||0)),l.length>0?l[0]:{name:"联合政府",description:"多阶层联合执政",icon:"Users",color:"text-gray-400"}}function Ur(e){return bn.find(o=>o.name===e)}const Vr=(e={},o={},i={})=>{const n={};return Object.entries(ce).forEach(([r,a])=>{var b,g;let u=0,l=0;const c=a.needs||{};Object.entries(c).forEach(([p,w])=>{var A,M,C;if(!w||w<=0)return;const x=(C=(M=e==null?void 0:e[p])!=null?M:(A=qe[p])==null?void 0:A.basePrice)!=null?C:fo(p);if(!Number.isFinite(x)||x<=0)return;const T=Math.max(0,(i==null?void 0:i[p])||0);u+=w*x,l+=w*x*T});const d=Math.max(0,(b=a.headTaxBase)!=null?b:0),f=Math.max(0,(g=o==null?void 0:o[r])!=null?g:1);l+=d*f,n[r]={needsCost:Number.isFinite(u)?u:0,taxCost:Number.isFinite(l)?l:0}}),n},Fi=(e={},o={})=>{const i=Number.isFinite(o.livingCostWeight)?o.livingCostWeight:1,n=Number.isFinite(o.taxCostWeight)?o.taxCostWeight:1,r={};return Object.entries(e).forEach(([a,u])=>{const l=(u==null?void 0:u.needsCost)||0,c=(u==null?void 0:u.taxCost)||0;r[a]=Math.max(0,l*i+c*n)}),r},zr=(e={},o={})=>{let i=0,n=0;return Object.keys(e).forEach(r=>{const a=e[r]||0,u=o[r]||0;a>0&&u>0&&(i+=u*a,n+=a)}),n>0?i/n:Li},Hr=()=>({headTax:0,industryTax:0,businessTax:0,tariff:0,tariffSubsidy:0,subsidy:0,policyIncome:0,policyExpense:0,priceControlIncome:0,priceControlExpense:0}),Yr={minProfitMargin:.1,maxPurchaseAmount:20,exportProbability:.5,maxInventoryRatio:.3,minWealthForTrade:10,tradeDuration:3,tradeCooldown:0,enableDebugLog:!1,enableMerchantAssignments:!0,idleTradeEfficiency:.15,maxPartnersPerTick:4,maxResourcesScoredPerPartner:10,shortageWeight:2.2,surplusWeight:1.3},wa=e=>Math.max(0,Math.min(1,e)),Bo=(e,o=0)=>Number.isFinite(e)?e:o,Mn=(e=[],o=10)=>!Array.isArray(e)||e.length===0?[]:[...e].sort((n,r)=>((r==null?void 0:r.score)||0)-((n==null?void 0:n.score)||0)).slice(0,Math.max(0,o)),Jr=e=>Bo(e==null?void 0:e.relation,50),Xr=({partner:e})=>(e==null?void 0:e.isAtWar)===!0,Qr=({merchantAssignments:e,nations:o})=>{if(!e||typeof e!="object")return null;const i={};return Object.entries(e).forEach(([n,r])=>{const a=Math.max(0,Math.floor(Number(r)||0));a<=0||!(!Array.isArray(o)||o.some(l=>(l==null?void 0:l.id)===n))||(i[n]=a)}),Object.keys(i).length>0?i:null},Zr=({nations:e,maxPartners:o})=>{const n=(Array.isArray(e)?e.filter(a=>a&&!a.isRebelNation):[]).map(a=>({nationId:a.id,relation:Jr(a)})).sort((a,u)=>u.relation-a.relation).slice(0,Math.max(1,o)),r={};return n.forEach(a=>{r[a.nationId]=1}),r},xa=({resourceKey:e,res:o,demand:i={},marketPrice:n=1})=>{const r=Bo(o==null?void 0:o[e],0),a=Math.max(0,Bo(i==null?void 0:i[e],0));if(a<=0)return 0;const c=(r<=0?0:r/a)/8,d=wa(1-c),f=Math.min(1.5,Math.max(.7,Bo(n,1)/3));return d*f},va=({resourceKey:e,res:o,supply:i={},marketPrice:n=1})=>{const r=Bo(o==null?void 0:o[e],0),a=Math.max(0,Bo(i==null?void 0:i[e],0));if(a<=0)return 0;const c=(r<=0?0:r/a)/12,d=wa((c-1)/2),f=Math.min(1.6,Math.max(.6,2.2/Math.max(.5,Bo(n,1))));return d*f},wn=({resourceKey:e,partner:o,tick:i})=>{const n=Os(e,o,i);return Number.isFinite(n)&&n>0?n:null},Ca=e=>{const o=Number(e);return Number.isFinite(o)?Math.max(.1,Math.min(5,o)):1},Kr=({resourceKey:e,partner:o,tick:i,getLocalPrice:n,res:r,demand:a,tradeConfig:u,merchantTradePreferences:l})=>{var A,M;const c=n(e),d=wn({resourceKey:e,partner:o,tick:i});if(c==null||d==null)return null;const f=(c-d)/Math.max(1e-4,c);if(f<=0)return null;const b=xa({resourceKey:e,res:r,demand:a,marketPrice:c}),g=di(e,o,i),p=g!=null&&g.surplusAmount?Math.min(1,g.surplusAmount/Math.max(50,g.target||1)):0,w=u.shortageWeight*b+1*f+.6*p,x=Ca((M=(A=l==null?void 0:l.import)==null?void 0:A[e])!=null?M:1),T=w*x;return{type:"import",resourceKey:e,localPrice:c,foreignPrice:d,score:T,partnerSurplus:p,shortage:b,prefMultiplier:x}},ec=({resourceKey:e,partner:o,tick:i,getLocalPrice:n,res:r,supply:a,tradeConfig:u,merchantTradePreferences:l})=>{var M,C;const c=n(e),d=wn({resourceKey:e,partner:o,tick:i});if(c==null||d==null)return null;const f=(d-c)/Math.max(1e-4,c);if(f<=0||Bo(r==null?void 0:r[e],0)<=0)return null;const g=va({resourceKey:e,res:r,supply:a,marketPrice:c}),p=di(e,o,i),w=p!=null&&p.shortageAmount?Math.min(1,p.shortageAmount/Math.max(50,p.target||1)):0,x=u.surplusWeight*g+1*f+.6*w,T=Ca((C=(M=l==null?void 0:l.export)==null?void 0:M[e])!=null?C:1),A=x*T;return{type:"export",resourceKey:e,localPrice:c,foreignPrice:d,score:A,partnerShortage:w,surplus:g,prefMultiplier:T}},tc=({res:e,wealth:o,popStructure:i,supply:n,demand:r,nations:a,tick:u,taxPolicies:l,taxBreakdown:c,getLocalPrice:d,roleExpense:f,roleWagePayout:b,pendingTrades:g=[],lastTradeTime:p=0,gameSpeed:w=1,classFinancialData:x,logs:T,potentialResources:A,merchantAssignments:M=null,merchantTradePreferences:C=null})=>{var ve,Xe,L;const k=(i==null?void 0:i.merchant)||0;if(k<=0)return{pendingTrades:g,lastTradeTime:p,lockedCapital:0,capitalInvestedThisTick:0,completedTrades:[]};let q=0;const B=[],j=(l==null?void 0:l.resourceTaxRates)||{},H=(l==null?void 0:l.importTariffMultipliers)||(l==null?void 0:l.resourceTariffMultipliers)||{},O=(l==null?void 0:l.exportTariffMultipliers)||(l==null?void 0:l.resourceTariffMultipliers)||{},U=F=>{var S;const ee=j[F]||0,oe=(S=H[F])!=null?S:0;return ee+oe},Q=F=>{var S;const ee=j[F]||0,oe=(S=O[F])!=null?S:0;return ee+oe},I={...Yr,...((ve=ce.merchant)==null?void 0:ve.tradeConfig)||{}},W=[];if(g.forEach(F=>{if(F.daysRemaining-=1,F.daysRemaining<=0){if(b.merchant=(b.merchant||0)+F.revenue,F.type==="import"){if(e[F.resource]=(e[F.resource]||0)+F.amount,n[F.resource]=(n[F.resource]||0)+F.amount,F.partnerId&&Array.isArray(a)){const ee=a.find(oe=>(oe==null?void 0:oe.id)===F.partnerId);if(ee){ee.inventory||(ee.inventory={});const oe=ee.inventory[F.resource]||0;ee.inventory[F.resource]=Math.max(0,oe-F.amount)}}}else if(F.type==="export"&&F.partnerId&&Array.isArray(a)){const ee=a.find(oe=>(oe==null?void 0:oe.id)===F.partnerId);if(ee){ee.inventory||(ee.inventory={});const oe=ee.inventory[F.resource]||0;ee.inventory[F.resource]=Math.max(0,oe+F.amount)}}B.push({type:F.type,resource:F.resource,amount:F.amount,revenue:F.revenue,profit:F.profit,partnerId:F.partnerId}),I.enableDebugLog&&yn("trade","[Merchant Debug] ✅ Trade complete:",{type:F.type==="export"?"Export":"Import",partnerId:F.partnerId,resource:F.resource,amount:F.amount,revenue:F.revenue,profit:F.profit})}else W.push(F)}),!(u-p>=I.tradeCooldown))return{pendingTrades:W,lastTradeTime:p,lockedCapital:0,capitalInvestedThisTick:0,completedTrades:B};const ye=Object.keys(qe).filter(F=>Nt(F)).filter(F=>!A||A.has(F)),Ee=Qr({merchantAssignments:M,nations:a}),N=I.enableMerchantAssignments&&!!Ee,K=N?Ee:Zr({nations:a,maxPartners:I.maxPartnersPerTick}),ue=Object.entries(K).map(([F,ee])=>({nationId:F,count:ee})).filter(F=>F.count>0).slice(0,Math.max(1,I.maxPartnersPerTick)),be=N?1:I.idleTradeEfficiency,Ce=k>100?100:k,ke=k>100?k/100:1,tt=ue.reduce((F,ee)=>F+ee.count,0)||1,we=ue.map(F=>{const ee=F.count/tt,oe=Math.max(1,Math.round(Ce*ee));return{...F,batches:oe}});for(let F=0;F<we.length;F++){const ee=we[F],oe=Array.isArray(a)?a.find(Le=>(Le==null?void 0:Le.id)===ee.nationId):null;if(!oe||Xr({partner:oe}))continue;const S=[],ot=[],It=[];ye.forEach(Le=>{const ct=d(Le);if(ct==null)return;const Ct=xa({resourceKey:Le,res:e,demand:r,marketPrice:ct}),Zt=va({resourceKey:Le,res:e,supply:n,marketPrice:ct});Ct>.01&&ot.push({resourceKey:Le,score:Ct}),Zt>.01&&It.push({resourceKey:Le,score:Zt})});let Ft=Mn(ot,I.maxResourcesScoredPerPartner),yo=Mn(It,I.maxResourcesScoredPerPartner);if(Ft.length===0&&yo.length===0){const Le=Math.max(6,I.maxResourcesScoredPerPartner),ct=[];ye.forEach(Zt=>{const ut=d(Zt);if(ut==null)return;const Kt=wn({resourceKey:Zt,partner:oe,tick:u});if(Kt==null)return;const bo=(ut-Kt)/Math.max(1e-4,ut),$t=(Kt-ut)/Math.max(1e-4,ut),Gt=Math.max(bo,$t);Gt<=0||ct.push({resourceKey:Zt,score:Gt})});const Ct=Mn(ct,Le);Ft=Ct,yo=Ct,I.enableDebugLog&&yn("trade","[Merchant Debug] ⚠️ Trade 2.0 fallback prefilter active (no shortage/surplus signals).",{partnerId:oe==null?void 0:oe.id,fallbackCandidates:Ct.length})}if(Ft.forEach(({resourceKey:Le})=>{const ct=Kr({resourceKey:Le,partner:oe,tick:u,getLocalPrice:d,res:e,demand:r,tradeConfig:I,merchantTradePreferences:C});ct&&S.push(ct)}),yo.forEach(({resourceKey:Le})=>{const ct=ec({resourceKey:Le,partner:oe,tick:u,getLocalPrice:d,res:e,supply:n,tradeConfig:I,merchantTradePreferences:C});ct&&S.push(ct)}),S.length===0)continue;S.sort((Le,ct)=>ct.score-Le.score);const Ie=Math.min(12,ee.batches);for(let Le=0;Le<Ie;Le++){const ct=o.merchant||0;if(ct<=I.minWealthForTrade)break;const Ct=S[Le%S.length];if(!Ct)break;const Zt=ct/(Ce+1)*be;if(Ct.type==="export"){const ut=oc({partner:oe,partnerId:oe.id,resourceKey:Ct.resourceKey,wealthForThisBatch:Zt,batchMultiplier:ke,wealth:o,res:e,supply:n,taxBreakdown:c,tradeConfig:I,getLocalPrice:d,foreignUnitPrice:Ct.foreignPrice,getResourceTaxRate:Q,classFinancialData:x,taxPolicies:l,logs:T});if(ut.success){q+=ut.outlay,W.push(ut.trade),p=u;const Kt=((Xe=qe[Ct.resourceKey])==null?void 0:Xe.name)||Ct.resourceKey,bo=(oe==null?void 0:oe.name)||(oe==null?void 0:oe.id)||"未知国家";T&&ut.trade.amount>=.5&&T.push(`📦 商人发起贸易: 向${bo}出口 ${Kt} x${ut.trade.amount.toFixed(1)}`)}}else{const ut=ic({partner:oe,partnerId:oe.id,resourceKey:Ct.resourceKey,wealthForThisBatch:Zt,batchMultiplier:ke,wealth:o,res:e,taxBreakdown:c,tradeConfig:I,getLocalPrice:d,foreignUnitPrice:Ct.foreignPrice,getResourceTaxRate:U,roleExpense:f,classFinancialData:x,taxPolicies:l,logs:T});if(ut.success){q+=ut.cost,W.push(ut.trade),p=u;const Kt=((L=qe[Ct.resourceKey])==null?void 0:L.name)||Ct.resourceKey,bo=(oe==null?void 0:oe.name)||(oe==null?void 0:oe.id)||"未知国家";T&&ut.trade.amount>=.5&&T.push(`📦 商人发起贸易: 从${bo}进口 ${Kt} x${ut.trade.amount.toFixed(1)}`)}}}}const z=W.reduce((F,ee)=>F+Math.max(0,(ee==null?void 0:ee.capitalLocked)||0),0);return{pendingTrades:W,lastTradeTime:p,lockedCapital:z,capitalInvestedThisTick:q,completedTrades:B}},oc=({partner:e,partnerId:o,resourceKey:i,wealthForThisBatch:n,batchMultiplier:r,wealth:a,res:u,supply:l,taxBreakdown:c,tradeConfig:d,getLocalPrice:f,foreignUnitPrice:b,getResourceTaxRate:g,classFinancialData:p,taxPolicies:w,logs:x})=>{var tt,we,z,ve,Xe,L;const T=f(i),A=b;if(A===null||T===null||A<=T)return{success:!1};const M=g(i),C=T*(1+M),k=C>0?n/C:0,B=(u[i]||0)/r*d.maxInventoryRatio,j=di(i,e,0),H=Math.max(20,((j==null?void 0:j.shortageAmount)||0)+((j==null?void 0:j.target)||0)*.08),O=Math.min(d.maxPurchaseAmount,k,B,H);if(O<=.1)return{success:!1};const U=T*O,Q=U*M,I=A*O;let W=U,ae=0;if(Q<0){const F=Math.abs(Q);(u.silver||0)>=F*r?(W-=F,ae=-F):x.push(`Treasury empty, cannot pay export subsidy for ${((tt=qe[i])==null?void 0:tt.name)||i}!`)}else W+=Q,ae=Q;const fe=I-W;if((W>0?fe/W:fe>0?1/0:-1/0)<d.minProfitMargin)return{success:!1};const Ee=O*r,N=W*r,K=ae*r;if((a.merchant||0)<N)return{success:!1};if((u[i]||0)<Ee)return{success:!1};a.merchant-=N;const ue=((we=w==null?void 0:w.resourceTaxRates)==null?void 0:we[i])||0,be=(L=(Xe=(z=w==null?void 0:w.exportTariffMultipliers)==null?void 0:z[i])!=null?Xe:(ve=w==null?void 0:w.resourceTariffMultipliers)==null?void 0:ve[i])!=null?L:0,Ce=U*ue*r,ke=U*be*r;if(ke>0?c.tariff=(c.tariff||0)+ke:ke<0&&(c.tariffSubsidy=(c.tariffSubsidy||0)+Math.abs(ke)),K<0){const F=Math.abs(K);u.silver-=F,c.subsidy+=F}else Ce>0&&(c.industryTax+=Ce);if(p&&p.merchant){const F=U*M*r;if(Math.abs(ke)>.001){p.merchant.expense.tariffs=(p.merchant.expense.tariffs||0)+ke;const oe=F-ke;oe>0&&(p.merchant.expense.transactionTax=(p.merchant.expense.transactionTax||0)+oe)}else F>0&&(p.merchant.expense.transactionTax=(p.merchant.expense.transactionTax||0)+F);fe>0&&(p.merchant.income.ownerRevenue=(p.merchant.income.ownerRevenue||0)+fe*r);const ee=K<0?Math.abs(K):0;ee>0&&(p.merchant.income.subsidy=(p.merchant.income.subsidy||0)+ee)}return u[i]=Math.max(0,(u[i]||0)-Ee),l[i]=Math.max(0,(l[i]||0)-Ee),{success:!0,outlay:N,trade:{type:"export",partnerId:o,resource:i,amount:Ee,revenue:I*r,profit:fe*r,daysRemaining:d.tradeDuration,capitalLocked:N}}},ic=({partner:e,partnerId:o,resourceKey:i,wealthForThisBatch:n,batchMultiplier:r,wealth:a,res:u,taxBreakdown:l,tradeConfig:c,getLocalPrice:d,foreignUnitPrice:f,getResourceTaxRate:b,roleExpense:g,classFinancialData:p,taxPolicies:w,logs:x})=>{var ke,tt,we,z,ve,Xe;const T=d(i),A=f;if(A===null||T===null||A>=T)return{success:!1};const M=di(i,e,0),C=Math.max(10,((M==null?void 0:M.surplusAmount)||0)+((M==null?void 0:M.target)||0)*.05),k=b(i),q=A,B=q>0?n/q:0,j=Math.min(c.maxPurchaseAmount,B,C);if(j<=.1)return{success:!1};const H=A*j,O=T*j,U=O*k;let Q=O,I=0;if(U<0){const L=Math.abs(U);(u.silver||0)>=L*r?(Q+=L,I=-L):x.push(`Treasury empty, cannot pay import subsidy for ${((ke=qe[i])==null?void 0:ke.name)||i}!`)}else Q-=U,I=U;const W=Q-H;if((H>0?W/H:W>0?1/0:-1/0)<c.minProfitMargin)return{success:!1};const fe=j*r,ye=H*r,Ee=Q*r,N=I*r;if((a.merchant||0)<ye)return{success:!1};a.merchant-=ye,g.merchant=(g.merchant||0)+ye;const K=((tt=w==null?void 0:w.resourceTaxRates)==null?void 0:tt[i])||0,ue=(Xe=(ve=(we=w==null?void 0:w.importTariffMultipliers)==null?void 0:we[i])!=null?ve:(z=w==null?void 0:w.resourceTariffMultipliers)==null?void 0:z[i])!=null?Xe:0,be=O*K*r,Ce=O*ue*r;if(Ce>0?l.tariff=(l.tariff||0)+Ce:Ce<0&&(l.tariffSubsidy=(l.tariffSubsidy||0)+Math.abs(Ce)),N<0){const L=Math.abs(N);u.silver-=L,l.subsidy+=L}else be>0&&(l.industryTax+=be);if(p&&p.merchant){const L=O*k*r;if(Math.abs(Ce)>.001){p.merchant.expense.tariffs=(p.merchant.expense.tariffs||0)+Ce;const oe=L-Ce;oe>0&&(p.merchant.expense.transactionTax=(p.merchant.expense.transactionTax||0)+oe)}else L>0&&(p.merchant.expense.transactionTax=(p.merchant.expense.transactionTax||0)+L);const F=Ee-ye;F>0&&(p.merchant.income.ownerRevenue=(p.merchant.income.ownerRevenue||0)+F);const ee=N<0?Math.abs(N):0;ee>0&&(p.merchant.income.subsidy=(p.merchant.income.subsidy||0)+ee)}return{success:!0,cost:ye,trade:{type:"import",partnerId:o,resource:i,amount:fe,revenue:Ee,profit:Ee-ye,daysRemaining:c.tradeDuration,capitalLocked:ye}}},nc=({popStructure:e,jobsAvailable:o,wealth:i,getExpectedWage:n,getHeadTaxRate:r,effectiveTaxModifier:a})=>{const u=f=>{var w,x;const b=n(f),p=((x=(w=ce[f])==null?void 0:w.headTaxBase)!=null?x:.01)*r(f)*a;return b-Math.max(0,p)},l=f=>{var x,T,A,M;const b=(x=uo[f])!=null?x:0,g=ur[f],p=Number.isFinite(g)?g:(T=lr[b])!=null?T:0;return((M=(A=ce[f])==null?void 0:A.startingWealth)!=null?M:100)*p},c=(f,b)=>{var w,x;const g=(w=uo[f])!=null?w:0,p=(x=uo[b])!=null?x:0;return p<=2||g<=p};return Wt.map((f,b)=>{var x;const g=Math.max(0,o[f]||0),p=e[f]||0,w=Math.max(0,g-p);return w<=0||f==="official"?null:{role:f,vacancy:w,netIncome:u(f),priorityIndex:b,tier:(x=uo[f])!=null?x:0,wealthRequired:l(f)}}).filter(Boolean).sort((f,b)=>b.netIncome!==f.netIncome?b.netIncome-f.netIncome:f.priorityIndex-b.priorityIndex).forEach(f=>{var p;const b=Math.max(1,Math.floor(f.vacancy*Ys));let g=Math.min(f.vacancy,b);if(f.tier<=1){const w=e.unemployed||0;if(w<=0||g<=0)return;const x=Math.min(g,w);if(x<=0)return;const T=i.unemployed||0,A=w>0?T/w:0;if(e[f.role]=(e[f.role]||0)+x,e.unemployed=Math.max(0,w-x),A>0){const M=A*x;i.unemployed=Math.max(0,T-M),i[f.role]=qo((i[f.role]||0)+M)}}else{const w=Object.keys(uo).filter(x=>{var C;if(!c(x,f.role)||x===f.role||x==="soldier"||x==="official")return!1;const T=e[x]||0;if(T<=0)return!1;const A=(C=uo[x])!=null?C:0,M=f.tier;if(A===M&&x!=="unemployed"){const k=o[x]||0;if(T<=k)return!1}return!0}).sort((x,T)=>{var C,k;const A=(C=uo[x])!=null?C:0,M=(k=uo[T])!=null?k:0;return x==="unemployed"?-1:T==="unemployed"?1:M-A});for(const x of w){if(g<=0)break;const T=e[x]||0;if(T<=0)continue;const A=i[x]||0,M=T>0?A/T:0,C=(p=uo[x])!=null?p:0;let k=!1,q=0,B=0;if(C<f.tier&&M<f.wealthRequired){const H=T*Js,O=Math.floor(H)+(Math.random()<H%1?1:0);if(O>0)B=O,k=!0,q=f.wealthRequired-M;else continue}else C===f.tier||f.wealthRequired<=0?B=T:B=M>=f.wealthRequired?T:0;const j=Math.min(g,B);if(!(j<=0)){if(e[f.role]=(e[f.role]||0)+j,e[x]=Math.max(0,T-j),M>0||k){const H=M*j;i[x]=Math.max(0,A-H);const O=k?q*j:0;i[f.role]=qo((i[f.role]||0)+H+O)}g-=j}}}}),{popStructure:e,wealth:i}},ac=({popStructure:e,wealth:o,roleMetrics:i,hasBuildingVacancyForRole:n,reserveBuildingVacancyForRole:r,logs:a,migrationCooldowns:u={},supplyDemandRatio:l={},roleProducesResource:c={}})=>{var fe,ye,Ee;const d={};Object.entries(u).forEach(([N,K])=>{K>1&&(d[N]=K-1)});const f=i.filter(N=>N.role!=="soldier"&&N.role!=="official");if(f.length===0)return{popStructure:e,wealth:o,migrationCooldowns:d};const b=f.reduce((N,K)=>N+K.potentialIncome*K.pop,0),g=f.reduce((N,K)=>N+K.pop,0),p=g>0?b/g:0,w=ra.filter(N=>{const K=l[N];return K!==void 0&&K<er}),x=new Set;w.length>0&&Object.entries(c).forEach(([N,K])=>{K&&Array.isArray(K)&&K.some(be=>w.includes(be))&&x.add(N)}),w.length>0&&x.size>0;const T=.8,A=ra.filter(N=>{const K=l[N];return K!==void 0&&K<T}),M=new Set;A.length>0&&Object.entries(c).forEach(([N,K])=>{K&&Array.isArray(K)&&K.some(be=>A.includes(be))&&M.add(N)});const C=f.filter(N=>n(N.role)).reduce((N,K)=>Math.max(N,K.potentialIncome),0),k=f.filter(N=>{if(N.pop<=0||N.role==="soldier"||d[N.role]&&d[N.role]>0)return!1;const K=N.perCap*.05,ue=-Math.max(.5,Math.min(50,K));return N.potentialIncome<p*.7||N.perCapDelta<ue||C>0&&N.potentialIncome<C*.6}).reduce((N,K)=>!N||K.potentialIncome<N.potentialIncome||K.potentialIncome===N.potentialIncome&&K.perCapDelta<N.perCapDelta?K:N,null);if(!k)return{popStructure:e,wealth:o,migrationCooldowns:d};const q=(fe=uo[k.role])!=null?fe:0,B=(Ee=(ye=ce[k.role])==null?void 0:ye.startingWealth)!=null?Ee:100,j=o[k.role]||0,H=k.pop>0?j/k.pop:0,O=H>=B*dr,U=N=>{var be;const ue=((be=uo[N])!=null?be:0)-q;if(ue>0)return Ks;if(ue===0)return Xs;{const Ce=Math.abs(ue);return Qs*Math.pow(Zs,Ce-1)}},Q=(N,K)=>{var ke;const be=((ke=uo[N])!=null?ke:0)-q;let Ce=K;if(O&&be>0){const tt=Ce*fr*be;Ce+=tt}return Ce},I=f.filter(N=>{if(N.role===k.role||N.vacancy<=0)return!1;const ue=1.3*U(N.role);if(N.role==="soldier")return N.potentialIncome>k.potentialIncome*ue;const be=Q(N.role,N.potentialIncome);return n(N.role)&&be>k.potentialIncome*ue}).reduce((N,K)=>{if(!N)return K;const ue=Q(K.role,K.potentialIncome),be=Q(N.role,N.potentialIncome);return ue>be?K:N},null);if(!I)return{popStructure:e,wealth:o,migrationCooldowns:d};const W=k.pop<Ni?Hs:zs;let ae=Math.floor(k.pop*W);if(ae<=0&&k.pop>0&&(ae=1),ae=Math.min(ae,I.vacancy),ae>0){if(I.role!=="soldier"){const N=r(I.role,ae);!N||N.count<=0?ae=0:ae=N.count}if(ae>0){const N=H*ae;N>0&&(o[k.role]=Math.max(0,j-N),o[I.role]=qo((o[I.role]||0)+N)),e[k.role]=Math.max(0,k.pop-ae),e[I.role]=(e[I.role]||0)+ae,d[k.role]=sa,d[I.role]=sa}}return{popStructure:e,wealth:o,migrationCooldowns:d}},sc=(e={})=>{const o={...e};return Object.keys(ce).forEach(i=>{var n;o[i]===void 0&&(o[i]=((n=ce[i])==null?void 0:n.startingWealth)||0)}),o},rc=(e=[])=>{const o={};return Array.isArray(e)&&e.forEach(i=>{var n;i.active&&((n=i.modifiers)!=null&&n.approval)&&Object.entries(i.modifiers.approval).forEach(([r,a])=>{o[r]=(o[r]||0)+a})}),o},cc=({popStructure:e,classApproval:o,classInfluence:i,totalInfluence:n,newActiveBuffs:r,newActiveDebuffs:a,eventStabilityModifier:u=0,extraStabilityPenalty:l=0,currentStability:c=50,stabilityBonus:d=0})=>{let f=0,b=0;Object.keys(ce).forEach(M=>{if((e[M]||0)===0)return;const k=o[M]||50,q=i[M]||0,B=n>0?q/n:0;f+=k*B,b+=B});let g=b>0?f:50;u&&(g+=u);let p=0;r.forEach(M=>{M.stability&&(p+=M.stability)}),a.forEach(M=>{M.stability&&(p+=M.stability)}),d&&(p+=g*d),p-=l;const w=Math.max(0,Math.min(100,g+p)),x=Math.max(0,Math.min(100,c+(w-c)*rr)),T=Math.min(1.5,Math.max(.5,1+(x-50)/100));return{stabilityValue:x,targetStability:w,efficiency:T,stabilityFactor:T}},lc=({popStructure:e,classWealthResult:o})=>{const i={},n=Object.values(o).reduce((a,u)=>a+u,0);Object.keys(ce).forEach(a=>{const u=e[a]||0;if(u===0)return;const l=ce[a],c=o[a]||0,d=n>0?c/n:0;i[a]=l.influenceBase*u+d*10});const r=Object.values(i).reduce((a,u)=>a+u,0);return{classInfluence:i,totalInfluence:r,totalWealth:n}},uc=$n.reduce((e,o)=>(e[o.id]=o,e),{}),dc=()=>({buildingBonuses:{},categoryBonuses:{gather:0,industry:0,civic:0,military:0},passiveGains:{},passivePercentGains:{},perPopPassiveGains:{},incomePercentBonus:0,decreeResourceDemandMod:{},decreeStratumDemandMod:{},decreeResourceSupplyMod:{},decreeSilverIncome:0,decreeSilverExpense:0,extraMaxPop:0,maxPopPercent:0,productionBonus:0,industryBonus:0,taxBonus:0,needsReduction:0,stabilityBonus:0,scienceBonus:0,cultureBonus:0,militaryBonus:0}),To=(e,o)=>{if(!e)return;const{buildingBonuses:i,categoryBonuses:n,passiveGains:r,decreeResourceDemandMod:a,decreeStratumDemandMod:u,decreeResourceSupplyMod:l}=o;if(e.buildings&&Object.entries(e.buildings).forEach(([c,d])=>{!c||typeof d!="number"||Number.isFinite(d)&&(i[c]=(i[c]||0)+d)}),e.buildingProductionMod&&Object.entries(e.buildingProductionMod).forEach(([c,d])=>{if(!c||typeof d!="number"||!Number.isFinite(d))return;["gather","industry","civic","military","all"].includes(c)?n[c]=(n[c]||0)+d:i[c]=(i[c]||0)+d}),e.categories&&Object.entries(e.categories).forEach(([c,d])=>{!c||typeof d!="number"||Number.isFinite(d)&&(n[c]=(n[c]||0)+d)}),e.passive&&Object.entries(e.passive).forEach(([c,d])=>{!c||typeof d!="number"||(r[c]=(r[c]||0)+d)}),e.passivePercent&&Object.entries(e.passivePercent).forEach(([c,d])=>{!c||typeof d!="number"||(o.passivePercentGains[c]=(o.passivePercentGains[c]||0)+d)}),e.maxPop){const c=e.maxPop;c>-1&&c<1&&c!==0?o.maxPopPercent+=c:o.extraMaxPop+=c}e.production&&(o.productionBonus+=e.production),e.industry&&(o.industryBonus+=e.industry),e.taxIncome&&(o.taxBonus+=e.taxIncome),e.needsReduction&&(o.needsReduction+=e.needsReduction),e.stability&&(o.stabilityBonus+=e.stability),e.scienceBonus&&(o.scienceBonus+=e.scienceBonus),e.cultureBonus&&(o.cultureBonus+=e.cultureBonus),e.militaryBonus&&(o.militaryBonus+=e.militaryBonus),e.gatherBonus&&(n.gather=(n.gather||0)+e.gatherBonus),e.industryBonus&&(o.industryBonus+=e.industryBonus),e.knowledgeBonus&&(o.scienceBonus+=e.knowledgeBonus),e.resourceDemandMod&&Object.entries(e.resourceDemandMod).forEach(([c,d])=>{typeof d=="number"&&(a[c]=(a[c]||0)+d)}),e.stratumDemandMod&&Object.entries(e.stratumDemandMod).forEach(([c,d])=>{typeof d=="number"&&(u[c]=(u[c]||0)+d)}),e.resourceSupplyMod&&Object.entries(e.resourceSupplyMod).forEach(([c,d])=>{typeof d=="number"&&(l[c]=(l[c]||0)+d)}),e.perPopPassive&&Object.entries(e.perPopPassive).forEach(([c,d])=>{!c||typeof d!="number"||(o.perPopPassiveGains[c]=(o.perPopPassiveGains[c]||0)+d)}),typeof e.incomePercent=="number"&&(o.incomePercentBonus+=e.incomePercent)},fc=(e,o)=>{Array.isArray(e)&&e.forEach(i=>{const n=uc[i];!n||!n.effects||To(n.effects,o)})},pc=(e,o)=>{Array.isArray(e)&&e.forEach(i=>{var r,a;if(!i||!i.active||!i.modifiers)return;const n=((a=(r=i.modifiers)==null?void 0:r.passive)==null?void 0:a.silver)||0;n>0?o.decreeSilverIncome+=n:n<0&&(o.decreeSilverExpense+=Math.abs(n)),To(i.modifiers,o)})},hc=(e,o)=>{Array.isArray(e)&&e.forEach(i=>{!i||!i.effects||To(i.effects,o)})},mc=(e,o)=>{e&&To(e,o)},gc=(e,o,i=1.15,n=1)=>{const r={},l=1+Math.max(0,i-1)*Math.pow(o,.9);for(const[c,d]of Object.entries(e||{}))r[c]=Math.ceil(d*n*l);return r},yc=(e,o,i={})=>{let n=0;for(const[r,a]of Object.entries(i)){const u=parseInt(r);Number.isFinite(u)&&u>=e&&a>0&&(n+=a)}return n},_a=90,Ea=60,bc=500,Mc=.4,xn={satisfied:{effectMult:1,corruption:0,description:null},uncomfortable:{effectMult:.9,corruption:.01,description:"生活拮据"},struggling:{effectMult:.7,corruption:.03,description:"入不敷出"},desperate:{effectMult:.3,corruption:.1,description:"濒临破产"}},wc={landowner:{cats:["gather"],risk:.4},merchant:{cats:["civic","industry"],risk:.7},capitalist:{cats:["industry","gather"],risk:.8},scribe:{cats:["civic"],risk:.3},cleric:{cats:["civic"],risk:.3},peasant:{cats:["gather"],risk:.4},worker:{cats:["industry"],risk:.5},artisan:{cats:["industry"],risk:.5},engineer:{cats:["industry"],risk:.6},navigator:{cats:["civic","gather"],risk:.6}},xc=(e,o)=>{var i,n;return!o||o==="silver"?1:(n=(i=e==null?void 0:e.prices)==null?void 0:i[o])!=null?n:1},vc=(e,o,i)=>{var u;const n=wc[e]||{cats:["gather"],risk:.5},r=(u=ia[o])==null?void 0:u.spectrum;let a=[...n.cats];return r==="left"?(a=a.filter(l=>l!=="industry"),a.includes("gather")||a.push("gather")):r==="right"&&(a.includes("industry")||a.push("industry")),{preferredCategories:a,riskTolerance:n.risk*(.8+Math.random()*.4),investmentThreshold:.2+Math.random()*.3,lastInvestmentDay:i-Math.floor(_a/2),lastUpgradeDay:i-Math.floor(Ea/2)}},Cc=(e,o,i=null)=>{const n=Math.max(1,o||0),r=e.wealth||0,a={desperate:n*10,struggling:n*30,uncomfortable:n*60,wealthy:n*120},l=(Number.isFinite(i)?i:e.salary||0)/n;return r<a.desperate?"desperate":r>=a.wealthy?"satisfied":l<.8&&r<a.struggling?"struggling":r<a.uncomfortable?"uncomfortable":"satisfied"},Pa=(e,o)=>Object.entries(e||{}).reduce((i,[n,r])=>n==="silver"?i+r:i+xc(o,n)*r,0),_c=(e,o={},i={})=>{const n=io.find(c=>c.id===e);if(!(n!=null&&n.jobs))return 1;let r=0,a=0;const u=(i==null?void 0:i[e])||0,l=Math.max(1,u);return Object.entries(n.jobs).forEach(([c,d])=>{const f=l*d,b=o[c]||0;r+=f,a+=f*Math.min(1,b)}),r>0?a/r:1},Ec=(e,o,i,n,r,a)=>{const u=io.find(p=>p.id===e.buildingId);if(!u)return 0;const l=e.level||0,c=jt(u,l),d={...u,...c,id:u.id,owner:c.owner||u.owner},f=pi(d,o,i).profit,b=n==null?void 0:n[e.buildingId],g=Number.isFinite(b)?b:_c(e.buildingId,a,r);return f*g},Pc=(e,o,i,n,r)=>{const a=jt(e,o),u=jt(e,i),l=pi({...e,...a},n,r).profit;return pi({...e,...u},n,r).profit-l},Ta={marxism:0,primitive_communism:.05,peasant_revolt:.1,utopian_socialism:.2,social_democracy:.4,legalism:.6,conservatism:.7,absolutism:.7,aristocratic_oligarchy:.8,feudalism:.8,mercantilism:.9,classical_liberalism:1},Tc=(e,o,i,n,r,a,u,l=0,c=[])=>{var q;if(!(e!=null&&e.investmentProfile))return null;const d=e.politicalStance,f=Ta[d]!==void 0?Ta[d]:.5;if(f<=0||Math.random()>f)return null;const b=e.investmentProfile;if(o-b.lastInvestmentDay<_a||e.wealth<bc)return null;const g=((q=r==null?void 0:r.dominance)==null?void 0:q.faction)==="left"?.5:1,p=Math.max(1,(e.wealth||0)/400),w=Math.min(2.2,1+Math.log10(p)*.6),x=b.riskTolerance*g*w;if(Math.random()>x)return null;const T=e.wealth*Mc*b.riskTolerance*w;if(T<=0)return null;const A=ha(u),M=io.filter(B=>{var U;return!(!B.owner||!B.baseCost||!(((U=B.epoch)!=null?U:0)<=l)||!(!B.requiresTech||c.includes(B.requiresTech))||((a==null?void 0:a[B.id])||0)<=0)}).map(B=>{const j=(a==null?void 0:a[B.id])||0,H=gc(B.baseCost,j,A),O=Pa(H,i),U=pi(B,i,n).profit,Q=b.preferredCategories.includes(B.cat)?2:1;return{building:B,cost:O,profit:U,weight:Math.max(.01,U*Q)}}).filter(B=>B.cost<=T&&B.profit>0).sort((B,j)=>j.weight-B.weight);if(M.length===0)return null;const C=M.reduce((B,j)=>B+j.weight,0);let k=Math.random()*C;for(const B of M)if(k-=B.weight,k<=0)return{buildingId:B.building.id,cost:B.cost,profit:B.profit};return null},kc=(e,o,i,n,r,a,u,l)=>{var g,p,w,x;if(!((g=e.ownedProperties)!=null&&g.length))return null;const c=((p=e.investmentProfile)==null?void 0:p.lastUpgradeDay)||0;if(o-c<Ea||e.wealth<200)return null;const d=((w=r==null?void 0:r.dominance)==null?void 0:w.faction)==="left"?.7:1;if(Math.random()>(((x=e.investmentProfile)==null?void 0:x.riskTolerance)||.5)*d)return null;const f=ha(l),b=[];return e.ownedProperties.forEach((T,A)=>{const M=io.find(I=>I.id===T.buildingId);if(!M)return;const C=qn(M.id),k=T.level||0,q=k+1;if(q>C)return;const B=(a==null?void 0:a[M.id])||0,j=(u==null?void 0:u[M.id])||{},H=yc(q,B,j),O=Un(M.id,q,H,f);if(!O)return;const U=Pa(O,i);if(U>e.wealth*.5)return;const Q=Pc(M,k,q,i,n);Q<=0||b.push({propertyIndex:A,buildingId:M.id,fromLevel:k,toLevel:q,cost:U,profitGain:Q,roi:Q/U})}),b.length?(b.sort((T,A)=>A.roi-T.roi),b[0]):null},Ac={0:0,1:3,2:6,3:9,4:12,5:15,6:18,7:21},ka={early_administration:2,bureaucracy:3,civil_service:3,administrative_reform:4,centralization:2},Wc=(e=0,o={},i=[])=>{const r=Ac[e]||0,a=o.officialCapacity||0;let u=0;return i.forEach(l=>{ka[l]&&(u+=ka[l])}),Math.max(1,2+r+a+u)},Rc=(e,o)=>{const i={buildings:{},buildingProductionMod:{},wartimeProduction:0,tradeBonus:0,taxEfficiency:0,buildingCostMod:0,incomePercentBonus:0,passiveGains:{},passivePercentGains:{},corruption:0,decreeStratumDemandMod:{},decreeResourceDemandMod:{},resourceSupplyMod:{},resourceWaste:{},needsReduction:0,productionInputCost:{},extraMaxPop:0,populationGrowth:0,researchSpeed:0,approval:{},coalitionApproval:0,legitimacyBonus:0,organizationDecay:0,factionConflict:0,stability:0,militaryBonus:0,militaryUpkeep:0,diplomaticBonus:0,diplomaticCooldown:0,diplomaticIncident:0};if(!e||!Array.isArray(e))return i;const n=o?1:.5,r=(a,u=n)=>{if(!a||!a.type||typeof a.value!="number")return;const l=a.value*u;switch(a.type){case"buildings":a.target&&(i.buildings[a.target]=(i.buildings[a.target]||0)+l);break;case"buildingProductionMod":case"categories":a.target&&(i.buildingProductionMod[a.target]=(i.buildingProductionMod[a.target]||0)+l);break;case"wartimeProduction":i.wartimeProduction+=l;break;case"tradeBonus":i.tradeBonus+=l;break;case"taxEfficiency":i.taxEfficiency+=l;break;case"buildingCostMod":i.buildingCostMod+=l;break;case"incomePercent":i.incomePercentBonus+=l;break;case"passive":a.target&&(i.passiveGains[a.target]=(i.passiveGains[a.target]||0)+l);break;case"passivePercent":a.target&&(i.passivePercentGains[a.target]=(i.passivePercentGains[a.target]||0)+l);break;case"corruption":i.corruption+=l;break;case"stratumDemandMod":a.target&&(i.decreeStratumDemandMod[a.target]=(i.decreeStratumDemandMod[a.target]||0)+l);break;case"resourceDemandMod":a.target&&(i.decreeResourceDemandMod[a.target]=(i.decreeResourceDemandMod[a.target]||0)+l);break;case"resourceSupplyMod":a.target&&(i.resourceSupplyMod[a.target]=(i.resourceSupplyMod[a.target]||0)+l);break;case"resourceWaste":a.target&&(i.resourceWaste[a.target]=(i.resourceWaste[a.target]||0)+l);break;case"needsReduction":i.needsReduction+=l;break;case"maxPop":i.extraMaxPop+=l;break;case"populationGrowth":i.populationGrowth+=l;break;case"researchSpeed":i.researchSpeed+=l;break;case"approval":a.target&&(i.approval[a.target]=(i.approval[a.target]||0)+l);break;case"coalitionApproval":i.coalitionApproval+=l;break;case"legitimacyBonus":i.legitimacyBonus+=l;break;case"organizationDecay":i.organizationDecay+=l;break;case"factionConflict":i.factionConflict+=l;break;case"stability":i.stability+=l;break;case"militaryBonus":i.militaryBonus+=l;break;case"militaryUpkeep":i.militaryUpkeep+=l;break;case"diplomaticBonus":i.diplomaticBonus+=l;break;case"diplomaticCooldown":i.diplomaticCooldown+=l;break;case"diplomaticIncident":i.diplomaticIncident+=l;break;case"productionInputCost":a.target&&(i.productionInputCost[a.target]=(i.productionInputCost[a.target]||0)+l);break}};return e.forEach(a=>{if(!a||typeof a!="object")return;const u=xn[a.financialSatisfaction]||xn.satisfied,l=n*(u.effectMult||1);u.corruption&&(i.corruption+=u.corruption*n),a.effects&&typeof a.effects=="object"&&Object.entries(a.effects).forEach(([c,d])=>{typeof d=="object"&&d!==null?Object.entries(d).forEach(([f,b])=>{r({type:c,target:f,value:b},l)}):r({type:c,value:d},l)}),a.drawbacks&&typeof a.drawbacks=="object"&&Object.entries(a.drawbacks).forEach(([c,d])=>{typeof d=="object"&&d!==null?Object.entries(d).forEach(([f,b])=>{r({type:c,target:f,value:b},l)}):r({type:c,value:d},l)})}),i},Bc=(e,o={})=>{var I,W;if(!e)return 0;const i=(I=o.currentDay)!=null?I:0,n=o.polityEffects||{},r=e.sourceStratum,a=Math.max(0,e.wealth||0),u=Array.isArray(e.ownedProperties)?e.ownedProperties:[],l=u.length,c=u.reduce((ae,fe)=>ae+Math.max(0,(fe==null?void 0:fe.level)||0),0),d=u.reduce((ae,fe)=>ae+Math.max(0,(fe==null?void 0:fe.purchaseCost)||0),0),b=(e.hireDate!=null?Math.max(0,i-e.hireDate):0)/365,g=1+Math.min(2.5,Math.log2(b+1)*.9),w=(W={capitalist:260,landowner:240,knight:220,official:200,engineer:180,merchant:170,scribe:140,cleric:140,artisan:120,navigator:120,soldier:110,worker:90,miner:85,lumberjack:80,peasant:75,serf:65,unemployed:60}[r])!=null?W:100,x=o.classInfluence||{},T=Math.max(0,x[r]||0),A=Math.log10(T+1)*70,M=w+A,C=Math.log10(a+1)*60,k=Math.sqrt(l)*55,q=Math.sqrt(c)*45,B=Math.log10(d+1)*40,j=Math.max(0,n.officialCapacity||0),H=1+Math.min(1.2,j*.05),U=Math.max(0,e.stratumInfluenceBonus||0)*120,Q=(M+C+k+q+B+U)*g*H;return Math.max(0,Q)},Sc=(e,o=!0,i={})=>{const n={},r=i.classInfluence||{},a=i.totalInfluence||0;if(!e||!Array.isArray(e))return n;const u=o?1:.5,l=2e4;return e.forEach(c=>{if(!c||!c.sourceStratum)return;const d=c.sourceStratum,f=Bc(c,i),b=Math.max(0,r[d]||0),g=a>0?b/a:0,p=1+Math.min(.35,g*.7);let x=f*10*p;x=Math.min(l,x)*u,!(x<=0)&&(n[d]=(n[d]||0)+x,d!=="official"&&(n.official=(n.official||0)+x*.25))}),n},jc=(e,o)=>{const i={stability:0,legitimacyBonus:0,gatherBonus:0,industryBonus:0,tradeBonus:0,researchSpeed:0,cultureBonus:0,taxEfficiency:0,incomePercentBonus:0,buildingCostMod:0,needsReduction:0,productionInputCost:{},populationGrowth:0,militaryBonus:0,organizationDecay:0,approval:{},diplomaticBonus:0};let n=0,r=0;if(!e||!Array.isArray(e))return{aggregatedEffects:i,satisfiedCount:n,unsatisfiedCount:r};const a=u=>{!u||typeof u!="object"||Object.entries(u).forEach(([l,c])=>{typeof c=="object"&&c!==null?l==="approval"?Object.entries(c).forEach(([d,f])=>{typeof f=="number"&&(i.approval[d]=(i.approval[d]||0)+f)}):l==="productionInputCost"&&Object.entries(c).forEach(([d,f])=>{typeof f=="number"&&(i.productionInputCost[d]=(i.productionInputCost[d]||0)+f)}):typeof c=="number"&&i.hasOwnProperty(l)&&(i[l]+=c)})};return e.forEach(u=>{if(!u)return;const l=u.stanceConditionParams;na(u.politicalStance,o,l)?(n++,a(u.stanceActiveEffects)):(r++,a(u.stanceUnsatisfiedPenalty))}),{aggregatedEffects:i,satisfiedCount:n,unsatisfiedCount:r}},Ic=(e,o=0)=>{var f,b;if(!e||typeof e!="object")return e;const i=!!e.investmentProfile,n=Array.isArray(e.ownedProperties),r=e.loyalty===void 0||e.loyalty===null||e.loyalty===0&&((f=e.lowLoyaltyDays)!=null?f:0)>100,a=Number.isFinite(e.salary);if(i&&n&&!r&&a)return e;const u=e.sourceStratum||e.stratum||"peasant",l=e.politicalStance,c=Di==null?void 0:Di.INITIAL_MIN,d=r?c:e.loyalty;return{...e,financialSatisfaction:e.financialSatisfaction||"satisfied",salary:Number.isFinite(e.salary)?e.salary:Number.isFinite(e.baseSalary)?e.baseSalary:0,baseSalary:Number.isFinite(e.baseSalary)?e.baseSalary:e.salary||0,investmentProfile:i?e.investmentProfile:vc(u,l,o),ownedProperties:n?e.ownedProperties:[],lastDayPropertyIncome:typeof e.lastDayPropertyIncome=="number"?e.lastDayPropertyIncome:0,loyalty:d,lowLoyaltyDays:r?0:(b=e.lowLoyaltyDays)!=null?b:0}},Oc=({nation:e,tick:o,epoch:i,resources:n,population:r,army:a,logs:u})=>{var p,w;let l=0;const c=n,d=e;if(!d.isAtWar)return{raidPopulationLoss:l};d.warDuration=(d.warDuration||0)+1;const f=(p=d.aggression)!=null?p:.7,b=Math.min(.35,.25+f*.1);if(Math.random()<b){const x=(w=d.militaryStrength)!=null?w:1,T=.08+f*.05,A={},M=Gn(i,"light"),C=3+Math.random()*5,k=Math.floor(C*x);M.forEach(I=>{if(lo[I]){const W=Math.floor(k/M.length*(.5+Math.random()*.8));W>0&&(A[I]=W)}});const q={...a},B=Object.values(q).reduce((I,W)=>I+W,0);let j=0,H=0,O=0,U={victory:!0,attackerLosses:{},defenderLosses:{}};if(B===0)j=Math.floor((c.food||0)*T),H=Math.floor((c.silver||0)*(T/2)),O=Math.min(5,Math.max(1,Math.floor(T*25)));else{U=ta({army:A,militaryBuffs:.1},{army:q,militaryBuffs:0}),U.victory&&(j=Math.floor((c.food||0)*T),H=Math.floor((c.silver||0)*(T/2)),O=Math.min(5,Math.max(1,Math.floor(T*25))));const I=U.defenderLosses||{},W={};Object.entries(I).forEach(([ae,fe])=>{if(a[ae]){const ye=Math.min(a[ae],fe);a[ae]=Math.max(0,a[ae]-ye),ye>0&&(W[ae]=ye)}}),Object.keys(W).length>0&&u.push(`AUTO_REPLENISH_LOSSES:${JSON.stringify(W)}`)}j>0&&(c.food=Math.max(0,(c.food||0)-j)),H>0&&(c.silver=Math.max(0,(c.silver||0)-H)),O>0&&(l+=O),d.warScore=(d.warScore||0)+(U.victory?-8:6);const Q={nationName:d.name,victory:!U.victory,attackerArmy:A,defenderArmy:q,attackerLosses:U.attackerLosses||{},defenderLosses:U.defenderLosses||{},foodLoss:j,silverLoss:H,popLoss:O,ourPower:U.defenderPower||0,enemyPower:U.attackerPower||0,battleReport:U.battleReport||[],actionType:"raid",actionName:"叛军突袭"};u.push(`❗RAID_EVENT❗${JSON.stringify(Q)}`)}const g=-(d.warScore||0);if(g>50&&(d.warDuration||0)>20){const x=d.lastSurrenderDemandDay||0;if(o-x>=30&&Math.random()<.05){d.lastSurrenderDemandDay=o;const T=c.silver||0,A=Math.floor((r||0)*.05),M=Math.floor(g/4),C=Math.max(0,(r||100)-10),k=Math.min(Math.max(A,M,10),C),q=Math.max(100,Math.floor(T*.1)),B=q*3,j=Math.ceil(B/365);let H="reform";g>200?H="massacre":g>100&&(H="concession"),u.push(`REBEL_DEMAND_SURRENDER:${JSON.stringify({nationId:d.id,nationName:d.name,rebellionStratum:d.rebellionStratum,coalitionStrata:d.coalitionStrata||[d.rebellionStratum],warScore:d.warScore,warAdvantage:g,primaryDemandType:H,massacreAmount:k,reformAmount:q,subsidyTotalAmount:B,subsidyDailyAmount:j})}`)}}return{raidPopulationLoss:l}},Dc=({nation:e,tick:o,logs:i})=>{const n=e,r=n.warScore||0,a=n.warDuration||0,u=Number.isFinite(n.lastPeaceRequestDay)?n.lastPeaceRequestDay:-1/0;if(o-u>=30&&!n.isPeaceRequesting){const c=Math.max(0,r-20)/100+Math.max(0,a-60)/500,d=Math.min(.4,c*.5);r>30&&Math.random()<d?(n.isPeaceRequesting=!0,n.peaceTribute=0,n.lastPeaceRequestDay=o,i.push(`🏳️ ${n.name} 已陷入绝境，请求投降！`)):r>60&&a>90&&(n.isPeaceRequesting=!0,n.peaceTribute=0,n.lastPeaceRequestDay=o,i.push(`🏳️ ${n.name} 已经崩溃，恳求投降！`))}},Lc=({nation:e,tick:o,epoch:i,resources:n,army:r,logs:a,difficultyLevel:u=mn})=>{var ke,tt;let l=0;const c=e,d=n;if(i<1)return{raidPopulationLoss:l};if(pa(o,u))return{raidPopulationLoss:l};const f=c.lastMilitaryActionDay||0,b=Cr(u);c.militaryCooldownDays||(c.militaryCooldownDays=Math.max(5,7+Math.floor(Math.random()*24)+b));const g=o-f>=c.militaryCooldownDays,p=Math.max(0,-(c.warScore||0));let w=Math.min(.18,.02+(c.aggression||.2)*.04+p/400);if(w=xr(w,u),!g||Math.random()>=w)return{raidPopulationLoss:l};c.lastMilitaryActionDay=o,c.militaryCooldownDays=Math.max(5,7+Math.floor(Math.random()*24)+b);const x=Math.max(c.appearEpoch||0,Math.min(i,(ke=c.expireEpoch)!=null?ke:i)),T=(tt=c.militaryStrength)!=null?tt:1,A=Math.max(.3,Math.min(1.5,(c.wealth||500)/800)),M=1+(c.aggression||.2),C=1+Math.max(-.5,(c.warScore||0)/120),k=c.aggression||.2;Object.values(r).reduce((we,z)=>we+z,0);const q=-(c.warScore||0),B=(c.traits||[]).includes("maritime")||(c.name||"").includes("海")||(c.name||"").includes("威尼斯");let j="raid",H="light",O={min:2,max:6},U="边境掠夺",Q=1;const I=Math.random();T>.7&&k>.5&&q>30&&x>=2?I<.25?(j="siege",H="heavy",O={min:15,max:25},U="围城压制",Q=1.5):I<.6?(j="assault",H="medium",O={min:12,max:18},U="正面攻势",Q=1.3):I<.75&&k>.6&&(j="scorched_earth",H="heavy",O={min:12,max:20},U="焦土战术",Q=1.4):T>.5&&q>10&&x>=1?I<.35?(j="assault",H="medium",O={min:10,max:15},U="正面攻势",Q=1.2):I<.5&&B&&x>=2&&(j="naval_raid",H="medium",O={min:8,max:14},U="海上劫掠",Q=1.1):q<-20&&k>.6&&I<.3&&(j="scorched_earth",H="medium",O={min:8,max:15},U="焦土战术",Q=1.1);const W=(.05+k*.05+p/1200)*Q,ae=T*A*M*C,fe={},ye=Gn(x,H),Ee=O.min+Math.random()*(O.max-O.min),N=Math.floor(Ee*ae);ye.forEach(we=>{if(lo[we]){const z=.5+Math.random()*.8,ve=Math.floor(N/ye.length*z);ve>0&&(fe[we]=ve)}});const K={...r},ue=Object.values(K).reduce((we,z)=>we+z,0),be={raid:1,assault:1.5,siege:2,naval_raid:1.2,scorched_earth:1.8}[j]||1,Ce={raid:{win:-8,lose:6},assault:{win:-15,lose:12},siege:{win:-25,lose:20},naval_raid:{win:-12,lose:10},scorched_earth:{win:-18,lose:15}}[j]||{win:-8,lose:6};if(ue===0){let we=Math.floor((d.food||0)*W*be),z=Math.floor((d.silver||0)*(W/2)*be),ve=0;we=Ko(we,u),z=Ko(z,u),j==="scorched_earth"&&(ve=Math.floor((d.wood||0)*W*.8),ve=Ko(ve,u),ve>0&&(d.wood=Math.max(0,(d.wood||0)-ve))),we>0&&(d.food=Math.max(0,(d.food||0)-we)),z>0&&(d.silver=Math.max(0,(d.silver||0)-z));let Xe=Math.min(Math.floor(3*be),Math.max(1,Math.floor(W*20*be)));Xe=fa(Xe,u),l+=Xe;const L={nationName:c.name,victory:!1,attackerArmy:fe,defenderArmy:{},attackerLosses:{},defenderLosses:{},foodLoss:we,silverLoss:z,woodLoss:ve,popLoss:Xe,ourPower:0,enemyPower:0,actionType:j,actionName:U};a.push(`❗RAID_EVENT❗${JSON.stringify(L)}`),c.warScore=(c.warScore||0)+Ce.win;const F=we+z+ve;c.wealth=(c.wealth||0)+Math.floor(F*.08)}else{const we={raid:.1,assault:0,siege:-.1,naval_raid:.15,scorched_earth:.05}[j]||.1,z={army:fe,militaryBuffs:we},ve={army:K,militaryBuffs:0,wealth:(d.food||0)+(d.silver||0)+(d.wood||0)},Xe=ta(z,ve);let L=0,F=0,ee=0,oe=0;if(Xe.victory){let Ie=Math.floor((d.food||0)*W*be),Le=Math.floor((d.silver||0)*(W/2)*be);Ie=Ko(Ie,u),Le=Ko(Le,u),j==="scorched_earth"&&(ee=Math.floor((d.wood||0)*W*.8),ee=Ko(ee,u),ee>0&&(d.wood=Math.max(0,(d.wood||0)-ee))),Ie>0&&(d.food=Math.max(0,(d.food||0)-Ie)),Le>0&&(d.silver=Math.max(0,(d.silver||0)-Le));let ct=Math.min(Math.floor(3*be),Math.max(1,Math.floor(W*20*be)));ct=fa(ct,u),l+=ct;const Ct=Ie+Le+ee;c.wealth=(c.wealth||0)+Math.floor(Ct*.08)}const S=Xe.defenderLosses||{},ot={};Object.entries(S).forEach(([Ie,Le])=>{if(r[Ie]){const ct=Math.min(r[Ie],Le);r[Ie]=Math.max(0,r[Ie]-ct),ct>0&&(ot[Ie]=ct)}}),Object.keys(ot).length>0&&a.push(`AUTO_REPLENISH_LOSSES:${JSON.stringify(ot)}`);const It=Object.values(Xe.attackerLosses||{}).reduce((Ie,Le)=>Ie+(Le||0),0);It>0&&(c.enemyLosses=(c.enemyLosses||0)+It);const Ft=Xe.victory?Ce.win:Ce.lose;c.warScore=(c.warScore||0)+Ft;const yo={nationName:c.name,victory:!Xe.victory,attackerArmy:fe,defenderArmy:K,attackerLosses:Xe.attackerLosses||{},defenderLosses:Xe.defenderLosses||{},foodLoss:L,silverLoss:F,woodLoss:ee,popLoss:oe,ourPower:Xe.defenderPower,enemyPower:Xe.attackerPower,battleReport:Xe.battleReport||[],actionType:j,actionName:U};a.push(`❗RAID_EVENT❗${JSON.stringify(yo)}`)}return{raidPopulationLoss:l}},Nc=({nation:e,tick:o,lastGlobalPeaceRequest:i=-1/0,logs:n})=>{const r=e,a=Number.isFinite(r.lastPeaceRequestDay)?r.lastPeaceRequestDay:-1/0,u=o-a>=or,l=ir,c=o-i>=l;if((r.warScore||0)>12&&u&&c){const d=Math.min(.5,.03+(r.warScore||0)/120+(r.warDuration||0)/400)+Math.min(.15,(r.enemyLosses||0)/500);if(Math.random()<d){const f=r.warScore||0,b=r.enemyLosses||0,g=r.warDuration||0,p=Math.max(0,r.wealth||0),w=vs(f,b,g,p);return n.push(`🤝 ${r.name} 请求和平，愿意支付 ${w} 银币作为赔款。`),r.isPeaceRequesting=!0,r.peaceTribute=w,r.lastPeaceRequestDay=o,!0}}return!1},Fc=({nation:e,tick:o,population:i,playerWealth:n,logs:r})=>{const a=e,u=-(a.warScore||0);if(u>25&&(a.warDuration||0)>30){const l=a.lastSurrenderDemandDay||0;if(o-l>=60&&Math.random()<.03){a.lastSurrenderDemandDay=o;let c="tribute";const d=a.warDuration||0;let f=Cs(u,d,n);u>100?(c="territory",f=Math.min(50,Math.max(3,Math.floor(i*.05)))):u>50&&Math.random()<.5&&(c="open_market",f=365*2),r.push(`AI_DEMAND_SURRENDER:${JSON.stringify({nationId:a.id,nationName:a.name,warScore:a.warScore,demandType:c,demandAmount:f})}`)}}},$c=({nation:e,tick:o,population:i,playerWealth:n,resources:r,logs:a})=>{const u=e;if(!u.isAtWar||u.isPeaceRequesting)return;const l=u.lastMercyPeaceOfferDay||0;if(o-l<30)return;const d=(r==null?void 0:r.silver)||0,f=(r==null?void 0:r.food)||0,b=d+f+((r==null?void 0:r.wood)||0),g=i<20,p=n<50&&d<30,w=b<100&&i<50,x=u.warDuration||0;if(!(x>=30&&(g||p&&i<50||w&&p)))return;const M=u.aggression||.3,C=Math.min(1,(g?.4:0)+(p?.3:0)+(w?.2:0)+(i<10?.3:0)),k=.05+x/500+C*.3,q=M*.15,B=Math.min(.5,Math.max(.1,k-q));Math.random()<B&&(u.lastMercyPeaceOfferDay=o,u.isMercyPeaceOffering=!0,u.mercyPeaceOfferDay=o,a.push(`🕊️ ${u.name} 见你已无力继续战斗，愿意无条件议和。`),a.push(`AI_MERCY_PEACE_OFFER:${JSON.stringify({nationId:u.id,nationName:u.name,warScore:u.warScore,warDuration:x,playerPopulation:i,playerWealth:n})}`))},Gc=({nation:e,nations:o,tick:i,epoch:n,resources:r,stabilityValue:a,logs:u,difficultyLevel:l=mn})=>{var U,Q,I;const c=e,d=r,f=(U=c.relation)!=null?U:50,b=(Q=c.aggression)!=null?Q:.2,g=vr(l);if(pa(i,l))return;const p=(o||[]).filter(W=>W.isAtWar===!0&&W.id!==c.id&&!W.isRebelNation).length,w=(o||[]).some(W=>W.isAtWar&&W.warStartDay&&i-W.warStartDay<cr&&W.id!==c.id),x=p>0?Math.pow(.3,p):1,T=Math.max(0,(50-f)/70),A=a<35?.02:0,M=b>.5?b*.03:0;let C=n>=g?Math.min(.08,b*.04+T*.025+A+M):0;C=da(C,l),C*=x;const k=c.peaceTreatyUntil&&i<c.peaceTreatyUntil,q=c.alliedWithPlayer===!0;!c.isAtWar&&!k&&!q&&f<25&&p<pn&&!w&&Math.random()<C&&(c.isAtWar=!0,c.warStartDay=i,c.warDuration=0,c.warDeclarationPending=!0,u.push(`⚠️ ${c.name} 对你发动了战争！`),u.push(`WAR_DECLARATION_EVENT:${JSON.stringify({nationId:c.id,nationName:c.name})}`));const j=(d.food||0)+(d.silver||0)+(d.wood||0),H=c.wealth||500,O=(I=c.militaryStrength)!=null?I:1;if(!c.isAtWar&&!k&&!q&&n>=g&&j>H*2&&O>.8&&f<50&&b>.4&&p<pn&&!w){let W=.001*b*(j/H-1);W=da(W,l),Math.random()<W&&(c.isAtWar=!0,c.warStartDay=i,c.warDuration=0,c.warDeclarationPending=!0,u.push(`⚠️ ${c.name} 觊觎你的财富，发动了战争！`),u.push(`WAR_DECLARATION_EVENT:${JSON.stringify({nationId:c.id,nationName:c.name,reason:"wealth"})}`))}},qc=(e,o,i)=>{e.forEach(n=>{if(Object.values(n.foreignWars||{}).filter(l=>l==null?void 0:l.isAtWar).length<3||e.filter(l=>{var c,d;return((d=(c=l.foreignWars)==null?void 0:c[n.id])==null?void 0:d.isAtWar)&&l.id!==n.id}).length>=2)return;const u=e.filter(l=>{var d,f,b,g;return l.id===n.id||(f=(d=l.foreignWars)==null?void 0:d[n.id])!=null&&f.isAtWar||(l.allies||[]).includes(n.id)?!1:((g=(b=l.foreignRelations)==null?void 0:b[n.id])!=null?g:50)<40});if(u.length>=2&&Math.random()<.005){const l=u[Math.floor(Math.random()*u.length)];l.foreignWars||(l.foreignWars={}),n.foreignWars||(n.foreignWars={}),l.foreignWars[n.id]={isAtWar:!0,warStartDay:o,warScore:0},n.foreignWars[l.id]={isAtWar:!0,warStartDay:o,warScore:0},i.push(`⚔️ 国际新闻：${l.name} 认为 ${n.name} 的好战行为威胁地区稳定，对其宣战！`)}})},Uc=(e,o,i,n)=>{e.forEach(r=>{r.foreignWars||(r.foreignWars={}),e.forEach(a=>{var H,O,U,Q,I;if(a.id===r.id||(H=r.foreignWars[a.id])!=null&&H.isAtWar)return;const u=((O=r.foreignWars[a.id])==null?void 0:O.peaceTreatyUntil)||0;if(i<u||(r.allies||[]).includes(a.id)||(a.allies||[]).includes(r.id))return;const c=Object.values(r.foreignWars||{}).filter(W=>W==null?void 0:W.isAtWar).length,d=r.aggression>.7?2:1;if(c>=d)return;const f=r.population||100,b=r.wealth||500;if(f<30||b<300)return;const g=W=>{var ae;return((ae=W.militaryStrength)!=null?ae:1)*(W.population||100)*(1+(W.aggression||.3))};let p=g(r),w=g(a);e.forEach(W=>{if(W.id===r.id||W.id===a.id)return;((r.allies||[]).includes(W.id)||(W.allies||[]).includes(r.id))&&(p+=g(W)),((a.allies||[]).includes(W.id)||(W.allies||[]).includes(a.id))&&(w+=g(W))});const x=p/Math.max(1,w),T=r.aggression>.7?.5:.7;if(x<T)return;const M=Object.values(a.foreignWars||{}).filter(W=>W==null?void 0:W.isAtWar).length>0?.002:0,C=(Q=(U=r.foreignRelations)==null?void 0:U[a.id])!=null?Q:50,k=(I=r.aggression)!=null?I:.3,q=C<50,B=k>.25,j=C<15;if(q&&B||j){let W=k*.003+(50-C)/5e3;C<10?W+=.01:C<20&&(W+=.003),x>2?W*=2:x>1.5?W*=1.5:x>1.2?W*=1.2:x<.8&&(W*=.1),W+=M*.5;const ae=a.wealth||500;if(ae>b*1.5&&x>.8){const fe=.003*k*(ae/b-1);W+=fe}if(W=Math.min(.003,W),Math.random()<W){r.foreignWars[a.id]={isAtWar:!0,warStartDay:i,warScore:0},a.foreignWars||(a.foreignWars={}),a.foreignWars[r.id]={isAtWar:!0,warStartDay:i,warScore:0};const fe=[`📢 国际新闻：${r.name} 向 ${a.name} 宣战了！`,`📢 国际新闻：${r.name} 正式对 ${a.name} 宣战！`,`📢 国际新闻：战争爆发！${r.name} 对 ${a.name} 发起了战争！`];n.push(fe[Math.floor(Math.random()*fe.length)]);const ye=a.alliedWithPlayer===!0,Ee=r.alliedWithPlayer===!0,N=ye&&Ee,K=e.filter(ue=>ue.isAtWar===!0&&!ue.isRebelNation).length;N?n.push(`⚖️ 你的盟友 ${r.name} 与 ${a.name} 发生冲突，你选择保持中立。`):(ye&&!r.isAtWar&&n.push(`ALLY_ATTACKED_EVENT:${JSON.stringify({allyId:a.id,allyName:a.name,attackerId:r.id,attackerName:r.name,currentPlayerWars:K})}`),Ee&&!a.isAtWar&&(K>=pn?n.push(`⚖️ 你的盟友 ${r.name} 向 ${a.name} 宣战！但你已陷入多场战争，选择不介入。`):(a.isAtWar=!0,a.warStartDay=i,a.warDuration=0,a.relation=Math.max(0,(a.relation||50)-40),n.push(`⚔️ 你的盟友 ${r.name} 向 ${a.name} 宣战！作为同盟，你被迫与 ${a.name} 进入战争状态！`)))),e.forEach(ue=>{if(ue.id===r.id||ue.id===a.id)return;((a.allies||[]).includes(ue.id)||(ue.allies||[]).includes(a.id))&&(ue.foreignWars||(ue.foreignWars={}),ue.foreignWars[r.id]={isAtWar:!0,warStartDay:i,warScore:0},r.foreignWars||(r.foreignWars={}),r.foreignWars[ue.id]={isAtWar:!0,warStartDay:i,warScore:0},n.push(`⚔️ ${ue.name} 作为 ${a.name} 的盟友，加入对 ${r.name} 的战争！`))})}}})})},Vc=(e,o,i,n)=>{const r=new Set(e.map(a=>a.id));e.forEach(a=>{Object.keys(a.foreignWars||{}).forEach(u=>{var A,M;const l=a.foreignWars[u];if(!(l!=null&&l.isAtWar))return;const c=o.find(C=>C.id===u);if(!c||!r.has(u)){a.foreignWars[u]={isAtWar:!1},c&&n.push(`⚔️ ${a.name} 与 ${c.name} 的战争因对方势力消亡而结束。`);return}c.foreignWars||(c.foreignWars={}),c.foreignWars[a.id]||(c.foreignWars[a.id]={isAtWar:!0,warStartDay:l.warStartDay||i,warScore:-(l.warScore||0)});const d=i-(l.warStartDay||i),f=Math.min(2,1+d/500),b=.995-f*.003,g=.998-f*.002,p=Object.values(a.foreignWars||{}).filter(C=>C==null?void 0:C.isAtWar).length,w=Object.values(c.foreignWars||{}).filter(C=>C==null?void 0:C.isAtWar).length,x=Math.pow(.998,p-1),T=Math.pow(.998,w-1);if(a.wealth=Math.max(100,(a.wealth||500)*b*x),a.population=Math.max(10,(a.population||100)*g*x),c.wealth=Math.max(100,(c.wealth||500)*b*T),c.population=Math.max(10,(c.population||100)*g*T),(i-l.warStartDay)%10===0&&i>l.warStartDay){const C=((A=a.militaryStrength)!=null?A:1)*(a.population||100)*(1+(a.aggression||.3)),k=((M=c.militaryStrength)!=null?M:1)*(c.population||100)*(1+(c.aggression||.3)),q=C+k,B=C/q,j=.02+Math.random()*.03;if(a.population=Math.max(10,(a.population||100)*(1-j*(1-B))),c.population=Math.max(10,(c.population||100)*(1-j*B)),Math.random()<B){l.warScore=(l.warScore||0)+5,c.foreignWars[a.id].warScore=(c.foreignWars[a.id].warScore||0)-5;const I=Math.floor((c.wealth||500)*.08);a.wealth=(a.wealth||500)+I,c.wealth=Math.max(100,(c.wealth||500)-I)}else{l.warScore=(l.warScore||0)-5,c.foreignWars[a.id].warScore=(c.foreignWars[a.id].warScore||0)+5;const I=Math.floor((a.wealth||500)*.08);c.wealth=(c.wealth||500)+I,a.wealth=Math.max(100,(a.wealth||500)-I)}l.endScoreThreshold||(l.endScoreThreshold=25+Math.floor(Math.random()*56));const H=Math.abs(l.warScore||0),O=(a.population||100)<30||(a.wealth||500)<200,U=(c.population||100)<30||(c.wealth||500)<200,Q=O||U?.03:.005;if(H>=l.endScoreThreshold||Math.random()<Q){const I=(l.warScore||0)>0?a:c,W=I.id===a.id?c:a,ae=Math.abs(l.warScore||0);let fe="draw",ye=0,Ee=0,N=365,K="僵持";ae>=200?(fe="overwhelming",ye=.25,Ee=.35,N=365*3,K="压倒性胜利"):ae>=100?(fe="major",ye=.15,Ee=.25,N=Math.floor(365*2.5),K="大胜"):ae>=50?(fe="minor",ye=.08,Ee=.12,N=365*2,K="小胜"):ae>=25&&(fe="pyrrhic",ye=.03,Ee=.05,N=Math.floor(365*1.5),K="惨胜");const ue=Math.floor((W.population||100)*ye),be=Math.floor((W.wealth||500)*Ee);I.population=(I.population||100)+ue,I.wealth=(I.wealth||500)+be,W.population=Math.max(10,(W.population||100)-ue),W.wealth=Math.max(100,(W.wealth||500)-be);let Ce=!1;fe==="overwhelming"&&(W.population||100)<30&&(W.wealth||500)<300&&(I.population=(I.population||100)+(W.population||0),I.wealth=(I.wealth||500)+(W.wealth||0),W.isAnnexed=!0,W.annexedBy=I.id,W.annexedAt=i,W.population=0,W.wealth=0,Ce=!0),a.foreignWars[u]={isAtWar:!1,peaceTreatyUntil:i+N},c.foreignWars[a.id]={isAtWar:!1,peaceTreatyUntil:i+N};const ke=10+Math.floor(ae/10);a.foreignRelations||(a.foreignRelations={}),c.foreignRelations||(c.foreignRelations={}),a.foreignRelations[u]=vt((a.foreignRelations[u]||50)-ke,0,100),c.foreignRelations[a.id]=vt((c.foreignRelations[a.id]||50)-ke,0,100);const tt=i-(l.warStartDay||i);Ce?n.push(`📢 国际新闻：${I.name} 在历时${tt}天的战争中彻底击败 ${W.name}，将其吞并！`):fe==="draw"?n.push(`📢 国际新闻：${a.name} 与 ${c.name} 经过${tt}天的战争后握手言和。`):n.push(`📢 国际新闻：${I.name} 在与 ${W.name} 历时${tt}天的战争中取得${K}！`)}}})})},zc=e=>Array.isArray(e)?e.map(o=>(o.foreignRelations||(o.foreignRelations={}),e.forEach(i=>{if(i.id!==o.id){if(o.foreignRelations[i.id]===void 0){const n=((o.aggression||.3)+(i.aggression||.3))/2;o.foreignRelations[i.id]=Math.floor(50-n*30+(Math.random()-.5)*20)}if(Math.random()<.05){const n=(Math.random()-.5)*6;o.foreignRelations[i.id]=vt((o.foreignRelations[i.id]||50)+n,0,100)}}}),o)):[],Hc=(e,o)=>!(o%30===0)||!Array.isArray(e)?e||[]:e.map(n=>{var c;if(n.isRebelNation)return n;const r=(c=n.relation)!=null?c:50,u=n.alliedWithPlayer===!0?.1:.5;let l=r;return r>50?l=Math.max(50,r-u):r<50&&(l=Math.min(50,r+u)),{...n,relation:l}}),Yc=(e,o,i)=>{Array.isArray(e)&&e.forEach(n=>{var a,u;if(n.isRebelNation||n.alliedWithPlayer!==!0||((a=n.relation)!=null?a:50)>=70)return;const r=n.lastAllyColdEventDay||0;o-r<30||Math.random()<.005&&(n.lastAllyColdEventDay=o,i.push(`ALLY_COLD_EVENT:${JSON.stringify({nationId:n.id,nationName:n.name,relation:Math.round((u=n.relation)!=null?u:50)})}`))})},Jc=(e,o)=>{e.forEach(i=>{var c;if(Math.random()>.02)return;const n=(c=i.aggression)!=null?c:.3,r=i.wealth||500;if(n>.6||r<300)return;const a=e.filter(d=>{var b,g,p,w;if(d.id===i.id||(g=(b=i.foreignWars)==null?void 0:b[d.id])!=null&&g.isAtWar)return!1;const f=(w=(p=i.foreignRelations)==null?void 0:p[d.id])!=null?w:50;return f>=40&&f<80});if(a.length===0)return;const u=a[Math.floor(Math.random()*a.length)],l=zn(r,u.wealth);if(r>l*3){i.wealth=Math.max(0,(i.wealth||0)-l),u.wealth=(u.wealth||0)+l;const d=Math.floor(5+Math.random()*8);i.foreignRelations||(i.foreignRelations={}),u.foreignRelations||(u.foreignRelations={}),i.foreignRelations[u.id]=vt((i.foreignRelations[u.id]||50)+d,0,100),u.foreignRelations[i.id]=vt((u.foreignRelations[i.id]||50)+d,0,100),i.foreignRelations[u.id]>=80&&u.foreignRelations[i.id]>=80?o.push(`🤝 国际新闻：${i.name} 与 ${u.name} 达成同盟协议！`):Math.random()<.3&&o.push(`💝 国际新闻：${i.name} 向 ${u.name} 赠送了外交礼物，两国关系升温。`)}})},Xc=(e,o)=>{e.forEach(i=>{if(Math.random()>.02||i.isAtWar||(i.wealth||500)<300)return;const r=e.filter(d=>{var b,g,p,w;return d.id===i.id||d.isAtWar||(g=(b=i.foreignWars)==null?void 0:b[d.id])!=null&&g.isAtWar?!1:((w=(p=i.foreignRelations)==null?void 0:p[d.id])!=null?w:50)>=30});if(r.length===0)return;const a=r[Math.floor(Math.random()*r.length)],u=Math.floor(20+Math.random()*60);u*(1-.08)-u*.5<=0||(i.wealth=(i.wealth||0)+u*.05,a.wealth=(a.wealth||0)+u*.05,i.foreignRelations||(i.foreignRelations={}),a.foreignRelations||(a.foreignRelations={}),i.foreignRelations[a.id]=Math.min(100,(i.foreignRelations[a.id]||50)+1),a.foreignRelations[i.id]=Math.min(100,(a.foreignRelations[i.id]||50)+1))})},Qc=(e,o,i,n,r,a={})=>{const u=i;e.forEach(l=>{var k,q,B,j,H,O,U,Q,I,W,ae,fe;if(Math.random()>.005||l.isAtWar||((k=l.relation)!=null?k:50)<40)return;const c=l.wealth||500;if(c<400)return;const d=l.openMarketUntil&&o<l.openMarketUntil,f=Math.random()>.5,b=["food","wood","stone","iron"],g=b[Math.floor(Math.random()*b.length)],p=((q=n==null?void 0:n.prices)==null?void 0:q[g])||((B=qe[g])==null?void 0:B.basePrice)||1,w=((j=a==null?void 0:a.resourceTaxRates)==null?void 0:j[g])||0,x=f?(Q=(U=(H=a==null?void 0:a.exportTariffMultipliers)==null?void 0:H[g])!=null?U:(O=a==null?void 0:a.resourceTariffMultipliers)==null?void 0:O[g])!=null?Q:0:(fe=(ae=(I=a==null?void 0:a.importTariffMultipliers)==null?void 0:I[g])!=null?ae:(W=a==null?void 0:a.resourceTariffMultipliers)==null?void 0:W[g])!=null?fe:0,T=d?0:w+x,A=Math.floor(10+Math.random()*40),M=A*p,C=Math.floor(M*T);if(f){const ye=p*1.5,Ee=A*ye,N=M+C;if(Ee<=N)return;(u[g]||0)>=A&&(u[g]=(u[g]||0)-A,u.silver=(u.silver||0)+C,l.wealth=Math.max(0,(l.wealth||0)-M-C),l.inventory||(l.inventory={}),l.inventory[g]=(l.inventory[g]||0)+A,r.push(`AI_TRADE_EVENT:${JSON.stringify({nationId:l.id,nationName:l.name,tradeType:"export",resourceKey:g,quantity:A,baseValue:M,tariff:C,isOpenMarket:d})}`),l.relation=Math.min(100,(l.relation||50)+2))}else{const ye=A*p*.6;if(M-C<=ye)return;c>=M*.6&&(u[g]=(u[g]||0)+A,u.silver=(u.silver||0)+C,l.wealth=(l.wealth||0)+M-C,l.inventory||(l.inventory={}),l.inventory[g]=Math.max(0,(l.inventory[g]||0)-A),r.push(`AI_TRADE_EVENT:${JSON.stringify({nationId:l.id,nationName:l.name,tradeType:"import",resourceKey:g,quantity:A,baseValue:M,tariff:C,isOpenMarket:d})}`),l.relation=Math.min(100,(l.relation||50)+2))}})},Zc=(e,o,i,n)=>{e.forEach(r=>{var C;const a=r.wealth||500,u=(C=r.aggression)!=null?C:.3,l=r.relation||0;if(r.isAtWar===!0)return;const d=r.lastGiftToPlayerDay||0,b=o-d>=1825,g=2e-5+l/1e6+a/1e8;if(b&&a>1e3&&l>=70&&u<.4&&Math.random()<g){const k=zn(a);r.wealth=Math.max(0,r.wealth-k),r.lastGiftToPlayerDay=o,n.push(`AI_GIFT_EVENT:${JSON.stringify({nationId:r.id,nationName:r.name,amount:Math.floor(k)})}`)}const p=5e-5+Math.max(0,(400-a)/1e6);if(i>=1&&a<400&&Math.random()<p){const k=Math.floor(80+Math.random()*120);n.push(`AI_REQUEST_EVENT:${JSON.stringify({nationId:r.id,nationName:r.name,resourceKey:"silver",resourceName:"银币",amount:k})}`)}const w=r.alliedWithPlayer===!0,x=r.lastAllianceRequestDay||0,A=o-x>=1095,M=5e-5+(l-70)/1e5;A&&!w&&l>=70&&u<.5&&Math.random()<M&&(r.lastAllianceRequestDay=o,n.push(`AI_ALLIANCE_REQUEST:${JSON.stringify({nationId:r.id,nationName:r.name})}`))})},Kc=(e,o,i)=>{e.forEach(n=>{var d,f,b,g,p;if(Math.random()>.002||((d=n.aggression)!=null?d:.3)>.6)return;n.allies||(n.allies=[]);const a=e.filter(w=>{var A,M,C,k,q,B;if(w.id===n.id||n.allies.includes(w.id)||(M=(A=n.foreignWars)==null?void 0:A[w.id])!=null&&M.isAtWar)return!1;const x=(k=(C=n.foreignRelations)==null?void 0:C[w.id])!=null?k:50,T=(B=(q=w.foreignRelations)==null?void 0:q[n.id])!=null?B:50;return x>=70&&T>=70});if(a.length===0)return;const u=a[Math.floor(Math.random()*a.length)],c=((((b=(f=n.foreignRelations)==null?void 0:f[u.id])!=null?b:50)+((p=(g=u.foreignRelations)==null?void 0:g[n.id])!=null?p:50))/2-60)/100;Math.random()<c&&(u.allies||(u.allies=[]),n.allies.push(u.id),u.allies.push(n.id),i.push(`🤝 国际新闻：${n.name} 与 ${u.name} 正式缔结军事同盟！`))})},e0=(e,o)=>{var r;if(!e.alliedWithPlayer||e.isAtWar)return;const i=(r=e.relation)!=null?r:50;(i<40||(e.allianceStrain||0)>=3)&&(e.alliedWithPlayer=!1,e.allianceStrain=0,o.push(`AI_BREAK_ALLIANCE:${JSON.stringify({nationId:e.id,nationName:e.name,reason:i<40?"relation_low":"player_neglect"})}`))},t0=(e,o="normal")=>{var u;const i=(u=e.relation)!=null?u:50;let n=0;const r=ma(o),a=Er(o);i>50?n=-a*r.bad:i<50&&(n=a*r.good),e.relation=Math.max(0,Math.min(100,i+n)),e.foreignRelations&&Object.keys(e.foreignRelations).forEach(l=>{var d;let c=(d=e.foreignRelations[l])!=null?d:50;c>50?c-=a*r.bad:c<50&&(c+=a*r.good),e.foreignRelations[l]=Math.max(0,Math.min(100,c))})},o0=({nation:e,tick:o,gameSpeed:i})=>{var d;const n=e;n.inventory?n.inventory={...n.inventory}:n.inventory={},typeof n.budget!="number"&&(n.budget=(n.wealth||800)*.5);const r=((d=n.economyTraits)==null?void 0:d.resourceBias)||{},a=Object.keys(qe).filter(Nt);if(a.length>0){const b=n.isAtWar||n.foreignWars&&Object.values(n.foreignWars).some(x=>x==null?void 0:x.isAtWar)?1.3+(n.aggression||.2)*.5:1,g=n.epoch||0,p=1+g*.5+Math.pow(g,1.3)*.1,w=Math.max(.8,Math.min(2,(n.wealth||1e3)/1e3));a.forEach(x=>{var we;const T=(we=r[x])!=null?we:1,A=n.inventory[x]||0,M=Math.round(500*Math.pow(T,1.2)),C=Math.round(M*p*w),k=5*i*p*w,q=5*i*p*w*b,B=x.split("").reduce((z,ve)=>z+ve.charCodeAt(0),0),j=600+B%200,H=Math.sin(o*2*Math.PI/j+B*.1),O=.35+Math.abs(T-1)*.45,U=T>1?1+Math.max(0,H)*O+.2:1-Math.max(0,H)*O*.4,Q=T<1?1+Math.max(0,H)*O+.15:1-Math.max(0,H)*O*.25,I=k*Math.pow(T,1.2)*U,W=q*Math.pow(1/T,.8)*Q,ae=A/C;let fe=1,ye=1;ae>1.5?(fe*=.5,ye*=1.15):ae>1.1?(fe*=.8,ye*=1.05):ae<.5?(fe*=1.5,ye*=.85):ae<.9&&(fe*=1.2,ye*=.95);const Ee=(C-A)*.01*i,N=(Math.random()-.5)*C*.1*i,K=I*fe,ue=W*ye,be=K-ue+Ee+N,Ce=C*.2,ke=C*3,tt=A+be;n.inventory[x]=Math.max(Ce,Math.min(ke,tt))})}const u=(n.wealth||800)*.5,l=.02,c=u-n.budget;n.budget=n.budget+c*l*i,n.budget=Math.max(0,n.budget)},i0=({nation:e,tick:o})=>{var n;const i=e;if(!((n=i.economyTraits)!=null&&n.ownBasePopulation)){const a=(i.wealthTemplate||800)/800;i.economyTraits={...i.economyTraits||{},ownBasePopulation:Math.max(5,Math.round(16*a*(.8+Math.random()*.4))),ownBaseWealth:Math.max(500,Math.round(1e3*a*(.8+Math.random()*.4))),developmentRate:.8+(i.aggression||.3)*.3+Math.random()*.4,lastGrowthTick:o}}},n0=({nation:e,tick:o})=>{const i=e;if(!i.economyTraits)return;const n=i.economyTraits.ownBasePopulation,r=i.economyTraits.ownBaseWealth,a=i.economyTraits.developmentRate||1;if(o-(i.economyTraits.lastGrowthTick||0)>=100){const l=Math.max(1,(n||10)/200),c=vt(1/(1+l*.6),.2,1),d=.3*a*c;if(Math.random()<d&&!i.isAtWar){const f=(1.03+Math.random()*.05)*c,b=(1.04+Math.random()*.08)*Math.max(.4,c);i.economyTraits.ownBasePopulation=Math.round(n*f),i.economyTraits.ownBaseWealth=Math.round(r*b)}i.economyTraits.lastGrowthTick=o}},a0=({nation:e,epoch:o,playerPopulationBaseline:i,playerWealthBaseline:n,tick:r})=>{var z,ve,Xe,L,F,ee,oe,S,ot,It,Ft,yo;const a=e,u=a.foreignPower||{},l=vt((ve=(z=u.volatility)!=null?z:a.marketVolatility)!=null?ve:.3,.1,.9),c=vt((L=(Xe=u.populationFactor)!=null?Xe:u.baseRating)!=null?L:1,.6,2.5),d=vt((F=u.wealthFactor)!=null?F:u.baseRating?u.baseRating*1.1:1.1,.5,3.5),f=1+Math.max(0,o-((ee=u.appearEpoch)!=null?ee:0))*.03,b=1+Math.max(0,o)*.15,g=(((oe=a.economyTraits)==null?void 0:oe.ownBasePopulation)||16)*b*c,p=(((S=a.economyTraits)==null?void 0:S.ownBaseWealth)||1e3)*b*d,w=.3,x=i*c*f,T=n*d*f,A=g*(1-w)+x*w,M=p*(1-w)+T*w,C=Math.max(1,(a.wealthTemplate||800)/Math.max(800,n)*.8),k=Math.max(1,(a.wealthTemplate||800)/Math.max(800,n)*1.1),q=di("food",a,r),B=q.isShortage?vt(1-q.shortageAmount/Math.max(1,q.target),.5,1):1,j=q.isSurplus?vt(1+q.surplusAmount/Math.max(1,q.target)*.08,1,1.15):1,H=vt(B*j,.5,1.15),O=Math.max(3,A*C*H),U=Math.max(200,i*1.5,(((ot=a.economyTraits)==null?void 0:ot.ownBasePopulation)||16)*25),Q=Math.max(0,O-U),I=Q>0?U+Q/(1+Q/U):O,W=Math.max(100,M*k);a.economyTraits={...a.economyTraits||{},basePopulation:I,baseWealth:W};const ae=(It=a.population)!=null?It:I,fe=vt(1+l*.6+f*.08,1,1.8),ye=vt(1/(1+Math.pow(ae/Math.max(1,U),1.3)),.25,1),Ee=(a.isAtWar?.032:.12)*fe*ye,N=(Math.random()-.5)*l*I*.04*ye;let K=ae+(I-ae)*Ee+N;if(a.isAtWar&&(K-=ae*.012),a.population=Math.max(3,Math.round(K)),q.isShortage){const Ie=vt(q.shortageAmount/Math.max(1,q.target),0,1),Le=(Ft=a.militaryStrength)!=null?Ft:1;a.militaryStrength=Math.max(.6,Le-Ie*.01)}const ue=(yo=a.wealth)!=null?yo:W,be=(a.isAtWar?.03:.11)*fe,Ce=(Math.random()-.5)*l*W*.05;let ke=ue+(W-ue)*be+Ce;a.isAtWar&&(ke-=ue*.015),a.wealth=Math.max(100,Math.round(ke));const tt=a.wealth*.45,we=Number.isFinite(a.budget)?a.budget:tt;a.budget=Math.max(0,we+(tt-we)*.35)},s0=e=>{var u;const o=e;o.economyTraits||(o.economyTraits={});const i=Math.max(5,o.economyTraits.basePopulation||o.population||10),n=Math.max(100,o.economyTraits.baseWealth||o.wealth||200);o.economyTraits.basePopulation=i,o.economyTraits.baseWealth=n;const r=Math.max(i,Math.floor(i*1.1)),a=Math.max(n,Math.floor(n*1.15));o.population=vt(Math.round(o.population||i),5,r),o.wealth=vt(Math.round(o.wealth||n),n*.5,a),o.budget=Math.min(o.wealth,Math.max(0,(u=o.budget)!=null?u:Math.floor(o.wealth*.3)))},r0=e=>{var o;if(!e.isAtWar){const i=(o=e.militaryStrength)!=null?o:1;i<1&&(e.militaryStrength=Math.min(1,i+.005))}},c0=({nation:e,resources:o,logs:i})=>{let n=0;const r=e,a=o;if(r.installmentPayment&&r.installmentPayment.remainingDays>0){const u=r.installmentPayment.amount;a.silver=(a.silver||0)+u,n+=u,r.installmentPayment.paidAmount+=u,r.installmentPayment.remainingDays-=1,r.installmentPayment.remainingDays===0&&(i.push(`💰 ${r.name} 完成了所有分期赔款支付（共${r.installmentPayment.totalAmount}银币）。`),delete r.installmentPayment)}return n},l0=({resources:e,buildings:o,population:i,popStructure:n={},birthAccumulator:r=0,decrees:a,gameSpeed:u,epoch:l,market:c,classWealth:d,classApproval:f={},activeBuffs:b=[],activeDebuffs:g=[],taxPolicies:p,army:w={},militaryWageRatio:x=1,militaryQueue:T=[],nations:A=[],tick:M=0,techsUnlocked:C=[],activeFestivalEffects:k=[],classWealthHistory:q,classNeedsHistory:B,merchantState:j={pendingTrades:[],lastTradeTime:0},maxPopBonus:H=0,eventApprovalModifiers:O={},eventStabilityModifier:U=0,currentStability:Q=50,eventResourceDemandModifiers:I={},eventStratumDemandModifiers:W={},eventBuildingProductionModifiers:ae={},livingStandardStreaks:fe={},buildingUpgrades:ye={},rulingCoalition:Ee=[],previousLegitimacy:N=0,migrationCooldowns:K={},difficulty:ue,officials:be=[],activeDecrees:Ce,officialsPaid:ke=!0,quotaTargets:tt={},expansionSettings:we={},cabinetStatus:z={},priceControls:ve=null,previousTaxShock:Xe={}})=>{var rs,cs,ls,us,ds,fs,ps,hs,ms,gs,ys,bs,Ms,ws,xs;const L={...e},F={...(c==null?void 0:c.prices)||{}},ee={},oe={},S={},ot={},It={};Object.keys(ce).length>0&&Object.keys(ce).forEach(t=>{S[t]={income:{wage:0,ownerRevenue:0,subsidy:0},expense:{headTax:0,transactionTax:0,businessTax:0,tariffs:0,essentialNeeds:{},luxuryNeeds:{},decay:0,productionCosts:0,wages:0}}});const Ft=(A||[]).some(t=>t.isAtWar===!0),yo=3,Ie=p||{},Le=Ie.headTaxRates||{},ct=Ie.resourceTaxRates||{},Ct=Ie.businessTaxRates||{},Zt=Vr(F,Le,ct);Fi(Zt,(xt==null?void 0:xt.price)||{});const ut=Fi(Zt,(xt==null?void 0:xt.wage)||{}),Kt=(c==null?void 0:c.wages)||{},bo=t=>{const s=ut==null?void 0:ut[t];return!Number.isFinite(s)||s<=0?Li*.8:Math.max(Li*.8,s*1.1)},$t=t=>{var m;const s=Kt==null?void 0:Kt[t];if(Number.isFinite(s)&&s>0)return Math.max(Zo,s);const h=(m=ce[t])==null?void 0:m.startingWealth;return Number.isFinite(h)&&h>0?Math.max(Li*.5,h/40,bo(t)):Math.max(E0,bo(t))},Gt={},gi={},Mo={},pe=sc(d),So=t=>{const s=Le[t];return typeof s=="number"?s:1},ei=t=>{const s=ct[t];return typeof s=="number"?s:0},u0=t=>{const s=Ct[t];return typeof s=="number"?s:1},ze=Hr(),_=dc();z.effects&&(z.effects.adminEfficiency&&(_.taxEfficiencyBonus=(_.taxEfficiencyBonus||0)+z.effects.adminEfficiency),z.effects.stabilityMod&&(_.stabilityBonus=(_.stabilityBonus||0)+z.effects.stabilityMod),z.effects.tradeBonusMod&&(_.tradeBonusMod=(_.tradeBonusMod||0)+z.effects.tradeBonusMod),z.effects.diplomaticRelationsMod&&(_.diplomaticBonus=(_.diplomaticBonus||0)+z.effects.diplomaticRelationsMod),z.effects.approvalBonus&&Object.entries(z.effects.approvalBonus).forEach(([t,s])=>{_.stanceApprovalEffects=_.stanceApprovalEffects||{},_.stanceApprovalEffects[t]=(_.stanceApprovalEffects[t]||0)+s}),z.effects.organizationGrowthMod&&(_.organizationGrowthMod=(_.organizationGrowthMod||0)+z.effects.organizationGrowthMod),z.effects.researchSpeed&&(_.scienceBonus=(_.scienceBonus||0)+z.effects.researchSpeed)),z.decreeEffects&&To(z.decreeEffects,_);const at=Rc(be,ke),d0={...at,passive:at.passiveGains,passivePercent:at.passivePercentGains,resourceDemandMod:at.decreeResourceDemandMod,stratumDemandMod:at.decreeStratumDemandMod,maxPop:at.extraMaxPop,incomePercent:at.incomePercentBonus};To(d0,_),at.researchSpeed&&(_.scienceBonus=(_.scienceBonus||0)+at.researchSpeed),_.taxEfficiencyBonus=at.taxEfficiency||0,_.corruption=at.corruption||0,at.incomePercentBonus&&(_.incomePercentBonus=(_.incomePercentBonus||0)+at.incomePercentBonus),_.populationGrowthBonus=at.populationGrowth||0,_.militaryUpkeepMod=at.militaryUpkeep||0,_.tradeBonusMod=at.tradeBonus||0,_.buildingCostMod=at.buildingCostMod||0,_.wartimeProduction=at.wartimeProduction||0,_.resourceWaste=at.resourceWaste||{},_.coalitionApproval=at.coalitionApproval||0,_.legitimacyBonus=at.legitimacyBonus||0,_.organizationGrowthMod=(_.organizationGrowthMod||0)+(at.organizationDecay||0),_.factionConflict=(_.factionConflict||0)+(at.factionConflict||0),_.diplomaticCooldown=at.diplomaticCooldown||0,_.diplomaticIncident=at.diplomaticIncident||0,_.diplomaticBonus=at.diplomaticBonus||0,_.officialProductionInputCost=at.productionInputCost||{};const f0={classApproval:f,classInfluence:(c==null?void 0:c.classInfluence)||{},totalInfluence:(c==null?void 0:c.totalInfluence)||1,classLivingStandard:(c==null?void 0:c.classLivingStandard)||{},classIncome:(c==null?void 0:c.classIncome)||{},stability:Q/100,legitimacy:N,taxPolicies:Ie,rulingCoalition:Ee,atWar:Ft,population:i,epoch:l,buildings:o},Qe=jc(be,f0).aggregatedEffects;Qe.stability&&(_.stabilityBonus=(_.stabilityBonus||0)+Qe.stability),Qe.legitimacyBonus&&(_.legitimacyBonus=(_.legitimacyBonus||0)+Qe.legitimacyBonus),Qe.gatherBonus&&(_.categoryBonuses.gather=(_.categoryBonuses.gather||0)+Qe.gatherBonus),Qe.industryBonus&&(_.categoryBonuses.industry=(_.categoryBonuses.industry||0)+Qe.industryBonus),Qe.tradeBonus&&(_.tradeBonusMod=(_.tradeBonusMod||0)+Qe.tradeBonus),Qe.researchSpeed&&(_.scienceBonus=(_.scienceBonus||0)+Qe.researchSpeed),Qe.taxEfficiency&&(_.taxEfficiencyBonus=(_.taxEfficiencyBonus||0)+Qe.taxEfficiency),Qe.incomePercentBonus&&(_.incomePercentBonus=(_.incomePercentBonus||0)+Qe.incomePercentBonus),Qe.buildingCostMod&&(_.buildingCostMod=(_.buildingCostMod||0)+Qe.buildingCostMod),Qe.needsReduction&&(_.needsReduction=(_.needsReduction||0)+Qe.needsReduction),Qe.populationGrowth&&(_.populationGrowthBonus=(_.populationGrowthBonus||0)+Qe.populationGrowth),Qe.militaryBonus&&(_.militaryBonus=(_.militaryBonus||0)+Qe.militaryBonus),Qe.organizationDecay&&(_.organizationGrowthMod=(_.organizationGrowthMod||0)+Qe.organizationDecay),Qe.cultureBonus&&(_.cultureBonus=(_.cultureBonus||0)+Qe.cultureBonus),Qe.diplomaticBonus&&(_.diplomaticBonus=(_.diplomaticBonus||0)+Qe.diplomaticBonus),_.stanceApprovalEffects=Qe.approval||{},_.stanceProductionInputCost=Qe.productionInputCost||{};const{buildingBonuses:$i,categoryBonuses:Gi,passiveGains:p0,passivePercentGains:h0,perPopPassiveGains:m0,decreeResourceDemandMod:yi,decreeStratumDemandMod:bi,decreeResourceSupplyMod:vn}=_;let{decreeSilverIncome:qi,decreeSilverExpense:Ui,extraMaxPop:Aa,maxPopPercent:Cn,productionBonus:_n,industryBonus:En,taxBonus:g0,needsReduction:Wa}=_;fc(C,_);const y0=Ce?Object.entries(Ce).map(([t,s])=>({id:t,active:!0,modifiers:(s==null?void 0:s.effects)||(s==null?void 0:s.modifiers)})):[],b0=Array.isArray(a)?a.filter(t=>t&&t.active):[];pc([...y0,...b0],_),hc(k,_),Array.isArray(b)&&b.forEach(t=>{To(t,_)}),Array.isArray(g)&&g.forEach(t=>{To(t,_)});let Vi=null;if(Ee&&Ee.length>0){const t=lc({popStructure:n,classWealthResult:d}),s=qr(Ee,t.classInfluence);Vi=Sr(s.name),mc(Vi,_)}ui&&ui[l]&&ui[l].bonuses&&To(ui[l].bonuses,_),qi=_.decreeSilverIncome,Ui=_.decreeSilverExpense,Aa=_.extraMaxPop,Cn=_.maxPopPercent,_n=_.productionBonus,En=_.industryBonus,g0=_.taxBonus,Wa=_.needsReduction;const M0=_.incomePercentBonus||0,qt=t=>(F[t]||(F[t]=fo(t)),F[t]=Math.max(Zo,F[t]),F[t]);let jo=null;const w0=(t,s,h)=>{var m,y;if(t==="silver"&&s>0){Ze[h]=(Ze[h]||0)+s,S[h]&&(S[h].income.ownerRevenue=(S[h].income.ownerRevenue||0)+s),jo&&ot[jo]&&(ot[jo].ownerRevenue+=s);return}if(!(s<=0)&&(L[t]=(L[t]||0)+s,Nt(t))){Mo[t]=(Mo[t]||0)+s;const E=qt(t),P=((m=z==null?void 0:z.dominance)==null?void 0:m.panelType)==="plannedEconomy"&&(ve==null?void 0:ve.enabled)&&((y=ve.governmentBuyPrices)==null?void 0:y[t])!==void 0;let G=E;if(P){const Z=wr({resourceKey:t,amount:s,marketPrice:E,priceControls:ve,taxBreakdown:ze,resources:L});Z.success&&(G=Z.effectivePrice)}let V=G*s;Ze[h]=(Ze[h]||0)+V,jo&&ot[jo]&&(ot[jo].ownerRevenue+=V),S[h]&&(S[h].income.ownerRevenue=(S[h].income.ownerRevenue||0)+V)}},Re={},eo=o,x0=new Set,wo={},Io={},Ze={},Mi={},zi={};let _o=5,Ra=0;_o+=Aa,_o+=H,oa(w),_s(w),Object.values(w).reduce((t,s)=>t+s,0),Wt.forEach(t=>wo[t]=0),Wt.forEach(t=>{Io[t]={totalSlots:0,weightedWage:0},Ze[t]=0});const dt={};Object.keys(ce).forEach(t=>{dt[t]=0});const Uo={};Object.keys(ce).forEach(t=>{Uo[t]=0}),Object.keys(ce).forEach(t=>{});const v0=()=>{Object.entries(Ze).forEach(([t,s])=>{if(s<=0){Mi[t]=s;return}const h=Mi[t]||0,m=s-h;m>0&&(pe[t]=qo((pe[t]||0)+m)),Mi[t]=s})};io.forEach(t=>{const s=eo[t.id]||0;if(s>0){const h=ye[t.id]||{};let m=0;Object.entries(h).forEach(([D,P])=>{const G=parseInt(D);Number.isFinite(G)&&G>0&&P>0&&(m+=P)});const E={0:Math.max(0,s-m)};Object.entries(h).forEach(([D,P])=>{const G=parseInt(D);Number.isFinite(G)&&G>0&&P>0&&(E[G]=P)}),Object.entries(E).forEach(([D,P])=>{var le,re;if(P<=0)return;const G=parseInt(D),$=jt(t,G);let V=1+($i[t.id]||0);const Z=1+(Gi[t.cat]||0);if(V*=Z,(le=$.output)!=null&&le.maxPop&&(_o+=$.output.maxPop*V*P),(re=$.output)!=null&&re.militaryCapacity&&(Ra+=$.output.militaryCapacity*V*P),$.jobs)for(let me in $.jobs)wo[me]=(wo[me]||0)+$.jobs[me]*P;$.output&&Object.entries($.output).forEach(([me,lt])=>{qe[me]&&(lt||0)>0&&x0.add(me)})})}});const wi=new Set;if(io.forEach(t=>{var m;const s=((m=t.epoch)!=null?m:0)<=l,h=!t.requiresTech||C.includes(t.requiresTech);s&&h&&t.output&&Object.entries(t.output).forEach(([y,E])=>{qe[y]&&(E||0)>0&&wi.add(y)})}),Cn!==0){const t=Math.max(0,1+Cn);_o=Math.max(0,_o*t)}_o=Math.floor(_o);let Ba=0;Object.entries(w).forEach(([t,s])=>{if(!s||s<=0)return;const h=lo[t],m=(h==null?void 0:h.populationCost)||1;Ba+=s*m});const C0=(T||[]).reduce((t,s)=>{if(s.status==="waiting"||s.status==="training"){const h=lo[s.unitId],m=(h==null?void 0:h.populationCost)||1;return t+m}return t},0),Sa=Ba+C0;Sa>0&&(wo.soldier=(wo.soldier||0)+Sa);const _0=n&&Object.keys(n).length>0,Y={};let xi=0;if(_0){Wt.forEach(s=>{const h=n[s]||0;Y[s]=Math.max(0,h)}),Y.unemployed=Math.max(0,n.unemployed||0);const t=Wt.reduce((s,h)=>s+(Y[h]||0),0)+(Y.unemployed||0);if(xi=i-t,xi>0)Y.unemployed=(Y.unemployed||0)+xi;else if(xi<0){let s=-xi;const h=Math.min(Y.unemployed||0,s);if(h>0&&(Y.unemployed-=h,s-=h),s>0){const m=Wt.reduce((y,E)=>y+(Y[E]||0),0);if(m>0){const y=s;Wt.forEach((E,D)=>{if(s<=0)return;const P=Y[E]||0;if(P<=0)return;const G=P/m;let $=Math.floor(G*y);$<=0&&s>0&&($=1),D===Wt.length-1?$=Math.min(P,s):$=Math.min(P,Math.min($,s)),!($<=0)&&(Y[E]=P-$,s-=$)}),s>0&&Wt.forEach(E=>{if(s<=0)return;const D=Y[E]||0;if(D<=0)return;const P=Math.min(D,s);Y[E]=D-P,s-=P})}}}}else{let t=i;Wt.forEach(s=>{const h=Math.max(0,wo[s]||0),m=Math.min(t,h);Y[s]=m,t-=m}),Y.unemployed=Math.max(0,t)}Y.unemployed=Math.max(0,Y.unemployed||0);const E0=zr(Y,Kt);Wt.forEach(t=>{if(t==="official")return;const s=Y[t]||0,h=Math.max(0,wo[t]||0);if(s>h){const m=s-h,y=pe[t]||0,E=s>0?y/s:0;if(Y[t]=h,Y.unemployed=(Y.unemployed||0)+m,E>0){const D=E*m;pe[t]=Math.max(0,y-D),pe.unemployed=(pe.unemployed||0)+D}}});const P0=Array.isArray(be)?be.length:0;Y.official=P0,pe.official=0;let T0=1,vi=0,Pn=Ma(N);const Oo=Math.max(0,T0*Pn*(1+(_.taxBonus||0))),k0=t=>{let h=0,m=0,y=0,E=0;io.forEach($=>{var lt,Ke,Be,et,it,He,ht;const V=eo[$.id]||0;if(V<=0)return;const Z=jt($,0),le=Z.jobs||{},re=le[t]||0;if(re<=0)return;if($.owner===t){let _e=0;Z.output&&Object.entries(Z.output).forEach(([Se,$e])=>{if(!qe[Se])return;const Te=F[Se]||fo(Se);_e+=$e*Te});let Ne=0;Z.input&&Object.entries(Z.input).forEach(([Se,$e])=>{const Te=F[Se]||fo(Se);Ne+=$e*Te});let se=0;Object.entries(le).forEach(([Se,$e])=>{var Tt,_t;if(Se===t||!$e||$e<=0)return;const Te=(_t=(Tt=c==null?void 0:c.wages)==null?void 0:Tt[Se])!=null?_t:$t(Se);se+=Te*$e});const ge=((Ke=(lt=ce[t])==null?void 0:lt.headTaxBase)!=null?Ke:.01)*So(t)*Oo,de=(Be=$.businessTaxBase)!=null?Be:.1,Ye=(it=(et=Ie==null?void 0:Ie.businessTaxRates)==null?void 0:et[$.id])!=null?it:1,De=de*Ye,st=_e-Ne-se-ge-De,Fe=re>0?st/re:0;h+=Fe*re*V,m+=re*V}else{const _e=(ht=(He=c==null?void 0:c.wages)==null?void 0:He[t])!=null?ht:$t(t);y+=_e*re*V,E+=re*V}});const D=m+E;if(D<=0)return $t(t);const G=(h+y)/D;return Math.max($t(t),G*1.2)};nc({popStructure:Y,jobsAvailable:wo,wealth:pe,getExpectedWage:t=>{if((Y[t]||0)<=5){const h=k0(t),m=$t(t);return Math.max(h,m)}return $t(t)},getHeadTaxRate:So,effectiveTaxModifier:Oo});const Ot={},Ht={},Yt={},ft={},Oe=[],Hi={},Tn={};Object.entries(p0).forEach(([t,s])=>{if(!s)return;const h=s,m=L[t]||0;if(h>=0)L[t]=m+h,Re[t]=(Re[t]||0)+h;else{const y=Math.abs(h),E=Math.min(m,y);E>0&&(L[t]=m-E,Re[t]=(Re[t]||0)-E)}});const kn=i||0;Object.entries(m0||{}).forEach(([t,s])=>{if(!s||kn<=0)return;const h=s*kn,m=L[t]||0;if(h>=0)L[t]=m+h,Re[t]=(Re[t]||0)+h;else{const y=Math.abs(h),E=Math.min(m,y);E>0&&(L[t]=m-E,Re[t]=(Re[t]||0)-E)}}),Object.entries(h0||{}).forEach(([t,s])=>{if(!s)return;const h=Re[t]||0;if(h!==0){const m=Math.abs(h)*s;h>=0?(L[t]=(L[t]||0)+m,Re[t]=h+m):(L[t]=(L[t]||0)-m,Re[t]=h-m)}else{const y=kn*.01*s;L[t]=(L[t]||0)+y,Re[t]=(Re[t]||0)+y}});const An={},Wn=1-Math.max(-2,Math.min(.95,Wa||0));Object.keys(ce).forEach(t=>{var V,Z,le;if(t==="official")return;const s=Y[t]||0;if(s===0)return;const h=ce[t];pe[t]===void 0&&(pe[t]=h.startingWealth||0);const m=So(t),E=((Z=(V=ce[t])==null?void 0:V.headTaxBase)!=null?Z:.01)*m*Oo,D=Math.max(0,pe[t]||0),P=D/Math.max(1,s),G=E>=0?Math.min(E,P):E,$=s*G;if($!==0)if($>0){const re=Math.min(D,$);pe[t]=D-re,ze.headTax+=re,Uo[t]=(Uo[t]||0)+re,dt[t]=(dt[t]||0)+re,S[t]&&(S[t].expense.headTax=(S[t].expense.headTax||0)+re)}else{const re=-$,me=L.silver||0;me>=re&&(L.silver=me-re,pe[t]=qo(D+re),ze.subsidy+=re,Ze[t]=(Ze[t]||0)+re,S[t]&&(S[t].income.subsidy=(S[t].income.subsidy||0)+re))}Ot[t]=(le=f[t])!=null?le:50,(Ot[t]||0)<=0&&(An[t]=!0)});const A0=!!(Ce&&Ce.forced_labor);io.forEach(t=>{var Si,ji,un,go,Ii,xo,oo,vo,Yo;const s=eo[t.id]||0;if(s===0)return;const h=ye[t.id]||{},m={input:{},output:{},jobs:{}};let y=0,E=!1;Object.entries(h).forEach(([v,R])=>{const J=parseInt(v);Number.isFinite(J)&&J>0&&R>0&&(y+=R,E=!0)});const D=Math.max(0,s-y),P={0:D};Object.entries(h).forEach(([v,R])=>{const J=parseInt(v);Number.isFinite(J)&&J>0&&R>0&&(P[J]=R)});const G={};Object.entries(P).forEach(([v,R])=>{if(R<=0)return;const J=parseInt(v),ie=jt(t,J).owner||"state";G[ie]||(G[ie]={levels:{},totalCount:0}),G[ie].levels[J]=R,G[ie].totalCount+=R}),Object.keys(G).forEach(v=>{var R;pe[v]===void 0&&(pe[v]=((R=ce[v])==null?void 0:R.startingWealth)||0)}),t.owner;let $=1;if(!E&&D===s){if(t.input)for(const[v,R]of Object.entries(t.input))m.input[v]=R*s;if(t.output)for(const[v,R]of Object.entries(t.output))m.output[v]=R*s;if(t.jobs)for(const[v,R]of Object.entries(t.jobs))m.jobs[v]=R*s}else for(const[v,R]of Object.entries(P)){if(R<=0)continue;const J=parseInt(v),X=jt(t,J);if(X.input)for(const[ie,te]of Object.entries(X.input))m.input[ie]=(m.input[ie]||0)+te*R;if(X.output)for(const[ie,te]of Object.entries(X.output))m.output[ie]=(m.output[ie]||0)+te*R;if(X.jobs)for(const[ie,te]of Object.entries(X.jobs))m.jobs[ie]=(m.jobs[ie]||0)+te*R}const V=ui[l];let Z=0;V&&V.bonuses&&(t.cat==="gather"&&V.bonuses.gatherBonus&&(Z+=V.bonuses.gatherBonus),t.cat==="industry"&&V.bonuses.industryBonus&&(Z+=V.bonuses.industryBonus));let le=0,re=0;b.forEach(v=>{v.production&&(le+=v.production),v.industryBonus&&(re+=v.industryBonus)}),g.forEach(v=>{v.production&&(le+=v.production),v.industryBonus&&(re+=v.industryBonus)}),le+=_n,re+=En,(t.cat==="gather"||t.cat==="civic")&&(Z+=le),t.cat==="industry"&&(Z+=re),Ft&&_.wartimeProduction&&(Z+=_.wartimeProduction);const me=Gi[t.cat];me&&me!==0&&(Z+=me);const lt=ae[t.id]||0,Ke=ae[t.cat]||0,Be=ae.all||0;Z+=lt+Ke+Be;const et=$i[t.id];et&&et!==0&&(Z+=et),$*=1+Z,ot[t.id]||(ot[t.id]={wagesByRole:{},paidWagePerWorkerByRole:{},filledByRole:{},wagePaidRatioByOwner:{},ownerRevenue:0,productionCosts:0,businessTaxPaid:0});let it=1,He=0,ht=0;const _e={};let Ne=0;const se=[];if(Object.keys(m.jobs).length>0){Hi[t.id]=Hi[t.id]||{};for(let v in m.jobs){const R=m.jobs[v];Io[v]||(Io[v]={totalSlots:0,weightedWage:0}),He+=R;const J=wo[v],X=Y[v],ie=J>0?Math.min(1,X/J):0,te=R*ie;ht+=te,Hi[t.id][v]=te,ot[t.id].filledByRole[v]=(ot[t.id].filledByRole[v]||0)+te;const he=Math.max(0,R-te);if(he>.001){const We=he>=1?Math.floor(he):1;(zi[v]||(zi[v]=[])).push({buildingId:t.id,buildingName:t.name||t.id,availableSlots:We})}if(!Object.keys(G).includes(v)&&te>0){const We=(Si=_e[v])!=null?Si:$t(v),xe=bo(v),Ge=Math.max(We,xe);_e[v]=Ge,Ne+=te*Ge,se.push({role:v,ownerKey:t.owner||"state",roleSlots:R,filled:te,baseWage:Ge})}}He>0&&(it=ht/He),He>0&&(Tn[t.id]=it)}const Pe=$;$*=it,A0&&((ji=t.jobs)!=null&&ji.serf||(un=t.jobs)!=null&&un.miner)&&($*=1.2);const ge=$,de=ge>0?ge:Pe;let Ye=1,De=0,st=!1;const Fe=Object.keys(m.input).length>0,Se=Object.keys(m.output).some(v=>v!=="maxPop"&&v!=="militaryCapacity");if(Fe&&Se){const v=((go=_.officialProductionInputCost)==null?void 0:go[t.id])||0,R=((Ii=_.stanceProductionInputCost)==null?void 0:Ii[t.id])||0,J=v+R;if(J!==0){const X=1+J,ie=Math.max(.2,X);for(const[te,he]of Object.entries(m.input))m.input[te]=he*ie}if(_.resourceWaste)for(const[X,ie]of Object.entries(m.input)){const te=((xo=_.resourceWaste)==null?void 0:xo[X])||0;if(!te)continue;const he=Math.max(0,1+te);m.input[X]=ie*he}}if(Object.keys(m.input).length>0)for(const[v,R]of Object.entries(m.input)){if(!Xo(v,l,C))continue;const J=R,X=J*de;if(X<=0)continue;const ie=L[v]||0;if(ie<=0?Ye=0:Ye=Math.min(Ye,ie/X),Nt(v)){const te=qt(v),he=ei(v);De+=J*te*(1+he)}}let $e=ge*Math.max(0,Math.min(1,Ye)),Te=de*Math.max(0,Math.min(1,Ye));if(t.cat==="gather"&&Ye===0&&Object.keys(m.input).length>0){$e=ge*.2,Te=de*.2,st=!0,De=0;const v=Object.keys(m.input).map(R=>{var J;return((J=qe[R])==null?void 0:J.name)||R}).join("、");M%30===0&&Oe.push(`⚠️ ${t.name} 缺少 ${v}，工人正在徒手作业（效率20%）`)}let Tt=0,_t=!1;if(Object.keys(m.output).length>0)for(const[v,R]of Object.entries(m.output)){if(v==="maxPop"||!Nt(v))continue;_t=!0;const ie=R*qt(v);Tt+=ie}const kt=de>0?Ne/de:Ne,Me=Tt*Te,je=De*Te,rt=kt*Te,Ut=Math.max(0,Me-je),Je=rt>0?Ut/rt:1,mt=Number.isFinite(Je)?Je>=1?Math.min(3,1+(Je-1)*.5):Math.max(.65,1-(1-Je)*.5):1,gt=kt*mt,co=gt*Te,nt=t.cat==="civic"&&!t.owner&&((oo=t.output)==null?void 0:oo.maxPop)>0,Vt=t.cat==="military",Rt=(vo=t.businessTaxBase)!=null?vo:.1,Et=nt||Vt?0:u0(t.id),wt=Rt*Et,Ae=wt*s*Te,Ue=De+gt;let Ve=$e,Pt=Te,Jt=null,Bt=null;const ai=Math.min(co,Ut),ne=$e>0?ai/$e:0,yt=De+ne;if(_t){const v=je+ai+Math.max(0,Ae);if(v>0&&Me<=0)Ve=0,Jt=0;else if(v>0&&Me<v*.98){const R=Math.max(0,Math.min(1,Me/v));Jt=R,Ve=$e*R,Pt=Te*R}else Jt=v>0?Me/v:null;Bt={baseMultiplier:ge,resourceLimit:Ye,targetMultiplier:$e,estimatedRevenue:Me,estimatedInputCost:je,estimatedWageCost:co,actualPayableWageCost:ai,actualWageCostPerMultiplier:ne,actualOperatingCostPerMultiplier:yt,estimatedBusinessTax:Ae,estimatedCost:v,marginRatio:Jt,actualMultiplierAfterMargin:Ve,outputValuePerMultiplier:Tt,inputCostPerMultiplier:De,wageCostPerMultiplier:gt,count:s,expectedWageBillBase:Ne,baseWageCostPerMultiplier:kt,wagePressure:mt,baseWageCost:rt,wageCoverage:Je,valueAvailableForLabor:Ut,wagePlans:se}}if(yt>0){let v=1/0;const R=[];Object.entries(G).forEach(([ie,te])=>{const he=te.totalCount/s,We=yt*he,xe=pe[ie]||0,Ge=We>0?xe/We:1/0;v=Math.min(v,Ge),R.push({owner:ie,proportion:he,operatingCost:We,cash:xe,affordable:Ge})});const J=v===1/0?$e:v,X=v===1/0?Te:v;Ve=Math.min(Ve,Math.max(0,J)),Pt=Math.min(Pt,Math.max(0,X)),Bt&&(Bt.totalOperatingCostPerMultiplier=Ue,Bt.minAffordableMultiplier=v,Bt.affordableMultiplier=J,Bt.actualMultiplierAfterAffordable=Ve,Bt.ownerDetails=R)}Bt&&(It[t.id]=Bt),(!Number.isFinite(Ve)||Ve<0)&&(Ve=0);const No=.3;let zt=1;Object.keys(G).forEach(v=>{An[v]&&(zt=Math.min(zt,No))}),Object.keys(m.jobs).length>0&&Object.keys(m.jobs).forEach(v=>{An[v]&&(zt=Math.min(zt,No))}),Ve*=zt,Pt*=zt;const to=ge>0?Math.min(1,Ve/ge):0,si=de>0?Math.min(1,Pt/de):0;let Wi=0;if(Object.keys(m.input).length>0&&!st){const v={};Object.entries(P).forEach(([R,J])=>{if(J<=0)return;const X=parseInt(R),ie=jt(t,X);!ie.input||Object.keys(ie.input).length===0||(v[X]={},Object.entries(ie.input).forEach(([te,he])=>{v[X][te]=he*J*Ve}))});for(const[R,J]of Object.entries(m.input)){if(!Xo(R,l,C))continue;const X=J*Ve;if(!X||X<=0)continue;const ie=L[R]||0,te=Math.min(X,ie),he=X>0?te/X:0;if(Nt(R)){const We=qt(R),xe=ei(R);Object.entries(v).forEach(([Ge,At])=>{const pt=parseInt(Ge),Dt=At[R]||0;if(Dt<=0)return;const St=Dt*he;if(St<=0)return;const bt=jt(t,pt).owner||"state",ci=St*We,Fo=ci*xe;let $o=ci;if(Fo<0){const Go=Math.abs(Fo);(L.silver||0)>=Go&&(L.silver-=Go,ze.subsidy+=Go,$o-=Go,Ze[bt]=(Ze[bt]||0)+Go,S[bt]&&(S[bt].income.subsidy=(S[bt].income.subsidy||0)+Go))}else Fo>0&&(ze.industryTax+=Fo,$o+=Fo,S[bt]&&(S[bt].expense.transactionTax=(S[bt].expense.transactionTax||0)+Fo));pe[bt]=Math.max(0,(pe[bt]||0)-$o),dt[bt]=(dt[bt]||0)+$o,ot[t.id].productionCosts+=$o,S[bt]&&(S[bt].expense.productionCosts=(S[bt].expense.productionCosts||0)+$o)}),Gt[R]=(Gt[R]||0)+te,gi[R]||(gi[R]={buildings:{},pop:0}),gi[R].buildings[t.id]=(gi[R].buildings[t.id]||0)+te}te<=0||(L[R]=ie-te,Re[R]=(Re[R]||0)-te)}}Object.keys(m.jobs).length>0&&Object.entries(m.jobs).forEach(([v,R])=>{const J=R;J<=0||(Io[v]||(Io[v]={totalSlots:0,weightedWage:0}),Io[v].totalSlots+=J)});const ho={};Object.entries(P).forEach(([v,R])=>{const J=parseInt(v),X=jt(t,J);let ie=0;X.output&&Object.entries(X.output).forEach(([pt,Dt])=>{if(pt==="maxPop"||!Nt(pt))return;const Lt=Dt*qt(pt);ie+=Lt});let te=0;X.input&&Object.entries(X.input).forEach(([pt,Dt])=>{Xo(pt,l,C)&&Nt(pt)&&(te+=Dt*qt(pt))});let he=0;const We=X.owner||"state";X.jobs&&Object.entries(X.jobs).forEach(([pt,Dt])=>{var Lt;if(pt===We)return;const St=(Lt=_e[pt])!=null?Lt:$t(pt);he+=Dt*St});const xe=Math.max(0,ie-te),Ge=he>0?xe/he:1;let At=1;Number.isFinite(Ge)?Ge>=1?At=Math.min(3,1+(Ge-1)*.5):At=Math.max(.65,1-(1-Ge)*.5):At=1,ho[J]=At});let Po=0,Ho=0;Object.entries(P).forEach(([v,R])=>{const J=parseInt(v),X=ho[J]||1;Po+=X*R,Ho+=R});const Ri=Ho>0?Po/Ho:mt,Bi=((Yo=t.marketConfig)==null?void 0:Yo.wage)||{},Ro=Bi.wageMode,ri=Bi.subsistenceMultiplier||1.5,ln=se.map(v=>{const R=v.ownerKey||t.owner||"state";let J=Ri;if(Object.keys(P).length>1){let te=0,he=0;Object.entries(P).forEach(([We,xe])=>{var Dt;const Ge=parseInt(We),pt=((Dt=jt(t,Ge).jobs)==null?void 0:Dt[v.role])||0;if(pt>0){const St=ho[Ge]||1;te+=St*pt*xe,he+=pt*xe}}),he>0&&(J=te/he)}let X=v.baseWage*to*J;Ro==="subsistence"&&(X=((ut==null?void 0:ut[v.role])||bo(v.role))*ri);const ie=X*v.filled;return Wi+=ie,{...v,ownerKey:R,expectedSlotWage:X,wagePressure:J,wageMode:Ro,subsistenceMultiplier:Ro==="subsistence"?ri:void 0}}),mo={};if(ot[t.id].wagePaidRatioByOwner=mo,Wi>0){const v={};Object.entries(P).forEach(([R,J])=>{if(J<=0)return;const X=parseInt(R),ie=jt(t,X),te=ie.owner||"state";v[te]||(v[te]=0),ie.jobs&&Object.entries(ie.jobs).forEach(([he,We])=>{if(he===te)return;let xe;Ro==="subsistence"?xe=((ut==null?void 0:ut[he])||bo(he))*ri:xe=$t(he);const Ge=We*J*xe*to*(ho[X]||1);v[te]+=Ge})}),Object.entries(v).forEach(([R,J])=>{if(J<=0){mo[R]=0;return}const X=pe[R]||0;let ie=0;const te=ce[R];te&&te.needs&&(Object.entries(te.needs).forEach(([xe,Ge])=>{const At=qt(xe);ie+=Ge*At}),ie*=1.2);const he=Math.max(0,X-ie),We=Math.min(he,J);pe[R]=X-We,dt[R]=(dt[R]||0)+We,S[R]&&(S[R].expense.wages=(S[R].expense.wages||0)+We),mo[R]=J>0?We/J:0})}if(ln.forEach(v=>{var ie;const R=(ie=mo[v.ownerKey])!=null?ie:0,J=v.expectedSlotWage*R,X=v.baseWage*si*v.wagePressure;if(Io[v.role].weightedWage+=X*v.roleSlots,v.filled>0&&J>0){const te=J*v.filled;ot[t.id].wagesByRole[v.role]=(ot[t.id].wagesByRole[v.role]||0)+te,Ze[v.role]=(Ze[v.role]||0)+te,S[v.role]&&(S[v.role].income.wage=(S[v.role].income.wage||0)+te)}}),Object.entries(ot[t.id].wagesByRole).forEach(([v,R])=>{const J=ot[t.id].filledByRole[v]||0;J>0&&(ot[t.id].paidWagePerWorkerByRole[v]=R/J)}),Object.keys(m.output).length>0){const v={};Object.entries(P).forEach(([R,J])=>{if(J<=0)return;const X=parseInt(R),ie=jt(t,X);!ie.output||Object.keys(ie.output).length===0||(v[X]={},Object.entries(ie.output).forEach(([te,he])=>{v[X][te]=he*J*Ve}))});for(const[R,J]of Object.entries(m.output)){let X=J*Ve;if(!X||X<=0)continue;let ie=1;if(Nt(R)&&R!=="silver"){const te=qe[R],he=(te==null?void 0:te.marketConfig)||{},We=(xt==null?void 0:xt.market)||{},xe=he.outputVariation!==void 0?he.outputVariation:We.outputVariation||.2;ie=1+(Math.random()*2-1)*xe,X*=ie;const Ge=vn[R]||0;Ge!==0&&(X*=1+Ge),R==="science"&&_.scienceBonus&&(X*=1+_.scienceBonus),R==="culture"&&_.cultureBonus&&(X*=1+_.cultureBonus)}R!=="maxPop"&&(Nt(R)?(Object.entries(v).forEach(([te,he])=>{const We=parseInt(te),xe=he[R]||0;if(xe<=0)return;const Ge=J*Ve,At=Ge>0?xe/Ge:0,pt=X*At;if(pt<=0)return;const St=jt(t,We).owner||"state";jo=t.id,w0(R,pt,St),jo=null}),Re[R]=(Re[R]||0)+X,oe[R]||(oe[R]={buildings:{},imports:0}),oe[R].buildings[t.id]=(oe[R].buildings[t.id]||0)+X):L[R]=(L[R]||0)+X)}}if(wt!==0&&s>0){const v=wt*s*Ve;if(v>0){let R=0;Object.entries(G).forEach(([J,X])=>{var We;const ie=X.totalCount/s,te=v*ie,he=pe[J]||0;he>=te?(pe[J]=he-te,dt[J]=(dt[J]||0)+te,ot[t.id].businessTaxPaid+=te,R+=te,S[J]&&(S[J].expense.businessTax=(S[J].expense.businessTax||0)+te)):M%30===0&&he<te*.5&&Oe.push(`⚠️ ${((We=ce[J])==null?void 0:We.name)||J} 无力支付 ${t.name} 的营业税，政府放弃征收。`)}),ze.businessTax+=R}else if(v<0){const R=Math.abs(v),J=L.silver||0;J>=R?(L.silver=J-R,ze.subsidy+=R,Object.entries(G).forEach(([X,ie])=>{const te=ie.totalCount/s,he=R*te;pe[X]=qo((pe[X]||0)+he),Ze[X]=(Ze[X]||0)+he,S[X]&&(S[X].income.subsidy=(S[X].income.subsidy||0)+he)})):M%30===0&&Oe.push(`⚠️ 国库空虚，无法为 ${t.name} 支付营业补贴！`)}}if(t.id==="market"){const v=t.owner||"merchant",R=(Y[v]||0)>0,J=M%5===0;if(R&&J){let ie=pe[v]||0;if(!(ie<=0)){const te=[];if(Object.entries(L).forEach(([he,We])=>{if(!Nt(he)||he==="silver"||(We||0)<=300||(Re[he]||0)<0)return;const xe=qt(he);te.push({resource:he,stock:We,localPrice:xe})}),te.length>0){const he=[];if(Object.keys(qe).forEach(We=>{if(!Nt(We)||We==="silver")return;const xe=L[We]||0,Ge=Re[We]||0,At=Math.max(0,(Gt[We]||0)-(Mo[We]||0)),pt=Math.max(0,200-xe),Dt=Ge<0?Math.abs(Ge):0,St=Math.max(At,pt,Dt);if(St<=0)return;const Lt=Math.max(Zo,qt(We)*1.15),bt=St*Lt;bt<=0||he.push({resource:We,shortageAmount:St,importPrice:Lt,requiredValue:bt})}),he.length>0){he.sort((xe,Ge)=>Ge.requiredValue-xe.requiredValue);const We=10;he.forEach(xe=>{var pt,Dt;if(ie<=0)return;let Ge=xe.shortageAmount,At=xe.requiredValue;for(const St of te){if(ie<=0||Ge<=0||At<=0)break;const Lt=St.resource,bt=St.localPrice;if(bt<=0)continue;const ci=L[Lt]||0;if(ci<=0)continue;const Fo=At/bt,$o=ci*.05,Go=ie/bt,Jo=Math.min(Fo,$o,Go);if(!Number.isFinite(Jo)||Jo<=0)continue;const dn=Jo*bt;if(ie-=dn,pe[v]=ie,dt[v]=(dt[v]||0)+dn,L[Lt]=Math.max(0,ci-Jo),Mo[Lt]=(Mo[Lt]||0)+Jo,Re[Lt]=(Re[Lt]||0)-Jo,St.stock=Math.max(0,St.stock-Jo),At=Math.max(0,At-dn),xe.importPrice<=0)continue;let Co=dn/xe.importPrice;if(!Number.isFinite(Co)||Co<=0||(Co=Math.min(Co,Ge),Co<=0))continue;const li=Co*xe.importPrice;pe[v]+=li,ie+=li,L[xe.resource]=(L[xe.resource]||0)+Co,Mo[xe.resource]=(Mo[xe.resource]||0)+Co,Re[xe.resource]=(Re[xe.resource]||0)+Co,oe[xe.resource]||(oe[xe.resource]={buildings:{},imports:0}),oe[xe.resource].imports=(oe[xe.resource].imports||0)+Co,Ge=Math.max(0,Ge-Co),li>0&&(Mi[v]=(Mi[v]||0)+li,Ze[v]=(Ze[v]||0)+li),li>We&&((pt=qe[Lt])!=null&&pt.name,(Dt=qe[xe.resource])!=null&&Dt.name||xe.resource)}})}}}}}t.jobs&&Object.entries(t.jobs).forEach(([v,R])=>{R*s<=0})});const W0=Tr(ue),Yi=Bs(w);Object.keys(Yi).forEach(t=>{Yi[t]=Math.ceil((Yi[t]||0)*W0)});const ja={};Object.entries(Yi).forEach(([t,s])=>{ja[t]=Ft?s*yo:s});let Ji=0;const Ia={};Object.entries(ja).forEach(([t,s])=>{var D;if(s<=0)return;if(t==="silver"){Ji+=s;return}const h=L[t]||0,m=Math.min(h,s);m>0&&(L[t]=h-m,Re[t]=(Re[t]||0)-m,Ia[t]=m,Gt[t]=(Gt[t]||0)+s);const y=qt(t);let E=y;if(ve!=null&&ve.enabled&&(E=la({resourceKey:t,amount:s,marketPrice:y,priceControls:ve,taxBreakdown:ze,resources:L}).effectivePrice),Ji+=s*E,m<s&&M%30===0){const P=s-m;Oe.push(`⚠️ 军队维护资源不足：缺少 ${((D=qe[t])==null?void 0:D.name)||t} ${P.toFixed(1)}/日`)}});const Oa=1+l*.1,R0=oa(w),Da=Ss(R0,i),La=Math.max(.5,x!=null?x:1),ko=Ji*Oa*Da*La,Xi={dailyExpense:ko,resourceCost:Ji,epochMultiplier:Oa,scalePenalty:Da,wageMultiplier:La,resourceConsumption:Ia};if(ko>0){const t=L.silver||0;if(t>=ko)L.silver=t-ko,Re.silver=(Re.silver||0)-ko,Ze.soldier=(Ze.soldier||0)+ko,S.soldier&&(S.soldier.income.militaryPay=(S.soldier.income.militaryPay||0)+ko);else if(ko>0){const s=t*.9;s>0&&(L.silver=t-s,Re.silver=(Re.silver||0)-s,Ze.soldier=(Ze.soldier||0)+s,S.soldier&&(S.soldier.income.militaryPay=(S.soldier.income.militaryPay||0)+s)),Oe.push(`⚠️ 军饷不足！应付${ko.toFixed(0)}银币，仅能支付${s.toFixed(0)}银币，军心不稳。`)}}const Vo={},ao={},Qi={};Object.keys(ce).forEach(t=>{var it,He,ht,_e,Ne;if(t==="official"){Vo[t]={satisfactionRatio:1,totalTrackedNeeds:0},ao[t]=[];return}const s=ce[t],h=Y[t]||0;if(h===0||!s.needs){Vo[t]={satisfactionRatio:1,totalTrackedNeeds:0},ao[t]=[];return}let m=0,y=0;const E=[],D=s.startingWealth||1,G=(pe[t]||0)/Math.max(1,h)/D,$=s.needs||{};let V=0;["food","cloth"].forEach(se=>{var Pe;if($[se]){const ge=qt(se),de=((Pe=qe[se])==null?void 0:Pe.basePrice)||1,Ye=Math.max(ge,de);V+=$[se]*Ye}});const Z=(Ze[t]||0)/Math.max(1,h),le=V>0?Z/V:Z>0?10:0,re=Math.max(1,(s.maxConsumptionMultiplier||6)+ga(ue)),me=fi(le,G,s.wealthElasticity||1,re),lt=Vs(le).level,Ke=$s({consumptionMultiplier:me,incomeRatio:le,wealthRatio:G,livingStandardLevel:lt}),Be=Gs(le,G,s.wealthElasticity||1,lt),et={...s.needs};if(s.luxuryNeeds){const se=Object.keys(s.luxuryNeeds).map(Number).sort((Pe,ge)=>Pe-ge);for(const Pe of se)if(Be>=Pe){const ge=s.luxuryNeeds[Pe];for(const[de,Ye]of Object.entries(ge))et[de]=(et[de]||0)+Ye*Ke}}for(const[se,Pe]of Object.entries(et)){const ge=qe[se];if(ge&&ge.unlockTech){if(!C.includes(ge.unlockTech))continue}else if(ge&&typeof ge.unlockEpoch=="number"&&ge.unlockEpoch>l)continue;if(!wi.has(se))continue;let de=Pe*h*Wn;if(de<=0)continue;const Ye=((it=_.resourceWaste)==null?void 0:it[se])||0;Ye!==0&&(de*=1+Ye);const De=I[se]||0,st=yi[se]||0,Fe=De+st;Fe!==0&&(de*=1+Fe);const Se=W[t]||0,$e=bi[t]||0,Te=Se+$e;Te!==0&&(de*=1+Te),Ft&&(t==="soldier"||t==="knight")&&(de*=yo);let Tt=1;if(t==="official"&&be&&be.length>0&&(Tt=be.reduce((je,rt)=>je+(rt.greed||1),0)/be.length),Nt(se)){const Me=(ge==null?void 0:ge.marketConfig)||{},je=(xt==null?void 0:xt.market)||{},rt=Me.demandElasticity!==void 0?Me.demandElasticity:je.demandElasticity||.5,Ut=s.startingWealth||1,Je=(pe[t]||0)/Math.max(1,h),mt=(Ze[t]||0)/Math.max(1,h),gt=Math.max(0,mt)*30,nt=Math.max(Je,gt)/Ut;let Vt=s.wealthElasticity||1;t==="official"&&(Vt*=Tt);const Rt=Math.max(1,(s.maxConsumptionMultiplier||6)+ga(ue)),Et=fi(nt,nt,Vt,Rt);(!Qi[t]||Math.abs(Et-1)>Math.abs(Qi[t]-1))&&(Qi[t]=Et);const wt=qt(se),Ae=ge.basePrice||1,Ue=wt/Ae,Ve=Math.pow(Ue,-rt),Pt=.8+Math.random()*.4;de*=Et*Ve*Pt,de=Math.max(0,de),de=Math.min(de,Pe*h*Wn*8)}const _t=L[se]||0;let kt=0;if(Nt(se)){const Me=qt(se),rt=((He=z==null?void 0:z.dominance)==null?void 0:He.panelType)==="plannedEconomy"&&(ve==null?void 0:ve.enabled)&&((ht=ve.governmentSellPrices)==null?void 0:ht[se])!==void 0&&ve.governmentSellPrices[se]!==null;let Ut=Me;rt&&(Ut=ve.governmentSellPrices[se]);const Je=Ut*(1+ei(se)),mt=Je>0?Math.min(de,(pe[t]||0)/Je):de,gt=Math.min(de,_t,mt);if(gt>0){L[se]=_t-gt,Re[se]=(Re[se]||0)-gt;let nt=Me;rt&&(nt=la({resourceKey:se,amount:gt,marketPrice:Me,priceControls:ve,taxBreakdown:ze,resources:L}).effectivePrice);const Vt=ei(se),Rt=gt*nt,Et=Rt*Vt;let wt=Rt;if(Et<0){const Ae=Math.abs(Et);(L.silver||0)>=Ae?(L.silver-=Ae,ze.subsidy+=Ae,wt-=Ae,Ze[t]=(Ze[t]||0)+Ae,S[t]&&(S[t].income.subsidy=(S[t].income.subsidy||0)+Ae)):M%20===0&&Oe.push(`国库空虚，无法为 ${((_e=ce[t])==null?void 0:_e.name)||t} 支付 ${((Ne=qe[se])==null?void 0:Ne.name)||se} 消费补贴！`)}else Et>0&&(ze.industryTax+=Et,wt+=Et);if(pe[t]=Math.max(0,(pe[t]||0)-wt),dt[t]=(dt[t]||0)+wt,kt=gt,Gt[se]=(Gt[se]||0)+gt,ee[t]||(ee[t]={}),ee[t][se]=(ee[t][se]||0)+gt,S[t]){const Ae={cost:wt,quantity:gt,price:nt};if(s.needs&&s.needs.hasOwnProperty(se)){S[t].expense.essentialNeeds=S[t].expense.essentialNeeds||{};const Ue=S[t].expense.essentialNeeds[se];Ue&&typeof Ue=="object"?(Ue.cost+=wt,Ue.quantity+=gt):S[t].expense.essentialNeeds[se]=Ae}else{S[t].expense.luxuryNeeds=S[t].expense.luxuryNeeds||{};const Ue=S[t].expense.luxuryNeeds[se];Ue&&typeof Ue=="object"?(Ue.cost+=wt,Ue.quantity+=gt):S[t].expense.luxuryNeeds[se]=Ae}Et>0&&(S[t].expense.transactionTax=(S[t].expense.transactionTax||0)+Et)}}const co=de>0?kt/de:1;if(m+=co,y+=1,co<.99){const nt=mt>=de*.99,Vt=_t>=de*.99;let Rt="both";nt&&!Vt?Rt="outOfStock":!nt&&Vt&&(Rt="unaffordable"),E.push({resource:se,reason:Rt})}}else{const Me=Math.min(de,_t);Me>0&&(L[se]=_t-Me,kt=Me);const je=de>0?kt/de:1;m+=je,y+=1,je<.99&&E.push({resource:se,reason:"outOfStock"})}}Vo[t]={satisfactionRatio:y>0?m/y:1,totalTrackedNeeds:y},ao[t]=E});let Na=0,Ci=0,Rn=0;Object.keys(ce).forEach(t=>{var y,E;const s=Y[t]||0;if(s<=0)return;Ci+=s;const h=(E=(y=Vo[t])==null?void 0:y.satisfactionRatio)!=null?E:1;Na+=h*s;const m=ce[t];m&&m.needs&&(ao[t]||[]).some(G=>G.resource==="food"||G.resource==="cloth")&&(Rn+=s)});let Zi=.3+.7*(Ci>0?Na/Ci:1);if(Rn>0&&Ci>0){const t=Rn/Ci,s=t*.4;Zi=Math.max(.1,Zi-s),t>.1&&Oe.push("基础需求（食物/布料）严重短缺，劳动效率大幅下降！")}Zi<.999&&Object.entries(Re).forEach(([t,s])=>{const h=qe[t];if(!(!h||t==="silver"||h.type&&h.type==="virtual")&&s>0){const m=s*(1-Zi);Re[t]=s-m,L[t]=Math.max(0,(L[t]||0)-m)}});const B0=Ce?Object.entries(Ce).map(([t,s])=>({id:t,active:!0,modifiers:(s==null?void 0:s.effects)||(s==null?void 0:s.modifiers)})):[];let S0=rc(B0);if(Ce!=null&&Ce.forced_labor&&Y.serf>0&&(Ot.serf=Math.max(0,(Ot.serf||50)-5)),Ce!=null&&Ce.tithe){Y.cleric>0&&(Ot.cleric=Math.max(0,(Ot.cleric||50)-2));const t=(Y.cleric||0)*2*Oo;if(t>0){const s=pe.cleric||0,h=Math.min(s,t);pe.cleric=Math.max(0,s-h),ze.headTax+=h,dt.cleric=(dt.cleric||0)+h}}const ti=tt&&typeof tt=="object"&&Object.prototype.hasOwnProperty.call(tt,"targets")?tt:{enabled:!0,targets:tt||{}};if(((rs=z.dominance)==null?void 0:rs.faction)==="left"&&(ti!=null&&ti.enabled)&&ti.targets&&Object.keys(ti.targets).length>0){const{adjustments:t,approvalPenalties:s,adminCost:h}=hr(Y,ti.targets),m=Object.values(Y).reduce((G,$)=>G+$,0);let y=0,E=null,D=-1;Object.entries(t).forEach(([G,$])=>{Y[G]!==void 0&&(Y[G]=Math.max(0,Math.round(Y[G]+$)))}),Object.keys(Y).forEach(G=>{const $=Y[G];y+=$,$>D&&(D=$,E=G)});const P=m-y;P!==0&&E&&(Y[E]+=P,Y[E]<0&&(Y[E]=0)),Object.entries(s).forEach(([G,$])=>{Ot[G]&&(Ot[G]-=$*.05)})}let Ki={...o};const j0={cabinetStatusReceived:{hasCabinetStatus:!!z,hasDominance:!!(z!=null&&z.dominance),dominanceFaction:(cs=z==null?void 0:z.dominance)==null?void 0:cs.faction,synergy:z==null?void 0:z.synergy,level:z==null?void 0:z.level},expansionSettings:{hasSettings:!!we,settingsKeys:we?Object.keys(we):[],allowedCount:we?Object.values(we).filter(t=>t==null?void 0:t.allowed).length:0},conditionCheck:{isDominanceRight:((ls=z==null?void 0:z.dominance)==null?void 0:ls.faction)==="right",hasExpansionSettings:!!we,willProcess:((us=z==null?void 0:z.dominance)==null?void 0:us.faction)==="right"&&!!we},epochParam:l};if(console.log("[FREE MARKET SIMULATION DEBUG]",{dominanceCheck:{hasDominance:!!(z!=null&&z.dominance),faction:(ds=z==null?void 0:z.dominance)==null?void 0:ds.faction,isRightWing:((fs=z==null?void 0:z.dominance)==null?void 0:fs.faction)==="right"},expansionCheck:{hasSettings:!!we,settingsCount:we?Object.keys(we).length:0,allowedBuildings:we?Object.entries(we).filter(([t,s])=>s==null?void 0:s.allowed).map(([t])=>t):[]},willCallProcessExpansions:!!(z!=null&&z.dominance)&&z.dominance.faction==="right"&&!!we}),((ps=z.dominance)==null?void 0:ps.faction)==="right"&&we){const t={prices:F,wages:(c==null?void 0:c.wages)||{}},{expansions:s,wealthDeductions:h}=yr(io,pe,we,Ki,t,p,Tn);s.length>0&&(s.forEach(m=>{const y=m.buildingId;Ki[y]=(Ki[y]||0)+1}),Object.entries(h).forEach(([m,y])=>{pe[m]&&(pe[m]=Math.max(0,pe[m]-y))}),Object.assign(eo,Ki))}let _i=0,Fa=0,oi=0;const Bn=[],Sn={prices:F,wages:(c==null?void 0:c.wages)||{}},ii=(be||[]).map(t=>{var Ae,Ue,Ve,Pt,Jt,Bt,ai;if(!t)return t;const s=Ic(t,M),h=1e12;let m=typeof s.wealth=="number"?s.wealth:400;(!Number.isFinite(m)||m<0)&&(m=400);let y=Math.min(m,h);const E=y;ke&&typeof s.salary=="number"?(y+=s.salary,oi+=s.salary,console.log(`[OFFICIAL DEBUG] ${s.name}: Salary paid! +${s.salary}, wealth: ${E} -> ${y}`),S.official&&(S.official.income.salary=(S.official.income.salary||0)+s.salary)):console.log(`[OFFICIAL DEBUG] ${s.name}: NO SALARY! officialsPaid=${ke}, salary=${s.salary}, wealth=${y}`);const D=((Ae=ce.official)==null?void 0:Ae.needs)||{food:1.2,cloth:.2},P=((Ue=ce.official)==null?void 0:Ue.luxuryNeeds)||{};let G=0,$=0,V=0;const Z={},le=(ne,yt,No=!1)=>{var ri,ln;if(!ne||yt<=0)return;const zt=qe[ne];if(zt!=null&&zt.unlockTech&&!C.includes(zt.unlockTech)||zt&&typeof zt.unlockEpoch=="number"&&zt.unlockEpoch>l||wi&&!wi.has(ne))return;let to=yt*Wn;if(to<=0)return;const si=((ri=_.resourceWaste)==null?void 0:ri[ne])||0;si!==0&&(to*=1+si);const Wi=I[ne]||0,ho=yi[ne]||0,Po=Wi+ho;Po!==0&&(to*=1+Po);const Ho=W.official||0,Ri=bi.official||0,Bi=Ho+Ri;Bi!==0&&(to*=1+Bi);const Ro=L[ne]||0;if(Nt(ne)){const mo=qt(ne),Si=ei(ne),ji=mo*(1+Si),un=ji>0?Math.min(to,y/ji):to,go=Math.min(to,Ro,un);if(go<=0)return;L[ne]=Ro-go,Re[ne]=(Re[ne]||0)-go,Gt[ne]=(Gt[ne]||0)+go;const Ii=go*mo,xo=Ii*Si;let oo=Ii;if(xo<0){const vo=Math.abs(xo);(L.silver||0)>=vo?(L.silver-=vo,ze.subsidy+=vo,oo-=vo,oi+=vo,S.official&&(S.official.income.subsidy=(S.official.income.subsidy||0)+vo)):M%20===0&&Oe.push(`国库空虚，无法为 官员 支付 ${((ln=qe[ne])==null?void 0:ln.name)||ne} 消费补贴！`)}else xo>0&&(ze.industryTax+=xo,oo+=xo);if(y=Math.max(0,y-oo),G+=oo,No?$+=oo:V+=oo,Z[ne]||(Z[ne]={amount:0,cost:0,tax:0,luxuryCost:0,essentialCost:0}),Z[ne].amount+=go,Z[ne].cost+=oo,Z[ne].tax+=xo,No?Z[ne].luxuryCost+=oo:Z[ne].essentialCost+=oo,ee.official||(ee.official={}),ee.official[ne]=(ee.official[ne]||0)+go,S.official){const vo={cost:oo,quantity:go,price:mo},Yo=No?"luxuryNeeds":"essentialNeeds";S.official.expense[Yo]=S.official.expense[Yo]||{};const v=S.official.expense[Yo][ne];v&&typeof v=="object"?(v.cost+=oo,v.quantity+=go):S.official.expense[Yo][ne]=vo,xo>0&&(S.official.expense.transactionTax=(S.official.expense.transactionTax||0)+xo)}}else{const mo=Math.min(to,Ro);mo>0&&(L[ne]=Ro-mo,Z[ne]||(Z[ne]={amount:0,cost:0,tax:0,luxuryCost:0,essentialCost:0}),Z[ne].amount+=mo)}};Object.entries(D).forEach(([ne,yt])=>{le(ne,yt,!1)});const re=y/400,me=Math.min(re,1e9);if(me>=1&&P){const ne=Math.max(1,Math.min(y/400,1e9)),yt=1+Math.log10(ne)*1.6,No=Math.min(100,Number.isFinite(yt)?yt:1),zt=Math.max(1,Math.min((s.salary||0)/400,1e9)),to=1+Math.log10(zt)*1.2,si=Math.min(8,Number.isFinite(to)?to:1);Object.keys(P).map(Number).filter(ho=>ho<=me).sort((ho,Po)=>Po-ho).forEach(ho=>{const Po=P[ho];Po&&Object.entries(Po).forEach(([Ho,Ri])=>{le(Ho,Ri*No*si,!0)})})}const lt=y,Ke=So("official"),et=((Ve=ce.official)==null?void 0:Ve.headTaxBase)*Ke*Oo;let it=0;if(et!==0)if(et>0){const ne=Math.min(y,et);it=ne,y=Math.max(0,y-ne),ze.headTax+=ne,Uo.official=(Uo.official||0)+ne,dt.official=(dt.official||0)+ne,S.official&&(S.official.expense.headTax=(S.official.expense.headTax||0)+ne)}else{const ne=Math.abs(et),yt=L.silver||0;yt>=ne&&(L.silver=yt-ne,y+=ne,ze.subsidy+=ne,oi+=ne,S.official&&(S.official.income.subsidy=(S.official.income.subsidy||0)+ne))}const He=y,ht=et;let _e=0;(Pt=s.ownedProperties)!=null&&Pt.length&&s.ownedProperties.forEach(ne=>{const yt=Ec(ne,Sn,p,Tn,eo);yt>0?_e+=yt:yt<0&&(y=Math.max(0,y+yt))}),_e>0&&(y+=_e,oi+=_e,S.official&&(S.official.income.ownerRevenue=(S.official.income.ownerRevenue||0)+_e));const Ne=y,se=(s.salary||0)+_e,Pe=Cc({...s,wealth:y},G,se),ge=Number.isFinite(s.baseSalary)?s.baseSalary:s.salary||0,de=ge>0?(s.salary||0)/ge:1;let Ye="satisfied";de<.4?Ye="desperate":de<.7?Ye="struggling":de<.95&&(Ye="uncomfortable");const De=["satisfied","uncomfortable","struggling","desperate"];let st;if(Pe==="satisfied")st="satisfied";else{const ne=Math.max(De.indexOf(Pe),De.indexOf(Ye));st=De[ne]||Pe}const Fe=Tc({...s,wealth:y},M,Sn,p,z,eo,ue,l,C),Se=Array.isArray(s.ownedProperties)?[...s.ownedProperties]:[],$e={...s.investmentProfile};if(Fe&&y>=Fe.cost){y=Math.max(0,y-Fe.cost);const ne=`${Fe.buildingId}_off_${s.id}_${M}_${Math.floor(Math.random()*1e3)}`;Se.push({buildingId:Fe.buildingId,instanceId:ne,purchaseDay:M,purchaseCost:Fe.cost,level:0}),$e.lastInvestmentDay=M,eo[Fe.buildingId]=(eo[Fe.buildingId]||0)+1,Oe.push(`🧾 官员${s.name}投资了 ${Fe.buildingId}（花费 ${Math.ceil(Fe.cost)} 银）`)}const Te=kc({...s,wealth:y,ownedProperties:Se,investmentProfile:$e},M,Sn,p,z,eo,ye,ue);if(Te&&y>=Te.cost){y=Math.max(0,y-Te.cost);const ne=Se[Te.propertyIndex];ne&&(ne.level=Te.toLevel,$e.lastUpgradeDay=M,Bn.push({buildingId:Te.buildingId,fromLevel:Te.fromLevel,toLevel:Te.toLevel,officialName:s.name,cost:Te.cost}))}const Tt=y,_t=(Fe==null?void 0:Fe.cost)||0,kt=(Te==null?void 0:Te.cost)||0;_i+=y,Fa+=G;let Me=(Jt=s.loyalty)!=null?Jt:75,je=(Bt=s.lowLoyaltyDays)!=null?Bt:0;const rt=typeof s.politicalStance=="string"?s.politicalStance:(ai=s.politicalStance)==null?void 0:ai.stanceId,Ut=s.stanceConditionParams||[],Je=Object.values(Ht||{}).reduce((ne,yt)=>ne+(yt||0),0),mt={...Ze,official:ke?(s.salary||0)+(s.lastDayPropertyIncome||0):0},gt={classApproval:Ot,classInfluence:Ht,classIncome:mt,totalInfluence:Je,stability:(Q!=null?Q:50)/100,rulingCoalition:Ee,legitimacy:N!=null?N:0,taxPolicies:p,prices:F,epoch:l,population:n?Object.values(n).reduce((ne,yt)=>ne+(yt||0),0):0,atWar:(A||[]).some(ne=>ne.isAtWar)},co=na(rt,gt,Ut),{DAILY_CHANGES:nt,COUP_THRESHOLD:Vt,MAX:Rt,MIN:Et}=Di;Me+=co?nt.stanceSatisfied:nt.stanceUnsatisfied,st==="satisfied"?Me+=nt.financialSatisfied:st==="uncomfortable"?Me+=nt.financialUncomfortable:st==="struggling"?Me+=nt.financialStruggling:st==="desperate"&&(Me+=nt.financialDesperate);const wt=(Q!=null?Q:50)/100;return wt>.7?Me+=nt.stabilityHigh:wt<.3&&(Me+=nt.stabilityLow),Me+=ke?nt.salaryPaid:nt.salaryUnpaid,Me=Math.max(Et,Math.min(Rt,Me)),Me<Vt?je+=1:je=0,{...s,wealth:Math.min(h,Number.isFinite(y)?Math.max(0,y):400),lastDayExpense:G,financialSatisfaction:st,ownedProperties:Se,investmentProfile:$e,lastDayPropertyIncome:_e,lastDayExpenseBreakdown:Z,lastDayLuxuryExpense:$,lastDayEssentialExpense:V,loyalty:Me,lowLoyaltyDays:je,isStanceSatisfied:co,_debug:{initialWealth:E,salaryPaid:ke,salaryAmount:s.salary||0,wealthAfterSalary:E+(ke&&s.salary||0),dailyExpense:G,wealthAfterGoods:lt,headTaxPlanned:ht,headTaxPaid:it,wealthAfterTax:He,propertyIncome:_e,wealthAfterProperty:Ne,investmentCost:_t,upgradeCost:kt,wealthAfterInvestment:Tt,wealthFinal:y}}});pe.official=_i,dt.official=(dt.official||0)+Fa;const en=kr({popStructure:{...Y,official:0},wealth:pe,classIncome:Ze,classExpense:dt,classShortages:ao,epoch:l,techsUnlocked:C,priceMap:qt,livingStandardStreaks:fe}),$a=ii.length;if($a>0){const t=_i/$a;let s="赤贫",h=30;t>300?(s="奢华",h=95):t>100?(s="富裕",h=85):t>50?(s="小康",h=75):t>20?(s="温饱",h=60):(s="贫困",h=45);const m=t/400,y={奢华:{icon:"Crown",color:"text-purple-400"},富裕:{icon:"Gem",color:"text-blue-400"},小康:{icon:"Home",color:"text-green-400"},温饱:{icon:"UtensilsCrossed",color:"text-yellow-400"},贫困:{icon:"AlertTriangle",color:"text-orange-400"},赤贫:{icon:"Skull",color:"text-red-500"}},E=y[s]||y.赤贫;en.classLivingStandard.official={level:s,satisfaction:1,satisfactionRate:1,approvalCap:h,needsMet:1,wealthRatio:m,wealthPerCapita:t,wealthMultiplier:Math.min(6,1+Math.log(Math.max(1,t/100))*.5),icon:E.icon,color:E.color,bgColor:E.color.replace("text-","bg-").replace("-400","-900/20"),borderColor:E.color.replace("text-","border-").replace("-400","-500/30"),score:t>300?90:t>100?75:t>50?60:t>20?45:25};const D=fe.official||{},P=D.level===s;en.livingStandardStreaks.official={level:s,streak:P?(D.streak||0)+1:1}}const ni=en.classLivingStandard,Ga=en.livingStandardStreaks,qa={};Object.keys(ce).forEach(t=>{var gt,co,nt,Vt,Rt,Et,wt;const s=Y[t]||0;if(s===0)return;const h=Vo[t],m=(gt=h==null?void 0:h.satisfactionRatio)!=null?gt:1,y=ni[t];let E=(co=y==null?void 0:y.approvalCap)!=null?co:100;const D=Nr(t,Ee);if(D){const Ae=(y==null?void 0:y.level)||"温饱",Ue=Fr(Ae);E=Math.max(0,E-Ue)}let P=70;const G=y==null?void 0:y.level;G==="奢华"?P=95:G==="富裕"?P=85:G==="小康"&&(P=75),D&&_.coalitionApproval&&(P+=_.coalitionApproval);const $=So(t);(Vt=(nt=ce[t])==null?void 0:nt.headTaxBase)!=null;const V=Math.max(0,(Uo[t]||0)/Math.max(1,s)),Z=(Ze[t]||0)/Math.max(1,s),le=(pe[t]||0)/Math.max(1,s),re=Z>.001&&V>Z*.5,me=le>V*100;re&&!me?P=Math.min(P,40):$<.6&&(P+=5);const lt=(Uo[t]||0)/Math.max(1,s),Ke=le>.01?lt/le:0,Be=.05,it=Ke>Be&&lt>0?Math.min(25,(Ke-Be)/(.2-Be)*25):0,He=Xe[t]||0,Ne=Math.max(0,He*(1-.03)+it*.5);qa[t]=Ne;const se=Math.max(it,Ne),Pe=ao[t]||[],ge=Pe.filter(Ae=>Ae.isBasic),de=Pe.filter(Ae=>!Ae.isBasic),Ye=(Rt=h==null?void 0:h.totalTrackedNeeds)!=null?Rt:0;if(ge.length>0&&Ye>0&&(ge.length>=Object.keys(((Et=ce[t])==null?void 0:Et.needs)||{}).length?P=Math.min(P,0):P=Math.min(P,30)),de.length>0){const Ae=Math.min(15,de.length*3);P-=Ae}const De=Ga[t]||{};if(De.level==="赤贫"||De.level==="贫困"){const Ae=De.level==="赤贫"?2.5:1.5,Ue=Math.min(30,Math.ceil((De.streak||0)*Ae));Ue>0&&(P-=Ue)}let st=0;const Fe=(B||{})[t];if(Fe&&Fe.length>0){let Ve=0;for(let Pt=Fe.length-1;Pt>=0&&Ve<20&&Fe[Pt]>=.95;Pt--)Ve+=1;Ve>=3&&(st=Math.min(15,Ve*.6),P=Math.min(100,P+st))}let Se=0,$e=0;const Te=(q||{})[t];if(Te&&Te.length>=20){const Ae=Te.slice(-10).reduce((Ve,Pt)=>Ve+Pt,0)/10,Ue=Te.slice(-20,-10).reduce((Ve,Pt)=>Ve+Pt,0)/10;Ue>1&&(Se=(Ae-Ue)/Ue,$e=Math.min(15,Math.abs(Se)*50),Se>.05?P+=$e:Se<-.05&&(P-=$e))}if(m>=.98&&(P=Math.min(100,P+10)),t==="unemployed"){const Ue=2+s/Math.max(1,i)*30;P-=Ue}if(ft[t]={baseTarget:0,livingStandardBase:0,taxReliefBonus:0,luxuryShortagePenalty:0,povertyPenalty:0,sustainedNeedsBonus:0,wealthTrendBonus:0,positiveSatisfactionBonus:0,unemployedPenalty:0,eventBonus:0,decreeBonus:0,officialTargetBonus:0,legitimacyPenalty:0,taxShockPenalty:0,shockCapApplied:null,currentApprovalStart:0,targetApprovalPreShockCap:0,targetApprovalFinal:0,adjustmentSpeed:.02,inertiaDelta:0,effectiveApprovalCap:E,capApplied:null,approvalAfterCap:0,approvalFinal:0},ft[t].baseTarget=70,ft[t].livingStandardBase=P-70,$<.6&&(ft[t].taxReliefBonus=5),((de==null?void 0:de.length)||0)>0&&(ft[t].luxuryShortagePenalty=-Math.min(15,de.length*3)),(De==null?void 0:De.level)==="赤贫"||(De==null?void 0:De.level)==="贫困"){const Ae=De.level==="赤贫"?2.5:1.5,Ue=Math.min(30,Math.ceil((De.streak||0)*Ae));ft[t].povertyPenalty=-Ue}if(st&&(ft[t].sustainedNeedsBonus=st),$e&&Se&&Math.abs(Se)>.05&&(ft[t].wealthTrendBonus=Se>0?$e:-$e),m>=.98&&(ft[t].positiveSatisfactionBonus=10),t==="unemployed"){const Ue=2+s/Math.max(1,i)*30;ft[t].unemployedPenalty=-Ue}const Tt=(O==null?void 0:O[t])||0;Tt&&(P+=Tt,ft[t].eventBonus=Tt);const _t=S0[t]||0;_t&&(P+=_t,ft[t].decreeBonus=_t);const kt=((wt=at==null?void 0:at.approval)==null?void 0:wt[t])||0;kt>0&&(P+=kt,ft[t].officialTargetBonus=kt);const Me=Lr(N);Me<0&&(P+=Me,ft[t].legitimacyPenalty=Me);let je=E;kt<0&&(je=Math.max(0,E+kt)),ft[t].effectiveApprovalCap=je;let rt=Ot[t]||50;if(ft[t].currentApprovalStart=rt,ft[t].adjustmentSpeed=.02,se>1&&(rt=Math.max(0,rt-se),ft[t].taxShockPenalty=-se,se>5)){const Ae=Math.max(25,70-se*2);ft[t].shockCapApplied=Ae,P=Math.min(P,Ae)}ft[t].targetApprovalPreShockCap=P,ft[t].targetApprovalFinal=P;let Je=rt+(P-rt)*.02;ft[t].inertiaDelta=Je-rt;const mt=Je;Je=Math.min(Je,je),Je!==mt&&(ft[t].capApplied=je),ft[t].approvalAfterCap=Je,ft[t].approvalFinal=Math.max(0,Math.min(100,Je)),Ot[t]=Math.max(0,Math.min(100,Je))}),(Y.unemployed||0)===0&&f.unemployed!==void 0&&(Ot.unemployed=Math.min(100,f.unemployed+5));let so=i,tn=0;Object.keys(ce).forEach(t=>{const s=pe[t]||0,h=Y[t]||0;if(s>0&&h>0){const m=ni[t],y=m==null?void 0:m.level;if(y==="赤贫"||y==="贫困"||y==="温饱")return;const E=s/h;if(E/ca<1.2&&y!=="奢华")return;let P=.005;y==="小康"?P=.001:y==="富裕"&&(P=.003);const $=E*P*h;let V=parseFloat($.toFixed(2)),Z=0;S[t]&&S[t].expense&&S[t].expense.luxuryNeeds&&Object.values(S[t].expense.luxuryNeeds).forEach(re=>{Z+=re.cost||0});const le=parseFloat((Z*.5).toFixed(2));V=Math.min(V,le),V>0&&(pe[t]=Math.max(0,s-V),dt[t]=(dt[t]||0)+V,S[t]&&(S[t].expense.decay=(S[t].expense.decay||0)+V))}}),Object.keys(ce).forEach(t=>{Yt[t]=qo(pe[t]||0)});let Do=Object.values(Yt).reduce((t,s)=>t+s,0);Object.keys(ce).forEach(t=>{const s=Y[t]||0;if(s===0)return;const h=ce[t],m=Yt[t]||0,y=Do>0?m/Do:0;Ht[t]=h.influenceBase*s+y*10});const I0=Object.values(Ht).reduce((t,s)=>t+s,0),O0=Sc(be||[],ke,{classInfluence:Ht,totalInfluence:I0,polityEffects:Vi,currentDay:M});Object.entries(O0).forEach(([t,s])=>{Ht[t]!==void 0&&s>0&&(Ht[t]+=s)});let Lo=Object.values(Ht).reduce((t,s)=>t+s,0);const D0=Ir(Ee,Ht,Lo);vi=Or(D0),_.legitimacyBonus&&(vi=Math.max(0,Math.min(100,vi*(1+_.legitimacyBonus)))),Pn=Ma(vi);let jn=0;_.factionConflict&&(jn+=_.factionConflict),Object.keys(ce).forEach(t=>{var E;const s=Y[t]||0;if(s===0)return;const h=Ot[t]||50;if(h>=25)return;const m=Lo>0?(Ht[t]||0)/Lo:0,y=((E=ce[t])==null?void 0:E.name)||t;if(h<20&&m<.07){const D=Math.max(.03,(20-h)/200),P=Math.min(s,Math.max(1,Math.floor(s*D)));if(P>0){const V=pe[t]||0,le=(s>0?V/s:0)*P;le>0&&(pe[t]=Math.max(0,V-le)),Y[t]=Math.max(0,s-P)}const G=(ao[t]||[]).map(V=>{var me;const Z=typeof V=="string"?V:V.resource,le=typeof V=="string"?"outOfStock":V.reason,re=((me=qe[Z])==null?void 0:me.name)||Z;return le==="unaffordable"?`${re}(买不起)`:le==="outOfStock"?`${re}(缺货)`:le==="both"?`${re}(缺货且买不起)`:re}).join("、"),$=G?`，短缺资源：${G}`:"";Oe.push(`${y} 阶层对政局失望，${P} 人离开了国家，带走了 ${(P*(pe[t]||0)/Math.max(1,s)).toFixed(1)} 银币${$}。`)}else if(m>=.12){const D=Math.min(.2,.05+m*.15);jn+=D;const P=(ao[t]||[]).map($=>{var re;const V=typeof $=="string"?$:$.resource,Z=typeof $=="string"?"outOfStock":$.reason,le=((re=qe[V])==null?void 0:re.name)||V;return Z==="unaffordable"?`${le}(买不起)`:Z==="outOfStock"?`${le}(缺货)`:Z==="both"?`${le}(缺货且买不起)`:le}).join("、"),G=P?`（短缺：${P}）`:"";Oe.push(`${y} 阶层的愤怒正在削弱社会稳定${G}。`)}});const In=[],On=[];Object.keys(ce).forEach(t=>{var G,$;const s=ce[t];if(!s.buffs||(Y[t]||0)===0)return;const h=Ot[t]||50,m=(($=(G=Vo[t])==null?void 0:G.satisfactionRatio)!=null?$:1)>=.9,y=Lo>0?(Ht[t]||0)/Lo:0,E=y>.8?2:y>.5?1.5:1,D=h>=85&&y>=.3,P=h>=85&&m;if((D||P)&&s.buffs.satisfied){const V=hn(s.buffs.satisfied,E);In.push({class:t,...V})}else if(h<40&&s.buffs.dissatisfied&&y>=.3){const V=hn(s.buffs.dissatisfied,E);On.push({class:t,...V})}});const{stabilityValue:Ua,efficiency:Dn}=cc({popStructure:Y,classApproval:Ot,classInfluence:Ht,totalInfluence:Lo,newActiveBuffs:In,newActiveDebuffs:On,eventStabilityModifier:U,extraStabilityPenalty:jn,currentStability:Q,stabilityBonus:_.stabilityBonus||0}),Ei=l;let on=0;const Ln=Math.max(5,i||5),Pi=Math.max(100,(ms=(hs=L.silver)!=null?hs:e==null?void 0:e.silver)!=null?ms:0);let nn=-1/0;(A||[]).forEach(t=>{t.lastPeaceRequestDay&&t.lastPeaceRequestDay>nn&&(nn=t.lastPeaceRequestDay)});let po=(A||[]).map(t=>{var P,G,$,V,Z,le,re,me,lt,Ke;const s={...t};if(!(Ei>=((P=t.appearEpoch)!=null?P:0)&&(t.expireEpoch==null||Ei<=t.expireEpoch)))return s.isAtWar&&(s.isAtWar=!1,s.warDuration=0,s.warScore=0,s.warStartDay=void 0,Oe.push(`🕊️ 随着时代变迁，与 ${s.name} 的战争已成为历史。`)),s;if(s.isRebelNation){if(s0(s),s.isAtWar){const Be=Oc({nation:s,tick:M,epoch:l,resources:L,population:i,army:w,logs:Oe});tn+=Be.raidPopulationLoss}return Dc({nation:s,tick:M,logs:Oe}),s}s.foreignPower={...s.foreignPower||{}};const m=s.foreignPower,y=s.wealthTemplate||s.wealth||800;m.baseRating==null&&(m.baseRating=Math.max(.4,y/800));const E=Math.min(.9,Math.max(.1,($=(G=m.volatility)!=null?G:s.marketVolatility)!=null?$:.3));if(m.volatility=E,m.appearEpoch==null&&(m.appearEpoch=(V=s.appearEpoch)!=null?V:0),m.populationFactor==null){const Be=(Z=s.culturalTraits)!=null&&Z.agriculturalFocus?1.15:1;m.populationFactor=vt(m.baseRating*Be,.6,2.5)}if(m.wealthFactor==null){const Be=1+Math.max(0,m.appearEpoch)*.05;m.wealthFactor=vt(m.baseRating*Be,.5,3.5)}if(!m.initializedAtTick){const et=1+Math.max(0,Ei-((le=m.appearEpoch)!=null?le:0))*.08,it=.9+Math.random()*.25,He=vt(m.populationFactor*et*it,.6,2.5),ht=vt(m.wealthFactor*et*it,.5,3.5),_e=Math.max(3,Math.round(Ln*He)),Ne=Math.max(100,Math.round(Pi*ht));s.population=_e,s.wealth=Ne,s.budget=Math.max(50,Ne*.5),s.economyTraits={...s.economyTraits||{},basePopulation:_e,baseWealth:Ne},m.populationFactor=He,m.wealthFactor=ht,m.initializedAtTick=M,m.playerSnapshot={population:Ln,wealth:Pi},s.wealthTemplate||(s.wealthTemplate=Ne)}if(o0({nation:s,tick:M,gameSpeed:u}),s.isAtWar){s.warDuration=(s.warDuration||0)+1;const Be=(A||[]).filter(He=>He.isAtWar).length||1,et=((Xi==null?void 0:Xi.dailyExpense)||0)/Be;if(s.warTotalExpense=(s.warTotalExpense||0)+et,Ei>=1){const He=Lc({nation:s,tick:M,epoch:l,resources:L,army:w,logs:Oe,difficultyLevel:ue});tn+=He.raidPopulationLoss}Nc({nation:s,tick:M,lastGlobalPeaceRequest:nn,logs:Oe})&&(nn=M),Fc({nation:s,tick:M,population:i,playerWealth:Pi,logs:Oe}),$c({nation:s,tick:M,population:i,playerWealth:Pi,resources:L,logs:Oe})}else s.warDuration&&(s.warDuration=0,s.warTotalExpense=0);(re=s.relation)!=null,t0(s,ue);const D=ma(ue);if(_.diplomaticIncident&&!s.isRebelNation&&!s.isAtWar){const Be=_.diplomaticIncident/30*D.bad;s.relation=Math.min(100,Math.max(0,((me=s.relation)!=null?me:50)-Be))}if(_.diplomaticBonus&&!s.isRebelNation&&!s.isAtWar){const Be=_.diplomaticBonus/30*D.good;s.relation=Math.min(100,Math.max(0,((lt=s.relation)!=null?lt:50)+Be))}return e0(s,Oe),(Ke=s.aggression)!=null,Gc({nation:s,nations:A,tick:M,epoch:Ei,resources:L,stabilityValue:Ua,logs:Oe,difficultyLevel:ue}),on+=c0({nation:s,resources:L,logs:Oe}),r0(s),i0({nation:s,tick:M}),n0({nation:s,tick:M}),a0({nation:s,epoch:l,playerPopulationBaseline:Ln,playerWealthBaseline:Pi,tick:M}),s});po=zc(po),M%30===0&&(po=Hc(po,ue));const Ao=po.filter(t=>{var s;return l>=((s=t.appearEpoch)!=null?s:0)&&(t.expireEpoch==null||l<=t.expireEpoch)&&!t.isRebelNation});Yc(Ao,M,Oe),Jc(Ao,Oe),Xc(Ao),Qc(Ao,M,L,c,Oe,Ie),Zc(Ao,M,l,Oe),Kc(Ao,M,Oe),qc(Ao,M,Oe),Uc(Ao,po,M,Oe),Vc(Ao,po,M,Oe);let Ti=0,ki=Math.max(0,r||0),zo=Math.max(0,_o-so);if(zo>0){const t=Pr(ue);Math.random()<.01&&console.log(`[DEBUG] PopGrowth: diff=${ue}, mult=${t}`);const s=Math.max(0,i||0)*ar*t;if(ki+=s,i<Ni){const m=Math.max(0,(Ni-i)/Ni);ki+=sr*m*t}const h=Math.min(zo,Math.floor(ki));h>0&&(Ti+=h,ki-=h,zo-=h)}if(zo>0&&Object.keys(ce).forEach(t=>{var le;if(zo<=0)return;const s=Y[t]||0;if(s<=0)return;const h=(le=Ot[t])!=null?le:50,m=Math.max(0,(h-25)/75);if(m<=0)return;const y=Yt[t]||0,E=s>0?y/s:0,D=Math.max(.3,Math.min(2,E/ca)),P=nr*m*D*(1+(_.populationGrowthBonus||0));if(P<=0)return;let G=s*P;if(G<=0)return;const $=Math.floor(G);let V=$;const Z=G-$;Math.random()<Z&&(V+=1),!(V<=0)&&(V=Math.min(V,zo),!(V<=0)&&(Ti+=V,zo-=V))}),Ti>0&&(Y.unemployed=(Y.unemployed||0)+Ti,so=Math.min(_o,so+Ti)),(L.food||0)<=0&&(L.food=0,Math.random()>.9&&so>2)){if(so=so-1,(Y.unemployed||0)>0)Y.unemployed=Y.unemployed-1;else{const t=Wt.filter(s=>(Y[s]||0)>0);if(t.length>0){const s=t[Math.floor(Math.random()*t.length)];Y[s]=Math.max(0,(Y[s]||0)-1)}}Oe.push("饥荒导致人口减少！")}if(Object.keys(ce).forEach(t=>{if(t==="official")return;const s=Y[t]||0;if(s===0)return;const h=ce[t];if(!h||!h.needs)return;const m=ao[t]||[],y=m.some(P=>(typeof P=="string"?P:P.resource)==="food"),E=m.some(P=>(typeof P=="string"?P:P.resource)==="cloth"),D=(B||{})[t];if(D&&D.length>=5){const P=D.slice(-5),G=P.reduce(($,V)=>$+V,0)/P.length;if((y||E)&&G<.85){const $=h.name||t;let V=0;G<.5?V=.02+(.5-G)/.5*.08:V=.005+(.85-G)/.35*.015;const Z=Math.max(1,Math.floor(s*V));if(Z>0){Y[t]=Math.max(0,s-Z);const le=y&&E?"食物和布料":y?"食物":"布料";Oe.push(`${$} 阶层因长期缺乏${le}，${Z} 人死亡！`)}}}}),Wt.reduce((t,s)=>t+(Y[s]||0),0)+(Y.unemployed||0),tn>0){let t=tn;if((Y.unemployed||0)>=t)Y.unemployed=Y.unemployed-t;else{const s=Y.unemployed||0;Y.unemployed=0,t-=s;const h=Wt.reduce((m,y)=>m+(Y[y]||0),0);h>0&&t>0&&Wt.forEach(m=>{if(t<=0)return;const y=Y[m]||0;if(y<=0)return;const E=y/h,D=Math.min(y,Math.max(1,Math.floor(E*t)));Y[m]=y-D,t-=D})}}so=Wt.reduce((t,s)=>t+(Y[s]||0),0)+(Y.unemployed||0),so=Math.max(0,Math.floor(so)),Object.keys(L).forEach(t=>{L[t]<0&&(L[t]=0)});const Va={...F},ro={},L0=.35;Object.entries(Io).forEach(([t,s])=>{let h=0;const m=Y[t]||0;if(m>0){const D=Ze[t]||0,P=dt[t]||0;h=(D-P)/m}else s.weightedWage>0&&s.totalSlots>0?h=s.weightedWage/s.totalSlots:h=Kt[t]||0;h=Math.max(0,h);const y=Kt[t]||0,E=y+(h-y)*L0;ro[t]=parseFloat(E.toFixed(2))});const N0=Math.max(0,(gs=so!=null?so:i)!=null?gs:0),an=(xt==null?void 0:xt.market)||{},F0=Math.max(0,(ys=an.supplyDemandWeight)!=null?ys:1),$0=Math.max(0,an.virtualDemandPerPop||0),za=_r(ue),G0=Math.max(.1,((bs=an.inventoryTargetDays)!=null?bs:1.5)*za),q0=Math.max(0,(Ms=an.inventoryPriceImpact)!=null?Ms:.25);Object.keys(qe).forEach(t=>{var Ne,se;if(!Nt(t))return;const s=qe[t],h=(s==null?void 0:s.marketConfig)||{};h.supplyDemandWeight!==void 0&&Math.max(0,h.supplyDemandWeight);const m=h.virtualDemandPerPop!==void 0?Math.max(0,h.virtualDemandPerPop):$0,y=h.inventoryTargetDays!==void 0?Math.max(.1,h.inventoryTargetDays*za):G0;h.inventoryPriceImpact!==void 0&&Math.max(0,h.inventoryPriceImpact),Mo[t];const E=Gt[t]||0,D=m*N0,G=E+D,$=L[t]||0,V=$<=0?.01:G>0?$/G:y,Z=[];let le=0;io.forEach(Pe=>{const ge=eo[Pe.id]||0;if(ge<=0)return;const de=ye[Pe.id]||{};let Ye=0;Object.entries(de).forEach(([st,Fe])=>{const Se=parseInt(st);Number.isFinite(Se)&&Se>0&&Fe>0&&(Ye+=Fe)});const De={0:Math.max(0,ge-Ye)};Object.entries(de).forEach(([st,Fe])=>{const Se=parseInt(st);Number.isFinite(Se)&&Se>0&&Fe>0&&(De[Se]=Fe)}),Object.entries(De).forEach(([st,Fe])=>{var wt,Ae,Ue,Ve,Pt;const Se=parseInt(st),$e=jt(Pe,Se),Te=(wt=$e.output)==null?void 0:wt[t];if(!Te||Te<=0)return;const Tt=Pe.marketConfig||{},_t=Tt.price||(xt==null?void 0:xt.price)||{},kt=Tt.wage||(xt==null?void 0:xt.wage)||{};Fi(Zt,_t);const Me=Fi(Zt,kt);$e.input&&Object.entries($e.input).forEach(([Jt,Bt])=>{!Bt||Bt<=0||(F[Jt]||fo(Jt),ei(Jt))});const je=Pe.owner,rt=$e.jobs||{},Ut=je&&rt[je];Object.keys(rt).length>0&&!Ut&&Object.entries(rt).forEach(([Jt,Bt])=>{!Bt||Bt<=0||ro[Jt]||$t(Jt)}),(Ue=(Ae=Ie==null?void 0:Ie.businessTaxRates)==null?void 0:Ae[Pe.id])!=null,(Ve=Pe.businessTaxBase)!=null,je&&(Me[je]||0)*(rt[je]||0);const Je=V/y;let mt=1;Je<.5?mt=1+(1-Je*2)*5:Je<1?mt=1+(1-Je)*1:Je>2?(mt=.7-(Je-2)*.3,mt=Math.max(.1,mt)):Je>1&&(mt=1-(Je-1)*.3);let nt=fo(t)*mt;const Vt=(Pt=s.minPrice)!=null?Pt:Zo,Rt=s.maxPrice;nt=Math.max(nt,Vt),Rt!==void 0&&(nt=Math.min(nt,Rt));const Et=Te*Fe;le+=Et,Z.push({price:nt,output:Et})})});let re=0;if(le>0&&Z.length>0){let Pe=0;Z.forEach(ge=>{Pe+=ge.price*ge.output}),re=Pe/le}else{const Pe=fo(t),ge=V/y;let de=1;ge<.5?de=1+(1-ge*2)*5:ge<1?de=1+(1-ge)*1:ge>2?(de=.7-(ge-2)*.3,de=Math.max(.1,de)):ge>1&&(de=1-(ge-1)*.3),re=Pe*de;const Ye=(Ne=s.minPrice)!=null?Ne:Zo,De=s.maxPrice;re=Math.max(re,Ye),De!==void 0&&(re=Math.min(re,De))}let me=0;po.forEach(Pe=>{Pe.isAtWar===!0&&me++});let lt=0;po.forEach(Pe=>{!Pe.isPlayer&&Pe.foreignWars&&Object.values(Pe.foreignWars).forEach(ge=>{ge!=null&&ge.isAtWar&&lt++})}),lt=Math.floor(lt/2);const Ke=1+me*.025+lt*.01,Be=re*Ke,et=F[t]||Be,it=et+(Be-et)*.1,He=(se=s.minPrice)!=null?se:Zo,ht=s.maxPrice;let _e=it;_e=Math.max(_e,He),ht!==void 0&&(_e=Math.min(_e,ht)),Va[t]=parseFloat(_e.toFixed(2))});const U0=t=>{const s=(q||{})[t];if(!s||s.length<2)return null;const h=s[s.length-1],m=s[s.length-2],y=Math.max(1,(n==null?void 0:n[t])||0);return(h-m)/y},V0=t=>{const s=zi[t];return!s||s.length===0?!1:s.some(h=>h&&h.availableSlots>0)},z0=(t,s)=>{const h=zi[t];if(!h||h.length===0||s<=0)return null;let m=-1,y=0;for(let G=0;G<h.length;G++){const $=h[G];if(!$)continue;const V=$.availableSlots>=1?Math.floor($.availableSlots):$.availableSlots>0?1:0;V>y&&(y=V,m=G)}if(m===-1||y<=0)return null;const E=h[m],D=Math.min(s,y),P={buildingId:E.buildingId,buildingName:E.buildingName,count:D};return E.availableSlots-=D,E.availableSlots<=0&&h.splice(m,1),P},Ha=(t=[])=>Array.isArray(t)?t.reduce((s,h)=>s+Math.max(0,(h==null?void 0:h.capitalLocked)||0),0):0,H0=Math.max(0,(ws=j==null?void 0:j.lockedCapital)!=null?ws:Ha((j==null?void 0:j.pendingTrades)||[])),Y0=Yt.merchant||0;yn("simulation","[SIMULATION DEBUG] Calling simulateMerchantTrade, policies:",{hasExportTariff:!!Ie.exportTariffMultipliers,hasImportTariff:!!Ie.importTariffMultipliers,merchantPop:(Y==null?void 0:Y.merchant)||0});const Eo=tc({res:L,wealth:pe,popStructure:Y,supply:Mo,demand:Gt,nations:po,tick:M,taxPolicies:Ie,taxBreakdown:ze,getLocalPrice:qt,roleExpense:dt,roleWagePayout:Ze,pendingTrades:j.pendingTrades||[],lastTradeTime:j.lastTradeTime||0,gameSpeed:u,classFinancialData:S,logs:Oe,potentialResources:wi,merchantAssignments:j.merchantAssignments||j.assignments||null,merchantTradePreferences:j.merchantTradePreferences||null}),Ya=Math.max(0,(xs=Eo.lockedCapital)!=null?xs:Ha(Eo.pendingTrades));Eo.lockedCapital=Ya;const J0=Eo.capitalInvestedThisTick||0;"capitalInvestedThisTick"in Eo&&delete Eo.capitalInvestedThisTick;const Ja=Eo.completedTrades||[];if(Ja.length>0){const t={export:{},import:{}},s={};let h=0;Ja.forEach(y=>{var G;const E=y.resource;t[y.type][E]||(t[y.type][E]={amount:0,profit:0}),t[y.type][E].amount+=y.amount,t[y.type][E].profit+=y.profit,h+=y.profit;const D=y.partnerId||"unknown";if(!s[D]){const $=po.find(V=>(V==null?void 0:V.id)===D);s[D]={name:($==null?void 0:$.name)||D,exports:[],imports:[]}}const P=((G=qe[E])==null?void 0:G.name)||E;y.type==="export"?s[D].exports.push(`${P}x${y.amount.toFixed(1)}`):s[D].imports.push(`${P}x${y.amount.toFixed(1)}`)});const m=[];if(Object.values(s).forEach(y=>{const E=[];y.exports.length>0&&E.push(`出口${y.exports.join(",")}`),y.imports.length>0&&E.push(`进口${y.imports.join(",")}`),E.length>0&&m.push(`${y.name}(${E.join(", ")})`)}),m.length>0){const y=h>=0?`盈利${h.toFixed(1)}`:`亏损${Math.abs(h).toFixed(1)}`;Oe.push(`🛒 商人贸易完成: ${m.join("; ")}，${y}银币`)}if(_.tradeBonusMod&&h>0){const y=h*_.tradeBonusMod;pe.merchant=(pe.merchant||0)+y,S!=null&&S.merchant&&(S.merchant.income.ownerRevenue=(S.merchant.income.ownerRevenue||0)+y)}}"completedTrades"in Eo&&delete Eo.completedTrades;const Xa={};Wt.forEach(t=>{Xa[t]=Math.max(0,(wo[t]||0)-(Y[t]||0))});const X0=t=>t==="merchant"?(Yt.merchant||0)+Ya:Yt[t]||0,Q0=t=>t==="merchant"?((d==null?void 0:d.merchant)||0)+H0:(d==null?void 0:d[t])||0,Z0=t=>{var $,V,Z;let h=0,m=0,y=0,E=0;io.forEach(le=>{var et,it,He,ht,_e,Ne,se,Pe,ge,de;const re=eo[le.id]||0;if(re<=0)return;const me=jt(le,0),lt=me.jobs||{},Ke=lt[t]||0;if(Ke<=0)return;if(le.owner===t){let Ye=0;me.output&&Object.entries(me.output).forEach(([Me,je])=>{if(!je||je<=0||!qe[Me])return;const rt=F[Me]||fo(Me);Ye+=je*rt});let De=0;me.input&&Object.entries(me.input).forEach(([Me,je])=>{if(!je||je<=0)return;const rt=F[Me]||fo(Me);De+=je*rt});let st=0;Object.entries(lt).forEach(([Me,je])=>{var Ut,Je,mt;if(Me===t||!je||je<=0)return;const rt=(mt=(Je=ro==null?void 0:ro[Me])!=null?Je:(Ut=c==null?void 0:c.wages)==null?void 0:Ut[Me])!=null?mt:$t(Me);st+=rt*je});const Se=((it=(et=ce[t])==null?void 0:et.headTaxBase)!=null?it:.01)*So(t)*Oo,$e=(He=le.businessTaxBase)!=null?He:.1,Te=(_e=(ht=Ie==null?void 0:Ie.businessTaxRates)==null?void 0:ht[le.id])!=null?_e:1,Tt=$e*Te,_t=Ye-De-st-Se-Tt,kt=Ke>0?_t/Ke:0;h+=kt*Ke*re,m+=Ke*re}else{const Ye=(Pe=(se=ro==null?void 0:ro[t])!=null?se:(Ne=c==null?void 0:c.wages)==null?void 0:Ne[t])!=null?Pe:$t(t),st=((de=(ge=ce[t])==null?void 0:ge.headTaxBase)!=null?de:.01)*So(t)*Oo,Fe=Ye-st;y+=Fe*Ke*re,E+=Ke*re}});const D=m+E;if(D<=0)return((Z=(V=ro==null?void 0:ro[t])!=null?V:($=c==null?void 0:c.wages)==null?void 0:$[t])!=null?Z:$t(t))*1.2;const G=(h+y)/D;return Math.max(0,G*1.2)},sn=Wt.map(t=>{var Ne,se;const s=Y[t]||0,h=X0(t),m=Q0(t),y=h-m,E=s>0?h/s:0,D=s>0?y/s:0,P=Ze[t]||0,G=dt[t]||0,$=t==="merchant"?J0:0,Z=(P-G+$)/Math.max(1,s),le=ro[t]||$t(t),me=((se=(Ne=ce[t])==null?void 0:Ne.headTaxBase)!=null?se:.01)*So(t)*Oo,lt=le-me,Ke=U0(t),Be=t==="merchant"?Z:D,et=Ke!==null?Ke:Be,it=Z!==0?Z:lt;let He;s===0?He=Z0(t):t==="merchant"||et!==0?He=t==="merchant"?it:et:He=it;const ht=E>0?E*.002:0,_e=He+ht;return{role:t,pop:s,perCap:E,perCapDelta:Be,potentialIncome:_e,vacancy:Xa[t]||0}}).filter(t=>t.role!=="official"),rn=sn.reduce((t,s)=>s.pop>0?t+s.pop:t,0);rn>0&&sn.reduce((t,s)=>t+s.potentialIncome*s.pop,0)/rn,rn>0&&sn.reduce((t,s)=>t+s.perCap*s.pop,0)/rn;const Qa={};Object.keys(qe).forEach(t=>{const s=Mo[t]||0,h=Gt[t]||0;Qa[t]=h>0?s/h:s>0?999:1});const Wo={};io.forEach(t=>{if((eo[t.id]||0)<=0)return;const h=jt(t,0),m=h.output||{},y=h.jobs||{},E=Object.keys(m).filter(D=>qe[D]);E.length!==0&&(Object.keys(y).forEach(D=>{Wo[D]||(Wo[D]=[]),E.forEach(P=>{Wo[D].includes(P)||Wo[D].push(P)})}),t.owner&&!Wo[t.owner]&&(Wo[t.owner]=[]),t.owner&&E.forEach(D=>{Wo[t.owner].includes(D)||Wo[t.owner].push(D)}))});const Nn=ac({popStructure:Y,wealth:pe,roleMetrics:sn,hasBuildingVacancyForRole:V0,reserveBuildingVacancyForRole:z0,logs:Oe,migrationCooldowns:K,supplyDemandRatio:Qa,roleProducesResource:Wo});Object.assign(Y,Nn.popStructure),Object.assign(pe,Nn.wealth);const K0=Nn.migrationCooldowns;v0(),Object.keys(ce).forEach(t=>{Yt[t]=Math.max(0,pe[t]||0)}),Do=Object.values(Yt).reduce((t,s)=>t+s,0),Object.keys(ce).forEach(t=>{var s;if(t!=="official"&&ni[t]){const h=Y[t]||0,m=Yt[t]||0,y=((s=ce[t])==null?void 0:s.startingWealth)||100,E=h>0?m/h:0;ni[t].wealthPerCapita=E,ni[t].wealthRatio=y>0?E/y:0}});const Za=Math.max(0,pe.merchant||0);if(Za-Y0!==0){const t=ce.merchant;if(t){const s=Y.merchant||0,h=t.influenceBase*s+(Do>0?Za/Do*10:0),m=h-(Ht.merchant||0);Ht.merchant=h,Lo+=m}}const Mt={...ye},el=1.5,tl=.02;io.forEach(t=>{var Z,le,re;const s=t.id,h=eo[s]||0;if(h<=0)return;const m=qn(s);if(m<=0)return;const y=t.owner;if(!y||y==="state")return;const E=Y[y]||0;if(E<=0)return;const D=pe[y]||0,P=D/E,G=Mt[s]||{};let $=0;for(const[,me]of Object.entries(G))typeof me=="number"&&me>0&&($+=me);const V=h-$;for(let me=0;me<m;me++){if((me===0?V:G[me]||0)<=0)continue;const Ke=Un(s,me+1,0);if(!Ke)continue;let Be=0;for(const[_e,Ne]of Object.entries(Ke))if(_e==="silver")Be+=Ne;else{const se=F[_e]||1;Be+=Ne*se}if(P<el*Be||Math.random()>tl||!Object.entries(Ke).every(([_e,Ne])=>_e==="silver"?!0:(L[_e]||0)>=Ne)||D<Be)continue;Object.entries(Ke).forEach(([_e,Ne])=>{_e!=="silver"&&(L[_e]=Math.max(0,(L[_e]||0)-Ne))}),pe[y]=Math.max(0,D-Be),Mt[s]||(Mt[s]={}),me>0&&(Mt[s][me]=Math.max(0,(Mt[s][me]||0)-1),Mt[s][me]<=0&&delete Mt[s][me]);const it=me+1;Mt[s][it]=(Mt[s][it]||0)+1,Object.keys(Mt[s]).length===0&&delete Mt[s];const He=((Z=ce[y])==null?void 0:Z.name)||y,ht=((re=(le=Oi[s])==null?void 0:le[me])==null?void 0:re.name)||`等级${it}`;Oe.push(`🏗️ ${He}自发投资了自己的产业 ${t.name} → ${ht}（花费 ${Math.ceil(Be)} 银币）`);break}}),Bn.length>0&&Bn.forEach(t=>{const{buildingId:s,fromLevel:h,toLevel:m,officialName:y,cost:E}=t;Mt[s]||(Mt[s]={}),h>0&&(Mt[s][h]=Math.max(0,(Mt[s][h]||0)-1),Mt[s][h]<=0&&delete Mt[s][h]),Mt[s][m]=(Mt[s][m]||0)+1,Object.keys(Mt[s]).length===0&&delete Mt[s],Oe.push(`🏗️ 官员${y}升级了 ${s}（花费 ${Math.ceil(E)} 银）`)}),Object.keys(ce).forEach(t=>{Yt[t]=Math.max(0,pe[t]||0)}),Do=Object.values(Yt).reduce((t,s)=>t+s,0);const ol=Dn*(1+(_.taxEfficiencyBonus||0)-(_.corruption||0)),Ai=Math.max(0,Math.min(1,ol)),Ka=ze.headTax*Ai,es=ze.industryTax*Ai,ts=ze.businessTax*Ai,os=(ze.tariff||0)*Ai,il=ze.headTax+ze.industryTax+ze.businessTax+(ze.tariff||0),nl=Math.max(0,Math.min(1,Dn*(1+(_.taxEfficiencyBonus||0)))),Fn=Math.max(0,il*(nl-Ai));if(Fn>0&&ii.length>0){const t=ke?1:.5,s=ii.map(E=>{var G,$,V;const D=(((G=E.effects)==null?void 0:G.corruption)||0)+((($=E.drawbacks)==null?void 0:$.corruption)||0),P=((V=xn[E.financialSatisfaction])==null?void 0:V.corruption)||0;return Math.max(0,(D+P)*t)}),h=s.reduce((E,D)=>E+D,0),m=Fn/ii.length;let y=0;ii.forEach((E,D)=>{const P=h>0?Fn*(s[D]/h):m;P<=0||(E.wealth=Math.max(0,(E.wealth||0)+P),y+=P)}),y>0&&(_i+=y,pe.official=_i,Yt.official=Math.max(0,pe.official),Do=Object.values(Yt).reduce((E,D)=>E+D,0),oi+=y,S.official&&(S.official.income.corruption=(S.official.income.corruption||0)+y))}const is=ze.tariffSubsidy||0,ns=Ka+es+ts+os,al=ns+on,sl=Math.max(0,1+M0),as=al*sl;L.silver=(L.silver||0)+as,Re.silver=(Re.silver||0)+as,ze.policyIncome=qi,ze.policyExpense=Ui;const cn=ze.priceControlIncome||0,ss=ze.priceControlExpense||0;L.silver=(L.silver||0)+cn,Re.silver=(Re.silver||0)+cn;const rl={total:ns-ze.subsidy-is+on+qi-Ui+cn-ss,efficiency:Dn,breakdown:{headTax:Ka,industryTax:es,businessTax:ts,tariff:os,tariffSubsidy:is,subsidy:ze.subsidy,warIndemnity:on,policyIncome:qi,policyExpense:Ui,priceControlIncome:cn,priceControlExpense:ss,_debug_tariffPolicies:{hasExport:!!Ie.exportTariffMultipliers,hasImport:!!Ie.importTariffMultipliers,rawTariff:ze.tariff||0}}};return Ze.official=oi||0,ao&&(ao.official=[]),{resources:L,rates:Re,popStructure:Y,maxPop:_o,militaryCapacity:Ra,population:so,birthAccumulator:ki,classApproval:Ot,approvalBreakdown:ft,classInfluence:Ht,classWealth:Yt,classLivingStandard:ni,totalInfluence:Lo,totalWealth:Do,activeBuffs:In,activeDebuffs:On,stability:Ua,legitimacy:vi,legitimacyTaxModifier:Pn,logs:Oe,market:{prices:Va,demand:Gt,supply:Mo,wages:ro,needsShortages:ao,stratumConsumption:ee,supplyBreakdown:oe,demandBreakdown:gi},classIncome:Ze,classExpense:dt,jobFill:Hi,jobsAvailable:wo,taxes:rl,classFinancialData:S,buildingFinancialData:ot,buildingDebugData:It,dailyMilitaryExpense:Xi,needsShortages:ao,needsReport:Vo,livingStandardStreaks:Ga,nations:po,merchantState:Eo,buildingUpgrades:Mt,migrationCooldowns:K0,taxShock:qa,modifiers:{resourceDemand:{...yi,...Object.fromEntries(Object.entries(I).map(([t,s])=>[t,(yi[t]||0)+s]))},stratumDemand:{...bi,...Object.fromEntries(Object.entries(W).map(([t,s])=>[t,(bi[t]||0)+s]))},resourceSupply:vn,buildingProduction:{...$i,...ae},categoryProduction:Gi,sources:{decreeResourceDemand:yi,decreeStratumDemand:bi,decreeResourceSupply:vn,eventResourceDemand:I,eventStratumDemand:W,eventBuildingProduction:ae,techBuildingBonus:$i,techCategoryBonus:Gi,productionBonus:_n,industryBonus:En,militaryBonus:_.militaryBonus,stratumWealthMultiplier:Qi,productionInputCost:(()=>{const t={},s=_.officialProductionInputCost||{},h=_.stanceProductionInputCost||{};return new Set([...Object.keys(s),...Object.keys(h)]).forEach(y=>{t[y]=(s[y]||0)+(h[y]||0)}),t})()},officialEffects:{buildingCostMod:_.buildingCostMod||0,militaryUpkeepMod:_.militaryUpkeepMod||0,taxEfficiencyBonus:_.taxEfficiencyBonus||0,corruption:_.corruption||0,populationGrowthBonus:_.populationGrowthBonus||0,tradeBonusMod:_.tradeBonusMod||0,organizationGrowthMod:_.organizationGrowthMod||0,wartimeProduction:_.wartimeProduction||0,resourceWaste:_.resourceWaste||{},coalitionApproval:_.coalitionApproval||0,legitimacyBonus:_.legitimacyBonus||0,factionConflict:_.factionConflict||0,diplomaticCooldown:_.diplomaticCooldown||0,diplomaticIncident:_.diplomaticIncident||0}},army:w,officials:ii,effectiveOfficialCapacity:Wc(l,Vi||{},C),buildings:eo,_debug:{freeMarket:j0}}};self.onmessage=function(e){const{type:o,payload:i}=e.data;if(o==="SIMULATE")try{const n=l0(i);self.postMessage({type:"RESULT",payload:n})}catch(n){self.postMessage({type:"ERROR",error:n.message||"Unknown simulation error"})}else o==="PING"&&self.postMessage({type:"PONG"})},self.postMessage({type:"READY"})})();
