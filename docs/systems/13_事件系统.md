# 事件系统 - 详尽规则书

> **核心代码**:
> - 事件工具: `src/config/events/eventUtils.js`
> - 事件索引: `src/config/events/index.js`
> - 基础事件: `src/config/events/baseEvents.js`
> - 经济事件: `src/config/events/economicEvents.js`
> - 阶层冲突: `src/config/events/classConflictEvents.js`
> - 时代事件: `src/config/events/epochEvents.js`
> - 外交事件: `src/config/events/diplomaticEvents.js`
> - 叛乱事件: `src/config/events/rebellionEvents.js`

---

# 第一章：事件系统概述

## 1.1 事件分类

游戏事件分为多个类别（`index.js` L56）：

| 类别 | 文件 | 大小 | 说明 |
|-----|-----|-----|-----|
| 基础事件 | baseEvents.js | 125KB | 核心随机事件 |
| 阶层冲突 | classConflictEvents.js | 97KB | 阶层矛盾事件 |
| 时代事件 | epochEvents.js | 208KB | 时代特有事件 |
| 经济事件 | economicEvents.js | 52KB | 经济相关事件 |
| 外交事件 | staticDiplomaticEvents.js | 50KB | 静态外交事件 |
| 动态外交 | diplomaticEvents.js | 77KB | 动态创建事件 |
| 叛乱事件 | rebellionEvents.js | 29KB | 叛乱相关事件 |

## 1.2 事件汇总

事件合并为统一数组：

```javascript
EVENTS = [...BASE_EVENTS, ...CLASS_CONFLICT_EVENTS, 
          ...EPOCH_EVENTS, ...ECONOMIC_EVENTS, 
          ...STATIC_DIPLOMATIC_EVENTS]
```

---

# 第二章：触发条件

## 2.1 条件检查

事件触发条件检查（`eventUtils.js` L10-87）：

### 基础条件

| 条件 | 配置键 | 比较 |
|-----|-------|-----|
| 最低人口 | minPopulation | population ≥ |
| 最低时代 | minEpoch | epoch ≥ |
| 最高时代 | maxEpoch | epoch ≤ |
| 最低科研 | minScience | science ≥ |

### 阶层条件

`classConditions` 支持每个阶层的详细条件（`eventUtils.js` L31-83）：

| 条件 | 配置键 | 说明 |
|-----|-------|-----|
| 人口范围 | minPop/maxPop | 阶层人口数 |
| 满意度范围 | minApproval/maxApproval | 阶层满意度 |
| 影响力占比 | minInfluenceShare/maxInfluenceShare | 影响力占总体比例 |
| 财富值 | minWealth/maxWealth | 阶层财富 |
| 财富占比 | minWealthShare/maxWealthShare | 财富占总体比例 |
| 财富变化 | minWealthDelta/maxWealthDelta | 财富日变化 |
| 收入 | minIncome/maxIncome | 阶层收入 |

---

## 2.2 条件示例

```javascript
// 瘟疫爆发条件
triggerConditions: {
    minPopulation: 80,
    minEpoch: 1,
}

// 矿工不满条件
triggerConditions: {
    minEpoch: 1,
    classConditions: {
        miner: {
            minPop: 12,
            maxApproval: 55,
        },
    },
}

// 商路兴起条件
triggerConditions: {
    minEpoch: 1,
    classConditions: {
        merchant: {
            minPop: 3,
            minInfluenceShare: 0.18,
            minWealthShare: 0.18,
        },
    },
}
```

---

# 第三章：事件结构

## 3.1 基础结构

每个事件包含：

```javascript
{
    id: 'event_id',           // 唯一标识
    name: '事件名称',          // 显示名称
    icon: 'IconName',         // 图标名称
    image: null,              // 可选图片路径
    description: '描述文本',   // 事件描述
    triggerConditions: {},    // 触发条件
    options: []               // 选项列表
}
```

## 3.2 选项结构

每个选项包含：

```javascript
{
    id: 'option_id',          // 选项标识
    text: '选项文本',          // 按钮文本
    description: '描述',       // 选项描述
    effects: {}               // 效果对象
}
```

---

# 第四章：效果类型

## 4.1 资源效果

| 效果键 | 说明 | 示例 |
|-------|-----|-----|
| resourcePercent | 资源百分比变化 | `{food: -0.03}` -3%食物 |
| resource | 资源绝对变化 | `{silver: 100}` +100银币 |

## 4.2 人口效果

| 效果键 | 说明 | 示例 |
|-------|-----|-----|
| populationPercent | 人口百分比变化 | `-0.015` -1.5%人口 |
| populationDelta | 人口绝对变化 | `-10` -10人口 |

## 4.3 稳定度与满意度

| 效果键 | 说明 | 示例 |
|-------|-----|-----|
| stability | 稳定度变化 | `-5` -5稳定度 |
| approval | 阶层满意度变化 | `{peasant: -10}` 农民-10 |

## 4.4 需求修正

| 效果键 | 说明 | 示例 |
|-------|-----|-----|
| resourceDemandMod | 资源需求修正 | `{cloth: 0.2}` 布+20%需求 |
| stratumDemandMod | 阶层需求修正 | `{merchant: 0.15}` 商人活动+15% |

## 4.5 建筑产出修正

| 效果键 | 说明 | 示例 |
|-------|-----|-----|
| buildingProductionMod | 建筑产出修正 | `{farm: -0.3}` 农场-30% |
| buildingProductionMod.all | 全局产出修正 | `{all: -0.25}` 全部-25% |

## 4.6 科研与文化

| 效果键 | 说明 | 示例 |
|-------|-----|-----|
| science | 科研变化 | `0.05` +5%科研 |

---

# 第五章：动态事件

## 5.1 外交事件创建函数

动态创建的外交事件（`diplomaticEvents.js`）：

| 函数 | 说明 |
|-----|-----|
| createWarDeclarationEvent | 宣战事件 |
| createGiftEvent | 礼物事件 |
| createAIRequestEvent | AI请求事件 |
| createEnemyPeaceRequestEvent | 敌方求和 |
| createPlayerPeaceProposalEvent | 玩家求和 |
| createBattleEvent | 战斗事件 |
| createAllianceRequestEvent | 联盟请求 |
| createTreatyProposalEvent | 条约提议 |
| createNationAnnexedEvent | 国家吞并 |
| createIndependenceWarEvent | 独立战争 |
| createVassalRequestEvent | 附庸请求 |
| createBorderIncidentEvent | 边境冲突 |

## 5.2 叛乱事件创建函数

动态创建的叛乱事件（`rebellionEvents.js`）：

| 函数 | 说明 |
|-----|-----|
| createBrewingEvent | 酝酿事件(30%) |
| createPlottingEvent | 密谋事件(70%) |
| createActiveRebellionEvent | 起义事件(100%) |
| createOfficialCoupEvent | 官员政变 |
| createInvestigationResultEvent | 调查结果 |
| createArrestResultEvent | 逮捕结果 |
| createSuppressionResultEvent | 镇压结果 |
| createRebellionEndEvent | 叛乱结束 |

## 5.3 联合叛乱事件

联合叛乱事件（`coalitionRebellion.js`）：

| 函数 | 说明 |
|-----|-----|
| createCoalitionRebelNation | 创建联合叛军 |
| createCoalitionRebellionEvent | 联合叛乱事件 |
| calculateCoalitionPopLoss | 计算人口损失 |

---

# 第六章：事件选择

## 6.1 随机事件选择

随机事件选择逻辑（`eventUtils.js` L190-202）：

```javascript
function getRandomEvent(gameState, events) {
    // 1. 过滤可触发事件
    availableEvents = events.filter(e => canTriggerEvent(e, gameState))
    
    // 2. 随机选择
    if (availableEvents.length === 0): return null
    selectedEvent = availableEvents[random]
    
    // 3. 预解析随机国家
    return resolveRandomNationInEvent(selectedEvent, nations, epoch)
}
```

## 6.2 随机国家解析

事件中的'random'国家选择器预解析（`eventUtils.js` L97-147）：

```javascript
// 过滤可见且时代匹配的国家
visibleNations = nations.filter(n => 
    n.visible !== false &&
    epoch >= (n.appearEpoch ?? 0) &&
    (n.expireEpoch == null || epoch <= n.expireEpoch)
)

// 随机选择一个
randomNation = visibleNations[random]

// 替换效果中的'random'为具体国家ID
if (effects.nationRelation?.random):
    effects.nationRelation[randomNation.id] = effects.nationRelation.random
```

---

# 第七章：典型事件

## 7.1 基础事件示例

| 事件 | 触发条件 | 选项 |
|-----|---------|-----|
| 瘟疫爆发 | 人口≥80, 时代≥1 | 隔离/祈祷/放任 |
| 商队来访 | 时代≥1 | 贸易/征税/拒绝 |
| 丰收之年 | 时代≥0 | 储存/出售/庆典 |
| 技术突破 | 时代≥2, 科研≥100 | 推广/逐步/垄断 |
| 自然灾害 | 人口≥60 | 救援/重建/最低援助 |

## 7.2 阶层冲突事件

| 事件 | 触发条件 | 选项 |
|-----|---------|-----|
| 矿工怨声 | 时代≥1, 矿工≥12, 满意度≤55 | 改善安全/提高待遇/镇压 |
| 商路初兴 | 时代≥1, 商人影响≥18% | 开放贸易/征税/限制 |
| 学者沙龙 | 时代≥2, 科研≥800, 文书影响≥12% | 资助/引导舆论/限制 |
| 庄园施压 | 时代≥2, 地主财富≥25%, 农民满意度≤55 | 授特权/改革/站农民 |
| 骑士炫耀 | 时代≥3, 骑士影响≥15%, 军人满意度≤70 | 比武/赞士兵/限权 |

---

# 第八章：玩法策略

## 8.1 事件应对

| 事件类型 | 策略 |
|---------|-----|
| 自然灾害 | 储备资源应对紧急需求 |
| 阶层冲突 | 平衡各阶层影响力 |
| 经济危机 | 维持财政健康 |
| 外交冲突 | 保持良好关系 |

## 8.2 事件触发控制

| 目标 | 方法 |
|-----|-----|
| 减少负面事件 | 维持高满意度、高稳定度 |
| 触发正面事件 | 满足特定条件（如高科研） |
| 避免阶层冲突 | 平衡各阶层利益 |

---

# 附录A：效果类型速查

| 效果类型 | 键名 | 说明 |
|---------|-----|-----|
| 资源百分比 | resourcePercent | 修改资源库存 |
| 人口百分比 | populationPercent | 修改人口 |
| 稳定度 | stability | 修改稳定度 |
| 满意度 | approval | 修改阶层满意度 |
| 需求修正 | resourceDemandMod | 修改资源需求 |
| 阶层活动 | stratumDemandMod | 修改阶层活动 |
| 建筑产出 | buildingProductionMod | 修改建筑效率 |
| 科研 | science | 修改科研点数 |

---

# 附录B：代码位置索引

| 功能 | 文件 | 行号 |
|-----|-----|-----|
| 事件汇总 | index.js | L56 |
| 条件检查 | eventUtils.js | L10-87 |
| 随机事件选择 | eventUtils.js | L190-202 |
| 随机国家解析 | eventUtils.js | L97-147 |
| 外交事件创建 | diplomaticEvents.js | 全文 |
| 叛乱事件创建 | rebellionEvents.js | 全文 |
| 基础事件定义 | baseEvents.js | 全文 |
| 阶层冲突事件 | classConflictEvents.js | 全文 |
| 时代事件 | epochEvents.js | 全文 |
| 经济事件 | economicEvents.js | 全文 |
