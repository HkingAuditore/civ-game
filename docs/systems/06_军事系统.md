# 军事系统 - 完整机制

> **核心逻辑**: `logic/diplomacy/aiWar.js`, `config/militaryUnits.js`

---

## 1. 战斗系统

### 1.1 战斗模拟 (`militaryUnits.js` simulateBattle)

```javascript
// 战斗力 = Σ(单位数量 × 攻防值 × 时代系数 × buffs)
attackerPower = calculateBattlePower(attackerArmy, epoch, militaryBuffs)
defenderPower = calculateBattlePower(defenderArmy, epoch, militaryBuffs)

// 胜负判定
victory = attackerPower > defenderPower × 0.8

// 损失计算
if (victory):
    attackerLosses = 20-40%
    defenderLosses = 60-80%
else:
    attackerLosses = 50-70%
    defenderLosses = 30-50%
```

### 1.2 克制关系

| 单位类别 | 克制 | 被克制 |
|---------|-----|--------|
| infantry 步兵 | cavalry | archer, gunpowder |
| archer 弓箭 | infantry | cavalry |
| cavalry 骑兵 | archer, gunpowder | infantry |
| gunpowder 火器 | infantry, cavalry | - |
| siege 攻城 | 建筑 | 所有单位 |

克制关系提供**1.2-1.3倍**伤害加成。

### 1.3 淘汰机制

```javascript
obsoleteAfterEpochs = 2  // 典型值

if (currentEpoch - unitEpoch > obsoleteAfterEpochs):
    effectiveness *= 0.25  // 惩罚至75%
```

---

## 2. AI突袭

### 2.1 突袭概率 (`aiWar.js` L63-65)

```javascript
raidChance = min(0.35, 0.25 + aggression × 0.1)
```

### 2.2 突袭类型 (`aiWar.js` L301-356)

| 类型 | 条件 | 损失倍率 | 战分变化 |
|-----|-----|---------|----------|
| raid 边境掠夺 | 基础 | 1.0x | ±8 |
| assault 正面攻势 | 优势>10 | 1.5x | ±15 |
| siege 围城 | 优势>30 | 2.0x | ±25 |
| scorched_earth 焦土 | 高侵略性 | 1.8x | ±18 |
| naval_raid 海劫 | 海洋国家 | 1.2x | ±12 |

### 2.3 无防御损失 (`aiWar.js` L90-95)

```javascript
if (totalDefenders === 0):
    foodLoss = food × raidStrength
    silverLoss = silver × (raidStrength / 2)
    popLoss = min(5, max(1, raidStrength × 25))
```

---

## 3. 战争分数

### 3.1 分数变化

- 玩家防守成功: +6~20
- 玩家防守失败: -8~25
- 不同行动类型有不同分值

### 3.2 求和/投降触发

| 场景 | 战分条件 | 持续天数 | 概率 |
|-----|---------|---------|------|
| AI求和 | warScore>12 | - | 与战分正相关 |
| AI投降需求 | AI优势>25 | >30天 | 3% |
| 叛军投降 | 玩家优势>30 | >20天 | 5% |

### 3.3 怜悯和平 (`aiWar.js` L644-726)

玩家处于绝境时AI可能无条件议和：

```javascript
isDesperateSituation = 
    population < 20 ||
    (wealth < 50 && silver < 30 && pop < 50) ||
    (resources < 100 && wealth < 50)

mercyChance = min(0.5, 0.05 + warDuration/500 + desperationFactor×0.3 - aggression×0.15)
```

---

## 4. 宣战条件

### 4.1 宣战概率 (`aiWar.js` L778-789)

```javascript
hostility = max(0, (50 - relation) / 70)
unrest = stability < 35 ? 0.02 : 0

declarationChance = min(0.08, 
    aggression × 0.04 + 
    hostility × 0.025 + 
    unrest + 
    aggressionBonus
) × warCountPenalty
```

### 4.2 限制条件

- 需达到最低时代（默认epoch≥1）
- 不能有和平条约
- 不能是盟友
- 关系<25
- 同时战争数<MAX_CONCURRENT_WARS

---

## 5. 难度修正

| 修正项 | 简单 | 普通 | 困难 |
|-------|------|------|------|
| 宣战概率 | ×0.5 | ×1.0 | ×1.5 |
| 军事行动概率 | ×0.7 | ×1.0 | ×1.3 |
| 突袭伤害 | ×0.7 | ×1.0 | ×1.3 |
| 人口损失 | ×0.5 | ×1.0 | ×1.5 |
| 战争最低时代 | epoch≥2 | epoch≥1 | epoch≥1 |

---

## 6. 玩法策略

### 6.1 防御

- 保持一定军队防止突袭成功
- 高防御力单位更适合防守
- 无军队时突袭100%成功

### 6.2 外交

- 关系≥25时不会被宣战
- 低稳定度增加被攻击概率
- 盟友不会宣战

### 6.3 战时

- 快速积累正战分可迫使AI求和
- 负战分过多AI会提出投降要求
- 极端困境时等待怜悯和平
