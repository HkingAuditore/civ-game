# 军事系统 - 详尽规则书

> **核心代码**:
> - 兵种配置: `src/config/militaryUnits.js`
> - 军事行动: `src/config/militaryActions.js`
> - AI战争: `src/logic/diplomacy/aiWar.js`
> - 军事工具: `src/logic/diplomacy/militaryUtils.js`

---

# 第一章：兵种系统

## 1.1 兵种类别

游戏共有5种兵种类别（`militaryUnits.js` L702-709）：

| 类别 | 中文名 | 克制 | 被克制 |
|-----|-------|-----|-------|
| infantry | 步兵 | 骑兵 | 弓箭手/火器 |
| archer | 弓箭手 | 步兵 | 骑兵 |
| cavalry | 骑兵 | 弓箭手/火器 | 步兵 |
| gunpowder | 火器 | 步兵/骑兵 | 骑兵(近战) |
| siege | 攻城 | - | 所有类别 |

---

## 1.2 兵种属性

每个兵种包含以下属性（`militaryUnits.js` L17-45）：

| 属性 | 说明 |
|-----|-----|
| attack | 攻击力 |
| defense | 防御力 |
| speed | 速度 |
| range | 射程 |
| epoch | 解锁时代 |
| recruitCost | 招募成本（资源） |
| maintenanceCost | 每日维护费（资源） |
| trainingTime | 训练天数 |
| populationCost | 消耗人口数 |
| abilities | 特殊能力列表 |
| counters | 克制关系（类别→乘数） |
| weakAgainst | 弱势对象 |
| obsoleteAfterEpochs | 过时时代数（超过后不再显示） |

---

## 1.3 时代兵种列表

### 石器时代（Epoch 0）

| 兵种 | 类别 | 攻/防 | 招募成本 | 过时 |
|-----|-----|------|---------|-----|
| militia（民兵） | 步兵 | 6/4 | 125粮+60木 | +2时代 |
| slinger（投石兵） | 弓箭 | 6/2 | 150粮+75木+25石 | +2时代 |

### 青铜时代（Epoch 1）

| 兵种 | 类别 | 攻/防 | 招募成本 | 过时 |
|-----|-----|------|---------|-----|
| spearman（长矛兵） | 步兵 | 12/9 | 275粮+175木+60铜 | +2时代 |
| archer（弓箭手） | 弓箭 | 14/6 | 325粮+225木+125银 | +2时代 |
| chariot（战车） | 骑兵 | 15/8 | 500粮+300木+150铜+200银 | +2时代 |

### 古典时代（Epoch 2）

| 兵种 | 类别 | 攻/防 | 招募成本 | 过时 |
|-----|-----|------|---------|-----|
| hoplite（重装步兵） | 步兵 | 16/14 | 500粮+200铜+100铁+250银 | +2时代 |
| composite_archer（复合弓手） | 弓箭 | 18/7 | 425粮+250木+125铜+225银 | +2时代 |
| light_cavalry（轻骑兵） | 骑兵 | 18/8 | 600粮+300银+125铁 | +2时代 |
| battering_ram（攻城槌） | 攻城 | 30/15 | 750粮+1000木+250铁+400银 | +2时代 |

### 封建时代（Epoch 3）

| 兵种 | 类别 | 攻/防 | 招募成本 | 过时 |
|-----|-----|------|---------|-----|
| heavy_infantry（重甲步兵） | 步兵 | 20/18 | 700粮+300铁+400银 | +2时代 |
| crossbowman（弩兵） | 弓箭 | 22/9 | 550粮+350木+225铁+275银 | +2时代 |
| knight（骑士） | 骑兵 | 28/22 | 1250粮+500铁+150铜+800银 | +2时代 |
| trebuchet（投石机） | 攻城 | 45/8 | 1000粮+1000木+400板材+400铁+750银 | +2时代 |

### 探索时代（Epoch 4）

| 兵种 | 类别 | 攻/防 | 招募成本 | 过时 |
|-----|-----|------|---------|-----|
| pikeman（长枪兵） | 步兵 | 22/20 | 800粮+300木+350铁+450银 | +2时代 |
| arquebus（火绳枪手） | 火器 | 28/8 | 700粮+300铁+200工具+80铜+500银 | +2时代 |
| cuirassier（胸甲骑兵） | 骑兵 | 32/24 | 1500粮+600铁+1000银 | +2时代 |
| bombard（射石炮） | 攻城 | 55/10 | 1250粮+600铁+250铜+350工具+1000银 | +2时代 |

### 启蒙时代（Epoch 5）

| 兵种 | 类别 | 攻/防 | 招募成本 | 过时 |
|-----|-----|------|---------|-----|
| musketeer（刺刀火枪兵） | 步兵 | 30/14 | 900粮+350铁+250工具+550银 | +2时代 |
| rifleman（线膛枪手） | 火器 | 35/10 | 1000粮+400铁+300工具+650银 | +2时代 |
| dragoon（龙骑兵） | 骑兵 | 35/18 | 1400粮+450铁+225工具+900银 | +2时代 |
| cannon（野战炮） | 攻城 | 60/12 | 1500粮+700铁+300铜+450工具+1250银 | +2时代 |

### 工业时代（Epoch 6）

| 兵种 | 类别 | 攻/防 | 招募成本 | 过时 |
|-----|-----|------|---------|-----|
| line_infantry（线列步兵） | 步兵 | 40/20 | 1250粮+150钢+200工具+800银 | +3时代 |
| gatling（加特林机枪组） | 火器 | 50/12 | 1500粮+300钢+350工具+200煤+1250银 | +3时代 |
| lancer（枪骑兵） | 骑兵 | 38/20 | 1600粮+120钢+180工具+1000银 | +3时代 |
| artillery（重型火炮） | 攻城 | 80/15 | 2000粮+500钢+400煤+300工具+1750银 | +3时代 |

---

## 1.4 克制关系详解

克制系数作为战斗力乘数（`militaryUnits.js` L41-43, L96-97等）：

| 攻击方→防御方 | 克制系数 | 说明 |
|-------------|---------|-----|
| 步兵→骑兵 | ×1.6~2.0 | 长矛/刺刀阵克制骑兵冲锋 |
| 步兵→攻城 | ×1.2~1.5 | 近战突袭攻城器械 |
| 弓箭→步兵 | ×1.4~1.7 | 远程火力压制 |
| 弓箭→攻城 | ×1.3~1.5 | 射击操作人员 |
| 骑兵→弓箭 | ×1.6~1.9 | 快速追杀远程单位 |
| 骑兵→火器 | ×1.5~1.7 | 近身突袭火器阵地 |
| 火器→步兵 | ×1.5~2.0 | 火力优势 |
| 火器→骑兵 | ×1.4~1.8 | 齐射压制 |

---

## 1.5 特殊能力加成

能力对战斗力的加成（`militaryUnits.js` L931-950）：

### 攻击加成

| 能力 | 加成 |
|-----|-----|
| 范围伤害 | +12% |
| 压制火力 | +10% |
| 攻城 | +8% |
| 精确打击 | +8% |
| 穿甲 | +6% |
| 火器 | +6% |
| 冲锋 | +6% |
| 齐射 | +5% |
| 远程攻击 | +5% |
| 机动 | +4% |
| 快速移动 | +4% |
| 侦察 | +3% |

### 防御加成

| 能力 | 加成 |
|-----|-----|
| 坚守 | +8% |
| 方阵 | +8% |
| 盾墙 | +8% |

---

## 1.6 时代淘汰机制

兵种在超过其解锁时代+`obsoleteAfterEpochs`后不再显示（`militaryUnits.js` L12-14）：

```javascript
// 兵种可用条件
unit.epoch <= 当前时代 && (当前时代 - unit.epoch) <= obsoleteAfterEpochs

// 时代淘汰惩罚
if (时代差 > obsoleteAfterEpochs):
    惩罚 = min(0.75, (时代差 - obsoleteAfterEpochs) × 0.25)
    战斗力 *= (1 - 惩罚)
```

---

# 第二章：战斗力计算

## 2.1 基础战斗力公式

单位战斗力计算（`militaryUnits.js` L732-777）：

```javascript
单位战斗力 = (攻击力 + 防御力) × 数量 × 时代系数 × (1 + 军事buff) × 军饷乘数

// 时代系数
if (时代差 > 0 && 时代差 <= 过时阈值):
    时代系数 = 1 + 时代差 × 0.05  // 每高一时代+5%

// 军饷乘数（士兵工资影响士气）
基准工资 = 50
工资比例 = max(0, (士兵工资 - 50) / 50)
军饷乘数 = min(1.5, 1 + 工资比例 × 0.5)  // 上限+50%
```

---

## 2.2 综合战斗概况

战斗模拟中的战力计算（`militaryUnits.js` L1086-1098）：

```javascript
每单位攻击力 = 基础攻击 
            × (1 + 射程加成 + 速度加成 + 攻击能力加成 + 情境修正)
            × (1 + 军事buff)
            × 克制乘数

每单位防御力 = 基础防御
            × (1 + 速度加成×0.5 + 防御能力加成 + 情境修正)
            × 防御乘数(防守方1.2)
            × (1 + 军事buff)

// 射程加成
射程加成 = min(0.3, 射程 × 0.03)

// 速度加成
速度加成 = min(0.2, 速度 × 0.02)
```

---

## 2.3 战斗模拟流程

战斗模拟（`militaryUnits.js` L1253-1383）：

```javascript
// 1. 构建战斗概况
攻击方战斗力 = 总攻击×0.65 + 总防御×0.35
防守方战斗力 = 总攻击×0.65 + 总防御×0.35

// 2. 应用随机波动（±10%）
战斗力 *= 0.9 + random() × 0.2

// 3. 判定胜负
攻击方优势 = 攻击方战斗力 / (攻击方战斗力 + 防守方战斗力)
胜利 = 攻击方优势 > 0.5
压倒性胜利 = abs(攻击方优势 - 0.5) > 0.28
```

---

## 2.4 伤亡计算

伤亡计算逻辑（`militaryUnits.js` L1171-1249）：

```javascript
// 伤害缩放
相对战力 = 敌方战斗力 / (敌方战斗力 + 己方战斗力)
伤害缩放 = 0.12 × 相对战力^0.9

// 胜利方伤害减少
if (胜利): 伤害缩放 *= 0.75
if (压倒性胜利): 伤害缩放 *= (胜利 ? 0.6 : 1.1)

// 劣势方全灭机制
if (!胜利 && 战力比 >= 3):
    if (random() < 全灭概率):
        全军覆没

// 优势方伤亡上限
if (胜利 && 战力比 >= 3):
    最大损失 = sqrt(敌方兵力) × (战力比系数)
```

---

# 第三章：军事行动

## 3.1 行动类型

5种军事行动（`militaryActions.js` L129-370）：

| 行动 | 难度 | 冷却 | 敌军派遣比 | 解锁科技 |
|-----|-----|-----|----------|---------|
| raid（边境掠夺） | 易 | 15天 | 5-15% | - |
| assault（正面攻势） | 中 | 24天 | 30-70% | bronze_working |
| siege（围城压制） | 难 | 36天 | 30-70% | fortification |
| naval_raid（海上劫掠） | 中 | 18天 | 30-70% | sailing |
| scorched_earth（焦土战术） | 难 | 30天 | 35-55% | military_training |

---

## 3.2 战分变化

战斗胜负对战分的影响（`aiWar.js` L389-395）：

| 行动类型 | 胜利战分 | 失败战分 |
|---------|---------|---------|
| raid | -8 | +6 |
| assault | -15 | +12 |
| siege | -25 | +20 |
| naval_raid | -12 | +10 |
| scorched_earth | -18 | +15 |

> **正战分**：玩家优势，可求和获得赔款  
> **负战分**：敌方优势，可能被迫求和

---

## 3.3 战利品配置

边境掠夺战利品（`militaryActions.js` L144-162）：

| 资源 | 敌方财富% | 基础最小值 | 硬性上限 |
|-----|---------|----------|---------|
| food | 5.4% | 75 | 240000 |
| wood | 3.6% | 45 | 150000 |
| stone | 2.4% | 24 | 90000 |
| silver | 6.6% | 120 | 60000 |
| copper | 2.4% | 15 | 24000 |

正面攻势战利品更为丰厚，围城压制可获得最多资源（包括science/culture）。

---

## 3.4 战利品计算

战利品计算公式（`militaryActions.js` L63-127）：

```javascript
// 1. 基于敌方财富
敌方基础 = 敌方财富 × 资源百分比

// 2. 基于玩家资源（对数缩放防止爆炸）
对数缩放 = 玩家资源 > 1000 ? log10(玩家资源) / 6 : 玩家资源 / 1000
玩家缩放 = 基础最小值 × (1 + 对数缩放 × 2)

// 3. 取较小值
原始战利品 = max(基础最小值, min(敌方基础, 玩家缩放))

// 4. 应用硬性上限
最终战利品 = min(原始战利品, 硬性上限)
```

---

# 第四章：AI战争行为

## 4.1 宣战条件

AI宣战检查（`aiWar.js` L739-800）：

```javascript
// 必要条件
!正在交战 && !和平条约 && !正式盟友 && 关系 < 25 && 当前战争数 < 上限

// 宣战概率
敌意 = max(0, (50 - 关系) / 70)
动荡加成 = 稳定度 < 35 ? 0.02 : 0
侵略加成 = 侵略性 > 0.5 ? 侵略性 × 0.03 : 0

宣战概率 = min(0.08, 侵略性×0.04 + 敌意×0.025 + 动荡加成 + 侵略加成)
宣战概率 *= 难度修正 × 战争计数惩罚
```

---

## 4.2 AI军事行动

AI选择行动类型（`aiWar.js` L301-356）：

```javascript
// 高军力+高侵略+占优势+后期时代 → 围城/正面攻势/焦土
if (军力>0.7 && 侵略>0.5 && AI优势>30 && 时代>=2):
    25%围城, 35%正面攻势, 15%焦土

// 中等军力+占优势 → 正面攻势/海战
if (军力>0.5 && AI优势>10 && 时代>=1):
    35%正面攻势, 15%海战(海洋国家)

// 落后时+高侵略 → 焦土
if (AI优势<-20 && 侵略>0.6):
    30%焦土

// 默认 → 边境掠夺
```

---

## 4.3 AI求和机制

AI请求和平（`aiWar.js` L548-584）：

```javascript
// 条件
战分 > 12 && 冷却完毕 && 全局冷却完毕

// 求和意愿
意愿 = min(0.5, 0.03 + 战分/120 + 战争天数/400) + min(0.15, 敌军损失/500)

// 赔款计算
赔款 = calculateAIPeaceTribute(战分, 敌军损失, 战争天数, 可用财富)
```

---

## 4.4 怜悯和平

当玩家陷入绝境时AI可能主动议和（`aiWar.js` L644-726）：

```javascript
// 绝境判定
人口 < 20 || (财富 < 50 && 银币 < 30 && 人口 < 50) || (总资源 < 100 && 财富 < 50)

// 怜悯意愿
基础概率 = 0.05 + 战争天数/500 + 绝境系数×0.3
侵略惩罚 = 侵略性 × 0.15
怜悯概率 = clamp(基础概率 - 侵略惩罚, 0.1, 0.5)
```

---

# 第五章：叛军战争

## 5.1 叛军突袭

叛军突袭机制（`aiWar.js` L42-150）：

```javascript
// 突袭概率（比AI国家更高）
叛军侵略 = nation.aggression ?? 0.7
突袭概率 = min(0.35, 0.25 + 叛军侵略 × 0.1)

// 突袭强度
突袭强度 = 0.08 + 叛军侵略 × 0.05

// 资源损失（无防守时）
食物损失 = 食物 × 突袭强度
银币损失 = 银币 × (突袭强度 / 2)
人口损失 = min(5, max(1, 突袭强度 × 25))
```

---

## 5.2 叛军投降要求

叛军占优势时的投降要求（`aiWar.js` L152-197）：

```javascript
// 条件
叛军优势 > 50 && 战争天数 > 20 && random() < 0.05

// 三种选项
屠杀人数 = min(max(人口×5%, 战争优势/4, 10), 人口-10)
改革赔款 = max(100, 银币×10%)  // 一次性支付
强制补贴 = 改革赔款×3 ÷ 365  // 每日支付，持续365天
```

---

# 第六章：军队经济

## 6.1 每日维护费

军队维护计算（`militaryUnits.js` L1431-1446）：

```javascript
// 每种单位的每日维护
维护费[资源] = 单位维护成本[资源] × 数量

// 示例：10个骑士
// food: 9×10 = 90/日
// silver: 6.5×10 = 65/日
// iron: 0.8×10 = 8/日
// copper: 0.3×10 = 3/日
```

---

## 6.2 食物需求

军队食物需求（`militaryUnits.js` L720-730）：

```javascript
calculateArmyFoodNeed(army) {
    let total = 0;
    Object.entries(army).forEach(([unitId, count]) => {
        const unit = UNIT_TYPES[unitId];
        const foodNeed = unit.maintenanceCost?.food || 0;
        total += foodNeed * count;
    });
    return total;
}
```

---

## 6.3 AI国家军力

AI国家军队生成（`militaryUnits.js` L805-882）：

```javascript
// 基础军队规模
时代系数 = 1 + 时代 × 0.15
基础规模 = 人口 × 军事强度 × 0.6% × 时代系数

// 兵种分配（根据侵略性）
步兵比例 = 35% + (1-侵略性) × 15%  // 35-50%
远程比例 = 25% + 侵略性 × 10%      // 25-35%
骑兵比例 = 20% + 侵略性 × 10%      // 20-30%
攻城比例 = 5%
```

---

# 第七章：战争情报

## 7.1 军力估算

基于外交关系的军力估算（`militaryUtils.js` L11-61）：

```javascript
// 精度基于关系
精度因子 = max(0.1, 关系 / 100)
误差范围 = 1 - 精度因子

// 估算值
估算战力 = 实际战力 × (1 + 稳定随机 × 误差范围 × 0.5)

// 显示
关系 >= 60: "约 XXX"（绿色）
关系 >= 40: "XXX - YYY"（黄色，±20%范围）
关系 >= 20: "情报不足"（灰色）
关系 < 20: "未知"（灰色）
```

---

# 第八章：玩法策略

## 8.1 兵种配置策略

| 敌方为主 | 推荐兵种 | 原因 |
|---------|---------|-----|
| 步兵 | 火器/弓箭 | 远程克制 |
| 弓箭 | 骑兵 | 快速突袭 |
| 骑兵 | 步兵 | 长矛阵克制 |
| 火器 | 骑兵+步兵 | 骑兵近身+步兵抵挡 |
| 混合 | 均衡配置 | 覆盖各类别 |

## 8.2 军事行动选择

| 目标 | 推荐行动 | 说明 |
|-----|---------|-----|
| 快速获取资源 | 边境掠夺 | 冷却短、风险低 |
| 削弱敌军主力 | 正面攻势 | 高战分变化 |
| 最大化战利品 | 围城压制 | 获取全类型资源 |
| 海洋贸易品 | 海上劫掠 | 香料/咖啡/银币 |
| 破坏敌方经济 | 焦土战术 | 食物/木材损失大 |

## 8.3 战争管理

1. **保持正战分**：战分>12时敌方可能求和
2. **防止多线作战**：同时战争数有上限
3. **关注士兵工资**：高工资→高士气→+50%战斗力
4. **及时更新兵种**：过时兵种战斗力最多降75%
5. **利用怜悯机制**：绝境时AI可能主动停战

---

# 附录A：核心公式速查

| 计算 | 公式 |
|-----|-----|
| 基础战斗力 | (攻击+防御) × 数量 × 时代系数 × 军饷乘数 |
| 军饷乘数 | min(1.5, 1 + (工资-50)/50×0.5) |
| 时代加成 | 1 + 时代差×0.05（未过时） |
| 时代惩罚 | 1 - min(0.75, (时代差-过时阈值)×0.25) |
| 综合战力 | 总攻击×0.65 + 总防御×0.35 |
| 胜负判定 | 攻击方战力/(攻击方+防守方) > 0.5 |
| 压倒性胜利 | abs(优势-0.5) > 0.28 |
| AI军队规模 | 人口×军力×0.6%×(1+时代×0.15) |

---

# 附录B：代码位置索引

| 功能 | 文件 | 行号 |
|-----|-----|-----|
| 兵种定义 | militaryUnits.js | L17-700 |
| 兵种类别 | militaryUnits.js | L702-709 |
| 克制关系 | militaryUnits.js | L711-718 |
| 战斗力计算 | militaryUnits.js | L732-777 |
| AI军队生成 | militaryUnits.js | L805-882 |
| 能力加成表 | militaryUnits.js | L931-955 |
| 战斗模拟 | militaryUnits.js | L1253-1383 |
| 伤亡计算 | militaryUnits.js | L1171-1249 |
| 军队维护费 | militaryUnits.js | L1431-1446 |
| 军事行动配置 | militaryActions.js | L129-370 |
| 战利品计算 | militaryActions.js | L63-127 |
| 硬性上限 | militaryActions.js | L70-100 |
| AI军事行动 | aiWar.js | L251-537 |
| AI宣战 | aiWar.js | L739-800 |
| AI求和 | aiWar.js | L548-584 |
| 怜悯和平 | aiWar.js | L644-726 |
| 叛军突袭 | aiWar.js | L42-150 |
| 军力估算 | militaryUtils.js | L11-61 |
