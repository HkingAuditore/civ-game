# 建筑系统 - 详尽规则书

> **核心代码**:
> - 建筑配置: `config/buildings.js`
> - 升级配置: `config/buildingUpgrades.js`
> - 生产逻辑: `logic/simulation.js` L1350-2200

---

# 第一章：建筑分类

## 1.1 建筑类别

建筑分为四大类别（`cat`属性）：

| 类别 | 说明 | 生产加成来源 |
|-----|-----|------------|
| gather | 采集类（农田、伐木、采矿）| productionBonus |
| industry | 工业类（加工、制造）| industryBonus |
| civic | 民用类（贸易站、图书馆、教堂）| productionBonus |
| military | 军事类（兵营、堡垒）| 免营业税 |

---

## 1.2 建筑属性结构

每个建筑包含以下属性（`buildings.js`）：

```javascript
{
    id: 'farm',                      // 唯一标识
    name: "农田",                     // 显示名称
    desc: "提供自耕农岗位。",           // 描述
    baseCost: { wood: 12 },          // 建造成本
    input: { tools: 0.04 },          // 输入资源（每tick）
    output: { food: 4.8 },           // 输出资源（每tick）
    jobs: { peasant: 3 },            // 岗位配置
    owner: 'peasant',                // 业主阶层
    epoch: 0,                        // 解锁时代
    cat: 'gather',                   // 建筑类别
    requiresTech: 'irrigation',      // 需要科技（可选）
    businessTaxBase: 0.1,            // 营业税基础（默认0.1）
    marketConfig: { ... },           // 市场配置（可选）
}
```

---

## 1.3 业主与岗位

### 业主（Owner）
- 业主投入资金运营建筑
- 业主获得建筑利润
- 业主财富不足时建筑减产

### 岗位（Jobs）
- 建筑提供岗位雇佣工人
- 岗位填充率影响产量
- 工人获得工资

### 自营建筑
当`owner`出现在`jobs`中时，为自营建筑：
```javascript
// 自营建筑示例
{ jobs: { peasant: 3 }, owner: 'peasant' }
// peasant既是业主也是工人，不需要支付工资给自己
```

---

# 第二章：生产乘数计算

## 2.1 乘数计算流程

生产乘数决定实际产量（`simulation.js` L1406-1488）：

```
实际产量 = 基础产量 × 实际乘数 (actualMultiplier)

实际乘数 = 基础乘数 × 资源限制 × 利润边际约束 × 现金流约束
```

---

## 2.2 基础乘数（加成叠加）

基础乘数采用**加法叠加模式**（`simulation.js` L1427-1487）：

```javascript
基础乘数 = (1 + Σ加成百分比)

// 加成来源：
1. 时代加成 - currentEpoch.bonuses.gatherBonus / industryBonus
2. Buff/Debuff加成 - productionBonus / industryBonus
3. 政令加成 - productionBonus / industryBonus
4. 类别加成 - categoryBonuses[cat]
5. 事件加成 - eventBuildingProductionModifiers
6. 科技加成 - buildingBonuses[buildingId]
```

### 实例计算

假设农田（gather类）：
- 时代加成: +10%
- Buff加成: +5%
- 类别加成: +15%

则：
```
基础乘数 = 1 + 0.10 + 0.05 + 0.15 = 1.30
```

---

## 2.3 人员填充率

建筑需要足够的人口来填满岗位：

```javascript
填充率 = 实际填充工人数 / 总岗位数
基础乘数 *= 填充率
```

若岗位只填充50%，产量也只有50%。

---

## 2.4 资源限制

当输入资源不足时，产量按比例下降（`simulation.js` L1613-1635）：

```javascript
对于每种输入资源:
    需求量 = 每乘数需求 × 目标乘数
    可用量 = 当前库存
    资源限制 = min(资源限制, 可用量 / 需求量)

目标乘数 = 基础乘数 × max(0, min(1, 资源限制))
```

### 低效模式

采集类建筑在缺少输入时进入低效模式（`simulation.js` L1643-1655）：

```javascript
if (cat == 'gather' && 资源限制 == 0):
    目标乘数 = 基础乘数 × 0.2  // 20%效率
    输入成本 = 0               // 不消耗原料
```

---

## 2.5 利润边际约束

建筑只在有利润时满负荷运转（`simulation.js` L1721-1735）：

```javascript
预估成本 = 原料成本 + 实际可付工资 + max(0, 营业税)
预估收入 = 产出物市场价值

if (收入 <= 0 && 成本 > 0):
    实际乘数 = 0  // 完全停工
else if (收入 < 成本 × 0.98):
    边际比率 = max(0, min(1, 收入 / 成本))
    实际乘数 = 目标乘数 × 边际比率
```

---

## 2.6 现金流约束

业主财富不足时减产（`simulation.js` L1765-1791）：

```javascript
对于每个业主:
    业主比例 = 该业主建筑数 / 总数
    业主运营成本 = 每乘数运营成本 × 业主比例
    业主可支持乘数 = 业主财富 / 业主运营成本

可负担乘数 = min(所有业主可支持乘数)
实际乘数 = min(实际乘数, 可负担乘数)
```

---

# 第三章：工资机制

## 3.1 工资压力公式

工资压力根据盈利能力动态调整（`simulation.js` L1680-1687）：

```javascript
可用于工资 = max(0, 预估收入 - 原料成本)
工资覆盖率 = 可用于工资 / 基础工资成本

if (覆盖率 >= 1):
    工资压力 = min(3.0, 1 + (覆盖率 - 1) × 0.5)  // 最高3倍
else:
    工资压力 = max(0.65, 1 - (1 - 覆盖率) × 0.5) // 最低65%

实际工资成本 = 基础工资成本 × 工资压力
```

---

## 3.2 可支付工资限制

实际支付工资不能超过可用资金（`simulation.js` L1712-1719）：

```javascript
实际可付工资 = min(预估工资成本, 可用于工资)
```

这防止高工资期望导致产量崩溃的恶性循环。

---

## 3.3 庄园工资模式

封建庄园使用**生存工资模式**（`buildings.js` L70-81）：

```javascript
marketConfig: {
    wage: {
        wageMode: 'subsistence',        // 生存工资模式
        subsistenceMultiplier: 1.5,     // 工资=生存成本×1.5
    }
}
```

佃农不按市场工资支付，而是维持最低生存水平。

---

# 第四章：建筑升级

## 4.1 升级倍率

升级提升产出效率（`buildingUpgrades.js` L1-8）：

| 等级 | 产出倍率 | 说明 |
|-----|---------|-----|
| 基础 | 1.0x | 基础建筑 |
| Lv1 | 1.3x | 效率升级 |
| Lv2 | 2.25x | 规模化升级 |

---

## 4.2 升级配置结构

```javascript
{
    name: "灌溉田",                       // 升级后名称
    cost: { wood: 50, stone: 20, silver: 300 }, // 升级成本
    input: { tools: 0.04, wood: 0.06 },  // 新输入（替代基础）
    output: { food: 6.24 },              // 新产出（替代基础）
    jobs: { peasant: 3 },                // 新岗位（替代基础）
}
```

---

## 4.3 等级分布

一种建筑可以有不同等级的实例（`simulation.js` L1354-1379）：

```javascript
buildingUpgrades[buildingId] = { "1": 2, "2": 1 }
// 表示：2座Lv1，1座Lv2

// 自动计算0级数量
level0Count = 总数 - 已升级数量
```

---

## 4.4 升级效果聚合

多等级建筑的效果会聚合计算：

```javascript
effectiveOps.input = Σ(等级配置.input × 该等级数量)
effectiveOps.output = Σ(等级配置.output × 该等级数量)
effectiveOps.jobs = Σ(等级配置.jobs × 该等级数量)
```

---

# 第五章：市场配置

## 5.1 建筑市场参数

建筑可有独立的价格/工资权重（`buildings.js` marketConfig）：

```javascript
marketConfig: {
    price: {
        livingCostWeight: 0.08,    // 价格受生活成本影响
        taxCostWeight: 0.15,       // 价格受税负影响
    },
    wage: {
        livingCostWeight: 0.08,    // 工资受生活成本影响
        taxCostWeight: 0.05,       // 工资受税负影响
    }
}
```

---

## 5.2 不同类型建筑配置

| 建筑类型 | 价格权重 | 工资权重 | 说明 |
|---------|---------|---------|-----|
| 基础采集 | 0.08-0.12 | 0.05-0.08 | 高稳定性 |
| 工业加工 | 0.20-0.25 | 0.10 | 标准平衡 |
| 奢侈品 | 0.30-0.50 | 0.15-0.25 | 高波动性 |

---

# 第六章：税收影响

## 6.1 原料成本含税

原料采购需要支付资源税（`simulation.js` L1630-1634）：

```javascript
原料成本 = Σ(数量 × 价格 × (1 + 资源税率))
// 负税率（补贴）时成本降低
```

---

## 6.2 营业税

营业税按建筑产量征收（`simulation.js` L1691-1701）：

```javascript
营业税 = 营业税基础 × 税率系数 × 建筑数量 × 乘数

// 免税建筑：
- 军事类建筑 (cat == 'military')
- 住房建筑 (civic + 无owner + 产出maxPop)
```

---

## 6.3 产出不含税

产出按市场价计算，税收发生在消费端：

```javascript
产出价值 = Σ(产出量 × 市场价格)
// 生产者获得净价值，不受消费税/补贴影响
```

---

# 第七章：建筑示例

## 7.1 农田 (farm)

```javascript
{
    id: 'farm',
    output: { food: 4.8 },
    jobs: { peasant: 3 },
    owner: 'peasant',
    cat: 'gather',
    
    // 升级路径
    Lv1: { name: "灌溉田", output: { food: 6.24 } }   // 1.3x
    Lv2: { name: "精耕田", output: { food: 10.8 } }   // 2.25x
}
```

## 7.2 庄园 (large_estate)

```javascript
{
    id: 'large_estate',
    output: { food: 24.0 },
    jobs: { serf: 8, landowner: 1 },
    owner: 'landowner',
    // 佃农工资按生存成本计算，非市场工资
}
```

## 7.3 家具工坊 (furniture_workshop)

```javascript
{
    id: 'furniture_workshop',
    input: { tools: 0.1333, plank: 1.3333, cloth: 0.40 },
    output: { furniture: 1.60 },
    jobs: { artisan: 4 },
    owner: 'artisan',
    // 奢侈品工坊，价格/工资高敏感度
}
```

---

# 第八章：玩法策略

## 8.1 生产优化

1. **最大化加成**：叠加时代+科技+政令加成
2. **保证人口**：确保足够人口填满岗位
3. **供应链**：保障输入资源供应
4. **利润管理**：监控利润边际，调整税率

## 8.2 升级策略

1. **Lv1优先**：低成本高收益（+30%产出）
2. **Lv2大规模**：高投入高回报（+125%产出）
3. **人均效率**：Lv2增加岗位，注意人口

## 8.3 业主管理

1. **监控财富**：业主破产导致建筑停工
2. **税率平衡**：高税降低业主利润
3. **补贴扶持**：负税率补贴困难行业

## 8.4 危机处理

1. **资源短缺**：采集类进入20%低效模式
2. **亏损停产**：利润边际约束导致减产
3. **资金链断裂**：业主财富耗尽导致停工

---

# 附录：关键公式速查

| 公式 | 计算 |
|-----|-----|
| 基础乘数 | 1 + Σ加成% |
| 工资压力（盈利）| min(3.0, 1 + (覆盖率-1)×0.5) |
| 工资压力（亏损）| max(0.65, 1 - (1-覆盖率)×0.5) |
| 边际约束 | max(0, min(1, 收入/成本)) |
| Lv1产出 | 基础 × 1.3 |
| Lv2产出 | 基础 × 2.25 |
