# 叛乱系统 - 完整机制

> **核心逻辑**: `logic/diplomacy/rebellionSystem.js`, `logic/organizationSystem.js`

---

## 1. 系统概述

叛乱系统核心流程：
```
阶层不满 → 组织度积累 → 阶段推进 → 叛乱爆发 → 叛军战争
    ↓
控制措施/妥协要求
```

---

## 2. 组织度系统

### 2.1 阶段定义 (`organizationSystem.js` ORGANIZATION_STAGE)

| 阶段 | 阈值 | 说明 |
|-----|------|-----|
| calm | <20 | 平静，无风险 |
| brewing | <40 | 酝酿中 |
| plotting | <60 | 密谋阶段 |
| organized | <80 | 有组织活动 |
| active | ≥80 | 活跃叛乱 |

### 2.2 组织度增长

```javascript
dailyGrowth = 基础增长 
            + 不满天数修正 
            + 影响力占比修正
            - 稳定度压制
            - 控制措施减益
```

影响因素：
- 阶层满意度<35: 增长加速
- 阶层影响力占比高: 增长加速
- 贫困/赤贫生活水平: 额外加速
- 活跃法令压制: 增长减缓

---

## 3. 叛乱触发

### 3.1 条件 (`rebellionSystem.js` checkRebellionCondition)

```javascript
// 触发条件
approval < 30           // 满意度低于30
dissatisfactionDays >= 30  // 不满持续30天以上
influenceShare >= 0.05  // 影响力占比≥5%
organizationLevel >= 80 // 组织度达到活跃阶段
```

### 3.2 联盟叛乱

当多个阶层同时满足条件时形成联盟叛乱：
- 所有满足条件的阶层联合
- 叛军力量更强
- 妥协代价更高

---

## 4. 叛乱事件

### 4.1 酝酿事件 (brewing)

玩家可选择：
- 忽视：组织度继续增长
- 压制：花费资源降低组织度，可能引发反弹
- 妥协：提前满足部分要求

### 4.2 密谋事件 (plotting)

更严重的警告，开始出现具体要求：
- 改革要求：政策调整
- 财务要求：补贴/减税

### 4.3 活跃叛乱 (active)

爆发叛军：
- 创建叛军国家
- 进入战争状态
- 人口流失到叛军

---

## 5. 叛军战争

### 5.1 叛军特性

叛军比普通AI更激进：
```javascript
rebelAggression = 0.7  // 高侵略性
raidChance = min(0.35, 0.25 + aggression × 0.1)  // 更高突袭概率
```

### 5.2 叛军投降要求 (`aiWar.js` L153-197)

当叛军占优势时提出要求：

| 优势程度 | 主要要求 |
|---------|---------|
| <100 | reform 改革：一次性支付 |
| 100-200 | concession 妥协：每日补贴365天 |
| >200 | massacre 清洗：人口代价 |

### 5.3 玩家选项

1. **接受改革**: 支付银币，阶层财富增加
2. **接受补贴**: 每日支付，持续1年
3. **接受清洗**: 失去人口，但立即结束
4. **继续战斗**: 拒绝所有条件

---

## 6. 官员政变

### 6.1 触发条件 (`officials.js` LOYALTY_CONFIG)

```javascript
COUP_THRESHOLD = 25        // 忠诚度阈值
COUP_DURATION_DAYS = 180   // 需持续天数

// 触发判定
if (loyalty < COUP_THRESHOLD && lowLoyaltyDays >= 180):
    checkCoupTrigger()
```

### 6.2 政变资本

官员需有足够资本才能政变：
```javascript
hasCapital = 
    wealth >= COUP_WEALTH_THRESHOLD ||
    propertyCount >= COUP_PROPERTY_THRESHOLD
```

---

## 7. 玩法策略

### 7.1 预防叛乱

1. **维持满意度>35**: 避免不满积累
2. **控制关键阶层**: 高影响力阶层需重点关注
3. **发展经济**: 改善生活水平从根本解决

### 7.2 应对酝酿

1. 早期妥协代价更小
2. 压制有风险但可能阻止升级
3. 观察组织度增长速度

### 7.3 战时应对

1. 快速击败叛军获得正战分
2. 战分>30时叛军可能投降
3. 如无法取胜可接受妥协条件

### 7.4 官员管理

1. 定期检查忠诚度
2. 高威望+高财产的低忠诚官员最危险
3. 处置前评估政变风险
