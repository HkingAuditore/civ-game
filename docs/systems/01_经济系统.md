# 经济系统 - 详尽规则书

> **核心代码**:
> - 价格计算: `logic/economy/prices.js`
> - 工资计算: `logic/economy/wages.js`
> - 税收计算: `logic/economy/taxes.js`
> - 资源配置: `config/gameConstants.js`
> - 主循环: `logic/simulation.js` L4900-5300

---

# 核心概念：玩家与市场的关系

## 抽象市场模型

**游戏采用抽象市场模型**：资源存在于一个公共的"市场"中，所有参与者（政府、阶层）都只拥有**银币**，通过与市场交互来获取和出售资源。

```
               ┌─────────────────┐
               │   抽象市场      │
               │  (resources)    │
               │  粮食、木材...   │
               └────────┬────────┘
                   ↑    ↓
        ┌──────────┴────┴──────────┐
        │                          │
   建筑生产 ──→ 资源入库      资源出库 ←── 阶层消费
        │                          │
    卖出收银币              购买付银币
        ↓                          ↓
   ┌────────┐                ┌────────┐
   │业主阶层│                │消费阶层│
   │ 银币+  │                │ 银币-  │
   └────────┘                └────────┘
```

---

## 谁拥有什么

| 实体 | 拥有 | 不拥有 |
|-----|-----|-------|
| **政府（玩家）** | 国库银币 | 市场资源、阶层财富 |
| **各阶层** | 阶层银币存款 | 市场资源 |
| **市场** | 所有实物资源 | 银币 |

---

## 市场运作机制

### 资源入库（生产端）
1. 建筑生产资源 → 资源进入市场库存（`resources`对象）
2. 业主阶层获得银币收入（产出价值 - 成本）

### 资源出库（消费端）
1. 阶层根据需求从市场购买资源
2. 阶层支付银币 → 资源从市场库存扣除

### 政府与市场
- 政府**不直接**与市场交易资源
- 政府通过**税收**从阶层获取银币
- 政府通过**补贴**向阶层支付银币
- 政府通过**价格管制**（左派主导）间接影响市场价格

---

## 政府的经济手段

政府通过**间接手段**影响经济：

| 手段 | 机制 | 效果 |
|-----|-----|-----|
| **税收** | 从阶层银币中抽取 | 增加国库，减少民间银币 |
| **补贴** | 负税率向阶层支付 | 减少国库，增加民间银币 |
| **价格管制** | 左派主导时设定官方价格 | 改变市场交易价格 |
| **建筑政策** | 建造/拆除建筑 | 改变市场供给量 |
| **法令** | 颁布政令 | 临时修改经济参数 |

---

## 市场自动运转

市场是**自主运行**的，政府只能观察和调控：

1. **生产**：建筑自动生产资源进入市场
2. **定价**：市场根据供需自动确定价格
3. **消费**：阶层自动从市场购买需求品
4. **工资**：建筑根据利润自动调整工资
5. **人口流动**：劳动力根据工资自动迁移

政府的作用是**引导**经济，而非**控制**经济。

---

# 第一章：资源系统

## 1.1 资源分类

游戏中的资源分为以下几类：

### 基础原材料（Tier 1）
这些资源可以在时代0直接采集，是经济链的起点：

| 资源 | 基础价格 | 默认所有者 | 特点 |
|-----|---------|-----------|-----|
| food（粮食）| 1.0 | peasant | 必需品，价格稳定，库存目标730天 |
| wood（木材）| 2.0 | lumberjack | 建材，库存目标550天 |
| stone（石料）| 3.0 | miner | 建材，库存目标550天 |
| cloth（布料）| 1.5 | worker | 必需品+制成品 |

### 工业资源（Tier 2）
需要加工或特定科技解锁：

| 资源 | 基础价格 | 解锁条件 | 库存目标天数 |
|-----|---------|---------|------------|
| brick（砖块）| 6.0 | pottery科技 | 270天 |
| tools（工具）| 16.0 | tool_making科技 | 300天 |
| plank（木板）| 5.0 | 时代1 + tools科技 | 240天 |
| copper（铜矿）| 5.5 | 时代1 + copper_mining | 300天 |
| iron（铁矿）| 8.0 | 时代2 + ironworking | 500天（战略储备）|

### 奢侈品（Tier 3）
高价商品，价格波动大：

| 资源 | 基础价格 | 特点 |
|-----|---------|-----|
| delicacies（珍馐）| 24 | 需求弹性1.3，库存目标90天 |
| furniture（家具）| 28 | 需求弹性1.2，库存目标120天 |
| ale（美酒）| 18 | 需求弹性1.5，库存目标150天 |
| fine_clothes（华服）| 32 | 需求弹性1.5，库存目标100天 |
| spice（香料）| 26 | 时代4解锁，贸易品 |
| coffee（咖啡）| 24 | 时代5解锁 |

### 特殊资源

| 资源 | 说明 |
|-----|-----|
| silver（银币）| 货币，固定价格1.0，用于财政税收 |
| science（科研）| 政府主导产出，极低波动性 |
| culture（文化）| 文化积累，低波动性 |

---

## 1.2 资源市场参数

每种资源都有独立的市场配置参数（`marketConfig`），这些参数决定了该资源的价格行为：

### 参数说明

```javascript
marketConfig: {
    supplyDemandWeight: 0.4-1.6,    // 供需对价格影响权重
    inventoryTargetDays: 90-730,     // 目标库存天数
    inventoryPriceImpact: 0.15-0.5,  // 库存对价格影响系数
    demandElasticity: 0.2-1.5,       // 需求弹性
    outputVariation: 0.1-0.2,        // 产出浮动±%
}
```

### 参数效果

| 参数 | 低值效果 | 高值效果 |
|-----|---------|---------|
| supplyDemandWeight | 价格稳定（必需品）| 价格敏感（奢侈品）|
| inventoryTargetDays | 低库存紧张（易腐品）| 高库存缓冲（战略物资）|
| inventoryPriceImpact | 库存波动影响小 | 库存波动影响大 |
| demandElasticity | 刚需（价格不影响需求）| 弹性（价格影响需求）|

---

# 第二章：价格机制

## 2.1 价格计算公式

价格采用**三层模型**（`simulation.js` L5151-5189）：

### 第一层：库存天数计算

```javascript
库存天数 = 当前库存 / 日消耗量
库存比率 = 库存天数 / 目标库存天数
```

### 第二层：供需调整系数

```javascript
if (库存比率 < 0.5):       // 紧急短缺
    价格系数 = 1.0 + (1.0 - 库存比率×2) × 5.0   // 最高6倍
else if (库存比率 < 1.0):  // 偏低
    价格系数 = 1.0 + (1.0 - 库存比率) × 1.0     // 1.0-2.0倍
else if (库存比率 > 2.0):  // 严重积压
    价格系数 = 0.7 - (库存比率 - 2.0) × 0.3     // 最低0.1倍
else if (库存比率 > 1.0):  // 充足
    价格系数 = 1.0 - (库存比率 - 1.0) × 0.3     // 0.7-1.0倍
```

### 第三层：最终价格

```javascript
市场价格 = 基础价格 × 价格系数
最终价格 = max(最低价, min(最高价, 市场价格))
```

### 实战案例

假设粮食：
- 基础价格 = 1.0
- 目标库存天数 = 730（2年）
- 当前库存 = 365天消耗量

则：
- 库存比率 = 365 / 730 = 0.5
- 价格系数 = 1.0 + (1.0 - 0.5) × 1.0 = 1.5
- 市场价格 = 1.0 × 1.5 = **1.5银/单位**

---

## 2.2 成本价与利润

建筑的生产成本计算（`simulation.js` L5106-5149）：

```javascript
成本价 = (原材料成本 + 工资成本 + 营业税 + 业主生活成本) / 产出数量

// 其中：
原材料成本 = Σ(输入量 × 输入价格 × (1 + 资源税率))
工资成本 = Σ(工人数 × 对应工资)
营业税 = 营业税基础 × 税率系数
业主生活成本 = 业主生活需求 × 业主人数
```

**关键机制**：当供过于求时，市场价格可能**低于成本价**，导致生产者亏损。这会促使生产者减产或转行，实现市场自我调节。

---

## 2.3 价格平滑

价格变化采用平滑过渡（`prices.js` L248-250）：

```javascript
新价格 = 当前价格 + (目标价格 - 当前价格) × 0.1
```

即每tick只向目标价格移动10%，防止剧烈波动。

---

# 第三章：工资机制

## 3.1 生存成本地板

每个阶层有**生存成本地板**（`wages.js` L81-87），这是工资的最低保障：

```javascript
生存成本地板 = max(BASE_WAGE_REFERENCE × 0.8, 需求成本 × 1.1)

// 其中：
需求成本 = Σ(需求量 × 市场价格) + 税负成本
```

工资不会低于生存成本地板，确保工人能维持基本生活。

---

## 3.2 工资信号计算

工资由市场信号决定（`wages.js` L157-186）：

```javascript
工资信号 = (收入 - 支出) / 人口数

// 如果利润过高（>支出10倍），进行对数抑制：
if (利润率 > 10):
    抑制因子 = min(1, 2 / log10(利润率 + 1))
    工资信号 = 支出 × (1 + 利润率 × 抑制因子)
```

### 工资平滑

```javascript
新工资 = 旧工资 + (工资信号 - 旧工资) × 平滑系数

// 如果工资信号比旧工资高50%以上，平滑系数减半：
if (工资信号 > 旧工资 × 1.5):
    有效平滑系数 = 基础平滑系数 × 0.5
```

这防止工资暴涨导致通货膨胀。

---

## 3.3 建筑工资压力

建筑根据利润调整实际工资（`simulation.js` L1706-1712）：

```javascript
工资覆盖率 = (收入 - 原料成本) / 基础工资成本

if (覆盖率 >= 1):
    工资压力 = min(3.0, 1 + (覆盖率 - 1) × 0.5)  // 最高3倍
else:
    工资压力 = max(0.65, 1 - (1 - 覆盖率) × 0.5) // 最低65%

实际工资 = 基础工资 × 工资压力
```

**玩法意义**：
- 高利润行业吸引更多工人（工资高）
- 低利润行业流失工人（工资低）
- 形成自然的劳动力市场调节

---

# 第四章：税收系统

## 4.1 税收类型

游戏有三种主要税收（`taxes.js`）：

### 人头税（Head Tax）

按阶层人口征收：

```javascript
计划税额 = 人头税基础 × 税率系数 × 税收效率修正 × 人口

// 实际征收不能超过阶层存款
实际税额 = min(计划税额, 阶层存款)

// 负税率 = 补贴（从国库支付给阶层）
```

每个阶层有不同的`headTaxBase`（在`strata.js`定义）。

### 交易税（Industry Tax）

对资源交易征收：

```javascript
交易税 = 交易金额 × 资源税率

// 资源税率可以为负（补贴）
// 负税率时国库支付差额
```

上限：±500%（`TAX_LIMITS.MAX_RESOURCE_TAX = 5.0`）

### 营业税（Business Tax）

对建筑运营征收：

```javascript
营业税 = 营业税基础 × 税率系数 × 产量系数

// 军事类建筑和住房建筑免税
```

---

## 4.2 税收效率

所有税收受效率影响（`taxes.js` L141-163）：

```javascript
净税收 = (人头税 + 交易税 + 营业税 + 关税) × 效率
       - 补贴支出
       + 战争赔款
       + 政策收入 - 政策支出
       + 价格管制收入 - 价格管制支出
```

效率低于100%时，部分税收流失（腐败）。

---

## 4.3 税收冲击（Tax Shock）

高税率会导致阶层不满，游戏计算"税收冲击"惩罚：

```javascript
// 使用税前财富计算，防止"榨干后无惩罚"的漏洞
税收占比 = 实际税额 / 税前财富

// 超过阈值时产生冲击
if (税收占比 > 阈值):
    累积冲击 += 新冲击
    满意度惩罚 = f(累积冲击)
```

---

# 第五章：财富系统

## 5.1 阶层财富来源

每个阶层有独立的财富池（`wealth[stratum]`），来源包括：

| 来源 | 说明 |
|-----|-----|
| 工资收入 | 被建筑雇佣获得 |
| 业主收入 | 拥有建筑时获得利润分成 |
| 补贴收入 | 负税率时从政府获得 |
| 贸易利润 | 商人阶层特有 |

---

## 5.2 财富支出

| 支出 | 说明 |
|-----|-----|
| 需求消费 | 购买基础需求和奢侈品 |
| 人头税 | 向政府缴纳 |
| 交易税 | 购买资源时的额外成本 |
| 生产成本 | 业主支付原料和工资 |

---

## 5.3 财富衰减

为防止无限积累，财富每日衰减（`gameConstants.js` L17）：

```javascript
WEALTH_DECAY_RATE = 0.005  // 每日0.5%衰减

每日衰减 = 当前财富 × 0.005
```

这模拟了生活消费和维护成本。

---

## 5.4 建筑收入分配

建筑产出收入分配给业主（`simulation.js` L1683-1698）：

```javascript
// 产出价值
产出价值 = Σ(产出量 × 市场价格)

// 业主获得：产出价值 - 运营成本
// 如果亏损，从业主财富扣除（现金流约束）
```

---

# 第六章：商人贸易

## 6.1 商人阶层特性

商人阶层有独特的财富计算（`simulation.js` L5455-5462）：

```javascript
// 商人总财富 = 可用存款 + 锁定资本（在途贸易）
商人财富 = classWealth.merchant + merchantLockedCapital
```

这确保贸易资本不会被重复计算或意外消耗。

---

## 6.2 贸易利润

商人通过贸易站（market）获得额外收益（`simulation.js` L5437-5439）：

```javascript
// 贸易加成进入商人财富
wealth.merchant += tradeBonus
classFinancialData.merchant.income.ownerRevenue += tradeBonus
```

---

# 第七章：玩法策略

## 7.1 价格调控

1. **增产降价**：建造更多生产建筑，增加供给，降低价格
2. **减产涨价**：拆除或不建生产建筑，减少供给，提高价格
3. **价格管制**：左派主导时可直接设定政府价格

## 7.2 税收策略

| 策略 | 效果 | 风险 |
|-----|-----|-----|
| 高人头税 | 快速收入 | 满意度下降，税收冲击 |
| 负人头税（补贴）| 提升满意度 | 财政赤字 |
| 高交易税 | 抑制消费 | 生产成本上升 |
| 负交易税（补贴）| 刺激生产 | 财政负担 |

## 7.3 工资观察

1. 工资上涨 → 该行业利润高，可扩大生产
2. 工资下跌 → 该行业利润低，可能需要调整税率或减产
3. 工资接近生存成本地板 → 该阶层生活困难，可能引发不满

## 7.4 库存管理

1. 保持必需品（粮食、布料）库存在目标天数附近
2. 奢侈品可接受较低库存（价格高时增产）
3. 战略资源（铁、煤）保持高库存缓冲

---

# 附录：关键常量

| 常量 | 值 | 位置 |
|-----|---|-----|
| PRICE_FLOOR | 0.01 | utils/constants.js |
| BASE_WAGE_REFERENCE | 1.0 | utils/constants.js |
| WEALTH_DECAY_RATE | 0.005 | gameConstants.js |
| MAX_HEAD_TAX | 10000 | gameConstants.js |
| MAX_RESOURCE_TAX | 5.0 | gameConstants.js |
| MAX_BUSINESS_TAX | 10000 | gameConstants.js |
