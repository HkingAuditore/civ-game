# 人口系统 - 完整机制

> **核心逻辑**: `logic/population/needs.js`, `logic/diplomacy/populationMigration.js`

---

## 1. 人口上限

### 1.1 来源

人口上限由建筑的`maxPop`产出决定：

| 建筑 | maxPop | 时代 |
|-----|--------|-----|
| hut | 3 | 0 |
| granary | 6 | 1 |
| house | 8 | 2 |
| manor_house | 9 | 3 |
| townhouse | 10 | 4 |
| apartment | 11 | 5 |

### 1.2 加成

科技和时代提供百分比加成：
```javascript
effectiveMaxPop = baseMaxPop × (1 + maxPopBonus)
```

---

## 2. 人口增长

### 2.1 自然增长

```javascript
growthRate = 基础增长
           × 粮食满足率
           × 住房容量比
           × 时代加成

// 仅当有空间且粮食充足时增长
if (population < maxPop && foodSatisfied > 0.8):
    population += growthRate
```

### 2.2 增长限制

- 人口接近上限时增速放缓
- 粮食不足时增长停止甚至下降

---

## 3. 人口结构

### 3.1 阶层分布

```javascript
popStructure = {
    peasant: 100,
    worker: 50,
    merchant: 10,
    // ...
}
```

### 3.2 就业系统

建筑提供岗位：
```javascript
// farm提供
jobs: { peasant: 3 }

// factory提供
jobs: { worker: 20, engineer: 4, capitalist: 1 }
```

未就业者进入`unemployed`阶层。

---

## 4. 人口迁移

### 4.1 类型 (`populationMigration.js`)

| 类型 | 解锁时代 | 说明 |
|-----|---------|-----|
| economic_migration | 3 | 经济移民 |
| war_refugees | 2 | 战争难民 |
| political_exile | 4 | 政治流亡 |

### 4.2 移民条件

- 需要足够的人口容量
- 条件触发（如战争、经济差距）
- 受政策影响

---

## 5. 人口损失

### 5.1 原因

| 原因 | 触发条件 |
|-----|---------|
| 战争突袭 | 战斗失败 |
| 饥荒 | 粮食长期不足 |
| 叛乱 | 阶层起义 |
| 瘟疫 | 事件触发 |

### 5.2 阶层损失

特定事件可能导致特定阶层人口损失：
```javascript
popStructure[stratum] -= lossAmount
```

---

## 6. 玩法策略

### 6.1 人口增长

1. **建造住房**: 提高maxPop
2. **确保粮食**: 食物短缺阻止增长
3. **研究科技**: 获取maxPop加成

### 6.2 就业管理

1. **建造生产建筑**: 提供岗位
2. **平衡阶层**: 避免大量失业
3. **升级建筑**: 高级建筑提供更多岗位

### 6.3 避免损失

1. 保持军队防止突袭
2. 储备粮食应对短缺
3. 维持稳定防止叛乱
