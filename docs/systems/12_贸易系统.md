# 贸易系统 - 详尽规则书

> **核心代码**:
> - 商人贸易: `src/logic/economy/trading.js`
> - 外贸价格: `src/utils/foreignTrade.js`
> - 条约效果: `src/logic/diplomacy/treatyEffects.js`

---

# 第一章：贸易2.0系统

## 1.1 默认配置

商人贸易配置（`trading.js` L16-33）：

| 参数 | 值 | 说明 |
|-----|---|-----|
| minProfitMargin | 10% | 最低利润边际 |
| maxPurchaseAmount | 20 | 单次最大购买量 |
| exportProbability | 50% | 出口概率 |
| maxInventoryRatio | 30% | 最大库存占比 |
| minWealthForTrade | 10 | 最低贸易资本 |
| tradeDuration | 3天 | 贸易完成时间 |
| tradeCooldown | 0 | 贸易冷却时间 |
| idleTradeEfficiency | 15% | 无分配时效率 |
| maxPartnersPerTick | 4 | 每tick最多伙伴数 |
| shortageWeight | 2.2 | 短缺权重 |
| surplusWeight | 1.3 | 盈余权重 |

---

## 1.2 商人分配

商人可分配到不同贸易伙伴（`trading.js` L59-84）：

```javascript
// 归一化分配
normalized[nationId] = 商人数量

// 无分配时自动选择
按关系排序 → 取前N个最友好国家
```

---

# 第二章：外贸价格

## 2.1 库存驱动定价

外国资源价格计算（`foreignTrade.js` L21-73）：

```javascript
// 基础目标库存
基础库存 = 500 × bias^1.2
// bias = 国家对该资源的偏好，1.5=特产，0.5=稀缺

// 财富因子
财富因子 = clamp(国家财富 / 1000, 0.8, 1.5)

// 时代因子
时代因子 = 1 + epoch × 0.5 + epoch^1.3 × 0.1
// epoch 0=1x, 1=1.5x, 2=2x, 3=2.8x, 4=3.6x, 5=4.5x, 6=5.5x

// 目标库存
目标库存 = 基础库存 × 财富因子 × 时代因子

// 库存调节
库存比率 = 当前库存 / 目标库存
短缺压力 = max(0, 1 - 库存比率)
盈余压力 = max(0, 库存比率 - 1)

// 价格乘数
短缺乘数 = 1 + min(2.5, 短缺压力 × 0.9)
盈余乘数 = 1 - min(0.95, 盈余压力 × 0.6)
库存因子 = 短缺乘数 × 盈余乘数

// 战争价格上涨
战争系数 = 1 + min(0.75, 战争数 × 0.15)
// 每场战争+15%，最高+75%

// 最终价格
价格 = 基础价格 × 偏差因子 × 库存因子 × 战争系数
价格 = clamp(价格, 基础价×0.25, 基础价×4.0)
```

---

## 2.2 贸易状态

贸易缺口/盈余判定（`foreignTrade.js` L87-132）：

```javascript
// 短缺阈值 (特产更难缺货)
短缺乘数 = bias > 1 ? 0.3 : (bias < 1 ? 1.5 : 0.8)
短缺阈值 = 动态目标 × 短缺乘数

// 盈余阈值 (稀缺更难盈余)
盈余乘数 = bias > 1 ? 0.4 : (bias < 1 ? 2.0 : 1.2)
盈余阈值 = 动态目标 × 盈余乘数

// 判定
isShortage = 库存 < 短缺阈值
isSurplus = 库存 > 盈余阈值
```

---

# 第三章：贸易执行

## 3.1 进口评分

进口候选评分（`trading.js` L137-183）：

```javascript
// 有效成本（含关税）
有效成本 = 外国价 × (1 + 关税率)

// 利润边际
利润边际 = (本地价 - 有效成本) / 有效成本
if (利润边际 <= -0.1): 拒绝

// 短缺因子
短缺因子 = computeResourceShortageFactor(...)

// 伙伴盈余
伙伴盈余 = min(1, 盈余量 / max(50, 目标))

// 综合评分
评分 = shortageWeight × 短缺因子 +
       2.0 × max(0, 利润边际) +    // 利润权重高
       0.6 × 伙伴盈余

评分 *= 玩家偏好乘数
```

## 3.2 出口评分

出口候选评分（`trading.js` L185-222）：

```javascript
// 价格优势
价格优势 = (外国价 - 本地价) / 本地价
if (价格优势 <= 0): 拒绝

// 本地盈余
盈余因子 = computeResourceSurplusFactor(...)

// 伙伴短缺
伙伴短缺 = min(1, 短缺量 / max(50, 目标))

// 综合评分
评分 = surplusWeight × 盈余因子 +
       1.0 × 价格优势 +
       0.6 × 伙伴短缺

评分 *= 玩家偏好乘数
```

---

## 3.3 贸易执行

进口执行（`trading.js` L800-950）：

```javascript
// 成本计算
进口成本 = 外国价 × 数量
关税 = 进口成本 × 关税率
商人总成本 = 进口成本 + 关税

// 本地销售
毛收入 = 本地价 × 数量

// 利润
净利润 = 毛收入 - 商人总成本
利润率 = 净利润 / 商人总成本

if (利润率 < minProfitMargin): 拒绝
```

出口执行（`trading.js` L638-798）：

```javascript
// 成本计算
本地成本 = 本地价 × 数量
税款 = 本地成本 × 交易税率
关税 = 本地成本 × 出口关税率
总支出 = 本地成本 + 税款 + 关税

// 外国销售
收入 = 外国价 × 数量

// 利润
净利润 = 收入 - 总支出
利润率 = 净利润 / 总支出

if (利润率 < minProfitMargin): 拒绝
```

---

## 3.4 待处理贸易

贸易有延迟完成（`trading.js` L289-348）：

```javascript
// 每天减少剩余天数
trade.daysRemaining -= 1

if (daysRemaining <= 0):
    // 进口：资源到账
    res[resource] += trade.amount
    // 伙伴库存减少
    partner.inventory[resource] -= trade.amount
    
    // 商人收到收入
    roleWagePayout.merchant += trade.revenue
```

---

# 第四章：关税和补贴

## 4.1 关税类型

| 类型 | 配置键 | 说明 |
|-----|-------|-----|
| 进口关税 | importTariffMultipliers | 对进口征税 |
| 出口关税 | exportTariffMultipliers | 对出口征税 |
| 交易税 | resourceTaxRates | 基础交易税 |

## 4.2 条约减免

贸易协定减免关税（`trading.js` L400-416）：

```javascript
// 获取条约效果
treatyEffects = getTreatyEffects(partner, tick)
条约关税乘数 = treatyEffects.tariffMultiplier // 0~1

// 应用减免（只影响关税部分）
实际关税 = 基础关税 × 条约关税乘数
```

---

# 第五章：玩法策略

## 5.1 贸易方向

| 目标 | 策略 |
|-----|-----|
| 进口缺口资源 | 分配商人到有盈余的伙伴 |
| 出口盈余资源 | 分配商人到有缺口的伙伴 |
| 套利 | 利用价差获利 |

## 5.2 关税政策

| 政策 | 效果 |
|-----|-----|
| 高进口关税 | 保护本地产业，减少进口 |
| 高出口关税 | 减少出口，保留资源 |
| 进口补贴 | 鼓励进口，弥补短缺 |
| 出口补贴 | 鼓励出口，增加外汇 |

## 5.3 贸易协定

| 协定效果 | 说明 |
|---------|-----|
| tariffMultiplier=0.5 | 关税减半 |
| tariffMultiplier=0 | 关税全免 |

---

# 附录A：核心公式速查

| 计算 | 公式 |
|-----|-----|
| 外国价格 | 基础价×偏差×库存因子×战争系数 |
| 库存因子 | 短缺乘数×盈余乘数 |
| 时代目标库存 | 500×bias^1.2×财富因子×时代因子 |
| 进口利润 | 本地价×数量 - 外国价×数量×(1+关税) |
| 出口利润 | 外国价×数量 - 本地价×数量×(1+税+关税) |

---

# 附录B：代码位置索引

| 功能 | 文件 | 行号 |
|-----|-----|-----|
| 默认贸易配置 | trading.js | L16-33 |
| 商人分配归一化 | trading.js | L59-70 |
| 进口评分 | trading.js | L137-183 |
| 出口评分 | trading.js | L185-222 |
| 贸易执行主函数 | trading.js | L231-634 |
| 进口执行V2 | trading.js | L800-950 |
| 出口执行V2 | trading.js | L638-798 |
| 外国价格计算 | foreignTrade.js | L21-73 |
| 贸易状态计算 | foreignTrade.js | L87-132 |
