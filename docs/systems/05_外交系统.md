# 外交系统 - 详尽规则书

> **核心代码**:
> - 外交配置: `config/diplomacy.js`
> - 附庸逻辑: `logic/diplomacy/vassalSystem.js`
> - 总督系统: `logic/diplomacy/vassalGovernors.js`
> - AI战争: `logic/diplomacy/aiWar.js`

---

# 第一章：外交时代解锁机制

## 1.1 条约解锁

游戏中的外交机制按时代逐步解锁（`diplomacy.js` L4-37）。玩家必须达到对应时代才能使用这些外交工具。

### 条约类型解锁表

| 条约类型 | 解锁时代 | 基础持续时间 | 最低关系需求 | 说明 |
|---------|---------|------------|------------|-----|
| peace_treaty（和平条约）| 时代1 | 365天 | 0 | 停战协议 |
| non_aggression（互不侵犯）| 时代2 | 365天 | 40 | 不互相宣战 |
| trade_agreement（贸易协定）| 时代2 | 365天 | 45 | 关税优惠 |
| open_market（开放市场）| 时代2 | 730天 | 55 | 双边贸易自由化 |
| academic_exchange（学术交流）| 时代3 | 730天 | 65 | 科研合作 |
| defensive_pact（共同防御）| 时代3 | 1095天 | 70 | 军事同盟 |
| investment_pact（投资协议）| 时代4 | 730天 | 55 | 海外投资保护 |
| free_trade（自由贸易）| 时代4 | 1095天 | 60 | 完全免关税 |

### 条约持续时间计算

条约持续时间会随时代优势增长（`diplomacy.js` L285-291）：

```javascript
实际持续时间 = 基础持续时间 × (1 + 时代优势 × 0.5)

时代优势 = max(0, 当前时代 - 解锁时代)
```

**示例**：
- 时代4解锁贸易协定（解锁时代2），时代优势=2
- 实际持续时间 = 365 × (1 + 2×0.5) = 365 × 2 = 730天

---

## 1.2 主权类型解锁

附庸关系同样按时代解锁（`diplomacy.js` L15-20）：

| 附庸类型 | 解锁时代 | 说明 |
|---------|---------|-----|
| protectorate（保护国）| 时代2 | 高自主度附庸 |
| tributary（朝贡国）| 时代3 | 中等控制附庸 |
| colony（殖民地）| 时代4 | 完全控制领地 |
| puppet（傀儡国）| 时代6 | 低自主度傀儡 |

---

## 1.3 条约成本机制

### 签约成本

签约需要支付银币（`diplomacy.js` L589-598）：

```javascript
签约成本 = max(200, (玩家财富 × 0.6 + 目标财富 × 0.4) × 费率)
```

### 条约费率表

| 条约类型 | 签约费率 | 每日维护费 |
|---------|---------|----------|
| peace_treaty | 0.5% | 0 |
| non_aggression | 1% | 2银/日 |
| academic_exchange | 1.5% | 3银/日 |
| trade_agreement | 3.5% | 6银/日 |
| open_market | 4% | 6银/日 |
| investment_pact | 4% | 9银/日 |
| free_trade | 5% | 12银/日 |
| defensive_pact | 5% | 15银/日 |

### 违约惩罚

违约根据时代产生不同惩罚（`diplomacy.js` L293-297）：

| 时代 | 关系惩罚 | 外交冷却 |
|-----|---------|---------|
| 0-3 | -20 | 90天 |
| 4-5 | -35 | 180天 |
| 6+ | -50 | 365天 |

---

# 第二章：附庸系统详解

## 2.1 附庸类型配置

四种附庸类型有不同属性（`diplomacy.js` L316-373）：

### 核心属性对照表

| 属性 | 保护国 | 朝贡国 | 傀儡国 | 殖民地 |
|-----|-------|-------|-------|-------|
| **最低关系** | 60 | 50 | 30 | 0 |
| **初始自主度** | 80 | 50 | 20 | 5 |
| **基础朝贡率** | 8% | 15% | 25% | 35% |
| **剥削系数** | 0.9 | 0.7 | 0.5 | 0.3 |
| **关税折扣** | 50% | 75% | 100% | 100% |

### 外交自由度

| 能力 | 保护国 | 朝贡国 | 傀儡国 | 殖民地 |
|-----|-------|-------|-------|-------|
| 独立结盟 | ✓ | ✗ | ✗ | ✗ |
| 签署条约 | ✓ | ✓ | ✗ | ✗ |
| 自由贸易 | ✓ | ✓ | ✗ | ✗ |

### 自主度效果

自主度影响附庸能力（`diplomacy.js` L387-393）：

```javascript
getAutonomyEffects(autonomy) {
    canDeclareWar: autonomy > 70,      // 自主宣战
    canSignTreaties: autonomy > 50,    // 自主签约
    canSetTariffs: autonomy > 40,      // 自主关税
    tributeReduction: 1 - (autonomy / 200),  // 朝贡减免
    investmentShield: autonomy / 100,  // 投资保护
}
```

---

## 2.2 附庸政策系统

### 劳工政策（Labor Policy）

影响海外投资工资和动荡（`diplomacy.js` L112-141）：

| 政策ID | 名称 | 工资乘数 | 每日动荡 | 独立增速 | 解锁时代 |
|-------|-----|---------|--------|---------|---------|
| standard | 正常雇佣 | ×1.0 | 0 | ×1.0 | - |
| exploitation | 压榨剥削 | ×0.6 | +0.05% | ×1.2 | - |
| slavery | 强制劳动 | ×0.3 | +0.15% | ×1.8 | 时代2 |

### 贸易政策（Trade Policy）

影响贸易条件和独立（`diplomacy.js` L147-196）：

| 政策ID | 名称 | 玩家价格优惠 | 朝贡修正 | 独立增速 | 特殊效果 |
|-------|-----|------------|---------|---------|---------|
| free | 自由贸易 | 0 | ×0.8 | ×0.8 | - |
| preferential | 优惠准入 | -10% | ×1.0 | ×1.0 | 关税折扣50% |
| exclusive | 排他贸易 | -25% | ×1.2 | ×1.3 | 免关税 |
| dumping | 倾销市场 | +20%卖价 | ×1.0 | ×1.4 | 强制出口 |
| looting | 资源掠夺 | -40%买价 | ×1.5 | ×1.6 | 强制进口（时代3）|

### 治理政策（Governance Policy）

影响行政方式（`diplomacy.js` L202-231）：

| 政策ID | 名称 | 朝贡修正 | 控制成本 | 独立增速 | 自主度下限 |
|-------|-----|---------|---------|---------|----------|
| autonomous | 自治 | ×0.5 | ×0 | ×0.6 | 70% |
| puppet_govt | 傀儡政府 | ×1.0 | ×0.5 | ×1.0 | 20% |
| direct_rule | 总督直辖 | ×1.3 | ×1.5 | ×0.8 | 0%（需官员）|

### 政策预设

快速设置组合（`diplomacy.js` L254-283）：

| 预设 | 劳工 | 贸易 | 治理 |
|-----|-----|-----|-----|
| 保护国模式 | standard | preferential | autonomous |
| 朝贡国模式 | exploitation | dumping | puppet_govt |
| 傀儡国模式 | exploitation | looting | puppet_govt |
| 殖民地模式 | slavery | looting | direct_rule |

---

# 第三章：朝贡系统

## 3.1 朝贡结算周期

朝贡每**30天**结算一次（`vassalSystem.js` L341-368）。

---

## 3.2 朝贡金额计算

完整的朝贡计算公式（`vassalSystem.js` L449-523）：

### 第一步：基础金额

```javascript
基于玩家财富 = 玩家财富 × 0.008
基于附庸财富 = 附庸财富 × 0.03

基础朝贡 = max(200, 玩家基础×0.5 + 附庸基础×0.5)
```

### 第二步：应用朝贡率

```javascript
朝贡 = 基础朝贡 × 朝贡率
// 朝贡率由附庸类型决定：8%/15%/25%/35%
```

### 第三步：规模系数

```javascript
if (附庸财富 > 3000):
    规模系数 = 1.5  // 大型
else if (附庸财富 > 1000):
    规模系数 = 1.0  // 中型
else:
    规模系数 = 0.6  // 小型

朝贡 *= 规模系数
```

### 第四步：自主度修正

```javascript
自主度系数 = 1 - (自主度 / 200)
// 自主度0 → 系数1.0
// 自主度100 → 系数0.5

朝贡 *= 自主度系数
```

### 第五步：独立抵抗

```javascript
抵抗系数 = max(0.3, 1 - (独立压力 / 150))
// 独立压力0 → 系数1.0
// 独立压力100 → 系数0.33
// 最低0.3（始终至少30%）

朝贡 *= 抵抗系数
```

### 第六步：总督效果

```javascript
朝贡 *= 总督朝贡加成  // 默认1.0
朝贡 -= 朝贡 × 总督腐败率  // 腐败损失
```

### 完整公式汇总

```
最终朝贡 = max(200, (玩家财富×0.8% + 附庸财富×3%) × 0.5)
         × 朝贡率
         × 规模系数
         × (1 - 自主度/200)
         × max(0.3, 1 - 独立压力/150)
         × 总督朝贡加成
         × (1 - 腐败率)
```

---

## 3.3 资源朝贡

除银币外还可朝贡资源（`vassalSystem.js` L500-517）：

```javascript
可朝贡资源: food, wood, iron, cloth

每种资源朝贡量 = min(
    附庸库存 × 10%,
    基础量(10) × 朝贡率 × 规模系数
) × 自主度系数 × 抵抗系数
```

---

# 第四章：独立压力系统

## 4.1 每日基础增长率

独立压力每天增长（`diplomacy.js` L637-657）：

| 附庸类型 | 基础增长/天 |
|---------|-----------|
| 保护国 | 0.08 |
| 朝贡国 | 0.15 |
| 傀儡国 | 0.25 |
| 殖民地 | 0.40 |

---

## 4.2 独立增长率修正

完整的增长率计算（`vassalSystem.js` L532-570）：

### 时代系数

```javascript
时代系数 = 1.0 + max(0, 当前时代 - 3) × 0.15
// 时代3及以前：×1.0
// 时代4：×1.15
// 时代5：×1.30
// ...
```

### 阶层满意度影响

```javascript
平均满意度 = 加权平均(精英, 平民, 底层)

if (平均满意度 < 30):   // 危机
    增长率 *= 2.0
else if (平均满意度 < 50):  // 低
    增长率 *= 1.3
else if (平均满意度 > 70):  // 高
    增长率 *= 0.7
```

### 政策修正

```javascript
// 劳工政策
standard: ×1.0
exploitation: ×1.2
slavery: ×1.8

// 贸易政策
free: ×0.8
preferential: ×1.0
exclusive: ×1.3
dumping: ×1.4
looting: ×1.6
```

### 完整公式

```
每日独立增长 = 基础增长率
             × 时代系数
             × 满意度系数
             × 劳工政策系数
             × 贸易政策系数
             - 控制措施减少量
```

---

## 4.3 独立欲望计算

独立欲望是综合指标（`diplomacy.js` L401-425）：

```javascript
独立欲望 = 独立压力
         + 朝贡率 × 100
         + (100 - 自主度) × 0.3
         + (100 - 精英满意度) × 0.15
         + (100 - 平民满意度) × 0.10
         - 宗主军事优势 × 30

// 宗主军事优势 = max(0, 宗主军力 - 附庸军力)
// 结果限制在0-100范围
```

---

## 4.4 独立战争触发

当独立欲望≥80时检查触发（`vassalSystem.js` L604-634）：

### 触发概率

| 条件 | 检查 | 概率 |
|-----|-----|-----|
| 宗主正在交战 | playerAtWar | 30% |
| 宗主稳定度<40 | playerStability | 20% |
| 外国支持（关系≥60）| 第三方国家 | 25% |

### 触发后果

```javascript
// 触发独立战争时
vassalNation.isAtWar = true;
vassalNation.warTarget = 'player';
vassalNation.independenceWar = true;
vassalNation.vassalOf = null;  // 立即解除附庸状态
vassalNation.vassalType = null;
```

---

# 第五章：控制措施

## 5.1 控制措施概览

四种控制措施（`diplomacy.js` L660-691）：

| 措施 | 基础日费 | 财富缩放 | 主要效果 |
|-----|---------|---------|---------|
| 总督 | 30 | +0.3% | 独立压制、精英满意 |
| 驻军 | 50 | +0.5% | 强力压制、平民不满 |
| 同化 | 60 | +0.2% | 降低独立上限 |
| 扶持 | 50 | +0.4% | 满意度、财富转移 |

---

## 5.2 成本计算

每种措施的实际成本（`vassalSystem.js` L22-31）：

```javascript
日成本 = 基础成本 + 附庸财富 × 缩放系数

// 示例：附庸财富5000
驻军成本 = 50 + 5000 × 0.005 = 50 + 25 = 75银/日
```

---

## 5.3 总督详解

总督是最复杂的控制措施（`vassalGovernors.js` L72-176）：

### 需要分配官员

总督必须分配一名官员。官员属性影响效果：

| 官员属性 | 效果 |
|---------|-----|
| 威望（prestige）| 独立压制、精英满意度 |
| 行政（administrative）| 朝贡效率、降低腐败 |
| 军事（military）| 稳定性、动荡压制 |
| 忠诚度（loyalty）| 廉政、独立风险 |

### 独立压制计算

```javascript
威望独立压制 = 威望 × 0.005
// 威望50 → 0.25/天压制
// 威望100 → 0.50/天压制
```

### 朝贡效率

```javascript
行政加成 = min(0.5, 行政 × 0.01)
// 行政50 → +50%朝贡（上限）
// 行政30 → +30%朝贡

朝贡乘数 = 1.0 + 行政加成
```

### 腐败率

```javascript
基础腐败 = 5%

// 行政降低腐败
腐败 -= 行政 × 0.001
// 行政50 → 腐败降低5%

// 低忠诚增加腐败
if (忠诚度 < 40):
    腐败 += (40 - 忠诚度) × 0.002
    // 忠诚30 → 腐败+2%

// 范围限制：0-30%
```

### 阶层满意度

```javascript
精英满意度加成 = 威望 × 0.02 × 阶层系数

// 阶层系数
贵族出身: ×1.3
平民出身: ×0.7
资本家出身: ×1.0
```

### 总督日成本

```javascript
日成本 = 30 + 威望 × 0.5
// 威望50 → 55银/日
// 威望80 → 70银/日
```

### 低忠诚风险

```javascript
if (忠诚度 < 40):
    // 腐败风险警告
    // 每日1%概率触发腐败事件
    
if (忠诚度 < 20):
    // 严重危险警告
    // 独立风险增加
    独立风险 = (40 - 忠诚度) × 0.001
```

---

## 5.4 驻军详解

驻军需要军事力量支撑（`vassalSystem.js` L99-112, L231-263）：

### 军力需求

```javascript
需求军力 = 附庸军力 × 50%

有效 = 玩家军力 ≥ 需求军力
```

### 效果

```javascript
if (有效):
    独立压力减少 = 0.5/天
else:
    独立压力减少 = 0.1/天  // 仅20%效果
    // 触发警告

// 平民满意度惩罚
平民满意度 -= 3 × 0.1  // 每日累积
```

---

## 5.5 文化同化

同化降低独立上限（`vassalSystem.js` L266-289）：

```javascript
每日独立上限减少 = 0.05
最低独立上限 = 30

// 全阶层满意度惩罚
所有阶层满意度 -= 1 × 0.1  // 每日累积
```

---

## 5.6 经济扶持

扶持提升满意度（`vassalSystem.js` L292-329）：

```javascript
独立压力减少 = 0.1/天

// 满意度加成
平民满意度 += 3 × 0.1  // 每日
底层满意度 += 5 × 0.1  // 每日

// 财富转移
附庸财富 += 日成本 × 0.1%
```

---

# 第六章：时代演进效果

## 6.1 演进效果配置

随时代增强的外交效果（`diplomacy.js` L749-801）：

| 效果类型 | 每时代加成 | 上限 |
|---------|----------|-----|
| 商人效率 | +10% | +50% |
| 附庸控制 | +5%控制、+3%朝贡 | 无上限 |
| 条约效率 | +10%时长、-2%维护 | 无上限 |
| 组织效率 | +8%效果、+1成员上限 | +40% |
| 海外投资 | +5%利润、-2%风险 | 无上限 |
| 移民效率 | +10%流量、+5%融入 | 无上限 |

---

# 第七章：附庸关系转换

## 7.1 建立附庸

建立附庸的要求（`diplomacy.js` L456-475）：

| 从主权国家到 | 最低关系 | 军力比 | 战分需求 |
|-------------|---------|-------|---------|
| 保护国 | 60 | 0.5 | 30 |
| 朝贡国 | 50 | 0.4 | 50 |
| 傀儡国 | 30 | 0.3 | 80 |
| 殖民地 | 0 | 0.2 | 100 |

## 7.2 释放附庸

主动释放的效果（`vassalSystem.js` L675-688）：

```javascript
// 主动释放
关系变化 = +20

// 其他原因解除
关系变化 = -30

// 重置附庸状态
vassalOf = null
autonomy = 100
independencePressure = 0
```

---

# 第八章：玩法策略

## 8.1 附庸经济收益最大化

| 策略 | 朝贡收入 | 独立风险 | 适用场景 |
|-----|---------|---------|---------|
| 自治保护国 | 低 | 极低 | 长期稳定盟友 |
| 傀儡+驻军 | 高 | 中 | 征服后控制 |
| 殖民+同化 | 最高 | 高 | 完全吸收 |

## 8.2 控制措施组合推荐

| 目标 | 第一措施 | 第二措施 | 说明 |
|-----|---------|---------|-----|
| 稳定收入 | 总督（高行政）| 扶持 | 腐败低、满意度高 |
| 快速压制 | 驻军 | 同化 | 需强大军力 |
| 长期同化 | 同化 | 扶持 | 缓慢但稳定 |

## 8.3 独立风险管理

1. **监控独立欲望**：保持<80
2. **军事威慑**：保持军力>附庸×150%
3. **满意度管理**：精英>50，平民>40
4. **避免多线作战**：战时独立概率+30%
5. **选择好总督**：高威望+高行政+高忠诚

## 8.4 总督选拔标准

| 属性 | 优先级 | 原因 |
|-----|-------|-----|
| 行政 | 高 | 朝贡+50%、腐败-5% |
| 威望 | 中 | 独立压制、精英满意 |
| 忠诚度 | 高 | 避免腐败和叛变 |
| 出身阶层 | 看情况 | 贵族对精英好、平民对平民好 |

---

# 附录A：核心公式速查

| 计算 | 公式 |
|-----|-----|
| 条约持续 | 基础 × (1 + 时代优势×0.5) |
| 签约成本 | max(200, 加权财富 × 费率) |
| 朝贡基础 | max(200, 玩家×0.8% + 附庸×3%) |
| 规模系数 | 小0.6 / 中1.0 / 大1.5 |
| 自主度减免 | 1 - 自主度/200 |
| 抵抗系数 | max(0.3, 1 - 独立/150) |
| 总督成本 | 30 + 威望×0.5 |
| 驻军需求 | 附庸军力 × 50% |
| 独立时代系数 | 1 + max(0, 时代-3)×0.15 |

---

# 附录B：控制措施对照表

| 措施 | 日费公式 | 独立压力减少 | 主要风险 |
|-----|---------|------------|---------|
| 总督 | 30+财富×0.3% | 威望×0.005 | 低忠诚腐败 |
| 驻军 | 50+财富×0.5% | 0.5（有效）/0.1 | 平民不满、需军力 |
| 同化 | 60+财富×0.2% | 降低上限0.05/天 | 全民不满 |
| 扶持 | 50+财富×0.4% | 0.1 | 成本高 |
