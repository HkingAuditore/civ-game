# 外交系统 - 完整机制

> **核心逻辑**: `logic/diplomacy/vassalSystem.js`, `config/diplomacy.js`

---

## 1. 系统概述

外交系统核心：
```
国家关系 → 附庸建立 → 控制措施 → 朝贡/独立压力 → 可能独立战争
              ↓
条约/组织 → 贸易/军事合作 → 收益/义务
```

---

## 2. 附庸类型

### 2.1 类型配置 (`diplomacy.js` VASSAL_TYPE_CONFIGS)

| 类型 | 时代 | 朝贡率 | 独立基础增长 |
|-----|-----|--------|------------|
| `protectorate` 保护国 | epoch≥2 | 5% | 0.15/天 |
| `tributary` 朝贡国 | epoch≥3 | 15% | 0.10/天 |
| `puppet` 傀儡国 | epoch≥4 | 25% | 0.08/天 |
| `colony` 殖民地 | epoch≥5 | 35% | 0.20/天 |

### 2.2 独立欲望计算 (`diplomacy.js` calculateIndependenceDesire)

```javascript
基础欲望 = 独立压力 × vassalType.independenceWeight
         + 不满度修正
         - 相对军事力量压制
```

---

## 3. 控制措施

### 3.1 措施类型 (`diplomacy.js` INDEPENDENCE_CONFIG.controlMeasures)

| 措施 | 成本公式 | 独立减少 | 特殊效果 |
|-----|---------|---------|---------|
| `governor` 总督 | 基础+财富% | 由官员决定 | 需指派官员 |
| `garrison` 驻军 | 基础+财富% | -0.25 | 需军力≥附庸50% |
| `assimilation` 同化 | 基础+财富% | 降独立上限 | 满意度-2 |
| `economicAid` 经援 | 基础+财富% | -0.10 | 满意度+3 |

### 3.2 措施成本 (`vassalSystem.js` L22-31)

```javascript
dailyCost = baseCost + vassalWealth × scalingFactor
```

### 3.3 总督效果 (`vassalSystem.js` L39-91)

```javascript
// 基础效果受官员威望和忠诚度影响
effectiveness = baseEffectiveness 
              × (0.5 + prestige/100 × 0.5) 
              × (0.5 + loyalty/100 × 0.5)

independenceReduction = baseReduction × (1 + effectiveness)

// 低忠诚度风险
if (loyalty < 40):
    corruptionChance = (40 - loyalty) / 100
    independenceIncrease = 0.05 × (40 - loyalty) / 40
```

### 3.4 驻军效果 (`vassalSystem.js` L99-112)

```javascript
// 需要军力 ≥ 附庸军力 × 50%
requiredStrength = vassalMilitary × 0.5
isEffective = playerMilitary >= requiredStrength

// 不足时效果降至20%
if (!isEffective):
    independenceReduction = baseReduction × 0.2
```

---

## 4. 朝贡系统

### 4.1 朝贡周期 (`vassalSystem.js` L341)

每30天结算一次朝贡。

### 4.2 朝贡计算

```javascript
silverTribute = vassalWealth × tributeRate × modifiers
resourceTribute = 选择性资源按配置比例

// modifiers包括:
// - 总督贪腐 (增加/截留)
// - 附庸满意度
// - 附庸类型基础率
```

---

## 5. 独立压力

### 5.1 增长率 (`vassalSystem.js` L371-390)

```javascript
effectiveGrowth = independenceGrowth - controlMeasureReduction

// 独立压力有上限 (assimilation可降低上限)
updated.independencePressure = min(
    independenceCap,
    max(0, current + effectiveGrowth)
)
```

### 5.2 独立战争触发 (`vassalSystem.js` L392-400)

```javascript
if (independenceDesire >= INDEPENDENCE_WAR_CONDITIONS.minIndependenceDesire):
    checkIndependenceWarTrigger(...)
```

触发条件检查：
- 宗主国战争中
- 宗主国稳定度低
- 附庸军力足够

---

## 6. 劳工政策

### 6.1 政策类型 (`diplomacy.js` LABOR_POLICY_DEFINITIONS)

| 政策 | 工资倍率 | 每日不满 | 独立增速 |
|-----|---------|---------|---------|
| `standard` | 1.0 | 0 | 1.0x |
| `exploitation` | 0.6 | +0.05 | 1.2x |
| `slavery` (epoch≥2) | 0.3 | +0.15 | 1.8x |

---

## 7. 国际组织

### 7.1 解锁时代 (`diplomacy.js` DIPLOMACY_ERA_UNLOCK.organizations)

| 组织类型 | 时代 |
|---------|-----|
| 防御同盟 | epoch≥3 |
| 贸易联盟 | epoch≥4 |
| 军事集团 | epoch≥5 |

---

## 8. 条约系统

### 8.1 条约类型 (`diplomacy.js` DIPLOMACY_ERA_UNLOCK.treaties)

| 条约 | 时代 | 效果 |
|-----|-----|-----|
| `peace_treaty` | epoch≥1 | 终止战争 |
| `non_aggression` | epoch≥2 | 互不侵犯 |
| `trade_agreement` | epoch≥3 | 贸易加成 |
| `military_alliance` | epoch≥4 | 军事互助 |

---

## 9. 玩法策略

### 9.1 附庸管理

- **保护国**: 低成本维持，但控制弱
- **殖民地**: 高收益但独立倾向强，需强力镇压
- **傀儡国**: 平衡选择

### 9.2 控制措施选择

| 场景 | 推荐措施 |
|-----|---------|
| 早期稳定 | 经济援助 (提升满意度) |
| 军事压制 | 驻军 (需军力支持) |
| 长期同化 | 同化政策 (降独立上限) |
| 精细管理 | 总督 (需高威望高忠诚官员) |

### 9.3 避免独立战争

1. 保持军力优势 (≥附庸的2倍)
2. 避免宗主国稳定度过低
3. 不要在战争期间忽视附庸
4. 组合使用多种控制措施

### 9.4 总督选择

- 选择高威望+高忠诚的官员
- 避免派遣忠诚度<40的官员（贪腐风险）
- 贵族出身官员更适合处理精英事务
