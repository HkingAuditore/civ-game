# 阶层社会系统 - 详尽规则书

> **核心代码**:
> - 阶层配置: `config/strata.js`
> - 满意度计算: `logic/stability/approval.js`
> - 生活水平: `utils/livingStandard.js`
> - 需求消费: `logic/population/needs.js`

---

# 第一章：阶层分类

## 1.1 阶层层级

游戏共有18个社会阶层，分为三个层级：

### 底层阶级（消费上限3倍）

| 阶层 | 基础影响力 | 初始财富 | 人头税基础 | 特点 |
|-----|-----------|---------|-----------|-----|
| peasant（自耕农）| 0.5 | 80 | 0.01 | 粮食基础，民心之本 |
| lumberjack（樵夫）| 0.4 | 90 | 0.02 | 专业伐木 |
| serf（佃农）| 0.3 | 50 | 0.015 | 依附地主，消费最保守 |
| worker（工人）| 1.0 | 80 | 0.03 | 工业基石 |
| unemployed（失业者）| 0.3 | 30 | 0.01 | 不满风险 |

### 中层阶级（消费上限6倍）

| 阶层 | 基础影响力 | 初始财富 | 人头税基础 | 特点 |
|-----|-----------|---------|-----------|-----|
| artisan（工匠）| 1.2 | 200 | 0.035 | 手工业者 |
| miner（矿工）| 0.8 | 120 | 0.025 | 艰苦劳动 |
| merchant（商人）| 3.5 | 500 | 0.09 | 贸易阶层，高消费弹性 |
| navigator（水手）| 2.5 | 300 | 0.06 | 航海扩张 |
| scribe（学者）| 1.5 | 250 | 0.04 | 知识传承 |
| soldier（军人）| 2.0 | 180 | 0.04 | 军事力量 |
| cleric（神职）| 3.0 | 220 | 0.05 | 信仰文化 |

### 上层阶级（消费上限10倍）

| 阶层 | 基础影响力 | 初始财富 | 人头税基础 | 特点 |
|-----|-----------|---------|-----------|-----|
| official（官员）| 4.0 | 400 | 0.08 | 政府管理，**贪婪消费** |
| landowner（地主）| 5.0 | 800 | 0.07 | 传统精英 |
| capitalist（资本家）| 6.0 | 1200 | 0.08 | 工业精英，**最高消费弹性** |
| knight（骑士）| 4.0 | 600 | 0.09 | 军事贵族 |
| engineer（工程师）| 3.5 | 700 | 0.1 | 技术精英 |

---

## 1.2 阶层属性详解

每个阶层有以下核心属性（`strata.js`）：

### 经济属性

```javascript
{
    startingWealth: 数值,      // 初始财富（银币）
    headTaxBase: 数值,         // 人头税基础（每人每日）
    wealthWeight: 数值,        // 财富权重（计算影响力时）
    defaultResource: '资源',   // 默认关联资源
}
```

### 消费属性

```javascript
{
    wealthElasticity: 0.3-1.8, // 财富弹性：收入增加时消费增长速度
    maxConsumptionMultiplier: 3/6/10, // 消费上限倍数
    greedy: true/false,        // 贪婪模式（仅官员启用）
}
```

**财富弹性说明**：
- 佃农 (0.4)：最保守，收入翻倍消费只增40%
- 工人 (0.7)：中等增长
- 商人 (1.5)：收入转化消费能力强
- 资本家 (1.8)：消费增长最快

### 需求属性

```javascript
{
    needs: { food: 数量, cloth: 数量 }, // 基础需求（每人每日）
    luxuryNeeds: {                       // 奢侈需求（按财富乘数解锁）
        1.0: { ale: 0.05 },               // 财富乘数≥1.0时解锁
        2.0: { furniture: 0.03 },         // 财富乘数≥2.0时解锁
        // ...更高阈值
    }
}
```

### 效果属性（Buffs）

```javascript
{
    buffs: {
        satisfied: { desc: '描述', taxIncome: +0.1, production: +0.05 },
        dissatisfied: { desc: '描述', taxIncome: -0.2, stability: -0.1 }
    }
}
```

---

# 第二章：生活水平系统

## 2.1 生活水平等级

生活水平分为6个等级（`livingStandard.js` L14-21）：

| 等级 | 评分范围 | 满意度上限 | 图标颜色 |
|-----|---------|-----------|---------|
| 赤贫 | 0-19 | 30 | 灰色 |
| 贫困 | 20-39 | 50 | 红色 |
| 温饱 | 40-54 | 70 | 黄色 |
| 小康 | 55-69 | 85 | 绿色 |
| 富裕 | 70-84 | 95 | 蓝色 |
| 奢华 | 85-100 | 100 | 紫色 |

**关键机制**：生活水平**限制满意度上限**。例如，贫困状态下满意度最高只能到50。

---

## 2.2 生活水平评分公式

总评分由三部分组成（`livingStandard.js` L24-72, L74-102）：

### 收入充裕度评分（0-50分）

```javascript
// 盈余比率 = (收入 - 基础成本) / 基础成本
surplus = (income - essentialCost) / essentialCost

if (surplus >= 1):     分数 = 50          // 收入是成本2倍以上
if (0 <= surplus < 1): 分数 = 25 + surplus × 25  // 收支平衡到2倍
if (-1 <= surplus < 0):分数 = 25 + surplus × 25  // 入不敷出
if (surplus < -1):     分数 = 0           // 严重亏损
```

### 需求满足评分（0-30分）

```javascript
分数 = 需求满足率 × 30
```

### 财务安全评分（0-20分）

```javascript
覆盖天数 = 存款 / 日支出
分数 = min(20, (覆盖天数 / 30) × 20)  // 能覆盖30天支出 = 满分
```

### 总评分

```javascript
总评分 = 收入充裕度 + 需求满足 + 财务安全
// 然后根据评分确定生活水平等级
```

---

## 2.3 财富乘数（消费能力）

财富乘数决定奢侈品解锁和消费量（`livingStandard.js` L143-221）：

### 计算公式

```javascript
// 1. 有效比率（财富可补偿30%收入不足）
effectiveRatio = max(incomeRatio, wealthRatio × 0.3)

// 2. 基础乘数（对数增长）
if (effectiveRatio <= 0): baseMultiplier = 0.3
if (effectiveRatio < 1):  baseMultiplier = 0.3 + effectiveRatio × 0.7
if (effectiveRatio >= 1): baseMultiplier = 1 + ln(effectiveRatio) × 0.5
// 贪婪模式（官员）使用线性增长：1 + (ratio - 1) × 0.8

// 3. 弹性调节
incomeMultiplier = 1 + (baseMultiplier - 1) × wealthElasticity

// 4. 财富意愿约束
if (wealthRatio < 0.3): wealthFactor = 0.5  // 赤贫只敢消费50%
if (wealthRatio < 1):   wealthFactor = 0.5-1.0  // 逐渐增加
if (wealthRatio >= 2):  wealthFactor = 1.0-1.15 // 富裕略增

// 5. 最终乘数
wealthMultiplier = incomeMultiplier × wealthFactor
// 受阶层上限限制（底层3，中层6，上层10）
```

### 实战案例

假设自耕农：
- 人均收入 = 0.8（收入比率）
- 人均财富 = 160，初始财富 = 80（财富比率 = 2.0）
- 财富弹性 = 0.5，消费上限 = 3

则：
- effectiveRatio = max(0.8, 2.0 × 0.3) = 0.8
- baseMultiplier = 0.3 + 0.8 × 0.7 = 0.86
- incomeMultiplier ≈ 0.93
- wealthFactor = 1.0（财富比率=2）
- **wealthMultiplier ≈ 0.93**

这意味着该自耕农只能解锁财富乘数≤0.93的奢侈品需求。

---

# 第三章：满意度系统

## 3.1 满意度目标计算

满意度采用**渐变机制**（`approval.js` L40-183）：

### 基础目标值

```javascript
targetApproval = 70  // 基础

// 生活水平调整
if (livingLevel == '奢华'): targetApproval = 95
if (livingLevel == '富裕'): targetApproval = 85
if (livingLevel == '小康'): targetApproval = 75
```

### 税负惩罚

```javascript
// 税负过重判定
taxBurden = (每人税额 > 收入 × 50%) && (财富 < 税额 × 100天)

if (taxBurden):
    targetApproval = min(targetApproval, 40)  // 上限40
else if (税率 < 0.6):
    targetApproval += 5  // 低税奖励
```

### 需求短缺惩罚

```javascript
// 基础需求短缺 - 严重惩罚
if (基础短缺数 >= 全部基础需求数):
    targetApproval = min(targetApproval, 0)   // 直接归零
else if (基础短缺数 > 0):
    targetApproval = min(targetApproval, 30)  // 上限30

// 奢侈需求短缺 - 较轻惩罚
luxuryPenalty = min(15, 短缺种类数 × 3)
targetApproval -= luxuryPenalty
```

### 生活水平惩罚

```javascript
if (生活水平 == '赤贫' || '贫困'):
    惩罚基数 = 赤贫 ? 2.5 : 1.5
    惩罚 = min(30, 连续天数 × 惩罚基数)
    targetApproval -= 惩罚
```

### 需求持续满足奖励

```javascript
// 连续满足率≥95%
if (连续满足天数 >= 3):
    奖励 = min(15, 连续天数 × 0.6)
    targetApproval += 奖励
```

### 财富趋势修正

```javascript
// 比较近10天和前10天财富均值
trend = (近期均值 - 过去均值) / 过去均值
trendBonus = min(15, |trend| × 50)

if (trend > 0.05): targetApproval += trendBonus  // 财富增长
if (trend < -0.05): targetApproval -= trendBonus  // 财富下降
```

---

## 3.2 满意度渐变

满意度以**每日2%**速度向目标值靠拢（`approval.js` L165-168）：

```javascript
adjustmentSpeed = 0.02
newApproval = currentApproval + (targetApproval - currentApproval) × 0.02
```

这意味着满意度不会突变，需要持续改善条件才能提升。

---

## 3.3 法令效果

法令效果**直接叠加**到最终满意度，不受渐变影响（`approval.js` L173-181）：

```javascript
newApproval += decreeApprovalModifiers[key]
```

---

# 第四章：需求消费系统

## 4.1 基础需求

每个阶层有固定的基础需求（`strata.js` needs字段）：

| 阶层 | 粮食需求 | 布料需求 |
|-----|---------|---------|
| 佃农 | 0.36 | 0.05 |
| 自耕农 | 0.42 | 0.06 |
| 工人 | 0.52 | 0.09 |
| 商人 | 0.70 | 0.14 |
| 资本家 | 1.00 | 0.16 |

基础需求**必须满足**，否则严重影响满意度和劳动效率。

---

## 4.2 奢侈需求解锁

奢侈需求按**财富乘数阈值**解锁（`needs.js` L106-116）：

```javascript
// 遍历所有阈值
luxuryThresholds.forEach(threshold => {
    if (unlockMultiplier >= threshold) {
        // 解锁该阈值的所有奢侈品需求
        // 实际消费量 = 配置量 × luxuryConsumptionMultiplier
    }
})
```

### 商人奢侈需求示例（`strata.js` L228-236）

```javascript
luxuryNeeds: {
    1.0: { delicacies: 0.60, spice: 0.20, furniture: 0.12, ... },
    1.5: { coffee: 0.14 },
    2.0: { delicacies: 0.35, plank: 0.12, brick: 0.05, culture: 0.20 },
    3.0: { steel: 0.05, coal: 0.03 },
    // ...更高阈值
}
```

---

## 4.3 消费能力上限

底层阶级有消费上限限制（`strata.js`）：

```javascript
maxConsumptionMultiplier: 
    底层(peasant, serf, worker等) = 3
    中层(artisan, merchant等) = 6
    上层(official, landowner等) = 10-50
```

这防止底层阶级因补贴导致消费爆炸。

---

# 第五章：满意度效果（Buffs）

## 5.1 效果类型

满意度高/低时触发不同效果：

### 经济效果
- `taxIncome`: 税收收入修正
- `production`: 生产效率修正
- `industryBonus`: 工业加成
- `gatherBonus`: 采集加成

### 军事效果
- `militaryPower`: 军事力量修正

### 稳定效果
- `stability`: 稳定度修正
- `cultureBonus`: 文化产出修正
- `scienceBonus`: 科研产出修正

---

## 5.2 各阶层效果

| 阶层 | 满意时效果 | 不满时效果 |
|-----|-----------|-----------|
| 自耕农 | 税收+10%，生产+5% | 税收-20%，生产-10% |
| 工人 | 工业+15% | 工业-25%（罢工）|
| 军人 | 军力+20% | 军力-30%，稳定-20% |
| 骑士 | 军力+25%，稳定+10% | 军力-20%，稳定-15% |
| 地主 | 税收+15%，稳定+15% | 税收-30%，稳定-25%（叛乱）|
| 资本家 | 工业+25%，科研+15% | 工业-30%，税收-25%（外逃）|
| 官员 | 税收+10% | 税收-20%（腐败）|

---

# 第六章：影响力系统

## 6.1 影响力计算

阶层影响力决定执政联盟和政治权重：

```javascript
影响力 = influenceBase × 人口数 + (财富占比 × 10)

// 其中：
// - influenceBase: 阶层基础影响力（0.3-6.0）
// - 财富占比: 该阶层财富 / 全国总财富
```

---

## 6.2 执政联盟

影响力最高的几个阶层组成执政联盟：
- 联盟成员满意度对稳定度权重更高
- 某些政治立场要求特定阶层在联盟内

---

# 第七章：玩法策略

## 7.1 满意度管理

1. **保障基础需求**：粮食和布料短缺会直接锁死满意度
2. **渐进税制**：突然加税会触发税收冲击
3. **改善生活水平**：生活水平限制满意度上限
4. **利用法令**：法令效果立即生效

## 7.2 阶层经营

1. **底层阶层**：人数多但消费谨慎，税收效率低
2. **中层阶层**：平衡发展，贸易和专业生产
3. **上层阶层**：影响力大但人数少，不满后果严重

## 7.3 财富分配

1. 高收入阶层（商人、资本家）消费能力强
2. 低收入阶层需要补贴才能解锁奢侈品
3. 官员贪婪模式使其消费特别高

## 7.4 危机应对

1. **赤贫危机**：满意度上限30，每天-2.5惩罚，需紧急补贴
2. **基础短缺**：满意度直接锁30或0，需增产或进口
3. **财富下降**：触发负面趋势惩罚，需稳定经济

---

# 附录：阶层属性速查表

| 阶层 | 弹性 | 上限 | 食需 | 布需 | 税基 |
|-----|-----|-----|-----|-----|-----|
| serf | 0.4 | 3 | 0.36 | 0.05 | 0.015 |
| peasant | 0.5 | 3 | 0.42 | 0.06 | 0.01 |
| lumberjack | 0.6 | 3 | 0.46 | 0.07 | 0.02 |
| miner | 0.6 | 4 | 0.56 | 0.10 | 0.025 |
| worker | 0.7 | 3 | 0.52 | 0.09 | 0.03 |
| artisan | 0.8 | 6 | 0.62 | 0.11 | 0.035 |
| soldier | 0.6 | 6 | 0.60 | 0.10 | 0.04 |
| scribe | 1.0 | 6 | 0.62 | 0.11 | 0.04 |
| cleric | 0.9 | 6 | 0.65 | 0.11 | 0.05 |
| navigator | 0.7 | 6 | 0.60 | 0.10 | 0.06 |
| merchant | 1.5 | 10 | 0.70 | 0.14 | 0.09 |
| official | 2.5 | 50 | 0.85 | 0.14 | 0.08 |
| landowner | 1.4 | 10 | 0.95 | 0.15 | 0.07 |
| knight | 1.0 | 10 | 0.90 | 0.14 | 0.09 |
| engineer | 1.1 | 10 | 0.75 | 0.12 | 0.1 |
| capitalist | 1.8 | 10 | 1.00 | 0.16 | 0.08 |
| unemployed | 0.3 | 3 | 0.30 | 0.04 | 0.01 |
