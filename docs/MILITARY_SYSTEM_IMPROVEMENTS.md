# 军事系统改进 - 动态敌军与战争消耗机制

## 改进概述

本次更新对军事系统进行了重大改进，实现了以下核心功能：

1. **敌方兵种随时代动态升级**：敌方军队的兵种组合会根据国家所处的时代自动调整
2. **战争消耗机制**：持续的战争会削弱敌方的军事实力、财富和人口
3. **战后恢复机制**：和平状态下，敌方国家会逐渐恢复实力

## 详细改进内容

### 1. 动态兵种系统

#### 新增函数：`getEnemyUnitsForEpoch(epoch, actionType)`

根据时代和行动类型返回合适的兵种池：

**时代兵种配置：**

- **石器时代 (0)**：民兵、投石兵
- **青铜时代 (1)**：长矛兵、弓箭手、轻骑兵、剑士
- **古典时代 (2)**：重装步兵、弩兵、骑士
- **封建时代 (3)**：重装步兵、弩兵、骑士
- **工业时代 (4)**：火枪兵、龙骑兵、火炮
- **现代 (5)**：步枪兵、现代步兵、坦克、火炮
- **信息时代 (6)**：现代步兵、坦克、现代火炮

**行动类型：**

- `light`：轻型兵种组（用于边境掠夺、突袭）
- `medium`：中型兵种组（用于正面攻势）
- `heavy`：重型兵种组（用于围城压制）

#### 敌方时代计算

敌方的实际时代基于：
- 国家的出现时代（`appearEpoch`）
- 国家的消失时代（`expireEpoch`）
- 玩家当前时代（`epoch`）

```javascript
const enemyEpoch = Math.max(
  nation.appearEpoch || 0, 
  Math.min(playerEpoch, nation.expireEpoch ?? playerEpoch)
);
```

这确保了：
- 早期时代的国家不会使用高级兵种
- 后期时代的国家会使用更强大的兵种
- 敌方兵种不会超过玩家当前时代太多

### 2. 战争消耗机制

#### 新增国家属性

每个国家现在拥有以下新属性：

- **`militaryStrength`** (0.2-1.0)：军事实力，初始为1.0（满实力）
- **`population`** (100+)：国家人口，影响兵力规模
- **`economyTraits.baseWealth`**：基础财富，用于战后恢复
- **`economyTraits.basePopulation`**：基础人口，用于战后恢复

#### 战斗中的消耗

每次战斗胜利后，敌方会遭受以下损失：

**军事实力削弱：**
```javascript
const militaryStrengthDamage = Math.min(
  0.15, // 单次最多削弱15%
  enemyLossCount * 0.005 + wealthDamage / 10000
);
```

**人口损失：**
```javascript
const populationLoss = Math.floor(enemyLossCount * 0.8);
// 每个士兵损失对应0.8人口损失
```

**财富损失：**
```javascript
const wealthDamage = Math.min(
  targetNation.wealth,
  Math.max(50, enemyLossCount * wealthDamagePerUnit)
);
```

#### 实力对兵力的影响

敌方生成的军队规模受多个因素影响：

```javascript
const overallStrength = 
  militaryStrength *      // 军事实力 (0.2-1.0)
  wealthFactor *          // 财富因素 (0.3-1.5)
  aggressionFactor *      // 侵略性 (1.0-1.8)
  warScoreFactor;         // 战争分数 (0.5-2.0+)

const enemyTotalUnits = Math.floor(baseUnitCount * overallStrength);
```

这意味着：
- 初次交战时，敌方兵力最强（100%实力）
- 持续战斗后，敌方兵力逐渐减少
- 财富被掏空后，敌方难以维持大规模军队
- 人口损失会进一步限制兵力恢复

### 3. 战后恢复机制

#### 恢复条件

只有在**和平状态**下，国家才会恢复实力：

```javascript
if (!nation.isAtWar) {
  // 执行恢复逻辑
}
```

#### 恢复速率

**军事实力恢复：**
- 每tick恢复0.5%
- 约200 ticks（3-4分钟游戏时间）恢复满

**财富恢复：**
- 每tick恢复基础财富的0.2%
- 逐渐恢复到初始财富水平

**人口恢复：**
- 每tick恢复基础人口的0.3%
- 逐渐恢复到初始人口水平

#### 恢复上限

所有恢复都有上限，不会超过初始值：

```javascript
militaryStrength = Math.min(1.0, currentStrength + recoveryRate);
wealth = Math.min(baseWealth, currentWealth + wealthRecoveryRate);
population = Math.min(basePopulation, currentPopulation + populationRecoveryRate);
```

### 4. UI显示改进

#### 军事面板（MilitaryTab）

新增显示：
- **军事实力**：显示敌方当前军事实力百分比
- **人口**：显示敌方当前人口数量

```
战争分数：15  敌军损失：45  财富：650  军事实力：75%  人口：850
```

#### 外交面板（DiplomacyTab）

新增显示：
- **实力**：带颜色标识的军事实力百分比
  - 绿色：>70%（强大）
  - 黄色：40-70%（中等）
  - 红色：<40%（虚弱）

```
分数: 15  天数: 8  损失: 45  实力: 75%
```

## 游戏体验改进

### 战争策略深度提升

1. **早期战争更容易**：石器时代的敌人只有民兵和投石兵，容易击败
2. **后期战争更具挑战**：现代敌人拥有坦克和火炮，需要精心准备
3. **持续战争有意义**：每次胜利都会削弱敌方，最终可以"打光敌方主力"
4. **和平有价值**：给敌方恢复时间会让下次战争更困难

### 战术选择

**速战速决：**
- 在敌方实力满时发动多次进攻
- 快速削弱敌方军事实力
- 在敌方恢复前结束战争

**持久战：**
- 逐步消耗敌方财富和人口
- 等待敌方实力降低到安全水平
- 发动决定性打击

**和平谈判时机：**
- 敌方实力<40%时，更容易接受和平
- 敌方财富耗尽时，赔款能力有限
- 考虑是否给敌方恢复时间

## 技术实现细节

### 修改的文件

1. **`src/config/militaryActions.js`**
   - 新增 `getEnemyUnitsForEpoch()` 函数
   - 修改军事行动配置，添加 `unitScale` 和 `baseUnitCount`

2. **`src/hooks/useGameActions.js`**
   - 修改 `launchBattle()` 函数，使用动态兵种生成
   - 添加军事实力和人口削弱逻辑

3. **`src/logic/simulation.js`**
   - 修改突袭军队生成逻辑
   - 添加战后恢复机制

4. **`src/hooks/useGameState.js`**
   - 初始化国家的军事实力和人口属性

5. **`src/components/tabs/MilitaryTab.jsx`**
   - 添加军事实力和人口显示

6. **`src/components/tabs/DiplomacyTab.jsx`**
   - 添加军事实力显示（带颜色标识）

### 数据流

```
战斗发起
  ↓
计算敌方时代 → 获取兵种池 → 计算综合实力 → 生成敌方军队
  ↓
战斗模拟
  ↓
战斗结果 → 削弱敌方实力/财富/人口 → 更新国家状态
  ↓
和平状态 → 逐渐恢复实力/财富/人口
```

## 平衡性考虑

### 削弱速率

- 单次战斗最多削弱15%军事实力
- 需要7-8次胜利才能将敌方削弱到最低（20%）
- 确保玩家需要多次战斗才能完全压制敌方

### 恢复速率

- 军事实力：3-4分钟恢复满
- 财富/人口：根据损失程度，5-10分钟恢复
- 给玩家足够时间发动连续进攻，但也不会让敌方永久虚弱

### 最低保障

- 军事实力最低20%（确保敌方始终有一定威胁）
- 人口最低100（确保国家不会完全消失）
- 财富最低0（可以完全掏空）

## 未来扩展建议

1. **不同国家的恢复速率**：商业国家财富恢复快，军事国家实力恢复快
2. **战争疲劳**：长期战争降低恢复速率
3. **盟友支援**：其他国家可以帮助恢复
4. **占领机制**：彻底击败后可以占领敌方领土
5. **和平条约**：可以要求敌方限制军事实力恢复

## 测试建议

1. **测试早期战争**：在石器时代与"石斧部族"交战，验证敌方只使用低级兵种
2. **测试后期战争**：在现代与敌人交战，验证敌方使用坦克和火炮
3. **测试持续战争**：连续发动5-10次进攻，观察敌方实力下降
4. **测试恢复机制**：停战后等待几分钟，观察敌方实力恢复
5. **测试UI显示**：检查军事面板和外交面板的新信息显示

## 已知问题

无

## 更新日期

2025-12-02
