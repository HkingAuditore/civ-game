# 修复：军力与财富经济约束系统

**日期**: 2026-02-04  
**版本**: v5  
**问题严重性**: 🔴 严重逻辑错误

---

## 🐛 问题描述

### 核心问题
游戏中出现了**严重违反经济逻辑**的情况：
- **人口**: 22.2亿
- **财富**: 89
- **军力**: 2亿+

**人均财富**: 89 ÷ 2,220,000,000 = **0.00000004**

### 问题分析

这种情况在现实中是**完全不可能**的：

1. **22亿人只有89财富** → 应该早就饿死了
2. **人均财富0.00000004** → 根本养不起军队
3. **却有2亿军力** → 完全违反经济规律

### 根本原因

#### 1. 军力计算无经济约束
```javascript
// 旧代码（错误）
const baseArmySize = Math.floor(
    population * militaryStrength * 0.006 * epochFactor * difficultyMultiplier
);
```

**只看人口，完全不看财富！**

#### 2. 财富增长机制缺陷
- `ownBaseWealth` 初始值过低（500-1000）
- 增长速率过慢（每10 tick才增长1-2%）
- 无法跟上人口增长速度
- 没有"追赶机制"来修正过低的人均财富

#### 3. 缺少饥荒死亡机制
- 人均财富极低时，只是减速增长
- 没有大规模死亡机制
- 人口可以在极度贫困下继续增长

---

## ✅ 解决方案

### 方案A：军力计算添加财富约束

**文件**: `src/config/militaryUnits.js`  
**函数**: `generateNationArmy()`

#### 修改内容

添加**财富约束系数**，基于人均财富限制军队规模：

```javascript
// 计算人均财富
const wealth = nation?.wealth || 500;
const wealthPerCapita = wealth / Math.max(1, population);

// 财富约束系数
let wealthConstraint = 1.0;
if (wealthPerCapita < 0.5) {
    // 极度贫困：军队规模削减到5%以下
    wealthConstraint = Math.max(0.05, wealthPerCapita * 0.1);
} else if (wealthPerCapita < 5) {
    // 贫困：军队规模10%-50%
    wealthConstraint = 0.05 + (wealthPerCapita - 0.5) / 4.5 * 0.45;
} else if (wealthPerCapita < 20) {
    // 正常：军队规模50%-100%
    wealthConstraint = 0.5 + (wealthPerCapita - 5) / 15 * 0.5;
}
// wealthPerCapita >= 20: 无约束 (100%)

// 应用约束
const baseArmySize = Math.floor(
    population * militaryStrength * 0.006 * 
    epochFactor * difficultyMultiplier * wealthConstraint
);
```

#### 效果

| 人均财富 | 军队规模 | 说明 |
|---------|---------|------|
| < 0.5 | < 5% | 极度贫困，几乎无军队 |
| 0.5 - 5 | 5% - 50% | 贫困，军队受限 |
| 5 - 20 | 50% - 100% | 正常，逐渐恢复 |
| ≥ 20 | 100% | 富裕，无约束 |

**示例**：
- 人均财富 0.00000004 → 军队规模削减到 **0.000004%**
- 22亿人口 → 理论军队1320万 × 0.000004% = **约53人**

---

### 方案C：修复财富增长机制

**文件**: `src/logic/diplomacy/aiEconomy.js`  
**函数**: `processAIIndependentGrowth()`

#### 修改1：添加追赶机制

当人均财富低于目标时，给予额外增长：

```javascript
const targetPerCapitaWealth = 50;  // 目标人均财富基准

// 追赶奖励
let catchUpBonus = 0;
if (currentPerCapitaWealth < targetPerCapitaWealth) {
    const wealthGap = (targetPerCapitaWealth - currentPerCapitaWealth) / targetPerCapitaWealth;
    catchUpBonus = Math.min(0.05, wealthGap * 0.1);  // 最多+5%
}
```

#### 修改2：提高增长上限

```javascript
// 旧值：0.03 (3%)
// 新值：0.08 (8%)
const cappedWealthRate = clamp(rawWealthRate, -0.02, 0.08);
```

#### 修改3：调整人均财富上限

```javascript
// 旧值：2000 * 2^epoch (2k, 4k, 8k, 16k, 32k)
// 新值：3000 * 2^epoch (3k, 6k, 12k, 24k, 48k)
const perCapitaWealthCap = Math.min(100000, 3000 * Math.pow(2, Math.min(epoch, 4)));
```

#### 修改4：提高发展奖励

```javascript
// 旧值：0.005
// 新值：0.01
const developmentBonus = (developmentRate - 1) * 0.01;
```

---

### 方案B+：添加饥荒死亡机制

**文件**: `src/logic/diplomacy/aiEconomy.js`  
**函数**: `updateAIDevelopment()`

#### 修改内容

当人均财富极低时，触发人口崩溃：

```javascript
const wealthPerCapita = currentWealth / Math.max(1, next.population);

if (wealthPerCapita < 0.5) {
    // 极度贫困：每次更新损失5-15%人口（饥荒）
    const starvationSeverity = Math.max(0, (0.5 - wealthPerCapita) / 0.5);
    const starvationRate = 0.05 + starvationSeverity * 0.1;  // 5%-15%
    const deaths = Math.floor(next.population * starvationRate * tickScaleFactor);
    next.population = Math.max(3, next.population - deaths);
    
    console.warn(`[FAMINE] ${next.name}: 人均财富${wealthPerCapita.toFixed(4)}过低，触发饥荒`);
} else if (wealthPerCapita < 2) {
    // 严重贫困：每次更新损失1-3%人口
    const povertyRate = 0.01 + (2 - wealthPerCapita) / 1.5 * 0.02;
    const deaths = Math.floor(next.population * povertyRate * tickScaleFactor);
    next.population = Math.max(3, next.population - deaths);
}
```

#### 效果

| 人均财富 | 人口损失率 | 说明 |
|---------|-----------|------|
| < 0.1 | 10-15% | 极度饥荒 |
| 0.1 - 0.5 | 5-10% | 严重饥荒 |
| 0.5 - 2 | 1-3% | 贫困 |
| ≥ 2 | 0% | 正常 |

---

## 📊 预期效果

### 修复前（错误）
```
人口: 22.2亿
财富: 89
人均财富: 0.00000004
军力: 2亿+
```

### 修复后（正确）

#### 情况1：财富增长追上人口
```
人口: 22.2亿
财富: 1110亿（追赶机制生效）
人均财富: 50
军力: 1320万（正常）
```

#### 情况2：人口因饥荒崩溃
```
人口: 22.2亿 → 饥荒 → 100万（崩溃）
财富: 89
人均财富: 0.089 → 饥荒后恢复到正常
军力: 几乎为0（贫困约束）
```

---

## 🎯 核心改进

### 1. 经济约束系统
- ✅ 军队规模受财富约束
- ✅ 人均财富过低时军队大幅削减
- ✅ 符合经济规律

### 2. 财富追赶机制
- ✅ 人均财富过低时加速增长
- ✅ 防止财富与人口脱钩
- ✅ 目标人均财富：50

### 3. 饥荒死亡机制
- ✅ 极度贫困触发大规模死亡
- ✅ 防止不合理的人口增长
- ✅ 经济崩溃导致人口崩溃

### 4. 平衡调整
- ✅ 提高财富增长上限（3% → 8%）
- ✅ 提高人均财富上限（2k → 3k基准）
- ✅ 提高发展奖励（0.5% → 1%）

---

## 🔍 测试建议

### 测试场景1：正常发展
1. 观察AI国家人口和财富是否同步增长
2. 人均财富应该维持在20-100之间
3. 军队规模应该合理（人口的0.6%左右）

### 测试场景2：经济崩溃
1. 人为降低AI国家财富到极低值
2. 观察是否触发饥荒机制
3. 人口应该大幅下降
4. 军队规模应该接近0

### 测试场景3：战争影响
1. AI国家进入战争状态
2. 观察财富和人口的损失
3. 军队规模应该随经济衰退而减少

---

## 📝 总结

这次修复解决了游戏中**最严重的经济逻辑错误**：

1. **军力不再脱离经济现实** - 贫困国家无法维持大军
2. **财富能够跟上人口增长** - 追赶机制防止脱钩
3. **极度贫困导致人口崩溃** - 符合历史规律

**核心理念**：
> 经济是一切的基础。没有财富，就没有军队；  
> 没有粮食，就没有人口；  
> 这是铁律。

---

**修改文件**：
1. `src/config/militaryUnits.js` - 军力计算添加财富约束
2. `src/logic/diplomacy/aiEconomy.js` - 财富增长机制和饥荒系统

**影响范围**：
- AI国家军力计算
- AI国家财富增长
- AI国家人口动态
- 游戏经济平衡

**版本**: v5  
**状态**: ✅ 已实施
