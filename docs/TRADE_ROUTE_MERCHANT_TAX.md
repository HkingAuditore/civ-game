# è´¸æ˜“è·¯çº¿å•†äººç¨æ”¶æœºåˆ¶

## ä¿®æ”¹æ—¥æœŸ
2025-12-04

## æ¦‚è¿°
æœ¬æ¬¡ä¿®æ”¹å°†è´¸æ˜“è·¯çº¿çš„é€»è¾‘ä»"ç©å®¶ç›´æ¥è·å¾—è´¸æ˜“åˆ©æ¶¦"æ”¹ä¸º"å•†äººç¾¤ä½“è¿›è¡Œäº¤æ˜“ï¼Œç©å®¶åªèµšå–äº¤æ˜“ç¨"ï¼Œä½¿æ¸¸æˆæœºåˆ¶æ›´åŠ çœŸå®å’Œåˆç†ã€‚

## ä¿®æ”¹å†…å®¹

### 1. å‡ºå£æœºåˆ¶

#### ä¿®æ”¹å‰
- ç©å®¶ç›´æ¥ä»¥å›½å†…ä»·æ ¼è´­ä¹°èµ„æº
- ç©å®¶ç›´æ¥ä»¥å›½å¤–ä»·æ ¼å‡ºå”®èµ„æº
- ç©å®¶è·å¾—å…¨éƒ¨åˆ©æ¶¦ï¼š`åˆ©æ¶¦ = (å›½å¤–ä»· - å›½å†…ä»·) Ã— æ•°é‡`

#### ä¿®æ”¹å
- **å•†äººç¾¤ä½“**åœ¨å›½å†…ä»¥å›½å†…å¸‚åœºä»·è´­ä¹°èµ„æº
- **å•†äººç¾¤ä½“**åœ¨å›½å¤–ä»¥å›½å¤–å¸‚åœºä»·å‡ºå”®èµ„æº
- **å•†äººç¾¤ä½“**è·å¾—è´¸æ˜“åˆ©æ¶¦ï¼š`å•†äººåˆ©æ¶¦ = (å›½å¤–ä»· - å›½å†…ä»·) Ã— æ•°é‡`
- **ç©å®¶**åªè·å¾—å•†äººåœ¨å›½å†…è´­ä¹°æ—¶çš„äº¤æ˜“ç¨ï¼š`ç©å®¶ç¨æ”¶ = å›½å†…ä»· Ã— æ•°é‡ Ã— äº¤æ˜“ç¨ç‡`

#### ç¤ºä¾‹
å‡è®¾ï¼š
- èµ„æºï¼šé£Ÿç‰©
- å›½å†…ä»·æ ¼ï¼š5 é“¶å¸/å•ä½
- å›½å¤–ä»·æ ¼ï¼š8 é“¶å¸/å•ä½
- å‡ºå£æ•°é‡ï¼š10 å•ä½
- äº¤æ˜“ç¨ç‡ï¼š5%

**å•†äººçš„äº¤æ˜“ï¼š**
- å›½å†…è´­ä¹°æˆæœ¬ï¼š5 Ã— 10 = 50 é“¶å¸
- å›½å¤–é”€å”®æ”¶å…¥ï¼š8 Ã— 10 = 80 é“¶å¸
- å•†äººåˆ©æ¶¦ï¼š80 - 50 = 30 é“¶å¸

**ç©å®¶çš„æ”¶ç›Šï¼š**
- äº¤æ˜“ç¨ï¼š50 Ã— 0.05 = 2.5 é“¶å¸

### 2. è¿›å£æœºåˆ¶

#### ä¿®æ”¹å‰
- ç©å®¶ç›´æ¥ä»¥å›½å¤–ä»·æ ¼è´­ä¹°èµ„æº
- ç©å®¶ç›´æ¥ä»¥å›½å†…ä»·æ ¼å‡ºå”®èµ„æº
- ç©å®¶è·å¾—å…¨éƒ¨åˆ©æ¶¦ï¼š`åˆ©æ¶¦ = (å›½å†…ä»· - å›½å¤–ä»·) Ã— æ•°é‡`

#### ä¿®æ”¹å
- **å•†äººç¾¤ä½“**åœ¨å›½å¤–ä»¥å›½å¤–å¸‚åœºä»·è´­ä¹°èµ„æº
- **å•†äººç¾¤ä½“**åœ¨å›½å†…ä»¥å›½å†…å¸‚åœºä»·å‡ºå”®èµ„æº
- **å•†äººç¾¤ä½“**è·å¾—è´¸æ˜“åˆ©æ¶¦ï¼š`å•†äººåˆ©æ¶¦ = (å›½å†…ä»· - å›½å¤–ä»·) Ã— æ•°é‡`
- **ç©å®¶**åªè·å¾—å•†äººåœ¨å›½å†…é”€å”®æ—¶çš„äº¤æ˜“ç¨ï¼š`ç©å®¶ç¨æ”¶ = å›½å†…ä»· Ã— æ•°é‡ Ã— äº¤æ˜“ç¨ç‡`

#### ç¤ºä¾‹
å‡è®¾ï¼š
- èµ„æºï¼šæœ¨æ
- å›½å¤–ä»·æ ¼ï¼š3 é“¶å¸/å•ä½
- å›½å†…ä»·æ ¼ï¼š6 é“¶å¸/å•ä½
- è¿›å£æ•°é‡ï¼š10 å•ä½
- äº¤æ˜“ç¨ç‡ï¼š5%

**å•†äººçš„äº¤æ˜“ï¼š**
- å›½å¤–è´­ä¹°æˆæœ¬ï¼š3 Ã— 10 = 30 é“¶å¸
- å›½å†…é”€å”®æ”¶å…¥ï¼š6 Ã— 10 = 60 é“¶å¸
- å•†äººåˆ©æ¶¦ï¼š60 - 30 = 30 é“¶å¸

**ç©å®¶çš„æ”¶ç›Šï¼š**
- äº¤æ˜“ç¨ï¼š60 Ã— 0.05 = 3 é“¶å¸

## ä»£ç ä¿®æ”¹

### 1. useGameLoop.js - processTradeRoutes å‡½æ•°

#### å‡ºå£é€»è¾‘ä¿®æ”¹
```javascript
// ä¿®æ”¹å‰
const purchaseCost = localPrice * exportAmount;
const saleRevenue = foreignPrice * exportAmount;
const profit = saleRevenue - purchaseCost;
setResources(prev => ({
  ...prev,
  silver: (prev.silver || 0) + profit,
  [resource]: Math.max(0, (prev[resource] || 0) - exportAmount),
}));

// ä¿®æ”¹å
const domesticPurchaseCost = localPrice * exportAmount;
const taxRate = taxPolicies?.resourceTaxRates?.[resource] || 0;
const tradeTax = domesticPurchaseCost * taxRate;
const foreignSaleRevenue = foreignPrice * exportAmount;
const merchantProfit = foreignSaleRevenue - domesticPurchaseCost;

setResources(prev => ({
  ...prev,
  silver: (prev.silver || 0) + tradeTax,  // ç©å®¶åªè·å¾—äº¤æ˜“ç¨
  [resource]: Math.max(0, (prev[resource] || 0) - exportAmount),
}));
```

#### è¿›å£é€»è¾‘ä¿®æ”¹
```javascript
// ä¿®æ”¹å‰
const purchaseCost = foreignPrice * importAmount;
const saleRevenue = localPrice * importAmount;
const profit = saleRevenue - purchaseCost;
setResources(prev => ({
  ...prev,
  silver: (prev.silver || 0) + profit,
  [resource]: (prev[resource] || 0) + importAmount,
}));

// ä¿®æ”¹å
const foreignPurchaseCost = foreignPrice * importAmount;
const domesticSaleRevenue = localPrice * importAmount;
const taxRate = taxPolicies?.resourceTaxRates?.[resource] || 0;
const tradeTax = domesticSaleRevenue * taxRate;
const merchantProfit = domesticSaleRevenue - foreignPurchaseCost;

setResources(prev => ({
  ...prev,
  silver: (prev.silver || 0) + tradeTax,  // ç©å®¶åªè·å¾—äº¤æ˜“ç¨
  [resource]: (prev[resource] || 0) + importAmount,
}));
```

#### è¿”å›å€¼ä¿®æ”¹
```javascript
// ä¿®æ”¹å‰
return { income: totalIncome, expense: totalExpense };

// ä¿®æ”¹å
return { tradeTax: totalTradeTax };
```

### 2. æ—¥å¿—æ˜¾ç¤ºä¿®æ”¹

#### å‡ºå£æ—¥å¿—
```javascript
// ä¿®æ”¹å‰
tradeLog.push(`ğŸš¢ å‡ºå£ ${exportAmount.toFixed(1)} ${RESOURCES[resource]?.name || resource} è‡³ ${nation.name}ï¼ˆå›½å†…ä»· ${localPrice.toFixed(1)} â†’ å›½å¤–ä»· ${foreignPrice.toFixed(1)}ï¼‰ï¼Œ${profitText} é“¶å¸ã€‚`);

// ä¿®æ”¹å
tradeLog.push(`ğŸš¢ å‡ºå£ ${exportAmount.toFixed(1)} ${RESOURCES[resource]?.name || resource} è‡³ ${nation.name}ï¼šå•†äººå›½å†…è´­ ${domesticPurchaseCost.toFixed(1)} é“¶å¸ï¼ˆç¨ ${tradeTax.toFixed(1)}ï¼‰ï¼Œå›½å¤–å”® ${foreignSaleRevenue.toFixed(1)} é“¶å¸ï¼Œå•†äººèµš ${merchantProfit.toFixed(1)} é“¶å¸ã€‚`);
```

#### è¿›å£æ—¥å¿—
```javascript
// ä¿®æ”¹å‰
tradeLog.push(`ğŸš¢ è¿›å£ ${importAmount.toFixed(1)} ${RESOURCES[resource]?.name || resource} ä» ${nation.name}ï¼ˆå›½å¤–ä»· ${foreignPrice.toFixed(1)} â†’ å›½å†…ä»· ${localPrice.toFixed(1)}ï¼‰ï¼Œ${profitText} é“¶å¸ã€‚`);

// ä¿®æ”¹å
tradeLog.push(`ğŸš¢ è¿›å£ ${importAmount.toFixed(1)} ${RESOURCES[resource]?.name || resource} ä» ${nation.name}ï¼šå•†äººå›½å¤–è´­ ${foreignPurchaseCost.toFixed(1)} é“¶å¸ï¼Œå›½å†…å”® ${domesticSaleRevenue.toFixed(1)} é“¶å¸ï¼ˆç¨ ${tradeTax.toFixed(1)}ï¼‰ï¼Œå•†äººèµš ${merchantProfit.toFixed(1)} é“¶å¸ã€‚`);
```

### 3. ç¨æ”¶é¢æ¿æ˜¾ç¤ºä¿®æ”¹

#### StatusBar.jsx
```javascript
// ä¿®æ”¹å‰
const tradeIncome = tradeStats?.income || 0;
const tradeExpense = tradeStats?.expense || 0;
const tradeNet = tradeIncome - tradeExpense;

// ç¨æ”¶è¯¦æƒ…æ˜¾ç¤º
<div className="flex justify-between py-1 border-b border-gray-800">
  <span>è´¸æ˜“è·¯çº¿</span>
  <div className="text-right">
    <span className={`${tradeNetClass} font-mono block`}>
      {tradeNet >= 0 ? '+' : ''}{tradeNet.toFixed(2)}
    </span>
    <span className="text-[10px] text-gray-500">
      æ”¶ {tradeIncome.toFixed(1)} / æ”¯ {tradeExpense.toFixed(1)}
    </span>
  </div>
</div>

// ä¿®æ”¹å
const tradeTax = tradeStats?.tradeTax || 0;

// ç¨æ”¶è¯¦æƒ…æ˜¾ç¤º
<div className="flex justify-between py-1 border-b border-gray-800">
  <span>è´¸æ˜“è·¯çº¿ç¨</span>
  <span className={`${tradeTaxClass} font-mono`}>
    {tradeTax >= 0 ? '+' : ''}{tradeTax.toFixed(2)}
  </span>
</div>
```

#### App.jsx
```javascript
// ä¿®æ”¹å‰
const tradeStats = gameState.tradeStats || { income: 0, expense: 0 };
const tradeNet = (tradeStats.income || 0) - (tradeStats.expense || 0);
const netSilverPerDay = taxes.total + tradeNet - silverUpkeepPerDay;

// ä¿®æ”¹å
const tradeStats = gameState.tradeStats || { tradeTax: 0 };
const tradeTax = tradeStats.tradeTax || 0;
const netSilverPerDay = taxes.total + tradeTax - silverUpkeepPerDay;
```

### 4. çŠ¶æ€ç®¡ç†ä¿®æ”¹

#### useGameState.js
```javascript
// ä¿®æ”¹å‰
const [tradeStats, setTradeStats] = useState({ income: 0, expense: 0 });

// å­˜æ¡£åŠ è½½
setTradeStats(data.tradeStats || { income: 0, expense: 0 });

// ä¿®æ”¹å
const [tradeStats, setTradeStats] = useState({ tradeTax: 0 });

// å­˜æ¡£åŠ è½½
setTradeStats(data.tradeStats || { tradeTax: 0 });
```

#### useGameLoop.js
```javascript
// ä¿®æ”¹å‰
let tradeSummary = { income: 0, expense: 0 };
if (current.tradeRoutes && current.tradeRoutes.routes && current.tradeRoutes.routes.length > 0) {
  const summary = processTradeRoutes(current, result, addLog, setResources, setNations, setTradeRoutes);
  if (summary) {
    tradeSummary = summary;
  }
}
setTradeStats(tradeSummary);

// ä¿®æ”¹å
let tradeTax = 0;
if (current.tradeRoutes && current.tradeRoutes.routes && current.tradeRoutes.routes.length > 0) {
  const summary = processTradeRoutes(current, result, addLog, setResources, setNations, setTradeRoutes);
  if (summary) {
    tradeTax = summary.tradeTax || 0;
  }
}
setTradeStats({ tradeTax });
```

## æ¸¸æˆå¹³è¡¡å½±å“

### 1. ç©å®¶æ”¶ç›Šé™ä½
- ä¿®æ”¹å‰ï¼šç©å®¶è·å¾—å…¨éƒ¨è´¸æ˜“åˆ©æ¶¦
- ä¿®æ”¹åï¼šç©å®¶åªè·å¾—äº¤æ˜“ç¨ï¼ˆé€šå¸¸ä¸ºäº¤æ˜“é¢çš„5%ï¼‰
- **å½±å“**ï¼šè´¸æ˜“è·¯çº¿çš„æ”¶ç›Šå¤§å¹…é™ä½ï¼Œç©å®¶éœ€è¦æ›´å¤šä¾èµ–å…¶ä»–æ”¶å…¥æ¥æº

### 2. ç¨ç‡çš„é‡è¦æ€§æå‡
- äº¤æ˜“ç¨ç‡ç›´æ¥å½±å“è´¸æ˜“è·¯çº¿çš„æ”¶ç›Š
- ç©å®¶å¯ä»¥é€šè¿‡è°ƒæ•´äº¤æ˜“ç¨ç‡æ¥å¹³è¡¡è´¢æ”¿æ”¶å…¥å’Œå¸‚åœºæ´»åŠ›
- é«˜ç¨ç‡å¢åŠ æ”¶å…¥ä½†å¯èƒ½æŠ‘åˆ¶è´¸æ˜“

### 3. æ›´çœŸå®çš„ç»æµæ¨¡æ‹Ÿ
- å•†äººé˜¶çº§æˆä¸ºçœŸæ­£çš„è´¸æ˜“ä¸»ä½“
- ç©å®¶ä½œä¸ºç»Ÿæ²»è€…ï¼Œé€šè¿‡ç¨æ”¶è€Œéç›´æ¥è´¸æ˜“è·åˆ©
- ç¬¦åˆå†å²ä¸Šçš„è´¸æ˜“å’Œç¨æ”¶æ¨¡å¼

## æµ‹è¯•å»ºè®®

### 1. åŸºç¡€åŠŸèƒ½æµ‹è¯•
- åˆ›å»ºå‡ºå£è·¯çº¿ï¼ŒéªŒè¯ç©å®¶åªè·å¾—äº¤æ˜“ç¨
- åˆ›å»ºè¿›å£è·¯çº¿ï¼ŒéªŒè¯ç©å®¶åªè·å¾—äº¤æ˜“ç¨
- æ£€æŸ¥æ—¥å¿—æ˜¾ç¤ºæ˜¯å¦æ­£ç¡®æ˜¾ç¤ºå•†äººåˆ©æ¶¦å’Œç©å®¶ç¨æ”¶

### 2. ç¨ç‡æµ‹è¯•
- è°ƒæ•´äº¤æ˜“ç¨ç‡ï¼ŒéªŒè¯ç¨æ”¶è®¡ç®—æ˜¯å¦æ­£ç¡®
- æµ‹è¯•è´Ÿç¨ç‡ï¼ˆè¡¥è´´ï¼‰çš„æƒ…å†µ
- éªŒè¯ä¸åŒèµ„æºçš„ç¨ç‡è®¾ç½®

### 3. è´¢æ”¿å¹³è¡¡æµ‹è¯•
- å¯¹æ¯”ä¿®æ”¹å‰åçš„è´¢æ”¿æ”¶å…¥
- éªŒè¯æ¸¸æˆæ˜¯å¦ä»ç„¶å¯ç©
- æ£€æŸ¥æ˜¯å¦éœ€è¦è°ƒæ•´å…¶ä»–æ”¶å…¥æ¥æº

### 4. UIæ˜¾ç¤ºæµ‹è¯•
- éªŒè¯ç¨æ”¶é¢æ¿æ˜¾ç¤ºæ­£ç¡®
- æ£€æŸ¥çŠ¶æ€æ çš„è´¸æ˜“ç¨æ˜¾ç¤º
- ç¡®è®¤æ—¥å¿—ä¿¡æ¯æ¸…æ™°æ˜“æ‡‚

## ç›¸å…³æ–‡ä»¶

- `src/hooks/useGameLoop.js` - è´¸æ˜“è·¯çº¿å¤„ç†é€»è¾‘
- `src/components/layout/StatusBar.jsx` - ç¨æ”¶é¢æ¿æ˜¾ç¤º
- `src/App.jsx` - ä¸»åº”ç”¨é€»è¾‘
- `src/hooks/useGameState.js` - çŠ¶æ€ç®¡ç†

## ç‰ˆæœ¬å†å²

### v2.0 (2025-12-04)
- âœ… ä¿®æ”¹è´¸æ˜“è·¯çº¿ä¸ºå•†äººç¾¤ä½“äº¤æ˜“æ¨¡å¼
- âœ… ç©å®¶åªè·å¾—äº¤æ˜“ç¨è€Œéå…¨éƒ¨åˆ©æ¶¦
- âœ… æ›´æ–°æ—¥å¿—æ˜¾ç¤ºï¼Œæ˜¾ç¤ºå•†äººåˆ©æ¶¦å’Œç©å®¶ç¨æ”¶
- âœ… æ›´æ–°ç¨æ”¶é¢æ¿ï¼Œæ˜¾ç¤ºè´¸æ˜“è·¯çº¿ç¨
- âœ… æ›´æ–°çŠ¶æ€ç®¡ç†ï¼Œä½¿ç”¨tradeTaxæ›¿ä»£income/expense

### v1.2 (2025-12-03)
- ä¿®å¤è´¸æ˜“ç›ˆäºè®¡ç®—é€»è¾‘
- æ”¹è¿›æ—¥å¿—æ˜¾ç¤º

### v1.1 (2025-12-03)
- ä¿®å¤è´¸æ˜“çŠ¶æ€è®¡ç®—é€»è¾‘
- è°ƒæ•´ç¼ºå£/ç›ˆä½™é˜ˆå€¼

### v1.0 (2025-12-03)
- åˆå§‹å®ç°è´¸æ˜“è·¯çº¿ç³»ç»Ÿ
