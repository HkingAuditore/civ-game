# 贸易路线系统实现文档

## 概述

本文档详细说明了新的贸易路线系统的设计和实现。该系统取代了原有的即时套利贸易，改为基于贸易路线的自动化进出口机制。

## 实现日期

2025-12-01

## 系统设计

### 核心概念

1. **贸易路线（Trade Route）**：玩家与外国之间建立的持续性贸易通道
2. **自动执行**：贸易路线一旦建立，将在每个游戏tick自动执行
3. **条件检查**：贸易路线的创建和执行都需要满足特定条件

### 贸易路线类型

#### 1. 出口路线（Export Route）
- **创建条件**（v1.1更新）：
  - 资源已解锁（当前时代可用）
  - 双方未处于战争状态
  - ~~对方国家对该资源有缺口（库存 < 目标库存的50%）~~ **已移除此限制**
  
- **执行机制**：
  - 每个tick检查我方是否有盈余（库存 > 目标库存）
  - 如果有盈余，按照一定比例（5%）和速度输出到对方
  - 以对方的市场价计算收入
  - 资源从我方库存扣除，银币增加
  - 对方库存增加，预算减少

- **暂停条件**（v1.2更新）：
  - ~~对方不再有缺口（库存 >= 目标库存的50%）~~ **不再自动关闭，只暂停交易**
  - 对方没有缺口时暂停交易，但保留路线
  - 我方没有盈余时暂停交易，但保留路线

#### 2. 进口路线（Import Route）
- **创建条件**（v1.1更新）：
  - 资源已解锁（当前时代可用）
  - 双方未处于战争状态
  - ~~对方国家对该资源有盈余（库存 > 目标库存的150%）~~ **已移除此限制**
  
- **执行机制**：
  - 每个tick检查对方是否有盈余
  - 如果有盈余，按照一定比例（5%）和速度从对方进口
  - 以对方的市场价计算成本
  - 需要有足够的银币支付
  - 资源增加到我方库存，银币减少
  - 对方库存减少，预算增加

- **暂停条件**（v1.2更新）：
  - ~~对方不再有盈余（库存 <= 目标库存的150%）~~ **不再自动关闭，只暂停交易**
  - 对方没有盈余时暂停交易，但保留路线
  - 我方银币不足时暂停交易，但保留路线

### 战争影响

- 当双方处于战争状态时：
  - 无法创建新的贸易路线
  - 现有贸易路线暂停执行（不删除）
  - 战争结束后，贸易路线自动恢复

## 数据结构

### 贸易路线状态

```javascript
{
  routes: [
    {
      nationId: 'string',      // 目标国家ID
      resource: 'string',      // 资源类型
      type: 'import'|'export', // 路线类型
      createdAt: number        // 创建时间（游戏天数）
    }
  ]
}
```

## 代码实现

### 1. 游戏状态管理（useGameState.js）

添加了贸易路线状态：

```javascript
const buildInitialTradeRoutes = () => ({
  routes: [],
});

const [tradeRoutes, setTradeRoutes] = useState(buildInitialTradeRoutes);
```

### 2. 外交标签页（DiplomacyTab.jsx）

- 移除了"批量"输入框
- 将"出口"/"进口"按钮改为"创建/取消"贸易路线按钮
- 按钮状态根据是否已有路线动态变化
- 显示资源的缺口/盈余状态

### 3. 游戏操作（useGameActions.js）

添加了 `handleTradeRouteAction` 函数：

```javascript
handleTradeRouteAction(nationId, action, payload)
```

- **action**: 'create' 或 'cancel'
- **payload**: { resource, type: 'import'|'export' }

功能：
- 验证资源是否已解锁
- 检查战争状态
- 验证贸易条件（缺口/盈余）
- 创建或取消贸易路线

### 4. 游戏循环（useGameLoop.js）

添加了 `processTradeRoutes` 函数，在每个tick中执行：

```javascript
const processTradeRoutes = (current, result, addLog, setResources, setNations, setTradeRoutes)
```

功能：
- 遍历所有活跃的贸易路线
- 检查战争状态（暂停但不删除）
- 计算贸易量（盈余/缺口的5%）
- 执行资源和银币的转移
- 更新双方的库存和预算
- ~~自动关闭不再满足条件的路线~~ **v1.2更新：不再自动关闭，只暂停交易**
- 生成贸易日志

## 贸易参数配置

```javascript
const TRADE_SPEED = 0.05;        // 每天传输盈余/缺口的5%
const MIN_TRADE_AMOUNT = 0.1;    // 最小贸易量
const TARGET_INVENTORY = 500;    // 目标库存（简化版）
```

## 与市场价格的交互

### 出口路线
- 出口会减少我方库存，可能导致我方价格上涨
- 增加对方库存，可能导致对方价格下跌
- 以对方的市场价作为交易价格

### 进口路线
- 进口会增加我方库存，可能导致我方价格下跌
- 减少对方库存，可能导致对方价格上涨
- 以对方的市场价作为交易价格

## 用户体验改进

### 1. 直观的UI
- 清晰显示资源的缺口/盈余状态
- 按钮颜色区分：创建（蓝绿/紫色）vs 取消（红色）
- 实时显示本地和外国价格

### 2. 自动化管理
- 一次设置，持续运行
- 自动适应供需变化
- ~~条件不满足时自动关闭~~ **v1.2更新：条件不满足时暂停交易，保留路线**

### 3. 战争保护
- 战争期间暂停贸易
- 和平后自动恢复
- 避免资源流向敌国

## 游戏平衡

### 优势
1. **稳定收入**：建立出口路线后可获得持续收入
2. **资源保障**：进口路线确保关键资源供应
3. **价格调节**：通过贸易平衡市场价格

### 限制
1. **速度限制**：每天只能传输盈余/缺口的5%
2. **条件依赖**：必须满足缺口/盈余条件
3. **战争中断**：战争会暂停所有贸易
4. **银币需求**：进口需要足够的银币

## 与原系统的对比

### 原系统（即时套利贸易）
- ✅ 立即执行，快速获利
- ✅ 可以精确控制数量
- ❌ 需要手动操作
- ❌ 容易忘记执行
- ❌ 可能导致过度交易

### 新系统（贸易路线）
- ✅ 自动执行，无需干预
- ✅ 持续稳定的贸易流
- ✅ 更符合真实贸易逻辑
- ✅ 防止过度交易
- ❌ 速度较慢
- ❌ 不能精确控制数量

## 未来改进建议

1. **贸易路线升级**
   - 增加贸易速度
   - 降低交易成本
   - 提高利润率

2. **贸易协议**
   - 与盟友建立优惠贸易协议
   - 降低关税
   - 增加贸易量上限

3. **贸易港口**
   - 建造港口建筑增加贸易路线数量
   - 提升贸易效率
   - 解锁特殊商品

4. **贸易统计**
   - 显示每条路线的累计交易量
   - 统计总收入/支出
   - 分析贸易效益

5. **贸易事件**
   - 海盗袭击（损失部分货物）
   - 贸易繁荣（临时提升贸易量）
   - 贸易禁运（强制关闭路线）

## 测试建议

### 基础功能测试
1. 创建出口路线，验证资源减少、银币增加
2. 创建进口路线，验证资源增加、银币减少
3. 取消路线，验证贸易停止
4. 宣战后验证路线暂停
5. 和平后验证路线恢复

### 边界条件测试
1. 银币不足时进口路线暂停
2. 我方无盈余时出口路线暂停
3. ~~对方无缺口时出口路线关闭~~ **v1.2更新：对方无缺口时出口路线暂停**
4. ~~对方无盈余时进口路线关闭~~ **v1.2更新：对方无盈余时进口路线暂停**
5. 未解锁资源无法创建路线
6. **v1.2新增：暂停的路线在条件恢复后自动恢复交易**

### 性能测试
1. 创建多条贸易路线
2. 验证游戏性能
3. 检查日志数量是否合理

## 相关文件

- **状态管理**: `src/hooks/useGameState.js`
- **UI组件**: `src/components/tabs/DiplomacyTab.jsx`
- **操作逻辑**: `src/hooks/useGameActions.js`
- **游戏循环**: `src/hooks/useGameLoop.js`
- **工具函数**: `src/utils/foreignTrade.js`

## 版本历史

### v1.2 (2025-12-01 14:20)
- ✅ 移除自动关闭贸易路线的机制
- ✅ 改为在没有盈余/缺口时暂停交易但保留路线
- ✅ 用户可以手动管理所有贸易路线，不会被系统自动关闭

**主要变更**：
- **出口路线**：
  - 之前：对方没有缺口时自动关闭路线
  - 现在：对方没有缺口时暂停交易但保留路线，等待条件满足后自动恢复
- **进口路线**：
  - 之前：对方没有盈余时自动关闭路线
  - 现在：对方没有盈余时暂停交易但保留路线，等待条件满足后自动恢复
- **好处**：用户可以提前布局贸易路线，不用担心被系统自动关闭

### v1.1 (2025-12-01 14:16)
- ✅ 优化UI：显示所有已解锁的资源
- ✅ 允许为每个已解锁资源创建出口或进口路线
- ✅ 移除了"只有在对方有缺口/盈余时才显示"的限制
- ✅ 战争期间禁用创建按钮但保留显示
- ✅ 改进用户体验：更直观的贸易路线管理

**主要变更**：
- 之前：只显示对方有缺口或盈余的资源
- 现在：显示所有已解锁的资源，用户可以自由创建任意贸易路线
- 战争期间：按钮变灰并禁用，但已有路线仍然显示（可取消）

### v1.0 (2025-12-01)
- ✅ 实现贸易路线数据结构
- ✅ 实现创建/取消贸易路线功能
- ✅ 实现自动执行机制
- ✅ 实现战争状态检查
- ✅ 实现条件自动关闭
- ✅ 更新UI界面
- ✅ 编写完整文档
